<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[かえるのひみつきち]]></title><description><![CDATA[かえるのひみつきち]]></description><link>https://kashiwaba-yuki.com</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 28 Feb 2022 15:02:11 GMT</lastBuildDate><item><title><![CDATA[Mac mini Late2018を購入したのでVMWare Fusion PlayerでMacOSの仮想マシンを構築してみた]]></title><link>https://kashiwaba-yuki.com/note-setup-macmini</link><guid isPermaLink="false">https://kashiwaba-yuki.com/note-setup-macmini</guid><pubDate>Sat, 26 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日初めてのMac端末を手に入れたのでセットアップ手順やつまづいた点について記録しておきます。&lt;/p&gt;
&lt;p&gt;今回はMac mini(Late2018)で以下のような環境をセットアップしていきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mac miniにインストールしたMacOSを現在最新のMonterey 12.2.1にアップグレードする&lt;/li&gt;
&lt;li&gt;VMWare fusion playerをインストールしてMacOS Big Surの仮想マシンを構築する&lt;/li&gt;
&lt;li&gt;LAN上のWindowsマシンからVNCでリモートアクセスできるようにする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;初めてのMac機ということで結構手こずった点もあったのでその辺まとめておきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;環境について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#macos%E3%82%92%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;MacOSをクリーンインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mac-os%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;Mac OSをアップグレードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#vmware-fusion-player%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;VMWare Fusion Playerをインストールする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AEmacos%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;仮想マシンのMacOSライセンスについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AEos%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;インストール用のOSを取得する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;環境について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;環境について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境について&lt;/h2&gt;
&lt;p&gt;今回購入したMac miniのスペックは以下の通りです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mac mini Late 2018&lt;/li&gt;
&lt;li&gt;Intel core i3 8100B&lt;/li&gt;
&lt;li&gt;16GB RAM&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 881px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtUlEQVQozyWRWW8bZRSGfYt60QTUZDzLN5uX8diesT3jLbGdpFlMg5NGSew6SVOlgAilErQkFKksAsENfyOirKGIG674bw+nzsWjkeabeb73vCfz5c5PPIyec778gnF8ybD4BZveBffcb9i2v59xX3vJyPiBlvOKlroiNa9IjCvq+hU1Ic7eEAmZb9tTvq4d8FW4y87iiGb2hJ5+zIb2hFH2c3azzzg1nvKp+ojN6jWtyn+0i//QzL0m9a5pOH9St3+npn6lZr0is7/1ko32Mzqlc7nxhCXzIT3zEWvaU4aLF2xrF+wIp9onHDvfMaj+S6/0N8v5azreH5L6N1L1C4n1Mw1JnpluXLIWvi+jHJEaU1rmCX37jMS+R91dJ/WHdAvb8uM6HWeVJL9HVJgS58dU/cMZZfeA0BkRqc9EOHzBQIQ1fUJDhA3jiKZxTM6MUZaLmTUxdAPL9FAqh6M8PPsGV3AsB9t05VwjMHZk5LXnrFY+IJGEcXZCfSad4ul1LN0hbWzT607wVAGVzbHaH7I2eJdWo087GZBzyvK+IN/alI19Mg+Gl2yl5/TDM1LniJoxoe09Qi2WGaSb3G//RSd4zXr3Q1zLp15t04g6+HZJLglm2HoBU7eITBHejT4mmNsnWphSfmdCaf6QcF4S6RHdeETy9mPeu/Mj69ULgkKFbnOF/tJdOs0+ab1LVE4o5WIMqaauDsislp/g39onuP2AkhDenspzirpTJa60yFtdutqYldoeyvRJa0tEYQNlePhOUXosEBakHtOWRY7JLIePcW/tEsyPJemY0twb8QRHi6UXl0pQpyIp1Jul6L6M254lq4YJSdyh2ViSPnvYtkPTFWG3dIr51hb5uT2Kc4cincyE7oKk0PNYi3nsbBHPKuMLjh7cYJRwBaXJQhakQ81hpXDG/3y7bZgx6q+QAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/46874829b33a7188178bc0e0cc89457c/8ac56/image-20220228213725674.webp 240w,
/static/46874829b33a7188178bc0e0cc89457c/d3be9/image-20220228213725674.webp 480w,
/static/46874829b33a7188178bc0e0cc89457c/8e8eb/image-20220228213725674.webp 881w&quot;
              sizes=&quot;(max-width: 881px) 100vw, 881px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/46874829b33a7188178bc0e0cc89457c/8ff5a/image-20220228213725674.png 240w,
/static/46874829b33a7188178bc0e0cc89457c/e85cb/image-20220228213725674.png 480w,
/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png 881w&quot;
            sizes=&quot;(max-width: 881px) 100vw, 881px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png&quot;
            alt=&quot;image-20220228213725674&quot;
            title=&quot;image-20220228213725674&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;本当はM1チップ搭載のLate2020が欲しかったのですが、VMWare ESXiがまだM1アーキテクチャをサポートしていなかったためLate2018にしました。&lt;/p&gt;
&lt;p&gt;中古で買う予定だったのでLate2014と迷ったのですが、Late2018で一番安いCPUのIntel core i3 8100Bの評価がかなり良く、Late2014のIntel Core i7-4578Uよりもスペックがよさそうだったのでこちらを購入しました。&lt;/p&gt;
&lt;p&gt;中古相場についても、Late2018のi3モデルとLate2014のi7モデルではほとんど価格は変わらなかったです。&lt;/p&gt;
&lt;p&gt;また、Late2018はLate2014と違ってRAMの拡張もできるという点が最終的に決め手になりました。&lt;/p&gt;
&lt;h2 id=&quot;macosをクリーンインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#macos%E3%82%92%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;macosをクリーンインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MacOSをクリーンインストールする&lt;/h2&gt;
&lt;p&gt;PCを購入したらまずはクリーンインストールをするのがお作法です。&lt;/p&gt;
&lt;p&gt;MacOSの再インストールは初めてだったので少々戸惑いました。&lt;/p&gt;
&lt;p&gt;MacOSの場合は、WindowsやLinuxのようにブートメディアを作成してBIOSからリセットする方法ではなく、Mac端末に内臓されている復旧ユーティリティからインターネットもしくは復旧メディア経由で再インストールを行います。&lt;/p&gt;
&lt;p&gt;詳しくは以下のリンクが参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT204904&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS を再インストールする方法 - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsキーボードの場合は[Winキー + R]を押しながらMac mini Late2018の電源を付けることで復旧ユーティリティが起動します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 362px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACN0lEQVQ4y5WTzXLSUBTHeQexlBA+WgoEAkn4SqgFKQgFIk1pocO4cdw448aNblw4bnTle/gGvoUuHDc+zt97bnsyNzZUXfw5NyHndz5vIlPQQNLy6Tvi/+K06/vELmf9IPNXxQVIxEVOx0TfJQ7O/gk1GtlKrYS6WUalXkbZLIUyGhWpqmWEom9UX1JCjaDl9jFbP8WLz+8RbAIEV0sE63Osri8w9ScYnZ1iOHksdTodojfwIsBohkJaNoXZ5hybD2+x2q7gB3P4Fwup2fIMC/HMULIE5FKzh/pNhvRDD/IPce70mrjcztHyHDhdB003Xi2vCavdCDMjBikEZg90pApJLNw1vr76juXER3/ax5P5GOPZSGblPurC7lio2dWwpyowkqFeELaYEQNxMNCuYVsOao6BetMMZTo1aQnIg+GW3QHKssVQeiKby4+f0Bsei5JvsiEQW4aSvR9YzCKdSWK02eDllx8Y+3O4J21YokTqV7vXCq170pVnCsLJhEA65ASMX5riI0841W73jLLg/eO+qfvIfsyQwPxRTiqZfoDt82f49usnJv4UneM2vL4r14OGYd9m63RtNFr1CJD8JZDI9EA2LXo4GPfx+t0b2cO66BOtBoEIQGeCkahcukEqkBghkNM2RJkF8UzReRjqQHhlaMnp9tB9jmSo1k/7JAOU8pFmx+moWkTROJRA8on0kKE0pX1x/f5Fe5mHSOl70kcdamQPufz/kQoL1+ZPKIsd7nunwsj+BjhnLE4e9s/dAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a026780da82d130498c68b6f20d52ab9/8ac56/image-20220228215319901.webp 240w,
/static/a026780da82d130498c68b6f20d52ab9/c2de8/image-20220228215319901.webp 362w&quot;
              sizes=&quot;(max-width: 362px) 100vw, 362px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a026780da82d130498c68b6f20d52ab9/8ff5a/image-20220228215319901.png 240w,
/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png 362w&quot;
            sizes=&quot;(max-width: 362px) 100vw, 362px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png&quot;
            alt=&quot;image-20220228215319901&quot;
            title=&quot;image-20220228215319901&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;僕の環境ではディスクユーティリティから既存のパーティションをすべて削除した上でパーティションを再構成し、インターネット経由でMac OSを再インストールしました。&lt;/p&gt;
&lt;p&gt;ちなみに、今回は使用しませんでしたが以下のようにインストールメディアからのインストールも可能なようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT211683&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;以前のバージョンの macOS を入手する - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT201372&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS の起動可能なインストーラを作成する方法 - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;mac-osをアップグレードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mac-os%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;mac osをアップグレードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Mac OSをアップグレードする&lt;/h2&gt;
&lt;p&gt;インストールが完了したらAppleIDと連携した後、[システム環境設定]&gt;[ソフトウェア・アップデート]を開き、アップデートを実行します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABp0lEQVQoz01S23aaQBTlI9pYtQjMwHAHDQjIRSMtTUw1yepLktq+1ZX8/w/snBm72jzstffZzLnNoCWiQGqvkPICEW8Q22tCh0TCIc1b4k55gVURSsURr8lv4VPsmxV8liEZPUHjTMCcChgTG5buwDY9CBbAsXylueEqfh9zwyPtw+Uh+QGERcwchKMDNH1soiy3aNYDHUgw+2TDNkLkaY1NM2A33OF2uFdaefVXtGWvsFw08HhKBWMI7iMY3UNbFjV+n15x/HPCj8cjmE7djUAd7rtrStyiytYIxQK+nSLyLpWO3DO7LIarCno04QO0ttvg9PKCx+cnPB9/wTFpfJpQWNFZ/4WMZfJ7T0J6Hkv+F+Smi+HLNe72B2RpqVY+F4vU6gqz4B+EKQsnairJ0uM6fbNcRHJl47OFKm8x9DvqEmI2YXTBAeZxjmW2QpHXWJUdKomiReTPKZkejgdgpsCm67H7tkeWZYjH9CizC+owWUBMc7CLBawPc4hxjkhv0Pg3GC4f0KcHXMXf0YW3WLItUp1+KZ3uddqhcG+wCvZI2RUWH3/iDf9z9ztnZUKUAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/8ac56/image-20220228220157397.webp 240w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/d3be9/image-20220228220157397.webp 480w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/038cb/image-20220228220157397.webp 696w&quot;
              sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/8ff5a/image-20220228220157397.png 240w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/e85cb/image-20220228220157397.png 480w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png 696w&quot;
            sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png&quot;
            alt=&quot;image-20220228220157397&quot;
            title=&quot;image-20220228220157397&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;しばらく待つとアップグレードが完了します。&lt;/p&gt;
&lt;h2 id=&quot;vmware-fusion-playerをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#vmware-fusion-player%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;vmware fusion playerをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VMWare Fusion Playerをインストールする&lt;/h2&gt;
&lt;p&gt;VMware Fusionは、MacOS上で実行できるホスト型のハイパーバイザです。&lt;/p&gt;
&lt;p&gt;Windowsなどで使えるVMWare Workstationと同様にProとPlayerのエディションが存在し、Fusion Playerは無料での個人利用が可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.vmware.com/jp/products/fusion/faq.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;VMware Fusion の概要 | FAQ | JP&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsなどで使えるWorkstation Playerの場合は、残念ながら無料ライセンスでは仮想化の最大のメリットともいえるスナップショット機能が使用できません。&lt;/p&gt;
&lt;p&gt;しかし、なんとVMware Fusionは個人用の無料ライセンスでもスナップショット機能が使えるのです。&lt;/p&gt;
&lt;p&gt;これは素晴らしい。&lt;/p&gt;
&lt;p&gt;VMWare Fusionは以下のダウンロードページからダウンロード可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://customerconnect.vmware.com/downloads/info/slug/desktop_end_user_computing/vmware_fusion/12_0&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Download VMware Fusion 12 - VMware Customer Connect&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;インストーラをダウンロードできたら、次に以下のページにVMWareアカウントでログインして個人利用用のライセンスを取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://customerconnect.vmware.com/web/vmware/evalcenter?p=fusion-player-personal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;VMware Fusion Player – Personal Use License&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;VMWareアカウントがない場合はアカウント作成が必要です。&lt;/p&gt;
&lt;p&gt;作成できたら「VMware Fusion Player – Personal Use」というライセンスが取得できます。&lt;/p&gt;
&lt;p&gt;あとはダウンロードしたインストーラを実行して取得したライセンスを登録すればOKです。&lt;/p&gt;
&lt;h3 id=&quot;仮想マシンのmacosライセンスについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AEmacos%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;仮想マシンのmacosライセンスについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想マシンのMacOSライセンスについて&lt;/h3&gt;
&lt;p&gt;仮想マシンを作成する前にMacOSの仮想マシンのライセンスについて確認しておきます。&lt;/p&gt;
&lt;p&gt;Appleのライセンスを読むと、MacOSの仮想マシンは、Mac端末上でのみ最大2つのコピーを使用することができると書かれています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(iii) to install, use and run up to two (2) additional copies or instances of the Apple Software, or any prior macOS or OS X operating system software or subsequent release of the Apple Software, within virtual operating system environments on each Apple-branded computer you own or control that is already running the Apple Software, for purposes of: (a) software development; (b) testing during software development; (c) using macOS Server; or (d) personal, non-commercial use.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.apple.com/legal/sla/docs/macOSMonterey.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS Monterey License&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MacOSの仮想マシンを構築するのはOKですが、あくまでMac端末上でのみ許可されるという点に注意が必要ですね。&lt;/p&gt;
&lt;h3 id=&quot;インストール用のosを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AEos%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;インストール用のosを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;インストール用のOSを取得する&lt;/h3&gt;
&lt;p&gt;インストールしたFusion Playerを起動すると、以下のような仮想マシンのセットアップ画面がでてきます。&lt;/p&gt;
&lt;p&gt;ここで、「リカバリパーティションからMacOSをインストール」を選択すると、現在使用しているOSと同じバージョンの仮想マシンを簡単に立てることができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACfUlEQVQ4y11T227bMAw1sK7d2q5Jc7FlWZIdW7ZzcW5okqXNQx4KbMMwYP//NWciHTvuHg5ISTzUoUh5WWqRpRmMNtAOjY0i1UI5yFAiFBJChAgCAaV0G6tbbgxPG+0OiRi10FqjLEvMZjO2WZZhs9lgv9/jeDzifD4jTVNIKRGpK08536tVRB9gjOFk8/mc7XQ6xXa75YRvb28fEnbFkM8JyVFOFYHUUTlUGkHKiCFCWgv4QQDf9/kp9AdOncdTF4WBCxQOAcNHkiSslHwh6jOyoUtKoP0u6NI6IasJ8PXGw/1nD1+cfX78hNU8xW4zw+DbDcTwAdJ/wqh/h2HvFsHwHqPencMtnxPXH4+4MR5lpbd47j1g0H9kOx72MCstbBpD+EOnaIQodEqDIfxRH1oJtqPBE4M49BxUvtc8pjZxDWq/SZDZnFEUU9i8gLUFr8mvqiXiZOJ4NC41jyrtNOXaJa2brskaTr28oF27BhGn6XCX33Y5dEFFUfBoNONAoFKstXzGZV32qdO73Q6LxYIb2Xa5SUhJiERB15sVlsslXl5eeLCrquIRyfOc9wir1YovbEbnOoeXJF11tKafQphMJkxszuI4bn1K1pZ8nUPBs0eKqLQmYDwet7+G/P+/aRetQhrgsiixXq9xOBz4W8VxwgHkv76+4nQ68ZNQbENWneraN5Qy5IBkkrgkhrtM5RlTl1GXmrF6sqqZAlWD+PyTuCoJz6YF8mzqBrnCYu4eOC0RCZdYuvmKnMow5jXbkPYT3uczF0Pxq2qLynHTJIdXphXW8z3ez7/w8/0PttV36CBDLHOYMGfbBe2Z0LKvRea+6A6/f/xl/tSu8A9c58w8tNayMwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/8ac56/image-20220228222728117.webp 240w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/d3be9/image-20220228222728117.webp 480w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/df8c5/image-20220228222728117.webp 649w&quot;
              sizes=&quot;(max-width: 649px) 100vw, 649px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/8ff5a/image-20220228222728117.png 240w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/e85cb/image-20220228222728117.png 480w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png 649w&quot;
            sizes=&quot;(max-width: 649px) 100vw, 649px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png&quot;
            alt=&quot;image-20220228222728117&quot;
            title=&quot;image-20220228222728117&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;しかし、今回は検証用のマシンを作成したいので、一つ前のBig Surをインストールしていきます。&lt;/p&gt;
&lt;p&gt;そのため、まずはOSイメージを取得します。&lt;/p&gt;
&lt;p&gt;OSイメージはApp Storeからダウンロード可能ですが、現行バージョンより古いOSイメージはApp Storeのアプリの検索結果には表示されないため、Webから直接リンクにアクセスする必要があります。&lt;/p&gt;
&lt;p&gt;各OSイメージのリンクは、以下の公式ページからアクセスできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT211683&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;以前のバージョンの macOS を入手する - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このURLからApp Storeを開きOSイメージをダウンロードすると、イメージは「Application」ディレクトリに配置されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADwklEQVQ4y0WUyW4jdRDG/QbAhAmJl3a33d3ubu9re4ljx0tsZ4/HntjYDpkkQmJWQIQDDMsBDgwiQkJCcB6JE1y4MW/BWyDNjRf4Ue5E4lCqpUuf/vXVV+1rGkNOCkPc4pCSNsbVTiga+7iFDcqFTSrFBoPuAf3OPu3GgE5zx6u5+brY5q3/P/Zt6kMOM2PK6ZGAidcmFPQ9cukS+XSFfKZCvdpio7xFtdSgWe9SytXIpVzpKd9YZuldr9fnGvdoxM/YTp5TjoypRKZkwtsEA2GUgEZ4XSG4HiYgFg5FiekOUdXwvilB7bYn4vUYUVsArUP2Ny6ZdD6knTqlGBoJYF+aDMJBhzU1ixq00QKW1EySdklet+HFml9qgRh+QyesxLzct5kYM+k+Y9G7Ytx4Qi99Sck4RLkTxJx8Se/Vv6j9R6h3QljRPL//8YqXv/2JbWQJvqlTPG7y3etfaX19TEhyXzc356T1jOnWR4w3nzJrX1G1hoRWAsR2Pqf/82uijQ9QJI/Hylx98oLvX/xCNlkl+EYUZ6/E4u+nZK+ahN8y8dXsI/arF+xkz2nZMzajU3JKD9Uv41llUukejp6X3CIairPhdmnVd9GVuFez9QzJjRJxJ4e2LhxWZbyT1iMOCpfU1BENASwsOfTHsKPSbOYx1aRwaHuA6rqFsmZ68bKmKQlCqzaK3yEinPvq5hGDzCm7mQcMUu/RMma3gCbVYpP5bE4uWUHzFmPT2upQLddlATECAYe26vDXeMSTYo21tRi+lnmfjvEuDdHg0pqiw5I6ILiii4Db9O7vU8410dYc/CsqD68+5vlnXxG6G2FVAM8Vk3+++YJFdxf/XVnKluhwKOPOGo85KlwwsE8pKQOcTILBYo/dx2d0px1MxyEuW86ka5iRFHE9J2PaVMwcfTOFFXeJLkdumfc4zp3LtTzgIH1G31pQDPSIF5Icfdtm8pOc3qc1DAF0BNDR0lhqCsfIe7qzxSecChmrdMNhyxyxbUxpy7hL60QmVNQ+wVWTREheVSmiaLKMVQtd8s7emN7RFON2KaoIXouIV2449u2YQ8bJBTvxuQAKuADWhMNVOaf3jQ7Pr1/yjvwQ1BWNVKzA+fUPnP54TTlTx/92lFSiyPhsTsxJewrw7VkHzEsLjvMX9GMTD7AaHhDy67hqGbf9kJDpoq4Zoscse8dTDkdzEiKnsABE5NW6HpebNonIkny7yX1m1Zm3mEHshN4SUEZWRRaqNCf0NJFlLOPYAliQC3HldY6Ru9Hhsh7NCh0JL/4PbSUSlPnIetEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/8ac56/image-20220226220901937.webp 240w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/d3be9/image-20220226220901937.webp 480w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/9e625/image-20220226220901937.webp 540w&quot;
              sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/8ff5a/image-20220226220901937.png 240w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/e85cb/image-20220226220901937.png 480w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png 540w&quot;
            sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png&quot;
            alt=&quot;image-20220226220901937&quot;
            title=&quot;image-20220226220901937&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;あとはこのイメージをFusion PlayerのGUIにドラッグ&amp;#x26;ドロップすると、以下のように仮想マシンの作成に進むことができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 651px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC10lEQVQ4y51Ta1faQBCl9tTWHj3aCuSxj2TzIiESIAgoCFjtqWBb7dHW//9PbmeXh1K/9cM9MzuZuXt3MlM55bfo+hMU/AItd4wWGxubW2conBHa1gAd6xSlM0Tu3SCVc6T8GzIxR1Mu0OQLZGy+hDtHxecNMM+CK2w43ILN6mDSQV5kUJGHvN1EUbagYgUVCqRZiOZJTD6Hw6pUV1+C16i+iopyMsRJhCxtIm+ekM3Q7XRxd3eP4fAMi8Utnv48YXIxwXQ6w83NAo8PvzEeTxCFMdIG1UcJTk5aEFwSoZshCH3EcYI0TdFoNAyiKILv+8iyjIrHKMsSRVEgDEMkSWJytK/z4jg2tYwxerKbggvXHPTH2WxmiF5CxzWBlHIT0/76Ul3LOYfruktCIbkJRFGI0WhkEvVZCGGsLtJqdOE6xskPggBKKXPWFxhCz2nA86nZ1DtNFBK0TempWlWSLJHnOdrtjnlah3pclj0iYAa6Xb6vVgqJUHgk17YguYPAl+h122gXOUIloegy5tRR/XyIevXTxtaOj+BYVUSBR7U1o37TQ8Zd1KpH8BSDUztEK4tQPz7A/oc3ONjbwcfdCt6/3cbuToW+7+Bofxd77yqwbZt4+FKh9EiFLWHXSGmdw666Bk6NGeiYa4lXcCjfNjnUQ+E/91DSkwPRIKQr+69P4C8gXthVri/VmjAxCn0ew2f/D29NKJ3YECqeQLEVyN9SJ16r2son+M+EK4UiJETGejx41S9mSdNn0zvqqWS026t8XefJVQ+FEy03hTPztzVUoGhvJ7iYXGA6m9L2TGn9RjT055hQ/Or6imYzhsscGnRO47Ksd8lWAk7zFoSIQ9rhhPbajwyG/XPCGYaDc5wRBqdD9HtDE7+cfkG3XW5yG3GGJKYf4wWoZKqPshjg5voH7r8/YjyYwdOqLfWMuto6D3tj3N0+4HL8Ff3OOe7J/zn/hU7ex18yL9+RFzgsLAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/8ac56/image-20220226220842339.webp 240w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/d3be9/image-20220226220842339.webp 480w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/be1d0/image-20220226220842339.webp 651w&quot;
              sizes=&quot;(max-width: 651px) 100vw, 651px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/8ff5a/image-20220226220842339.png 240w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/e85cb/image-20220226220842339.png 480w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png 651w&quot;
            sizes=&quot;(max-width: 651px) 100vw, 651px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png&quot;
            alt=&quot;image-20220226220842339&quot;
            title=&quot;image-20220226220842339&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;細かいハードウェアのカスタマイズは割愛します。&lt;/p&gt;
&lt;p&gt;これで、MacOS上で仮想MacOSを動かすことができました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/44a54/image-20220228223342401.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACbUlEQVQ4y5WSaU8TURhGZ5pOKZRCp9PSGUohXSiBlqVsXVgFGsAoFQW/QNCQgMZdCEjSyFagKCKgyN893rJo1NaED0+edzI35547d6QhY43xhnWmmt+RDr7nftMqD8Nijn4lFTol6f9CX/CE/sAZnfohXXpe9AGdxh4drmPaHRd0u37Q572g13OEFKtcImqfIlhfg7fei1evxfB40D0Ghph1j46vzkcoGKLWMK7jRTc0gu5h4uo5cU1sVpUnVrWF1GV/Tsg2gSRJt46mtDKofSPhPKTbsSOyidRuWyRQnr5eJP8H8PudLJkuu6asnWHXdxLqPr0C2FstgJGKeRrKhkuCZFkuCfcI4IjrjJSaIynSUy2OHLbO4LMM3vK4V0Dd2sGY+5h+dZeUY18At5H8ZVMYlkRJs2w2SyQS+cv2qg1rG5PuPMPOnIDmiBcMA2UZdEu8pE0ymUTTtKKGdeURMp48o9oeQ+qOsPyIVGcZo0bpLgqz2+1Fv6V8DayviDJjHDLh2mXUuc2AI4ukW/pRlZaShiaT6Z/bv7llvy3KvPeAjHuLSW2TO+oGkmEZKA6UC1ZXffP8xyy6qSLCSu0RT9w5Zp1b3HUUgEo/mjmKSTZjkkRkRfTfv4ryy1IWa6ySFUXMMXMfK5UnLFpzzFduM139AcmltOEyt+M0t6AWYmqk2h6jJ/WYdGeaVHyOhppeEi3jJOML9DRNMxB5yUggy5y+wRvfZ163HjGrr/LAvo6kKo1cxhzGqTSjyWE05yhTC3leLCwz93SfpoY+Ho0tMTt/QnpomeTIBgNd5yx637KR+sRa5pR7/mekba/4CSjrfxEjUmocAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/8ac56/image-20220228223342401.webp 240w,
/static/85c82b1fc74c3df19844d24b22aff21e/d3be9/image-20220228223342401.webp 480w,
/static/85c82b1fc74c3df19844d24b22aff21e/e46b2/image-20220228223342401.webp 960w,
/static/85c82b1fc74c3df19844d24b22aff21e/11ae3/image-20220228223342401.webp 1017w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/8ff5a/image-20220228223342401.png 240w,
/static/85c82b1fc74c3df19844d24b22aff21e/e85cb/image-20220228223342401.png 480w,
/static/85c82b1fc74c3df19844d24b22aff21e/d9199/image-20220228223342401.png 960w,
/static/85c82b1fc74c3df19844d24b22aff21e/44a54/image-20220228223342401.png 1017w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/d9199/image-20220228223342401.png&quot;
            alt=&quot;image-20220228223342401&quot;
            title=&quot;image-20220228223342401&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;新しくMac端末を買ったので仮想マシンのセットアップまでやってみました。&lt;/p&gt;
&lt;p&gt;本当はESXiを入れたかったのですが、どうやらMac miniの内臓SSDにESXiをインストールすることはできず、Thunderbolt 3で接続した外部SSDにインストールする必要があることがわかったので、今回はFusion Playerで代用しました。&lt;/p&gt;
&lt;p&gt;また外部接続用のSSDが手に入ったらESXiの構築にもチャレンジしていこうと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Gatsbyで作成したSPAブログをGitHubPagesに公開する環境を作る備忘録]]></title><description><![CDATA[Gatsbyで作成したSPAブログをGithub Pagesに公開する手順についてまとめています。Gatsbyの開発環境はDockerコンテナ上に構築しています。]]></description><link>https://kashiwaba-yuki.com/note-how-to-deploy-gatsby-spa</link><guid isPermaLink="false">https://kashiwaba-yuki.com/note-how-to-deploy-gatsby-spa</guid><pubDate>Sun, 20 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;突然ですが、諸般の事情につきブログを移転することにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;旧ブログ&lt;/a&gt;の記事は順次こちらのブログに移植していこうと思います（手動でやる必要があるので面倒ですが…。）&lt;/p&gt;
&lt;p&gt;新しいブログですが、MITライセンスで公開されているGatsbyテンプレートの&lt;a href=&quot;https://github.com/alxshelepenok/gatsby-starter-lumen&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gatsby-starter-lumen&lt;/a&gt;をベースに使用させてもらってます。&lt;/p&gt;
&lt;p&gt;この記事では、新しいブログを公開するまでに実施した作業について備忘録としてまとめておきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回作成する環境&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83&quot;&gt;ローカル開発環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%92%B0%E5%A2%83&quot;&gt;デプロイ環境&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gatsby%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot;&gt;Gatsby環境を構築する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#docker%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Dockerをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gatsby%E9%96%8B%E7%99%BA%E7%94%A8%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;Gatsby開発用のコンテナを作成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gatsby%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;Gatsbyブログの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0eacces-permission-denied-mkdir-appnpmsentry-cli-%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;トラブルシューティング：EACCES: permission denied, mkdir ‘/app/.npm/sentry-cli’ が発生する場合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0socialimage%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;トラブルシューティング：socialImageのエラーが発生する場合&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gatsby%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;Gatsbyの設定を変更する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;プロフィール設定を変更する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%88%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;サイトデザインの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E8%BF%BD%E5%8A%A0%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot;&gt;コンテンツを追加、編集する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#typora%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot;&gt;Typoraの設定をする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#github-pages%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot;&gt;GitHub Pagesにデプロイする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;パスの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%94%A8%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;デプロイ用のカスタムスクリプトの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#pages%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;Pagesの設定&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回作成する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回作成する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回作成する環境&lt;/h2&gt;
&lt;p&gt;今回は以下の環境を想定しています。&lt;/p&gt;
&lt;h3 id=&quot;ローカル開発環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83&quot; aria-label=&quot;ローカル開発環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ローカル開発環境&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Windows 10 Pro&lt;/li&gt;
&lt;li&gt;Docker&lt;/li&gt;
&lt;li&gt;Typora&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;この環境が実際に記事を書く環境になります。&lt;/p&gt;
&lt;p&gt;Windowsホスト上のTyporaでMarkdownを編集し、動作確認はGatsby環境を構築したDockerコンテナ上で行います。&lt;/p&gt;
&lt;p&gt;ちなみにTyporaは高機能Markdownエディタです。&lt;/p&gt;
&lt;p&gt;最近有料化しましたが$15くらいの買い切りライセンスなので非常におすすめです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://typora.io/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Typora&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デプロイ環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%92%B0%E5%A2%83&quot; aria-label=&quot;デプロイ環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デプロイ環境&lt;/h3&gt;
&lt;p&gt;ローカルで作成したブログは、GitHub Pagesにデプロイして公開します。&lt;/p&gt;
&lt;p&gt;この際、独自ドメインを使用して公開できるように構成します。&lt;/p&gt;
&lt;h2 id=&quot;gatsby環境を構築する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsby環境を構築する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsby環境を構築する&lt;/h2&gt;
&lt;h3 id=&quot;dockerをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;dockerをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dockerをインストールする&lt;/h3&gt;
&lt;p&gt;現在Windows環境にDockerをインストールする方法としては、以下の2つの方法が主になると思います。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WSL2にDockerをインストールする&lt;/li&gt;
&lt;li&gt;Docker Desktop for Windowsをインストールする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.docker.com/desktop/windows/install/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Install Docker Desktop on Windows | Docker Documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回はPowershellからDockerコマンドを実行していく予定なので、Docker Desktop for Windowsをインストールしました。&lt;/p&gt;
&lt;p&gt;ちなみに、Docker Desktop for Windowsは少し前にライセンス有料化で話題になりましたが、個人利用の場合は引き続き無料で使用することができます。&lt;/p&gt;
&lt;p&gt;インストール方法については上記のドキュメントのリンクからダウンロードしたインストーラを実行するだけでOKです。&lt;/p&gt;
&lt;h3 id=&quot;gatsby開発用のコンテナを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E9%96%8B%E7%99%BA%E7%94%A8%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsby開発用のコンテナを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsby開発用のコンテナを作成する&lt;/h3&gt;
&lt;p&gt;続いてGatsbyの開発環境を構築します。&lt;/p&gt;
&lt;p&gt;基本的には以下のドキュメントを参照し、次のようなDockerfileを作成しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.gatsbyjs.com/docs/tutorial/part-0/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Part 0: Set Up Your Development Environment | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; ubuntu:20.04&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; TZ=Asia/Tokyo&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; mkdir -p /app/blog&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; HOME=/app/&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;WORKDIR&lt;/span&gt; /app&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt update &amp;amp;&amp;amp; apt upgrade -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install tzdata -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install curl git python wget -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install nodejs npm -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install n -g&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; n stable&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt purge -y nodejs npm&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt autoremove -y&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; node -v&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install -g gatsby-cli&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install gh-pages --save-dev&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; chown root:root ./* -R&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;WORKDIR&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$HOME&lt;/span&gt;/blog&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;EXPOSE&lt;/span&gt; 8000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ubuntu 20.04のコンテナをベースに最新のNodeJSをインストールした後、&lt;code class=&quot;language-text&quot;&gt;gatsby-cli&lt;/code&gt;をインストールしました。&lt;/p&gt;
&lt;p&gt;これによって&lt;code class=&quot;language-text&quot;&gt;gatsby&lt;/code&gt;コマンドが使用できるようになります。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt;はGithub Pagesにデプロイする際に使用するパッケージです。&lt;/p&gt;
&lt;p&gt;詳細は後述します。&lt;/p&gt;
&lt;p&gt;なお、今回作成したイメージは&lt;a href=&quot;https://hub.docker.com/repository/docker/kashiwabayuki/gatsby-env&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kashiwabayuki/gatsby-env&lt;/a&gt;として公開しているので、以下のコマンドでPullすることも可能です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; pull kashiwabayuki/gatsby-env&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;gatsbyブログの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;gatsbyブログの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsbyブログの作成&lt;/h3&gt;
&lt;p&gt;コンテナイメージを作成した後、環境構築時のみコンテナにログインしていくつかのセットアップを実行する必要があります。&lt;/p&gt;
&lt;p&gt;Powershell環境の場合、以下のコマンドでコンテナにログインできます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$pwddir&lt;/span&gt; = &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Get-Location&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;PSProvider FileSystem&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Path
docker run &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;it &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;volume &lt;span class=&quot;token variable&quot;&gt;$pwddir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;src:&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;app &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;p 8000:8000 kashiwabayuki/gatsby-env&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このコマンドで、コンテナのホームディレクトリ&lt;code class=&quot;language-text&quot;&gt;/app&lt;/code&gt;にローカルボリューム&lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt;を紐づけてログインしています。&lt;/p&gt;
&lt;p&gt;ログイン後、以下のコマンドで&lt;code class=&quot;language-text&quot;&gt;gatsby-starter-lumen&lt;/code&gt;を使用してGatsbyのコンテンツを作成します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gatsby new blog https://github.com/alxshelepenok/gatsby-starter-lumen&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、新たに生成された&lt;code class=&quot;language-text&quot;&gt;blog&lt;/code&gt;ディレクトリ配下で以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#もしエラーになる場合は npm install --legacy-peer-deps を実行する。&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt;コマンドでエラーが発生する場合は&lt;code class=&quot;language-text&quot;&gt;--legacy-peer-deps&lt;/code&gt;オプションを付けてから実行してみると良いです。&lt;/p&gt;
&lt;p&gt;これでブログの初期設定は完了です。&lt;/p&gt;
&lt;p&gt;以下のコマンドを実行してローカルサーバが起動すれば成功です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gatsby develop -H &lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;.0.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;トラブルシューティングeacces-permission-denied-mkdir-appnpmsentry-cli-が発生する場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0eacces-permission-denied-mkdir-appnpmsentry-cli-%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;トラブルシューティングeacces permission denied mkdir appnpmsentry cli が発生する場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラブルシューティング：EACCES: permission denied, mkdir ‘/app/.npm/sentry-cli’ が発生する場合&lt;/h3&gt;
&lt;p&gt;再現条件が不定なので原因はよくわかっていないのですが、&lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt; を実行した際に&lt;code class=&quot;language-text&quot;&gt;EACCES: permission denied, mkdir &apos;/app/.npm/sentry-cli&apos;&lt;/code&gt;という権限エラーが発生する場合があります。&lt;/p&gt;
&lt;p&gt;Dockerのユーザはrootにしているので通常発生しないことが想定されるのですが、僕の環境では何度か発生しました。&lt;/p&gt;
&lt;p&gt;対処方としては、Dockerfileでエラーの発生するディレクトリに以下のように明示的に所有者をrootに設定してあげると解消されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; chown root:root ./* -R&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;エラーが発生しないときもあるので、原因は正直よくわかっていないです。。&lt;/p&gt;
&lt;h3 id=&quot;トラブルシューティングsocialimageのエラーが発生する場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0socialimage%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;トラブルシューティングsocialimageのエラーが発生する場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラブルシューティング：socialImageのエラーが発生する場合&lt;/h3&gt;
&lt;p&gt;ちなみに、この時以下のようなエラーが発生する場合があります。&lt;/p&gt;
&lt;p&gt;これは、各記事の&lt;code class=&quot;language-text&quot;&gt;socialImage&lt;/code&gt;の値が空になっているか、参照先の画像が存在していない場合、もしくは&lt;code class=&quot;language-text&quot;&gt;static&lt;/code&gt;ディレクトリが解決できない場合に発生するようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;Field &lt;span class=&quot;token string&quot;&gt;&quot;socialImage&quot;&lt;/span&gt; must not have a selection since &lt;span class=&quot;token builtin class-name&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;String&quot;&lt;/span&gt; has no subfields.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;本記事の手順の場合は問題ないですが、Windowsのホスト上で&lt;code class=&quot;language-text&quot;&gt;gatsby develop&lt;/code&gt;を実行した場合、&lt;code class=&quot;language-text&quot;&gt;static&lt;/code&gt;ディレクトリが解決できない既知の問題のためこのような問題が発生する場合があります。&lt;/p&gt;
&lt;p&gt;解決のためには、以下のIssueに記載の回避策を試すか、本記事に記載のコンテナイメージを利用してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/alxshelepenok/gatsby-starter-lumen/issues/761&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Field “socialImage” must not have a selection since type “String” has no subfields. · Issue #761 · alxshelepenok/gatsby-starter-lumen&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;gatsbyの設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsbyの設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsbyの設定を変更する&lt;/h2&gt;
&lt;p&gt;とりあえずここまでで最低限のGatsby環境が出来上がったので、次は初期セットアップを行っていきます。&lt;/p&gt;
&lt;h3 id=&quot;プロフィール設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロフィール設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロフィール設定を変更する&lt;/h3&gt;
&lt;p&gt;基本的なプロフィールやSNSなどの設定は&lt;code class=&quot;language-text&quot;&gt;blog/config.js&lt;/code&gt;から変更できます。&lt;/p&gt;
&lt;p&gt;実際の設定は以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&apos;use strict&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;https://kashiwaba-yuki.com&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;pathPrefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;かえるのひみつきち&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;subtitle&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;copyright&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;All rights reserved 2022 Kaeru-no-Himitsukichi.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;disqusShortname&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;postsPerPage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;googleAnalyticsId&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;useKatex&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;menu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;All Articles&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Development&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/tag/development&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Notes&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/category/note&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;author&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;かしわば&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;photo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/avatar.png&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;bio&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;リバースエンジニアになりたい趣味プログラマ。&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;contacts&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;facebook&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;telegram&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;twitter&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;yuki_kashiwaba&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;github&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;kash1064&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;rss&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;vkontakte&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;linkedin&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;instagram&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;gitlab&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;weibo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;codepen&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;youtube&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;soundcloud&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;medium&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;特に&lt;code class=&quot;language-text&quot;&gt;contacts&lt;/code&gt;内のSNSアカウントについて、表示したくないものはコメントアウトではなく空欄にする必要があります。&lt;/p&gt;
&lt;p&gt;コメントアウトするとエラーが発生します。&lt;/p&gt;
&lt;h3 id=&quot;サイトデザインの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%88%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;サイトデザインの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サイトデザインの設定&lt;/h3&gt;
&lt;p&gt;サイトデザインを変更する場合は、各要素のテンプレートをそれぞれ編集する必要があります。&lt;/p&gt;
&lt;p&gt;今回はベースのレイアウトは変更せず、配色などを一部変更しました。&lt;/p&gt;
&lt;p&gt;基本のデザインを変更したい場合は&lt;code class=&quot;language-text&quot;&gt;blog/src/assets/scss/base/_generic.scss&lt;/code&gt;を編集します。&lt;/p&gt;
&lt;p&gt;内容は以下のようになっており、各要素の文字サイズや色、フォントなども変更することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/** 
 * Generic
 */&lt;/span&gt;
&lt;span class=&quot;token selector&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-root-font-size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;margin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0 0 0 &lt;span class=&quot;token function&quot;&gt;calc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;100vw - 100%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-family&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-font-family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-color&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-line-height&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-ms-text-size-adjust&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-webkit-text-size-adjust&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;text-rendering&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; optimizeLegibility&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-webkit-font-smoothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; antialiased&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-moz-osx-font-smoothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; grayscale&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h1,
h2,
h3,
h4,
h5,
h6&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-family&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-font-family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-weight&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 600&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1.8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;4&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.6875&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.375&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 省略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、リンクの色や一部の要素のサイズなどは&lt;code class=&quot;language-text&quot;&gt;blog/src/assets/scss/_variables.scss&lt;/code&gt;で定義されている変数にて設定されています。&lt;/p&gt;
&lt;p&gt;例えばリンクの色を変更したい場合は、&lt;code class=&quot;language-text&quot;&gt;$color-primary&lt;/code&gt;を変更する必要があります。&lt;/p&gt;
&lt;p&gt;コンテンツの最大幅は&lt;code class=&quot;language-text&quot;&gt;$layout-post-single-width&lt;/code&gt;で設定されています。&lt;/p&gt;
&lt;p&gt;そのため、僕のブログでも以下のようにベースカラーを一部変更しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;// Colors
$&lt;span class=&quot;token property&quot;&gt;color-base&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #222&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-primary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #918D40&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-secondary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #A9D159&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

$&lt;span class=&quot;token property&quot;&gt;color-white&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #FFF&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 40%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray-border&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 77%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray-bg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 79%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;コンテンツを追加編集する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E8%BF%BD%E5%8A%A0%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot; aria-label=&quot;コンテンツを追加編集する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コンテンツを追加、編集する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-starter-lumen&lt;/code&gt;を使用する場合、デフォルトでは以下の2タイプのコンテンツが用意されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pages：Aboutページなどの固定ページ&lt;/li&gt;
&lt;li&gt;Posts：ブログコンテンツ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これらはいずれも&lt;code class=&quot;language-text&quot;&gt;blog/content/&lt;/code&gt;ディレクトリの配下に配置されています。&lt;/p&gt;
&lt;p&gt;Gatsbyは、&lt;code class=&quot;language-text&quot;&gt;blog/src/cms/index.js&lt;/code&gt;の定義に沿って&lt;code class=&quot;language-text&quot;&gt;blog/content/&lt;/code&gt;配下のファイルを探索し、指定された形式のページとして識別します。&lt;/p&gt;
&lt;p&gt;そのため、デフォルトではすべてのブログページは&lt;code class=&quot;language-text&quot;&gt;blog/content/posts&lt;/code&gt;配下に置かれている必要がありますが、ここに&lt;code class=&quot;language-text&quot;&gt;notes&lt;/code&gt;などのカスタムディレクトリを追加したい場合は、以下のように&lt;code class=&quot;language-text&quot;&gt;CMS.registerPreviewTemplate&lt;/code&gt;にてディレクトリ名とテンプレートを紐づける必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// @flow strict&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;netlify-cms-app&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; PagePreview &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./preview-templates/page-preview&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; PostPreview &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./preview-templates/post-preview&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;pages&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PagePreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;posts&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PostPreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;notes&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PostPreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;記事のurlからディレクトリ名を削除する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AEurl%E3%81%8B%E3%82%89%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E5%90%8D%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B&quot; aria-label=&quot;記事のurlからディレクトリ名を削除する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事のURLからディレクトリ名を削除する&lt;/h3&gt;
&lt;p&gt;デフォルトでは、記事のURLは以下の形式になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;https://&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;カスタムドメイン&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;記事の存在するディレクトリ名&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;記事のSlug&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;URLに&lt;code class=&quot;language-text&quot;&gt;&amp;lt;記事の存在するディレクトリ名&gt;&lt;/code&gt;が埋まっていると、今後Markdownファイルのディレクトリを変更するたびにURLが変わってしまうのでよろしくありません。&lt;/p&gt;
&lt;p&gt;そのため、URLに&lt;code class=&quot;language-text&quot;&gt;&amp;lt;記事の存在するディレクトリ名&gt;&lt;/code&gt;が入らないように設定を変更します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;blog/gatsby/on-create-node.js&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;createNodeField&lt;/code&gt;を以下のように書き換えます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;internal&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;MarkdownRemark&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;frontmatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;slug &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;undefined&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dirname &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;relativeDirectory&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;createNodeField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;slug&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// value: `/${dirname}/${node.frontmatter.slug}`&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;frontmatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;slug&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでデプロイ時に生成されるURLからディレクトリ名を削除することができます。&lt;/p&gt;
&lt;h2 id=&quot;typoraの設定をする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#typora%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot; aria-label=&quot;typoraの設定をする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Typoraの設定をする&lt;/h2&gt;
&lt;p&gt;僕が愛用しているTyporaというマークダウンエディタの非常に便利な機能の1つに、画像をコピペすると自動的に任意のローカルフォルダに保存してくれる機能があります。&lt;/p&gt;
&lt;p&gt;Gatsbyの場合&lt;code class=&quot;language-text&quot;&gt;blog/static/media&lt;/code&gt;配下の画像に対して&lt;code class=&quot;language-text&quot;&gt;/media&lt;/code&gt;でアクセスできます。&lt;/p&gt;
&lt;p&gt;そのため、以下のようにTyporaの設定で、コピペされた画像が&lt;code class=&quot;language-text&quot;&gt;blog/static/media&lt;/code&gt;配下の任意のディレクトリに配置されるように設定を行いました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/525d3/image-20220221222611109.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWklEQVQoz42S3VKDMBCFeaZaAuEnQKAhtKZYtZ3q2AsvHX3/2+NuWiJ16owX3wQ27Nmzu0RxViHOa8QZU3nu0tKfIq9C7L9EIlOIJQsoEjiLVp1FWjRB2CNVQNwQ4lwmSrICIs2RyCIIWrdDqQ3yqkNaagjVQugeyYUlvXN8TnDILjxc/RKUVYuMxBQlC/rYlQ0+V2t8rUd80HlIcii6LxqDol5RRwMas0FCXUWdHaGNQ91tgsOJJRVZEEat8Ebix7rDK3GiZGMdFAnp/p6Ee2+AnUb74zse9ye43dFXmM9D5A0EjWJhXqBGYthCrXfoxgMKbn3WVWhZ0jwW1MLPZuvglE+Oa/uAYfsMM4wY3BMaapsdTQbmi4muHV2LcQK7qGnrune0KHuhBxvh+wmfyzOcC0zPhobPm+ahs2BatihbGwpwXM42LRl6P/+HN9xNH0+Ffrf110/Nd9//6Vjt6iNuBQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/8ac56/image-20220221222611109.webp 240w,
/static/915fae9fa8c5853d16b68d568fce6fff/d3be9/image-20220221222611109.webp 480w,
/static/915fae9fa8c5853d16b68d568fce6fff/e46b2/image-20220221222611109.webp 960w,
/static/915fae9fa8c5853d16b68d568fce6fff/36bbb/image-20220221222611109.webp 1090w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/8ff5a/image-20220221222611109.png 240w,
/static/915fae9fa8c5853d16b68d568fce6fff/e85cb/image-20220221222611109.png 480w,
/static/915fae9fa8c5853d16b68d568fce6fff/d9199/image-20220221222611109.png 960w,
/static/915fae9fa8c5853d16b68d568fce6fff/525d3/image-20220221222611109.png 1090w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/d9199/image-20220221222611109.png&quot;
            alt=&quot;image-20220221222611109&quot;
            title=&quot;image-20220221222611109&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、デプロイ時にブログページが適切な画像を参照できるようになります。&lt;/p&gt;
&lt;h2 id=&quot;github-pagesにデプロイする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#github-pages%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot; aria-label=&quot;github pagesにデプロイする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Pagesにデプロイする&lt;/h2&gt;
&lt;p&gt;さて、概ね形は整ったのでいよいよデプロイしていきます。&lt;/p&gt;
&lt;p&gt;基本的には公式の手順をベースにしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.gatsbyjs.com/docs/how-to/previews-deploys-hosting/how-gatsby-works-with-github-pages/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;How Gatsby Works with GitHub Pages | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まず必要なのは公開用のGithubリポジトリです。&lt;/p&gt;
&lt;p&gt;リポジトリの設定はパブリックにする必要があります。&lt;/p&gt;
&lt;p&gt;公開リポジトリにプッシュが完了したら、Github Pagesへのデプロイを始めていきます。&lt;/p&gt;
&lt;h3 id=&quot;パスの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;パスの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;パスの設定&lt;/h3&gt;
&lt;p&gt;今回はカスタムドメインを使用するので、&lt;code class=&quot;language-text&quot;&gt;blog\gatsby-config.js&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;pathPrefix&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt;を設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// pathPrefix: siteConfig.pathPrefix,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;pathPrefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、URLでアクセスする際に適切なパスを使えるようにするために必要な設定です。&lt;/p&gt;
&lt;p&gt;一方、カスタムドメインを指定しない場合は、&lt;code class=&quot;language-text&quot;&gt;pathPrefix&lt;/code&gt;にリポジトリ名を設定します。&lt;/p&gt;
&lt;h3 id=&quot;デプロイ用のカスタムスクリプトの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%94%A8%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;デプロイ用のカスタムスクリプトの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デプロイ用のカスタムスクリプトの作成&lt;/h3&gt;
&lt;p&gt;次にデプロイ用のスクリプトを設定します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;blog\package.json&lt;/code&gt;内の&lt;code class=&quot;language-text&quot;&gt;scripts&gt;deploy&lt;/code&gt;を以下のように設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token string-property property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;deploy&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rm -rf node_modules/.cache/gh-pages &amp;amp;&amp;amp; gatsby clean &amp;amp;&amp;amp; gatsby build --prefix-paths &amp;amp;&amp;amp; echo &apos;kashiwaba-yuki.com&apos; &gt; public/CNAME &amp;amp;&amp;amp; gh-pages -d public -b pages&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rm -rf node_modules/.cache/gh-pages&lt;/code&gt;は、ビルド時にエラーが発生しないよう、過去のキャッシュを削除しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby clean &amp;amp;&amp;amp; gatsby build --prefix-paths&lt;/code&gt;では、&lt;code class=&quot;language-text&quot;&gt;gatsby&lt;/code&gt;コマンドでコンテンツをビルドしています。&lt;/p&gt;
&lt;p&gt;変更内容を確実に反映させるために&lt;code class=&quot;language-text&quot;&gt;gatsby clean&lt;/code&gt;が必要です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;echo &apos;kashiwaba-yuki.com&apos; &gt; public/CNAME&lt;/code&gt;は、カスタムドメインを使用するためのCNAMEファイルを公開ディレクトリに配置するための記述です。&lt;/p&gt;
&lt;p&gt;これが無いとデプロイするたびにカスタムドメインが解除されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gh-pages -d public -b pages&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt;を使って&lt;code class=&quot;language-text&quot;&gt;pages&lt;/code&gt;ブランチにビルドしたコンテンツを配置しています。&lt;/p&gt;
&lt;p&gt;Gitリポジトリにプッシュするため、コンテナ内からリポジトリにプッシュできるようにしておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;pagesの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pages%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;pagesの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Pagesの設定&lt;/h3&gt;
&lt;p&gt;ここまで来たら後は簡単です。&lt;/p&gt;
&lt;p&gt;公開リポジトリの設定画面を開き、「Pages」で公開用のブランチ&lt;code class=&quot;language-text&quot;&gt;pages&lt;/code&gt;を指定してGtihub Pagesを公開します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f563b163d6bd711d854562d48559456d/dcccd/image-20220223010848772.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDElEQVQ4y22Ty3LbMAxFtW0cvUVRoiTqLVuPpOOk6abLTL+gq35E/395C0C2x0m7OAMNRV5cgKATZxZuqIXHIJVobI+qmaCLDgdfEekF9V/cQN80nCgtRegqxqjqBG2PMFWPWFdQlFTlTI2ESIt2j6aRtes5EWyGFRkd9KKMMpFopBH0NbJlQvl0gtlmpOu2s8yIRxIlJE4NfTcIu1JwVQZHc7a7sllQNXTAVoiqCiERVJao6ZtiWcIvSnjGwMtzwadvxo3Joe1Od/1LxWlLrm07o7AjqvZEcPkDMkoeaws/bWlvjkfq6wdIwzF2EJH7PjbjhuP2Av5n+xklCXLfQhI7BJxcSfL73t16OM5fwWVHupTSg8SgOz5jfn5DQTfNlyYXQ80PdAMvqW7J7xFBdsgH/DhHqApxythuRjttJFbdNh8ukff6sUFA0SPcKBe3uzA57I5PyMpe3F0Pc4ksaKiHzTCjHlechgU99TPJ91FhQl3DU5/GJslqPHjJzYFHGctulXJDcs8tYKcJESlzN69cjf6nl05NmXlA94X9Z0DzlBZW1tl5chnomNzFZpD2ROmOH2cfLsnhoeZLuWb44oZ4//kHbz9+o11eMazfMa4vGJczhplYX1FPZ6SWXlM9X1joZU3SX0fK5fd4EXzwY5y//cK0vdOhI72iiRg+oGlNFQNUOe6RSEwrF/oXt29Oq5a0OpwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f563b163d6bd711d854562d48559456d/8ac56/image-20220223010848772.webp 240w,
/static/f563b163d6bd711d854562d48559456d/d3be9/image-20220223010848772.webp 480w,
/static/f563b163d6bd711d854562d48559456d/e46b2/image-20220223010848772.webp 960w,
/static/f563b163d6bd711d854562d48559456d/0b154/image-20220223010848772.webp 1127w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f563b163d6bd711d854562d48559456d/8ff5a/image-20220223010848772.png 240w,
/static/f563b163d6bd711d854562d48559456d/e85cb/image-20220223010848772.png 480w,
/static/f563b163d6bd711d854562d48559456d/d9199/image-20220223010848772.png 960w,
/static/f563b163d6bd711d854562d48559456d/dcccd/image-20220223010848772.png 1127w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f563b163d6bd711d854562d48559456d/d9199/image-20220223010848772.png&quot;
            alt=&quot;image-20220223010848772&quot;
            title=&quot;image-20220223010848772&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回はCNAMEファイルも作成してカスタムドメインが有効になっているので、このドメインに接続すれば作成したブログを確認することができます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;WordPressの旧ブログから順次こちらに移行していく予定です。&lt;/p&gt;
&lt;p&gt;画像とか内部リンクとかの修正を手動でやる必要があるのでかなり手間がかかりそうです。。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -シリアルポート 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-011-kernel-main-08</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-011-kernel-main-08</guid><pubDate>Sun, 13 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-010-kernel-main-07&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の動きを確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#uartinit%E9%96%A2%E6%95%B0&quot;&gt;uartinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#uart%E3%81%A8%E3%81%AF&quot;&gt;UARTとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot;&gt;通信にシリアルポートを使用する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;uartinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#uartinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;uartinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;uartinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;uart.c&lt;/code&gt;関数で定義された関数で、シリアルポート関連の初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;COM1&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3f8&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; uart&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// is there a uart?&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Turn off the FIFO&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 9600 baud, 8 data bits, 1 stop bit, parity off.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Unlock divisor&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;115200&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9600&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Lock divisor, 8 data bits.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Enable receive interrupts.&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If status is 0xFF, no serial port.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Acknowledge pre-existing interrupt conditions;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// enable interrupts.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_COM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Announce that we&apos;re here.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;xv6...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;uartとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#uart%E3%81%A8%E3%81%AF&quot; aria-label=&quot;uartとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UARTとは&lt;/h3&gt;
&lt;p&gt;そもそもUARTとは何かですが、&lt;code class=&quot;language-text&quot;&gt;**Universal Asynchronous Receiver/Transmitter**（汎用非同期送受信機）&lt;/code&gt;を指すようです。&lt;/p&gt;
&lt;p&gt;UARTは、2つのデバイス間でシリアルデータを交換するためのプロトコルを指します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.rohde-schwarz.com/jp/products/test-and-measurement/oscilloscopes/educational-content/understanding-uart_254524.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;UARTの概要 | Rohde &amp;#x26; Schwarz&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Universal asynchronous receiver-transmitter - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;近年では主として使われていないようですが、UARTはシリアルポートによる通信で使用されていたプロトコルみたいです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数では、いわゆるCOMポートをセットアップしているようですね。&lt;/p&gt;
&lt;h3 id=&quot;通信にシリアルポートを使用する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot; aria-label=&quot;通信にシリアルポートを使用する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信にシリアルポートを使用する&lt;/h3&gt;
&lt;p&gt;OSが通信にシリアルポートを使用する場合は、初めにシリアルポートを初期化する必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Serial_Ports&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial Ports - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ソースコードを順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;COM1&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3f8&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Turn off the FIFO&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0x3f8&lt;/code&gt;として定義されています。&lt;/p&gt;
&lt;p&gt;これは、固定されたCOM1ポートのIOポートのアドレスです。&lt;/p&gt;
&lt;p&gt;各COMポートのレジスタについては、IOポートアドレスからのオフセットでアクセスできます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+2&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Interrupt Identification&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;FIFO control registers&lt;/code&gt;を指します。&lt;/p&gt;
&lt;p&gt;ここでは、0をセットすることでUART内のFIFOの動作を無効化しています。&lt;/p&gt;
&lt;p&gt;FIFOが無効化されている場合、受信したデータは&lt;code class=&quot;language-text&quot;&gt;Receiver buffer register&lt;/code&gt;に受け渡されます。&lt;/p&gt;
&lt;p&gt;続いて、以下のコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 9600 baud, 8 data bits, 1 stop bit, parity off.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Unlock divisor&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;115200&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9600&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Lock divisor, 8 data bits.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Enable receive interrupts.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+3&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Line control register&lt;/code&gt;に該当します。&lt;/p&gt;
&lt;p&gt;これは、セットされたbitに応じて通信パラメータを変更します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 428px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 102.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD5UlEQVQ4y2VUW2/bZBjO30RCQ0jco0kIiRu4KFRC4gaBEFyAgNttQqDCurVdS8fSdlm7tEua2LFzsJ2D48RnO+c8PO+XjRU10asvtuP3e97n8BW2fj3C3W928OHXO/jgy9/w0Xe7+OynPby/fQ8ff/8Yn/zwCJ/+uIetX57g7rd/4d3P7+HO9gPc+eJtvbd9H+9sPcBXP++gMBwFMBs6vOEQSRSiaZqoVF5Ba9SRJjE0rYa6Voemy3WC6STDJM8wvVGTPMV8PsPZ+SUKozAFsOYXyLMMQza2LAtDz8NiPke366Db66I/6GGxWGK1Wt2q5XIJ+ZTKFRQcd4yESJI0Vc00TUO1ckWEDURRhFq9hur1tUIZhCHiOL5V8r80y3FSKqPgKYTAar1WCF13CMe2MBqPOd4EtmPDJkqH65yIBc3tWrxF2PdCxV/GZr4/VhxWqxWO2VfIDV6bpgGLDSeTKWtyq9I0Qc5npy/IoTuOEBPyZDpVpA/6fYUmCEL+OUen04FpNGDbDjcM4A5dUiPlYTwawfOGfHcGDoiziysUgmSCN5/5bIYxRxXEKTldLBZs2CZqA7quod22YNk2DMNU3Oq6rjj3KGBELs8vayh0ui503hTuItqm2+2qsce+D5/NDYojLwlCIT+OYoV0THqkkeeNFGI/CDYj94Y+hq6LmOPKyLXrqmogiibctdVqoU0buUQtiGecYrGYq98ihqxSYrvnF6/IoR9jvVqqm1EY4LJcRqNhYER+ojBCkw3NZhOtdhtT8ixKy3qzRJg5Pao47HuBcn7Om6KyNBSEYuwRCZeRTaPJe7raRGhIkhR5nitnvKkpkZ9KUryAPlyL21f0YY4GFRVlhYI8S+FYNnq0UH/QR4/8tolY7CMJ2Yy9mU758CV92JWkxJFS1SWXV1fMMRV0+PKIKEXJWq3Ojag0UWq8DknF/9MSEeXrpPhxTj95KikpH4rCfXpRbJBxE9NsEmGPlmmrTDdbwmdL8bbmOzez/KJcZZYHY3ZPyUtCDn2FSJoOiFb8WK/X2XTjuyYbabUaJ9BU9uW9VK2ZoqFYesnTJsqoZsid1qqhwdFsmtdnUlKSr+uGokLEGZDHDjm0HIcnUoeTDBS3DT7r08fnl9dUeRS+Ps/mmyw3TVgURRITcyNRVxo5dkdFUpLT6bTUKnZq8LwUg89mc6pM21T1Np6dXSi4x8USHh8+xd7hPzh69hzHJyXsHhzjydNTHBwXsf93EQ/3j/Bw71Ctf+we4Pc/H/H5CfaPiup/BZFcFMroqzyf0KgzdVCIL/+7VqfMVP3uUbAuRZKISoIs2qpJpJVKldGM8S+pabx/t0/rAgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ac56/image-54.webp 240w,
/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/3b73a/image-54.webp 428w&quot;
              sizes=&quot;(max-width: 428px) 100vw, 428px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ff5a/image-54.png 240w,
/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png 428w&quot;
            sizes=&quot;(max-width: 428px) 100vw, 428px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png&quot;
            alt=&quot;2022/02/image-54.png&quot;
            title=&quot;2022/02/image-54.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.lammertbies.nl/comm/info/serial-uart&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial UART, an in depth tutorial - Lammert Bies&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;outb(COM1+3, 0x80);&lt;/code&gt;は8bit目をセットして&lt;code class=&quot;language-text&quot;&gt;DLAB&lt;/code&gt;を有効化しています。&lt;/p&gt;
&lt;p&gt;これによって、次の&lt;code class=&quot;language-text&quot;&gt;COM1+0&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;COM1+1&lt;/code&gt;への書き込みアクセスが&lt;code class=&quot;language-text&quot;&gt;Divisor latch registers (R/W)&lt;/code&gt;に変化します。&lt;/p&gt;
&lt;p&gt;ここに&lt;code class=&quot;language-text&quot;&gt;115200/9600&lt;/code&gt;と0をそれぞれ書き込むことでUARTのタイムベースを9,600bpsに設定していることになります。&lt;/p&gt;
&lt;p&gt;続く&lt;code class=&quot;language-text&quot;&gt;outb(COM1+3, 0x03);&lt;/code&gt;では、LRCの&lt;code class=&quot;language-text&quot;&gt;DLAB&lt;/code&gt;を解除するとともに&lt;code class=&quot;language-text&quot;&gt;8 data bits&lt;/code&gt;をセットしています。&lt;/p&gt;
&lt;p&gt;その後、&lt;code class=&quot;language-text&quot;&gt;Modem control register&lt;/code&gt;に0をセットした後、割込みを有効化してます。&lt;/p&gt;
&lt;p&gt;一通りの初期化処理を行った後、&lt;code class=&quot;language-text&quot;&gt;Line status register&lt;/code&gt;のチェックを行ってシリアルポートが利用可能であることを確認しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// If status is 0xFF, no serial port.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、RBRとIIRの情報を参照して現在の割込み状態を確認した後、割込みを有効化して終了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Acknowledge pre-existing interrupt conditions;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// enable interrupts.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_COM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はシリアルポートの初期化処理を追いかけてました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;pinit&lt;/code&gt;関数です。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -画面描画 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-010-kernel-main-07</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-010-kernel-main-07</guid><pubDate>Fri, 11 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-009-kernel-main-06&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数の動きを確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#consoleinit%E9%96%A2%E6%95%B0&quot;&gt;consoleinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;devsw構造体について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#inode%E3%81%A8%E3%81%AF&quot;&gt;inodeとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;consolewrite関数を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF&quot;&gt;ビデオメモリの書き込み&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;consoleread関数を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;consoleinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consoleinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;consoleinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consoleinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;console&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;locking &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_KBD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず1行目の&lt;code class=&quot;language-text&quot;&gt;initlock(&amp;amp;cons.lock, &quot;console&quot;);&lt;/code&gt;ですが、これは&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;メモリ割り当て・排他制御 編&lt;/a&gt;で確認したメモリロックのために&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体を初期化する関数でした。&lt;/p&gt;
&lt;p&gt;今回使用している&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cons.lock&lt;/code&gt;は、以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; locking&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; cons&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の中ではメモリロックは行われません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数や&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数などが実行される際に、&lt;code class=&quot;language-text&quot;&gt;cons&lt;/code&gt;が使われてメモリロックが行われます。&lt;/p&gt;
&lt;p&gt;続いて、以下の行を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで参照している&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の配列であり、この配列は&lt;code class=&quot;language-text&quot;&gt;file.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NDEV&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の定義は&lt;code class=&quot;language-text&quot;&gt;file.h&lt;/code&gt;で行われています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// table mapping major device number to&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// device functions&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;write&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CONSOLE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに&lt;code class=&quot;language-text&quot;&gt;NDEV&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で10と定義されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NDEV&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum major device number&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;devsw構造体について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;devsw構造体について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;devsw構造体について&lt;/h3&gt;
&lt;p&gt;ここで詳しく知りたいのは、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体が何者かという点です。&lt;/p&gt;
&lt;p&gt;UNIXのマニュアルなどを見ると、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体はデバイスドライバが&lt;code class=&quot;language-text&quot;&gt;character device interfaces&lt;/code&gt;を持つ場合に使用されるもののように見えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://man.netbsd.org/devsw.9&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;devsw(9) - NetBSD Manual Pages&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、以下のページのように、「システムが一文字ずつデータを転送する機器に対応」した入出力インターフェースが&lt;code class=&quot;language-text&quot;&gt;character device interfaces&lt;/code&gt;に該当すると考えられます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバイスファイル - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の定義を見ると、&lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;write&lt;/code&gt;の2種類の関数ポインタが設定されています。&lt;/p&gt;
&lt;p&gt;ここには、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数のように任意の関数割り当てが行われます。&lt;/p&gt;
&lt;p&gt;引数にはいずれも&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体が含まれます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体は、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体と同様に&lt;code class=&quot;language-text&quot;&gt;file.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// in-memory copy of an inode&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint dev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// Device number&lt;/span&gt;
  uint inum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Inode number&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ref&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// Reference count&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sleeplock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// protects everything below here&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; valid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// inode has been read from disk?&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// copy of disk inode&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; major&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; minor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; nlink&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint addrs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NDIRECT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;inodeとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#inode%E3%81%A8%E3%81%AF&quot; aria-label=&quot;inodeとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;inodeとは&lt;/h3&gt;
&lt;p&gt;そもそも&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;とは何かについて触れておきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;とはざっくり言うとファイル、ディレクトリなどのファイルシステムのオブジェクトに関する情報が格納されている構造体です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の持つ情報としては以下のようなものが挙げられます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ファイルサイズ(バイト数)&lt;/li&gt;
&lt;li&gt;ファイルを格納しているデバイスのデバイスID&lt;/li&gt;
&lt;li&gt;ファイルの所有者、グループのID&lt;/li&gt;
&lt;li&gt;ファイルシステム内でファイルを識別するinode番号&lt;/li&gt;
&lt;li&gt;タイムスタンプ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/Inode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;inode - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSの&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体を見ても上記に近い情報が格納されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;は、システム内に一意のIDで管理されます。(xv6OSでは恐らく&lt;code class=&quot;language-text&quot;&gt;inum&lt;/code&gt;が該当する)&lt;/p&gt;
&lt;p&gt;割り当て可能な&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;番号には通常上限があり、もし&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;番号が枯渇した場合は、ストレージデバイスのディスク容量に空きがあっても新規にファイルの作成ができなくなります。&lt;/p&gt;
&lt;p&gt;一般的なLinuxシステムの場合は、&lt;code class=&quot;language-text&quot;&gt;df -i&lt;/code&gt;コマンドで各デバイスごとの使用可能な&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の上限を確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;df&lt;/span&gt; -i
Filesystem                         Inodes  IUsed   IFree IUse% Mounted on
udev                              &lt;span class=&quot;token number&quot;&gt;1007124&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;449&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1006675&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /dev
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;919&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1018235&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run
/dev/mapper/ubuntu--vg-ubuntu--lv &lt;span class=&quot;token number&quot;&gt;1310720&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;380878&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;929842&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;% /
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019153&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /dev/shm
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019149&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/lock
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;18&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019136&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /sys/fs/cgroup
/dev/loop0                             &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/bare/5
/dev/loop2                          &lt;span class=&quot;token number&quot;&gt;10847&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;10847&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core18/2284
/dev/loop1                          &lt;span class=&quot;token number&quot;&gt;10836&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;10836&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core18/2253
/dev/loop3                          &lt;span class=&quot;token number&quot;&gt;11776&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;11776&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core20/1270
/dev/loop5                          &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gnome-3-34-1804/72
/dev/loop4                          &lt;span class=&quot;token number&quot;&gt;11777&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;11777&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core20/1328
/dev/loop6                          &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gnome-3-34-1804/77
/dev/loop7                          &lt;span class=&quot;token number&quot;&gt;65095&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;65095&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gtk-common-themes/1519
/dev/loop8                            &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/lxd/21835
/dev/loop9                          &lt;span class=&quot;token number&quot;&gt;64986&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;64986&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gtk-common-themes/1515
/dev/loop10                           &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/lxd/21545
/dev/loop11                           &lt;span class=&quot;token number&quot;&gt;479&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;479&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/snapd/14295
/dev/loop12                           &lt;span class=&quot;token number&quot;&gt;482&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;482&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/snapd/14549
/dev/sda2                           &lt;span class=&quot;token number&quot;&gt;65536&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;320&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;65216&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /boot
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;45&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019109&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/user/121
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019071&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/user/1000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kazmax.zpp.jp/linux_beginner/inode.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;iノード（inode）とは&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;consolewrite関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;consolewrite関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consolewrite関数を読む&lt;/h3&gt;
&lt;p&gt;この時点ではまだ&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;を使ってファイルを作成することはないので、ひとまずxv6OSのコードに戻ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;配列の&lt;code class=&quot;language-text&quot;&gt;CONSOLE = 1&lt;/code&gt;要素の&lt;code class=&quot;language-text&quot;&gt;write&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt;には、それぞれ&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で定義された関数が割り当てされます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数を読んでみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consolewrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数はターゲットとなる&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体変数のポインタと&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数に引き渡す文字およびその長さが引数として与えられます。&lt;/p&gt;
&lt;p&gt;まず&lt;code class=&quot;language-text&quot;&gt;iunlock&lt;/code&gt;関数ですが、これは&lt;code class=&quot;language-text&quot;&gt;fs.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Unlock the given inode.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holdingsleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ref &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;iunlock&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;releasesleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この関数についてはファイルシステムを扱う際に詳しく見ていきますが、受け渡しされた&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の持つ‘sleeplock‘構造体を操作してロックを解放しています。&lt;/p&gt;
&lt;p&gt;続いては&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;でロックを取得した後、&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数に受け渡しされた文字列を一文字ずつ流し込んでいます。&lt;/p&gt;
&lt;p&gt;この時、与えられた文字列は&lt;code class=&quot;language-text&quot;&gt;0xFF&lt;/code&gt;とのANDになるので、印字可能な状態が担保されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;panicked&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cgaputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、与えられた値を引数として&lt;code class=&quot;language-text&quot;&gt;uartputc&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartputc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;uart.c&lt;/code&gt;で定義された関数で、シリアルポート(UART)への空きこみを行います。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;COM1(I/Oポート 0x3f8)&lt;/code&gt;に受け取った値を書き込んでいます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;uart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;microdelay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+0&lt;/code&gt;はデータレジスタになっており、ここに値が書き込まれると送信バッファに書き込みが行われます。&lt;/p&gt;
&lt;p&gt;その前の行の&lt;code class=&quot;language-text&quot;&gt;inb(COM1+5)&lt;/code&gt;はラインステータスレジスタの値の読み取りを行っています。&lt;/p&gt;
&lt;p&gt;ラインステータスレジスタの6番目のbitは&lt;code class=&quot;language-text&quot;&gt;THRE&lt;/code&gt;と呼ばれるレジスタで、このbitが立っているときは送信バッファが空で、新たなデータを送信可能であることを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Serial_Ports&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial Ports - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;つまり&lt;code class=&quot;language-text&quot;&gt;!(inb(COM1+5) &amp;amp; 0x20)&lt;/code&gt;の行は、ラインステータスレジスタの&lt;code class=&quot;language-text&quot;&gt;THRE&lt;/code&gt;をチェックして、送信バッファが使用可能でない場合は&lt;code class=&quot;language-text&quot;&gt;microdelay&lt;/code&gt;関数により処理を遅延させる処理を行っているわけです。&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;BACKSPACE&lt;/code&gt;が入力された場合の書き込みが&lt;code class=&quot;language-text&quot;&gt;uartputc(&apos;\b&apos;); uartputc(&apos; &apos;); uartputc(&apos;\b&apos;);&lt;/code&gt;になっているのは、カーソルを一つ戻してスペースで上書きした上で、もう一度書き込み前の位置にカーソルを戻しているイメージみたいです。&lt;/p&gt;
&lt;h3 id=&quot;ビデオメモリの書き込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;ビデオメモリの書き込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ビデオメモリの書き込み&lt;/h3&gt;
&lt;p&gt;シリアルポートへの書き込みが完了したら、最後に&lt;code class=&quot;language-text&quot;&gt;cgaputc&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cgaputc&lt;/code&gt;関数では、入力値をビデオメモリに書き込んで出力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cgaputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Cursor position: col + 80*row.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// black on white&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pos under/overflow&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Scroll up.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memmove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pos &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで使用している書き込み先の&lt;code class=&quot;language-text&quot;&gt;crt&lt;/code&gt;はアドレス&lt;code class=&quot;language-text&quot;&gt;0xb8000&lt;/code&gt;の領域です。&lt;/p&gt;
&lt;p&gt;この領域はフレームバッファと呼ばれる領域です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK: 50&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BACKSPACE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CRTPORT&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3d4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; ushort &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;crt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ushort&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xb8000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// CGA memory&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://e-words.jp/w/%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%90%E3%83%83%E3%83%95%E3%82%A1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;フレームバッファ（frame buffer）とは - IT用語辞典 e-Words&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;3.-The Screen&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まず&lt;code class=&quot;language-text&quot;&gt;CRTPORT&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;CRT Controller&lt;/code&gt;のレジスタである&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;を指しています。&lt;/p&gt;
&lt;p&gt;これは制御用のレジスタで、&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;に対応するデータレジスタ領域は&lt;code class=&quot;language-text&quot;&gt;0x3D5&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;この2つの領域を利用してコンソール上のカーソル位置をコントロールできます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;に14をセットすることで、16bitで表現されるカーソルの上位8bitを制御することを指定します。&lt;/p&gt;
&lt;p&gt;そして、15をセットした場合は、カーソルの下位8bitを制御することを指定します。&lt;/p&gt;
&lt;p&gt;つまり、以下の行では変数&lt;code class=&quot;language-text&quot;&gt;pos&lt;/code&gt;に現在のカーソルの16bitを格納しているわけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pos &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで取得したカーソルの上位bitと下位bitの関係は以下のようになります。&lt;/p&gt;
&lt;p&gt;上位8bitがカーソルの行の位置を指し、下位8bitが何文字目かを指しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB4ElEQVQ4y52UiW7aQBCGjd1KTQQ4QRBzBFVRpUqN2kp9/xcBQgLGBzZHEoPNYhvzZ2eJjQNJmnalj/UMs/9eMyv5qxBRvEEY7Yg3CbcT0aeQnSeNzUMaAYsghVGMfDMMA67rotfrodvpoN+/gWVZ0HUd+nAI0zTxVluHMST6obbdbjkAY2tEUQQ/CLBYLLBcLuH7PgJuU88YQ8xXkyRbTiKgsa8KHs24ZpmfrVYY2zafYPHxFdLMs/kDJtM5prN7OO40+x47EximDXvsihjyEbP5PT/nzaHgbhUjw8SP6584r1SgaXVcEBcaahz61uoN4U/tarWG9tcr9G8HYvyKhZDYOsq2NRiOoJ6dQ5KkD6Mon9Hp3uwFKQ3SNtRHYmYKlGUFhUJBkBdIfbIsC/vktMgzor8XpHPwPC8TrNa0bGAqUiqVoKoqisXi0Qq/nJyi28utkA444OnwniAJVfi5lsvlvwu+uWXlP7d8dCnq2T9diqx8enkpL9PGwq/ff0RatC7baLYuBY0m71Oefa1WG/VGE1ffvuP2bnAouEtsKrmx48KyHdgc6xnHnYjEJqycP40J+bgssQ8fh1dLipeg5z2K/t04Ejx8vmiCMNxBAfQflR+V3cOjJ2zyi7iM/fP1BEPRt77flC1tAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ac56/image-37.webp 240w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/d3be9/image-37.webp 480w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/b0a15/image-37.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ff5a/image-37.png 240w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/e85cb/image-37.png 480w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png&quot;
            alt=&quot;2022/02/image-37.png&quot;
            title=&quot;2022/02/image-37.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下の行は、改行文字が渡された場合の挙動です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーソル位置が次の行の一番左端の位置になるように&lt;code class=&quot;language-text&quot;&gt;pos&lt;/code&gt;を加算しています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;BACKSPACE&lt;/code&gt;が与えられた場合はカーソル位置を一つ戻します。&lt;/p&gt;
&lt;p&gt;文字入力が与えられた場合は、16bitの文字データを格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// black on white&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この文字データの上位8bitには、背景と文字の色の情報が保持されます。&lt;/p&gt;
&lt;p&gt;また、下位8bitには表示する文字が指定されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 311px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVQY012RiWrjQBBE/f9/tRByrCzbClkfso7IOmZG10iWJcvOwstIgRDS8KhqKHp66EVXDaReQaMuhp4iaZBRRZWd516LjjzWVGmLliYj+1l/+sZQJi0izFlkQcnLg013vnDtb4T+O7a1RqSKcbjR1C3u/kgcJeiqoe+uDJeJkf48fPWGoxuwszwW4T7m6fEZa/mX9Xo1s91tefv3xnJp4TibGSEFt9s46+kUERmkEsRJjFKSrr/w+rydBqZUuWa/P7DZOOhaUxuapsWylnieP29flRVTCSHx/QDXPSIySeCHSKm4f/zHeTIDRVSYdSOC9xjPjwij1LyekcmCUyxIzNcnHyfSaIkqaoqymZl8XmpUXpOazNEJWahQYf+xOTgHdvaO1cMKEQg+2jujHr+or996NUf8zWC4m7x0JZ/C87uCiI7abQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9119764dfbb86dac586e9a998536c1a0/8ac56/image-35.webp 240w,
/static/9119764dfbb86dac586e9a998536c1a0/c6a73/image-35.webp 311w&quot;
              sizes=&quot;(max-width: 311px) 100vw, 311px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9119764dfbb86dac586e9a998536c1a0/8ff5a/image-35.png 240w,
/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png 311w&quot;
            sizes=&quot;(max-width: 311px) 100vw, 311px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png&quot;
            alt=&quot;2022/02/image-35.png&quot;
            title=&quot;2022/02/image-35.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;3.-The Screen&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にデバッガで確認してみると、この処理によってコンソールに文字が表示されていることを確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACYklEQVQoz4WTy08TURSHp6R2Wlpo7HTamekLSukLKO20tNPHTB8gJYSSkOhCE1cu1CiPugGi6MYYFz7+AxNXrvRf/Lwd0I0kLr7cc29yf/d37jlHGms1Buomo0STfmyTgbbOMNHC0arY2gZOrEYzVPyLJagHihym8/ya5vj+tMIbR+XtQOGqH0GykyadqIktLvbjJj2lSnNxjWaw6NIKzkRKWAtld20vlDDlAkdLeX68MPl51ubrJMPHHYX32ypSK1XFiln09CYHhSH7OQcrfC3YEiJmKE81tEI1eIOIzXCZw2yOd3sZvj1Z48tRkquRyrtBDMlKV7C0jki3Ri/VpCdSnaXZiazTWCzxYHzEyekxp8cnvJpOXS7Oz7m8OOdMnJ8dP2d6+pKpOL989hipn6pzb6nLji7STtZp3S0yjK3hRFdpR1bJaxk0Q0fTNBLJBOl0mriIo9Eoum64GIJoXCOrK0iT4pD7tTGT8ohJYSCclbD1IqOkEI2UMYIKXtmHX5bxeDxIkvQPnptVCcwh7S53OCgO2Mv2GC93sZUK20aD3eSWqH6NnJoRr6vE1BjzgXlkIez3+11kn4zP5yMgYskzRyx0Rwjm+myJP7SNJs4MIdIVlbZENdvhDSLexVtd3eYwPhPcK4wwDZtOfAs749BPtumKittag77WRPUrN5c8twrNmPNc77UFIbgj0mxH61jCmRUXzSx6sT3rxfC625OqP/Jfh39Q5r1Iw/j1pGynWgx0MTF6haHewIlvupNiRgqsyDo52XBZ9RsseQ2cRIIPkxSfH2X59NDkYr/M691lfgMT9j+/578oxQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/287bd96654e766d4a3f99968fe97efa7/8ac56/image-34.webp 240w,
/static/287bd96654e766d4a3f99968fe97efa7/d3be9/image-34.webp 480w,
/static/287bd96654e766d4a3f99968fe97efa7/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/287bd96654e766d4a3f99968fe97efa7/8ff5a/image-34.png 240w,
/static/287bd96654e766d4a3f99968fe97efa7/e85cb/image-34.png 480w,
/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png&quot;
            alt=&quot;2022/02/image-34.png&quot;
            title=&quot;2022/02/image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次の処理は非常にシンプルで、最大の行数である24行をオーバーした場合に、先頭行を削除してスクロールした上で、末尾の行を空行にしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Scroll up.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memmove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の処理は、現在のカーソル位置を&lt;code class=&quot;language-text&quot;&gt;CRTPORT&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;CRTPORT+1&lt;/code&gt;に保存しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数によるコンソールへの書き込みが完了します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数に戻ったらメモリロックの解除と&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;のロックを行って終了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;consoleread関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;consoleread関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consoleread関数を読む&lt;/h3&gt;
&lt;p&gt;次は&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数を読んでいきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;と読み取り先のポインタ、読み取るバッファサイズを引数として受け取ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consoleread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  target &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;w&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;myproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;killed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;D&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// EOF&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// Save ^D for next time, to make sure&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// caller gets a 0-byte result.&lt;/span&gt;
        input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; target &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolwrite&lt;/code&gt;関数同様メモリロックと&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;のロック解除を行った後、指定されたバッファサイズのループ内で以下の処理を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;D&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// EOF&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Save ^D for next time, to make sure&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// caller gets a 0-byte result.&lt;/span&gt;
    input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;input&lt;/code&gt;構造体は以下の構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;INPUT_BUF&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Read index&lt;/span&gt;
  uint w&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Write index&lt;/span&gt;
  uint e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Edit index&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;input&lt;/code&gt;構造体に入ってきた値を1文字ずつ読みだして取得しているようです。&lt;/p&gt;
&lt;p&gt;実際にこの処理が呼び出されるのは、OSの起動が完了してからです。&lt;/p&gt;
&lt;p&gt;具体的には、シェルに入力した文字を取得する際などに使用されます。&lt;/p&gt;
&lt;p&gt;以下の画像は、コンソールに「l」という文字を打ち込んだ際の挙動をデバッガで確認したときのものです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACZklEQVQoz4VTSW/TQBidNnYIzerETtokbaqozeY6e7xNHGfpRkq6QVNa2v4DRCUoJy69IBDiwoUrFyQucOAvIH7X44svwIUensbfjPX0lhm2uVSHk6hBD5VhhMvQZ4hptFa8vb9hRCowI/QdLKMvl/HpSsP3F028m6zjdiDjdpgEG+Zb6M0IFwowggX6uejBCJVo/rPO9hpCHvX5VWhsFWZgGW+3Uvj2TMeXpyv4sBnCGzcMZi830UnZsJUGnGUOLtdhxuukRoUeJaXRDRgEXapibIxwNBzjeDTB6fZDXD/ZwfvrKT7eTPHqag8vz7fBeJYsr3ThpmpwF1twlmoYJKsw4mVYCbKYIKsxUkoWjw4OMD079XB2cY7p+QX2H51i7/AxJkeE4xOwcaGHSWmA3TzHeN1BTyF1MRU8VYWba4AvbhBUGIkSfGwOjLH/Y18d4qS5S6R9HKojDEilFVrHMFnCg1wR/UwZo1wFbqaCbDKNTDYDRVEQCATg9/v/gSiKYKNVG+4Kh5vuoJe1wJUmHMqzSxk6URU2Nc4pPyuuIRVXEJNiCAWD8Pl8HoEoiN4qCIK3x7bWXDQzLiylhXbagZXS4WQ5OlHKUW6gQwVxugVtSYN/Trzb8mbe8YhMuQk9zT3iWUk2Ec/U6rEqTFLZoqZFJtxNOMySogQ1vdTyirCTbXTlKnrUqhEtkdUquqTQlFRE/AtkcR73BMpsXkB8QYASEaGE/UiE7kOimfWlCrrUqiPXKCsNFuVlSxuwo3RV6FWYdDabLcqzHS6gFV5DnR5BTyni62URP29U/HrN8eN5H58vNfwGvBdC44No/BYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/8ac56/image-38.webp 240w,
/static/43ea7f9468b2523fc26c4779efb0ac06/d3be9/image-38.webp 480w,
/static/43ea7f9468b2523fc26c4779efb0ac06/b0a15/image-38.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/8ff5a/image-38.png 240w,
/static/43ea7f9468b2523fc26c4779efb0ac06/e85cb/image-38.png 480w,
/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png&quot;
            alt=&quot;2022/02/image-38.png&quot;
            title=&quot;2022/02/image-38.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ユーザの入力値がどのように&lt;code class=&quot;language-text&quot;&gt;input.buf&lt;/code&gt;に格納されるかは、実際にシェルが使えるようになってから詳しく追っていこうと思います。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;ioapicenable(IRQ_KBD, 0);&lt;/code&gt;で割込みを有効化して、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数は終了します。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はコンソールの初期化を行いました。&lt;/p&gt;
&lt;p&gt;入出力インターフェースの仕組みについて知ることができたので非常に興味深かったです。&lt;/p&gt;
&lt;p&gt;次回はシリアルポートを初期化する&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数から見ていきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -IOAPIC 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-009-kernel-main-06</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-009-kernel-main-06</guid><pubDate>Sun, 06 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-008-kernel-main-05&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#picinit%E9%96%A2%E6%95%B0&quot;&gt;picinit関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ioapicinit%E9%96%A2%E6%95%B0&quot;&gt;ioapicinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%81%9Fioapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E9%A0%98%E5%9F%9F%E3%81%AE%E5%8F%82%E7%85%A7&quot;&gt;メモリマップされたIOAPICレジスタ領域の参照&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#data%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;Dataレジスタ経由でデータの読み書きを行う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#redirection-table%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;Redirection Tableの初期化&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;picinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#picinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;picinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;picinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;picirq.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;以下の通りかなり小さい関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;types.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;traps.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// I/O Addresses of the two programmable interrupt controllers&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IO_PIC1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Master (IRQs 0-7)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IO_PIC2&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xA0&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Slave (IRQs 8-15)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Don&apos;t use the 8259A interrupt controllers.  Xv6 assumes SMP hardware.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// mask all interrupts&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IO_PIC1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IO_PIC2&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK!&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Blank page.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;outb&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;で定義された以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ushort port&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uchar data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;out %0,%1&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;d&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;任意のポートにデータを送信するアセンブリを発行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/8365746/what-does-outb-in-att-asm-mean&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - what does “outb” in AT&amp;#x26;T asm mean? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;0x21&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0xA1&lt;/code&gt;という&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;に関連したポートをマスクしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;は、割込み要求を受け入れ、CPUに送信する割込みコントローラですが、SMPをサポートするxv6OSではAPICによる割込みを実装するため、無効化する必要があります。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;0x21&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0xA1&lt;/code&gt;は、どちらも&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;のデータポートになります。&lt;/p&gt;
&lt;p&gt;以下のOSDevのWikiにある通り、ローカルAPICとIOAPICによる割込みを実装する場合は、これらのデータポートに&lt;code class=&quot;language-text&quot;&gt;0xFF&lt;/code&gt;を設定して&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;を無効化します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/PIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;8259 PIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/62329557/i-o-port-addressing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - I/O Port Addressing - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ioapicinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ioapicinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;ioapicinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ioapicinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数の処理が完了し、PICが無効化されました。&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数が&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数から呼び出されます。&lt;/p&gt;
&lt;p&gt;この関数では、IOAPICの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;IOAPIC&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  maxintr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_VER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ioapicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ioapicinit: id isn&apos;t equal to ioapicid; not a MP\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Mark all interrupts edge-triggered, active high, disabled,&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// and not routed to any CPUs.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; INT_DISABLED &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;コードを順番に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;メモリマップされたioapicレジスタ領域の参照&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%81%9Fioapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E9%A0%98%E5%9F%9F%E3%81%AE%E5%8F%82%E7%85%A7&quot; aria-label=&quot;メモリマップされたioapicレジスタ領域の参照 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリマップされたIOAPICレジスタ領域の参照&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapic = (volatile struct ioapic*)IOAPIC;&lt;/code&gt;の行では変数&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;構造体を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IOAPIC&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// ioapic.c&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IOAPIC&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xFEC00000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Default physical address of IO APIC&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IOAPICのアドレスはデフォルトで&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;になることが保証されているため、このアドレスを固定値として指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/24828186/about-the-io-apic-82093aa&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - About the IO-APIC 82093AA - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;構造体は、以下のように非常にシンプルな構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// IO APIC MMIO structure: write reg, then read or write data.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint pad&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://web.archive.org/web/20161130153145/http://download.intel.com/design/chipsets/datashts/29056601.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Memory Mapped Registers for Accessing IOAPIC Registers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 17.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAA4klEQVQY0y2O6W6DMBCE8/6PVvVX2uYCwhpiDJgz2E5KVX11aVdazcweo9kp6zCj51B07KXlTSwvl5rXtKGbFh4hMC+euwuEyBf3qwNTnIXwwHnP4v93EXfE+v5amYaep1+4mYaPrGToe9xyR+uKw1VzzDXGGKSy7JOS90xj+xFRJRfRtE3DOeJm+Hx+0nU90zyjRDgfj4gonHPYtsXoG6aKT5E/gkfyjLY2W3rJc86nE000lPz6Z7iuK9Za+phKKUWSJBRlyTiOW6qiKGKXGx+GARW1MfW2lxggTVOqqtrufgDVECrAWoI6dQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/45b8bf0613c0fee518900e712948f7c0/8ac56/image-6.webp 240w,
/static/45b8bf0613c0fee518900e712948f7c0/d3be9/image-6.webp 480w,
/static/45b8bf0613c0fee518900e712948f7c0/b0a15/image-6.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/45b8bf0613c0fee518900e712948f7c0/8ff5a/image-6.png 240w,
/static/45b8bf0613c0fee518900e712948f7c0/e85cb/image-6.png 480w,
/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png&quot;
            alt=&quot;2022/02/image-6.png&quot;
            title=&quot;2022/02/image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の&lt;code class=&quot;language-text&quot;&gt;reg&lt;/code&gt;がインデックスとして使用され、&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;の領域を利用して読み書きを行われます。&lt;/p&gt;
&lt;p&gt;実際に起動時に&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;の領域に格納される値がどうなっているのか気になったのでデバッガで確認してみました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;から20バイト分の領域を見てみましたが、この時点ではすべて0でした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/5wx 0xfec00000
0xfec00000:	0x00000000	0x00000000	0x00000000	0x00000000
0xfec00010:	0x00000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;dataレジスタ経由でデータの読み書きを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#data%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;dataレジスタ経由でデータの読み書きを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dataレジスタ経由でデータの読み書きを行う&lt;/h3&gt;
&lt;p&gt;続いて以下のコードを見ます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;maxintr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_VER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ioapicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ioapicinit: id isn&apos;t equal to ioapicid; not a MP\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicread&lt;/code&gt;関数は、引数として受け取った値を&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;reb&lt;/code&gt;に書き込み、その後&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;の値を取得して返却する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; uint &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;reg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IOAPICでは、&lt;code class=&quot;language-text&quot;&gt;ioapic-&gt;reg&lt;/code&gt;がインデックスレジスタとして使用され、間接的にデータの読み書きを行うことができます。&lt;/p&gt;
&lt;p&gt;インデックスレジスタとレジスタの対応は以下の通りです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 32.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAARlAAAEZQAGA43XUAAABI0lEQVQY00VR226EIBD1/3/PPjTqpl5BEbnsimB1PR2IbUnICTDnMkMmrMdkA8waUDGFYlBoRo2PRqJkGtvmcRwHVsLZrFBPh80HfO87nNvwdB5+22DXDSEEZLjX+zwgpQSbJNzLouMCPZ/BOUfb1OjYSEYKvVAw9pVEGL19Vl+JVzU9tDHI3teVBEPYwRgDpz1NAmqRWOSMuq5RliWstVjJ6GkNjNbQ2qR6NvQYxxEjZ3SnkV234HmeEEKg6zoiWVRVhaZtk2Ce56geD4h5xk6teu8TxvqWaiIWZGpiwusvYaBkE2YiTeTYk3DX9RiGIRF+MSaNxIgp4d1VxGVZ/gXj4AUJDvSglEptRIOYoCgKcDpLIjianXP0MYTJ/A4RO4tGP9vhxMmussmZAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/8ac56/image-5.webp 240w,
/static/0f8fc332e216b95790c9d23b8ce7a518/d3be9/image-5.webp 480w,
/static/0f8fc332e216b95790c9d23b8ce7a518/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/8ff5a/image-5.png 240w,
/static/0f8fc332e216b95790c9d23b8ce7a518/e85cb/image-5.png 480w,
/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png&quot;
            alt=&quot;2022/02/image-5.png&quot;
            title=&quot;2022/02/image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://mmi.hatenablog.com/entry/2017/04/09/132708&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O APICについて - 睡分不足&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maxintr = (ioapicread(REG_VER) &gt;&gt; 16) &amp;amp; 0xFF;&lt;/code&gt;の行では、インデックスレジスタに1を指定してバージョン情報を取得しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/5wx 0xfec00000
0xfec00000:	0x00000001	0x00000000	0x00000000	0x00000000
0xfec00010:	0x00170020&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maxintr&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;0x17&lt;/code&gt;が入ります。&lt;/p&gt;
&lt;p&gt;これはバージョンレジスタの23:16bitの範囲にあるMREを取得しているようです。&lt;/p&gt;
&lt;p&gt;ここで取得できる情報は割込み入力PINの数から1を引いた数になるみたいです。(おそらくこれが定義できる割込みの最大数に?)&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAB/klEQVQoz21T246qQBDk/z/Kl3UTox6NsnIVkIuACgLe1wdru1o9l+RM0umZpma6qmYwpn4ONy5hrUp4eQsn2WGRNTDTBvXxBo7H46HBcbvd0LYtrterRtd1OJ1Ov3FG4HsIlr7G9XJGliYoixzn0xH/G3VVYbkM9OCyLOC6Lo7HP1gjTRIkSYogCJCt1wJeIpZaGEaI41gjTVNEUaSxFgxrnK9WK81t2+FyuWgTYz6fySE+fN+H53lwHEdAK3jSmd19qUVhqBuXgmFjz3MVxzkzSXBvUZYiOQjRds8O9ONwOKgEBtfM/F43HZr2oN/fGGb6+V7zDCPJt0jXJQ5q7llpvw1n3L+/UbdHeFmFqNjrpr+DmHfe7/cwfLkU27bxazyGaZoqkfIpg5Isy1LP1lmGIs/VT/rInEkt0TuQixS5lVyYQVlVtcN0OpGYYj6bYT439XDbtjCZTNRL79XIlgb0lyToH2vOa14U4uH9flcPXNdRJqTdNC222y02m42ACux2O2WQC0PWy3KjazLl9+1GsLJm3ajqWumPRyN89Pv4/Oyj1+thMBhgJLXhcKiZDMjashZYLBY6Z5Ad17SGFhh8S/SKRW4iS8pg91qaMehN0zTK/qmg+SfeNSoxEn3Eofpnfn3pY6UMNf5l+POBPxtzTgz3xJI5pzX8/dj8B//bc+BEHWN+AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/8ac56/image-7.webp 240w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/d3be9/image-7.webp 480w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/b0a15/image-7.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/8ff5a/image-7.png 240w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/e85cb/image-7.png 480w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png&quot;
            alt=&quot;2022/02/image-7.png&quot;
            title=&quot;2022/02/image-7.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行では&lt;code class=&quot;language-text&quot;&gt;id&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;0x0&lt;/code&gt;を取得しました。&lt;/p&gt;
&lt;p&gt;これはIDレジスタの27:24bitの範囲の値でAPIC IDの値になります。(1つ目が0なのでたぶん初回実行時の値が0になっている?)&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABZUlEQVQoz5VS126DQBC8//+xSFHiJrkCphsw1TgugOzJzspO5Ic85KTRnrbM7A2YVVzhfZPgwynw6ewx2hawsi+M3BJvmz3srAXP7XbXOAwDLpcL+r5H110lf9P8/X5XGMuysFou0dQVDk0N27ZRliX+Ommaas8w9AiDAHlRvNQNi57nIQxDJEkC3/fhui52ux3yPFdkWYY4jkWokr7gcS8RRSF8mWW9EOK6rmE8GSaZ4ziqHIgqCdfrtUZXBhzbgr1ZI0sT8EUkfPZzGd6jKMLpdIYJ0lKZr9frK7pOYy8+JWWLjXgd5Y341qmHrJ3P5x8wx03NYrnCeDzGdDIRNV/VuTEjVWOBH4Swtz48icxp/vFsPpWoqkq3Ne52q2TT6fRBGCkhPWTkMO8k3qnIb65tW8XhcMDxeFQRw4+wmM8xm83UHyqxyKbnwF+gVU+wn/6bWJTUfAGf0EqhaRpt+A8owF/qG1VGoTvNDXmCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f20954147f64329fe787e7a1456b66e2/8ac56/image-8.webp 240w,
/static/f20954147f64329fe787e7a1456b66e2/d3be9/image-8.webp 480w,
/static/f20954147f64329fe787e7a1456b66e2/b0a15/image-8.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f20954147f64329fe787e7a1456b66e2/8ff5a/image-8.png 240w,
/static/f20954147f64329fe787e7a1456b66e2/e85cb/image-8.png 480w,
/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png&quot;
            alt=&quot;2022/02/image-8.png&quot;
            title=&quot;2022/02/image-8.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この値が&lt;code class=&quot;language-text&quot;&gt;ioapicid&lt;/code&gt;と一致するかを検証しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicid&lt;/code&gt;は&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ編&lt;/a&gt;で見た通り、MPコンフィグレーションテーブルから取得したAPICの番号でした。&lt;/p&gt;
&lt;h3 id=&quot;redirection-tableの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#redirection-table%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;redirection tableの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Redirection Tableの初期化&lt;/h3&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ioapicwrite&lt;/code&gt;関数で全ての&lt;code class=&quot;language-text&quot;&gt;Redirection Table&lt;/code&gt;を無効化しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mark all interrupts edge-triggered, active high, disabled,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// and not routed to any CPUs.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; INT_DISABLED &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicwrite&lt;/code&gt;関数は以下のようにインデックスと書き込みデータを使用して書き込みを行う関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;reg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;INT_DISABLED&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;0x00010000&lt;/code&gt;として定義されています。&lt;/p&gt;
&lt;p&gt;これによって、17番目のbitに1をセットすることができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 19.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAAvElEQVQY0z1PXQ9EMBD0/38aolRFwmm158VXEF6Z2y3uYTI7M91mJ5inCUmSoCgKaK0xzzOGYcBEPmfMrMdx9PPL7xvWDNa8G5znScEIpRTiOIYxBoY+dtbBti1agnPOe6wt+Vo3/8zD3LyuK4LrurDvO6SUiKIIKs+RCgHxIGedpjQnDwvP7yxlhizLEIYhvl2H4DgOf7K1FnVd+9p8ZVVV0E1zg7wPZd7T1MBolGWJvu+xbRuWZfF1+cIfeiEh/Dp95tgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/8ac56/image-9.webp 240w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/d3be9/image-9.webp 480w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/b0a15/image-9.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/8ff5a/image-9.png 240w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/e85cb/image-9.png 480w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png&quot;
            alt=&quot;2022/02/image-9.png&quot;
            title=&quot;2022/02/image-9.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このbitはMaskフラグになっており、セットされた場合割込みが送信されなくなります。&lt;/p&gt;
&lt;p&gt;下位8bitに設定している値は割込みベクタです。&lt;/p&gt;
&lt;p&gt;なんで初期化時に無効化してるんでしょうか。。&lt;/p&gt;
&lt;p&gt;たぶん以降のコードを読めばわかると思うので引き続き進めていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;まで読み進めました。&lt;/p&gt;
&lt;p&gt;まだ読んでいない&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行している関数も残り10個になり、折り返しに差し掛かってきました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数を読んでいきます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -セグメントディスクリプタ初期化 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-008-kernel-main-05</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-008-kernel-main-05</guid><pubDate>Thu, 03 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-007-kernel-main-04&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数によるローカルAPICの設定を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#seginit%E9%96%A2%E6%95%B0&quot;&gt;seginit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#cpus%E9%96%A2%E6%95%B0&quot;&gt;cpus関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;GDTのセット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;seginit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#seginit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;seginit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;seginit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数はCPUにカーネルセグメントディスクリプタを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Set up CPU&apos;s kernel segment descriptors.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Run once on entry on each CPU.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Map &quot;logical&quot; addresses to virtual addresses using identity map.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Cannot share a CODE descriptor for both kernel and user&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// because it would have to have DPL_USR, but the CPU forbids&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// an interrupt from CPL=0 to DPL=3.&lt;/span&gt;
  c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lgdt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードを読んでいきます。&lt;/p&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;proc.h&lt;/code&gt;で次のように定義されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Per-CPU state&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// Local APIC ID&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;scheduler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// swtch() here to enter scheduler&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;taskstate&lt;/span&gt; ts&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// Used by x86 to find stack for interrupt&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint started&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Has the CPU started?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ncli&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                    &lt;span class=&quot;token comment&quot;&gt;// Depth of pushcli nesting.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; intena&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// Were interrupts enabled before pushcli?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// The process running on this cpu or null&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は、配列&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;に格納されています。&lt;/p&gt;
&lt;p&gt;これは、&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ 編&lt;/a&gt;で見た通り&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;NCPU&lt;/code&gt;に設定されている通り、最大8つのCPUをサポートする配列です。&lt;/p&gt;
&lt;h3 id=&quot;cpus関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cpus%E9%96%A2%E6%95%B0&quot; aria-label=&quot;cpus関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;cpus関数&lt;/h3&gt;
&lt;p&gt;配列&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を取得する箇所を見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpuid&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;proc.c&lt;/code&gt;で以下のように定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数の戻り値から&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;を引いた値を返します(何やってるんだろう…)。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Must be called with interrupts disabled&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Must be called with interrupts disabled to avoid the caller being&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// rescheduled between reading lapicid and running through the loop.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;FL_IF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mycpu called with interrupts enabled\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// APIC IDs are not guaranteed to be contiguous. Maybe we should have&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// a reverse map, or reserve a register to store &amp;amp;cpus[i].&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;unknown apicid\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数の肝は以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// APIC IDs are not guaranteed to be contiguous. Maybe we should have&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// a reverse map, or reserve a register to store &amp;amp;cpus[i].&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicid&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で定義されている、ローカルAPICからAPICIDを取得して24bitの右シフトを行ったものを返却する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;には、&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ 編&lt;/a&gt;で見た通り&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;でローカルAPICのアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;Intelのマルチプロセッサ仕様書(5-1)によると、ローカルAPICはベースメモリアドレス&lt;code class=&quot;language-text&quot;&gt;0x0FEE00000&lt;/code&gt;に置かれ、ローカルAPICIDは0から始まるハードウェアに連続して割り当てされるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;INTEL MULTIPROCESSOR SPECIFICATION Pdf Download | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバッガで確認してみたところ、初回呼び出し時は&lt;code class=&quot;language-text&quot;&gt;lapic[ID]&lt;/code&gt;の値は0でした。&lt;/p&gt;
&lt;p&gt;つまり&lt;code class=&quot;language-text&quot;&gt;lapicid&lt;/code&gt;の戻り値も0になります。&lt;/p&gt;
&lt;p&gt;これによって&lt;code class=&quot;language-text&quot;&gt;apicid = lapicid();&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;apicid&lt;/code&gt;には0が入ります。&lt;/p&gt;
&lt;p&gt;続くループの処理をデバッガで確認したところ、&lt;code class=&quot;language-text&quot;&gt;cpus[i].apicid&lt;/code&gt;の値も0で&lt;code class=&quot;language-text&quot;&gt;apicid&lt;/code&gt;と一致するため、&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[i]&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;が返却さえｒました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;return mycpu()-cpus;&lt;/code&gt;も0となり、最初の&lt;code class=&quot;language-text&quot;&gt;cpuid&lt;/code&gt;関数実行時の戻り値は0となることを確認しました。&lt;/p&gt;
&lt;p&gt;これによって、初回起動時の&lt;code class=&quot;language-text&quot;&gt;c = &amp;amp;cpus[cpuid()];&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;c = &amp;amp;cpus[0];&lt;/code&gt;となります。&lt;/p&gt;
&lt;h3 id=&quot;gdtのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;gdtのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GDTのセット&lt;/h3&gt;
&lt;p&gt;というわけで、続く以下の行では、&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;gdt[NSEGS]&lt;/code&gt;要素に値をセットしていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Map &quot;logical&quot; addresses to virtual addresses using identity map.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Cannot share a CODE descriptor for both kernel and user&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// because it would have to have DPL_USR, but the CPU forbids&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// an interrupt from CPL=0 to DPL=3.&lt;/span&gt;
c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lgdt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;は前述した&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体であり、&lt;code class=&quot;language-text&quot;&gt;gdt&lt;/code&gt;は以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;segdesc&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定義されている構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;ifndef&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;__ASSEMBLER__&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Segment Descriptor&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint lim_15_0 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Low bits of segment limit&lt;/span&gt;
  uint base_15_0 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Low bits of segment base address&lt;/span&gt;
  uint base_23_16 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Middle bits of segment base address&lt;/span&gt;
  uint type &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Segment type (see STS_ constants)&lt;/span&gt;
  uint s &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// 0 = system, 1 = application&lt;/span&gt;
  uint dpl &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Descriptor Privilege Level&lt;/span&gt;
  uint p &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Present&lt;/span&gt;
  uint lim_19_16 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// High bits of segment limit&lt;/span&gt;
  uint avl &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Unused (available for software use)&lt;/span&gt;
  uint rsv1 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Reserved&lt;/span&gt;
  uint db &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// 0 = 16-bit segment, 1 = 32-bit segment&lt;/span&gt;
  uint g &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Granularity: limit scaled by 4K when set&lt;/span&gt;
  uint base_31_24 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// High bits of segment base address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに&lt;code class=&quot;language-text&quot;&gt;NSEGS&lt;/code&gt;も、&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定数6として定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// cpu-&gt;gdt[NSEGS] holds the above segments.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NSEGS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで定義されている&lt;code class=&quot;language-text&quot;&gt;segdesc&lt;/code&gt;構造体は、セグメントディスクリプタです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABpklEQVQoz3VSDW+CUAz0//8u3fyYLktchprFOZ18CAo8EFT01it5inFrUovvtdf27rWKokBVVern81ndflfV7f/t7PH7dDppJFbreDyCluc5DoeDXm63W6xWPwiCDYzJsJHo+b7k7JFJHgtZV5al1NT1NJ4pINHzLIPn+YiiLdI0xYfjYLH4xsSZwhcw1/MQ+IE2S+IY67WreUmS4nK5KCAHUkAe7Pd7PbCd4yRGJk2MMVKUXCej13mH66TWroDkg6vxIMtyGAFig1L+M3Iq5pEW60VRamPePwByZV4SeLMJ1QnCCTg97xiDIIDn1qtzVfLN6S9NQP7Q2IkikJf5/AuuFNIpDrklZ5yqaRyAje44tIAmNXCciRSu0W4/YfgyQrfbx2AwvAIulyvEcYLdblcLJQ2bKt8BUoC162pir9cX8CnCMJLiGFY4UmMjzyz/+G/lMAylq4tO5xmj1zdZfaH88f2VRaliUDw++Kb9uTJjFEUyYYDx+B2z2acIsxNOjSpPYILxGXHCJtAdoD6Psn4CVJWR6lFRrm/5Io9Ul5GgLLZ1Tf8Fhqic9oHnDUAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/67703d9268cb5e9193a27b143a5996d8/8ac56/image-4.webp 240w,
/static/67703d9268cb5e9193a27b143a5996d8/d3be9/image-4.webp 480w,
/static/67703d9268cb5e9193a27b143a5996d8/b0a15/image-4.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/67703d9268cb5e9193a27b143a5996d8/8ff5a/image-4.png 240w,
/static/67703d9268cb5e9193a27b143a5996d8/e85cb/image-4.png 480w,
/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png&quot;
            alt=&quot;2022/02/image-4.png&quot;
            title=&quot;2022/02/image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;セグメントディスクリプタは、&lt;a href=&quot;/linux-memory-protect-gdt-ldt&quot;&gt;x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)&lt;/a&gt;で軽く触れたGDTとLDTのエントリとなるデータ構造です。&lt;/p&gt;
&lt;p&gt;セグメントディスクリプタは、CPUにセグメントのサイズやアドレス、またアクセス権限や状態を通知します。&lt;/p&gt;
&lt;p&gt;x86CPUでは、この仕組みによってメモリ保護を実現していました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KCODE&lt;/code&gt;などのセグメントセレクタと、割り当てしている権限についてはブートストラップを参照したときにも確認したので、この記事では割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/unix-xv6-001-bootstrap&quot;&gt;xv6OSを真面目に読みこんでカーネルを完全に理解する -ブートストラップ編-&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;カーネル側でセグメントディスクリプタの初期化を行いました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数から。。。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ローカルAPIC 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-007-kernel-main-04</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-007-kernel-main-04</guid><pubDate>Wed, 02 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数によるマルチプロセッサ構成でのCPU情報の取得を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#lapicinit%E9%96%A2%E6%95%B0&quot;&gt;lapicinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF&quot;&gt;ローカルAPICレジスタ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#spurious-interrupt-vector%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;Spurious Interrupt Vectorの設定とローカルAPICの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BF%E3%82%A4%E3%83%9E%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;タイマの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#disable-logical-interrupt-lines&quot;&gt;Disable logical interrupt lines&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#disable-performance-counter-overflow-interrupts&quot;&gt;Disable performance counter overflow interrupts&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#error-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;Error Registerのセット&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#esr%E3%81%AE%E3%82%AF%E3%83%AA%E3%82%A2&quot;&gt;ESRのクリア&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#eoi%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF&quot;&gt;EOIのチェック&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#interrupt-command-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;Interrupt Command Registerのセット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;lapicinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#lapicinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;lapicinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;lapicinit関数&lt;/h2&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で最初に実行される関数群の&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数から見ていきます。&lt;/p&gt;
&lt;p&gt;ここでは割込みコントローラの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Enable local APIC; set spurious interrupt vector.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SVR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ENABLE &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_SPURIOUS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// The timer repeatedly counts down at bus frequency&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// from lapic[TICR] and then issues an interrupt.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// If xv6 cared more about precise timekeeping,&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// TICR would be calibrated using an external time source.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TDCR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; X1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TICR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Disable logical interrupt lines.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Disable performance counter overflow interrupts&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// on machines that provide that interrupt entry.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;VER&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PCINT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Map error interrupt to IRQ_ERROR.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ERROR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_ERROR&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Clear error status register (requires back-to-back writes).&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Ack any outstanding interrupts.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;EOI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Send an Init Level De-Assert to synchronise arbitration ID&apos;s.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRHI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BCAST &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; INIT &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; LEVEL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; DELIVS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Enable interrupts on the APIC (but not on the processor).&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TPR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;if(!lapic) return;&lt;/code&gt;ではグローバル変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;に値が格納されているかをチェックしています。&lt;/p&gt;
&lt;h3 id=&quot;ローカルapicレジスタ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF&quot; aria-label=&quot;ローカルapicレジスタ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ローカルAPICレジスタ&lt;/h3&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;前回&lt;/a&gt;確認したMPテーブルの取得の中でMPフローティングポインタ内の&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;のアドレスが格納されていました。&lt;/p&gt;
&lt;p&gt;実際にこのグローバル変数に格納されている値をデバッガで確認してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x801027a0
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の中身を見てみたところ、アドレス&lt;code class=&quot;language-text&quot;&gt;0xfee00000&lt;/code&gt;が格納されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ info variables lapic
File lapic.c:
&lt;span class=&quot;token number&quot;&gt;44&lt;/span&gt;:	volatile uint *lapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

$ p lapic
&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;volatile uint *&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 0xfee00000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は、メモリマップされたローカルAPICレジスタです。&lt;/p&gt;
&lt;p&gt;ローカルAPICレジスタはMPコンフィグレーションテーブルの指すアドレスにメモリマップされた32bitのデータです。&lt;/p&gt;
&lt;p&gt;16バイト境界にアラインメントされたオフセットにある、32bitの各要素をローカルAPICレジスタとして設定します。&lt;/p&gt;
&lt;p&gt;詳細は以下のページが参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以降は、ローカルAPICレジスタの設定を行っていきます。&lt;/p&gt;
&lt;p&gt;その際、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で定義された以下の値を使用します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Local APIC registers, divided by 4 for use as uint[] indices.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ID&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0020&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// ID&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;VER&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0030&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Version&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TPR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0080&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Task Priority&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;EOI&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00B0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// EOI&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SVR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00F0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Spurious Interrupt Vector&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ENABLE&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000100&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Unit Enable&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ESR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0280&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Error Status&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ICRLO&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0300&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt Command&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;INIT&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000500&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// INIT/RESET&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;STARTUP&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000600&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Startup IPI&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DELIVS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00001000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Delivery status&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ASSERT&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00004000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Assert interrupt (vs deassert)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DEASSERT&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LEVEL&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00008000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Level triggered&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BCAST&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00080000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Send to all APICs, including self.&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BUSY&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00001000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;FIXED&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ICRHI&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0310&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt Command [63:32]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TIMER&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0320&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 0 (TIMER)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;X1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x0000000B&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// divide counts by 1&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PERIODIC&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00020000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Periodic&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PCINT&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0340&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Performance Counter LVT&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LINT0&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0350&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 1 (LINT0)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LINT1&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0360&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 2 (LINT1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ERROR&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0370&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 3 (ERROR)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MASKED&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00010000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt masked&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TICR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0380&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Initial Count&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TCCR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0390&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Current Count&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TDCR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x03E0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Divide Configuration&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;spurious-interrupt-vectorの設定とローカルapicの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#spurious-interrupt-vector%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;spurious interrupt vectorの設定とローカルapicの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Spurious Interrupt Vectorの設定とローカルAPICの有効化&lt;/h3&gt;
&lt;p&gt;先に進みます。&lt;/p&gt;
&lt;p&gt;この行では&lt;code class=&quot;language-text&quot;&gt;lapicw&lt;/code&gt;関数によって&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;を設定してローカルAPICの有効化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Enable local APIC; set spurious interrupt vector.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SVR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ENABLE &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_SPURIOUS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicw&lt;/code&gt;関数はこの後も頻繁に使用される以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; index&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;index&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// wait for write to finish, by reading&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;index&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt;を引数として、&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の値を書き換えます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapic[ID]&lt;/code&gt;のIDは&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;(0x0020/4)&lt;/code&gt;と定義されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapic[ID];&lt;/code&gt;は特に設定変更などを行っている処理ではなく、この値を参照させることで、その前に命令した&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の書き込みが終了するのを待つことを目的としています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicw(SVR, ENABLE | (T_IRQ0 + IRQ_SPURIOUS));&lt;/code&gt;の行について見ていきます。&lt;/p&gt;
&lt;p&gt;インデックスは&lt;code class=&quot;language-text&quot;&gt;SVR&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;これは&lt;code class=&quot;language-text&quot;&gt;(0x00F0/4)&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;のオフセットを指します。&lt;/p&gt;
&lt;p&gt;以下記事に記載の通り、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;のbit8(&lt;code class=&quot;language-text&quot;&gt;0x100&lt;/code&gt;)をセットすることによってAPICを有効にすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、ローカルAPICが割込みを受信できるようにするためには、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;を設定する必要があります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;の下位8bitには&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;のIRQ番号がマッピングされます。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;0x100&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0x3f&lt;/code&gt;のORを取った&lt;code class=&quot;language-text&quot;&gt;0x13f&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;にセットされます。&lt;/p&gt;
&lt;p&gt;この下位ビット&lt;code class=&quot;language-text&quot;&gt;0x3f&lt;/code&gt;ですが、&lt;code class=&quot;language-text&quot;&gt;T_IRQ0 + IRQ_SPURIOUS&lt;/code&gt;の演算結果として登場しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;T_IRQ0&lt;/code&gt;などの値は&lt;code class=&quot;language-text&quot;&gt;traps.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// These are arbitrarily chosen, but with care not to overlap&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// processor defined exceptions or interrupt vectors.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_SYSCALL&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// system call&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_DEFAULT&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// catchall&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_IRQ0&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// IRQ 0 corresponds to int T_IRQ&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_TIMER&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_KBD&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_COM1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_IDE&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_ERROR&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_SPURIOUS&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev Wiki&lt;/a&gt;の解説だと、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;にセットする一番簡単な値は&lt;code class=&quot;language-text&quot;&gt;0xff&lt;/code&gt;であると書かれていますが、xv6OSでは&lt;code class=&quot;language-text&quot;&gt;0x1f&lt;/code&gt;でした。&lt;/p&gt;
&lt;p&gt;(この理由はいまいちよくわかってません。。)&lt;/p&gt;
&lt;h3 id=&quot;タイマの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BF%E3%82%A4%E3%83%9E%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;タイマの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;タイマの設定&lt;/h3&gt;
&lt;p&gt;続いては以下の行です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// The timer repeatedly counts down at bus frequency&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// from lapic[TICR] and then issues an interrupt.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// If xv6 cared more about precise timekeeping,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// TICR would be calibrated using an external time source.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TDCR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; X1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TICR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TDCR&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;(0x03E0/4)&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;Divide Configuration Register (for Timer)&lt;/code&gt;のオフセットです。&lt;/p&gt;
&lt;p&gt;この設定はローカルAPICタイマの周期を設定する際に使用します。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマとは、各プロセッサのローカルAPICに内臓されているタイマで、そのプロセッサのみに対して割込みを発生させます。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマは、カーネルから&lt;code class=&quot;language-text&quot;&gt;Timer Initial Count&lt;/code&gt;として設定された値を初期値として一定の間隔でデクリメントしていき、0になったときに割込みを発生させます。&lt;/p&gt;
&lt;p&gt;このデクリメント速度は、CPUのバス周波数を&lt;code class=&quot;language-text&quot;&gt;Timer Divide Configuration&lt;/code&gt;の値で割った値に依存します。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマでは、&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;One-shot mode&lt;/code&gt;の2種類の挙動を定義できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;の場合は、0になったカウントは自動的に初期値に戻り、デクリメントが再開されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;One-shot mode&lt;/code&gt;の場合は、カウントが0になって割込みを発生させた場合、プログラムが明示的に初期値を設定するまでカウントは0のままとなります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC_timer&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC timer - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://japan.zdnet.com/article/20365986/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;タイマー割り込みとして、Local APICのタイマ割り込みを選択したことを示すメッセージ - ZDNet Japan&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、&lt;code class=&quot;language-text&quot;&gt;Timer Divide Configuration&lt;/code&gt;の値は&lt;code class=&quot;language-text&quot;&gt;0x0000000B&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABF0lEQVQoz32RCYuDQAyF+///mdTCFhGLth3B+6rifb+dhJ2ltN0NPJgkbz4z8dD3PZZlQZqmeDxKVKVUVaEoCmRZJmsPzktZL396Ko+iCHGcoG1bZgzDgAMdKJIkge/7CIKAjY7jQNd12LbNNSXyeJ7Hcl3BXhqKgliHeZ45iWWDLt9uN1iWJSfOoIKmVB8q8hxN06Cua4zjyOd1XdlHrF9g13VPz6u4ue8791wheFpN05DKNRCAYORRsDfgp1DAKArxdT4z9HnyVx8D1Q7/iySOcTqdoB+PEML908c7pIUSeZqmN/GzpCmXezNNE4ZhIJR7/OQlBrF4wmetUtfrlf9yEPhw5Jnyy+XCEuLO4CAMsW0bXu9/A9hYY3E3+dHEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/8ac56/image.webp 240w,
/static/d05d9531c380a9b7fae36b6a644a608f/d3be9/image.webp 480w,
/static/d05d9531c380a9b7fae36b6a644a608f/b0a15/image.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/8ff5a/image.png 240w,
/static/d05d9531c380a9b7fae36b6a644a608f/e85cb/image.png 480w,
/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png&quot;
            alt=&quot;2022/02/image.png&quot;
            title=&quot;2022/02/image.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;Timer Initial Count&lt;/code&gt;の値は&lt;code class=&quot;language-text&quot;&gt;lapicw(TICR, 10000000);&lt;/code&gt;によって&lt;code class=&quot;language-text&quot;&gt;10000000&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;ちなみに以下の行は、&lt;code class=&quot;language-text&quot;&gt;Local Vector Table 0 (TIMER)&lt;/code&gt;の設定を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Local Vector Table(LVT)&lt;/code&gt;自体はローカルAPICにおけるイベントを割込みベクタに変換するためのテーブルです。&lt;/p&gt;
&lt;p&gt;LVTによって、ソフトウェアはローカル割込みがCPUに送信される方法を指定することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 119.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAADAklEQVQ4y32U2XLaQBBF+f9vyWOe8uiyg6GMXaHMvoPYQWKVMMh0+jQaAgR7qkYzmuXO7dtLKgxD2e/3cjgchPl6vbYxDCNZrVYyn/sym07Pe1OdbzYbWS6XNn58fNjI/m63kxRgtEgXBoOBtNttG+ndTsdGz/Ok1WpJt9s9j71eTxaLQIbDoQHS4jj+B3g8Ho0pLPp9T/oKApvxeGx9u93a3mw2k0CBRqORFIsFqVQqOhalWq1KFO2uAY9yam9/8vLj5y8Zjsa2jimubRT0kmkQBPYIsmD+GfCyLZYr6Q4nEkaRvhrZQYBp49FQstms1Ot1taR/dQ+s1F6dcfz8lFzuRWnX7LVP/b9tDjCKQnPIer0yGY4XeyfAhCF6NRoNMwET8do2iQAuuEdgvNAzUSIDjrhmeGMyb8Hg9TUnuZcXaXe6FlJRYj6Peb2uPDw86Jk3s+guoKPt9MKccrmsobE477MH88l4JOl0Wmq1+h0NbwBdkNM8jTXfD8xcQsZJMZ1M5Pn5WQqFokx07vv+94DMuVhRhoTHUjOGdUyGOZIM1MM9e9A35t+abGmoF9HR8/qWCaQhezAF+F6775QkYwBlzujylREwl//fAqITB3EChQHTuDyfzy31yFn0ch3vct7JwMP0M6DpooWgowWBlHK92WzaHh2zAQMctitd439zD3CTlCYAcIQbSTGEhykjYDgDLVmjEvHYFSBarRKGDsh1sofKwhz25C8lDlAAsQLA2AFutxtpKQgXOfgVIOsAAuRYoSOAi8UFQ4J1t4ukWChYTXMXenoQAEDRybGC4Uid5IIdlmDE/2moYYGHuQAgrPgPAv/kCJWDPeas43k0R6Zx8sAVoItBAE6hE8pXjaB/fHyUfD4v2UxG0zAjhzgB5EPOvr8XTC9KOqbXtFMcqvrPGowx8WTNWn4/PRlgRgEzWnBjZRjHiYYcLpVKBgQo80KiqevoBnsXCeQ5Z9krlcqyS7Io5VLssvFIo1FXp7RNH6KgmcRmpVI2Zx1vZKDQ0v8C6TUhDYjW/XoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1fb117892fd2af6a004e0e16826524d0/8ac56/image-1.webp 240w,
/static/1fb117892fd2af6a004e0e16826524d0/d3be9/image-1.webp 480w,
/static/1fb117892fd2af6a004e0e16826524d0/b0a15/image-1.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1fb117892fd2af6a004e0e16826524d0/8ff5a/image-1.png 240w,
/static/1fb117892fd2af6a004e0e16826524d0/e85cb/image-1.png 480w,
/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png&quot;
            alt=&quot;2022/02/image-1.png&quot;
            title=&quot;2022/02/image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;LVTは以下の32bitレジスタから構成されています。詳細は実際に使用するときに見ていきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LVT Timer Register (FEE0 0320H)&lt;/li&gt;
&lt;li&gt;LVT Thermal Monitor Register (FEE0 0330H)&lt;/li&gt;
&lt;li&gt;LVT Performance Counter Register (FEE0 0340H)&lt;/li&gt;
&lt;li&gt;LVT LINT0 Register (FEE0 0350H)&lt;/li&gt;
&lt;li&gt;LVT LINT1 Register (FEE0 0360H)&lt;/li&gt;
&lt;li&gt;LVT Error Register (FEE0 0370H)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;TIMER&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;(0x0320/4)&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;LVT Timer Register&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LVT Timer Register&lt;/code&gt;はAPICのタイマが割込みを発生させた場合の割込みを指定します。&lt;/p&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;PERIODIC&lt;/code&gt;によってLVTの18bit目の&lt;code class=&quot;language-text&quot;&gt;Timer Mode&lt;/code&gt;を1にセットすることで、タイマの動作を&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;に変更しています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;T_IRQ0 + IRQ_TIMER&lt;/code&gt;では、割込みベクタを設定していますが、セットしている値は&lt;code class=&quot;language-text&quot;&gt;0x20&lt;/code&gt;となっているようです。
(ググってもダイレクトな情報ソース見つからなかったのですが、たぶん&lt;code class=&quot;language-text&quot;&gt;INT 0x20&lt;/code&gt;みたいなタイマ割込みを指している？わからん。)&lt;/p&gt;
&lt;h3 id=&quot;disable-logical-interrupt-lines&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#disable-logical-interrupt-lines&quot; aria-label=&quot;disable logical interrupt lines permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Disable logical interrupt lines&lt;/h3&gt;
&lt;p&gt;次いきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;(0x0350/4)&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;(0x0360/4)&lt;/code&gt;にそれぞれ&lt;code class=&quot;language-text&quot;&gt;0x00010000&lt;/code&gt;をセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Disable logical interrupt lines.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;(0x0340/4)&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;(0x0350/4)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;LVT LINT0 Register&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;LVT LINT1 Register&lt;/code&gt;でした。&lt;/p&gt;
&lt;p&gt;これらはどちらも、LINT0およびLINT1ピンからの割込みを定義する割込みベクタです。&lt;/p&gt;
&lt;p&gt;ここで、17bit目をセットしてマスクを有効化しています。&lt;/p&gt;
&lt;p&gt;(なんでこの2つを無効化する必要があるのかは全然わかりませんでした！なぜ！！)&lt;/p&gt;
&lt;h3 id=&quot;disable-performance-counter-overflow-interrupts&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#disable-performance-counter-overflow-interrupts&quot; aria-label=&quot;disable performance counter overflow interrupts permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Disable performance counter overflow interrupts&lt;/h3&gt;
&lt;p&gt;次行きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Disable performance counter overflow interrupts&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// on machines that provide that interrupt entry.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;VER&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PCINT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PCINT&lt;/code&gt;はオーバフローが発生したときに割込みを生成する&lt;code class=&quot;language-text&quot;&gt;LVT Performance Counter Register&lt;/code&gt;を特定の条件下でマスクしています。&lt;/p&gt;
&lt;p&gt;その条件は、ローカルAPICの&lt;code class=&quot;language-text&quot;&gt;Version Register&lt;/code&gt;の値を16bit右シフトして下位8bitを取ったときの値が4より大きくなることです。&lt;/p&gt;
&lt;p&gt;意味は全然わかりませんでした。。&lt;/p&gt;
&lt;p&gt;とりあえずデバッガで実行してみたらこの行は実行されなかったので、xv6OSは&lt;code class=&quot;language-text&quot;&gt;LVT Performance Counter Register&lt;/code&gt;をマスクしないものとして先に進みます…。&lt;/p&gt;
&lt;h3 id=&quot;error-registerのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#error-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;error registerのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Error Registerのセット&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LVT Error Register&lt;/code&gt;の割込みベクタをセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Map error interrupt to IRQ_ERROR.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ERROR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_ERROR&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;esrのクリア&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#esr%E3%81%AE%E3%82%AF%E3%83%AA%E3%82%A2&quot; aria-label=&quot;esrのクリア permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ESRのクリア&lt;/h3&gt;
&lt;p&gt;ここではESRをクリアしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Clear error status register (requires back-to-back writes).&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ESRは&lt;code class=&quot;language-text&quot;&gt;Error Status Register&lt;/code&gt;の略で、エラーが発生したときにbitがセットされます。&lt;/p&gt;
&lt;p&gt;対応は以下の図。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABeUlEQVQoz4WS626CQBCFff8Ha39IKiDKTWMU5aaA0ihync4Zu8a0DSU5mWV359uzszO5Xq/UNA2laUpZllFRFJTnOR2PR4qiiE6nExX5Y+6hjMIwFEWsOI5JMW63G03quiZ8WAiCQDYmSUKbzYYsy6LdbidrCnI4HOQgCPux1ratMMB6AodhkNi2jTgVZ+wWTsuypKqqxAHi5XIRYf58Po8DK07SplN6f38jTdNosVhQylAk4gAlXB9z/wLv1Y1msw8yDJM8z6P9fi9OlKPXCCjgXdeNASuamybphs4yyPd8qSkK/1MoAcCjDpumJt/3xZ3ruhLL8vNZw1cpaN/3I4/Cz79er0WAbbdbatgBkuCk532IaBOVo+KfQMSQW2O5tAXq2LY8jOt6ZJoGOY4jzqMoFugv4P1+lwk4UAq49wyun82w+dxi+FLGAKM3Ta6xx2Vp+TGG7xwwwBKHGCh1fJ2EmxVJcLharQRoMUzXZwJFF6CV4PA1F/9fbf9C6fe4f28AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a62689b6484885eda853c23b71f5eeee/8ac56/image-2.webp 240w,
/static/a62689b6484885eda853c23b71f5eeee/d3be9/image-2.webp 480w,
/static/a62689b6484885eda853c23b71f5eeee/b0a15/image-2.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a62689b6484885eda853c23b71f5eeee/8ff5a/image-2.png 240w,
/static/a62689b6484885eda853c23b71f5eeee/e85cb/image-2.png 480w,
/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png&quot;
            alt=&quot;2022/02/image-2.png&quot;
            title=&quot;2022/02/image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なんで2回クリアしているのかは、またしても謎です。&lt;/p&gt;
&lt;h3 id=&quot;eoiのチェック&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#eoi%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF&quot; aria-label=&quot;eoiのチェック permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;EOIのチェック&lt;/h3&gt;
&lt;p&gt;EOIは&lt;code class=&quot;language-text&quot;&gt;End of interrupt&lt;/code&gt;の略で、特定の割込み処理が完了したことを示す信号で、PICに送信されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Ack any outstanding interrupts.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;EOI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/End_of_interrupt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;End of interrupt - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;EOIレジスタには互換性のために0をセットしておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;interrupt-command-registerのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#interrupt-command-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;interrupt command registerのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Interrupt Command Registerのセット&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ICRHI&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;ICRLOはどちらも&lt;/code&gt;Interrupt Command Register`です。&lt;/p&gt;
&lt;p&gt;これら2つのレジスタは、CPUに割込みを送信するために使用されます。&lt;/p&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;(0x0300/4)&lt;/code&gt;にデータが書き込まれたときは割込みが発生しますが、&lt;code class=&quot;language-text&quot;&gt;(0x0310/4)&lt;/code&gt;に書き込まれた時には割込みは発生しないため、&lt;code class=&quot;language-text&quot;&gt;ICRHI&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;ICRHO&lt;/code&gt;の順で値をセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Send an Init Level De-Assert to synchronise arbitration ID&apos;s.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRHI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BCAST &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; INIT &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; LEVEL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; DELIVS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;INIT Level De-assert&lt;/code&gt;によってシステム内のすべてのローカルAPICに同期メッセージを送信し、その&lt;code class=&quot;language-text&quot;&gt;arbitration ID&lt;/code&gt;をAPICに設定しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAACIklEQVQ4y3VUibKiMBD0/3/r7dv1HWpZaLkciiIegAqCKOAxOz2PUChsqsZgjk5Ppyed8/lMRZHT4RDSJcsoz/l7v6cgCChNU0qSROJ0OjUC82EYyvftdiNgdYqiIDTf98myLFosFmSaFs3nc1qtVhKbzYZ0/S/1+32a2Tat12taLpfkuq6sy5gIGsh08IOGQZzyeDykv16vFMcxMz/Q8XhkJhFFUVQxwz6QUfueAO/3u5w6m81oPB4Ly+12K73jOGQzKwRYAVRJgDXoFaknhgmz2e12kiLSh6ZgiM0AgVZRFMr/y+UiLDGfpmfJqgJU+Y80jX6/v5M2GtFkMiHP8yQdsMdCCC6pcpoF/x8Oh9T905WM4jhpAiLdj26XBoMBadqIJ38uC00xQnqPcgyHvr39kkuCxo2UwQTi5nlW2aANEOvQLMukz8+vil0DELfpsch79uC91ERp88SwHAsCX1hC81ZAbEIo3V4BlYaYh11slgi6G4ZBa/apsl4F+NoAVgcEOwCpMZct1Ov1+eaPTR/WAepAdUBEZWQ2PZhpJUPMNRi+Ar4yRLo/l8aFwD0M7zhLqXnI0crwfy0rHw2UIwKAqCJdN8TcrZeCk1DsJqcA01rTqdwgWNUBkTbGfN9jQF0K4AlQGRtl5zIAXhzbnku5KW3ammka9N3rsamjyhWiIfLHhxL9xLU6ZXZ4snA6vvFEIfBAwNDoTdMU7wJM2Q39PwL5F+pagDLJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/8ac56/image-3.webp 240w,
/static/192a2ec202fe9a196c88a8cd947bd723/d3be9/image-3.webp 480w,
/static/192a2ec202fe9a196c88a8cd947bd723/b0a15/image-3.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/8ff5a/image-3.png 240w,
/static/192a2ec202fe9a196c88a8cd947bd723/e85cb/image-3.png 480w,
/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png&quot;
            alt=&quot;2022/02/image-3.png&quot;
            title=&quot;2022/02/image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;TPR(Task Priority Register)&lt;/code&gt;に0をセットすることで、CPUがすべての割込みを処理できるようになるため、割込み機能が有効化されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Enable interrupts on the APIC (but not on the processor).&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TPR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみにTPRに15をセットすると、すべての割込みが禁止されます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数から呼び出された&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数の処理が全部終わりました。&lt;/p&gt;
&lt;p&gt;今回いまいち理解できないまま進んでしまった部分も多かったので、わかり次第追記していこうと思います。&lt;/p&gt;
&lt;p&gt;次回はいよいよセグメントディスクリプタです。&lt;/p&gt;
&lt;p&gt;だんだん本格的にカーネルの動きが見えてきて楽しくなってきました。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -マルチプロセッサ 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-006-kernel-main-03</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-006-kernel-main-03</guid><pubDate>Mon, 31 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-005-kernel-main-02&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるページテーブル割り当ての挙動を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#mpinit%E9%96%A2%E6%95%B0&quot;&gt;mpinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%90%84%E7%A8%AE%E6%A7%8B%E9%80%A0%E4%BD%93%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%A3%E8%A8%80&quot;&gt;各種構造体変数の宣言&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E4%BB%95%E6%A7%98%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;MP仕様について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%83%95%E3%83%AD%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;MPフローティングポインタ構造体の取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;MPコンフィグレーションテーブルの取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89ioapic%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;MPコンフィグレーションテーブルからIOAPICを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;プロセッサの情報を取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#processor-entry%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot;&gt;Processor Entryの情報取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ioapic%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot;&gt;IOAPICの情報取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#imcr%E3%81%AE%E5%A4%89%E6%9B%B4&quot;&gt;IMCRの変更&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;mpinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mpinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;mpinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;mpinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;で定義されている以下の関数です。&lt;/p&gt;
&lt;p&gt;「mp」はたぶんマルチプロセッサの意ですが、他のプロセッサを検出する役割を持つ関数が&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
        ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPBUS&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPLINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ismp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Didn&apos;t find a suitable machine&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;imcrp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Bochs doesn&apos;t support IMCR, so this doesn&apos;t run on Bochs.&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// But it would on real hardware.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x70&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// Select IMCR&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x23&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x23&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Mask external interrupts.&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;それではソースコードを順に読んでいきます。&lt;/p&gt;
&lt;h3 id=&quot;各種構造体変数の宣言&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%90%84%E7%A8%AE%E6%A7%8B%E9%80%A0%E4%BD%93%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%A3%E8%A8%80&quot; aria-label=&quot;各種構造体変数の宣言 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;各種構造体変数の宣言&lt;/h3&gt;
&lt;p&gt;関数呼び出し後、複数の構造体変数を宣言しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これらはいずれも&lt;code class=&quot;language-text&quot;&gt;mp.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;構造体の定義は以下です。&lt;/p&gt;
&lt;p&gt;詳細は実際に使用するソースコードを読む際に見ていくため、一旦割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// See MultiProcessor Specification Version 1.[14]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// floating pointer&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;_MP_&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// phys addr of MP config table&lt;/span&gt;
  uchar length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// 1&lt;/span&gt;
  uchar specrev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// MP system config type&lt;/span&gt;
  uchar imcrp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// configuration table header&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;PCMP&quot;&lt;/span&gt;
  ushort length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// total table length&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar product&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// product id&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;oemtable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// OEM table pointer&lt;/span&gt;
  ushort oemlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// OEM table length&lt;/span&gt;
  ushort entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// entry count&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// address of local APIC&lt;/span&gt;
  ushort xlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// extended table length&lt;/span&gt;
  uchar xchecksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// extended table checksum&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// processor table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (0)&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// local APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// local APIC verison&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// CPU flags&lt;/span&gt;
    &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPBOOT&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x02&lt;/span&gt;           &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// This proc is the bootstrap processor.&lt;/span&gt;&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// CPU signature&lt;/span&gt;
  uint feature&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// feature flags from CPUID instruction&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// I/O APIC table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (2)&lt;/span&gt;
  uchar apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// I/O APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// I/O APIC version&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC flags&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;mp仕様について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E4%BB%95%E6%A7%98%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;mp仕様について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MP仕様について&lt;/h3&gt;
&lt;p&gt;ソースコードを読む前に、MP仕様についてまとめておきます。&lt;/p&gt;
&lt;p&gt;MPテーブルとは、x86CPUの持っているOSにマルチプロセッサの情報を取得させるための仕組みです。&lt;/p&gt;
&lt;p&gt;MPテーブルにはx86CPUのMP仕様に関連した情報が格納されています。&lt;/p&gt;
&lt;p&gt;以下は、Interlのドキュメントに記載されていたMP仕様のデータ構造の図です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;FLOATING POINTER STRUCTURE&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;FIXED-LENGTH HEADER&lt;/code&gt;を参照しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAAB7ElEQVQ4y2WUiY6CQBBE+f9vW40bz0QNuq4niqIg4NU7r9fGESfpMGdNdXUNQZ7nkmVZFcfjUXa7nSRJIpvNRrbbraRpKvv9Xk6nkySHg84d3Jc59p3PZ91TFIUEUmv3+70+JePxWJrNprRa3+5w/rZ2vV7fxsHj8RAL2uVyUabcBnu+MOr3+/Izmykb5gn6rNMMIzAga2ww+naoLEu53W7KhnnG9LmcvQaoDG3AAZppuo0iWSyXslgsZD6fayzdOM8L1W3m2DJGxw9AdIuijWr11WhoYSytenBZ5C5br9f69QE1ZR+dNAAjrSQ5aLV3Tj8OomPsxsUzfYCtum8MrWNf9AEUi2ANghQBYA6W2CkMQ5WD1IuirDACn65pCIgVJHdsGU+nU03T9xx7SNmsVgH6DNlU9xash8OhkyD+8CjZ+Fl+AGIFUlSmz5cAmyxLn0VJFQSmZycD/mRcAfroxN0JzkFYWWX/AbOqb15kTIEAN9t9aMiCsTJgWPvhW8guMpkCHwj6vFdEt0NxHGsxVquVGpm+WYbAUr51Xhq6Sv06C4STSVVFgioa4OoJ6L9nLnz7OfjUoQ2YvQA2YxlEf0Wia7aO+c1KyBP44hMsDAYDGY1GGp1OR9rttnS7XQ36vV5Pjc1e++NwFn3/AEu3IidA9NVQAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/8ac56/image-29.webp 240w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/d3be9/image-29.webp 480w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/b0a15/image-29.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/8ff5a/image-29.png 240w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/e85cb/image-29.png 480w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png&quot;
            alt=&quot;2022/01/image-29.png&quot;
            title=&quot;2022/01/image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;FLOATING POINTER STRUCTURE&lt;/code&gt;は、MPフローティングポインタ構造体であり、xv6OSでは&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体として定義されていました。&lt;/p&gt;
&lt;p&gt;システムにMPフローティングポインタ構造体が存在する場合、そのシステムはMP仕様に準拠していることを意味します。&lt;/p&gt;
&lt;p&gt;MPフローティングポインタ構造体には以下の情報が含まれます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MPコンフィグレーションテーブルへのポインタ&lt;/li&gt;
&lt;li&gt;その他のMP情報へのポインタ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MPコンフィグレーションテーブルは、xv6OSで&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体として定義されています。&lt;/p&gt;
&lt;p&gt;後述する&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数では、MPフローティングポインタ構造体を取得した後に、その情報からMPコンフィグレーションテーブルを取得する処理が定義されています。&lt;/p&gt;
&lt;p&gt;では、OSはどうやってMPフローティングポインタ構造体を見つけるのかという点ですが、Interlの仕様書によると、MPフローティングポインタ構造体は以下のいずれかに存在するよう定義されているため、OSはこれらを検索してMPフローティングポインタ構造体の有無を確認することになります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;拡張BIOSデータ領域（EBDA）の最初の1KiB以内の領域&lt;/li&gt;
&lt;li&gt;システムベースメモリ領域の最後の1KiB以内の範囲&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0x0F0000&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;0x0FFFFFF&lt;/code&gt;の間のBIOS ROMアドレス空間&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;xv6OSでも、&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数によって、上記の領域の探索が行われます。&lt;/p&gt;
&lt;p&gt;これらの関数については後述します。&lt;/p&gt;
&lt;p&gt;次にMPコンフィグレーションテーブルですが、これは通常オプションの設定のようです。&lt;/p&gt;
&lt;p&gt;システムがデフォルトの場合はMPコンフィグレーションテーブルの定義は不要ですが、CPUの数が変動する可能性のある場合などは必須になります。(実質的に汎用OSでは必須ってことでしょうか)&lt;/p&gt;
&lt;p&gt;MPコンフィグレーションテーブルにはAPICやプロセッサ、バス、割込みに関する設定情報が含まれます。&lt;/p&gt;
&lt;p&gt;また新しくAPICという単語がでてきましたが、これはIntelのマルチプロセッサCPUで使用される割込み制御の機構です。&lt;/p&gt;
&lt;p&gt;APICについてはxv6OSで割込みコントローラを設定するときに詳しく見ていこうと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MP仕様についてはWEBページや書籍からはあまり有益な情報が得られなかったので、詳しく知るにはIntelの仕様書を読むのが一番早いと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html?page=37#manual&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Chapter 4 Mp Configuration Table; Mp Configuration Data Structures - Intel MultiProcessor Specification [Page 37] | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;mpフローティングポインタ構造体の取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%83%95%E3%83%AD%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;mpフローティングポインタ構造体の取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPフローティングポインタ構造体の取得&lt;/h3&gt;
&lt;p&gt;というわけでさっそく以下のコードを見ます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数の引数として&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体を与え、戻り値を&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の変数である&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の変数&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;を初期化するとともに、システムがSMPで動作しているかをチェックします。&lt;/p&gt;
&lt;p&gt;SMPとは、&lt;code class=&quot;language-text&quot;&gt;Symmetric multiprocessing&lt;/code&gt;あるいは&lt;code class=&quot;language-text&quot;&gt;shared-memory multiprocessing&lt;/code&gt;の略称で、要するに複数のCPUがメモリリソースを共有するマルチプロセッサシステムを意味しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Symmetric_multiprocessing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Symmetric multiprocessing - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Symmetric_Multiprocessing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Symmetric Multiprocessing - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一旦&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数のソースコードを見てみましょう。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数で宣言した&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体オブジェクトのアドレスを引数として、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体を戻り値とする関数です。&lt;/p&gt;
&lt;p&gt;この関数によってMPテーブルが検索され、引数として受け取った&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体オブジェクトと戻り値の&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の初期化が行われます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Search for an MP configuration table.  For now,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// don&apos;t accept the default configurations (physaddr == 0).&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Check for correct signature, calculate the checksum and,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// if correct, check the version.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// To do: check extended table checksum.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pmp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体は前述したMPフローティングポインタ構造体を指します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数が呼び出された時点ではまだシステムのMPフローティングポインタ構造体は取得できていないので、まずMPフローティングポインタ構造体を探索する必要があります。&lt;/p&gt;
&lt;p&gt;このために呼び出されるのが&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Look for an MP structure in the len bytes at addr.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  e &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; addr&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;_MP_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Search for the MP Floating Pointer Structure, which according to the&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// spec is in one of the following three locations:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 1) in the first KB of the EBDA;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 2) in the last KB of system base memory;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 3) in the BIOS ROM between 0xE0000 and 0xFFFFF.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  bda &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0E&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xF0000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;前述した通り、MPフローティングポインタ構造体が存在する場合は、以下のいずれかに配置されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;拡張BIOSデータ領域（EBDA）の最初の1KiB以内の領域&lt;/li&gt;
&lt;li&gt;システムベースメモリ領域の最後の1KiB以内の範囲&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0x0F0000&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;0x0FFFFFF&lt;/code&gt;の間のBIOS ROMアドレス空間&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これらの領域を検索してMPフローティングポインタ構造体が見つかった場合は&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;p&gt;このとき、MPフローティングポインタ構造体が見つからない場合、もしくはMPフローティングポインタ構造体が持つMPコンフィグレーションテーブルのアドレスが空の場合はカーネルを終了します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MPフローティングポインタ構造体は以下の構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// floating pointer&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;_MP_&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// phys addr of MP config table&lt;/span&gt;
  uchar length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// 1&lt;/span&gt;
  uchar specrev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// MP system config type&lt;/span&gt;
  uchar imcrp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体の定義は上記ですが、Intel仕様書の図の方がイメージしやすいので一緒に貼っておきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABz0lEQVQoz01S2W7CQAzM/38TfQKJW4irhQINOYCEcARCQkiAqcewVVeyNvHaY4/HVhiG2O/3OBwOap7ngj5+n89nHI9HbLdbxHGsPsYGQYBot/vLiaJIYhMkSQLrdDrhdrupFUWhAJc0xf1+h23/oNPpoF5vwF+t1JfnOdIsQ/7OKcsSl8tFC/Hd4s//83g89IEnirZot9vo9XpI00x9z+dTC5sYnixLsfJ9uTNYpPU9naLRaGjyerPBUWjYtg3HcZQqi27E77mu0icr0nOWSx1PkrDDnRQqXx0SdDweYb1eazLnQjCCEpDUCLgS2juZHWNo8/lc/amMKJD7es1hsRLbJxXenAkLsJtAqvtCZTqZKJgrPt5F8Zq3OQRkp8xVQD7SjDCJADJRaXqedmr+WcTE/heFShflmzI7IzUOld9GzTAM0O/3MRwOhd5COyEAAQ0T5jOP47qJ3yJQnl8xm81U+r3MKJEg13WwWCw0mKtESiMB5jdFYUFPYry3upGIdZcNsagaRWAQK/q+p0qapeYSs7p5j+OXzyw+jUKxe5rF1inIQWSvVD7wOR7jS0Sg6tVqFYPBALVaDa1mU9eq1WqhLcve7XbUt3RczTfz/wUC5z2KzlmzsAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/89053dbef9ccb06f6561234b34173eaa/8ac56/image-30.webp 240w,
/static/89053dbef9ccb06f6561234b34173eaa/d3be9/image-30.webp 480w,
/static/89053dbef9ccb06f6561234b34173eaa/b0a15/image-30.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/89053dbef9ccb06f6561234b34173eaa/8ff5a/image-30.png 240w,
/static/89053dbef9ccb06f6561234b34173eaa/e85cb/image-30.png 480w,
/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png&quot;
            alt=&quot;2022/01/image-30.png&quot;
            title=&quot;2022/01/image-30.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の4バイトの&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;_MP_&lt;/code&gt;が格納されていることが期待されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数で探索を行う場合には、この&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;を探索しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;physaddr&lt;/code&gt;にはMPコンフィグレーションテーブルのアドレスが格納されており、ここからはこの情報を元にMPコンフィグレーションテーブルを取得していきます。&lt;/p&gt;
&lt;h3 id=&quot;mpコンフィグレーションテーブルの取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;mpコンフィグレーションテーブルの取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPコンフィグレーションテーブルの取得&lt;/h3&gt;
&lt;p&gt;MPフローティングポインタ構造体を取得したら、MPコンフィグレーションテーブルの仮想アドレスを取得し、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造のポインタ変数&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;として格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MPコンフィグレーションテーブルは以下の構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// configuration table header&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;PCMP&quot;&lt;/span&gt;
  ushort length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// total table length&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar product&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// product id&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;oemtable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// OEM table pointer&lt;/span&gt;
  ushort oemlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// OEM table length&lt;/span&gt;
  ushort entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// entry count&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// address of local APIC&lt;/span&gt;
  ushort xlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// extended table length&lt;/span&gt;
  uchar xchecksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// extended table checksum&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以下はIntel仕様書から引用した構造図です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 476px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 126.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAARlAAAEZQAGA43XUAAADeUlEQVQ4y2WV6XLaUAyF/f7Pkb5HM9P+SiYEwr4vjrENBAibAYOqTyCnae/MnbtpOTqS5WA2m8lisZD9fm/z/f1dBoOh3THTJNHzQD4+Puw9yzLdL2S9Xtv5cDjYebVaS57nEmy2W+l02vL09CSlUknG47Gslkv5/euXPDz8kFa7LbvdTjabjfS6XanX69Lv96Wr++FwKO1W297SJJY0nUmwWq0MQaPRkLYqp2kqW3VSLr/Kz8dH6fV6hiLTmShaIiAq9lEUyWQyEWx4lAHK5/NZfLRaLUOBdxyB2Jx1OmYsiqZmhL2Py+Vq1MznCwk+Pz+FSVhH5QfPTJCGYWgoMMo+jmO7Z87nc+MTPUCBkHMATEfohtI0MQUfhMzI87PxB8LRaGh7EmG6OFMqAgjFy+l0MjRhiPDIQjqrMM6QYT0ejwVCd344ZEWmDSFw2WDwer0WqPDcaNSleU8W2X57e5ODyjKQvVwupoezOJ5a2IZwqwj9EQfGp6Ihe2QU7qBgqeWEc2hC7qSGcMyZOkUn8GT0el0NI72jPZsBCpyBIwaZR5EzctNppHp9M4wdhiHc3wsXTzzAyW63ldLLizSbDSOfUnp+fi7ePRL0/GwGPSGDQd+yBB9M7kDJilKWHc1Afk8Uk8wSRZ5fviPk8IVsZ0jhw5OFDCt3TOfQI/JzgRCvXCDsWWOlATBQ0LzKWpN0PJ5M/mgOsgJZrHxG0+n3LwVFMsv5bxRk1873aHhHziMjAnduXwoeqXzqiD01tlotrTFw3llZ5bcC17OXGKvL36KQG0LPGBxuNl97ipVibt8bBmWFIUcFx8hhjPN/WZ79k2UQM5C5Xi8WqhczXMLh591QOBnr5xopQr2ADyY8ULiszgsr5UMU7DHKPZM9DZo39KEgyDSzE7VOaK/asaNpbKHUanWp6l2iDcC7EZzWqlWp6uxofyyXy9bWDKE2FZpLweFFifXyYbLP1VBXFSuVijUISoUWZh1cneIIVMgvlx92Dnik/vhfhOG7CZA16gokIKBN0SBAFcdJkd2p1l2z2bSOHd27eTC3/0Nqj/DHBz/SDk1/wxARhCrM6n9IX6nPJEmKTmQc+qfHCge3/0ZkCnynlM5Q/y0gIIszdUIDBrnLYoywcRp4QyV+SK7WakXHhjtaVqn0IuXXkr5X7I0EEiqUvGhHonZ9/AE7OWhVjDxa3AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/8ac56/image-31.webp 240w,
/static/6dd866aa292a4e75103c8b5ea32eaf83/cf53a/image-31.webp 476w&quot;
              sizes=&quot;(max-width: 476px) 100vw, 476px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/8ff5a/image-31.png 240w,
/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png 476w&quot;
            sizes=&quot;(max-width: 476px) 100vw, 476px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png&quot;
            alt=&quot;2022/01/image-31.png&quot;
            title=&quot;2022/01/image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の4バイト分の領域に&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;が格納されていますが、これは&lt;code class=&quot;language-text&quot;&gt;PCMP&lt;/code&gt;になることが期待されます。&lt;/p&gt;
&lt;p&gt;xv6OSでは、取得したMPコンフィグレーションテーブルの確認のため、&lt;code class=&quot;language-text&quot;&gt;memcmp&lt;/code&gt;関数にて先頭4バイトが&lt;code class=&quot;language-text&quot;&gt;PCMP&lt;/code&gt;に一致するかをチェックしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、バージョン情報が適切であるか、データサイズが実際のサイズと一致するかについてもチェックを行っています。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数の以下の処理が終わり、MPフローティングポインタとMPコンフィグレーションテーブルを取得することができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;mpコンフィグレーションテーブルからioapicを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89ioapic%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;mpコンフィグレーションテーブルからioapicを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPコンフィグレーションテーブルからIOAPICを取得する&lt;/h3&gt;
&lt;p&gt;つづいて、&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;にMPコンフィグレーションテーブルの&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;から取得したアドレスを格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
lapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体は以下の構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// I/O APIC table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (2)&lt;/span&gt;
  uchar apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// I/O APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// I/O APIC version&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC flags&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Intel仕様書の図は以下です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACBUlEQVQ4y3VT2ZKiQBD0//9n9tEXn8YxQiZmFA9uEcFVQUNBQcytLGSXNXaJqOimKju7juzedrtFEARYryPEmw08z8d+v8dyaSHLMmzEx/9NFAlmrft2ZeznbockSZDnOc7nM3qHw0EdOwnQ4jhGmqbq830f4/EY0+lU/SRhjLjuSiyJ+SkhnVzbPQ8ej0fYtg3DGOPr6xuJVNLGiGtX2lYII6ngfr+jx0CbXdfo930PpmlisVgglkP/wjalR2Dr6rpuCF+NQGboOA5GoxGMz0/x/cmsa/SRMAxDyVAIr9erNrQoCjXu6WN5HBaBifSP+y6ui+XwWHZdP9CrqgplWf5lVXXXiXmeB9d1EclUSfyKo7Fvp9MJq9WqKZmEt9vtt7VAglgKgb4fqFS6mO6e2CROGsI2SGJaUVx1/PnlotqzLEu1ySnyADNime2eKwnbuA6FZVnLJULJIpPeUS40X/p2EeIso6xS1SIzTZ8YXmbbjiqAg1RCCncwGGA4HKLf72u/Rh8feHv7oRPmFIPA14mzfEcuJyEHQeG3Gmbs8RBhU2fD93d8TyaYz2Z6a1nenlO9dA41EsllukkS4yiEfKp78TFzVqJPr+nDQ/tBWwmRYRgqZrbCdR29bCLGJziV1TRnSsxeFs+VEqKvh5fvID2dz+eq/Oap7VQyLCkM19oSTv1/3y9w/hzqn7A9GwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ac56/image-32.webp 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/d3be9/image-32.webp 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/b0a15/image-32.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ff5a/image-32.png 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/e85cb/image-32.png 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png&quot;
            alt=&quot;2022/01/image-32.png&quot;
            title=&quot;2022/01/image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;IOAPICは外部割込みを複数のCPUで分散するための機構です。&lt;/p&gt;
&lt;p&gt;APICが外部割込みの機構であることは前述しましたが、APICにはローカルAPICとIOAPICの2種類があるようです。&lt;/p&gt;
&lt;p&gt;xv6OSではローカルAPICについては&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で、IOAPICについては&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で実装されています。&lt;/p&gt;
&lt;p&gt;ローカルAPICはCPUに内臓された割込みで、IOAPICはI/Oデバイスから受けとった割込みを、リダイレクションテーブルの情報を元にCPUに通知します。&lt;/p&gt;
&lt;p&gt;IOAPICはIOAPICテーブルを持っており、x86CPUは&lt;code class=&quot;language-text&quot;&gt;memory-mapped I/O&lt;/code&gt;を通してこのテーブルのエントリを定義できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memory-mapped I/O&lt;/code&gt;は簡単に言うとCPUとI/Oデバイス間で入出力を行う方法の一つで、物理アドレス空間にI/Oデバイスの入出力のための空間を用意し、CPUのメモリの読み書きの機能を利用して入出力を行う方法です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://mmi.hatenablog.com/entry/2017/04/09/132708&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O APICについて - 睡分不足&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%83%89I/O&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリマップドI/O - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PCIをI/Oデバイスに持つ一般的なシステムの場合、IOAPICはPCIの割込み信号の変化を検知し、リダイレクションテーブルの情報を元にCPUに割込みメッセージを発行します。&lt;/p&gt;
&lt;p&gt;この情報はCPU内部のローカルAPICが受け取り、割込みハンドラを呼び出して割込み処理を行った後、EOI(End of Interrupt)コマンドをIOAPICに返すことで、IOAPICに対して割込みの完了を通知します。&lt;/p&gt;
&lt;p&gt;詳しくは実際に割込み処理を実装するところまで進んだらやります。たぶん。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/IOAPIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IOAPIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2008/readings/ia32/ioapic.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;82093AA I/O ADVANCED PROGRAMMABLE INTERRUPT CONTROLLER (IOAPIC)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;APICの仕組みは、x86CPUとそのマザーボードのようなマルチプロセッサ環境での割込みを制御するための割込みコントローラが必要になったことで生まれました。&lt;/p&gt;
&lt;p&gt;もともと実装されていたPICと呼ばれるシンプルな割込み機構では、マルチプロセッサ構成での割込み処理に対応できなかったようです。&lt;/p&gt;
&lt;p&gt;xv6OSもマルチプロセッサ構成を前提としているので、PICからの割込みを無視してローカルAPICとIOAPICを使用した割込み処理を実装します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P45&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSのコードでは&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;にMPコンフィグレーションテーブルの&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;から取得したアドレスを格納しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;に格納されているのはメモリマップドされたローカルAPICのアドレスです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;を格納する変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;defs.h&lt;/code&gt;でグローバル変数として定義されています。&lt;/p&gt;
&lt;p&gt;この関数の中では以降使用することはなく、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で使用することになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;    lapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセッサの情報を取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセッサの情報を取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセッサの情報を取得する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;の取得が完了した後のループを見てみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;には、先ほど取得したMPコンフィグレーションテーブルが格納されています。&lt;/p&gt;
&lt;p&gt;Intelの仕様書より、MPコンフィグレーションテーブルエントリは、MPコンフィグレーションテーブルヘッダ(MPコンフィグレーションテーブルの先頭アドレス)から、可変数で続いていくことがわかります。&lt;/p&gt;
&lt;p&gt;MPコンフィグレーションテーブルエントリは、先ほど例示した&lt;code class=&quot;language-text&quot;&gt;Processor Entries&lt;/code&gt;の他に、&lt;code class=&quot;language-text&quot;&gt;Bus Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;I/O APIC Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;I/O Interrupt Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;Local Interrupt Entry&lt;/code&gt;などがあります。(他にも拡張エントリが存在します)&lt;/p&gt;
&lt;p&gt;これらはいずれも先頭1バイトにユニークな&lt;code class=&quot;language-text&quot;&gt;Entry Point&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Processor Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACBUlEQVQ4y3VT2ZKiQBD0//9n9tEXn8YxQiZmFA9uEcFVQUNBQcytLGSXNXaJqOimKju7juzedrtFEARYryPEmw08z8d+v8dyaSHLMmzEx/9NFAlmrft2ZeznbockSZDnOc7nM3qHw0EdOwnQ4jhGmqbq830f4/EY0+lU/SRhjLjuSiyJ+SkhnVzbPQ8ej0fYtg3DGOPr6xuJVNLGiGtX2lYII6ngfr+jx0CbXdfo930PpmlisVgglkP/wjalR2Dr6rpuCF+NQGboOA5GoxGMz0/x/cmsa/SRMAxDyVAIr9erNrQoCjXu6WN5HBaBifSP+y6ui+XwWHZdP9CrqgplWf5lVXXXiXmeB9d1EclUSfyKo7Fvp9MJq9WqKZmEt9vtt7VAglgKgb4fqFS6mO6e2CROGsI2SGJaUVx1/PnlotqzLEu1ySnyADNime2eKwnbuA6FZVnLJULJIpPeUS40X/p2EeIso6xS1SIzTZ8YXmbbjiqAg1RCCncwGGA4HKLf72u/Rh8feHv7oRPmFIPA14mzfEcuJyEHQeG3Gmbs8RBhU2fD93d8TyaYz2Z6a1nenlO9dA41EsllukkS4yiEfKp78TFzVqJPr+nDQ/tBWwmRYRgqZrbCdR29bCLGJziV1TRnSsxeFs+VEqKvh5fvID2dz+eq/Oap7VQyLCkM19oSTv1/3y9w/hzqn7A9GwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ac56/image-32-164559487926114.webp 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/d3be9/image-32-164559487926114.webp 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/b0a15/image-32-164559487926114.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ff5a/image-32-164559487926114.png 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/e85cb/image-32-164559487926114.png 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png&quot;
            alt=&quot;2022/01/image-32.png&quot;
            title=&quot;2022/01/image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Bus Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABSElEQVQoz3VRXXOCQAzk//+t+mZrHwUH5U6BooBw+FE4lW026oydaTOTyc0lu0k2wW63A70sSyyXMYyxqKoKdV1jv6+xWq1QFAXattWa7baAtRavuDzLtN65FsHlcoEfBjCSwHUdrtervPdKbEyihAR779H3vZLzPQiO8Xw+K6EXjuB2uykZI4tZMMrbGIM4jrFYRAijCPP5HIPk2Px0OuHVOEAimzTtY8LhMeHxeNRu3t8b0PhHAGPbOiXjhFYaJkmC9XqNL9mA+XEcEbx24nQE05ikk4AxDEOdmmuxKbU0yV2Ow+GApWxTVjWCTjRzzumntQZZliuAHekkoT7cgpJ0nUMqR/iWN+v4R72fMgQc/+k8ApOZAAjK81xXStMUm81Gr8tcLTVN0/zpv1Z+Go/xNpkgkmPQKfj7xwyfsxmm0yn6weM/+wHnhWCKxxlD3wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ebb106502198c09c82ee7c65884af857/8ac56/image-33.webp 240w,
/static/ebb106502198c09c82ee7c65884af857/d3be9/image-33.webp 480w,
/static/ebb106502198c09c82ee7c65884af857/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ebb106502198c09c82ee7c65884af857/8ff5a/image-33.png 240w,
/static/ebb106502198c09c82ee7c65884af857/e85cb/image-33.png 480w,
/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png&quot;
            alt=&quot;2022/01/image-33.png&quot;
            title=&quot;2022/01/image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I/O APIC Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 36.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABTElEQVQozz1R7a6CMBTj/V9LE8UoinKjV0QQjIOBRr4EFOxdZ64/mmXL2tP2GOfzGVmW4Xq94na7wfM8fS/LQqGETBJEUYSiKJDnuUai3tI0/XKEELjf76jrGkZVVej7Hq/XC8MwIAxD7Pd7hEqE4qfTCcfjEa7ramEa4J9S8Yah19ymaRDHMerHAwZdPJ9PdF2nRcXlAt/3IaXUZCF4D7QYXfH9X5D/CTpjKgobJG02a2y3WyyXS7iHg447Go1gmiZyFbVrW2RKzA8CSHWSGAY+FgtL85iA1ZRlBYP5LcvCdDpVwg5Wq5VyIvHjOPCUOB1xOt1xOHsjHioe09Eda0vVv6ZpP4IEOyCZcZNEfgmfiJEunQvhKUSsB3AhBJfEJHop7I898CTe7zfWaxuTyQS2beN3t9MLmc1MjMdjzOdzFXXx7ZDdk9eqWog/BA8JmOWgzGAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/8ac56/image-34.webp 240w,
/static/7ad98ae9eace37cd674ae886ea48e121/d3be9/image-34.webp 480w,
/static/7ad98ae9eace37cd674ae886ea48e121/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/8ff5a/image-34.png 240w,
/static/7ad98ae9eace37cd674ae886ea48e121/e85cb/image-34.png 480w,
/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png&quot;
            alt=&quot;2022/01/image-34.png&quot;
            title=&quot;2022/01/image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I/O Interrupt Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABhUlEQVQoz21Sa2+CQBD0//8sbX010SpaRB4CBUQBkXfig+nOmX5peskFbu92ZnZnB0maoixLVFWFMAxhWhaKolCbcfdwgO/76v56vSLLMniei1Tyft9FkpckCfI8x8DY7aBtNlitVtjv9wp0o85rbLdbBEGgYtp6jZ2uwxLCy+WCXPaaMcmvm0YBP59PDD7mc8xmM0wnYwXcyOVG0zCZTLFcfiIVRV3XwrEtaBKnyrqu0cgej9+FfIu+73FwHGRCMrjf74J+hWmaWAnjcrFQ/7qoITPVJOezOlP18Rirsm1RakhFjgC5nictKfGgwsfjgSgKMRqNMByOYBgGclERfPsIwgiu6+J2u8HY6fLm7aVOiDLpIdvBXpLYse2XwjiOcTrF0mhPVHzBlouqqlVpfMwzv6yk6zq0bQPmNG2rjCJBmiYSb9FTIZvJCwboqmWZCtwTZVEU4SAuszQC0122g1UQtChKZQbJ6bByGX8WARfSRyZlWfoaJXOvpoBO0wROAUfpv/UDy39OoWydYDYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/8ac56/image-35.webp 240w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/d3be9/image-35.webp 480w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/b0a15/image-35.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/8ff5a/image-35.png 240w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/e85cb/image-35.png 480w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png&quot;
            alt=&quot;2022/01/image-35.png&quot;
            title=&quot;2022/01/image-35.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Local Interrupt Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABhUlEQVQoz11SyZKCQAzl/3/Gmpsnaxy8aImjIloKLqDstBubwOFNEqvmIFVNd9JJXt5La1EUoSxLFEWBsipxPB5xvV7fNvlVlsHzPDyfT/Hl+ROck6ap2Lz4fL/fUdc1NP9yQb/fx8/wG4PBAL7vY7NeY7k0sVgssN3tEMcxttstDMPAfr8Xu64rrExT4nIqmmUpgeXQGGEyGeOr15OE16vBzJjKeTweY2VZgp6mifiUUlDEoG0pbmZgOjXo3BFIJHEat6lUhp1t40R0OWm93uBwOAhVBmAJ3ncz8ed5gSDwYVOO67q4EEumzbJot9tNKs/nc6I9hD4aIQxDWVyEC2SZElBd1+EHgWj7eDwkhgux/d8hd8EJMQnt+4Hop9RV9GDEgDT1zmfq9IWu69A0DZIkkXuW6y1HCm6MYzT+MW3e27aF49gwSWyLCjuOQ7RdWNaKxF/KkHgQvP8So4xeAANUVU2rkk41fHzc+ul0kknyABg5JJpML6D9TN3yS2BmJRX5/P4AbOBPKN6XDQsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3b0896cae18d6fa27616529c9db55817/8ac56/image-36.webp 240w,
/static/3b0896cae18d6fa27616529c9db55817/d3be9/image-36.webp 480w,
/static/3b0896cae18d6fa27616529c9db55817/b0a15/image-36.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3b0896cae18d6fa27616529c9db55817/8ff5a/image-36.png 240w,
/static/3b0896cae18d6fa27616529c9db55817/e85cb/image-36.png 480w,
/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png&quot;
            alt=&quot;2022/01/image-36.png&quot;
            title=&quot;2022/01/image-36.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSの以下のコードでも、MPコンフィグレーションヘッダの先頭から各エントリをチェックしていき、先頭の&lt;code class=&quot;language-text&quot;&gt;Entry Type&lt;/code&gt;の値に応じて処理を分岐させています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
      ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPBUS&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPLINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;チェックしているエントリは以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Table entry types&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPPROC&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per processor&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPBUS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per bus&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPIOAPIC&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x02&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per I/O APIC&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPIOINTR&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per bus interrupt source&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPLINTR&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x04&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per system interrupt source&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;processor-entryの情報取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#processor-entry%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot; aria-label=&quot;processor entryの情報取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Processor Entryの情報取得&lt;/h3&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;Processor Entry&lt;/code&gt;の場合です。&lt;/p&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;mpproc&lt;/code&gt;構造体のオブジェクトとして&lt;code class=&quot;language-text&quot;&gt;Processor Entriy&lt;/code&gt;を取得し、&lt;code class=&quot;language-text&quot;&gt;Local APIC ID&lt;/code&gt;の値をすべての&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;配列に順に格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
    ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみにここで使用されている&lt;code class=&quot;language-text&quot;&gt;NCPU&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で以下のように定数として定義されています。&lt;/p&gt;
&lt;p&gt;xv6OSは最大で8CPUまでサポートしているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NCPU&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of CPUs&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ioapicの情報取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ioapic%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot; aria-label=&quot;ioapicの情報取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IOAPICの情報取得&lt;/h3&gt;
&lt;p&gt;続いては&lt;code class=&quot;language-text&quot;&gt;IOAPIC&lt;/code&gt;の情報を取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;各構造体などについては前述したので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;imcrの変更&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#imcr%E3%81%AE%E5%A4%89%E6%9B%B4&quot; aria-label=&quot;imcrの変更 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IMCRの変更&lt;/h3&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;の処理はほぼ完了しました。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;IMCR&lt;/code&gt;を無効化します。&lt;/p&gt;
&lt;p&gt;IMCRは割り込みモード構成レジスタと呼ばれ、PICモードから変更するためには&lt;code class=&quot;language-text&quot;&gt;IMCR&lt;/code&gt;の変更が必要になるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://reverseengineering.stackexchange.com/questions/26308/where-is-the-imcr-defined-in-the-docs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - Where is the IMCR defined in the docs? - Reverse Engineering Stack Exchange&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://forum.osdev.org/viewtopic.php?f=1&amp;#x26;t=29102&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev.org • View topic - Set IMCR to 0x1 to mask external interrupts?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html?page=31&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Default Configurations; Symmetric I/O Mode - Intel MultiProcessor Specification [Page 31] | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数から始めます。&lt;/p&gt;
&lt;p&gt;今回取得した情報を利用して割込みコントローラを実装するようです。&lt;/p&gt;
&lt;p&gt;だんだん頭がついてこなくなってきたのでちょっと気合入れて頑張ろうと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる]]></title><link>https://kashiwaba-yuki.com/windows-windriver-002-irp</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windriver-002-irp</guid><pubDate>Sat, 29 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。&lt;/p&gt;
&lt;p&gt;なければ作ってしまおう、と思いカーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については以下の記事でまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;前回&lt;/a&gt;の記事ではDebugViewを設定してKdPrintでOSのバージョンを出力するだけのドライバを作成し、ライブデバッグを行いました。&lt;/p&gt;
&lt;p&gt;今回はもう少し動きのあるドライバを作成してデバッグをしていきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネルプログラミングについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9&quot;&gt;ユーザモードと比較した場合の、カーネルドライバ開発の相違点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;構造化例外処理(SEH)について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネル関数について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネルドライバのメモリ割り当てについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;デバイスオブジェクトについて&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;カーネルドライバとクライアントアプリケーションを作成する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D&quot;&gt;スケジュールの優先順位&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B&quot;&gt;DriverEntry関数を作る&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;DriverEntry関数を読む&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88&quot;&gt;ディスパッチルーチンのサポート&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97&quot;&gt;カーネル関数が使用する文字列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;デバイスオブジェクトの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;シンボリックリンクの作成&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;ディスパッチルーチンに割り当てるルーチンのセットアップ&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3&quot;&gt;関数アノテーション&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot;&gt;IRPの受け取り&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;デバイスコントロールのセットアップ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;現在のスタックロケーションの取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;要求された優先順位をスレッドに設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot;&gt;ドライバのインストール&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;カーネルデバッグで挙動を確認してみる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;ブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;IRPを解析する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルプログラミングについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネルプログラミングについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルプログラミングについて&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;を参考にカーネルドライバの開発を行っています。&lt;/p&gt;
&lt;p&gt;前回インストールしたWDK(Windows Driver Kit)にはカーネルドライバ開発で使用するライブラリとヘッダファイルが格納されています。&lt;/p&gt;
&lt;p&gt;カーネルAPIはC言語の関数群で構成されていますが、ユーザモード開発とは主に以下の点で異なります。&lt;/p&gt;
&lt;h3 id=&quot;ユーザモードと比較した場合のカーネルドライバ開発の相違点&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9&quot; aria-label=&quot;ユーザモードと比較した場合のカーネルドライバ開発の相違点 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ユーザモードと比較した場合の、カーネルドライバ開発の相違点&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;よりユーザモードと比較した場合の、カーネルドライバ開発の相違点について引用します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;未処理の例外発生時、システムをクラッシュさせる(BSOD)&lt;/li&gt;
&lt;li&gt;プロセスの終了時のアンロードルーチンでリソースを解放する必要がある(解放されない場合はリークが発生する)&lt;/li&gt;
&lt;li&gt;カーネルドライバ開発時のエラーは決して無視してはいけない&lt;/li&gt;
&lt;li&gt;IRQLが0より大きくなる場合がある&lt;/li&gt;
&lt;li&gt;埋め込まれたバグがシステム全体に影響を及ぼす可能性がある&lt;/li&gt;
&lt;li&gt;デバッグは他のマシンからリモートデバッグする必要がある&lt;/li&gt;
&lt;li&gt;ほとんどの標準ライブラリは使えない&lt;/li&gt;
&lt;li&gt;例外処理に使えるのは&lt;code class=&quot;language-text&quot;&gt;Structured Exception Handling(SEH)&lt;/code&gt;のみ&lt;/li&gt;
&lt;li&gt;C++ランタイムが利用できない&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;構造化例外処理sehについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;構造化例外処理sehについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;構造化例外処理(SEH)について&lt;/h3&gt;
&lt;p&gt;SEHはハードウェア障害などの特定の例外コードの状況を適切に処理するための機能です。&lt;/p&gt;
&lt;p&gt;SEHを使用することで、例外が発生した場合でも、メモリブロックやファイルなどのリソースが正常に解放されるようにプログラムを書くことができるようになります。&lt;/p&gt;
&lt;p&gt;SEHでは、「例外ハンドラ」と「終了ハンドラ」の2つのメカニズムを利用できます。&lt;/p&gt;
&lt;p&gt;例外ハンドラは特定のエラーに対応するために使用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/writing-an-exception-handler?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;例外ハンドラーの記述 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一方、終了ハンドラはコードブロックの処理が正常に終了したか例外が発生したかに関わらず常に実行させることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/writing-a-termination-handler?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;終了ハンドラーの記述 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルドライバ開発を行う場合は、SEHを使い、上記のいずれかを用いて例外処理を実装していく必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Structured Exception Handling (C/C++) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネル関数について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネル関数について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネル関数について&lt;/h3&gt;
&lt;p&gt;カーネルドライバ開発の際にはCの標準ライブラリは基本的には使用できません。&lt;/p&gt;
&lt;p&gt;カーネルドライバ開発では、カーネルのコンポーネントからエクスポートされている関数を使用します。&lt;/p&gt;
&lt;p&gt;多くのカーネル関数は&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;の中で実装されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;で実装されている関数には、文書化されているものと文書化されていないものがあります。&lt;/p&gt;
&lt;p&gt;カーネル関数の名前にはある程度規則性があり、目的ごとに接頭語が付属しています。&lt;/p&gt;
&lt;p&gt;接頭語の対応表については以下のWikipediaページに詳しく書いてありました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Ntoskrnl.exe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ntoskrnl.exe - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;文書化されているカーネル関数については以下のページなどから参照することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/ddi/_kernel/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows kernel - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネルドライバのメモリ割り当てについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネルドライバのメモリ割り当てについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバのメモリ割り当てについて&lt;/h3&gt;
&lt;p&gt;カーネルはドライバが利用可能な以下の2つのメモリプールを提供しています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ページプール：必要に応じてページアウトされる領域&lt;/li&gt;
&lt;li&gt;非ページプール：ページアウトされない領域&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;また、非ページプールは実行が可能な領域と実行不可の領域をそれぞれ制御することができます。&lt;/p&gt;
&lt;p&gt;ページングを行わない非ページプールを使用すればページフォールトが発生しないことが保証されますが、ドライバ開発を行う場合は可能な限りページプールで開発することが推奨されるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepool&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ExAllocatePool function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバイスオブジェクトについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;デバイスオブジェクトについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスオブジェクトについて&lt;/h3&gt;
&lt;p&gt;カーネルドライバは原則として1つ以上のデバイスオブジェクトを作成する必要があります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトとは、OSがデバイスを表すために使用されるものです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-device-objects&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバイス オブジェクトの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトは&lt;code class=&quot;language-text&quot;&gt;DEVICEOBJECT&lt;/code&gt;構造体のインスタンスとして作成されます。&lt;/p&gt;
&lt;p&gt;カーネルドライバは、デバイスオブジェクトを経由してクライアントアプリケーションと通信を行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_device_object&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;DEVICE&lt;/em&gt;OBJECT (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルドライバとクライアントアプリケーションを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルドライバとクライアントアプリケーションを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバとクライアントアプリケーションを作成する&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;の4章で解説されているコードを写経しつつSecondDriverSampleの開発を行っていきます。&lt;/p&gt;
&lt;p&gt;4章では、スレッドの優先度をコントロールするカーネルドライバとクライアントアプリケーションのセットを作成しました。&lt;/p&gt;
&lt;h3 id=&quot;スケジュールの優先順位&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D&quot; aria-label=&quot;スケジュールの優先順位 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スケジュールの優先順位&lt;/h3&gt;
&lt;p&gt;そもそもの話ですが、僕はWindowsAPIを使ったスレッド優先度の設定が何かについてそもそもよく知らなかったので簡単に調べてみました。&lt;/p&gt;
&lt;p&gt;Windows環境において、スレッドはスレッドの優先順位によってスケジュールされます。&lt;/p&gt;
&lt;p&gt;スレッドの優先順位は以下の2つの条件で決定されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;プロセスの優先度クラス&lt;/li&gt;
&lt;li&gt;プロセスの優先度クラス内のスレッドの優先度レベル&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;プロセスの優先度クラスは以下のいずれかに属しており、&lt;code class=&quot;language-text&quot;&gt;SetPriorityClass&lt;/code&gt;によって設定することができます。&lt;/p&gt;
&lt;p&gt;デフォルトではプロセスの優先度クラスは&lt;code class=&quot;language-text&quot;&gt;THREAD_PRIORITY_NORMAL&lt;/code&gt;になるようです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;IDLE&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;LOWEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;BELOW_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;ABOVE_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;HIGHEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;TIME_CRITICAL&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一方で、各優先度クラス内のスレッドの優先度レベルは以下のいずれかが設定されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SetThreadPriority&lt;/code&gt;で変更することができます。&lt;/p&gt;
&lt;p&gt;こちらもデフォルトでは&lt;code class=&quot;language-text&quot;&gt;THREAD_PRIORITY_NORMAL&lt;/code&gt;が割り当てされます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;IDLE&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;LOWEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;BELOW_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;ABOVE_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;HIGHEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;TIME_CRITICAL&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setpriorityclass&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SetPriorityClass function (processthreadsapi.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SetThreadPriority function (processthreadsapi.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これらの組みあわせによって各スレッドの優先順位が決定するものの、以下のリンク先の表の通り通常の設定方法では、すべてのレベルの優先順位を柔軟に設定することができないようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/win32/procthread/scheduling-priorities&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スケジュールの優先順位 - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで、4章で開発するドライバとクライアントでは、スレッドの優先度を柔軟に設定できるようにすることを目標にしています。&lt;/p&gt;
&lt;h3 id=&quot;driverentry関数を作る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B&quot; aria-label=&quot;driverentry関数を作る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry関数を作る&lt;/h3&gt;
&lt;p&gt;ベースは&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;過去の記事&lt;/a&gt;で作成した手順と同じです。&lt;/p&gt;
&lt;p&gt;まずはエントリポイントになる&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数を作ります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数では、以下の処理を実装します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;アンロードルーチンの設定&lt;/li&gt;
&lt;li&gt;ドライバがサポートするディスパッチルーチンの設定&lt;/li&gt;
&lt;li&gt;デバイスオブジェクトの生成&lt;/li&gt;
&lt;li&gt;デバイスオブジェクトへのシンボリックリンクの作成&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;アンロードルーチンとデバイスオブジェクトが必要な理由は前述した通りです。&lt;/p&gt;
&lt;p&gt;詳しくは以下の「必須の標準ドライバー ルーチン」の項が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-standard-driver-routines&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;標準ドライバー ルーチンの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ディスパッチルーチンはIRP(受信I/O要求パケット)を処理するものです。&lt;/p&gt;
&lt;p&gt;IRPには様々な要求に対してその要求に関する情報が格納されます。&lt;/p&gt;
&lt;p&gt;カーネルドライバは、ドライバのデバイスハンドルをオープンするために、最低限&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_CREATE&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_CLOSE&lt;/code&gt;のディスパッチルーチンについてはサポートする必要があるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/dispatch-routine-functionality&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ディスパッチ ルーチンの機能 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DRIVER_DISPATCH (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchcreate--dispatchclose--and-dispatchcreateclose-routines&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DispatchCreate, DispatchClose, and DispatchCreateClose Routines - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトへのシンボリックリンクを作成するのは、クライアントからカーネルドライバのデバイスオブジェクトを参照するためです。&lt;/p&gt;
&lt;p&gt;例えば&lt;code class=&quot;language-text&quot;&gt;CreateFile&lt;/code&gt;関数などは第1引数にデバイスオブジェクトのシンボリックリンクを受け取ります。&lt;/p&gt;
&lt;h2 id=&quot;driverentry関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;driverentry関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry関数を読む&lt;/h2&gt;
&lt;p&gt;ここで、実際に写経しつつ作成した&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数は次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;C&quot;&lt;/span&gt; NTSTATUS
&lt;span class=&quot;token function&quot;&gt;DriverEntry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_In_ PDRIVER_OBJECT DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _In_ PUNICODE_STRING RegistryPath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;UNREFERENCED_PARAMETER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RegistryPath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;SecondDriver DriverEntry started\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;DriverUnload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverUnload&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_DEVICE_CONTROL&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverDeviceControl&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	UNICODE_STRING devName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\Device\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;//RtlInitUnicodeString(&amp;amp;devName, L&quot;\\Device\\ThreadBoost&quot;);&lt;/span&gt;
	PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	NTSTATUS status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_DEVICE_UNKNOWN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FALSE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create device (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateSymbolicLink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;symLink&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create symbolic link (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;IoDeleteDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;SecondDriverSecondDriver DriverEntry completed successfully\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ディスパッチルーチンのサポート&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88&quot; aria-label=&quot;ディスパッチルーチンのサポート permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスパッチルーチンのサポート&lt;/h3&gt;
&lt;p&gt;とりあえず気になったのは以下の3行です。&lt;/p&gt;
&lt;p&gt;ここではディスパッチルーチンのセットアップを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_DEVICE_CONTROL&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverDeviceControl&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;semi-documented&lt;/code&gt;な構造体で、ロードされたカーネルモードドライバーのイメージを表します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;_DRIVER_OBJECT&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  CSHORT             Type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  CSHORT             Size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDEVICE_OBJECT     DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ULONG              Flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PVOID              DriverStart&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ULONG              DriverSize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PVOID              DriverSection&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_EXTENSION  DriverExtension&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  UNICODE_STRING     DriverName&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PUNICODE_STRING    HardwareDatabase&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PFAST_IO_DISPATCH  FastIoDispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_INITIALIZE DriverInit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_STARTIO    DriverStartIo&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_UNLOAD     DriverUnload&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_DISPATCH   MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_MAXIMUM_FUNCTION &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; DRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;PDRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;DRIVER&lt;/em&gt;OBJECT (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「ロードされたカーネルモードドライバーのイメージ」とは？って感じですが&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数が呼び出されるときにカーネル側で割り当てと初期化をされた後で渡されるオブジェクトとのことで、カーネル側でよしなにしてくれたオブジェクトなんだろうなと思ってます。（調べてもよくわからなかった・・・）&lt;/p&gt;
&lt;p&gt;ここで、このドライバオブジェクトのメンバである&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;にディスパッチルーチンを登録することでドライバがサポートする具体的な機能を指定できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;は関数ポインタの配列として管理されていて、&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_&lt;/code&gt;という接頭語がついたインデックスが事前定義されています。&lt;/p&gt;
&lt;p&gt;ここで、サポートするディスパッチルーチンのみ追加すればいい理由は、&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;配列はカーネル側で初期化された際にすべての要素がドライバがサポートしていないIRPであることを示す&lt;code class=&quot;language-text&quot;&gt;nt!IopInvalidDeviceRequest&lt;/code&gt;に設定されているためです。&lt;/p&gt;
&lt;p&gt;そのため、サポートするディスパッチルーチンのみ更新を行う方式になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://social.msdn.microsoft.com/Forums/ja-JP/4f42ce1d-cbd1-4968-b458-1d96239368a8/driverobject-12392-driverentry?forum=wdksupportteamja&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DriverObject と DriverEntry&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネル関数が使用する文字列&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97&quot; aria-label=&quot;カーネル関数が使用する文字列 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネル関数が使用する文字列&lt;/h3&gt;
&lt;p&gt;カーネル関数で文字列を使用する場合、基本的には&lt;code class=&quot;language-text&quot;&gt;UNICODE_STRING&lt;/code&gt;型の構造体が期待されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;UNICODE&lt;/em&gt;STRING (ntdef.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ソースコードの以下の行では、&lt;code class=&quot;language-text&quot;&gt;RTL_CONSTANT_STRING&lt;/code&gt;マクロを使ってパスの文字列&lt;code class=&quot;language-text&quot;&gt;\\Device\\SecondDriver&lt;/code&gt;を&lt;code class=&quot;language-text&quot;&gt;UNICODE_STRING&lt;/code&gt;に変換して変数&lt;code class=&quot;language-text&quot;&gt;devname&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;そのあとに出てくる&lt;code class=&quot;language-text&quot;&gt;symLink&lt;/code&gt;の行も同様です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;UNICODE_STRING devName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\Device\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlinitstring&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RtlInitString function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバイスオブジェクトの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;デバイスオブジェクトの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスオブジェクトの作成&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数内で行う必要がある「デバイスオブジェクトの生成」はここで行います。&lt;/p&gt;
&lt;p&gt;もともと&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数の引数としてカーネルが初期化した&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;を受け取ってはいますが、これは&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数でデバイスオブジェクトを作成するために必要な情報になります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトが存在しない場合、ハンドルをオープンしてユーザモードのクライアントがドライバと通信する方法がない状態となります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトは&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数で作成します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数は以下の構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;NTSTATUS &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           PDRIVER_OBJECT  DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           ULONG           DeviceExtensionSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; optional&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; PUNICODE_STRING DeviceName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           DEVICE_TYPE     DeviceType&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           ULONG           DeviceCharacteristics&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           BOOLEAN         Exclusive&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          PDEVICE_OBJECT  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;DeviceObject
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoCreateDevice function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第1引数として受け取る&lt;code class=&quot;language-text&quot;&gt;PDRIVER_OBJECT&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;は呼び出し元のデバイスオブジェクトになります。&lt;/p&gt;
&lt;p&gt;これは&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数の引数として受け取っていたものです。&lt;/p&gt;
&lt;p&gt;第7引数には、新しく作成する&lt;code class=&quot;language-text&quot;&gt;DeviceObject&lt;/code&gt;構造体のポインタが与えられます。&lt;/p&gt;
&lt;p&gt;新たに宣言した&lt;code class=&quot;language-text&quot;&gt;PDEVICE_OBJECT&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;DeviceObject&lt;/code&gt;のポインタを引数として与えられます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数が正常に動作した場合、このポインタの参照先に非ページプールから割り当てられたデバイスオブジェクトが格納されます。&lt;/p&gt;
&lt;p&gt;また、第3引数の&lt;code class=&quot;language-text&quot;&gt;DeviceName&lt;/code&gt;では、作成するデバイスオブジェクトに名前を付けることができます。&lt;/p&gt;
&lt;p&gt;ここでは、先ほど定義した&lt;code class=&quot;language-text&quot;&gt;devname&lt;/code&gt;を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DeviceType&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;FILE_DEVICE_UNKNOWN&lt;/code&gt;を指定します。&lt;/p&gt;
&lt;p&gt;その他設定可能なデバイスタイプについては以下のドキュメントにまとまってます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/specifying-device-types&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Specifying Device Types - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際のコードは以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
NTSTATUS status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_DEVICE_UNKNOWN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FALSE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create device (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;処理に失敗した場合は、&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;関数でエラーメッセージを出力します。&lt;/p&gt;
&lt;h3 id=&quot;シンボリックリンクの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;シンボリックリンクの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボリックリンクの作成&lt;/h3&gt;
&lt;p&gt;デバイスオブジェクトを作成しましたが、このままではユーザモードのクライアントからはアクセスすることができません。&lt;/p&gt;
&lt;p&gt;ユーザモードのクライアントからデバイスドライバにアクセスするためには、デバイスオブジェクトのシンボリックリンクの作成が必要になります。&lt;/p&gt;
&lt;p&gt;シンボリックリンクの作成は&lt;code class=&quot;language-text&quot;&gt;IoCreateSymbolicLink&lt;/code&gt;関数で行います。&lt;/p&gt;
&lt;p&gt;関数自体はシンプルで、&lt;code class=&quot;language-text&quot;&gt;PUNICODE_STRING&lt;/code&gt;構造体に変換したシンボリックリンクとデバイスオブジェクトの名前を引数に与えるだけです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoCreateSymbolicLink function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際のコードは以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateSymbolicLink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;symLink&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create symbolic link (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoDeleteDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボリックリンクの作成に失敗した場合、すべての作業を取り消して終了する必要があります。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;IoDeleteDevice&lt;/code&gt;関数を用いてシステムからデバイスオブジェクトを削除しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iodeletedevice&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoDeleteDevice function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトとシンボリックリンクの作成が完了したら&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;の処理は終了します。&lt;/p&gt;
&lt;h2 id=&quot;ディスパッチルーチンに割り当てるルーチンのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;ディスパッチルーチンに割り当てるルーチンのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスパッチルーチンに割り当てるルーチンのセットアップ&lt;/h2&gt;
&lt;p&gt;先ほど以下の行で設定したCREATEとCLOSEをサポートするルーチンをセットアップしていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;4章で作成したプログラムでは、CREATEとCLOSEのルーチンが同じ&lt;code class=&quot;language-text&quot;&gt;SecondDriverCreateClose&lt;/code&gt;に設定されています。&lt;/p&gt;
&lt;p&gt;これは、特別な処理をせずに単にIRP要求を受け入れるだけの挙動だからです。&lt;/p&gt;
&lt;p&gt;CREATEとCLOSEで処理を分けたい場合は、ルーチンも異なるルーチンを作成して割り当てる必要があります。&lt;/p&gt;
&lt;p&gt;実際にコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;_Use_decl_annotations_
NTSTATUS &lt;span class=&quot;token function&quot;&gt;SecondDriverCreateClose&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PIRP Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;UNREFERENCED_PARAMETER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、実際に書籍のサンプルのようにディスパッチルーチンを定義すると、ビルド時にコンパイルエラーC2440が発生しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;エラー	C2440	&lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &apos;&lt;span class=&quot;token function&quot;&gt;NTSTATUS&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__stdcall &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;PIRP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos; から &apos;&lt;/span&gt;PDRIVER_DISPATCH&apos; に変換できません。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ググっても正直よくわからなかったのですが、割り当てる関数をプロトタイプ宣言じゃなくて&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数より前に直接定義してみたら解決しました。&lt;/p&gt;
&lt;p&gt;ほんとにこれでいいのかはわからん。&lt;/p&gt;
&lt;p&gt;そもそもWDMでカーネル開発すること自体が非推奨なので、最新のコンパイラだと何か引っかかっちゃうんですかね？&lt;/p&gt;
&lt;h3 id=&quot;関数アノテーション&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3&quot; aria-label=&quot;関数アノテーション permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;関数アノテーション&lt;/h3&gt;
&lt;p&gt;先頭行に&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;がありますが、用途が全く分かりませんでした。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;を使用することで、同じ関数のスコープ内のヘッダに表示されるアノテーションが&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;を持つ定義にも存在するかのように使用される、とドキュメントに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/24426875/what-is-use-decl-annotations-meaning&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - what is &lt;em&gt;Use&lt;/em&gt;decl&lt;em&gt;annotations&lt;/em&gt; meaning - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/code-quality/annotating-function-behavior?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Annotating function behavior | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;しばらく調べたものの用途がわからなかったので、わかったら追記しようかと思います。&lt;/p&gt;
&lt;h3 id=&quot;irpの受け取り&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot; aria-label=&quot;irpの受け取り permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IRPの受け取り&lt;/h3&gt;
&lt;p&gt;IRPはアプリケーションからI/O要求が発生した場合に、I/Oマネージャによって作成される構造体です。&lt;/p&gt;
&lt;p&gt;IRPは非ページプールに割り当てされ、データのパケットとして受け渡されます。&lt;/p&gt;
&lt;p&gt;先にコードを見てみます。&lt;/p&gt;
&lt;p&gt;4章のドライバで行っていることはシンプルで、引数として受け取ったIRPの&lt;code class=&quot;language-text&quot;&gt;IoStatus&lt;/code&gt;の値を何やら書き換えた後、&lt;code class=&quot;language-text&quot;&gt;IoCompleteRequest&lt;/code&gt;に引き渡しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IRPは大きくIRPヘッダとスタックロケーションで構成されています。&lt;/p&gt;
&lt;p&gt;アプリケーションからの要求をI/Oマネージャが受け取った後、IRPを非ページプールメモリに割り当てます。&lt;/p&gt;
&lt;p&gt;その後、IRPヘッダとスタックロケーションを初期化してドライバのディスパッチルーチンを呼び出します。&lt;/p&gt;
&lt;p&gt;詳細な流れについては以下の記事が非常に参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sciencepark.co.jp/device_driver/dvdr/report-25/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバドラ講座25 │ サイエンスパーク株式会社&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoStatus&lt;/code&gt;はI/Oステータスブロックで、IRPが完了するとその完了状態が&lt;code class=&quot;language-text&quot;&gt;IoStatus.Status&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;また&lt;code class=&quot;language-text&quot;&gt;IoStatus.Information&lt;/code&gt;には読み書きされたバイト長が保持されます。&lt;/p&gt;
&lt;p&gt;ここでは何も読み書きをしていないので、&lt;code class=&quot;language-text&quot;&gt;IoStatus.Information&lt;/code&gt;は0を代入しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCompleteRequest&lt;/code&gt;マクロは、ディスパッチルーチンがI/O要求の処理をすべて完了し、IRPをI/Oマネージャに返却するためのマクロです。&lt;/p&gt;
&lt;p&gt;これでCREATEとCLOSEに対してサポートするディスパッチルーチンの定義は完了しました。&lt;/p&gt;
&lt;h3 id=&quot;デバイスコントロールのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;デバイスコントロールのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスコントロールのセットアップ&lt;/h3&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = SecondDriverDeviceControl;&lt;/code&gt;の行で設定しているデバイスコントロールルーチンのセットアップを行います。&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLは、ドライバとデータを受け渡す際に汎用的に使用可能なルーチンです。&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLは入力バッファ、出力バッファ、制御コードの3つを受け取る必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IRP&lt;em&gt;MJ&lt;/em&gt;DEVICE_CONTROL - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-i-o-control-codes&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Introduction to I/O Control Codes - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLには、以下のドキュメントに記載されている制御コードが渡され、操作が決定されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DeviceIoControl function (ioapiset.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;_Use_decl_annotations_
NTSTATUS &lt;span class=&quot;token function&quot;&gt;SecondDriverDeviceControl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDEVICE_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PIRP Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// get our IO_STACK_LOCATION&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoGetCurrentIrpStackLocation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;IoControlCode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_DEVICE_REQUEST&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;現在のスタックロケーションの取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;現在のスタックロケーションの取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;現在のスタックロケーションの取得&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoGetCurrentIrpStackLocation&lt;/code&gt;関数は、現在のスタックロケーションを取得できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoGetCurrentIrpStackLocation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;スタックロケーションは&lt;code class=&quot;language-text&quot;&gt;IO_STACK_LOCATION&lt;/code&gt;構造体で定義されています。&lt;/p&gt;
&lt;p&gt;ドライバはIRP内のスタックロケーションを利用してI/O操作に関するドライバ固有の情報を取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iogetcurrentirpstacklocation&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoGetCurrentIrpStackLocation function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;スタックロケーションには以下のような情報が含まれます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ドライバが実行するMajorFunctionsの情報&lt;/li&gt;
&lt;li&gt;ドライバが実行するMinorFunctionsの情報&lt;/li&gt;
&lt;li&gt;ドライバが転送するデータのバッファの長さや開始位置など&lt;/li&gt;
&lt;li&gt;ドライバーが作成したデバイスオブジェクトへのポインタ&lt;/li&gt;
&lt;li&gt;開いているファイル、デバイス、ディレクトリ、またはボリュームを表すファイルオブジェクトへのポインタ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/i-o-stack-locations&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O Stack Locations - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;要求された優先順位をスレッドに設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;要求された優先順位をスレッドに設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;要求された優先順位をスレッドに設定する&lt;/h3&gt;
&lt;p&gt;ここが今回作成するドライバの核になる実装です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;関数内で定義しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoGetCurrentIrpStackLocation&lt;/code&gt;関数で取得したスタックロケーションには、受け渡された制御コードなどの情報が含まれます。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;stack-&gt;Parameters.DeviceIoControl.IoControlCode&lt;/code&gt;内の情報を元に処理を分岐させています。&lt;/p&gt;
&lt;p&gt;ソースコードは以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// switch (stack-&gt;Parameters.DeviceIoControl.IoControlCode)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/code&gt;は以下ように定義しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token function&quot;&gt;CTL_CODE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SECOND_DRIVER_DEVICE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; METHOD_NEITHER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_ANY_ACCESS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;CTL_CODE&lt;/code&gt;マクロは、引数の情報を元に制御コードのオブジェクトを生成します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/d4drvif/nf-d4drvif-ctl_code&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CTL_CODE macro (d4drvif.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;受け渡された制御コードが&lt;code class=&quot;language-text&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/code&gt;の場合、処理を実行します。&lt;/p&gt;
&lt;p&gt;以下は入力値チェックを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は最終的にスレッドの優先順位を設定するため、受け渡されたバッファに&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;を格納する必要があります。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;stack-&gt;Parameters.DeviceIoControl.InputBufferLength&lt;/code&gt;のサイズの確認を行っています。&lt;/p&gt;
&lt;p&gt;サイズ確認後、&lt;code class=&quot;language-text&quot;&gt;(ThreadData*)stack-&gt;Parameters.DeviceIoControl.Type3InputBuffer&lt;/code&gt;にてスタックロケーションのバッファを&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;にキャストします。&lt;/p&gt;
&lt;p&gt;ヌルポインタになった場合はエラーを返します。&lt;/p&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;Priority&lt;/code&gt;の値が規定の範囲に収まっているかを確認します。&lt;/p&gt;
&lt;p&gt;受け渡されたデータのチェックが完了したら、&lt;code class=&quot;language-text&quot;&gt;KeSetPriorityThread&lt;/code&gt;関数でスレッドの優先順位を設定します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;KeSetPriorityThread&lt;/code&gt;関数は、第1引数に優先順位を設定するスレッドのポインタを受け取る必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetprioritythread&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;KeSetPriorityThread function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;関数を用いて、受け渡されたスレッドIDからスレッドオブジェクトのポインタを取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-pslookupthreadbythreadid&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PsLookupThreadByThreadId function (ntifs.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;ntifs.h&lt;/code&gt;をインクルードすることで使用可能です。&lt;/p&gt;
&lt;p&gt;コンパイルエラーを回避するため、&lt;code class=&quot;language-text&quot;&gt;ntifs.h&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;ntddk.h&lt;/code&gt;より前にインクルードする必要があります。&lt;/p&gt;
&lt;p&gt;コードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;優先順位をセットした後に&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;マクロを呼び出しています。&lt;/p&gt;
&lt;p&gt;このマクロは引数で受け取ったオブジェクトの参照カウントをデクリメントするマクロですが、用途がいまいちよくわかりませんでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obdereferenceobject&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ObDereferenceObject macro (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参照カウントとは、そのオブジェクトへの参照もしくはポインタがシステム内にいくつ存在しているかをカウントするもののようです。&lt;/p&gt;
&lt;p&gt;この参照カウントが0であれば、システム(たぶんGCなど)によって破棄することが許可されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E5%8F%82%E7%85%A7%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;参照カウント - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;による参照カウントのデクリメントを行うのは、システムのリークを防ぐためです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;は、受け取ったスレッドに対しての参照カウントをインクリメントします。&lt;/p&gt;
&lt;p&gt;そのため、終了時までに&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;によってデクリメントを行わないと参照カウントが増加したままになり、リークが発生します。&lt;/p&gt;
&lt;p&gt;これでカーネルドライバ側の実装を一通り追うことができました。&lt;/p&gt;
&lt;p&gt;クライアントの実装についてはこの記事では割愛します。&lt;/p&gt;
&lt;p&gt;詳しくやりたい方は&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;をご購入ください。&lt;/p&gt;
&lt;h2 id=&quot;ドライバのインストール&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot; aria-label=&quot;ドライバのインストール permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバのインストール&lt;/h2&gt;
&lt;p&gt;前の記事と同様の手順で、作成したドライバをシステムにインストールします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create second &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= C:\Driver\SecondDriver\SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; CreateService SUCCESS

$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; second
SERVICE_NAME: second
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; NOT_PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IGNORES_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 0
        FLAGS              :&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このあと&lt;code class=&quot;language-text&quot;&gt;WinObj&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;GLOBAL??&lt;/code&gt;を確認すると、作成した&lt;code class=&quot;language-text&quot;&gt;SecondDriver&lt;/code&gt;のシンボリックリンクが存在していることが確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACJUlEQVQ4y5WUCY+iQBCF+f9/bbJHdjMqKF4Icsh9CYpv69XYhtlsJtlOKqSb5utXr6qx4qxC29So6xpN06CqZN52mKYJ9/sdt9vty+A+Mx6PByw3OCMrY6TpBVmawfd9hOcQQRAgiuLXQX8HD87zAlmWKXgYBhEwweqrPdJ4h7rp9GUcxxoEt22L67VH13X/DL7fbDbY7/a4XC6q0hrbAIf1G4qyVZVU1IoCquUBZVliHEdVMA+ztt1uFfoC3roA3vYHmnbQE5nOcL0KLFelBNNLBj0y3hp/CfNPvqSfywEjrGmIsHPeEMWZwqgoFxjhxmgGAX3fq7L5muu6EhuEUaRz636VAhx+I0kKSbdCJcC6+ijEVZRSET+mmrIo9UCzRgAVLpdLJCble3/WlPO8ViBBVBGGkao0agjJ0lRTI4iDT8dxsFgsECfJsyidj6P7XWC9wGoURaEgFsb0mAHO4SbWzvpDYfJUOEiV/cMv5EUj/XeWlCR16bFIFLIPz7LGnqRqAzeDQHrItHMRosBpGjEOvU7YMpX4p+mwWcVDFoLxUvh8mmqzbdabNTKxQoGYDXY/of8zCKTKSKrMLCzji1HIBu26VuHzaORdnJVwjiHcIFUrPM+Dbds47Pd6W+i/NfeFFV6tVtjLBvoWhuGn8OWOv9sbfPv5Lqq2uo/A0+mkQlThHMj7aduO3JDkedk//224ryxyrGVPXTf6DVU6MveOngL/AA+cfmoXU3IpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/8ac56/image-21.webp 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/d3be9/image-21.webp 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/b0a15/image-21.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/8ff5a/image-21.png 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/e85cb/image-21.png 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ドライバがインストールできたので、クライアントアプリケーションを使ってスレッドの優先順位を設定してみます。&lt;/p&gt;
&lt;p&gt;今回は検証のためにメモ帳アプリのスレッドを操作することにしました。&lt;/p&gt;
&lt;p&gt;Proexpから、メモ帳のスレッドの優先順位が10に設定されていることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 554px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 115.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD/0lEQVQ4y51VWW8bVRSev4yExBu8wBu80AfUNwQPPLRpgUqJEzduHbUpjp3W9tgzXmbfN8/qNfb449wxCUGtIOLI13eZud/5zjrcelei2+5hePQU0vExgqkEfzKBrSowHBO+Z0BXJ3AsDas8Qeg5SFwHqa7DGA5hj0Zwx2N4kgTp8hLchgCHXR6jkxeQ6mcIoxlM14XregiCEJblwDJtFPMFFssV4iRBmuVI8wLbskRO5wHdYcQsIsKttzsIoym06w6mVy1kcYzRaAyTgNjFducaE0mG6/no80NMyAJBHKHVakNRNdi2g3a7A1UzYCsKOCeM0TlvYFKvQW82MScGyyLFfrMAsAUtaN4BJc3bJa33f+9vVof1dl2dK4MBuClpcS0Tq8WiYhfMErT1Ag0xRI33cdL38OK9hedXGl5PM/zWMfDsSkWNzpuij9MPOi7lBCN/BZ98yw2nUzJBhGXbiKIQUZLjlz8M/PjWwK/iAkd8jqNBgWc07tbDAk/7GX6o8fj+9w4eHffRGEWIAg+cTY4XKVKGYVAQAhR5TuyZqTf4LynJLdtljnI9J8tv4DjEUJRl6KaJzXaLxeoQxf2tp8r9v477sqMo2wxQljWofR4JMVxSJLM0w57e3dPf7bgvt/t/PKex3e0QMMCmIeIRsfwpmeHnOIJHDKsL+BjsU1KBVvaX6FgWuCfda3x20sXndQFfnAuwKI3uM3gIYLk/OOl8IIOT7BRvzmS06z4+NGeYRelfL+LBgKh+JaYimRyEFlrvFdQaFuqvTEqd7CMfPWSQzRgKZHIYBaidXuDJ8z5qZyrCMMX/lcHAoNKLU5y+fId6vYWLix4xjLHZbLBar7GlOmfr9XpDabEjv5fVXBQFZrMZzXPklLcRNYcVpZw4Ih8W8zmSNEaWJZSYFmIqP03TqXKcSmuWZXBovSYFaZpiSd0ljiKMqboC34dNOczzlHaUHTZVG+d5HhZUx4yJROnj096y7OqMCZtVRYVGNT+hvucQm3CxREyMdofWcCesfLlut1shM3MUaj8+aTVNi4D9O0BFUirAkvb56yaEL7+C8PU3CB4/hvXtd4jfvK3eHVMJc4wus58JA6yaKgGahkkmZpWPWLPNqTcyWVJFKWcvoTZeIe/1MWtdISFlTCaswfZ6PWJkVgcj0hCGYQXAfMv8tlwu4BFbBs5kQ5bofgjDDxCT6fczVSaXcYIgVIuIHM3YMsd/Slg3YsrZnFGJGvTNicMAlqGD7x/uVYCqqt5dEilyjCFzAfPd/cGizZQmSQrNnUFQbMh2BJfY6ppGaRRXFlYMbyPd7/crLS59pCwqdBas28F6HTtnLaotqGhc8XjHyxhLKq47HQiCWFn4J+DUtzkoTpmRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/87f9871280c443cd79688290c6f4679e/8ac56/image-22.webp 240w,
/static/87f9871280c443cd79688290c6f4679e/d3be9/image-22.webp 480w,
/static/87f9871280c443cd79688290c6f4679e/5e3e0/image-22.webp 554w&quot;
              sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/87f9871280c443cd79688290c6f4679e/8ff5a/image-22.png 240w,
/static/87f9871280c443cd79688290c6f4679e/e85cb/image-22.png 480w,
/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png 554w&quot;
            sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このスレッドを最大の優先順位である31に設定してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;C:\Driver\SecondDriverClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe 8616 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;アプリケーションの実行が完了すると、このようにメモ帳スレッドの優先順位が31に変更されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACGElEQVQ4y41UyW7aUBQ1IKGUn2EDUrpJJSS+gR3iY1inq4Ao/YAki+YbElA2CClpWiExKHbAE3gMNmCwOb3vpaG0JYErHb/B9x7f0cJYVWFbFkzT4PC8KVzHxrNtw3NdOKYJlyA1mlBub6E0mwgHAzBZr9fsgW0RGKFhWtB1HaqqQdNe1sdHkT5gQVYUqIoK8eYGo0YDw+trhP3+24TGZAKFjAzDICIVEzqPx2Mi1iBJEr9zyFtHeoIvy/BGI0QUESPbBUEnY0kUYZESIzUpPAZG3G630Wq1uPchDhMhCIK9Sp7ncS+Z7mI+R7BY8P2/WC6XEHxSYBLtcH+1WvF3366ucHLyCfl8HrlcDh+Pj5HNZjkymcxmTafTECxvtknwW4Rf6nUIgoBUKoVkMokPR0dIJBL87j9Mp/O9hLVabUMYi8U2xmz/emZrPB5nhH88/Eu2CM/OKtyIG+zyahu6PoZtO5ToAI7jwvd8eL4PjaqsU9W92Qynp58PJ5RHMhHaiMIIIjXzkPpMfxpC+vETJrUTogjVavVwQta4bDJ88kqVFd5v07t7dOtfoV1eAt0uar+LchAha+L5bM57yKHQ2dlynzGkEZzQLDOpVF5yyCrMqvsehBnlKKKwwjAk0gAyjZdJudNp9GQKn+3L5fJ+z17R6XQwoL9HnwaeQaS89bo9PHx/QK/X47N8fn6BQqGAUqmEYrH4Ln4Bvx1oDKTeWugAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/590aec4f72437db74fea11a1a8190b43/8ac56/image-23.webp 240w,
/static/590aec4f72437db74fea11a1a8190b43/d3be9/image-23.webp 480w,
/static/590aec4f72437db74fea11a1a8190b43/b0a15/image-23.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/590aec4f72437db74fea11a1a8190b43/8ff5a/image-23.png 240w,
/static/590aec4f72437db74fea11a1a8190b43/e85cb/image-23.png 480w,
/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png&quot;
            alt=&quot;image-23.png&quot;
            title=&quot;image-23.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルデバッグで挙動を確認してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;カーネルデバッグで挙動を確認してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルデバッグで挙動を確認してみる&lt;/h2&gt;
&lt;p&gt;さて、ここまでずいぶん時間がかかりましたが、ここからがようやく本題です。&lt;/p&gt;
&lt;p&gt;WinDbgからカーネルデバッグを行い、自作したカーネルドライバの動きを見てみたいと思います。&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については過去にも紹介したので割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;Windowsカーネルドライバを自作してWinDbgで解析してみる&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;ブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;とりあえずカーネルデバッグを仕掛けたあと、&lt;code class=&quot;language-text&quot;&gt;SecondDriver&lt;/code&gt;のモジュールがロードされていることを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; lmDvmSecondDriver
Browse full module list
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
fffff801`18390000 fffff801`18397000   SecondDriver   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
    Image path: \??\C:\Driver\SecondDriver\SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
    Image name: SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
    Browse all global symbols  functions  &lt;span class=&quot;token keyword&quot;&gt;data&lt;/span&gt;
    Timestamp:        Sat Jan 29 20:08:51 2022 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;61F52043&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    CheckSum:         0000EB8D
    ImageSize:        00007000
    Translations:     0000&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04b0 0000&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04e4 0409&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04b0 0409&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04e4
    Information &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; resource tables:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここまでソースコードを見てきた通り、クライアントからのIRPを受け取って実際に優先順位を変更する処理を行うのは&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;にブレークポイントを仕掛けた状態でクライアントアプリケーションによる優先順位変更を実施します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; bu SecondDriver!SecondDriverDeviceControl
kd&gt; bl
     0 e Disable Clear  fffff801`18391040  &lt;span class=&quot;token namespace&quot;&gt;[G:\Try2WinDbg\drivers\SecondDriverSample\SecondDriver\SecondDriver.cpp @ 18]&lt;/span&gt;     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; SecondDriver!SecondDriverDeviceControl&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;先ほど同様にメモ帳を起動して、メモ帳のスレッドの優先順位を31に変更するよう、クライアントアプリケーションから要求を実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;C:\Driver\SecondDriverClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe 8520 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;irpを解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;irpを解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IRPを解析する&lt;/h3&gt;
&lt;p&gt;今回はソースウィンドウも出してみました。&lt;/p&gt;
&lt;p&gt;ブレークポイントで処理が停止したときに、ソースコードのどの箇所かが一目でわかるのでとても便利です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 932px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 93.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADWUlEQVQ4y41U2W4jNxCcL88X5Cm/k7dkN8FaWh/yWrJkaWRJc5+c+55KNSUHxgIBQqDQlEg2q7qLY/z2p4Vf/3Dwy+8XfDmkyPIaQVrBTwp4cc55qRGqCm6UYbc/Y7lcYfW8RRSlOJ0uGmEYw/NCGGXdoO9auJYsHGEe32E5DmHD9Tw0XYdpnjW6foDKChwOJtYvG5zez3h+fsEPzo+cO44HIy0rVA0QRh1vVIhChboeMI7Q+DymaSaTDL7fEBUsK4XjKgRBA6VGVBVgxHEC33tC4P4F1/4bgX+HLH1ElhDxE/GIQq1QZU9oa5csIry9XWCaNvZ7h3MP+0OI4zGmwoAM8xx5WeB4NuH4O8Yf2JmPuNhbFLkPldioyhDjkGHoa9i2h91uj/3bHpuNidXqjO3WxcGM8W46MDLyrFtKDibSZhP8mBIiJLHSRW+a7oYeXdfrkvg+GxWwaV5L2YDtEDYon5LTokI/TsiLGn7swfIsJmLCJEYcxyiKAiUVSKx4uWO7ZLjF6+sL2Z2wWJZYr1t2vcXD9wFGkpcYpIvsgB/mtE3OwywDY5ZlbFCNYRhuGHE+W7TNEg8Pj7i7W2CxWLLr4g4Tr2vrynBkwqaemYAdZ8vTNGcsNaOczCSp/K5psTM9t1gscH9/r3H37RtL4FP6hTXcw1C3hG078U+RWbE2qWanVKalTtNEC31iqBN+J8t7fP36BevNhl038U4Pa4Yiue8GyixRsF5NU2tWIrssSjajY8IR3MbLAnZ1i836jdEkdpR8oG2OvOxyqyENOxNxUmvJZVlqZmma6jhLJsza2Emq4LoeLpecUlvuKWj2gF33eVl8TThxuxyMaHJJIrUTVh/NaNtW/xbbWJbD7q5o6h0lHmjmEy9wdR0Vzxox3+bAGhVFo51u0xZym1Lq1oxKo2kaHUWyR4ZhGPGF+Xoury1JrmQMy3K1gaMo4ULORAVvyrkh46FExywrNaT7tu3rr0qeV7rmAlmTfXHMhEVxtYNACi9RujnS7DLv+6vsru14WOqqdJQ9svYZNZ+cEYShlvIxxC5ibJEotRPLyOj7ns/S17Uef/4M3YZcYgw/LUoCYSSHrgfnf9ek2/M84b+G7DfyTOqlUFZXywiE+kcZPv77Pyjo6X8AsbaeA26Sb2AAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/821532881aff984b5d35308ef816777d/8ac56/image-24.webp 240w,
/static/821532881aff984b5d35308ef816777d/d3be9/image-24.webp 480w,
/static/821532881aff984b5d35308ef816777d/3b46e/image-24.webp 932w&quot;
              sizes=&quot;(max-width: 932px) 100vw, 932px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/821532881aff984b5d35308ef816777d/8ff5a/image-24.png 240w,
/static/821532881aff984b5d35308ef816777d/e85cb/image-24.png 480w,
/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png 932w&quot;
            sizes=&quot;(max-width: 932px) 100vw, 932px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png&quot;
            alt=&quot;image-24.png&quot;
            title=&quot;image-24.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ソースウィンドウは非常に便利で、ソースコードからブレークポイントをさらに設定することができます。&lt;/p&gt;
&lt;p&gt;今回はクライアントアプリケーションから受け取ったIRPの情報を確認したいので、スタックロケーションの取得が終わった次の行にブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 565px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnklEQVQ4y51SaWvcMBDd//9bCik0NNC0C0lp6UELSWC76+2uL61vr23Zsny/jrQHaUL6oQPDjEbS6L2nmaWej4hzuNYXuOZnBOw77M0nbI1b+O43VPkSNTcgyUWxAs+WkJWBkupNtUZdriD4iuISY59jlrAdwiJD4t/AMC5gsktsnUtYuyssrVfYum+wti9gOK/hs2v4zjVi7wM8ivtwjjy+0Z5Fc/SNj1lkOciaHsp+2ykebr/i/t0NFu8/4ufVHHfXt3ig/MfbOUIWo5IDOG9RVR1y3uCpzSLTRiJoYxrpkES0ceH/WsK9u4e/XMFbLBGu1gioVuUZmrZBXQu0jYSUAkJU2mvycRwxK0SNQraYpgmODYRJhyhNESQpGOlrMxfObocgjmFaFsliIAhDlGWJnB7gpL+KRVFgGKhhlhcIy5oQTvRSh5JeSnmCOI8R7gPUhKJrO/R9j77r0PU9XjIFapYXXCM8WcF7+JEHL2LYBQyWbSEIAnieB9/3Ke6wI8T7/R5JktBeiJQYRVGkIyHkB4Rk4zjRMwBjJVariHRq9SF1MSbKqolaq1wIoTVTrpANw6BdI0yEPDYcqdgec/yX6Yb5kbJ6ybQ5HNcjNDEJLeC6KSyLISFkGSEs8hxZliEMD1RThfrIQDHRDeNKnhtWJbBe29hsTLogsFiE2G4OusVxpLVkjCGmyyeaJ1cf9wwhMNA8gkQejiSUTofDyg+yDDq+SPkxwroeaGBrtK2kvKZc6vlSey2NTUMD3dBnqXrbtto7qv81Nll9Qgj6WfXLHhyHaX1M0zyOjU96unptbk2d19RU1lI3PzdUgx1wcSBHhWkaSLuRmkrKR01ToWiaRiNRKNW6H4ZnQ32mXDzScHhy8F82aQDTuZmKfwBc9sV5X3o0CgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/8ac56/image-25.webp 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/d3be9/image-25.webp 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/acb73/image-25.webp 565w&quot;
              sizes=&quot;(max-width: 565px) 100vw, 565px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/8ff5a/image-25.png 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/e85cb/image-25.png 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png 565w&quot;
            sizes=&quot;(max-width: 565px) 100vw, 565px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png&quot;
            alt=&quot;image-25.png&quot;
            title=&quot;image-25.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回は今までと趣向を変えて、GUI中心に解析をしてみようと思います。&lt;/p&gt;
&lt;p&gt;スタックロケーションの取得が終わった次の行に処理を進めた時点で、Localsウィンドウからスタックロケーションの情報を参照します。&lt;/p&gt;
&lt;p&gt;WinDbgのGUI上では、こんな感じで構造体の情報が整形されて確認できるようになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 899px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZUlEQVQoz3WQ/U6DMBTF9/5/G+O2zBgTE9/CxGzTJe4J/JoDyvimhQKDwrG9yIIzNjk0vYf76+md3G8Zrjcu5msLNy8eFhuG6WqPmdZ8bVP94uEN06U+P9lUm60sLJ77vqvlFy4fP3G79XG39TCppYAIXSjJYVZbCPCAoUgClGlIqniESvSCKnuhAfcZYtc69QKdBtYNbOYi4UIfAS4y1E37Y/eii4y6fjc1pT+v7x9w/YB8pU3VaaCUBRzHQS5zMsqyBOcceZ6jqiocj0eqKaX6S3TTIOYw2LaNtm1P3sQ07XY7uK6rjQ48TbG39ojimIBG50BKrCGMMXieB6FfJXPZA02SVEOGH7Msw8E7INZAKSWKoqD9HGj2IAgQhiHquiafgHGcIIoieqIpmISWZZ0uGWsMNACTMEkS6i306AjIhaAnDcsk8n2fEpq5mnQmddM0fxIOs/41w/Fh+Pm/dZ5yXB/0DZlCsRg+O4h1AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/8ac56/image-26.webp 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/d3be9/image-26.webp 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/8bcb7/image-26.webp 899w&quot;
              sizes=&quot;(max-width: 899px) 100vw, 899px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/8ff5a/image-26.png 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/e85cb/image-26.png 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png 899w&quot;
            sizes=&quot;(max-width: 899px) 100vw, 899px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png&quot;
            alt=&quot;image-26.png&quot;
            title=&quot;image-26.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションから受け渡しされた引数は、デバイスコントロールルーチンに渡されたIRPの入力バッファに格納されているのでした。&lt;/p&gt;
&lt;p&gt;入力バッファの参照先を確認すると&lt;code class=&quot;language-text&quot;&gt;0x1cefd9f6d8&lt;/code&gt;であることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 309px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQoz51Sa3OCMBDk//+6dqYqIEkgQVTeCFYewvYSi6XUT72ZnUnC3XK7d9bnrUVZXdDUNeI4Rl4UBhMeMU2TwfL8fX2+L8O6NFdIFSIIAgOfIKVEQ+/DMDwT18WvyAzhre2QpClCIlFKGTIpFVzHRVlWGMcR9/vdJM/nZYdrYmu+5nkGxgR8weExD77vQx0i2LaNlH6ooyhyCCFwH6eF/N92WPNDQYQ+JXPG4bp7yPAAxpnBHFVZGgVr6Uv8EGYZBBdQRKS91J2cz2cjc86pqhLbzQZMBAhVgOh4+uth13VUMOJ0OmG/38NxHXDOSeoOu52N6lKj7ztCjzRJqHvHKHh/f8PHZktWFTS8Hm3bQnNZNU2zIClKSdiOA+a5ROwaqXo4GRVosq7ryZacujricAiNGuZ5iJMUQ/8g1LCqujF+Sb0utD6aWPuUkgX/CSK8Gt886sqhVeE03SiKnmuyNn2JV9+/AHrb/uPrOEYXAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/8ac56/image-27.webp 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/451be/image-27.webp 309w&quot;
              sizes=&quot;(max-width: 309px) 100vw, 309px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/8ff5a/image-27.png 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png 309w&quot;
            sizes=&quot;(max-width: 309px) 100vw, 309px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png&quot;
            alt=&quot;image-27.png&quot;
            title=&quot;image-27.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;というわけで、メモリウィンドウから参照先のアドレスに格納されている値を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 403px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/321e106c693079f7889192779df1e18a/045fd/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADfklEQVQ4y1VUy44iNxTlW7LJcr4hi/xdlMVEihQpUTSfMYtITTfh2VBV1NvlerseUBQ0dAMzPZo5uXYBPUG6cvnaPj73nmN6TbNDXTUQeQXGQoQ8UfP9bo+oaPFhXOCvYY7f7zO8v8vwWz+DFjV4ftqj3Txh2/4/eqvVBq4fQWMCMzfFo1/AKQ4I6wM+Ohv8/DfHT38yvHvv4IdfTPz4q4U/hiWSeg8z28HJu7ApXEGAL8/PSFOBdrtD27bYPB0RiTXCtISoWxRFiSwrcDqdcf19+gK8fP6G42s3XmN//ore6+sXbLcHZElM5QZYbzYoqwpRnGC1brBqGmSiQEXfTbvF4eWI4+mE7W6HzXaLl+OR4oT94UD5cwfYtntM5xb+6U8xmtkYzyw8DHUMpzblPQxGSwzGMgz0/9XVqOYjg/Y6GD86t7F3otvqusFCd9AfzDCRi1PaPNQw0zxoywBz3YducugWx9xgKmdYIQw7VPNHWp/rjPb76B2JsgQ09AXu7/uIqXTOXFiWhaoq0TQrNdZ1iVVdqXG9qlGIHEJkKAuBshSoKGpa752o/hUBuo6D2WyGJM1UL13Xp16WJEpBuRRplpE4GQmYIs9zRFFMERGBhIBztU+I8g1Q1xbo9/vgYQzmuTAME7kQSOiA7/tgQYA47kAksMy5rgvOOQJa4xSO670BOraFyWSi1OWBD9t2kRGTuq4VqAxpoYoc0JDyEpiH9BAosixVzIvyu5KXBik3GCCkUgLmwTRttamkTTFdIkvMMiqNLLSiHgYBp5fFVEhQTm0KePgGaBPDMTGUPYzCgOaOYiPLkwckwyiOVNkxgYcXdh0YV6PvszdA01xiOBophsx3MZ8vqOQMOQHKA4L6eRXkmpO9C0NOF0RKOHn2BmjoGtnmnpIJwoBhsdCUsvJwFEYXNpEqWxCoLFWJxXz1Hcn17wFdh17FdEY2SGmRE2MLgqxQlqUSIKG8LL+45TrFVRCYZBkQazJ2B6gt5ri7u1ON9Vwbo/FEbUhIEIc86nnehREj0ZiaS9t4ZLFu9GBR32+Ajm1jMp3eGC6XJv0p5IqNEoJC9kmy7Ix9aUPUCSPnLLgwlE/PXHa2kT6UPdQ1Q5WcU8+kAFfPKWBSnLHgZhvFms4oY5/Pn7Bet0qUh4cHdYvvOdA0nRglShRpB/9ykNO6BL2Kcg05l4D/AZt2VHCOZCKvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/321e106c693079f7889192779df1e18a/8ac56/image-28.webp 240w,
/static/321e106c693079f7889192779df1e18a/ca1b5/image-28.webp 403w&quot;
              sizes=&quot;(max-width: 403px) 100vw, 403px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/321e106c693079f7889192779df1e18a/8ff5a/image-28.png 240w,
/static/321e106c693079f7889192779df1e18a/045fd/image-28.png 403w&quot;
            sizes=&quot;(max-width: 403px) 100vw, 403px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/321e106c693079f7889192779df1e18a/045fd/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;クライアントアプリケーションでは、受け取った引数は以下のように&lt;code class=&quot;language-text&quot;&gt;atoi&lt;/code&gt;関数で数値化され、ドライバルーチンに渡されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ThreadId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;C++の&lt;code class=&quot;language-text&quot;&gt;atoi&lt;/code&gt;関数は文字列を4バイトの&lt;code class=&quot;language-text&quot;&gt;int&lt;/code&gt;型の数値に変換します。&lt;/p&gt;
&lt;p&gt;そのため、メモリに格納されているデータも4バイト単位のリトルエンディアン形式で読むのがよさそうです。&lt;/p&gt;
&lt;p&gt;上記より、入力バッファの参照先のメモリに保存されている値は、以下の通りクライアントアプリケーションに与えた引数と一致していることがわかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0x2148 = 8520
0x1F = 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;WinDbgを使うと、カーネルドライバに渡されたIRPの情報も簡単に参照できるので非常に便利ですね。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;さて、これで最低限の機能をそろえたカーネルドライバの実装と、デバッグによるIRPの解析に入門することができました。&lt;/p&gt;
&lt;p&gt;まだまだ先は長いですが、引き続きカーネルプログラミングとデバッグは続けていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ページテーブル(PDT/PTD) 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-005-kernel-main-02</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-005-kernel-main-02</guid><pubDate>Wed, 26 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で初めに実行される&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数による排他制御周りの挙動を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるxv6カーネルのページテーブルの初期化を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;32bitページングについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#pdt%E3%81%A8pt&quot;&gt;PDTとPT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C&quot;&gt;仮想アドレスから物理アドレスを参照する流れ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#kvmalloc%E9%96%A2%E6%95%B0&quot;&gt;kvmalloc関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;仮想メモリについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#setupkvm%E9%96%A2%E6%95%B0&quot;&gt;setupkvm関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D&quot;&gt;kalloc関数によるページの確保&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;仮想アドレスのPTEの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#freevm%E9%96%A2%E6%95%B0&quot;&gt;freevm関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#switchkvm%E9%96%A2%E6%95%B0&quot;&gt;switchkvm関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;32bitページングについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;32bitページングについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;32bitページングについて&lt;/h2&gt;
&lt;p&gt;今回はxv6OSの&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数から読んでいきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数はカーネルのページテーブルを作成する関数です。&lt;/p&gt;
&lt;p&gt;そのため、ソースコードを読む前に、32bit環境でのページング機構について整理しておきます。&lt;/p&gt;
&lt;p&gt;ページング機構はMMU(Memory Management Unit)によって実装されます。&lt;/p&gt;
&lt;p&gt;x86環境では、MMUはPD(ページングディレクトリ)とPT(ページングテーブル)を利用してメモリマップを行います。&lt;/p&gt;
&lt;h3 id=&quot;pdtとpt&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pdt%E3%81%A8pt&quot; aria-label=&quot;pdtとpt permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PDTとPT&lt;/h3&gt;
&lt;p&gt;PDTとPTにはそれぞれPDE(ページディレクトリエントリ)とPTE(ページテーブルエントリ)が含まれます。&lt;/p&gt;
&lt;p&gt;PDEとPTEはどちらも1つ当たり4バイト(32bit)のサイズであり、PDにはPDEが、PTにはPTEが、それぞれ1024個含まれます。&lt;/p&gt;
&lt;p&gt;これによってPDEとPTEはどちらも4KiBのサイズ(x86におけるデフォルトの1ページ分)になります。&lt;/p&gt;
&lt;p&gt;各エントリの詳細については以下のリンク先が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Paging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Paging - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;仮想アドレスから物理アドレスを参照する流れ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C&quot; aria-label=&quot;仮想アドレスから物理アドレスを参照する流れ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想アドレスから物理アドレスを参照する流れ&lt;/h3&gt;
&lt;p&gt;仮想アドレスを物理アドレスに変換する際、仮想アドレスは以下の3つに分割されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;最上位10bit：PDEのインデックス&lt;/li&gt;
&lt;li&gt;次の10bit：PTEのインデックス&lt;/li&gt;
&lt;li&gt;最下位12bit：ページオフセット&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;アドレス変換の際、MMUはPDを参照して仮想アドレスのインデックスからPDEを特定します。&lt;/p&gt;
&lt;p&gt;次にPDEの情報と、仮想アドレスのインデックスからPTEを特定します。&lt;/p&gt;
&lt;p&gt;PTEは物理アドレスのベースアドレスを解決するため、仮想アドレスのオフセットと合わせて参照先の物理アドレスを特定することができます。&lt;/p&gt;
&lt;p&gt;詳細な流れは以下の図がわかりやすかったため引用しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.24999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHtXcgqv//EABgQAAMBAQAAAAAAAAAAAAAAAAABEQIQ/9oACAEBAAEFAuZdUIJQ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bp//EABgQAAIDAAAAAAAAAAAAAAAAAAABIDFB/9oACAEBAAY/AtLcf//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IafR9iUblBuGIeZ21gCif//aAAwDAQACAAMAAAAQPM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QVs//xAAaEAEBAQEBAQEAAAAAAAAAAAABEQAhMUFR/9oACAEBAAE/EAxtvyOZEYOrTdYgZ7vBDP0wR6B5F0AQ3//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/8ac56/zu04.webp 240w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/d3be9/zu04.webp 480w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/b0a15/zu04.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/09b79/zu04.jpg 240w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/7cc5e/zu04.jpg 480w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/jpeg&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参照画像：&lt;a href=&quot;https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PDは単なるPDEの配列形式になっています。&lt;/p&gt;
&lt;p&gt;PDの先頭アドレスはCR3レジスタに格納されています。&lt;/p&gt;
&lt;h2 id=&quot;kvmalloc関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kvmalloc%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kvmalloc関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kvmalloc関数&lt;/h2&gt;
&lt;p&gt;さて、&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;に引き続きカーネルの&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の処理を追っていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Bootstrap processor starts running C code here.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Allocate a real stack and switch to it, first&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// doing some setup required for memory allocator to work.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// phys page allocator&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// kernel page table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// detect other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disable pic&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// another interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// console hardware&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// serial port&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// process table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;tvinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// trap vectors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;binit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// buffer cache&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;fileinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// file table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ideinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disk &lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// start other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;userinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// first user process&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// finish this processor&apos;s setup&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数が終了するところまで進めたので、今回は&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数から見ていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one page table for the machine for the kernel address&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// space for scheduler processes.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  kpgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数はカーネルのページテーブルを変更します。&lt;/p&gt;
&lt;p&gt;ここで、カーネルがプロセスのアドレス空間を管理するための設計を持ったページテーブルに切り替えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.30 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、xv6OSではプロセスごとに1つのページテーブルが作成され、プロセスの実行時にはカーネルは現在のプロセスのページテーブルを使用します。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;kpgdir&lt;/code&gt;というCPUが実行していないプロセスを管理するページテーブルが用意されています。&lt;/p&gt;
&lt;h3 id=&quot;仮想メモリについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;仮想メモリについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想メモリについて&lt;/h3&gt;
&lt;p&gt;xv6OSだけでなく、WindowsやLinuxなどの32bitOS(x86アーキテクチャ)では、プロセスごとに仮想メモリというプライベートなメモリ空間が割り当てられます。&lt;/p&gt;
&lt;p&gt;各プロセスごとの仮想アドレス空間は独立しているため、それぞれが任意のアドレスから2GiB分の仮想アドレスを指定してメモリアクセスを行うことができます。&lt;/p&gt;
&lt;p&gt;(プロセス側があるアドレスの参照を行ったときに、実際に物理メモリのどのアドレスを参照することになるかは、カーネル側で管理します。)&lt;/p&gt;
&lt;p&gt;この仕組みによって、ページングを行っていてもプロセスは常に仮想アドレスに対してメモリアクセスを行うことができるため、アプリケーション側は物理メモリのアドレス変更を考慮することなく開発することができます。&lt;/p&gt;
&lt;p&gt;また、32bitOSは最大4GiBまでのアドレス空間しか管理することができません。&lt;/p&gt;
&lt;p&gt;しかし、プロセスごとに仮想アドレス空間を作成しページングの仕組みを利用することで、実際よりも大きなメモリ空間を利用してシステムを動かすことができるようになります。&lt;/p&gt;
&lt;p&gt;そのほかにも、プロセス間でメモリ空間が独立していることによってメモリの競合を防いだりやアクセス制御を行ったりすることもできます。&lt;/p&gt;
&lt;p&gt;ちなみに、なぜ32bitOSの扱うことができるアドレス空間が最大4GiBなのに、仮想アドレス空間は2GiBなのかというと、上位2GiBはカーネルに予約されているためのようです。&lt;/p&gt;
&lt;p&gt;詳しくは以下の図が参考になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20.webp 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20.webp 454w&quot;
              sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20.png 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png 454w&quot;
            sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.31 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;setupkvm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#setupkvm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;setupkvm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;setupkvm関数&lt;/h3&gt;
&lt;p&gt;とりあえず&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数の処理を追ってみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kpgdir = setupkvm();&lt;/code&gt;の行では、&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数の戻り値を&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;kpgdir&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;型は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下のように定義されており、&lt;code class=&quot;language-text&quot;&gt;uint&lt;/code&gt;型であることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; uint &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Set up kernel part of a page table.&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;PHYSTOP too high&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まずは変数宣言の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;は前述の通り&lt;code class=&quot;language-text&quot;&gt;uint&lt;/code&gt;と同義です。&lt;/p&gt;
&lt;p&gt;次の&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義されているカーネルのメモリマッピングテーブルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// This table defines the kernel&apos;s mappings, which are present in&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// every process&apos;s page table.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phys_start&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phys_end&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; perm&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;             EXTMEM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// I/O space&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNLINK&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;KERNLINK&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// kern text+rodata&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;   PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// kern data+memory&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;         PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// more devices&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;開始・終了アドレスと権限が定義されています。&lt;/p&gt;
&lt;p&gt;初期化されているテーブルのマッピングは、先ほど貼った以下の画像のレイアウトと一致します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20-16455945916397.webp 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20-16455945916397.webp 454w&quot;
              sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20-16455945916397.png 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png 454w&quot;
            sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.31 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;kalloc関数によるページの確保&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D&quot; aria-label=&quot;kalloc関数によるページの確保 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kalloc関数によるページの確保&lt;/h3&gt;
&lt;p&gt;ページテーブルの初期化後、使用するメモリ領域の確認と初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;PHYSTOP too high&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one 4096-byte page of physical memory.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Returns a pointer that the kernel can use.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Returns 0 if the memory cannot be allocated.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;の記事で確認した通り、この時点ではまだロックは無効化されています。&lt;/p&gt;
&lt;p&gt;そのため&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数は無視します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem.freelist&lt;/code&gt;には、解放されているページが短方向連結リストで格納されています。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は単に解放されている領域の有無を確認して、1ページ分の領域を確保している処理を行っているようです。&lt;/p&gt;
&lt;p&gt;確保に成功した場合&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は確保したページのポインタ(?)を返却し、&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;に格納します。&lt;/p&gt;
&lt;p&gt;これによって、次の行の&lt;code class=&quot;language-text&quot;&gt;memset(pgdir, 0, PGSIZE);&lt;/code&gt;で確保した1ページ分のメモリ領域を0で初期化することができます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の挙動も&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;の記事で確認したので割愛します。&lt;/p&gt;
&lt;p&gt;最後の行は&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;の値が&lt;code class=&quot;language-text&quot;&gt;DEVSPACE&lt;/code&gt;を超過していないかを検証しているだけなので割愛します。&lt;/p&gt;
&lt;p&gt;最終的に確保された1ページ分の領域&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;が、この後PDTとして使用されます。&lt;/p&gt;
&lt;h3 id=&quot;仮想アドレスのpteの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;仮想アドレスのpteの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想アドレスのPTEの作成&lt;/h3&gt;
&lt;p&gt;ここまでの処理で&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;には確保した1ページ分のメモリ領域の参照が格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;NELEM&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;defs.h&lt;/code&gt;で定義された以下のマクロで、固定サイズの配列の要素数を返却します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// number of elements in fixed-size array&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;k = kmap; k &amp;lt; &amp;amp;kmap[NELEM(kmap)]; k++&lt;/code&gt;のループ条件は単にすべての&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;配列の要素に対して処理を実行せよという命令と同義です。&lt;/p&gt;
&lt;p&gt;ここで肝になるのが以下の行です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数で、 引数として与えられた仮想アドレスのPTE(ページテーブルエントリ)を作成し、同じく引数として与えられた物理アドレスを参照します。&lt;/p&gt;
&lt;p&gt;PTEはページに対応する物理アドレスの値とアクセス制御や属性に関する情報を保持します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 40.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABtiAP/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAQABBQJzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAAAAQMf/aAAgBAQAGPwJU/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERMUFx/9oACAEBAAE/IWkvWdD/2gAMAwEAAgADAAAAEIvv/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8Qqv/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/EIj/xAAaEAEAAgMBAAAAAAAAAAAAAAABABExUXGR/9oACAEBAAE/EEWU4wKHtcHtn//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cea566737a194af6446f300861a595e8/8ac56/zu03b.webp 240w,
/static/cea566737a194af6446f300861a595e8/d3be9/zu03b.webp 480w,
/static/cea566737a194af6446f300861a595e8/b0a15/zu03b.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cea566737a194af6446f300861a595e8/09b79/zu03b.jpg 240w,
/static/cea566737a194af6446f300861a595e8/7cc5e/zu03b.jpg 480w,
/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/jpeg&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://softwaretechnique.web.fc2.com/OS_Development/kernel_development07.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;０から作るOS開発　ページングその１　ページとPTEとPDE&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずはソースコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Create PTEs for virtual addresses starting at va that refer to&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// physical addresses starting at pa. va and size might not&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// be page-aligned.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;last&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  last &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; size &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;は以下の5つの引数を受け取ります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;*pgdir：確保したページ(PDT)&lt;/li&gt;
&lt;li&gt;*va：PTEを作成する仮想アドレス&lt;/li&gt;
&lt;li&gt;size：紐づける物理アドレス領域のサイズ&lt;/li&gt;
&lt;li&gt;pa：紐づける物理アドレスの先頭アドレス&lt;/li&gt;
&lt;li&gt;perm：割り当てる権限&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;まず、PTEを作成する仮想アドレスと紐づける物理アドレス領域のサイズをもとにしてページサイズでアラインメントされたアドレスが&lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;last&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;p&gt;アラインメントに使用する&lt;code class=&quot;language-text&quot;&gt;PGROUNDDOWN&lt;/code&gt;については過去の記事で解説済みのため割愛します。&lt;/p&gt;
&lt;p&gt;次のループはこの&lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;last&lt;/code&gt;と一致するまでページサイズを加算しつつ実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際にPTEの領域を確保しているのは&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;引数として受け取ったページテーブル&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;のPTEのアドレスを返します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Return the address of the PTE in page table pgdir&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// that corresponds to virtual address va.  If alloc!=0,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// create any required page table pages.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; 
&lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; alloc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PDX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTE_ADDR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;alloc &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Make sure all those PTE_P bits are zero.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// The permissions here are overly generous, but they can&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// be further restricted by the permissions in the page table&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// entries, if necessary.&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_U&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;pde = &amp;amp;pgdir[PDX(va)];&lt;/code&gt;の行ではPDTとして確保しているページのうち、PTEを格納するインデックスを解決しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PDX(va)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定義されているマクロで、仮想アドレスから&lt;code class=&quot;language-text&quot;&gt;page directory index&lt;/code&gt;を解決しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// A virtual address &apos;la&apos; has a three-part structure as follows:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// +--------10------+-------10-------+---------12----------+&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// | Page Directory |   Page Table   | Offset within Page  |&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// |      Index     |      Index     |                     |&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// +----------------+----------------+---------------------+&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  \--- PDX(va) --/ \--- PTX(va) --/&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// page directory index&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PDX&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; PDXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// page table index&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; PTXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PTXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PTX in a linear address&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PDXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PDX in a linear address&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;if(*pde &amp;amp; PTE_P)&lt;/code&gt;の行では、取得したPDEのPresentビットを確認します。&lt;/p&gt;
&lt;p&gt;PDEのPresentビットはページが現在物理メモリにあるのか仮想メモリにあるのかを特定するために使用します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Paging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Paging - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、引数として受け取った仮想アドレスのPDEの有無を検証しているようです。&lt;/p&gt;
&lt;p&gt;初期状態では、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数によってPDは0に初期化されているため、以下の処理が呼び出されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;alloc &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Make sure all those PTE_P bits are zero.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// The permissions here are overly generous, but they can&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// be further restricted by the permissions in the page table&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// entries, if necessary.&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_U&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第3引数の&lt;code class=&quot;language-text&quot;&gt;alloc&lt;/code&gt;が1に設定されており、かつ仮想アドレスに対応するPDEが存在しない場合、ここで必要なPTが作成されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数の挙動は先ほども確認したので割愛します。&lt;/p&gt;
&lt;p&gt;ここで取得された1ページ分の領域は&lt;code class=&quot;language-text&quot;&gt;pgtab&lt;/code&gt;として参照されます。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;によってすべてのバイトが0に初期化されます。&lt;/p&gt;
&lt;p&gt;そして、PDEには物理アドレスに変換された&lt;code class=&quot;language-text&quot;&gt;pgtab&lt;/code&gt;のアドレスと、PDEに設定される権限が与えられます。&lt;/p&gt;
&lt;p&gt;最終的に&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数の戻り値としては、引数で受け取った仮想アドレスに対応するPDEから解決されるPDTの参照となります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;さて、&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数が終了したので&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数に戻ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pte&lt;/code&gt;にはこの仮想アドレスに対応するPTEの領域が確保されました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数が実行された段階ではまだPTEはすべて0で初期化されたままですので、&lt;code class=&quot;language-text&quot;&gt;*pte = pa | perm | PTE_P;&lt;/code&gt;の行で物理アドレスとパーミッションの割り当てを行っています。&lt;/p&gt;
&lt;p&gt;これで、&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数によって仮想アドレスと物理アドレスを紐づけるPTEの作成が完了しました。&lt;/p&gt;
&lt;h3 id=&quot;freevm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#freevm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;freevm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;freevm関数&lt;/h3&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数に戻ります。&lt;/p&gt;
&lt;p&gt;以下のループは&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;配列の要素の数だけ繰り返されていました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数によって、仮想アドレスと物理アドレスを紐づけるPDEとPTEが作成されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もしページテーブルの作成に失敗した場合、&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数の引数にここまで使用してきたPDTのページ&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;が与えられメモリ領域が解放されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数も&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数この時点では実行されないため、詳細は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Free a page table and all the physical memory pages&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// in the user part.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;freevm: no pgdir&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;deallocuvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NPDENTRIES&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTE_ADDR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;switchkvm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#switchkvm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;switchkvm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;switchkvm関数&lt;/h2&gt;
&lt;p&gt;ここまでで&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数の処理は終了し、戻り値としてカーネルのPDTが返却されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one page table for the machine for the kernel address&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// space for scheduler processes.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  kpgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この記事の前半で確認した通り、カーネルの参照するPDTの先頭アドレスは、x86ではCR3レジスタに格納されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;switchkvm&lt;/code&gt;関数の挙動はシンプルで、CR3レジスタに作成したPDTの仮想アドレスを物理アドレスに変換して格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Switch h/w page table register to the kernel-only page table,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// for when no process is running.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lcr3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kpgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// switch to the kernel page table&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lcr3&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;に定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lcr3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint val&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;movl %0,%%cr3&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;r&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;val&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるカーネルのページテーブルの作成と切り替えが完了しました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;これでxv6カーネルの&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で呼び出している18個の関数のうち、3つのソースコードを読みました。&lt;/p&gt;
&lt;p&gt;まだまだ先は長いですが少しずつ進めていきます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -メモリ割り当て・排他制御 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-004-kernel-main-01</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-004-kernel-main-01</guid><pubDate>Tue, 25 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;まででxv6OSのビルドと起動プロセスまで読み進めました。&lt;/p&gt;
&lt;p&gt;いよいよカーネルを読み進めていきます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;から読んでいきます。&lt;/p&gt;
&lt;p&gt;基本的にはCのソースコードを読みつつ、必要に応じて&lt;code class=&quot;language-text&quot;&gt;kernel.asm&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kernel.sym&lt;/code&gt;を参照してgdbデバッグを行う流れで処理を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0&quot;&gt;main関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0&quot;&gt;kinit1関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0%E3%81%AE%E5%BC%95%E6%95%B0&quot;&gt;kinit1関数の引数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#initlock%E9%96%A2%E6%95%B0&quot;&gt;initlock関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#freerange%E9%96%A2%E6%95%B0&quot;&gt;freerange関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kfree%E9%96%A2%E6%95%B0&quot;&gt;kfree関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kinit2%E9%96%A2%E6%95%B0&quot;&gt;kinit2関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#xv6%E3%81%AE%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;xv6のロックについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#acquire%E9%96%A2%E6%95%B0&quot;&gt;acquire関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#release%E9%96%A2%E6%95%B0&quot;&gt;release関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7panic%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;おまけ：デバッガでpanic関数を呼び出してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91memset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;おまけ：memsetについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;main関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0&quot; aria-label=&quot;main関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main関数&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;の記事では、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;のmain関数を呼び出すところまで見ていきました。&lt;/p&gt;
&lt;p&gt;ここからは、カーネル本体の動きを見ていきます。&lt;/p&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の中からmain関数の行のみを抜粋しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;__attribute__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;noreturn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;kpgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; end&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// first address after kernel loaded from ELF file&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Bootstrap processor starts running C code here.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Allocate a real stack and switch to it, first&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// doing some setup required for memory allocator to work.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// phys page allocator&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// kernel page table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// detect other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disable pic&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// another interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// console hardware&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// serial port&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// process table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;tvinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// trap vectors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;binit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// buffer cache&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;fileinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// file table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ideinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disk &lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// start other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;userinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// first user process&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// finish this processor&apos;s setup&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数がずらっと並んでおり、上から順に実行されています。&lt;/p&gt;
&lt;p&gt;この記事では、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数について見ていきます。&lt;/p&gt;
&lt;h2 id=&quot;kinit1関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kinit1関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit1関数&lt;/h2&gt;
&lt;p&gt;最初に実行されるkinit1関数は、&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている関数です。&lt;/p&gt;
&lt;p&gt;xv6カーネルは&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;を呼び出してメモリアロケータの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Initialization happens in two phases.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 1. main() calls kinit1() while still using entrypgdir to place just&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// the pages mapped by entrypgdir on free list.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 2. main() calls kinit2() with the rest of the physical pages&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// after installing a full page table that maps them on all cores.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;kmem&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーネルは実行時に、ページテーブルやプロセス、ユーザメモリ、カーネルスタック、パイプバッファなどのために物理メモリ領域を割り当てて解放しておく必要があります。&lt;/p&gt;
&lt;p&gt;xv6OSの場合は、カーネル本体が格納されるアドレスの末尾から&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;までの物理メモリが割り当て領域として使用されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;にて以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;EXTMEM&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;            &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Start of extended memory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PHYSTOP&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xE000000&lt;/span&gt;           &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Top physical memory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DEVSPACE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xFE000000&lt;/span&gt;         &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Other devices are at high addresses&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このメモリ領域の割り当てと解放はページ単位で行われます。&lt;/p&gt;
&lt;p&gt;カーネルは、解放されたページを連結リスト型で保持しており、割り当て時にはリストからそのページを削除する動きになります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 - DRAFT as of September 4, 2018 P32-33&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-24/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリ管理、アドレス空間、ページテーブル&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;kinit1関数の引数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0%E3%81%AE%E5%BC%95%E6%95%B0&quot; aria-label=&quot;kinit1関数の引数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit1関数の引数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;では、引数として受け取ったカーネルのendアドレスから4MiBまでの領域を「ロックなし」で使用できるようにするためのアロケータの初期化を行います。&lt;/p&gt;
&lt;p&gt;ここから&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数が呼び出されるまでは、カーネル末尾から4MiB分のアドレスをロックなしで割り当てられるようにした状態で稼働します。&lt;/p&gt;
&lt;p&gt;これは、&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数内で呼び出されている処理の大部分ではロックや4MiB以上のメモリ領域を使用することができないからであるようです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数の引数には、&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;が与えられています。&lt;/p&gt;
&lt;p&gt;まず第1引数の&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;に該当する引数ですが、これは&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で宣言されている以下の変数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;extern&lt;/code&gt;宣言がされており、&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;PROVIDE(end = .);&lt;/code&gt;を取得しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; end&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// first address after kernel loaded from ELF file&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;P2V(4*1024*1024)&lt;/code&gt;が与えられています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;P2V&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;で定義されたマクロで物理アドレスを仮想アドレスに変換する(=単純にKERNBASEを加算する)だけのマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;呼び出し時には&lt;code class=&quot;language-text&quot;&gt;4*1024*1024&lt;/code&gt;(=4MiB)にKERNBASEを加算した&lt;code class=&quot;language-text&quot;&gt;0x80400000&lt;/code&gt;が与えられます。&lt;/p&gt;
&lt;p&gt;実際に&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;呼び出し時の引数をgdbで確認したところ次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;kinit1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;0x801154a8, &lt;span class=&quot;token assign-left variable&quot;&gt;vend&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;0x80400000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;順番が前後しますが、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;ではこの2つの値を&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数の引数として与えてメモリ領域の確保を行います。&lt;/p&gt;
&lt;p&gt;ソースコードを上から順に見ていきたいので、先に&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数を確認します。&lt;/p&gt;
&lt;h3 id=&quot;initlock関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#initlock%E9%96%A2%E6%95%B0&quot; aria-label=&quot;initlock関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;initlock関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義された関数で、&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;構造体内の&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の初期化を行う関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; use_lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;spinlock.h&lt;/code&gt;で定義された以下の構造体です。&lt;/p&gt;
&lt;p&gt;コメントには排他制御と書かれており、ロックを行う際に使用しているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mutual exclusion lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint locked&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Is the lock held?&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// For debugging:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Name of lock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// The cpu holding the lock.&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// The call stack (an array of program counters)&lt;/span&gt;
                     &lt;span class=&quot;token comment&quot;&gt;// that locked the lock.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数では、この&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体のポインタと名前の文字列を受けとって初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;からこの関数を呼び出す際には、「kmem」という名前で初期化を行っていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;kmem&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の行では&lt;code class=&quot;language-text&quot;&gt;use_lock&lt;/code&gt;の値も0に初期化しています。&lt;/p&gt;
&lt;p&gt;ここではロックを無効化しています。&lt;/p&gt;
&lt;p&gt;しばらく後に呼び出される&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;では、&lt;code class=&quot;language-text&quot;&gt;kmem.use_lock&lt;/code&gt;が1に設定されます。&lt;/p&gt;
&lt;p&gt;また、実際にここでは、単に&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;の初期化を行ったのみでロックは行われていません。&lt;/p&gt;
&lt;p&gt;ここで初期化した構造体を利用してロックを行うためには、&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義されている&lt;code class=&quot;language-text&quot;&gt;void acquire(struct spinlock *lk)&lt;/code&gt;関数を呼び出す必要があります。&lt;/p&gt;
&lt;p&gt;この関数については実際に使用するときに確認します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2017/homework/xv6-lock.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Homework: xv6 locking&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;freerange関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#freerange%E9%96%A2%E6%95%B0&quot; aria-label=&quot;freerange関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;freerange関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている関数で、&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;を引数にとり、&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;を使用してアラインメントされた物理アドレス領域を解放する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Page directory and page table constants.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPDENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # directory entries per page directory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPTENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # PTEs per page table&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PGSIZE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// bytes mapped by a page&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PTXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PTX in a linear address&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PDXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PDX in a linear address&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;は引数として受け取ったアドレスを&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;の倍数にアラインメントするマクロです。&lt;/p&gt;
&lt;p&gt;これによって、引数&lt;code class=&quot;language-text&quot;&gt;sz&lt;/code&gt;以上の最小の&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;の倍数が返されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Bitwise NOT&lt;/code&gt;演算子です。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;(PGSIZE-1)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;に対する最大の余りになるため、これを加算した上でbit反転した&lt;code class=&quot;language-text&quot;&gt;(pgsize-1)&lt;/code&gt;とのANDを取ることで、&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;未満の端数を切り捨ててアラインメントすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/43289022/what-do-pgroundup-and-pgrounddown-in-xv6-mean&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What do PGROUNDUP and PGROUNDDOWN in xv6 mean? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;計算がちょっとわかりづらかったので、リバーシングしたPythonスクリプトを作成しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rev_PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;***************rev_PGROUNDUP***************&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    pgsize &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
    num1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    num2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; num1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; num2
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pgsize               : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pgsize[bin]          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;(sz)+(pgsize-1)      : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;(sz)+(pgsize-1)[bin] : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;~(pgsize-1)          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;~(pgsize-1)[bin]     : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;result               : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;result[bin]          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを実行すると以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;rev_PGROUNDUP&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
***************rev_PGROUNDUP***************
pgsize               &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
pgsize&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000000000000
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;+&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4195&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;+&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000001100011
~&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; -4096
~&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; -0b1000000000000
result               &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
result&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000000000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sz&lt;/code&gt;として100が入力された場合は、アラインメントされて切り上げされた結果4096が戻り値となります。&lt;/p&gt;
&lt;p&gt;話を&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数に戻します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;の引数には&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;が与えられており、戻り値が&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされたアドレスとなります。&lt;/p&gt;
&lt;p&gt;ここから&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;のアドレスに到達するまで、&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;ごと(ページごと)に&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数によって物理アドレスが解放され、ページリストの初期化が行われます。&lt;/p&gt;
&lt;h3 id=&quot;kfree関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kfree%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kfree関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kfree関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数はメモリの解放を行い、ページリストに解放したページを追加する関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;引数には解放するページの開始アドレスを使用します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数から呼び出される場合、引数に与えられる値は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされたアドレスになるため、4096バイト境界にアラインメントされていることが保証されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK: 21&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Free the page of physical memory pointed at by v,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// which normally should have been returned by a&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// call to kalloc().  (The exception is when&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// initializing the allocator; see kinit above.)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; end &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kfree&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Fill with junk to catch dangling refs.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数が呼び出されると、&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体の宣言を行っています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されており、参照先の&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体のみを持つ単方向リストです。&lt;/p&gt;
&lt;p&gt;解放済みのページを格納する&lt;code class=&quot;language-text&quot;&gt;freelist&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;の中に格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; use_lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の行では、引数として受け取ったアドレスが&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされており、かつページサイズの割り当てに十分な領域が存在しているかを確認しています。&lt;/p&gt;
&lt;p&gt;ここでチェックに失敗した場合は&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; end &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kfree&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数については後述します。&lt;/p&gt;
&lt;p&gt;次の行ではページの先頭アドレス&lt;code class=&quot;language-text&quot;&gt;v&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;分のアドレス領域を1で埋めています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Fill with junk to catch dangling refs.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;についても後述します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;によるメモリ領域の初期化が完了したら以下の行が実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;の実行時は、ロックは無効化されているため&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;は呼び出されません。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;kmem.freelist&lt;/code&gt;の先頭に新しい&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体が1ページ分追加され、&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;の処理は終了します。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数の処理も終了するため、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;の処理も終了し、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の次の関数の実行に進みます。&lt;/p&gt;
&lt;h2 id=&quot;kinit2関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit2%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kinit2関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit2関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;からしばらくカーネルの処理を実行した後、&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数はロックを有効化し、さらに大きなサイズのメモリ領域を確保します。&lt;/p&gt;
&lt;p&gt;動作は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;とほぼ同じです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;には4MiBのアドレスが割り当てされ、&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;にはアドレス領域の終端として設定されている&lt;code class=&quot;language-text&quot;&gt;0xE000000&lt;/code&gt;が与えられます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem.use_lock = 1;&lt;/code&gt;の行以外は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と同じです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;までの領域を解放してページリストに追加した後、ロックを有効化して終了します。&lt;/p&gt;
&lt;p&gt;これ以降はロックが有効化されているため、メモリの確保と解放のために&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数が呼び出されるようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数はどちらも&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;h2 id=&quot;xv6のロックについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6%E3%81%AE%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;xv6のロックについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6のロックについて&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数を読む前にxv6におけるロックの仕様を確認します。&lt;/p&gt;
&lt;p&gt;xv6OSはマルチプロセッサ環境で動作します。&lt;/p&gt;
&lt;p&gt;マルチプロセッサ環境の場合、複数のCPUが物理メモリリソースを共有しています。&lt;/p&gt;
&lt;p&gt;そのため、それぞれのCPUの処理が共有リソースを勝手に書き換えて問題を引き起こしたり競合したりしないようにするための仕組みがロックです。&lt;/p&gt;
&lt;p&gt;ロックによって任意のメモリ領域の排他制御を行うことで、そのメモリ領域に対して1つのCPUのみが操作可能な状態にすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、スピンロックとスリーブロックの2種類のロックが実装されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数で行っているロックはスピンロックです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%94%E3%83%B3%E3%83%AD%E3%83%83%E3%82%AF&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スピンロック - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;スピンロックによって、プロセスがメモリリソースを確保する際に、対象がすでにロックされている場合は、ロックが解除されるまでループを行って待機します。&lt;/p&gt;
&lt;h3 id=&quot;acquire関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#acquire%E9%96%A2%E6%95%B0&quot; aria-label=&quot;acquire関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;acquire関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;aquire&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体のポインタを引数としてロックを行います。&lt;/p&gt;
&lt;p&gt;ここでやりたいことはシンプルで、&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;locked&lt;/code&gt;に1をセットすることを試み、ロックが確保できるまでループして処理を待機させることです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Acquire the lock.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Loops (spins) until the lock is acquired.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Holding a lock for a long time may cause&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// other CPUs to waste time spinning to acquire it.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// disable interrupts to avoid deadlock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;acquire&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// The xchg is atomic.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;xchg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that the critical section&apos;s memory&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// references happen after the lock is acquired.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Record info about lock acquisition for debugging.&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の定義も再掲しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mutual exclusion lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint locked&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Is the lock held?&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// For debugging:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Name of lock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// The cpu holding the lock.&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// The call stack (an array of program counters)&lt;/span&gt;
                     &lt;span class=&quot;token comment&quot;&gt;// that locked the lock.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数の処理を順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// disable interrupts to avoid deadlock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;acquire&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pushcli&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;と同様に割込みを抑制させていますが、ここではスタックを利用してネストされた割込み禁止命令を実現しています。&lt;/p&gt;
&lt;p&gt;この処理によって、この後&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;でロックを確保する際に割込みが有効な状態でロックが保持される状況によってデッドロックが発生することを防いでいます。&lt;/p&gt;
&lt;p&gt;割込みを再開するには&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数を呼び出します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数では&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数は呼び出されません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数で実行された&lt;code class=&quot;language-text&quot;&gt;pushcli&lt;/code&gt;関数に対応した&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数が実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Pushcli/popcli are like cli/sti except that they are matched:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// it takes two popcli to undo two pushcli.  Also, if interrupts&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// are off, then pushcli, popcli leaves them off.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; eflags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  eflags &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;intena &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; eflags &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; FL_IF&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;FL_IF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;popcli - interruptible&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;popcli&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;intena&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sti&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の&lt;code class=&quot;language-text&quot;&gt;holding&lt;/code&gt;関数では、CPUがロックされているかを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Check whether this cpu is holding the lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lock&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; lock&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu()&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;proc.c&lt;/code&gt;で定義されている関数です。&lt;/p&gt;
&lt;p&gt;xv6OSはCPUごとに&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を管理しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;proc.h&lt;/code&gt;で以下のように定義されており、そのCPUで現在実行しているプロセスや入れ子になったスピンロックの数など様々な情報が格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Per-CPU state&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// Local APIC ID&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;scheduler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// swtch() here to enter scheduler&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;taskstate&lt;/span&gt; ts&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// Used by x86 to find stack for interrupt&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint started&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Has the CPU started?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ncli&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                    &lt;span class=&quot;token comment&quot;&gt;// Depth of pushcli nesting.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; intena&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// Were interrupts enabled before pushcli?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// The process running on this cpu or null&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数は現在のCPUの&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を参照するためのポインタを返します。&lt;/p&gt;
&lt;p&gt;呼び出し前には必ず割込みを無効化しておく必要があります。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;if(holding(lk)) panic(&quot;acquire&quot;);&lt;/code&gt;は、引数の&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体を参照し、CPUがロックされていることを確認しています。&lt;/p&gt;
&lt;p&gt;続いて、ロックののセットを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// The xchg is atomic.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;xchg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、ロックの操作時に競合が発生しないよう、操作をアトミックにする必要があります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;はこれを実現するための特殊なx86命令です。&lt;/p&gt;
&lt;p&gt;もしロックがセットされている場合、&lt;code class=&quot;language-text&quot;&gt;xchg(&amp;amp;lk-&gt;locked, 1)&lt;/code&gt;は1を返し、ループが継続されます。&lt;/p&gt;
&lt;p&gt;もしロックが解除されていた場合、&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;によって新たにロックが設定されます。&lt;/p&gt;
&lt;p&gt;その後、ループを終了しロックを確保します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://forum.osdev.org/viewtopic.php?f=1&amp;#x26;t=33690&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev.org • View topic - How can xchg return a value?&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that the critical section&apos;s memory&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// references happen after the lock is acquired.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Record info about lock acquisition for debugging.&lt;/span&gt;
lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;__sync_synchronize&lt;/code&gt;関数は組込み関数でメモリバリアを行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/982129/what-does-sync-synchronize-do/982179&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - What does _&lt;em&gt;sync&lt;/em&gt;synchronize do? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;lk-&gt;cpu&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数で取得した&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を格納します。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;getcallerpcs&lt;/code&gt;関数を呼び出しています。&lt;/p&gt;
&lt;p&gt;これはデバッグ用のコールスタックを格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Record the current call stack in pcs[] by following the %ebp chain.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ebp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  ebp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ebp &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ebp &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNBASE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ebp &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ebp&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// saved %eip&lt;/span&gt;
    ebp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ebp&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// saved %ebp&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数が呼び出されたときに出力される情報はここで格納しているようですね。&lt;/p&gt;
&lt;h3 id=&quot;release関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#release%E9%96%A2%E6%95%B0&quot; aria-label=&quot;release関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;release関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数には、ここまでに記載したい内容以上に特筆する点はないので詳細は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Release the lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;release&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that all the stores in the critical&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// section are visible to other cores before the lock is released.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Both the C compiler and the hardware may re-order loads and&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// stores; __sync_synchronize() tells them both not to.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Release the lock, equivalent to lk-&gt;locked = 0.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// This code can&apos;t use a C assignment, since it might&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// not be atomic. A real OS would use C atomics here.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;movl $0, %0&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;+m&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の&lt;code class=&quot;language-text&quot;&gt;asm volatile(&quot;movl $0, %0&quot; : &quot;+m&quot; (lk-&gt;locked) : );&lt;/code&gt;の行で&lt;code class=&quot;language-text&quot;&gt;locked&lt;/code&gt;に0を設定し、ロックを解除しています。&lt;/p&gt;
&lt;h2 id=&quot;おまけデバッガでpanic関数を呼び出してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7panic%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;おまけデバッガでpanic関数を呼び出してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：デバッガでpanic関数を呼び出してみる&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;CPU割込みを禁止した上で無限ループを発生させて、これ以上処理が行われないようにしているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;locking &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// use lapiccpunum so that we can call panic from mycpu()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;lapicid %d: panic: &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; %p&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  panicked &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// freeze other CPU&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際に何が出力されるのか確認するために、gdbで&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;を発生させてみることにしました。&lt;/p&gt;
&lt;p&gt;gdbで以下のコマンドを順に実行していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# QEMUに接続してpanic関数を呼び出す直前にブレークポイントを設定&lt;/span&gt;
$ target remote localhost:26000
$ b *0x80102499
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# panic関数を呼び出すようにフラグレジスタを改ざんして実行&lt;/span&gt;
$ info registers eflags
eflags         0x93                &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;IOPL&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; SF AF CF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$CF&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$eflags&lt;/span&gt; ^&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$CF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
$ info registers eflags
eflags         0x92                &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;IOPL&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; SF AF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでQEMUのコンソールを確認したところ、&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数の呼び出し時に&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;が呼び出されたことがわかります。&lt;/p&gt;
&lt;p&gt;最後の行に表示されているアドレスはリターンアドレスのスタックっぽいです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABYUlEQVQ4y62QuU7DQBRFx/vuOAUSxIkxW4NEAYiA4AdoKLIREiBiKyko6PiPJDjC8Z9e5nlJUiAESoqjuX4jn7kz7KbTRK/dQK/TQP+6OYfmfPZ438f72ysGvQ5uuy3cdds/0MLzwwBPl3Wwr2mCKIoQTSaI4xhJkmDKZ7TSd7E3Hn9iNBrnjBYyZzjEJE7w8dIG03QDqqJA0zTIspyi6zoMw0hnAmNgOYIgQCREMc0FNKP9gzUZTNXoZx2qqs4klmml2bZtWJaVYhomHMeB67rwPG+WMxwuFHC4oYMJogRJkqDwlgRlttDqPxxVDLCd3T34vo/trW0EQYAwDNMG1JjaEnTQb6LiWY5JqPOrGPmbFW9HVyRRIf2r8MQ3aWVYlkJYr1qZUFiR8LRmrbbhWWDPGy6DKGTCi9BeTcOCcxKu2zIqTo6rwOdUSxm1kprhZQQFZS2D501OyLPvqrjaL+MbS5xJroG2sO4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/8ac56/image-19.webp 240w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/d3be9/image-19.webp 480w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/b0a15/image-19.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/8ff5a/image-19.png 240w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/e85cb/image-19.png 480w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;おまけmemsetについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91memset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;おまけmemsetについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：memsetについて&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;string.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    c &lt;span class=&quot;token operator&quot;&gt;&amp;amp;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は、任意のメモリ領域に値を書き込むことのできる関数ですが、以下のglibの&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;とは実装が異なるように見えます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
inhibit_loop_to_libcall
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dstpp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstpp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; xlen&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      cccc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;OPSIZ &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;/* Do the shift in two steps to avoid warning if long has 32 bits.  */&lt;/span&gt;
	cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* There are at least some bytes to set.
	 No need to test for LEN == 0 in this alignment loop.  */&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstp &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; OPSIZ &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  len &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* Write 8 `op_t&apos; per iteration until less than 8 `op_t&apos; remain.  */&lt;/span&gt;
      xlen &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;OPSIZ &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xlen &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  xlen &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;%=&lt;/span&gt; OPSIZ &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* Write 1 `op_t&apos; per iteration until less than OPSIZ bytes remain.  */&lt;/span&gt;
      xlen &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xlen &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  xlen &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;%=&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;/* Write the last few bytes.  */&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dstpp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/lattera/glibc/blob/master/string/memset.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;glibc/memset.c at master · lattera/glibc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は、任意のアドレス範囲に特定の値を高速に書き込むことができ、初期化などに使用されます。&lt;/p&gt;
&lt;p&gt;単純にforループなどで実装するよりも高速に動作するように実装されているようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/13327155/memset-definition-and-use&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - Memset Definition and use - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6の&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;はglibのものよりかなり簡単な実装にはなっていますが、&lt;code class=&quot;language-text&quot;&gt;stosb&lt;/code&gt;命令や&lt;code class=&quot;language-text&quot;&gt;stosl&lt;/code&gt;を使用してforループよりも高速に動作するように実装されているようです。&lt;/p&gt;
&lt;p&gt;実際にgdbを使ってmemsetが動いていることを確認します。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;の実行直前にブレークポイントを仕掛けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ target remote localhost:26000
$ b memset
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ブレークポイントを設定したので、ページの先頭アドレスから0x1000バイト分の中身をのぞいてみたところ、すべて0になっていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# memset実行直前のメモリの状態を見る&lt;/span&gt;
$ x/1000 0x80116000
0x80116000:	0x00000000	0x00000000	0x00000000	0x00000000
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
0x80116f90:	0x00000000	0x00000000	0x00000000	0x00000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;終了直後に同じメモリ領域をのぞいてみると、すべてのバイト値が1になっていることが確認できました。(4バイトごとに出力が区切られているのでわかりづらいですが。)&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# memset実行直後のメモリの状態を見る&lt;/span&gt;
$ finish
$ $ x/1000 0x80116000
0x80116000:	0x01010101	0x01010101	0x01010101	0x01010101
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
0x80116f90:	0x01010101	0x01010101	0x01010101	0x01010101&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ようやくカーネル本体に進みました。&lt;/p&gt;
&lt;p&gt;とはいえ&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の1つ目の関数を読んだだけで結構なボリュームになってしまったので、続きは次の記事にまとめようと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -GDBデバッグ環境構築編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルをロードする挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-003-setup-kernel-debug</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-003-setup-kernel-debug</guid><pubDate>Mon, 24 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;まででxv6OSのビルドと起動プロセスまで読み進めました。&lt;/p&gt;
&lt;p&gt;早速カーネル本体の動きを読み進めようと思ったのですが、コードを読むだけだとわからない箇所があったので、理解を深めるためにデバッグ環境を先に構成しようと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#xv6os%E3%82%92qemu-gdb%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%99%E3%82%8B&quot;&gt;xv6OSをQEMU-GDBでデバッグする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82%E3%81%AEqemu%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%BC%95%E6%95%B0&quot;&gt;デバッグ時のQEMUのオプション引数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A9%A6%E3%81%99&quot;&gt;デバッグを試す&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;xv6osをqemu-gdbでデバッグする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6os%E3%82%92qemu-gdb%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%99%E3%82%8B&quot; aria-label=&quot;xv6osをqemu gdbでデバッグする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6OSをQEMU-GDBでデバッグする&lt;/h2&gt;
&lt;p&gt;基本的な手順は以下の記事が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/ksky/items/974ad1249cfb2dcf5437&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6のデバッグ環境をつくる - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;僕の環境ではQEMUのコンソールはGUIの別ウィンドウで使用したかったので、上記の記事とは異なり、&lt;code class=&quot;language-text&quot;&gt;qemu-nox-gdb&lt;/code&gt;ではなく&lt;code class=&quot;language-text&quot;&gt;qemu-gdb&lt;/code&gt;を使用しています。&lt;/p&gt;
&lt;p&gt;デバッガの接続方法は非常に簡単で、以下のコマンド実行するだけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefileと同じディレクトリで実行する&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; qemu-gdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、別のターミナルを開き、以下のコマンドを入力するとデバッグが可能になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# gdbでkernelバイナリをデバッグ対象に指定&lt;/span&gt;
gdb kernel

&lt;span class=&quot;token comment&quot;&gt;# gdbでリモートデバッグ&lt;/span&gt;
target remote localhost:26000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;make qemu-gdb&lt;/code&gt;は、xv6OSをビルドした上で&lt;code class=&quot;language-text&quot;&gt;qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512  -S -gdb tcp::26000&lt;/code&gt;を呼び出します。&lt;/p&gt;
&lt;p&gt;QEMUのオプション引数については以下で順に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;デバッグ時のqemuのオプション引数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82%E3%81%AEqemu%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%BC%95%E6%95%B0&quot; aria-label=&quot;デバッグ時のqemuのオプション引数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグ時のQEMUのオプション引数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;make qemu-gdb&lt;/code&gt;実行時に使用されるオプション引数は以下の通りです。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;オプション引数&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-serial &lt;dev&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;仮想シリアルデバイスをホストにリダイレクトする&lt;br /&gt;&lt;code class=&quot;language-text&quot;&gt;mon:stdio&lt;/code&gt;の設定ではターミナルにコンソールとQEMU monitorを表示させる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-drive &lt;options&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;ブロックデバイスやインターフェースなどの新しいデバイスを追加する&lt;br /&gt;今回は&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;をそれぞれdiskとして読み込んでいる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-smp &lt;cpus&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;指定した数のCPUを使用してSMP(マルチプロセッサシステム)をエミュレーションする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-m &lt;MB or GB&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;仮想マシン起動時のメモリサイズを指定(デフォルト単位：MB)&lt;br /&gt;&lt;code class=&quot;language-text&quot;&gt;1G&lt;/code&gt;のように接頭辞を付けることでギガバイト単位に変更可能&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-S&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;起動時にCPUを使用しない(=電源投入直後の時点で停止し、gdbの接続を待機させる)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-gdb &amp;#x3C;tcp::port&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;GDB接続を指定のプロトコル、ポートで受け入れる&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.qemu.org/docs/master/system/invocation.html#hxtool-0&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Invocation — QEMU documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/wataash/items/174b454d4478898a556b&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネルデバッグで使うQEMUオプションチートシート - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバッグを試す&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A9%A6%E3%81%99&quot; aria-label=&quot;デバッグを試す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグを試す&lt;/h3&gt;
&lt;p&gt;xv6カーネルのシンボル情報は、ビルド時に&lt;code class=&quot;language-text&quot;&gt;kernel.sym&lt;/code&gt;に格納されています。&lt;/p&gt;
&lt;p&gt;実際にgdb側でシンボルのアドレスを検索してみても同等の結果になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ info address main
Symbol &lt;span class=&quot;token string&quot;&gt;&quot;main&quot;&lt;/span&gt; is a &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; at address 0x80103040.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;main関数にブレークポイントを仕掛けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ main
$ c
Continuing.
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;----------------------------------registers-----------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
EAX: 0x80103040 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xfb1e0ff3 
EBX: 0x10094 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ECX: 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EDX: 0x1f0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ESI: 0x10094 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EDI: 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EBP: 0x7bf8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ESP: 0x8010b5c0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EIP: 0x80103040 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xfb1e0ff3
EFLAGS: 0x86 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;carry PARITY adjust zero SIGN &lt;span class=&quot;token builtin class-name&quot;&gt;trap&lt;/span&gt; interrupt direction overflow&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;-------------------------------------code-------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x80103034 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpenter+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x801027a0 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;lapicinit&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x80103039 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpenter+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;5&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x80102fe0 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpmain&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x8010303e:	xchg   ax,ax
&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x80103040 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	endbr32 
   0x80103044 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	lea    ecx,&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;esp+0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x80103048 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;8&lt;/span&gt;&gt;&lt;/span&gt;:	and    esp,0xfffffff0
   0x8010304b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	push   DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ecx-0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x8010304e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	push   ebp
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;------------------------------------stack-------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0004&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c4 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0008&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0012&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5cc --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0016&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0020&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d4 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0024&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0028&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5dc --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;------------------------------------------------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
Legend: code, data, rodata, value

Thread &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; hit Breakpoint &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;, main &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; at main.c:19&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;僕の環境ではgdb-pedaを有効化しているので色々でてきました。&lt;/p&gt;
&lt;p&gt;これでカーネルのデバッグができるようになりました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;はじめはbochsでやろうと思ったのですが、トラシューが上手くいかなかったのでgdbを使ってデバッグすることにしました。&lt;/p&gt;
&lt;p&gt;こっちの方が設定が簡単で使い慣れているので結果としてよかったです。&lt;/p&gt;
&lt;p&gt;今度こそほんとのほんとにカーネル本体を読み進めます。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -リンカ・ページング編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのデバッグ環境を構築します。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-002-load-kernel</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-002-load-kernel</guid><pubDate>Sun, 16 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-001-bootstrap&quot;&gt;前回&lt;/a&gt;に引き続きxv6OSのソースコードを読んでいきます。&lt;/p&gt;
&lt;p&gt;前回の記事では、xv6OSのブートストラップのコードを読んで、カーネル本体をロードする手前まで追っていきました。&lt;/p&gt;
&lt;p&gt;今回は実際に読み込まれるカーネルの動きを追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;カーネルプログラムのビルド&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88&quot;&gt;リンカスクリプト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E6%A7%8B%E9%80%A0&quot;&gt;リンカスクリプトの構造&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;エントリポイントの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionstext%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：textセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsrodata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：rodataセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsstabstabstr%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：stab,stabstrセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsdata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：dataセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsbss%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：bssセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsdiscard&quot;&gt;SECTIONS：DISCARD&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88&quot;&gt;カーネルのエントリポイント&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%96%E3%83%BC%E3%83%88%E3%83%98%E3%83%83%E3%83%80&quot;&gt;マルチブートヘッダ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9&quot;&gt;エントリポイントの物理アドレスを定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのエントリポイントのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF&quot;&gt;ページングとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;スタックポインタの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AB%E7%A7%BB%E8%A1%8C&quot;&gt;main関数に移行&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのロード&lt;/h2&gt;
&lt;p&gt;ブートストラップの中でカーネルのロードを行っていた箇所を振り返っておきます。&lt;/p&gt;
&lt;p&gt;カーネルの読み込みは、以下のようにメモリの&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;番地に読み込まれました。&lt;/p&gt;
&lt;p&gt;その後、プログラムヘッダがロードされ、&lt;code class=&quot;language-text&quot;&gt;entry()&lt;/code&gt;関数が呼び出されてカーネルに処理が移行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;そのため、今回は&lt;code class=&quot;language-text&quot;&gt;entry()&lt;/code&gt;関数を探すところから始めていきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;カーネルプログラムのビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;カーネルプログラムのビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルプログラムのビルド&lt;/h2&gt;
&lt;p&gt;カーネルプログラムのビルドの流れを追います。&lt;/p&gt;
&lt;p&gt;最終的なイメージファイルである&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;は、以下のコマンドで生成されていました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;の空領域に&lt;code class=&quot;language-text&quot;&gt;bootblock&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;を埋め込んだものが&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;xv6.img: bootblock kernel
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;bootblock &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kernel &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootblock&lt;/code&gt;については前回追ったので、今回は&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;を追っていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;kernel: &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; entry.o entryother initcode kernel.ld
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LDFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -T kernel.ld -o kernel entry.o &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -b binary initcode entryother
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S kernel &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; kernel.asm
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -t kernel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; kernel.sym&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;の依存関係は&lt;code class=&quot;language-text&quot;&gt;$(OBJS) entry.o entryother initcode kernel.ld&lt;/code&gt;になってます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$(OBJS)&lt;/code&gt;の一覧は結構数が多いので割愛します。&lt;code class=&quot;language-text&quot;&gt;main.o&lt;/code&gt;など、カーネルのモジュールが含まれます。&lt;/p&gt;
&lt;p&gt;下の2行はバイナリの逆アセンブル結果とシンボル情報を出力しているのみで、実際にバイナリを作成しているのは&lt;code class=&quot;language-text&quot;&gt;$(LD) $(LDFLAGS) -T kernel.ld -o kernel entry.o $(OBJS) -b binary initcode entryother&lt;/code&gt;の行です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LD&lt;/code&gt;は、前回説明した&lt;code class=&quot;language-text&quot;&gt;GCC&lt;/code&gt;と同じく&lt;code class=&quot;language-text&quot;&gt;$(TOOLPREFIX)ld&lt;/code&gt;の形式で使用されます。&lt;/p&gt;
&lt;p&gt;今回はクロスコンパイルは行わないので、普通に&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドが実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;LD &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;TOOLPREFIX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;ld

&lt;span class=&quot;token comment&quot;&gt;# FreeBSD ld wants ``elf_i386_fbsd&apos;&apos;&lt;/span&gt;
LDFLAGS &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; -m &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token punctuation&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; -V &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; elf_i386 &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;head&lt;/span&gt; -n &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LDFLAGS&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;ld -V&lt;/code&gt;の結果から&lt;code class=&quot;language-text&quot;&gt;elf_i386&lt;/code&gt;を抽出して&lt;code class=&quot;language-text&quot;&gt;-m elf_i386&lt;/code&gt;オプションとして表示させています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld -V&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドのバージョン確認コマンドのうち、サポートしているエミュレータの一覧を表示するオプション付きのコマンドです。&lt;/p&gt;
&lt;p&gt;実際にビルド時に実行されるコマンドは以下のようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-T&lt;/code&gt;オプションは&lt;code class=&quot;language-text&quot;&gt;-c&lt;/code&gt;オプションと同じく、リンカスクリプト(&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;)からリンクコマンドを読み込むオプションです。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;-b&lt;/code&gt;オプションは以降にインプットするオブジェクトファイルのバイナリフォーマットを指定するコマンドで、今回は&lt;code class=&quot;language-text&quot;&gt;binary&lt;/code&gt;を指定しているようです。&lt;/p&gt;
&lt;p&gt;以降に続く&lt;code class=&quot;language-text&quot;&gt;initcode&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;entryother&lt;/code&gt;はアセンブリファイルからアセンブルされたバイナリです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ld -m elf_i386 -T kernel.ld -o kernel &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
entry.o bio.o console.o exec.o file.o fs.o ide.o ioapic.o kalloc.o kbd.o lapic.o log.o main.o mp.o picirq.o pipe.o proc.o sleeplock.o spinlock.o string.o swtch.o syscall.o sysfile.o sysproc.o trapasm.o trap.o uart.o vectors.o vm.o  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
-b binary initcode entryother&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LD、GNUリンカーの使用-オプション&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次にリンカスクリプト&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;の中身を見てみます。&lt;/p&gt;
&lt;h3 id=&quot;リンカスクリプト&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88&quot; aria-label=&quot;リンカスクリプト permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リンカスクリプト&lt;/h3&gt;
&lt;p&gt;そもそもリンカスクリプトについてですが、リンカがオブジェクトファイルをリンクして実行形式を作成する際に、オブジェクトのメモリ配置を指定するためのファイルです。&lt;/p&gt;
&lt;p&gt;通常は、リンカに内臓されているデフォルトのリンカスクリプトが使用されるため、明示的に指定する必要はありません。&lt;/p&gt;
&lt;p&gt;ちなみに、リンカに内臓されているデフォルトのリンカスクリプトは&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドに&lt;code class=&quot;language-text&quot;&gt;--verbose&lt;/code&gt;オプションを付けると出力できます。&lt;/p&gt;
&lt;p&gt;ただし、OSなど組込み系のプログラムの場合は、汎用OSの管理機能が使えないため、リンカスクリプトを独自に設定する必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Scripts.html#Scripts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Scripts (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Basic-Script-Concepts.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Basic Script Concepts (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.computex.co.jp/article/use_gcc_1.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GNU Cを使いこなそう | 株式会社コンピューテックス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでカーネルのビルドに使用するリンカスクリプトの全文は以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Simple linker script for the JOS kernel.
   See the GNU ld &apos;info&apos; manual (&quot;info ld&quot;) to learn the syntax. */&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;OUTPUT_FORMAT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;OUTPUT_ARCH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i386&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ENTRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

SECTIONS
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;/* Link the kernel at this address: &quot;.&quot; means the current address */&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;/* Must be equal to KERNLINK */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stub &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Include debugging information in kernel memory */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Adjust the address for the data segment to the next page */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Conventionally, Unix linkers provide pseudo-symbols
	 * etext, edata, and end, at the end of the text, data, and bss.
	 * For the kernel mapping, we need the address at the beginning
	 * of the data section, but that&apos;s not one of the conventional
	 * symbols, because the convention started before there was a
	 * read-only rodata section between text and data. */&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* The data segment */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;DISCARD&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;eh_frame &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;note&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GNU&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;リンカスクリプトの構造&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E6%A7%8B%E9%80%A0&quot; aria-label=&quot;リンカスクリプトの構造 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リンカスクリプトの構造&lt;/h3&gt;
&lt;p&gt;リンカスクリプトとして最低限必須となる記述は、&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;MEMORY&lt;/code&gt;要素を定義する場合が多いですが、必須ではありません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素ではセクションを定義し、任意のアドレスに配置します。&lt;/p&gt;
&lt;p&gt;このアドレスは、物理アドレスと仮想アドレスのどちらも定義可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.computex.co.jp/article/use_gcc_1.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GNU Cを使いこなそう | 株式会社コンピューテックス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://blueeyes.sakura.ne.jp/2018/10/31/1676/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リンカスクリプトの書き方&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素のみが定義された最も単純なリンカスクリプトは以下の例のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;SECTIONS
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Simple-Example.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Simple Example (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSのリンカスクリプトでは、以下のセクションが定義されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;.text : 実行バイナリが配置される。通常は読み取り/実行権限のみ。&lt;/li&gt;
&lt;li&gt;.rodata : 読み取り専用データが配置される。&lt;/li&gt;
&lt;li&gt;.stab : スタブと呼ばれる固定長構造体の配列が配置される。&lt;/li&gt;
&lt;li&gt;.stabstr : スタブから参照される可変長文字列が配置される。&lt;/li&gt;
&lt;li&gt;.data : 読み書き可能なデータが配置される。&lt;/li&gt;
&lt;li&gt;.bss : ブロック開始記号(宣言されているがまだ値が割り当てられていないオブジェクト)が配置される。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://opensource.apple.com/source/gdb/gdb-292/doc/stabs.html/stabs_13.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;STABS - Using Stabs in Their Own Sections&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://doc.ecoscentric.com/gnutools/doc/stabs/Stab-Section-Basics.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;STABS: Stab Section Basics&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/.bss&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.bss - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リンカスクリプトの内容について順に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;エントリポイントの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントの定義&lt;/h3&gt;
&lt;p&gt;リンカスクリプトの先頭行を見ると、3つの定義がされています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Simple linker script for the JOS kernel.
   See the GNU ld &apos;info&apos; manual (&quot;info ld&quot;) to learn the syntax. */&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;OUTPUT_FORMAT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;OUTPUT_ARCH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i386&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ENTRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;OUTPUT_FORMAT&lt;/code&gt;では、出力バイナリのフォーマットを定義しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;OUTPUT_ARCH&lt;/code&gt;では、出力されるバイナリがどのアーキテクチャに対応するかを指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ENTRY&lt;/code&gt;では、一番初めに実行される関数のシンボル名を指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Entry-Point.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Entry Point (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで指定されている&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の中で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)

# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の詳細については後述します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/#kernelld&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;sectionstextセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionstext%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionstextセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：textセクションの定義&lt;/h3&gt;
&lt;p&gt;まずはtextセクションの定義を行っている箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Link the kernel at this address: &quot;.&quot; means the current address */&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* Must be equal to KERNLINK */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stub &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最初の行で定義されている&lt;code class=&quot;language-text&quot;&gt;. = 0x80100000;&lt;/code&gt;では、特殊記号&lt;code class=&quot;language-text&quot;&gt;.&lt;/code&gt;の値を設定します。&lt;/p&gt;
&lt;p&gt;これは、ロケーションカウンタとして使用されます。&lt;/p&gt;
&lt;p&gt;以降に定義されたセクションは、ロケーションカウンタの指すアドレスから開始されます。&lt;/p&gt;
&lt;p&gt;セクションが定義されると、ロケーションカウンタはそのサイズ分インクリメントされます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Simple-Example.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Simple Example (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、ロケーションカウンタの初期値として&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;p&gt;これによって、リンカによって出力されるバイナリの命令アドレスは&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;から開始されることになります。&lt;/p&gt;
&lt;p&gt;セクションの定義は、以下の構造で行われます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;section &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;address&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lma&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;section_align&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; ALIGN_WITH_INPUT&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;SUBALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;subsection_align&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;constraint&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    output&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;section&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;command
    output&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;section&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;command
    …
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;region&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;AT&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;lma_region&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;phdr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;phdr …&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;fillexp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Output-Section-Description.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Output Section Description (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AT(0x100000)&lt;/code&gt;は、セクションのロードアドレスを&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;と定義しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_21.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Section Options&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;*(.text .stub .text.* .gnu.linkonce.t.*)&lt;/code&gt;の行は何をしているのか正直全くわからなかったのですが、セクションのコンテンツを定義している行のようです。&lt;/p&gt;
&lt;p&gt;いくつか定義の方法がありますが、基本的には&lt;code class=&quot;language-text&quot;&gt;ファイル名(シンボル)&lt;/code&gt;の形式で定義されます。&lt;/p&gt;
&lt;p&gt;複数行に渡って定義することが可能です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;*()&lt;/code&gt;のように、ファイル名の代わりに&lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;を使用した場合は、リンク時に与えられたオブジェクトファイルの全てが対象になります。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;*(.text .stub .text.* .gnu.linkonce.t.*)&lt;/code&gt;の行は、入力されたオブジェクトファイルの持つ&lt;code class=&quot;language-text&quot;&gt;.text .stub .text.* .gnu.linkonce.t.*&lt;/code&gt;の各セクションのデータをリンカが作成する実行ファイルの&lt;code class=&quot;language-text&quot;&gt;.text.&lt;/code&gt;セクションに配置する、という命令です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_19.html#SEC19&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Section Placement&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リンカの入力で与えられている&lt;code class=&quot;language-text&quot;&gt;entry.o&lt;/code&gt;や&lt;code class=&quot;language-text&quot;&gt;bio.o&lt;/code&gt;などのファイルは、いずれも32bitELF形式でコンパイルされているため、それぞれがヘッダや&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションを持っています。&lt;/p&gt;
&lt;p&gt;これらを一つの実行ファイルとして統合するために上記のような定義がされているんですね。&lt;/p&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションの定義が完了したため、セグメントの終了を示す&lt;code class=&quot;language-text&quot;&gt;etext&lt;/code&gt;を定義する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/LDP_man-pages/man3/end.3.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of END&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;PROVIDE&lt;/code&gt;を使って、カレントロケーションに&lt;code class=&quot;language-text&quot;&gt;etext&lt;/code&gt;を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PROVIDE&lt;/code&gt;は、シンボルがコード上で未定義の場合にのみシンボルを作成する命令です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/PROVIDE.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PROVIDE (LD)&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;sectionsrodataセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsrodata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsrodataセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：rodataセクションの定義&lt;/h3&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;.rodata&lt;/code&gt;セクションを定義します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rodata&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Read Only Data&lt;/code&gt;の意味です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;リンカの定義は&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションと同じ記法なので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;sectionsstabstabstrセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsstabstabstr%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsstabstabstrセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：stab,stabstrセクションの定義&lt;/h3&gt;
&lt;p&gt;続いて、デバッグ用の&lt;code class=&quot;language-text&quot;&gt;stab&lt;/code&gt;セクションが定義されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Include debugging information in kernel memory */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;は、リンカスクリプトで定義されたコンテンツが空となるセクションは作成しません。&lt;/p&gt;
&lt;p&gt;デフォルトのコードでは各バイナリは&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションを持たないため、&lt;code class=&quot;language-text&quot;&gt;kerel&lt;/code&gt;にも&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションは存在しませんでした。&lt;/p&gt;
&lt;p&gt;しかし、Makefileで定義されたgccのコンパイルオプションに&lt;code class=&quot;language-text&quot;&gt;-gstabs&lt;/code&gt;を追加して&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションを作成することで、リンクされた&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;にも&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションが作成されることを確認しました。&lt;/p&gt;
&lt;h3 id=&quot;sectionsdataセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsdata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsdataセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：dataセクションの定義&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションには読み書き可能なデータが格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Adjust the address for the data segment to the next page */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* Conventionally, Unix linkers provide pseudo-symbols
	* etext, edata, and end, at the end of the text, data, and bss.
	* For the kernel mapping, we need the address at the beginning
	* of the data section, but that&apos;s not one of the conventional
	* symbols, because the convention started before there was a
	* read-only rodata section between text and data. */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* The data segment */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;. = ALIGN(0x1000);&lt;/code&gt;の行でカレントロケーションを&lt;code class=&quot;language-text&quot;&gt;0x1000&lt;/code&gt;の境界にアラインメントしてます。&lt;/p&gt;
&lt;p&gt;この行は先ほどの&lt;code class=&quot;language-text&quot;&gt;. = 0x80100000;&lt;/code&gt;のように、ロケーションカウンタに特定のアドレスを割り当てているわけではありません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ALIGN&lt;/code&gt;を実行した時点のカレントロケーションをもとに、指定した値の境界にカレントロケーションをアラインメントしています。&lt;/p&gt;
&lt;p&gt;実際に生成された&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;のバイナリを見ると、バイナリデータが&lt;code class=&quot;language-text&quot;&gt;0x80107aa9&lt;/code&gt;まで連続していたところから、&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションの先頭アドレスが&lt;code class=&quot;language-text&quot;&gt;0x80108000&lt;/code&gt;になっていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ objdump -D kernel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; -5 &lt;span class=&quot;token string&quot;&gt;&quot;Disassembly of section .data:&quot;&lt;/span&gt;
80107aa6:	&lt;span class=&quot;token number&quot;&gt;67&lt;/span&gt; 6e                	outsb  %ds:&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%si&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;,&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%dx&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
80107aa8:	&lt;span class=&quot;token number&quot;&gt;65&lt;/span&gt;                   	gs
80107aa9:	&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;                   	fs
	&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.

Disassembly of section .data:

&lt;span class=&quot;token number&quot;&gt;80108000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ctlmap&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:
	&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.
&lt;span class=&quot;token number&quot;&gt;80108010&lt;/span&gt;:	&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;                	adc    %edx,&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%edi&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;80108012&lt;/span&gt;:	05 &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;       	&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;    &lt;span class=&quot;token variable&quot;&gt;$0x15191412&lt;/span&gt;,%eax&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これはカレントロケーションが&lt;code class=&quot;language-text&quot;&gt;0x80107aaa&lt;/code&gt;までインクリメントされていたところから&lt;code class=&quot;language-text&quot;&gt;0x1000&lt;/code&gt;の境界にアラインメントされた結果です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_14.html#IDX239&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Arithmetic Functions&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以降の定義は、これまで紹介した内容と同一なので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;sectionsbssセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsbss%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsbssセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：bssセクションの定義&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.bss&lt;/code&gt;セクションは以下のように定義します。&lt;/p&gt;
&lt;p&gt;ここについてもこれまでと同様ですので割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;sectionsdiscard&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsdiscard&quot; aria-label=&quot;sectionsdiscard permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：DISCARD&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/DISCARD/&lt;/code&gt;に記述されたセクションは生成オブジェクトにリンクされません。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;DISCARD&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;eh_frame &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;note&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GNU&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.eh_frame&lt;/code&gt;はgccによって生成される、スタックバックトレースを取得するための情報が格納されるセクションです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.note.GNU-stack&lt;/code&gt;は、Linuxのオブジェクトファイルでスタック属性を宣言する際に使用されます。&lt;/p&gt;
&lt;h2 id=&quot;カーネルのエントリポイント&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88&quot; aria-label=&quot;カーネルのエントリポイント permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのエントリポイント&lt;/h2&gt;
&lt;p&gt;続いて、リンク時にカーネルのエントリポイントとして定義されていた&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;関数を見ていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;関数が定義された&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;は以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# The xv6 kernel starts executing in this file. This file is linked with
# the kernel C code, so it can refer to kernel symbols such as main().
# The boot block (bootasm.S and bootmain.c) jumps to entry below.
        
# Multiboot header, for multiboot boot loaders like GNU Grub.
# http://www.gnu.org/software/grub/manual/multiboot/multiboot.html
#
# Using GRUB 2, you can boot xv6 from a file stored in a
# Linux file system by copying kernel or kernelmemfs to /boot
# and then adding this menu entry:
#
# menuentry &amp;quot;xv6&amp;quot; {
# 	insmod ext2
# 	set root=&amp;#39;(hd0,msdos1)&amp;#39;
# 	set kernel=&amp;#39;/boot/kernel&amp;#39;
# 	echo &amp;quot;Loading ${kernel}...&amp;quot;
# 	multiboot ${kernel} ${kernel}
# 	boot
# }

#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;
#include &amp;quot;param.h&amp;quot;

# Multiboot header.  Data to direct multiboot loader.
.p2align 2
.text
.globl multiboot_header
multiboot_header:
  #define magic 0x1badb002
  #define flags 0
  .long magic
  .long flags
  .long (-magic-flags)

# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)

# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;マルチブートヘッダ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%96%E3%83%BC%E3%83%88%E3%83%98%E3%83%83%E3%83%80&quot; aria-label=&quot;マルチブートヘッダ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;マルチブートヘッダ&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の先頭行からコードを見ていくと、次のようなコードがありました。&lt;/p&gt;
&lt;p&gt;まず先頭行、&lt;code class=&quot;language-text&quot;&gt;.p2align 2&lt;/code&gt;ではバイナリを4バイト境界にアラインメントしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/as/P2align.html#P2align&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P2align (Using as)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/21546946/what-does-p2align-do-in-asm-code&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gcc - What does .p2align do in asm code? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;その後&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;ディレクティブの直下に&lt;code class=&quot;language-text&quot;&gt;multiboot_header&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;p&gt;ここでは、マルチブート仕様に対応するためのマルチブートヘッダの定義を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Multiboot header.  Data to direct multiboot loader.
.p2align 2
.text
.globl multiboot_header
multiboot_header:
  #define magic 0x1badb002
  #define flags 0
  .long magic
  .long flags
  .long (-magic-flags)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;マルチブート仕様とは、ブートローダがx86オペレーティングシステムカーネルをロードする方法を標準化したものです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/3850/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;前回&lt;/a&gt;の記事では、xv6OSのブートローダのコードを見ていきましたが、例えばxv6OSのカーネルをGRUBでブートしたい場合には、このマルチブート仕様にカーネルを対応させる必要があります。&lt;/p&gt;
&lt;p&gt;GRUBなどのブートローダは、Linuxシステムなどで標準的に採用されています。(通常はGRUB2を使用)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki2th.com/ja/Multiboot_Specification&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;マルチブート仕様&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wocota.hatenadiary.org/entry/20090607/1244389534&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GRUBでOSを起動する - OSのようなもの&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://inaz2.hatenablog.com/entry/2015/12/31/221319&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GRUBで簡単なOSカーネルを動かしてみる - ももいろテクノロジー&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にxv6OSをGRUBによる起動に対応させるのはカーネルの読解が一通り終わってからやろうと考えているので、コードの詳細は追わずに先に進みます。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントの物理アドレスを定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;エントリポイントの物理アドレスを定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントの物理アドレスを定義&lt;/h3&gt;
&lt;p&gt;続いてのコードは以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.globl&lt;/code&gt;ディレクティブは、シンボルをリンクされているすべてのファイルから参照可能にするための宣言です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;はエントリポイントとしてリンカスクリプトなどから参照されていたシンボルですが、この宣言によって&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の外部からの呼び出しが可能になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.google.com/search?q=.globl&amp;#x26;rlz=1C1GCEA_enJP959JP959&amp;#x26;oq=.globl&amp;#x26;aqs=chrome..69i57j0i512j0i10i512j0i10l7.483j0j7&amp;#x26;sourceid=chrome&amp;#x26;ie=UTF-8&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.globl - Google Search&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;_start = V2P_WO(entry)&lt;/code&gt;の行を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;V2P_WO&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;で定義されている以下のマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;// Memory layout

#define EXTMEM  0x100000            // Start of extended memory
#define PHYSTOP 0xE000000           // Top physical memory
#define DEVSPACE 0xFE000000         // Other devices are at high addresses

// Key addresses for address space layout (see kmap in vm.c for layout)
#define KERNBASE 0x80000000         // First kernel virtual address
#define KERNLINK (KERNBASE+EXTMEM)  // Address where kernel is linked

#define V2P(a) (((uint) (a)) - KERNBASE)
#define P2V(a) ((void *)(((char *) (a)) + KERNBASE))

#define V2P_WO(x) ((x) - KERNBASE)    // same as V2P, but without casts
#define P2V_WO(x) ((x) + KERNBASE)    // same as P2V, but without casts&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;引数として受け取ったアドレスから&lt;code class=&quot;language-text&quot;&gt;KERNBASE&lt;/code&gt;として設定されている&lt;code class=&quot;language-text&quot;&gt;0x80000000&lt;/code&gt;を引いて返すだけのマクロのようです。&lt;/p&gt;
&lt;p&gt;もともと、リンカではカーネルの&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションは&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;をベースにしてリンクされていました。&lt;/p&gt;
&lt;p&gt;これはユーザモードとカーネルモードの仮想メモリ範囲を切り分けて、x86CPUのページング機構によってCPUがカーネルの仮想アドレスをロードするための仕組みです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;しかし、&lt;code class=&quot;language-text&quot;&gt;_start = V2P_WO(entry)&lt;/code&gt;が実行される段階では、カーネル側で仮想メモリの設定が行われていないため、エントリポイント&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;を物理アドレスに割り当てるために、&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;の減算が行われています。&lt;/p&gt;
&lt;h3 id=&quot;カーネルのエントリポイントのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのエントリポイントのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのエントリポイントのロード&lt;/h3&gt;
&lt;p&gt;残りの&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の処理を追っていきます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;.globl entry&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;を外部から参照可能なシンボルとしています。&lt;/p&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;で行っている処理は、簡単に言うとページングを利用してカーネルの仮想アドレスを読み込んでいます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;ラベルが呼び出しされる時点では、まだページング機構は有効化されていないので、まずはこれを有効化していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ページングとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF&quot; aria-label=&quot;ページングとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ページングとは&lt;/h3&gt;
&lt;p&gt;コードを追う前に、ページングについて簡単にまとめます。&lt;/p&gt;
&lt;p&gt;ページングとは、メモリ領域を固定長のサイズ(ページ)に分割して管理する方法です。&lt;/p&gt;
&lt;p&gt;これによって、分割されたメモリ領域をリニアなメモリ空間として扱うことができたり、SSDなどの補助記憶装置に仮想的なページ領域を確保することで、物理メモリの容量以上のメモリ領域を扱うことができます。&lt;/p&gt;
&lt;p&gt;ページングにおいて、主記憶装置から補助記憶装置にページを書き出すことを「ページアウト」、逆に補助記憶装置から主記憶装置にページを書き戻すことを「ページイン」または「スワップイン」と呼びます。&lt;/p&gt;
&lt;p&gt;ページング機構によって、使用されていないメモリ領域はページアウトによって補助記憶装置に保存されます。&lt;/p&gt;
&lt;p&gt;次にそのメモリ領域が必要となる場合、OSは物理メモリ上に存在しないアドレスに対して「ページフォールト」という例外を発生させ、割込みによってスワップインを行い、物理メモリ上にページを書き戻すという挙動が発生します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://babyron64.hatenablog.com/entry/2017/12/22/210124&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86_64アーキテクチャ - ばびろん’s すたっく メモリアクセス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://babyron64.hatenablog.com/entry/2017/12/22/232423&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86_64アーキテクチャ - ばびろん’s すたっく メモリアクセス(続き)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://e-words.jp/w/%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ページング（paging）とは - IT用語辞典 e-Words&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ページング機構を有効化するためには、x86CPUでは&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPGフラグを1にする必要があります。&lt;/p&gt;
&lt;p&gt;実際にページングを有効化している箇所を見ます。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/3850/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;前回の記事&lt;/a&gt;でプロテクトモード移行時に&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPEフラグをセットしましたが、この時とやり方はほぼ同じです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の&lt;code class=&quot;language-text&quot;&gt;# Turn on paging.&lt;/code&gt;以降の処理が、&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPGフラグをセットしている箇所です。&lt;/p&gt;
&lt;p&gt;各フラグの演算に使っている定数はそれぞれ以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Control Register flags&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_PE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Protection Enable&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_WP&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00010000&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Write Protect&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_PG&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x80000000&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Paging&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR4_PSE&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000010&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Page size extension&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここから、PGフラグだけでなく、WPフラグもセットしていることがわかります。&lt;/p&gt;
&lt;p&gt;WPフラグがセットされると、CPUはリング0のスーパーバイザレベルのプロシージャが読み取り専用ページに時書き込みを行うことを禁止することができます。&lt;/p&gt;
&lt;p&gt;これによってOSで新しいプロセスを作成する際のコピーオンライト方式の実装を容易にすることができます。&lt;/p&gt;
&lt;p&gt;これについては今後の記事で書きます。&lt;/p&gt;
&lt;p&gt;ただ、x86CPUではデフォルトでWPフラグがセットされているはずなので、なぜ明示的に設定しているのかは疑問に感じる点です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/15275059/whats-the-purpose-of-x86-cr0-wp-bit&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - whats the purpose of x86 cr0 WP bit? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次に、CR0の設定より少しさかのぼった以下の箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Turn on page size extension for 4Mbyte pages
movl    %cr4, %eax
orl     $(CR4_PSE), %eax
movl    %eax, %cr4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;CR4(コントロールレジスタ4)&lt;/code&gt;のPSEフラグをセットしています。&lt;/p&gt;
&lt;p&gt;このフラグは、1ページのサイズをコントロールすることができます。&lt;/p&gt;
&lt;p&gt;CR4のPSEフラグがセットされていない(デフォルト)場合、ページのサイズは4KiBになります。&lt;/p&gt;
&lt;p&gt;逆にPSEフラグがセットされている場合、ページサイズは4MiBに拡張されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ページサイズに2つのサイズが設定されている詳しい背景などは機会があれば別の記事にまとめます。&lt;/p&gt;
&lt;p&gt;xv6OSでは、4MiBのページサイズが設定されていることまでわかりました。&lt;/p&gt;
&lt;p&gt;最後は以下の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set page directory
movl    $(V2P_WO(entrypgdir)), %eax
movl    %eax, %cr3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;xv6OSにおけるページング機構は、この次の行で有効化しているため、この時点ではまだページングが有効になっていません。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;$(V2P_WO(entrypgdir))&lt;/code&gt;マクロによって&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;のアドレスを物理アドレスに変換してからCR3に書き込んでいます。&lt;/p&gt;
&lt;p&gt;CR3は、ページング機構が有効な場合に使用されるレジスタで、x86CPUがページディレクトリとページテーブルを参照し、リニアアドレスを物理アドレスに変換するために使用されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で定義されている構造体配列です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// main.c&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; entrypgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// For entry.S&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// The boot page table used in entry.S and entryother.S.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Page directories (and page tables) must start on page boundaries,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// hence the __aligned__ attribute.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// PTE_PS in a page directory entry enables 4Mbyte pages.&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;__attribute__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;__aligned__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; entrypgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NPDENTRIES&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Map VA&apos;s [0, 4MB) to PA&apos;s [0, 4MB)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_PS&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   
  &lt;span class=&quot;token comment&quot;&gt;// Map VA&apos;s [KERNBASE, KERNBASE+4MB) to PA&apos;s [0, 4MB)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;KERNBASE&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;PDXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_PS&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配列のサイズは&lt;code class=&quot;language-text&quot;&gt;NPDENTRIES&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下の通り1024と定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Page directory and page table constants.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPDENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # directory entries per page directory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPTENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # PTEs per page table&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PGSIZE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// bytes mapped by a page&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;には2つの要素があります。&lt;/p&gt;
&lt;p&gt;正直何をしているのか雰囲気でしか理解していないですが、ここでは単にページディレクトリのエントリを初期化しているようです。&lt;/p&gt;
&lt;p&gt;まず、2つの要素に共通している&lt;code class=&quot;language-text&quot;&gt;(0) | PTE_P | PTE_W | PTE_PS&lt;/code&gt;の行は、以下の定義を行っています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; - すべてのビットを0にする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_P&lt;/code&gt; - present をセットする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_W&lt;/code&gt; - read\write をセットする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_PS&lt;/code&gt; - 4MiB page size bit をセットする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1つ目の要素&lt;code class=&quot;language-text&quot;&gt;[0] = (0) | PTE_P | PTE_W | PTE_PS,&lt;/code&gt;では、0番目の要素のページディレクトリエントリをこの値に初期化しています。&lt;/p&gt;
&lt;p&gt;次の要素では、&lt;code class=&quot;language-text&quot;&gt;KERNBASE&gt;&gt;PDXSHIFT&lt;/code&gt; = &lt;code class=&quot;language-text&quot;&gt;0x80000000 &gt;&gt; 22&lt;/code&gt; = 512番目の要素のページディレクトリエントリをこの値に初期化しています。&lt;/p&gt;
&lt;p&gt;この初期化は、次にページング機構を有効化してメイン関数に移行する際に使用するようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/58576065/what-does-this-code-mean-in-xv6-entrypgdir&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;what does this code mean in xv6 entrypgdir? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;スタックポインタの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;スタックポインタの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックポインタの設定&lt;/h3&gt;
&lt;p&gt;最後にスタックポインタの設定を行って、main関数に移行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set up the stack pointer.
movl $(stack + KSTACKSIZE), %esp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;KSTACKSIZE&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で4096と定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPROC&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of processes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;KSTACKSIZE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of per-process kernel stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NCPU&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of CPUs&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NOFILE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// open files per process&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NFILE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// open files per system&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NINODE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of active i-nodes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NDEV&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum major device number&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ROOTDEV&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// device number of file system root disk&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MAXARG&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max exec arguments&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MAXOPBLOCKS&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max # of blocks any FS op writes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LOGSIZE&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MAXOPBLOCKS&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max data blocks in on-disk log&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NBUF&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MAXOPBLOCKS&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of disk block cache&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;FSSIZE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of file system in blocks&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Cのコードに移行するためにスタックポインタの設定が必要なのですが、ここは正直よくわかりませんでした。&lt;/p&gt;
&lt;p&gt;というのも、変数&lt;code class=&quot;language-text&quot;&gt;stack&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で定義されているものであり、この時点ではまだ値が格納されていません。&lt;/p&gt;
&lt;p&gt;結果として&lt;code class=&quot;language-text&quot;&gt;.comm&lt;/code&gt;シンボルとして定義され、あとで再定義される想定とされているようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/29008035/assembly-mov-unitialized-variable&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - assembly - mov unitialized variable? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;難解ですね。。&lt;/p&gt;
&lt;h3 id=&quot;main関数に移行&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AB%E7%A7%BB%E8%A1%8C&quot; aria-label=&quot;main関数に移行 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main関数に移行&lt;/h3&gt;
&lt;p&gt;ブートストラップから続く一連の処理がようやく終わり、ここからカーネル本体となる&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の関数に移行していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;Jump to &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; and &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; to executing at&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;high&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;addresses&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; The indirect call is needed because&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;assembler produces a PC&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;relative instruction&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;a direct jump&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
mov $main&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;eax
jmp &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;eax

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;comm stack&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結構長くなってしまったので続きはまた次回の記事にて。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はカーネルプログラムのビルドとリンカスクリプト、そしてエントリポイントの処理の流れを追っていきました。&lt;/p&gt;
&lt;p&gt;次回は今度こそようやくカーネル本体の動きを追っていくことができそうです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ブートストラップ編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのブートストラップを読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-001-bootstrap</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-001-bootstrap</guid><pubDate>Mon, 10 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;xv6は、もともとMITのOSの講義のために開発された教育用のOSです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2012/xv6.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Xv6, a simple Unix-like teaching operating system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この講義で使用するテキストもオンラインで配布されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2012/xv6/book-rev7.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 a simple, Unix-like teaching operating system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Fork元のリポジトリは現在メンテナンスされておらず、RISC-Vで動作するUNIXv6のメンテナンスが行われています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%A7%8B%E9%80%A0&quot;&gt;イメージファイルの構造&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#xv6img&quot;&gt;xv6.img&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#fsimg&quot;&gt;fs.img&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#bootblock%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;bootblockを読む&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9&quot;&gt;コンパイラ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E4%BD%8D%E7%BD%AE%E7%8B%AC%E7%AB%8B%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89pic&quot;&gt;メモ：位置独立なコード(PIC)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot;&gt;bootmain.cの全体像&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootblocko%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot;&gt;bootblock.oの全体像&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%BC%E3%83%88%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF&quot;&gt;ブートプログラムのリンク&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモードとプロテクトモード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot;&gt;リアルモードで起動する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cli%E3%81%A8sti%E3%81%A7cpu%E5%89%B2%E8%BE%BC%E3%81%BF%E3%82%92%E7%A6%81%E6%AD%A2&quot;&gt;cliとstiでCPU割込みを禁止&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;セグメントレジスタの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#a20-line%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;A20 Lineの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C&quot;&gt;プロテクトモードへの移行&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E5%8F%82%E7%85%A7&quot;&gt;プロテクトモードでのメモリアドレス参照&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#lgdt-gdtdesc&quot;&gt;lgdt gdtdesc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32bit%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AE%E9%96%8B%E5%A7%8B&quot;&gt;32bitモードの開始&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%AA%E3%81%9Cljmp%E5%91%BD%E4%BB%A4%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B&quot;&gt;なぜljmp命令を使用するのか&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E7%A7%BB%E8%A1%8C%E5%BE%8C%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;プロテクトモード移行後の設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96-1&quot;&gt;セグメントレジスタの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot;&gt;bootmain.cの呼び出し&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89elf%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;ディスクからELFカーネルイメージをロードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89%E3%82%BB%E3%82%AF%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B&quot;&gt;ディスクからセクタを読み取る&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;読み込んだカーネルの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot;&gt;プログラムヘッダの読み込み&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;イメージファイルの構造&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%A7%8B%E9%80%A0&quot; aria-label=&quot;イメージファイルの構造 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;イメージファイルの構造&lt;/h2&gt;
&lt;p&gt;xv6は、&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;という2つのイメージファイルを使用して起動します。&lt;/p&gt;
&lt;h3 id=&quot;xv6img&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6img&quot; aria-label=&quot;xv6img permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6.img&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;は、以下のような構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefile&lt;/span&gt;
xv6.img: bootblock kernel
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;bootblock &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kernel &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;dd if=/dev/zero of=xv6.img count=10000&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;512*10^4&lt;/code&gt;バイト(51.2MBバイト)を&lt;code class=&quot;language-text&quot;&gt;/dev/zero&lt;/code&gt;から読みだして&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;として保存します。&lt;/p&gt;
&lt;p&gt;ddコマンドのブロックサイズ(&lt;code class=&quot;language-text&quot;&gt;bs&lt;/code&gt;)はデフォルトで512であるため、このような挙動になります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;conv=notrunc&lt;/code&gt;は、元のファイルのサイズを維持したまま、指定したバイナリの書き込みを行うオプションです。&lt;/p&gt;
&lt;p&gt;これによって、512バイトのbootblock が、&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;の先頭から書き込まれた際に、元の&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;のサイズが維持されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seek=1&lt;/code&gt;は、ブロック単位で書き込み開始位置をスキップするオプションです。&lt;/p&gt;
&lt;p&gt;ブロックサイズはデフォルトでは512であるため、&lt;code class=&quot;language-text&quot;&gt;dd if=kernel of=xv6.img seek=1 conv=notrunc&lt;/code&gt;は、先頭512バイト目からkernelを配置することを意味しています。&lt;/p&gt;
&lt;p&gt;これらのコマンドを見てわかる通り、&lt;code class=&quot;language-text&quot;&gt;512*10^4&lt;/code&gt;バイト(51.2MBバイト)の空のイメージファイルを生成した後、先頭512バイトにbootblockを配置し、さらにその後にkernelを配置しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABiElEQVQ4y8WU6XaCMBBGff8Hah+gdtGiApGqaCsgFgmgHDZ3viZxpaL1X3POPWFmwiXDVsF+bLdbRFFUII5jJEki4Me/65vNRpyb5/lBg0oQ+IjY4vVqhW9KQcwRNMsWEMNCo9dHUx+ADM1Tnq2xnAm2ZcLlcon1es12uIE9cVHTh3gfGJAGJl47AzxUa3h8qeNZ0yF9mixviDXDsYOcdXUhxNlwPAeNLxmyQRiqmMlIEygmQWufaw5lGI5ZLuTBIeGHFF0qo+8T6B5HFce7WN3nCHqeAtszWcsn4YGC0Ju5+JjI6LkEXVdlEKijBhRLOsacjsuEtCgstHwhpDshn+t6FW/dp13MZL0rwuMOC8LQFYt1ry1knL6vCQ4xr3WpgrFnYZ4tQKmLsW0jCKbgD7ggpNMJa1GCNm6hfaS5ZxfzGrElWK7BdpjfbjlOYqTzBOkiZSTlsHrG6mE4E6/bzZazbI57B/96zoWlO8yyrHC1a4hu+Nf1L8J7x13CNE3FveHzX1z72/wARuV7fAc3xmkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ac56/image-8.webp 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/d3be9/image-8.webp 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/b0a15/image-8.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ff5a/image-8.png 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/e85cb/image-8.png 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;空になったままのスペースはシステムが使用します。&lt;/p&gt;
&lt;h3 id=&quot;fsimg&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#fsimg&quot; aria-label=&quot;fsimg permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;fs.img&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;は以下のような構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefile&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;UPROGS&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_cat&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_echo&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_forktest&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_grep&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_init&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_kill&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_ln&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_ls&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_mkdir&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_rm&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_sh&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_stressfs&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_usertests&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_wc&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_zombie&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;

mkfs: mkfs.c fs.h
	gcc -Werror -Wall -o &lt;span class=&quot;token function&quot;&gt;mkfs&lt;/span&gt; mkfs.c

fs.img: &lt;span class=&quot;token function&quot;&gt;mkfs&lt;/span&gt; README &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;UPROGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
	./mkfs fs.img README &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;UPROGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;各種コマンドプログラムの本体やREADMEが格納されています。&lt;/p&gt;
&lt;p&gt;ユーザが操作するディスクです。&lt;/p&gt;
&lt;h2 id=&quot;bootblockを読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootblock%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;bootblockを読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootblockを読む&lt;/h2&gt;
&lt;p&gt;まずはbootblockについてです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;bootblock: bootasm.S bootmain.c
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -fno-pic -O -nostdinc -I. -c bootmain.c
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -fno-pic -nostdinc -I. -c bootasm.S
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LDFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S bootblock.o &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; bootblock.asm
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJCOPY&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S -O binary -j .text bootblock.o bootblock
	./sign.pl bootblock&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ビルドオプションから見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;コンパイラ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9&quot; aria-label=&quot;コンパイラ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コンパイラ&lt;/h3&gt;
&lt;p&gt;以下は、Makefileの中の&lt;code class=&quot;language-text&quot;&gt;$(CC)&lt;/code&gt;に関連した箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Cross-compiling (e.g., on Mac OS X)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# TOOLPREFIX = i386-jos-elf&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Using native tools (e.g., on X86 Linux)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#TOOLPREFIX = &lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Try to infer the correct TOOLPREFIX if not set&lt;/span&gt;
ifndef TOOLPREFIX
TOOLPREFIX :&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; i386-jos-elf-objdump -i &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;^elf32-i386$$&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;i386-jos-elf-&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; objdump -i &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;elf32-i386&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;***&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** Error: Couldn&apos;t find an i386-*-elf version of GCC/binutils.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** Is the directory with i386-jos-elf-gcc in your PATH?&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** If your i386-*-elf toolchain is installed with a command&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** prefix other than &apos;i386-jos-elf-&apos;, set your TOOLPREFIX&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** environment variable to that prefix and run &apos;make&apos; again.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** To turn off this error, run &apos;gmake TOOLPREFIX= ...&apos;.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;***&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
endif

CC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;TOOLPREFIX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;gcc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;デフォルトでは&lt;code class=&quot;language-text&quot;&gt;gcc&lt;/code&gt;を使ってコンパイルします。&lt;/p&gt;
&lt;p&gt;もしLinuxではなくMacOSなどの環境でビルドする場合は、&lt;code class=&quot;language-text&quot;&gt;TOOLPREFIX&lt;/code&gt;の設定を変更してクロスコンパイルする必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/maru-n@github/items/9cf83944403b3fbb8422&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OS X Yosemiteでxv6をbuildして動かすまで - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、以下は&lt;code class=&quot;language-text&quot;&gt;CFLAGS&lt;/code&gt;の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;CFLAGS &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; -fno-pic -static -fno-builtin -fno-strict-aliasing -O2 -Wall -MD -ggdb -m32 -Werror -fno-omit-frame-pointer
CFLAGS &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token punctuation&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; -fno-stack-protector -E -x c /dev/null &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; -fno-stack-protector&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;オプションの部分については割愛しますが、デフォルトの設定を追っていきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/GNU_gcc/man1/gcc.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of GCC&lt;/a&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;オプション&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-pic&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;位置独立なコード(PIC)を生成しない&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-static&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;プログラムを静的リンクでコンパイルする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-builtin&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;コンパイラに組み込まれているビルドイン関数を利用しない&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-strict-aliasing&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;厳密なエイリアシングの無効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-O2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;サポートされているすべての最適化オプションを有効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-Wall&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;すべてのコンパイラの警告メッセージを有効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-MD&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;システムヘッダーファイルとユーザーヘッダーファイルの両方を一覧&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-ggdb&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;gdbを対象としたデバッグ情報を生成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-m32&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;32bitオブジェクトとしてコンパイル&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-Werror&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;未使用の関数引数があった場合、コンパイルエラーとする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-omit-frame-pointer&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;フレームポインタを必要としない関数のレジスタにもフレームポインタを保持する&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;メモ位置独立なコードpic&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E4%BD%8D%E7%BD%AE%E7%8B%AC%E7%AB%8B%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89pic&quot; aria-label=&quot;メモ位置独立なコードpic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモ：位置独立なコード(PIC)&lt;/h3&gt;
&lt;p&gt;位置独立なコード(PIC)または位置独立実行形式(PIE)とは、メモリのどこに配置されても正しく実行できる機械語を指します。&lt;/p&gt;
&lt;p&gt;PICは主に共有ライブラリなどに利用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://0xcc.net/blog/archives/000107.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Linux の共有ライブラリを作るとき PIC でコンパイルするのはなぜか - bkブログ&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;bootmaincの全体像&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot; aria-label=&quot;bootmaincの全体像 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootmain.cの全体像&lt;/h3&gt;
&lt;p&gt;xv6のビルドを行う際、まず初めに以下の&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;から、&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;が生成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Boot loader.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Part of the boot block, along with bootasm.S, which calls bootmain().&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bootasm.S has put the processor into protected 32-bit mode.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bootmain() loads an ELF kernel image from the disk starting at&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// sector 1 and then jumps to the kernel entry routine.&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;types.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;memlayout.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SECTSIZE&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Wait for disk ready.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xC0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read a single sector at offset into dst.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Issue command.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// count = 1&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xE0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// cmd 0x20 - read sectors&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read data.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;insl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SECTSIZE&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read &apos;count&apos; bytes at &apos;offset&apos; from kernel into physical address &apos;pa&apos;.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Might copy more than asked.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  epa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Round down to sector boundary.&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Translate from bytes to sectors; kernel starts at sector 1.&lt;/span&gt;
  offset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If this is too slow, we could read lots of sectors at a time.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// We&apos;d write more to memory than asked, but it doesn&apos;t matter --&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// we load in increasing order.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;定義されている関数は以下の4つです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;void bootmain(void)&lt;/li&gt;
&lt;li&gt;void waitdisk(void)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;各関数の挙動については後で追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;bootblockoの全体像&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootblocko%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot; aria-label=&quot;bootblockoの全体像 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootblock.oの全体像&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;bootasm.o&lt;/code&gt;が生成され、先ほど生成した&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;とリンクされて&lt;code class=&quot;language-text&quot;&gt;bootblock.o&lt;/code&gt;が生成されます。&lt;/p&gt;
&lt;p&gt;以下は&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;

# Start the first CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment

  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60

  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS

  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call    bootmain

  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin

# Bootstrap GDT
.p2align 2                                # force 4 byte alignment
gdt:
  SEG_NULLASM                             # null seg
  SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)   # code seg
  SEG_ASM(STA_W, 0x0, 0xffffffff)         # data seg

gdtdesc:
  .word   (gdtdesc - gdt - 1)             # sizeof(gdt) - 1
  .long   gdt                             # address gdt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;中身を見る前に、ブートプログラムのリンクについて見てみます。&lt;/p&gt;
&lt;h3 id=&quot;ブートプログラムのリンク&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%BC%E3%83%88%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF&quot; aria-label=&quot;ブートプログラムのリンク permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブートプログラムのリンク&lt;/h3&gt;
&lt;p&gt;リンクは以下のコマンドで実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ld -m elf_i386 -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドは、複数のバイナリを結合し、新たな実行プログラムをコンパイルすることができるコマンドです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kazmax.zpp.jp/cmd/l/ld.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ld - コマンド (プログラム) の説明 - Linux コマンド集 一覧表&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上記のコマンドでは、&lt;code class=&quot;language-text&quot;&gt;elf_i386&lt;/code&gt;バイナリとしてリンクされます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://unix.stackexchange.com/questions/471056/gnu-linker-differences-between-the-different-32bit-emulation-modes?rq=1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - GNU Linker differences between the different 32bit emulation modes? - Unix &amp;#x26; Linux Stack Exchange&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-N&lt;/code&gt;オプションによってtextセクションとdataセクションは読み書き可能となり、&lt;code class=&quot;language-text&quot;&gt;start&lt;/code&gt;シンボルがエントリポイントとして扱われます。&lt;/p&gt;
&lt;p&gt;また、エントリポイントの開始アドレスは&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に定義されます。&lt;/p&gt;
&lt;p&gt;これは、x86CPUの場合は、起動時にBIOSのPOST(Power On Self Test)が実行された後、MBRからブートプログラムを読み込んで&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に展開し、ブートセクタとします。&lt;/p&gt;
&lt;p&gt;なぜこの位置に展開されるのかについては、以下の神記事に非常に詳しく書いてありました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.glamenv-septzen.net/view/614&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Assembler/なぜx86ではMBRが”0x7C00”にロードされるのか？(完全版) - Glamenv-Septzen.net&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;簡単にまとめると、ROM BIOSの必要とする最小メモリである32KBを開けておきたいというニーズと、0x0から0x3FFまでの範囲は割込みベクタとして予約されているため、結果としてブートセクタを32KBの末尾に置くことにしたとのことです。&lt;/p&gt;
&lt;p&gt;そのため、ブートセクタの領域512Bと、MBRのbootstrap用のデータ/スタック領域として512Bを確保した結果、&lt;code class=&quot;language-text&quot;&gt;0x7C00(32KB - 1024B)&lt;/code&gt;がブートセクタの先頭アドレスになったそうです。&lt;/p&gt;
&lt;p&gt;このあたりは過去に読んだ自作OS本にはあまり詳しく書いていなかった(気がする)のでとても参考になりました。&lt;/p&gt;
&lt;p&gt;これでブートプログラムが出来上がったので、まずは中身を見ていこうと思います。&lt;/p&gt;
&lt;h3 id=&quot;リアルモードとプロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモードとプロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードとプロテクトモード&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x86CPU&lt;/code&gt;では、起動時に&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;とソフトウェア互換のある「リアルモード」で起動します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;は16bitです。&lt;/p&gt;
&lt;p&gt;そのため、リアルモードは16bitで動作する状態になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Intel_8086&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここから、32bitに移行するための処理を追っていきます。&lt;/p&gt;
&lt;p&gt;リアルモードで動作する処理は以下の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;

# Start the first CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment

  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60

  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
{{ 省略 }}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;リアルモードで起動する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot; aria-label=&quot;リアルモードで起動する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードで起動する&lt;/h3&gt;
&lt;p&gt;以下では、&lt;code class=&quot;language-text&quot;&gt;.code16&lt;/code&gt;を先頭に書くことで、コードが16bitで実行される想定となるようにアセンブラに指示をしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;start&lt;/code&gt;セクションは、先ほどエントリポイントとしてリンクされたシンボルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/32395542/objdump-of-code16-and-code32-x86-assembly&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Objdump of .code16 and .code32 x86 assembly - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;cliとstiでcpu割込みを禁止&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cli%E3%81%A8sti%E3%81%A7cpu%E5%89%B2%E8%BE%BC%E3%81%BF%E3%82%92%E7%A6%81%E6%AD%A2&quot; aria-label=&quot;cliとstiでcpu割込みを禁止 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;cliとstiでCPU割込みを禁止&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;は、CPUの割込みを禁止する命令です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;が呼び出されてから、&lt;code class=&quot;language-text&quot;&gt;sti&lt;/code&gt;命令が呼び出されるまでの区間の処理は、CPUの割込みが禁止されます。(正確にはCPUからの割込み要求は発生するが無視される)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://c9x.me/x86/html/file_module_x86_id_31.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CLI : Clear Interrupt Flag (x86 Instruction Set Reference)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これは、BIOSに設定された割込みが有効化されたままだと、ブートプログラムの処理が正しく動作しなくなるためです。&lt;/p&gt;
&lt;p&gt;そのため、ブートプログラム側でスタックポインタや割込み設定を行っている間は、割込みを無効化しておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;セグメントレジスタの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;セグメントレジスタの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セグメントレジスタの初期化&lt;/h3&gt;
&lt;p&gt;次の4行では、AXレジスタ、DSレジスタ、ESレジスタ、SSレジスタをそれぞれ&lt;code class=&quot;language-text&quot;&gt;0x0000&lt;/code&gt;に初期化しています。&lt;/p&gt;
&lt;p&gt;AXレジスタはアキュムレータですが、他の3つのレジスタはセグメントレジスタです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Intel_8086&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/timwata/items/e7b7a18cc80b31fd940a&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 CPU 基礎 - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、BIOSに設定されたセグメントレジスタの値を初期化しています。&lt;/p&gt;
&lt;p&gt;一応各セグメントレジスタの用途について簡単に書いておきます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;レジスタ&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;DSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;データ用のデフォルトセグメントレジスタ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;ESレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;データ用のセグメントレジスタ&lt;br /&gt;通常はDSレジスタを使用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;SSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;スタック用のセグメントレジスタで、SPやBPによるメモリ参照時に使用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;CSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;コード用のセグメントレジスタ&lt;br /&gt;命令ポインタ(IP)はCSレジスタを使用&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.tamasoft.co.jp/lasm/help/lasm1to2.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;8086 のレジスタ&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;a20-lineの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#a20-line%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;a20 lineの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A20 Lineの有効化&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;では、後方互換のためにデフォルトでA20 Line(メモリアクセスの21番目のbit)が無効化されています。&lt;/p&gt;
&lt;p&gt;そのため、最大2MBのメモリ領域にアクセスするためには、A20 Lineを有効化する必要があります。&lt;/p&gt;
&lt;p&gt;A20 Lineは初めはKBC(キーボードコントローラ)に接続されています。&lt;/p&gt;
&lt;p&gt;KBCとは、キーボードからの入力をCPUに伝えるための機構です。&lt;/p&gt;
&lt;p&gt;KBCは、キーボードからシリアル通信で受け取った情報を一度バッファに格納し、KBCの制御コマンドか、CPUに転送する入力データかをチェックします。&lt;/p&gt;
&lt;p&gt;CPUに転送するデータの場合は&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;、制御コマンドの場合は&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;のポートからデータが転送されます。&lt;/p&gt;
&lt;p&gt;ここで、以下のコードではそれぞれ、KBCのバッファに未処理の入力がない状態を確認してから、&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;のポートにそれぞれ制御コマンドを送信することで、A20を有効化します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記の例では、制御コマンド&lt;code class=&quot;language-text&quot;&gt;0xd1&lt;/code&gt;をポート&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;に送信した後、&lt;code class=&quot;language-text&quot;&gt;0xdf&lt;/code&gt;がポート&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;に送信され、A20が有効になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/A20_Line&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;A20 Line - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://cstmize.hatenablog.jp/entry/2019/06/11/A20_gate%E3%81%A8keyboard_controller%E3%81%A8%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A%28xv6%E3%82%92%E4%BE%8B%E3%81%AB%E3%81%97%E3%81%A6%29&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;A20 gateとkeyboard controller(xv6を例にして) - 私のひらめき日記&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/15768683/the-a20-line-with-jos&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - The A20 Line with JOS - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモードへの移行&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C&quot; aria-label=&quot;プロテクトモードへの移行 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードへの移行&lt;/h3&gt;
&lt;p&gt;ここからプログラムの操作はプロテクトモードに移行します。&lt;/p&gt;
&lt;p&gt;プロテクトモードは「保護」リアルモードとは異なり、メモリ空間が保護されます。&lt;/p&gt;
&lt;p&gt;つまり、プロテクトモードではプログラムは許可されたメモリ空間にのみアクセスすることが可能となります。&lt;/p&gt;
&lt;p&gt;このため、リアルモードからプロテクトモードに移行する際には、ロードするカーネルがアクセス可能なメモリ空間を事前に定義する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;プロテクトモードへの移行自体は以下の行で行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;movl    %cr0, %eax
orl     $CR0_PE, %eax
movl    %eax, %cr0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;x86CPUでは、プロテクトモードを有効化するためにコントロールレジスタのPEフラグを1にする必要があります。&lt;/p&gt;
&lt;p&gt;上記のアセンブリコードでは、&lt;code class=&quot;language-text&quot;&gt;or&lt;/code&gt;演算を用いてコントロールレジスタのPEフラグを1に設定しています。&lt;/p&gt;
&lt;p&gt;これでプロテクトモードへの移行が完了します。&lt;/p&gt;
&lt;p&gt;※GDTの初期化を先に完了させておく必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモードでのメモリアドレス参照&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E5%8F%82%E7%85%A7&quot; aria-label=&quot;プロテクトモードでのメモリアドレス参照 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードでのメモリアドレス参照&lt;/h3&gt;
&lt;p&gt;プロテクトモードでは、メモリアドレスの参照のためにGDT(グローバルディスクリプタテーブル)が使用されます。&lt;/p&gt;
&lt;p&gt;GDT周りの機構については長くなったので別の記事にメモ書きとしてまとめました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/linux-got-plt&quot;&gt;x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;lgdt-gdtdesc&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#lgdt-gdtdesc&quot; aria-label=&quot;lgdt gdtdesc permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;lgdt gdtdesc&lt;/h3&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;lgdt&lt;/code&gt;命令はGDTのデータ構造をGDTRに登録するための命令です。&lt;/p&gt;
&lt;p&gt;ここに格納している&lt;code class=&quot;language-text&quot;&gt;gdtdesc&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;内で定義された以下のラベルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Bootstrap GDT
.p2align 2                                # force 4 byte alignment
gdt:
  SEG_NULLASM                             # null seg
  SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)   # code seg
  SEG_ASM(STA_W, 0x0, 0xffffffff)         # data seg

gdtdesc:
  .word   (gdtdesc - gdt - 1)             # sizeof(gdt) - 1
  .long   gdt                             # address gdt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.p2align 2&lt;/code&gt;は、この直後の命令やデータを4バイト境界に強制的に配置させます。&lt;/p&gt;
&lt;p&gt;これは、4の倍数のアドレスを開始点としてデータを配置することを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/2846914/what-is-meant-by-memory-is-8-bytes-aligned&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What is meant by “memory is 8 bytes aligned”? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行では、&lt;code class=&quot;language-text&quot;&gt;SEG_NULLASM&lt;/code&gt;マクロなどが配置されている行に&lt;code class=&quot;language-text&quot;&gt;gtd&lt;/code&gt;ラベルを付けています。&lt;/p&gt;
&lt;p&gt;これらのマクロは、&lt;code class=&quot;language-text&quot;&gt;asm.h&lt;/code&gt;で定義されている以下のマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;//
// assembler macros to create x86 segments
//

#define SEG_NULLASM                                             \
        .word 0, 0;                                             \
        .byte 0, 0, 0, 0

// The 0xC0 means the limit is in 4096-byte units
// and (for executable segments) 32-bit mode.
#define SEG_ASM(type,base,lim)                                  \
        .word (((lim) &amp;gt;&amp;gt; 12) &amp;amp; 0xffff), ((base) &amp;amp; 0xffff);      \
        .byte (((base) &amp;gt;&amp;gt; 16) &amp;amp; 0xff), (0x90 | (type)),         \
                (0xC0 | (((lim) &amp;gt;&amp;gt; 28) &amp;amp; 0xf)), (((base) &amp;gt;&amp;gt; 24) &amp;amp; 0xff)

#define STA_X     0x8       // Executable segment
#define STA_W     0x2       // Writeable (non-executable segments)
#define STA_R     0x2       // Readable (executable segments)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;x86CPUにおけるGDTは、基本的には8バイトのディスクリプタをいくつも並べた構造になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下は、&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;で紹介されていたディスクリプタの構造体です。&lt;/p&gt;
&lt;p&gt;こちらの方がxv6OSのコードよりもわかりやすかったので貼っておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SEGMENT_DESCRIPTOR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; limit_low&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base_low&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; base_mid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; access_right&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; limit_high&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base_high&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GDTの先頭(1つ目のディスクリプタ)には、すべての値が0に設定されたヌルディスクリプタを配置します。&lt;/p&gt;
&lt;p&gt;これはシステムからは参照されることはありません。&lt;/p&gt;
&lt;p&gt;ヌルディスクリプタはセグメントレジスタを無効化するために使用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/37861691/why-x86-processor-need-a-null-descriptor-in-gdt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Why x86 processor need a NULL descriptor in GDT? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;2番目のディスクリプタはコードセグメント、3番目のディスクリプタはデータセグメントのディスクリプタを定義しています。&lt;/p&gt;
&lt;p&gt;コードセグメントは読み取りと実行、データセグメントは書き込み権限が付与されています。&lt;/p&gt;
&lt;p&gt;最後に、このマクロで作成したGDTのアドレスを使用して、&lt;code class=&quot;language-text&quot;&gt;lgdt gdtdesc&lt;/code&gt;命令によってGDTRを初期化します。&lt;/p&gt;
&lt;p&gt;GDTRには48bitの値を格納します。&lt;/p&gt;
&lt;p&gt;上位32bitには、GDTの先頭アドレス(gdtラベル)が格納されます。&lt;/p&gt;
&lt;p&gt;下位16bitには、リミット値(GDTのエントリ数)が格納されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yz2cm.hatenadiary.org/entry/20140502/1399006500&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GDTR（Global Descriptor Table Register） - ゆずさん研究所&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;プログラムがLDTなどのディスクリプタを利用する際には、GDTRにセットされた先頭アドレスからのオフセットとして参照されることになります。&lt;/p&gt;
&lt;p&gt;これでGDTRの初期化が完了しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/67901342/why-in-xv6-theres-sizeofgdt-1-in-gdtdesc&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - Why in xv6 there’s sizeof(gdt)-1 in gdtdesc - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://jupiteroak.hatenablog.com/entry/2021/12/10/073000&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OS起動編⑮-2 entryother.S (Unix xv6を読む～OSコードリーディング～) - 野良プログラマーのCS日記&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;32bitモードの開始&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#32bit%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AE%E9%96%8B%E5%A7%8B&quot; aria-label=&quot;32bitモードの開始 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;32bitモードの開始&lt;/h3&gt;
&lt;p&gt;GDTRの初期化とプロテクトモードへの移行が完了したため、ここからは32bitモードで動作することになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令は第1オペランドにセグメントセレクタをとり、第2オペランドにオフセットアドレス(&lt;code class=&quot;language-text&quot;&gt;start32&lt;/code&gt;ラベル)を与えることで、セレクタに対応するセグメントベース+オフセットのアドレスにジャンプする命令です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KCODE&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;内で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// various segment selectors.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_KCODE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// kernel code&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_KDATA&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// kernel data+stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_UCODE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// user code&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_UDATA&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// user data+stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_TSS&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// this process&apos;s task state&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記より、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KCODE&amp;lt;&amp;lt;3)&lt;/code&gt;が定義するセグメントセレクタは、&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;これは、GDTの2つ目のセグメントであるコードセグメントを指します。&lt;/p&gt;
&lt;p&gt;セグメントセレクタは、以下のページの通り16bitで構成され、上位13bitにはディスクリプタのインデックス(GDTの先頭からのインデックス)が定義され、下位3bitにはテーブルインジゲータ(TI)と要求特権レベル(RPL)が定義されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yz2cm.hatenadiary.org/entry/20140502/1399012324&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;セグメント・セレクタ - ゆずさん研究所&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;TIが0の場合、GDTを参照します。(1の場合はLDTを参照)&lt;/p&gt;
&lt;p&gt;また、RPLが0の場合は、特権アクセスを意味します。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KCODE&amp;lt;&amp;lt;3)&lt;/code&gt;が定義するセグメントセレクタ&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;は、インデックスが1、TIが0、RPLが0と定義されたセグメントレジスタになります。&lt;/p&gt;
&lt;h3 id=&quot;なぜljmp命令を使用するのか&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%AA%E3%81%9Cljmp%E5%91%BD%E4%BB%A4%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B&quot; aria-label=&quot;なぜljmp命令を使用するのか permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;なぜljmp命令を使用するのか&lt;/h3&gt;
&lt;p&gt;このコードには少し違和感がありました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;%cr0&lt;/code&gt;の設定が完了してプロテクトモードに移行するところまで処理を進めた場合、わざわざ&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を呼び出さなくても&lt;code class=&quot;language-text&quot;&gt;start32&lt;/code&gt;の処理が呼び出されるはずです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
{{ 省略 }}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでわざわざ&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を使用しているのは、リアルモードで動作していた際にCPUが高速化のためにメモリから先読みした命令を破棄するためです。&lt;/p&gt;
&lt;p&gt;CPUには命令を高速に実行するためにパイプラインという仕組みがあり、これによって次の命令を先読みしています。&lt;/p&gt;
&lt;p&gt;しかし、プロテクトモードに移行するとリアルモードとは機械語の解釈が変わるため、これをリセットする必要がありまし。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を呼び出すことで、&lt;code class=&quot;language-text&quot;&gt;cs&lt;/code&gt;レジスタや&lt;code class=&quot;language-text&quot;&gt;eip&lt;/code&gt;レジスタの値がリロードされます。&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモード移行後の設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E7%A7%BB%E8%A1%8C%E5%BE%8C%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;プロテクトモード移行後の設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモード移行後の設定&lt;/h3&gt;
&lt;p&gt;あと少しで&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;の処理をすべて追うことができます。&lt;/p&gt;
&lt;p&gt;最後に見るのは以下の挙動です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;.code32  # Tell assembler to generate 32-bit code now.
start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS

  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call    bootmain

  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;セグメントレジスタの初期化-1&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96-1&quot; aria-label=&quot;セグメントレジスタの初期化 1 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セグメントレジスタの初期化&lt;/h3&gt;
&lt;p&gt;ここでは、CS以外のセグメントレジスタの初期化を行っています。&lt;/p&gt;
&lt;p&gt;リアルモードからプロテクトモードに移行したことで、セグメントセレクタの用法が変わりました。&lt;/p&gt;
&lt;p&gt;具体的には、リアルモードではメモリアドレスを参照する場合に、セグメント部を16倍してオフセットに加算する方式を取っていたものが、プロテクトモードではセグメントディスクリプタの参照に変わります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://atmarkit.itmedia.co.jp/icd/root/02/5785802.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Insider’s Computer Dictionary：8086 とは？ - ＠IT&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、プロテクトモードではセグメントレジスタにはセグメントセレクタを格納する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;セグメントセレクタは&lt;code class=&quot;language-text&quot;&gt;$(SEG_KDATA&amp;lt;&amp;lt;3)&lt;/code&gt;で設定されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KDATA&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;内で2と定義されていました。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KDATA&amp;lt;&amp;lt;3)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;これは、GDTの3番目に定義したセグメントディスクリプタ&lt;code class=&quot;language-text&quot;&gt;SEG_ASM(STA_W, 0x0, 0xffffffff)&lt;/code&gt;を指定するセレクタになります。&lt;/p&gt;
&lt;p&gt;これらの値を用いて、DS、ES、SSの各セグメントレジスタを初期化しています。&lt;/p&gt;
&lt;p&gt;また、FSとGSには0を格納しています。&lt;/p&gt;
&lt;p&gt;セグメントセレクタが0の場合、セグメントレジスタは無効化されます。&lt;/p&gt;
&lt;h3 id=&quot;bootmaincの呼び出し&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot; aria-label=&quot;bootmaincの呼び出し permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootmain.cの呼び出し&lt;/h3&gt;
&lt;p&gt;ここからは、&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;に処理が移行します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$start&lt;/code&gt;は初めに見た通り、&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に配置されています。&lt;/p&gt;
&lt;p&gt;つまり、スタックポインタ(スタックを積むベースのアドレス)は&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;になるわけですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set up the stack pointer and call into C.
movl    $start, %esp
call    bootmain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記より、今までの理解を図にするとこのようになるかと思います。(違ってたらごめんなさい)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://yukituna.com/wp-content/uploads/2022/01/image-15.png&quot; alt=&quot;https://yukituna.com/wp-content/uploads/2022/01/image-15.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ちなみに以下は&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;がReturnされた後の処理となるので今回は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのロード&lt;/h3&gt;
&lt;p&gt;ようやくプロテクトモードへの移行も完了し、処理が&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;に切り替わりました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;には、以下の4つの関数が定義されていますす。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;void bootmain(void)&lt;/li&gt;
&lt;li&gt;void waitdisk(void)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここからは&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;の挙動について追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;ディスクからelfカーネルイメージをロードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89elf%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;ディスクからelfカーネルイメージをロードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクからELFカーネルイメージをロードする&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootmain()&lt;/code&gt;は、ディスクからELFカーネルイメージをロードするための関数です。&lt;/p&gt;
&lt;p&gt;先頭から順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;始めに宣言されている構造体&lt;code class=&quot;language-text&quot;&gt;elfhdr&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;proghdr&lt;/code&gt;は、どちらも&lt;code class=&quot;language-text&quot;&gt;elf.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Format of an ELF executable file&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_MAGIC&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x464C457FU&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// &quot;\x7FELF&quot; in little endian&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// File header&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint magic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// must equal ELF_MAGIC&lt;/span&gt;
  uchar elf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort machine&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phoff&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint shoff&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort ehsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort phentsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shentsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shstrndx&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Program section header&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint off&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint vaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint filesz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint memsz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint align&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Values for Proghdr type&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_LOAD&lt;/span&gt;           &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Flag bits for Proghdr flags&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_EXEC&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_WRITE&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_READ&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この構造体の詳細については以下のページのままなので割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Executable and Linkable Format - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行の&lt;code class=&quot;language-text&quot;&gt;void (*entry)(void);&lt;/code&gt;では関数ポインタの宣言をしています。&lt;/p&gt;
&lt;p&gt;最終的に、ロードしたELFヘッダのエントリポイントを取得して呼び出します。&lt;/p&gt;
&lt;h3 id=&quot;ディスクからセクタを読み取る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89%E3%82%BB%E3%82%AF%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B&quot; aria-label=&quot;ディスクからセクタを読み取る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクからセクタを読み取る&lt;/h3&gt;
&lt;p&gt;次は以下の箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;elf = (struct elfhdr*)0x10000;&lt;/code&gt;の行は何をしているのかいまいちわかっていなかったのですが、&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;番地からの領域を&lt;code class=&quot;language-text&quot;&gt;elfhdr&lt;/code&gt;構造体としてキャストすることで、ポインタ変数&lt;code class=&quot;language-text&quot;&gt;elf&lt;/code&gt;を通してこの領域にアクセスできるようにしています。&lt;/p&gt;
&lt;p&gt;このポインタ変数&lt;code class=&quot;language-text&quot;&gt;elf&lt;/code&gt;は、次の行で&lt;code class=&quot;language-text&quot;&gt;unsigned char&lt;/code&gt;型のポインタにキャストされ、&lt;code class=&quot;language-text&quot;&gt;readseg&lt;/code&gt;関数の第1引数として渡されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vmm.dev/ja/lowlevel/xv6/xv6-1.md&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 のブートローダーを読む&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;readseg((uchar*)elf, 4096, 0);&lt;/code&gt;の行では、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf&lt;/code&gt;のアドレスに4096バイトのデータをロードします。&lt;/p&gt;
&lt;p&gt;ELFヘッダのサイズが52バイトであるにも関わらず4096バイトを読み込んでいる理由については下記が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/64795450/xv6-bootmain-loading-kernel-elf-header&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - XV6: bootmain - loading kernel ELF header - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;プログラム側からは、ELFヘッダとプログラムヘッダの組み合わせのサイズが呼び出し時点では不明なため、ELFヘッダとプログラムヘッダが4KBの範囲内に収まっていることを期待して、1ページ分のデータを読み込んでいる、という背景のようです。&lt;/p&gt;
&lt;p&gt;※x86CPUの1ページ分のサイズは4069バイト(4KB)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/11543748/why-is-the-page-size-of-linux-x86-4-kb-how-is-that-calculated&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Why is the page size of Linux (x86) 4 KB, how is that calculated? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;readseg&lt;/code&gt;関数は以下のようなコードです。&lt;/p&gt;
&lt;p&gt;内部の処理では、&lt;code class=&quot;language-text&quot;&gt;readsect&lt;/code&gt;関数によって2番目のセクタ(セクタ1)から、4096バイト分のデータを1セクタずつディスクから読み込み、&lt;code class=&quot;language-text&quot;&gt;uchar* pa&lt;/code&gt;の領域に書き込んでいきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Read &apos;count&apos; bytes at &apos;offset&apos; from kernel into physical address &apos;pa&apos;.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Might copy more than asked.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  epa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Round down to sector boundary.&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token comment&quot;&gt;// Translate from bytes to sectors; kernel starts at sector 1.&lt;/span&gt;
  offset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If this is too slow, we could read lots of sectors at a time.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// We&apos;d write more to memory than asked, but it doesn&apos;t matter --&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// we load in increasing order.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらが&lt;code class=&quot;language-text&quot;&gt;readsect&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Read a single sector at offset into dst.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Issue command.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// count = 1&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xE0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// cmd 0x20 - read sectors&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read data.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;insl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SECTSIZE&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このようなディスクの呼び出しは&lt;code class=&quot;language-text&quot;&gt;Cylinder-head-sector(CHS)&lt;/code&gt;と呼ばれる方法を使用しています。&lt;/p&gt;
&lt;p&gt;昨今のOSでこのようなディスク読み出しを実装しているものは(おそらく)無いのでCHSの詳細については割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Cylinder-head-sector&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Cylinder-head-sector - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/61028931/xv6-boot-loader-reading-sectors-off-disk-using-chs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - xv6 boot loader: Reading sectors off disk using CHS - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでなぜ&lt;code class=&quot;language-text&quot;&gt;offset = (offset / SECTSIZE) + 1;&lt;/code&gt;の行で、2番目のセクタ(セクタ1)からデータを読み込んでいるのかというと、Makefileの項で確認した通り、カーネルプログラムはイメージの先頭512バイトの位置に配置されているためです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABiElEQVQ4y8WU6XaCMBBGff8Hah+gdtGiApGqaCsgFgmgHDZ3viZxpaL1X3POPWFmwiXDVsF+bLdbRFFUII5jJEki4Me/65vNRpyb5/lBg0oQ+IjY4vVqhW9KQcwRNMsWEMNCo9dHUx+ADM1Tnq2xnAm2ZcLlcon1es12uIE9cVHTh3gfGJAGJl47AzxUa3h8qeNZ0yF9mixviDXDsYOcdXUhxNlwPAeNLxmyQRiqmMlIEygmQWufaw5lGI5ZLuTBIeGHFF0qo+8T6B5HFce7WN3nCHqeAtszWcsn4YGC0Ju5+JjI6LkEXVdlEKijBhRLOsacjsuEtCgstHwhpDshn+t6FW/dp13MZL0rwuMOC8LQFYt1ry1knL6vCQ4xr3WpgrFnYZ4tQKmLsW0jCKbgD7ggpNMJa1GCNm6hfaS5ZxfzGrElWK7BdpjfbjlOYqTzBOkiZSTlsHrG6mE4E6/bzZazbI57B/96zoWlO8yyrHC1a4hu+Nf1L8J7x13CNE3FveHzX1z72/wARuV7fAc3xmkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ac56/image-8-16455921223972.webp 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/d3be9/image-8-16455921223972.webp 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/b0a15/image-8-16455921223972.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ff5a/image-8-16455921223972.png 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/e85cb/image-8-16455921223972.png 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、&lt;code class=&quot;language-text&quot;&gt;\#define SECTSIZE  512&lt;/code&gt;とある通り、1セクタ分のサイズが512バイトと定義されています。&lt;/p&gt;
&lt;p&gt;そのため、2セクタ目の先頭にはカーネルの先頭バイトが存在していることが期待されます。&lt;/p&gt;
&lt;h3 id=&quot;読み込んだカーネルの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;読み込んだカーネルの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;読み込んだカーネルの確認&lt;/h3&gt;
&lt;p&gt;次の処理では、カーネルが正常に読み込まれているか確認するため、マジックナンバを参照しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プログラムヘッダの読み込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;プログラムヘッダの読み込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プログラムヘッダの読み込み&lt;/h3&gt;
&lt;p&gt;続いて、プログラムヘッダを読み込みます。&lt;/p&gt;
&lt;p&gt;基本的にはカーネルを読み込んだ際とほとんど同じ挙動のようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;のアドレスを&lt;code class=&quot;language-text&quot;&gt;proghdr&lt;/code&gt;構造体としてキャストします。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;はプログラムヘッダの開始オフセットです。&lt;/p&gt;
&lt;p&gt;先ほど4096バイト分のデータを読み込んだことで、ELFヘッダとともにプログラムヘッダもすべて読み込まれていることが期待されているため、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;の位置にはすでにプログラムヘッダの情報が格納されています。&lt;/p&gt;
&lt;p&gt;ここから、各プログラムセグメントのデータをロードします。&lt;/p&gt;
&lt;p&gt;この処理によって、実際に実行されるプログラムがロードされます。&lt;/p&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;stosb&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;で定義されており、&lt;code class=&quot;language-text&quot;&gt;ph-&gt;memsz&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;ph-&gt;filesz&lt;/code&gt;よりも大きい場合に0埋めするために利用されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;cld; rep stosb&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;=D&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;=c&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;memory&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;cc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/27958743/difference-between-p-filesz-and-p-memsz-of-elf32-phdr/31011428#31011428&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;elf - Difference between p&lt;em&gt;filesz and p&lt;/em&gt;memsz of Elf32_Phdr - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これでディスクからカーネルプログラムを読み込むことができたので、以降の処理はカーネルに任せることとなります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;結構時間がかかりましたがxv6 UNIXのブートストラップについて深掘りしつつ読み込みました。&lt;/p&gt;
&lt;p&gt;次回からようやく本題(カーネルのソースコードを読む)に入れそうです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)]]></title><description><![CDATA[UNIXのソースコードを読む中で、起動時のプロテクトモードへの移行プロセスが気になったので調べたことをまとめました。]]></description><link>https://kashiwaba-yuki.com/linux-memory-protect-gdt-ldt</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-memory-protect-gdt-ldt</guid><pubDate>Sun, 09 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;UNIXのソースコードを読む中で、起動時のプロテクトモードへの移行プロセスが気になったので調べたことをまとめました。&lt;/p&gt;
&lt;p&gt;技術的に誤りが無いように努めていますが、もし万が一誤りがあればご指摘いただけると助かります。&lt;/p&gt;
&lt;p&gt;今回は、Intelのx86CPUをターゲットとしています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモードとプロテクトモード&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;プロテクトモード&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E4%BF%9D%E8%AD%B7&quot;&gt;プロテクトモードにおけるメモリ保護&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;ディスクリプタテーブルについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gdt%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot;&gt;GDT(グローバルディスクリプタテーブル)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ldt%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot;&gt;LDT(ローカルディスクリプタテーブル)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;リアルモードとプロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモードとプロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードとプロテクトモード&lt;/h2&gt;
&lt;h3 id=&quot;リアルモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモード&lt;/h3&gt;
&lt;p&gt;x86CPUにおけるリアルモードとは、&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;CPU互換のための動作モードです。&lt;/p&gt;
&lt;p&gt;x86の場合は起動時の動作モードとなり、BIOSもリアルモードで動作します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;CPU互換のため、リアルモードはすべてのレジスタのアドレス長が16bitに制限されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リアルモード - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;メモリアドレスを参照する場合はセグメントレジスタの値を使用して、20bitのアドレス空間にアクセスすることができます。&lt;/p&gt;
&lt;p&gt;また、A20 Lineを有効化することで21bitのアドレス空間を使用することができるようになります。&lt;/p&gt;
&lt;p&gt;リアルモードでは、後述するプロテクトモードに存在する、ハードウェアベースのメモリ保護や仮想メモリは存在しません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Real_Mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Real Mode - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;プロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモード&lt;/h3&gt;
&lt;p&gt;プロテクトモードは、x86CPUにおいてメモリ空間が32bitに拡張され、メモリやI/Oの保護が可能となる動作モードです。&lt;/p&gt;
&lt;p&gt;階層的な特権管理(リングプロテクション)とタスク間のメモリ保護が可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロテクトモード - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Protected_Mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Protected Mode - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;前述した通り、x86CPUにおいてBIOSはリアルモードで動作しているため、プロテクトモード移行後はBIOS割込みを使用できなくなります。&lt;/p&gt;
&lt;p&gt;プロテクトモードにおけるメモリ保護の仕組みについては後述します。&lt;/p&gt;
&lt;h2 id=&quot;プロテクトモードにおけるメモリ保護&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E4%BF%9D%E8%AD%B7&quot; aria-label=&quot;プロテクトモードにおけるメモリ保護 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードにおけるメモリ保護&lt;/h2&gt;
&lt;p&gt;プロテクトモードでは、プログラムに対して参照可能なメモリ領域を定義する必要があります。これはカーネルプログラムにおいても同様です。&lt;/p&gt;
&lt;p&gt;まず、x86CPUはプログラムやデータをセグメントというメモリ内の連続した領域の単位で扱います。&lt;/p&gt;
&lt;p&gt;セグメントの単位は64KBか4GBの2種類があります。&lt;/p&gt;
&lt;p&gt;プロテクトモードにおけるメモリ保護では、メモリ領域の開始点とサイズ、そのメモリ領域の読み/書き/実行権限などをセグメントディスクリプタとよび、ディスクリプタテーブルによって管理します。&lt;/p&gt;
&lt;p&gt;プロテクトモードでプログラムがメモリを参照する場合、DSレジスタは直接メモリアドレスの値を指しません。&lt;/p&gt;
&lt;p&gt;その代わり、DSレジスタはディスクリプタテーブルを参照し、セグメントの情報を取得します。&lt;/p&gt;
&lt;p&gt;この仕組みによって、プログラムが自由なメモリ領域を参照するためにはディスクリプタテーブルの書き換えが必須となります。&lt;/p&gt;
&lt;p&gt;しかし、ディスクリプタテーブルはプログラムから書き換えられないようになっているため、結果としてプログラムはあらかじめ決められたメモリ領域以外を参照できず、メモリの保護が実現されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3JVSphh&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsはなぜ動くのか&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ascii.jp/elem/000/000/649/649680/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ASCII.jp：Windowsのメモリー管理をx86の仕組みから読み解く (1/4)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ディスクリプタテーブルについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;ディスクリプタテーブルについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクリプタテーブルについて&lt;/h2&gt;
&lt;p&gt;ディスクリプタテーブルには、GDT(グローバルディスクリプタテーブル)とLDT(ローカルディスクリプタテーブル)の2種類が存在します。&lt;/p&gt;
&lt;h3 id=&quot;gdtグローバルディスクリプタテーブル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdt%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot; aria-label=&quot;gdtグローバルディスクリプタテーブル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GDT(グローバルディスクリプタテーブル)&lt;/h3&gt;
&lt;p&gt;GDTは、通常システムに1つだけ定義されるディスクリプタテーブルです。&lt;/p&gt;
&lt;p&gt;GDTでは複数のLDTが管理されます。&lt;/p&gt;
&lt;p&gt;x86CPUには、GDTの先頭アドレスを指すためのGDTRと呼ばれるレジスタが存在します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ldtローカルディスクリプタテーブル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ldt%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot; aria-label=&quot;ldtローカルディスクリプタテーブル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;LDT(ローカルディスクリプタテーブル)&lt;/h3&gt;
&lt;p&gt;LDTはプログラムごとに作成されるディスクリプタテーブルです。&lt;/p&gt;
&lt;p&gt;x86CPUでは、プログラムはディスクリプタテーブルで定義されたアドレス以外の領域にはアクセスできません。&lt;/p&gt;
&lt;p&gt;そのため、プログラムごとに競合しないディスクリプタテーブルをOSが管理することによって、各プログラムが互いのメモリ領域を参照することを防ぎ、メモリ保護を実現することができます。&lt;/p&gt;
&lt;p&gt;x86CPUには、GDTRと同様に、現在使用しているLDTの先頭アドレスを指定するためのレジスタとしてLDTRが用意されています。&lt;/p&gt;
&lt;p&gt;プログラムがセグメントレジスタに値をセットしようとしたとき、CPUはLDTRを参照し、プログラムがアクセスしようとしているアドレスの参照と、アクセス可否の検証を行います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;x86CPUにおけるプログラム実行時の流れを整理すると、まずプログラムが実行状態に切り替わるとき、CPUはGDTRから参照したGDTより、実行対象のLDTのインデックスを特定して、LDTRに格納しておきます。&lt;/p&gt;
&lt;p&gt;プログラムが特定のセグメントに対して参照を要求した場合、CPUはLDTRからLDTを参照して、参照先のアドレスの取得と参照可否の検証を行います。&lt;/p&gt;
&lt;p&gt;この一連の処理によって、プログラムはあらかじめ定義されたメモリ領域以外を参照することができず、メモリ保護が実現されます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JVSphh&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsはなぜ動くのか&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[GOT/PLTを経由したライブラリ関数呼び出しの流れを追う]]></title><description><![CDATA[GOTとPLTの概要についてまとめるとともに実際に検証してみた内容をまとめています。]]></description><link>https://kashiwaba-yuki.com/linux-got-plt</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-got-plt</guid><pubDate>Thu, 06 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は、GOTとPLTの概要についてまとめるとともに実際に検証を行っていきます。&lt;/p&gt;
&lt;p&gt;この記事を書き始めたきっかけとしては、位置独立コード(PIC)について調べていく中でGOTがよくわからなくなってしまったことです。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E5%8B%95%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF&quot;&gt;共有ライブラリと動的リンク&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C&quot;&gt;共有ライブラリ関数呼び出しの流れ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#got&quot;&gt;GOT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#plt&quot;&gt;PLT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#got%E3%81%A8plt%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E8%BF%BD%E3%81%86&quot;&gt;GOTとPLTの動きを追う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;ソースコードとビルド&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%87%BA%E5%8A%9B&quot;&gt;仮想メモリの出力&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#call%E5%91%BD%E4%BB%A4&quot;&gt;call命令&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot;&gt;共有ライブラリ関数の呼び出し&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;共有ライブラリと動的リンク&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E5%8B%95%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF&quot; aria-label=&quot;共有ライブラリと動的リンク permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリと動的リンク&lt;/h2&gt;
&lt;p&gt;多くのELFバイナリではライブラリ関数(あらかじめ定義されているよく使う便利な関数)が動的リンクによってリンクされています。&lt;/p&gt;
&lt;p&gt;動的リンクとは、プログラムの実行に必要なライブラリ関数などの本体を、プログラムの実行時にリンクする仕組みのことです。&lt;/p&gt;
&lt;p&gt;動的リンクと対になる方式としては、必要なライブラリ関数などをすべて1つのプログラムにあらかじめリンクしておく静的リンクがあります。&lt;/p&gt;
&lt;p&gt;ライブラリ関数などのように複数のプログラムが共通して使用する関数やモジュールを動的リンクにすることで、プログラム自体のファイルサイズの削減や、実行時のメモリ使用量を効率化できるといったメリットがあります。&lt;/p&gt;
&lt;p&gt;ELFバイナリがどの共有ライブラリに依存しているかは、&lt;code class=&quot;language-text&quot;&gt;ldd&lt;/code&gt;コマンドで調べることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ldd test.o
	linux-vdso.so.1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007ffdb417f000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	libc.so.6 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /lib/x86_64-linux-gnu/libc.so.6 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f02af5ca000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	/lib64/ld-linux-x86-64.so.2 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f02af7d7000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/ld.so/man1/ldd.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of LDD&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では、動的リンクされた共有ライブラリをプログラムの実行時にリンクする仕組みについてまとめます。&lt;/p&gt;
&lt;h2 id=&quot;共有ライブラリ関数呼び出しの流れ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C&quot; aria-label=&quot;共有ライブラリ関数呼び出しの流れ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリ関数呼び出しの流れ&lt;/h2&gt;
&lt;p&gt;ライブラリ関数が動的リンクされたELFバイナリを実行する場合、ライブラリ関数は実際に処理の中で呼び出されるタイミングまでバインドされません。&lt;/p&gt;
&lt;p&gt;このような仕組みは遅延バインドと呼ばれ、PLT(Procedure Linkage Table)によってサポートされます。&lt;/p&gt;
&lt;p&gt;プログラムの実行時に共有ライブラリ関数が呼び出されるとき、最初に呼び出されるアドレスは共有ライブラリ関数の実態ではなく、&lt;code class=&quot;language-text&quot;&gt;.plt&lt;/code&gt;セクションのエントリになります。&lt;/p&gt;
&lt;p&gt;呼び出されたPLTのエントリは、その後GOT(Global Offset Table)と呼ばれる領域にジャンプします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;got&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#got&quot; aria-label=&quot;got permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GOT&lt;/h2&gt;
&lt;p&gt;GOT(Global Offset Table)はELFファイルとしてコンパイルされたプログラムを正しく実行できるようにするために使用されるコンピュータプログラム（実行可能ファイルおよび共有ライブラリ）メモリのセクションを指します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Offset_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Offset Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;簡潔に言うと、GOTはライブラリ関数のアドレス一覧を保持するための領域です。&lt;/p&gt;
&lt;p&gt;この領域は、プログラムの実行時に使用するライブラリ関数のアドレスが設定されます。&lt;/p&gt;
&lt;p&gt;GOTによて、ライブラリ関数をプロセスメモリ空間の中に再配置することが容易になります。&lt;/p&gt;
&lt;h2 id=&quot;plt&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#plt&quot; aria-label=&quot;plt permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PLT&lt;/h2&gt;
&lt;p&gt;PLT(Procedure Linkage Table)は、ライブラリ関数を呼び出すための小さなコードの集合です。&lt;/p&gt;
&lt;p&gt;PLTには、GOTが保持するライブラリ関数と同数のコードが配置されています。&lt;/p&gt;
&lt;p&gt;PLTの持つコードの挙動は、GOTに設定されている値にジャンプすることです。&lt;/p&gt;
&lt;p&gt;PLTのコードが呼び出されたとき、GOTにまだ呼び出し先の関数のアドレスが設定されていない場合は、アドレスをGOTに設定してからジャンプを行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://keichi.dev/post/plt-and-got/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PLTとGOTってなんだっけ · Keichi Takahashi&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;gotとpltの動きを追う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#got%E3%81%A8plt%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E8%BF%BD%E3%81%86&quot; aria-label=&quot;gotとpltの動きを追う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GOTとPLTの動きを追う&lt;/h2&gt;
&lt;p&gt;ここからは、実際にGDBを使ってメモリマップを見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;ソースコードとビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;ソースコードとビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ソースコードとビルド&lt;/h3&gt;
&lt;p&gt;今回検証に使用するのは以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次のコマンドでコンパイルし、gdbで起動しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gcc -fcf-protection&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;none -no-pie -g test.c -o test.o
gdb ./test.o&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;仮想メモリの出力&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%87%BA%E5%8A%9B&quot; aria-label=&quot;仮想メモリの出力 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想メモリの出力&lt;/h3&gt;
&lt;p&gt;Linuxには、現在稼働しているプロセスのための疑似ディレクトリとして&lt;code class=&quot;language-text&quot;&gt;/proc&lt;/code&gt;ディレクトリが容易されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/proc&lt;/code&gt;ディレクトリの直下には稼働中のプロセスのPIDに対応した数字のディレクトリがあり、その中にプロセス制御テーブルがマッピングされています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://uralowl.my.coocan.jp/unix/job/ORACLE/oracle/pmap_linux.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロセスのメモリマップについて (Linux)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/1401359/understanding-linux-proc-pid-maps-or-proc-self-maps&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;embedded - Understanding Linux /proc/pid/maps or /proc/self/maps - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は、プロセスのメモリマップを確認するため、以下のコマンドを使用しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; /proc/&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;pidof test.o&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;/maps
address           	permission offset   device inode   				   pathname
00400000-00401000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00401000-00402000 r-xp 00001000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00402000-00403000 r--p 00002000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00403000-00404000 r--p 00002000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00404000-00405000 rw-p 00003000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
7ffff7dc3000-7ffff7de8000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7de8000-7ffff7f60000 r-xp 00025000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7f60000-7ffff7faa000 r--p 0019d000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7faa000-7ffff7fab000 ---p 001e7000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fab000-7ffff7fae000 r--p 001e7000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fae000-7ffff7fb1000 rw-p 001ea000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fb1000-7ffff7fb7000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; 
7ffff7fcb000-7ffff7fce000 r--p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vvar&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
7ffff7fce000-7ffff7fcf000 r-xp 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vdso&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
7ffff7fcf000-7ffff7fd0000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7fd0000-7ffff7ff3000 r-xp 00001000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ff3000-7ffff7ffb000 r--p 00024000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffc000-7ffff7ffd000 r--p 0002c000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffd000-7ffff7ffe000 rw-p 0002d000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; 
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vsyscall&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maps&lt;/code&gt;は、プロセスまたはスレッド内の連続する仮想メモリの領域を示しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;address&lt;/code&gt;にはプロセスのアドレス空間内の領域の開始アドレスと終了アドレスが、&lt;code class=&quot;language-text&quot;&gt;permission&lt;/code&gt;にはその領域の権限が記録されています。&lt;/p&gt;
&lt;p&gt;上記の結果から、この&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/libc-2.31.so&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/ld-2.31.so&lt;/code&gt;の2つの共有ライブラリが使用されていることがわかります。&lt;/p&gt;
&lt;p&gt;ここで、共有ライブラリ&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/ld-2.31.so&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;7ffff7fcf000&lt;/code&gt;にマッピングされていますが、これは固定されたアドレスではありません。&lt;/p&gt;
&lt;p&gt;共有ライブラリが展開されるメモリアドレスは、プログラムの実行時に決定され、場合によっては異なるアドレスに展開されることもあります。&lt;/p&gt;
&lt;p&gt;ここで、プログラムの実行時に、共有ライブラリが実際にどのメモリアドレスに展開されたのかを調べて呼び出すための仕組みがPLTとGOTです。&lt;/p&gt;
&lt;h3 id=&quot;call命令&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#call%E5%91%BD%E4%BB%A4&quot; aria-label=&quot;call命令 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;call命令&lt;/h3&gt;
&lt;p&gt;アセンブリソースから、関数を呼び出す&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令の箇所を抜粋しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ disas main
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; main:
   0x000000000040113e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;3&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401126 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;test&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x0000000000401146 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x000000000040114e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;9&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令は以下の2つの処理を組み合わせた処理を実行する命令です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令の次のアドレス(関数がreturnした後に実行する命令)をスタックにプッシュする&lt;/li&gt;
&lt;li&gt;呼び出し先の関数のアドレスにジャンプする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vanya.jp.net/os/x86call/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86アセンブリ言語での関数コール&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで、2つの&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令のアセンブリをそれぞれ出力してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 0x401126 &amp;lt;test&gt;&lt;/span&gt;
$ disas 0x401126
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; test:
   0x0000000000401126 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	push   rbp
   0x0000000000401127 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	mov    rbp,rsp
   0x000000000040112a &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	mov    eax,0x0
   0x000000000040112f &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;9&lt;/span&gt;&gt;&lt;/span&gt;:	pop    rbp
   0x0000000000401130 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	ret    
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 0x401030 &amp;lt;rand@plt&gt;&lt;/span&gt;
$ disas 0x401030
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; rand@plt:
   0x0000000000401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
   0x0000000000401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
   0x000000000040103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを見比べたときに、ユーザ関数の&lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt;は直接関数が&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;されているのに対して、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;を呼び出す際は&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が呼び出されていることがわかります。&lt;/p&gt;
&lt;p&gt;そして、&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が呼び出された場合は最初の&lt;code class=&quot;language-text&quot;&gt;JMP&lt;/code&gt;命令で&lt;code class=&quot;language-text&quot;&gt;rand@got.plt&lt;/code&gt;が呼び出されます。&lt;/p&gt;
&lt;p&gt;これはまだGOTに呼び出し先のアドレスが設定されていないためです。&lt;/p&gt;
&lt;h3 id=&quot;共有ライブラリ関数の呼び出し&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot; aria-label=&quot;共有ライブラリ関数の呼び出し permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリ関数の呼び出し&lt;/h3&gt;
&lt;p&gt;次に、1回目と2回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し点にそれぞれブレークポイントを設定して、PLTからGOTを経て共有ライブラリ関数のバインドが行われる前後のGOTの変化を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x401146
$ b *0x40114e
$ run&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで、1回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し点に到達しました。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;のディスアセンブル結果から、対応するGOTのアドレスは&lt;code class=&quot;language-text&quot;&gt;0x404018&lt;/code&gt;であることがわかっています。&lt;/p&gt;
&lt;p&gt;つまり、最終的に&lt;code class=&quot;language-text&quot;&gt;0x404018&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数本体のアドレスが格納される想定になります。&lt;/p&gt;
&lt;p&gt;しかし、現時点ではまだ&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数はプログラムの実行時に一度も呼び出されていないため、GOTには&lt;code class=&quot;language-text&quot;&gt;rand@plt+6&lt;/code&gt;のアドレスが格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ telescope 0x404018
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x404018 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x401036 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gef.readthedocs.io/en/master/commands/dereference/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Command dereference - GEF - GDB Enhanced Features documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rand@plt+6&lt;/code&gt;のアドレスの処理は、スタックに値(0x0)を積んだ後に&lt;code class=&quot;language-text&quot;&gt;0x401020&lt;/code&gt;へのジャンプを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ disas 0x401030
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; rand@plt:
   0x0000000000401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
   0x0000000000401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
   0x000000000040103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この後の処理は、以下のようにさらにスタックに値を格納した後、&lt;code class=&quot;language-text&quot;&gt;0x404010&lt;/code&gt;に格納されているアドレスにジャンプする処理が続きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/16 0x401020
   0x401020:	push   QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404008&lt;/span&gt;
   0x401026:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404010&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x401036&lt;/code&gt;にブレークポイントを設定し、その後の処理を追ってみると次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x401026:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404010&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x40102c:	nop    DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rax+0x0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x40103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;-&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;   0x7ffff7fe7bb0:	endbr64 
       0x7ffff7fe7bb4:	push   rbx
       0x7ffff7fe7bb5:	mov    rbx,rsp
       0x7ffff7fe7bb8:	and    rsp,0xffffffffffffffc0
       0x7ffff7fe7bbc:	sub    rsp,QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x14b45&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x7ffff7ffc708 &amp;lt;_rtld_global_ro+232&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで呼び出している関数は&lt;code class=&quot;language-text&quot;&gt;_dl_runtime_resolve&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;詳しくは以下が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://syst3mfailure.io/ret2dl_resolve&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ret2dl_resolve x64&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この関数では、呼び出し先の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数のアドレスを解決して、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数を呼び出します。&lt;/p&gt;
&lt;p&gt;この際にGOTが更新されるため、次回以降の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し時には、解決された&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数のアドレスがGOTから直接呼び出されます。&lt;/p&gt;
&lt;p&gt;実際に2回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し時点で停止させ、先ほどと同じように&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が参照するGOTの中身を確認すると、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数本体のアドレスが格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ telescope 0x404018
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x404018 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x7ffff7e0de90 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	endbr64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;そのため、2回目の実行時には&lt;code class=&quot;language-text&quot;&gt;_dl_runtime_resolve&lt;/code&gt;は呼び出されず、直接&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数が実行されます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;UNIXのコードを読んでいたはずが、気づいたらGOTとPLTのことを調べてました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;読むともっと詳しく書いてあったので、GOT Overwriteなども試しつつもう少し深掘りしてみようと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3n114Fn&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debug Hacks -デバッグを極めるテクニック&amp;#x26;ツール&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-010-socket</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-010-socket</guid><pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;リバースエンジニアリング能力向上とWinDbgのプロになるため、自作のモジュールをリバーシングしてます。&lt;/p&gt;
&lt;p&gt;今回は、C言語で実装したWindowsのソケット通信プログラムを解析していきます。&lt;/p&gt;
&lt;p&gt;※検証目的に作成したプログラムでエラー処理などは実装していないため実用性は担保しません。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot;&gt;今回作成したプログラム&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#winsock2&quot;&gt;winsock2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#pragma-comment&quot;&gt;pragma comment()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ws2tcpiph&quot;&gt;ws2tcpip.h&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0&quot;&gt;POSTリクエストを送信する関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;WSADATAの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A&quot;&gt;通信先の指定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;Socketの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B&quot;&gt;コネクションの確立&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1&quot;&gt;HTTPリクエストの送信&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0&quot;&gt;UDP通信を行う関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;通信の確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B&quot;&gt;リバーシングする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Ghidraでデコンパイルする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;WinDbgでTTDトレースを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86&quot;&gt;Socketの中身を追う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88&quot;&gt;作成されたソケット&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;sockaddr_in構造体を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回作成したプログラム&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot; aria-label=&quot;今回作成したプログラム permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回作成したプログラム&lt;/h2&gt;
&lt;p&gt;今回作成したプログラムは以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/build/c/win_tcp_udp.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/win&lt;em&gt;tcp&lt;/em&gt;udp.c&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の2つの機能を実装してます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TCPコネクションを確立してPOSTリクエストを送信する&lt;/li&gt;
&lt;li&gt;UDPでデータを送信する&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ヘッダファイルは以下のものを使用してます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;winsock2.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdint.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;pragma&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token function&quot;&gt;comment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lib&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ws2_32.lib&quot;&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// IPアドレスを扱う場合などに利用&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;ws2tcpip.h&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;iphlpapi.h&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #pragma comment(lib, &quot;iphlpapi.lib&quot;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// winsock2.h と併用して使用する場合は、必ずwinsock2.hより後に定義する&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;windows.h&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;winsock2&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#winsock2&quot; aria-label=&quot;winsock2 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;winsock2&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;は、Windows Sockets 2を含むいくつかの実装を行う際に使用するヘッダファイルです。&lt;/p&gt;
&lt;p&gt;Windows環境におけるソケット通信に使用するAPI関数などが含まれています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Winsock2.h header - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/_winsock/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows Sockets 2 - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Winsock&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Winsock - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsでソケットプログラミングを行う際の最初の一歩は、この&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;で定義されている&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数を使って&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の初期化を行うことです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock/ns-winsock-wsadata&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WSADATA (winsock.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsastartup&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WSAStartup function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数は使用するWindows Socketsのバージョンと、初期化する&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の2つを引数に取ります。&lt;/p&gt;
&lt;p&gt;少々ややこしい点として、&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数の第一引数は、16bit符号なし整数(WORD型)を取りますが、下位8bitにWindows Socketsのメジャーバージョン、上位8bitにマイナーバージョンを指定する必要があります。&lt;/p&gt;
&lt;p&gt;そのため、引数に与える値は&lt;code class=&quot;language-text&quot;&gt;MAKEWORD&lt;/code&gt;マクロを使用して作成しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms632663(v=vs.85)&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;MAKEWORD macro (Windows) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、初期化に成功した場合、&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数は戻り値0を返し、失敗した場合は定義されているエラーコードのいずれかを返します。&lt;/p&gt;
&lt;p&gt;そのため、今回の実装には含めていませんが&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数の戻り値でエラー処理を実装します。&lt;/p&gt;
&lt;h3 id=&quot;pragma-comment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pragma-comment&quot; aria-label=&quot;pragma comment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;pragma comment()&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;などのヘッダファイルをインクルードしてコンパイルしようとすると、&lt;code class=&quot;language-text&quot;&gt;error LNK2019: 未解決の外部シンボル&lt;/code&gt;のようなエラーが返ってくる場合があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__closesocket@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__connect@12 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__htons@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__inet_addr@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__send@16 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__sendto@24 が関数 _send_udp で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__socket@12 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__WSAStartup@8 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__WSACleanup@0 が関数 _send_http_post で参照されました
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;\build\bin\win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe : fatal error LNK1120: 9 件の未解決の外部参照&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、コンパイラがライブラリをリンクできないことで発生します。&lt;/p&gt;
&lt;p&gt;解決方法として、次のどちらかを実施します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;VisualStudioで開発している場合は、プロジェクトのプロパティの[構成プロパティ]&gt;[リンカー]&gt;[入力]から[追加の依存ファイル]に参照エラーの発生しているライブラリを追加します&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;#pragma comment(lib, &quot;&amp;lt;ライブラリ名&gt;.lib&quot;)&lt;/code&gt;を追記します。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回はプロジェクトは作成せずCファイルをcl.exeでコンパイルしたいので、&lt;code class=&quot;language-text&quot;&gt;pragma&lt;/code&gt;を使っていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pragma&lt;/code&gt;とは、コンパイル時に特定のアクションを指示する命令です。&lt;/p&gt;
&lt;p&gt;特に、&lt;code class=&quot;language-text&quot;&gt;comment&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;lib&lt;/code&gt;構文を使用することで、コンパイル時にリンクするライブラリをソースコード側から指定することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/c-language/c-pragmas?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;C Pragmas | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/preprocessor/comment-c-cpp?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;comment pragma | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;#pragma comment(lib, &quot;ws2_32.lib&quot;)&lt;/code&gt;の行を追加することで&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;のリンクエラーを回避することができるようになります。&lt;/p&gt;
&lt;h3 id=&quot;ws2tcpiph&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ws2tcpiph&quot; aria-label=&quot;ws2tcpiph permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ws2tcpip.h&lt;/h3&gt;
&lt;p&gt;今回の実装では不要ですが、&lt;code class=&quot;language-text&quot;&gt;ws2tcpip.h&lt;/code&gt;はIPアドレスの取得に関連する構造体などが定義された、TCP/IPを行うために必要なヘッダファイルです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-basic-winsock-application&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Creating a Basic Winsock Application - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ws2tcpip/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ws2Tcpip.h header - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;postリクエストを送信する関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0&quot; aria-label=&quot;postリクエストを送信する関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;POSTリクエストを送信する関数&lt;/h2&gt;
&lt;p&gt;任意のアドレスに対してPOSTリクエストを送信する関数は以下の通りです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;send_http_post&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; destination&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; RSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httppath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/upload&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; LSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstSocket&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; read_size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
    WSADATA data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// AF_INETを設定&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_STREAMを指定)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_STREAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// 通信の開始&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Binding failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの作成&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;POST %s HTTP/1.1\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; httppath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Host: %s:%d\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;%s\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Content-Length: %d\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
         
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの送信&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
    &lt;span class=&quot;token comment&quot;&gt;// 通信のクローズ&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;HTTP request is sent!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;closesocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSACleanup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;wsadataの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;wsadataの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WSADATAの初期化&lt;/h3&gt;
&lt;p&gt;まずはソケット通信に必要な&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体を&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数で初期化します。&lt;/p&gt;
&lt;p&gt;Windows Socketsのバージョンは2.0を指定しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
WSADATA data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;通信先の指定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A&quot; aria-label=&quot;通信先の指定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信先の指定&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// AF_INETを設定&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の初期化後、&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体を作成してアドレスファミリと通信先のアドレス、ポート番号を定義します。&lt;/p&gt;
&lt;p&gt;公式ドキュメントでは&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体を使用する方法が紹介されていますが、今回は&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体を使用してます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-socket-for-the-client&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Creating a Socket for the Client - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体はIPv4の通信にのみ利用でき、IPv6を使用する場合は&lt;code class=&quot;language-text&quot;&gt;sockaddr_in6&lt;/code&gt;構造体を使用します。&lt;/p&gt;
&lt;p&gt;公式ドキュメントで使用している&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体はIPv4とIPv6の両方にソケットを使用する場合に利用します。&lt;/p&gt;
&lt;p&gt;特に理由がなければ&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体を使っておけば問題なさそうですね。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://medium.com/adamedelwiess/operating-system-9-socket-programming-experiment-2-enable-ipv4-and-ipv6-c2f034511cd4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Operating System 9 | Socket Programming Experiment 2: Enable IPv4 and IPv6 | by Adam Edelweiss | SereneField | Medium&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/23401147/what-is-the-difference-between-struct-addrinfo-and-struct-sockaddr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What is the difference between struct addrinfo and struct sockaddr - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;アドレスファミリには&lt;code class=&quot;language-text&quot;&gt;AF_INET&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AF_INET&lt;/code&gt;はIPv4の通信を行う場合に定義するアドレスファミリです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/1593946/what-is-af-inet-and-why-do-i-need-it&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;sockets - What is AF_INET, and why do I need it? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;socketの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;socketの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Socketの作成&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数を使ってソケットを作成します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_STREAMを指定)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_STREAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回はTCP接続を行うため、第2引数には&lt;code class=&quot;language-text&quot;&gt;SOCK_STREAM&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;socket function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第3引数には&lt;em&gt;プロトコル&lt;/em&gt;パラメータであり、使用するプロトコルを定義できます。&lt;/p&gt;
&lt;p&gt;今回はTCPを明示的に指定しておらず、0を渡しています。&lt;/p&gt;
&lt;p&gt;これは、プロトコルの指定を呼び出し元が行わないことを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/3735773/what-does-0-indicate-in-socket-system-call&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - what does 0 indicate in socket() system call? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;コネクションの確立&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B&quot; aria-label=&quot;コネクションの確立 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コネクションの確立&lt;/h3&gt;
&lt;p&gt;次は&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数でソケット接続を確立します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 通信の開始&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Binding failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数はSocket通信におけるクライアント側の接続を行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/connecting-to-a-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Connecting to a Socket - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この関数によってbindされているSocketサーバとのTCPコネクションを確立します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/70d7cbb162e7199a3a6b8596fc9fc683/socket_client_server.gif&quot; alt=&quot;https://www.tutorialspoint.com/unix_sockets/images/socket_client_server.gif&quot;&gt;&lt;/p&gt;
&lt;p&gt;画像引用元：&lt;a href=&quot;https://www.tutorialspoint.com/unix_sockets/client_server_model.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Unix Socket - Client Server Model&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;httpリクエストの送信&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1&quot; aria-label=&quot;httpリクエストの送信 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HTTPリクエストの送信&lt;/h3&gt;
&lt;p&gt;事前に作成したPOSTリクエストのデータを&lt;code class=&quot;language-text&quot;&gt;send&lt;/code&gt;関数でサーバに送信します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの送信&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は実装していませんが、レスポンスを受信するには&lt;code class=&quot;language-text&quot;&gt;recv&lt;/code&gt;関数を使います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/sending-and-receiving-data-on-the-client&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Sending and Receiving Data on the Client - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;udp通信を行う関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0&quot; aria-label=&quot;udp通信を行う関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UDP通信を行う関数&lt;/h3&gt;
&lt;p&gt;UDP通信を行う関数は以下の通りです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;send_udp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; destination&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; RSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; LSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstSocket&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; read_size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
    WSADATA wsaData&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;wsaData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_DGRAMを指定)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_DGRAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// UDPパケットの送信&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending UDP...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sendto&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; senddata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SOCKADDR &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;UDP is sent!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;closesocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSACleanup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;基本的にはTCP接続の時と同じ実装なので詳細は割愛します。&lt;/p&gt;
&lt;p&gt;違いとしては、UDP接続なのでSocketを作成する際の指定を&lt;code class=&quot;language-text&quot;&gt;SOCK_DGRAM&lt;/code&gt;にする点と、3wayハンドシェイクを行わないので&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数を使用せず、&lt;code class=&quot;language-text&quot;&gt;sendto&lt;/code&gt;関数でデータ転送を行う点です。&lt;/p&gt;
&lt;h2 id=&quot;通信の確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;通信の確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信の確認&lt;/h2&gt;
&lt;p&gt;このプログラムを実行し、実際に通信が行われているかWireSharkで確認してみました。&lt;/p&gt;
&lt;p&gt;まず、以下の通りPOSTリクエストが送信されていることが確認できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsklEQVQ4y51S207CQBTsrxmNJhpFQfBG/AtffPDfjBiFAlIoKJdaBLZAgdJWCpTYjrsbCHjBJjaZnLPb2dk5Z49wdX2D7f0wdg7C2NoLYXM3hFDsAsdnlwgdn3FETuI4ip0jchrHYfQcYfqfge0dRikncooDio3tPQjS4yOUnIRq9gmVbBbllIhaLgdCCIim0ahBo7E1X7N8ERc54zAwjtDMS7CLRZgUPVHEUMpjTEn//QRNecWo0YDTacO1THjTCXzvA77vw/O8b/DXYMkRpHQFhVQd5TyBXDRQU2yUK0PYtvvjdnZJEISkqCIpDpCXh3h4aEMUu7hPaHh+NtBqvePtzUajYXMnq6JrS85kVNzeEiSTbdzdEaTTOs076PXGnLAoa1XoT0G13qFOHBjGFJblYjCYwDRduO7HrweWYr+LCrLcpGXq0PUx+v0xd2YYE77udp35/oSXb1nTwLKFQqFJS9ShKCZeXgwORbFQrZqo0Mep1UzeRyY4m3nBgnKRIJHooFQa8INMgJARzxlU1aItmH4R+3MO6/UudWLCcWaBQ7sqttahRYd50eTV11yHIJef8U/CCQzXhkMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/64768d2f9690187105b1c5461918aaac/8ac56/image-70.webp 240w,
/static/64768d2f9690187105b1c5461918aaac/d3be9/image-70.webp 480w,
/static/64768d2f9690187105b1c5461918aaac/9e625/image-70.webp 540w&quot;
              sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/64768d2f9690187105b1c5461918aaac/8ff5a/image-70.png 240w,
/static/64768d2f9690187105b1c5461918aaac/e85cb/image-70.png 480w,
/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png 540w&quot;
            sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png&quot;
            alt=&quot;image-70.png&quot;
            title=&quot;image-70.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;また、UDPパケットも受信していることを確認しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 714px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz52NTUsCYRSF5/8ELSK0WkQQQaswnD50wjbt+xnRKgqinCmbnNEkLSKIMgjaqCV9QYsoBRdtxqWrhHdmnt6JkmgR6IGHe+65cK5iXlawrx9IXlQxziuYxTLH5WdO7+vkSi+kr6ro8pYq3lAoPcm8xtljnZO7Goe3rx3y1bcvlI38EWu5PKv7BZZX1hlPLDEUjdE/qdI3oTIaS0g/RyiiMaYtMjKzwHA0LqdGWM7ByDyh6ThhNc7A1CwKv/TeaGDu7JLc3MLQDVLSZzNZMpaNnbYktvSZDgd29ju3MFN76NtJFOG6CCFwPR/HaSJaLfA8epXi+z4BgRzH4aPdJtiCJ8EztwuEcP8UNpu0ZWGgn7xb/i3sRZ9q5+QYMReR+QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/8ac56/image-71.webp 240w,
/static/816c1ea998498b98edaeb6ba60edab0f/d3be9/image-71.webp 480w,
/static/816c1ea998498b98edaeb6ba60edab0f/80c40/image-71.webp 714w&quot;
              sizes=&quot;(max-width: 714px) 100vw, 714px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/8ff5a/image-71.png 240w,
/static/816c1ea998498b98edaeb6ba60edab0f/e85cb/image-71.png 480w,
/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png 714w&quot;
            sizes=&quot;(max-width: 714px) 100vw, 714px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png&quot;
            alt=&quot;image-71.png&quot;
            title=&quot;image-71.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでプログラムがちゃんと動作していることが確認できたので、最後にリバーシングしてみたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;リバーシングする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B&quot; aria-label=&quot;リバーシングする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リバーシングする&lt;/h2&gt;
&lt;h3 id=&quot;ghidraでデコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidraでデコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghidraでデコンパイルする&lt;/h3&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;関数から&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数を特定しました。&lt;/p&gt;
&lt;p&gt;その後、&lt;code class=&quot;language-text&quot;&gt;send_http_post&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;send_udp&lt;/code&gt;関数を特定した後、&lt;code class=&quot;language-text&quot;&gt;win_tcp_udp.exe&lt;/code&gt;を実行したときに展開されたイメージベースを設定しました。&lt;/p&gt;
&lt;h3 id=&quot;windbgでttdトレースを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでttdトレースを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでTTDトレースを取得する&lt;/h3&gt;
&lt;p&gt;解析を容易にするため、ビルドしたプログラムのTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;TTDトレースの取得方法は以下の記事にまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、取得したトレースファイルは以下のリポジトリにも置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/traces/win_tcp_udp.zip&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;socketの中身を追う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86&quot; aria-label=&quot;socketの中身を追う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Socketの中身を追う&lt;/h3&gt;
&lt;p&gt;とりあえず最初の解析ターゲットとして、&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の挙動を追っていくことにします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVQoz42SW2/bMAyF/f9/0wqsW7J6bdM2bTDUaJpuXRbk4qtkWfL1G31BXraH0jgQLZHnkJS8LFO8vW04hYo4gTxv6U1rx26nBt+WhkjHlE1FJ1/b/YtugqcSzWuwJtznxCfJ7hhJdMP7Jh38oizJBR8x7/HPNZe/5lwfVnw//mQRbXjp1ix1wOz3SvxXlvkK/3jLk17xlAcS88x9+sxD1q+BrAFB8yJY4/mZz8Xxki/xgov9Dz7tVty1S67M3bB33z7im1s+hzO+plfMtc8su+FbuhgwS26YK59F/SBY4llbksQxKqs4HiA8jaWXrsHk1eT3MQlGG5zV1KWlMTVNXlPmDuf0eVSec44sS+UShPAIh31H00BVCaGZCGV+fUxhzJBcCmElhJUIWiHU8n+eodY52+2WOCo4SIVp2lHXcim2IgzNeClFJUKavSBJLW3bx7Q0PZoR9eR7xhRS2UGILNK5JI+1O1cTichYYU2SFCIqz0dE0t6PC9mzQ55Sbiio78izhZXEUA4cJ2lZqe5MojI3zbAbxBJBKm81ihi6+J/9BbP7rreQUFCPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/8ac56/image-73.webp 240w,
/static/31cf08774dc03bba6fb203b469fa0aae/d3be9/image-73.webp 480w,
/static/31cf08774dc03bba6fb203b469fa0aae/12b65/image-73.webp 550w&quot;
              sizes=&quot;(max-width: 550px) 100vw, 550px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/8ff5a/image-73.png 240w,
/static/31cf08774dc03bba6fb203b469fa0aae/e85cb/image-73.png 480w,
/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png 550w&quot;
            sizes=&quot;(max-width: 550px) 100vw, 550px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png&quot;
            alt=&quot;image-73.png&quot;
            title=&quot;image-73.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Ghidraのディスアセンブリ結果から&lt;code class=&quot;language-text&quot;&gt;0xdf726e&lt;/code&gt;にブレークポイントを設定し、&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで処理を進めます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0x00df726e
&gt; g&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Step into&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の中に入ってみると、&lt;code class=&quot;language-text&quot;&gt;Prolog&lt;/code&gt;とついたオブジェクトを扱っているように見えます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABn0lEQVQoz42S2Y6bQBRE/f8/lNdR3iZKRhlLxpCAw05jFoON2emTC7YUZZ6mpVI1EpzuqsvO+fUV6/AF13lhbA3AZmgM/NNPutte/IVL9oOpN9CjyTKYm38UT98FocJxAnxfkeVX1jXPkJ7lnQkSVdK1M59dO9/3sCwT33MJZL8+N7c7SdIzDAPnTHGKUyw52AoTjD8Bpp9g+RFxFJLnGWWRo1RCXVcr0Md2bDzP25TnOW07oNKRZZy5BleOe8X315D9N8X7u+LtNeL4llKVlRx4pmnuTNMkyWZ2p9MJ0zQltk1RlI/Ik8YPevpuIJWbNWXNLatAfyKy4zgcjAOrn9OUrusY+gnX7eWmPUESUNQl2SWjnTq6sdt8WIatkqZpGMdxg2mtHx3atkR+9peeV+hInAzMw0IXCyBsubt36t81V+9Kday4uTfpunlW1P4Drr2tQF88DEMptpYuNFEsQ5Hp9qHcyu9AyReZ6CKKRMX/UVfYFjlVahvGCosimVwSUcjvE8UylHmhN6RLib+oBR1pdCYqRaFI6Q20wfQD+hcxwKsrrj13jwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5aa795fee13d8d07c18442c435645cfe/8ac56/image-74.webp 240w,
/static/5aa795fee13d8d07c18442c435645cfe/d3be9/image-74.webp 480w,
/static/5aa795fee13d8d07c18442c435645cfe/8aab1/image-74.webp 630w&quot;
              sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5aa795fee13d8d07c18442c435645cfe/8ff5a/image-74.png 240w,
/static/5aa795fee13d8d07c18442c435645cfe/e85cb/image-74.png 480w,
/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png 630w&quot;
            sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png&quot;
            alt=&quot;image-74.png&quot;
            title=&quot;image-74.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Prolog&lt;/code&gt;に関してはしばらく調べたものの該当しそうな情報が見つからなかったのでいったんスキップしました。&lt;/p&gt;
&lt;p&gt;誰か詳しい人いたら教えてください。。&lt;/p&gt;
&lt;h3 id=&quot;作成されたソケット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88&quot; aria-label=&quot;作成されたソケット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;作成されたソケット&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の直後の行を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 654px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABu0lEQVQoz5WRW2/aUBCE+f+/pEoTpUoJhaioIEraB5KWVDTG+G7APjbgK8YX4OspeepjVxqd0e7qaGanpeoaijrHWbr8rdMZLLehbE5EScyRM/9TLeXHL2aTn/imyzEvSbwtyrNHYPpkwY7DNmUfxhSbhCJMLjwPIvIweuvLebFLycWOdB3SmnZumHaumXy84qn9npf7W14fOmj9O6bdG156Et1rnrtXTB7eMet/QB3eo3/toY0+YX7/jPmtj9pvo/ZuaZn6HabextA6bMSAbTDCW42heWJjDEiXYxJnTKgNEfoXEntEYo2JnEdi45FUQlgDhD/kWE9o6bqNKe1qmslq5XE8gmFUHIozwgkR9gbPDFhpPmtTIMwQV13jaCv0mYVnhSS7TN47I0sLeUPlFWWuyA8XNE1NU59YLkuqqsJ1HYJAUJYHqrJ8e6tS7jTUcl4UheT1v6HMVRVdN/g9m7FYqHLhjGUfqMsjkbUjMmUITk5mZeTLnL3ksRYTy368iMkMqSxISTIZzl4qtCwbx3FQFIUwDKTl80VhWdasvRVCSJtSpSd8PM+7KPYv8LFdm220vbgppYNaqv0Dgw5OWzAP3qIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/8ac56/image-75.webp 240w,
/static/2e2565f594cff149c4bdd1c3b1b05539/d3be9/image-75.webp 480w,
/static/2e2565f594cff149c4bdd1c3b1b05539/d7085/image-75.webp 654w&quot;
              sizes=&quot;(max-width: 654px) 100vw, 654px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/8ff5a/image-75.png 240w,
/static/2e2565f594cff149c4bdd1c3b1b05539/e85cb/image-75.png 480w,
/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png 654w&quot;
            sizes=&quot;(max-width: 654px) 100vw, 654px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png&quot;
            alt=&quot;image-75.png&quot;
            title=&quot;image-75.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数は、作成したSocketを指すファイルディスクリプタを戻り値として返します。&lt;/p&gt;
&lt;p&gt;EAXレジスタの中身を見てみると以下の値が格納されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=00000150&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;socket function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このファイルディスクリプタを指すハンドルはTTDでは拾うことができませんが、ライブデバッグを行うと&lt;code class=&quot;language-text&quot;&gt;!handle&lt;/code&gt;コマンドで参照することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=00000108

&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;handle 108 f
Handle 108
  &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;         	File
  Attributes   	0
  GrantedAccess	0x16019f:
         ReadControl&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteDac&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;Synch
         Read/List&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Write&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Add&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;Append/SubDir/CreatePipe&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ReadEA&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteEA&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ReadAttr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteAttr
  HandleCount  	2
  PointerCount 	65534
  No Object Specific Information available&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ファイルオブジェクトの中身も見ようと思ったら多分カーネルデバッグを仕掛けないとだめなのかな？（たぶん）&lt;/p&gt;
&lt;h3 id=&quot;sockaddr_in構造体を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;sockaddr_in構造体を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;sockaddr_in構造体を読む&lt;/h3&gt;
&lt;p&gt;次に解析するのはソースコードでいうと以下の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;のメモリ領域を確保して、ポート番号、アドレスファミリ、IPアドレスをセットしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体は以下の構造になっています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;in_addr&lt;/code&gt;構造体には4バイトでIPv4アドレスが格納されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sin_zero&lt;/code&gt;はシステムに予約された領域で、すべて0埋めされます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt;          sin_family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;
  ADDRESS_FAMILY sin_family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;
  USHORT         sin_port&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  IN_ADDR        sin_addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  CHAR           sin_zero&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; SOCKADDR_IN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;PSOCKADDR_IN&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ws2def/ns-ws2def-sockaddr_in&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SOCKADDR_IN (ws2def.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/ns-winsock2-in_addr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;in_addr (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;sin_port&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;sin_addr&lt;/code&gt;にはネットワークバイトオーダの値を入れる必要があるため、ソースコードでは&lt;code class=&quot;language-text&quot;&gt;htons&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;inet_addr&lt;/code&gt;関数を使用しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-htons&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;htons function (winsock.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;inet_addr function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;解析対象の構造がおおむね確認できたところで、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の呼び出し後のアドレス&lt;code class=&quot;language-text&quot;&gt;0xdf7227&lt;/code&gt;にブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/573d26875a221e470c21f73fe4403d2f/29579/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACr0lEQVQ4y02Te28bRRTF/f0/CRISBUpV8QcUEdLQhkCT5lGnjuOs196H9/3emfX+etaGhlldzazmzpl7zrkzM9YyjiPexsN1XeLI0LYcRmtGnPc/4NzfMg5QlxFNFdLUDduyxa86dpoHc8xnhNkREPytj+f5JMmA70En0M4Y1p9vuFte43U+909zxR2fwg238Q2L7COL8hqnWpKSkeg7AE6jLErKsiBN9wIcsWaq0LK5fsf5w1su7Qdu/Rdcbb/hoviF8+Q3/i5O+CO+4NfojJPyhMvh6r8KR1zHZb1eEyeWLDsyaHqLM/+As1wyThfUoWKDaQKKJKfOW4rU6h/6rgfJMhvs/nA4S3OyOCXe7XlaCqwEoz3n5h3LxZyu7wmCmO02ZLcreHIsy6Vl5VRsooogb/CygFlhK9pBIvsu7m5DkNUkdUdlW3LT4fz5Hav5R3o7kGc6JH093xDlGWVVsd/vMVOMe6yYzt50p/zenPDafcXL8Gde+mf8uJEu7Smn7T+s3n/P47+AWdqzepK7fksYtarU0jSWsjY0kq42PTPfiMIYcxfMJfodi3jH7TbF6yMCm+GcfasKrzDDSN/XqjIll3ZpmmidUBQZTTfQCrAfBmajHQ8aVmlFmRaUMiTYINE59OP64jWr+xtpaAXUieLUdFKfabbH5vvf+OpyGISEYUAUWYpyqmak0s3OX69E+RorneJ45GEBWxc2Cr0D5UuCuCZV4+6a9rkP00QOx7GoWGkztYFikOPnP6lCAYpy23S6uGAXyn1H5ni9zpQ40tSTmVmdPwMWeSFK6vZ4UEtM/1MfDriXb3jU0+uV13VWLyk+6BiGhl3UyJRBjAbpaHVp8wxYldKwLOXkoOQjYCX3HlYPPK5WGD3D/X7UvtF+rcoqzblMEVWtt3FLVBq+AOqF2CDCCgFdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/573d26875a221e470c21f73fe4403d2f/8ac56/image.webp 240w,
/static/573d26875a221e470c21f73fe4403d2f/d3be9/image.webp 480w,
/static/573d26875a221e470c21f73fe4403d2f/4b567/image.webp 543w&quot;
              sizes=&quot;(max-width: 543px) 100vw, 543px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/573d26875a221e470c21f73fe4403d2f/8ff5a/image.png 240w,
/static/573d26875a221e470c21f73fe4403d2f/e85cb/image.png 480w,
/static/573d26875a221e470c21f73fe4403d2f/29579/image.png 543w&quot;
            sizes=&quot;(max-width: 543px) 100vw, 543px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/573d26875a221e470c21f73fe4403d2f/29579/image.png&quot;
            alt=&quot;image.png&quot;
            title=&quot;image.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の戻り値を確認すると、確保されたアドレスが&lt;code class=&quot;language-text&quot;&gt;0x55d810&lt;/code&gt;から始まることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=0055d810&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;メモリアドレスを見てみると16バイト分の領域に値がセットされているように見えます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体は、ポートとアドレスファミリの領域にそれぞれ2バイトずつ、IPアドレスに4バイト、システム予約領域に8バイトを使用します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 517px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQY0z1Q2XKDMAzk/7+pR6ZpmplCOGxjbgwEQogh6R9sJWcmDzuWtdJKKy/LMhy+D+D3FIbY77+QJAmapkFRFOj7HmVZoqprdF3nch3l7vc7tnXFtm0vPB5/8LTOcDz+QKUaDTUFQYCcxFnUxXmOkAZFceyG+r6PnESHoXfiVVU5lARrN3hCCOx2nwijGD1tIKUk4ed2aZqiaVsnlGU5WtpaKQVjOudAiMT9FfVIJXG7rfCKoqSpv9DUNJCVVGu0JMJTWcgY48S5zpgWmni2zMOZf3JPuA2jKMLH+xv84ERCDW0avbZj23w/SS6kVC6OyXpNp6nrysVCCrBLxrJYeOM4USHf5Ix1tRjHkYgF8zxjmiayccPlciHMFC+Ot9bCUp555vjl+ut8xT8XoqsBy1ipXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/8ac56/image-1.webp 240w,
/static/96374987ee5c17149aca7c34d5cbca5d/d3be9/image-1.webp 480w,
/static/96374987ee5c17149aca7c34d5cbca5d/7f59e/image-1.webp 517w&quot;
              sizes=&quot;(max-width: 517px) 100vw, 517px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/8ff5a/image-1.png 240w,
/static/96374987ee5c17149aca7c34d5cbca5d/e85cb/image-1.png 480w,
/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png 517w&quot;
            sizes=&quot;(max-width: 517px) 100vw, 517px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png&quot;
            alt=&quot;image-1.png&quot;
            title=&quot;image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このまま処理を進めていくと、空だったメモリの領域にポート番号、アドレスファミリ、IPアドレスが設定されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 496px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQY01WR246DMAxE+f+PW4rEnVYQCBAuCS1U7bbqdtY26kMfRrHI2HMcPN3USLMcwzBA6wZBECAvjrher1iWBeu6Yp5nDOOIxTnxGWPw+3jg9Xrhfr/h8Xzi/X7jj+SlaYIf30dxPGKipjAMUVUVmqZBEsdSn04n+h6hrmtkaYooiuDcgq7rUJWleBlG6xZeVZWIkwRK1bhcLmKapgnWWqlnOh2p740Qj+MglLyBoZM9rLZt0fU9vDzP4B8OKIqCUi1KSmQDN3Hdk8mYXkhH2oBplFISzkO4ZnIR3XmMvBMqnM9nwtbSyO/GNdOyuNlaB0MBHLht2xehiAk/A0siWL9WdvvKNNjaWUj53T4/hVfm4H0Ds4vu/gFdE7teJSikEQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/28807a629a0e13d12b351cd801596f5c/8ac56/image-2.webp 240w,
/static/28807a629a0e13d12b351cd801596f5c/d3be9/image-2.webp 480w,
/static/28807a629a0e13d12b351cd801596f5c/6f16c/image-2.webp 496w&quot;
              sizes=&quot;(max-width: 496px) 100vw, 496px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/28807a629a0e13d12b351cd801596f5c/8ff5a/image-2.png 240w,
/static/28807a629a0e13d12b351cd801596f5c/e85cb/image-2.png 480w,
/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png 496w&quot;
            sizes=&quot;(max-width: 496px) 100vw, 496px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png&quot;
            alt=&quot;image-2.png&quot;
            title=&quot;image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このままだと少しわかりづらいので表示を変えてみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; dyb 0055d810
          76543210 76543210 76543210 76543210
          &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;
0055d810  00000010 00000000 00000000 01010000  02 00 00 50
0055d814  10101001 11111110 01100100 00011110  a9 fe 64 1e
0055d818  00000000 00000000 00000000 00000000  00 00 00 00
0055d81c  00000000 00000000 00000000 00000000  00 00 00 00&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ポート番号80が&lt;code class=&quot;language-text&quot;&gt;0x0050&lt;/code&gt;とネットワークバイトオーダ（ビッグエンディアン）形式で格納されています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;0x55d814&lt;/code&gt;からの4バイトは、IPアドレスが同じくネットワークバイトオーダで格納されています。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;年の瀬にソケットプログラミングとリバーシングなどをしてました。&lt;/p&gt;
&lt;p&gt;来年も良い年になるとよいですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[C言語でRC4暗号を実装してGhidraとWinDbgでリバーシングしてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-011-rc4</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-011-rc4</guid><pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回はC言語でRC4暗号を実装してWinDbgでリバーシングしてみたいと思います。&lt;/p&gt;
&lt;p&gt;2021/12/24に開催されていた&lt;a href=&quot;https://harekaze.com/ctf/2021.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Harekaze mini CTF 2021&lt;/a&gt;のRev問で静的解析からRC4暗号が使われていることを見抜く問題があったのですが、残念ながらデコンパイル結果から見抜くことができませんでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/TeamHarekaze/harekaze-mini-ctf-2021-challenges-public/blob/main/rev/pack-program/solution/Pack%20Program-solve.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;harekaze-mini-ctf-2021 Pack&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで、今回は復習を兼ねて実際に自分でRC4暗号を実装し、リバーシングしてみたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7%E3%81%A8%E3%81%AF&quot;&gt;RC4暗号とは&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E6%9A%97%E5%8F%B7&quot;&gt;ストリーム暗号&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7&quot;&gt;RC4暗号&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ksa&quot;&gt;KSA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#prga%E3%81%A7%E9%8D%B5%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%82%92%E7%94%9F%E6%88%90%E3%81%97%E3%81%A6%E6%9A%97%E5%8F%B7%E5%8C%96&quot;&gt;PRGAで鍵ストリームを生成して暗号化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%BE%A9%E5%8F%B7&quot;&gt;復号&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;ソースコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#rc4%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;RC4プログラムをリバーシングしてみる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;呼び出し関数のデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;TTDトレースを解析する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ksa%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;KSAのデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#prga%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;PRGAのデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%BF%BD%E8%A8%98202212&quot;&gt;追記(2022/1/2)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;rc4暗号とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7%E3%81%A8%E3%81%AF&quot; aria-label=&quot;rc4暗号とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4暗号とは&lt;/h2&gt;
&lt;p&gt;RC4暗号はWEPやSSL通信などに使用されていたストリーム暗号の一種です。&lt;/p&gt;
&lt;p&gt;現在は脆弱性が広く知られており、使用は推奨されておりません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/RC4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RC4 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ストリーム暗号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E6%9A%97%E5%8F%B7&quot; aria-label=&quot;ストリーム暗号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ストリーム暗号&lt;/h3&gt;
&lt;p&gt;ストリーム暗号は対象暗号(暗号化と復号に同じ鍵を使用する暗号)の一種で、bitごと、あるいはバイトごとに逐次暗号化を行っていく方式です。&lt;/p&gt;
&lt;p&gt;ストリーム暗号以外の対象暗号としてはブロック暗号があり、ストリーム暗号と比較されることが多いです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3zi4Pew&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;暗号技術 実践活用ガイド&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;rc4暗号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7&quot; aria-label=&quot;rc4暗号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4暗号&lt;/h3&gt;
&lt;p&gt;RC4暗号は、ストリーム暗号なので、生成した疑似乱数列と平文の排他的論理和を取ることで暗号化を行います。&lt;/p&gt;
&lt;p&gt;RC4による暗号化は、ざっくり以下の流れです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;与えられた鍵を元に、KSAによって暗号化に使用する鍵ストリームを生成するための初期ステートSを生成します&lt;/li&gt;
&lt;li&gt;初期ステートSを使い、PRGA(疑似乱数生成アルゴリズム)で平文を暗号化する鍵ストリームを生成します&lt;/li&gt;
&lt;li&gt;生成した鍵ストリームを用いて平文をXOR暗号化します&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;ksa&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ksa&quot; aria-label=&quot;ksa permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KSA&lt;/h3&gt;
&lt;p&gt;RC4暗号では、あらかじめ定義された配列S	を使用し、KSA(キースケージュールアルゴリズム)を用いて配列Sの初期化を行います。&lt;/p&gt;
&lt;p&gt;実装はWikipediaのサンプルを参考にしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/RC4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RC4 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;N&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tmp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 配列Sの初期化(S[0]=0, S[1]=1....S[255]=255)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;token comment&quot;&gt;// KSAで初期ストリームを生成&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコードの通り、入力されたキーを元にKSAで初期ストリームを生成します。&lt;/p&gt;
&lt;h3 id=&quot;prgaで鍵ストリームを生成して暗号化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prga%E3%81%A7%E9%8D%B5%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%82%92%E7%94%9F%E6%88%90%E3%81%97%E3%81%A6%E6%9A%97%E5%8F%B7%E5%8C%96&quot; aria-label=&quot;prgaで鍵ストリームを生成して暗号化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PRGAで鍵ストリームを生成して暗号化&lt;/h3&gt;
&lt;p&gt;RC4のPRGAから暗号化までは以下のステップで実装します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iをインクリメントする(&lt;code class=&quot;language-text&quot;&gt;i = (i + 1) % 256&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;S[i]をjを加算する(&lt;code class=&quot;language-text&quot;&gt;j = (j + S[i]) % 256&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;S[i]とS[j]をスワップする&lt;/li&gt;
&lt;li&gt;鍵ストリームKを&lt;code class=&quot;language-text&quot;&gt;S[(S[i] + S[j]) % 256]&lt;/code&gt;として平文とXORをとる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;実装は非常にシンプルですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでRC4の暗号化処理が実装できました。&lt;/p&gt;
&lt;h3 id=&quot;復号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%BE%A9%E5%8F%B7&quot; aria-label=&quot;復号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;復号&lt;/h3&gt;
&lt;p&gt;RC4暗号は疑似乱数を用いたXORにより暗号化を行っています。&lt;/p&gt;
&lt;p&gt;この疑似乱数の生成アルゴリズムは決定論的アルゴリズムなので、常に同じキーから同じ疑似乱数が取得できます。&lt;/p&gt;
&lt;p&gt;そのため、RC4の暗号化に使用したものと同じキーを使用して生成した疑似乱数で、暗号化されたテキストを再びXORすることで元の平文を復号することができます。&lt;/p&gt;
&lt;h2 id=&quot;ソースコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;ソースコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ソースコード&lt;/h2&gt;
&lt;p&gt;ソースコード全体は以下です。&lt;/p&gt;
&lt;p&gt;こちらのリポジトリにも置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/build/c/rc4_encrypt.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/rc4_encrypt.c&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;N&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tmp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 配列Sの初期化(S[0]=0, S[1]=1....S[255]=255)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;token comment&quot;&gt;// KSAで初期ストリームを生成&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; argc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RC4 module\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// RC4のkeyは短いと簡単に推測されてしまうため、実際に使用する場合は注意が必要&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;testkey&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;this is test.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This is encrypted text\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;==&gt; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%02hhX&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;decrypted_text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; decrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This is decrypted text\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;==&gt; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; decrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、このプログラムをリバーシングしてみます。&lt;/p&gt;
&lt;h2 id=&quot;rc4プログラムをリバーシングしてみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;rc4プログラムをリバーシングしてみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4プログラムをリバーシングしてみる&lt;/h2&gt;
&lt;p&gt;とりあえずビルドしたバイナリをGhidraで解析してみます。&lt;/p&gt;
&lt;p&gt;main関数の特定方法などは割愛します。&lt;/p&gt;
&lt;h3 id=&quot;呼び出し関数のデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;呼び出し関数のデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;呼び出し関数のデコンパイル&lt;/h3&gt;
&lt;p&gt;まずはRC4の呼び出し関数をチェックしてみます。&lt;/p&gt;
&lt;p&gt;ソースコードでいうと以下の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;デコンパイル結果を見ると、何か変です笑&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint uVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined in_stack_fffffef8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_004071b0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407260&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;in_stack_fffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;解析を容易にするため、関数名や変数名をリネームしました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint uVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined S&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードにはない以下の2行が何をしているのかよくわからないですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;というわけで、WinDbgのTTDトレースを使ってこの箇所を解析していきます。&lt;/p&gt;
&lt;h3 id=&quot;ttdトレースを解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttdトレースを解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレースを解析する&lt;/h3&gt;
&lt;p&gt;例によってTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;トレースファイルは以下に配置してあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/traces/rc4_encrypt.zip&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/rc4_encrypt.zip&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このトレースファイルをロードし、&lt;code class=&quot;language-text&quot;&gt;uVar1 = DAT_00471090 ^ (uint)&amp;amp;stack0xfffffffc;&lt;/code&gt;の処理を行っているアドレスにブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABMUlEQVQY03WQS0/DMBCE8/9/A4LfwAkEVwQXXhII1KK0PFLlAUnjOHacuPbHkh64wEqjtdba2ZlJjDF0Xc84IhXn3nUTdvCkT7eUZYEbd6jeY10j/xmDK3FO470nxkDYTYQwyTuSVGVFtslp6oi1zNXUht547i/PeHt9lWWH1YpaX9OYU7S7R2tLqxqmUcmRH2ghhMR2BrXtZsKq3BNaMzL5yM3FOet1iogkXRo+PrQoLqm/ViiVUudb2kJhqi26ajC6JcnUhrc6I8sDjYr4IApbR+/g9uSI5eIZ3UFR7MRBZBAXTnIJwUuPs/pp6gVaYEge8ifu3h/JykD+KQseNkVPowM3J4e8LBZ72ZLvL/6vZLSjSB1QbRTb+6EbJGTZuzo+YL1K51kIYQ79J6d9/xvfBknLlkXLvGgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/8ac56/image-3.webp 240w,
/static/e89668a93e15c3df0bca083fd4cb0504/d3be9/image-3.webp 480w,
/static/e89668a93e15c3df0bca083fd4cb0504/d2334/image-3.webp 659w&quot;
              sizes=&quot;(max-width: 659px) 100vw, 659px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/8ff5a/image-3.png 240w,
/static/e89668a93e15c3df0bca083fd4cb0504/e85cb/image-3.png 480w,
/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png 659w&quot;
            sizes=&quot;(max-width: 659px) 100vw, 659px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png&quot;
            alt=&quot;image-3.png&quot;
            title=&quot;image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0086734e&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;WinDbgで読ませたところ、Ghidra上で&lt;code class=&quot;language-text&quot;&gt;DAT_00471090&lt;/code&gt;として表示されていたデータはどうやらSecurity Cookieだということがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 27.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVQY04XRbUvCUBTA8X3/j1AUYWHltLASil7kG4mKMFHTabqlrjltbUuHe9D9u16DehF04Me953C4XM5RtFaLZqPBwDB4M0cs44TZ55I4DAnmM2Sk6Q/+OKVNKLWWxsvQZDiZMnZdnHnCwE7xw4i+aaG/WyxEYyxE337f10JhkW4o6vEVhdw1mW2V/S2VYr5MsXDDxUlZ1vO5S/L7JVThaO+MXOacQlbUDkqSKvL1ebh7SnangFKv3NK4vaPz8IjZfMZqddGfDGytQ1vU9Fqd5n2FbrXKuN3B6em4uoFrvOJJA8l/HUpKt99jZI358H05iXgJ40lKGMc4nscsCJiFAUEUsogj/gtF09qMTBPrzWIulhCFS0xzvZAA27bxxKOemO2H4zCdTERPgCtyX3wgSRKxl5R0tRJS6QtcBbjfUN/CDwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4e960040ed4a62ea1a54c6669515e475/8ac56/image-4.webp 240w,
/static/4e960040ed4a62ea1a54c6669515e475/d3be9/image-4.webp 480w,
/static/4e960040ed4a62ea1a54c6669515e475/038cb/image-4.webp 696w&quot;
              sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4e960040ed4a62ea1a54c6669515e475/8ff5a/image-4.png 240w,
/static/4e960040ed4a62ea1a54c6669515e475/e85cb/image-4.png 480w,
/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png 696w&quot;
            sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png&quot;
            alt=&quot;image-4.png&quot;
            title=&quot;image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;__security_cookie&lt;/code&gt;はデータセクション内に定義され、バッファオーバーフローの検出に利用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://reverseengineering.stackexchange.com/questions/22182/security-cookie-for-function-pointers-in-windows-10&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ida - _&lt;em&gt;security&lt;/em&gt;cookie for function pointers in Windows 10&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;どうやらこの用途のわからなかった2行は、この機構によってバッファオーバーフローの発生を検知するための処理のようですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちょっとすっきりしたので、このままKSAとPRGAの解析を進めていきます。&lt;/p&gt;
&lt;h3 id=&quot;ksaのデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ksa%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;ksaのデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KSAのデコンパイル&lt;/h3&gt;
&lt;p&gt;KSA関数をGhidra でデコンパイルした結果はこんな感じでした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;undefined4 __cdecl &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  sVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;sVar1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;
               &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00867180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://harekaze.com/ctf/2021.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Harekaze mini CTF 2021&lt;/a&gt;のRev問で出てきたバイナリのデコンパイル結果とよく似ていますね。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAABk0lEQVQ4y41Ti3LbMAzz///TPmJfse3axbEelChSwiC7brurL6nueEwiCQEIaInhB3L5CZGBlAZCGIiRlQ2aG1poqNWhm8KqYa4xxl5Xa9FWYFbhbugdrPFe46zx0Z8C3rZORjeUcvt06PrwCfZoLVmckla0lr9cvKqnDN0zVBUxddRkMGmU2y9AD+ZPGRZZacgdqcxZOqwZru8MPME6AANd3EJCSXdIEqQaCTrBDYXunoZ9ZvhoHEvvyouCSoaaE2epBFB079DW+XmOwL7FboIuKWZK3ng5wwfzRrDR8cXtR8z+Y1iKETBASsCvdcXL/S/qnTLV4CaUz0CzuxVIbRAGvCUlgQSlMikz+HFXtgNOZJG5sSHXV5qzwinRekOeCeBITte/JVnV+dwqw92QoiHnsj+7KOyBzBNnq0IG808Nac9t21nOp2he0LRw1n4AzqiIVBrTdmMqpTI5hwnO6ucsncxBgGNv2Hgbced3/4jNn98BL68rQgxkGdnj0UPExr6FowKjNX8798J55m1vP7cF/ANCGU4Yr1jrVQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/8ac56/image-5.webp 240w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/d3be9/image-5.webp 480w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/8ff5a/image-5.png 240w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/e85cb/image-5.png 480w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png&quot;
            alt=&quot;image-5.png&quot;
            title=&quot;image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/TeamHarekaze/harekaze-mini-ctf-2021-challenges-public/blob/main/rev/pack-program/solution/Pack%20Program-solve.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;harekaze-mini-ctf-2021 Pack&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これがすぐに見抜けてれば解けたと思うと悔しいです。&lt;/p&gt;
&lt;h3 id=&quot;prgaのデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prga%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;prgaのデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PRGAのデコンパイル&lt;/h3&gt;
&lt;p&gt;以下がデコンパイル結果です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;undefined4 __cdecl &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  sVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00867180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_3 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
         param_2&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;
         &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;
                  &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちょっと気になるのは、ソースコードで&lt;code class=&quot;language-text&quot;&gt;(i + 1) % 256&lt;/code&gt;としている箇所が、デコンパイル結果では以下のような表現になっている点です。&lt;/p&gt;
&lt;p&gt;※ C言語では&lt;code class=&quot;language-text&quot;&gt;+&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;&amp;amp;&lt;/code&gt;の演算子の優先順位は同一なので、&lt;code class=&quot;language-text&quot;&gt;i + 1&lt;/code&gt;が先に評価されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際に以下のようなスクリプトを作り試してみると、上記の演算で&lt;code class=&quot;language-text&quot;&gt;% 256&lt;/code&gt;と全く同じ演算結果を得ることができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mod256&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; n

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;250&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;260&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mod256&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;新たな発見ですね。&lt;/p&gt;
&lt;p&gt;今後リバーシングしたときにこのようなデコンパイル結果を見かけたらmod演算としてリバースエンジニアリングすることができそうです。&lt;/p&gt;
&lt;h3 id=&quot;追記202212&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%BF%BD%E8%A8%98202212&quot; aria-label=&quot;追記202212 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;追記(2022/1/2)&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mod 256&lt;/code&gt;のコードはどれも上記のような出力になるのかと思ったのですが、結構コンパイラによって出力が違うようで、Twitterで親切な方にコメントいただきました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 41.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABoklEQVQoz1WSy5LaMBBF/RcBZMmWX4UfQABjgzE29jDMI4upQLLJOn+SDz+Rh2GqZnGquq5ut1rqtprmwG63ZbGYk+c5D33Pj9cXnk4P9FVJva9YrZZUVcX5/EjbNOybinJf3rwvz3THll1TUhQFVpLNKQ89+e5AnKTEaUZW1CSrgmixxE8W+FHMfD5ns61YFzuWeUGSpqQz00Td8704kA7+aYzlaA83jNEmSUwmqDBjXF7Q9U+C9sKkfGPsZ7hKITevqOoXcvuGcHycaIao/xjtN3Z1QbgBlpQSaQuDjRQCzxQO8wY/K3CTNTrboLwQ7Wr8dY/OH3FXPUoHOAaZlsg4R0zXSEdjKXPznaGo6/nmmTNcP/pEOi72cOY6OMrGkfa7d9CUFCj7A9Pc14JGuJm+MujCdD9gfxQa4on5ItuWtzypENLBGsS7eTQafSbdNWHi8XiM7/tkWUoYBoaQIAiI45goCvE8TaAVU/cb1jC9JElIzdTKsjSrcabrju/0Zi26rqMxq1LXNafTiaNZkSEeaNuW89Mz1+uV0/Uv0fUf/wEW5vDCKZRq5wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/8ac56/image-6.webp 240w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/d3be9/image-6.webp 480w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/b0a15/image-6.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/8ff5a/image-6.png 240w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/e85cb/image-6.png 480w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png&quot;
            alt=&quot;image-6.png&quot;
            title=&quot;image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;引用：&lt;a href=&quot;https://twitter.com/fujitanozomu/status/1477557557103558657?s=20&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;引用元コメント&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はHarekaze mini CTF 2021の復習を兼ねて、RC4暗号を実装してリバーシングしてみました。&lt;/p&gt;
&lt;p&gt;新しい発見もあったので試してみてよかったです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3zi4Pew&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;暗号技術 実践活用ガイド&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-009-base64</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-009-base64</guid><pubDate>Thu, 30 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は独自実装したBase64モジュールをGhidraでデコンパイルした後にWinDbgで処理を追っていきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;Base64の実装とビルド&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;Base64の実装について&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%A8%E3%81%AF&quot;&gt;Base64とは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;Base64のソースコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%98%E3%83%83%E3%83%80%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot;&gt;Base64プログラムのヘッダファイル&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7time-travel-debugging%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;WinDbgでTime Travel Debuggingを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Base64プログラムをGhidraでデコンパイルする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#entrypoint%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;entrypointからmain関数を特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64encode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;Base64Encode関数のデコンパイル結果を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64decode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;Base64Decode関数のデコンパイル結果を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot;&gt;TTDトレースの解析&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;シンボルファイルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;ブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A8ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E3%81%9D%E3%82%8D%E3%81%88%E3%82%8B&quot;&gt;WinDbgとGhidraのイメージベースをそろえる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%9F%E3%81%84%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;解析したいポイントにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;アセンブリを読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;base64の実装とビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;base64の実装とビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64の実装とビルド&lt;/h2&gt;
&lt;p&gt;まずは今回の解析に使用するプログラムをビルドします。&lt;/p&gt;
&lt;p&gt;ソースコードは以下のリポジトリにあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Base64エンコードとデコードのプログラムについては、以下の記事で紹介されているものが&lt;code class=&quot;language-text&quot;&gt;WTFPL v2&lt;/code&gt;で配布されているとのことでしたのでありがたく拝借しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/leak4mk0/items/6c7f708dd59d52e0bc5c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CでBASE64のエンコード/デコードを行う関数 - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一部の実装については独自にカスタマイズしていますが、ベースは概ね変わりません。&lt;/p&gt;
&lt;p&gt;この記事で紹介しているソースコードについても、参照元を踏襲し&lt;code class=&quot;language-text&quot;&gt;WTFPL v2&lt;/code&gt;で公開しておりますので、自由にお使いください。&lt;/p&gt;
&lt;p&gt;なお、Base64エンコードおよびデコードの結果については保証しませんのであしからず。&lt;/p&gt;
&lt;p&gt;ビルドは以下のコマンドで実施します。&lt;/p&gt;
&lt;p&gt;cl.exeを利用できるように、事前に開発者用コマンドプロンプトを設定しておく必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/kash1064/Try2WinDbg
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; Try2WinDbg

&lt;span class=&quot;token comment&quot;&gt;# cl.exeを利用できるように、事前に開発者用コマンドプロンプトを設定しておく&lt;/span&gt;
cl /c ./build/c/base64.c
&lt;span class=&quot;token function&quot;&gt;link&lt;/span&gt; /DEBUG /PDB:./build/symbol/base64.pdb ./base64.obj /OUT:./build/bin/base64.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ビルドができない環境でも、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/trace/base64_trace.zip&lt;/code&gt;の中にあるTTDトレースファイルを使うことでTTDを使った解析を行うことができます。&lt;/p&gt;
&lt;p&gt;TTDトレースの読み込みについては以下の記事でまとめてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;base64の実装について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;base64の実装について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64の実装について&lt;/h2&gt;
&lt;h3 id=&quot;base64とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%A8%E3%81%AF&quot; aria-label=&quot;base64とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64とは&lt;/h3&gt;
&lt;p&gt;Base64は、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc4648&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RFC4648&lt;/a&gt;で定義されているデータのエンコーディング方法です。&lt;/p&gt;
&lt;p&gt;様々なバイト列をASCIIデータに変換することができるので、データの保存や転送など、様々な状況で利用されます。&lt;/p&gt;
&lt;p&gt;Base64は、エンコーディングするバイナリデータを24bit単位で区切り、さらに6bitずつに分割することで、様々なデータを64文字の事前に定義された文字列に変換することができます。&lt;/p&gt;
&lt;p&gt;ここで、エンコーディング元のバイナリデータが24bit単位で区切れない長さの場合、パディングと呼ばれる文字が追加されます。&lt;/p&gt;
&lt;p&gt;パディングの文字はRFCで&lt;code class=&quot;language-text&quot;&gt;=&lt;/code&gt;と定義されていますが、同じくRFCで定義されているURL安全なBase64エンコーディングの場合は&lt;code class=&quot;language-text&quot;&gt;_&lt;/code&gt;が使用されます。&lt;/p&gt;
&lt;h3 id=&quot;base64のソースコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;base64のソースコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64のソースコード&lt;/h3&gt;
&lt;p&gt;以下が今回使用するBase64プログラムのソースコードです。&lt;/p&gt;
&lt;p&gt;長いので詳細な解説はしません。&lt;/p&gt;
&lt;p&gt;ビルドしたプログラムを実行するとmain関数で定義されたテストが実行されますが、他のプログラムにリンクすることで関数単位で呼び出すことも可能です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;assert.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;base64.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_SPEC base64_spec&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; lineLength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// base64_specの初期化&lt;/span&gt;
    base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_SPECS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
    length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// mallocの戻り値は確保したメモリブロックを指すポインタ&lt;/span&gt;
    base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    lineLength &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 3文字単位でエンコードを行う(エンコード後は4文字になる)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_SPEC base64_spec&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// base64_specの初期化&lt;/span&gt;
    base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_SPECS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// デコードするBase64文字列用のメモリ領域の確保&lt;/span&gt;
    length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; BASE64_TABLE_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; ch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        ch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xf0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xc0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cursor &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_TESTS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        BASE64_TEST test&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        test &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;BASE64(\&quot;%s\&quot;) = \&quot;%s\&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;strcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;DATA(\&quot;%s\&quot;) = \&quot;%s\&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token function&quot;&gt;free&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;free&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;base64プログラムのヘッダファイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%98%E3%83%83%E3%83%80%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; aria-label=&quot;base64プログラムのヘッダファイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64プログラムのヘッダファイル&lt;/h3&gt;
&lt;p&gt;以下は、Base64プログラムのヘッダファイルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;ifndef&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;__BASE64_H__&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;__BASE64_H__&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Data&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Base64 tables&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE_URL&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; BASE64_TABLE_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// enum型で使用するBase64Tableの種類を定義&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;enum&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_TYPE&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    BASE64_TYPE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    BASE64_TYPE_CUSTOM1
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_TYPE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_SPEC&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lineSep&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; lineSepLength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_SPEC&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_SPEC BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; BASE64_SPECS_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Export function&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Test data&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_TEST&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_TEST&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TEST BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;this is test&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;dGhpcyBpcyB0ZXN0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SGVsbG8=&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Fan-Fan-Fun!!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;RmFuLUZhbi1GdW4hIQ==&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AAA&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;QUFB&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; BASE64_TESTS_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;endif&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// !__BASE64_H__&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;windbgでtime-travel-debuggingを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7time-travel-debugging%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでtime travel debuggingを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでTime Travel Debuggingを取得する&lt;/h2&gt;
&lt;p&gt;ビルドが完了したら、解析を容易にするためにTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;TTDトレースの取得方法は以下の記事を参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ちなみに、プログラムのビルドができない環境でも、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/trace/base64_trace.zip&lt;/code&gt;の中にあるTTDトレースファイルを使うことでTTDを使った解析を行うことができます。&lt;/p&gt;
&lt;h2 id=&quot;base64プログラムをghidraでデコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;base64プログラムをghidraでデコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64プログラムをGhidraでデコンパイルする&lt;/h2&gt;
&lt;p&gt;トレースファイルの解析の前に、一度GhidraでBase64プログラムをデコンパイルしてみました。&lt;/p&gt;
&lt;h3 id=&quot;entrypointからmain関数を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#entrypoint%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;entrypointからmain関数を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;entrypointからmain関数を特定する&lt;/h3&gt;
&lt;p&gt;PEバイナリを実行する場合、entrypointでは初期化処理の後にmain関数が呼び出され、その後exitプロセスが呼び出されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.bigmessowires.com/2015/10/02/what-happens-before-main/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;What Happens Before main() | Big Mess o’ Wires&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
FID_conflict&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;__get_initial_narrow_environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0043c3a2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0043c39c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
unaff_ESI &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_004078f0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uVar7 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;___scrt_is_managed_app&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar7 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;bVar2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    	&lt;span class=&quot;token function&quot;&gt;__cexit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;___scrt_uninitialize_crt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\x01&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_FS_OFFSET &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_14&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; unaff_ESI&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、上記のデコンパイル結果でいうところの&lt;code class=&quot;language-text&quot;&gt;___scrt_is_managed_app()&lt;/code&gt;の直前の行で呼び出している&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_004078f0()&lt;/code&gt;がmain関数であることがわかります。&lt;/p&gt;
&lt;h3 id=&quot;base64encode関数のデコンパイル結果を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64encode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;base64encode関数のデコンパイル結果を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64Encode関数のデコンパイル結果を読む&lt;/h3&gt;
&lt;p&gt;次は、main関数から辿っていき、Base64Encode関数のデコンパイル結果を読んでいきます。&lt;/p&gt;
&lt;p&gt;当然ですが、ソースコードの見え方とはかなり変わっており、読みづらくなってますね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;base64_encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_2c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_2c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_28 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f24&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        local_2c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;PTR_s_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef_00467f28&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_28 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f2c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;気になった点としては以下の点があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この部分の元のソースコードは以下のようになってました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// mallocの戻り値は確保したメモリブロックを指すポインタ&lt;/span&gt;
base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;をGhidraで追ってみると次のようになっていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__malloc_base&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この結果から、&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数であることがわかりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://strontic.github.io/xcyclopedia/library/ucrtbase.dll-34A153A39639A1DB64761AEDACDFA4AE.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ucrtbase.dll | Microsoft C Runtime Library | STRONTIC&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数の引数として与えられている&lt;code class=&quot;language-text&quot;&gt;(uint)(param_2 &amp;lt;&amp;lt; 2) / 3 + 3&lt;/code&gt;が、ソースコードでいうところの以下の行であることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;興味深い点としては、一度変数&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt;に入れていたはずの値がデコンパイル結果では直接&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数に受け渡されている点と、&lt;code class=&quot;language-text&quot;&gt;size * 4&lt;/code&gt;の演算がデコンパイル結果ではシフト演算に置き換わっている点です。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングを行う場合は、このあたりのコンパイラの気持ちも理解しつつ進めていく必要がありそうですね。&lt;/p&gt;
&lt;h3 id=&quot;base64decode関数のデコンパイル結果を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64decode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;base64decode関数のデコンパイル結果を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64Decode関数のデコンパイル結果を読む&lt;/h3&gt;
&lt;p&gt;続いてDecodeの関数のデコンパイル結果も見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;base64_decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  byte bVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_EDX&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined8 uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; local_ac&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_98&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_90&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte local_88 &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00474224 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; in_EDX&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    in_stack_ffffff50 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_ac &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f24&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        in_stack_ffffff50 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;PTR_s_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef_00467f28&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_ac &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f2c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    sVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    uVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ulonglong&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pbVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pbVar3 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;_memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_88&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        local_88&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; local_ac&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        bVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_88&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3fU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80000003&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfffffffc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407ca8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_94&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これと言って特筆する点はないですが、一か所読んでもよくわからないデコンパイル結果がありました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ulonglong&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pbVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードでいうと以下のコードの箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// デコードするBase64文字列用のメモリ領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;なので、&lt;code class=&quot;language-text&quot;&gt;uVar4 = thunk_FUN_0041973b((sVar2 * 3 &gt;&gt; 2) + 3);&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;uVar4&lt;/code&gt;はソースコードでいうところの&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;であることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数は成功したときに確保したメモリ領域の先頭アドレスを戻り値に格納するため、&lt;code class=&quot;language-text&quot;&gt;uVar4&lt;/code&gt;にはアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;これを&lt;code class=&quot;language-text&quot;&gt;0x20&lt;/code&gt;分右シフトしているので、やっていることとしてはアドレスを32bit分ずらしている処理であると思います。&lt;/p&gt;
&lt;p&gt;この動きの理由はデコンパイル結果からは理解が及ばなかったので、この後WinDbgで解析を行う際に確認したいと思います。&lt;/p&gt;
&lt;h2 id=&quot;ttdトレースの解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;ttdトレースの解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレースの解析&lt;/h2&gt;
&lt;h3 id=&quot;シンボルファイルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;シンボルファイルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイルのロード&lt;/h3&gt;
&lt;p&gt;WinDbgを起動してTTDトレースファイルを読み込んだら、シンボルファイルをロードしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Try2WinDbg\traces\base64_trace
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが読み込まれていれば関数名で検索ができるようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt;  x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D base64!base64*
002372d0          base64!base64Encode &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_base64Encode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
002375a0          base64!base64Decode &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_base64Decod&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x /D モジュール名!関数名&lt;/code&gt;で各関数のアドレスが特定できました。&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;ブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;次に、各関数の呼び出しアドレスにブレークポイントを設定しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu base64!base64Encode
&gt; bu base64!base64Decode
&gt; bl
0 e Disable Clear  002372d0     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; base64!base64Encode
1 e Disable Clear  002375a0     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; base64!base64Decode&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行を開始すると、最初に呼び出される&lt;code class=&quot;language-text&quot;&gt;base64Encode&lt;/code&gt;関数の呼び出し地点で処理が停止します。&lt;/p&gt;
&lt;h3 id=&quot;windbgとghidraのイメージベースをそろえる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A8ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E3%81%9D%E3%82%8D%E3%81%88%E3%82%8B&quot; aria-label=&quot;windbgとghidraのイメージベースをそろえる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgとGhidraのイメージベースをそろえる&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;の出力から、Base64プログラムが&lt;code class=&quot;language-text&quot;&gt;0x230000&lt;/code&gt;に展開されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;        module name
00230000 002ac000   base64_exe C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;private pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  C:\ProgramData\Dbg\sym\base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\E82F6C1FD64A46D7AD5845CF4BD1BF431\base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ghidraのデコンパイル結果を元にWinDbgの解析をスムーズに行うため、Ghidraのイメージベースの設定を&lt;code class=&quot;language-text&quot;&gt;0x230000&lt;/code&gt;に変更しておきます。&lt;/p&gt;
&lt;p&gt;Ghidraのベースアドレスの変更は、ファイルインポート時の[Options]から行うか、[Window]&gt;[Memory Map]を開いて、右側にある[Set Image Base]ボタンから変更できます。&lt;/p&gt;
&lt;h3 id=&quot;解析したいポイントにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%9F%E3%81%84%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;解析したいポイントにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;解析したいポイントにブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;これでGhidraのアドレスがWinDbgのアドレスとそろったので、ブレークポイントの設定が容易になりました。&lt;/p&gt;
&lt;p&gt;先ほどデコンパイル結果からどんな挙動か把握できなかった&lt;code class=&quot;language-text&quot;&gt;local_94 = (byte *)((ulonglong)uVar4 &gt;&gt; 0x20);&lt;/code&gt;の箇所にブレークポイントを仕掛けてみましょう。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAAB50lEQVQozz2R627aQBCF/f4P0r5A+7OXpFWbtCiBcAsBG0oMiTEYr71re722vw7QZqSjkXZHM+fiXX/7zs+bWwaDKU/zFcFyzWb7QhhuWK0CwTNBsKQ/nPHu/YAPH4dcXc24u39m9vTCOowJd1vCbcRs7uMhZYwm3hXUNRRFjbW1vFm6roMTpEJ/ispyXGOwTcGlTv8N/6tpOjzXtJeFcYlSyDIni2uyTGGrEltYXG3ZLIYckwNaHUlUSmoMutSUtcy5Etc6tMx7JxY6z9hFGq0vDGtboY3CuZrWNbRyNFzNSdNMZvccs5hjfiQt9iSnrhOyKiXROV7lRM5rgr/OOOQQJRVxKoziir0wVmWHESvW0x5GGzlYkOYHlJA4iLJEZKlcUzhHXtqT5I4sN7xEJUkqDOVCUdYcZbAoS0xuqawlfOyR5ylOPCsrqIVIe3GR7p+HVqzyGpHzJlkY2kpCqaz4pc69qRvJpWEzH6L2a5T/iU1/yesoQAUBZh1Q7KLzwlqunFOuJNVUOWS3pHiB1hVt+xYgf7YhmTKkr+JZFBJHG3QSUUlIVithbDGiyPv85SvXP37x++6B216fXn/I3WDEaDw+YzyeMJk+ct8f8DCZMZkvGM4W0n2m/kLgs1gt8ZdLxqN7/gLkZKhOy9W53QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/8ac56/image-68.webp 240w,
/static/fd40540a66045f4e6161c4fcfc79b44c/d3be9/image-68.webp 480w,
/static/fd40540a66045f4e6161c4fcfc79b44c/b0a15/image-68.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/8ff5a/image-68.png 240w,
/static/fd40540a66045f4e6161c4fcfc79b44c/e85cb/image-68.png 480w,
/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png&quot;
            alt=&quot;image-68.png&quot;
            title=&quot;image-68.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下のコマンドで&lt;code class=&quot;language-text&quot;&gt;0x00237696&lt;/code&gt;にブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0x00237696&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行を進めると、問題のアドレスにたどり着きました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 637px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDElEQVQ4y3VUy47bRhDU//9FLgkQwIfYCAwYcJBL4EOCHFa7q+VSK0rim5wnHxLflRpK2fiSARrdMxqWuqeqexMEJwTBGWlaQCkLrSuaXePvzZ0raSCFgVYutu/m9vp+ZyNKASkV8jxHluWomwZd12EcR/oBfT/i2ndo+xa60sjKFLJRkJWEshLd1OP7tQkOB7y+vuJAfw5DXC5Xggzrj1L0KGSPxU5oH1t0hx4X74L6sV59t+uAGFj2CxDRzws2/quHp+dn7Pd7RFGEZVne/02UPbJiQGdb2JOFCQ2apIE5GKhAAZogdsEiaXq5Ab4RyGOG5/MZp9MJQkjM8w1UMbs8H2ErhWN0gqkNbGMhrWD5Boax2wtdotQCA59pczwG2L+9rWCu9OPxiJLv6pbWA21CU1uE55Dn/LAokMmMT1GgqiqmiHdz1W2OwQGe5yEMzyzbhzEGdV3zxsy4h9Ij9wZJksBayzduuK+YncHl2t7R8C+iy5CZ+Y6QBKXQGIb/3lCrBUUJZlKjKBTcS8wzME13G7He7/uZqriz7O++Yvv3D9g//4zdw4/Iw18wNr/zy28Q8VcU0W8wxWf4u58gsk9Q+Sek8QfGH6HLX1HJz5CMG/0F6P9wLD/hcfsnfO+B/i8EhydEocf0a5JCvVHMtUoR7HYo4xNi38PhuIVIzuiUBMYr0F0Alr9MDXUYBCyZpJwjlkWmBqY/3cq2ZoamLKZqRr1vcYmoyYLJO+3lvJDSk7/F+Yx7yndl2fd9yuaE7cMDttst+mG4s9yT2XFl2aYWaHhIvlbNOf0ZWnP3zoaVZZehDwfseS8reFU3d1J6inuCudxa7dpdUXUVFvz/2hyowRfKJgiO7OUMhtKYHIVchpJJMwrbKMoqhFCC/aspm4ZZ16uMWva+1nqV2rysneKvgE6H3svLOiCEECw1p5g5XeSMiiAeyYiLBFoopBwQSimCNui7Hm3NPr92N2Encby2XRwn7JiArVau5KRpzljx39m7blzlHFtlRbloCHfOuJItFUCTHBiMrWnwD0r7ueWbwqv4AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f94eefe8d82d62321840849257a4c708/8ac56/image-69.webp 240w,
/static/f94eefe8d82d62321840849257a4c708/d3be9/image-69.webp 480w,
/static/f94eefe8d82d62321840849257a4c708/63990/image-69.webp 637w&quot;
              sizes=&quot;(max-width: 637px) 100vw, 637px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f94eefe8d82d62321840849257a4c708/8ff5a/image-69.png 240w,
/static/f94eefe8d82d62321840849257a4c708/e85cb/image-69.png 480w,
/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png 637w&quot;
            sizes=&quot;(max-width: 637px) 100vw, 637px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png&quot;
            alt=&quot;image-69.png&quot;
            title=&quot;image-69.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここから処理の流れを追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;アセンブリを読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;アセンブリを読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アセンブリを読む&lt;/h3&gt;
&lt;p&gt;ブレークポイントを設定した箇所のアセンブリを読んでみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token number&quot;&gt;00237691&lt;/span&gt; e8 &lt;span class=&quot;token number&quot;&gt;94&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;c        CALL       malloc                                           undefined &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        ff ff
&lt;span class=&quot;token number&quot;&gt;00237696&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; c4 &lt;span class=&quot;token number&quot;&gt;04&lt;/span&gt;        ADD        ESP&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x4&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;00237699&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;89&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;85&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;68&lt;/span&gt;        MOV        dword ptr &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;EBP &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_9c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;EAX
        ff ff ff
&lt;span class=&quot;token number&quot;&gt;0023769f&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; bd &lt;span class=&quot;token number&quot;&gt;68&lt;/span&gt;        CMP        dword ptr &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;EBP &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_9c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;
        ff ff ff &lt;span class=&quot;token number&quot;&gt;00&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;002376&lt;/span&gt;a6 &lt;span class=&quot;token number&quot;&gt;75&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;07&lt;/span&gt;           JNZ        LAB_002376af&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;EAX&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;の戻り値であるアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;このアドレスを&lt;code class=&quot;language-text&quot;&gt;[EBP + local_9c]&lt;/code&gt;に格納して0と比較しています。&lt;/p&gt;
&lt;p&gt;ソースコードでいうところの以下の処理です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;残念ながら、Ghidraのデコンパイル結果のように&lt;code class=&quot;language-text&quot;&gt;local_94 = (byte *)((ulonglong)uVar4 &gt;&gt; 0x20);&lt;/code&gt;の処理を見つけることはできませんでした。&lt;/p&gt;
&lt;p&gt;試しにメモリアドレスの中身も見てみましたが、&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;の戻り値がそのまま格納されただけでした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; dyd &lt;span class=&quot;token namespace&quot;&gt;[ebp-0x98]&lt;/span&gt;
           3          2          1          0
          &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;
0059f800  00000000 11100000 00010110 01101000  00e01668&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;おそらくGhidraのデコンパイルの問題かとは思うのですが、いったい何をもとにこのシフト処理が出力されたのか謎ですね。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ほんとはBase64の処理をデバッガで追っていくはずだったのですが、いまいち面白い発見がなかったので割愛しました。&lt;/p&gt;
&lt;p&gt;次はRC4とかROT13あたりの暗号化処理を実装してデバッグしてみたいと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Windowsカーネルドライバを自作してWinDbgで解析してみる]]></title><link>https://kashiwaba-yuki.com/windows-windriver-001-tutorial</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windriver-001-tutorial</guid><pubDate>Wed, 22 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。&lt;/p&gt;
&lt;p&gt;なければ作ってしまおう、と思いカーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については以下の記事でまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B&quot;&gt;最初のドライバを作る&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#wdm%E3%81%A8%E3%81%AF&quot;&gt;WDMとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;シンプルなコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#driverentry&quot;&gt;DriverEntry&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#firstdriverunload&quot;&gt;FirstDriverUnload&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89&quot;&gt;システムスレッド（カーネルモードシステムスレッド）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;ドライバをビルドする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;対象プラットフォームの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;カーネルドライバをロードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C&quot;&gt;サービスの停止ができない問題&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B&quot;&gt;サービスを再読み込みする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;サービスの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D&quot;&gt;ドライバがシステムに読み込まれていることを確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B&quot;&gt;KdPrintマクロを追加する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;DebugViewを設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;カーネルデバッグで自作ドライバを解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;最初のドライバを作る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B&quot; aria-label=&quot;最初のドライバを作る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;最初のドライバを作る&lt;/h2&gt;
&lt;p&gt;とりあえず最初のドライバを作っていきます。&lt;/p&gt;
&lt;p&gt;VisualStudioからWDMプロジェクトを作成します。&lt;/p&gt;
&lt;p&gt;この時、本記事を執筆した2021/12/01時点では、VisualStudio 2022はカーネルドライバの開発に非対応でした。&lt;/p&gt;
&lt;p&gt;そのため、VisualStudio 2022以降にアップデートしていると、WDMプロジェクトを作成することができませんので注意が必要です。&lt;/p&gt;
&lt;p&gt;今回はVisualStudio 2019を使用しています。&lt;/p&gt;
&lt;h3 id=&quot;wdmとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#wdm%E3%81%A8%E3%81%AF&quot; aria-label=&quot;wdmとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WDMとは&lt;/h3&gt;
&lt;p&gt;WDMは&lt;code class=&quot;language-text&quot;&gt;Microsoft Windows Driver Model&lt;/code&gt;の略称で、Windows 2000以降のデバイスドライバーのアーキテクチャです。&lt;/p&gt;
&lt;p&gt;現在では非推奨のドライバモデルです。&lt;/p&gt;
&lt;p&gt;現在カーネルドライバを作成する場合は、&lt;code class=&quot;language-text&quot;&gt;Windows Driver Foundation(WDF)&lt;/code&gt;かユニバーサルWindowsドライバが主流になっているのかな？&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-wdm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WDM の概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WDMドライバには、以下の3つの種類があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bus driver&lt;/li&gt;
&lt;li&gt;function driver&lt;/li&gt;
&lt;li&gt;filter drivers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/bus-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Bus Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/function-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Function Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/filter-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Filter Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;シンプルなコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;シンプルなコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンプルなコード&lt;/h3&gt;
&lt;p&gt;VisualStudioでWDMプロジェクトを作成したら、適当な名前のC++ソースファイルを追加して以下のコードを追加します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(DriverObject);
	UNREFERENCED_PARAMETER(RegistryPath);

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;driverentry&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry&quot; aria-label=&quot;driverentry permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;は、ドライバモジュールのエントリポイントになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;は、システムスレッド（カーネルモードシステムスレッド）から&lt;code class=&quot;language-text&quot;&gt;IRQL_PASSIVE_LEVEL(0)&lt;/code&gt;のIRQLで呼び出されます。&lt;/p&gt;
&lt;h3 id=&quot;firstdriverunload&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#firstdriverunload&quot; aria-label=&quot;firstdriverunload permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FirstDriverUnload&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;FirstDriverUnload&lt;/code&gt;は、ドライバのアンロードルーチンを定義します。&lt;/p&gt;
&lt;p&gt;関数名は&lt;code class=&quot;language-text&quot;&gt;FirstDriverUnload&lt;/code&gt;以外に変更しても問題ありません。&lt;/p&gt;
&lt;p&gt;上記のサンプルコードではまだ定義されていませんが、&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;DriverUnload&lt;/code&gt;に指定することでドライバモジュールのアンロード時に呼び出す関数を定義します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;// アンロードルーチンを定義
DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーネルドライバの場合はアンロードされるタイミングでメモリリソースなどの解放が必要となるため、このアンロードルーチンでクリーンアップの処理を定義します。&lt;/p&gt;
&lt;h3 id=&quot;システムスレッドカーネルモードシステムスレッド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89&quot; aria-label=&quot;システムスレッドカーネルモードシステムスレッド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;システムスレッド（カーネルモードシステムスレッド）&lt;/h3&gt;
&lt;p&gt;システムプロセス(プロセスID 4)が実行しているスレッドがシステムスレッドであり、カーネルモードで実行されています。&lt;/p&gt;
&lt;p&gt;システムスレッドは、&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;か、ロードされているデバイスドライバのカーネルモードコードを実行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3ei56Eg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;インサイドWindows 第7版 上&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ドライバをビルドする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;ドライバをビルドする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバをビルドする&lt;/h3&gt;
&lt;p&gt;最低限のコードが作成できたらカーネルドライバをビルドします。&lt;/p&gt;
&lt;p&gt;とりあえずデバッグビルドで作成するので、[Ctrl+Shift+B]を押してビルドします。&lt;/p&gt;
&lt;h3 id=&quot;対象プラットフォームの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;対象プラットフォームの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;対象プラットフォームの設定&lt;/h3&gt;
&lt;p&gt;今回はx64環境向けのドライバモジュールをビルドするので、VisualStudioのプロジェクトのプロパティから、[アクティブソリューションプラットフォーム]の設定を[x64]にしておきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 944px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACu0lEQVQ4y41TS08TURSeH0DCig1pEDCgCa8N/gckboj/g3/QhQsXmCBuCW4AY4GakCBqQmq7wIUYQyAQGzt9t9PpPDswnU6ffJ5zSxF1gTf55t5z7z3f+c45d6Sjo68wDB2ZTAalUgmapkHX9S5orWllFItFcVYul6+hIpfLwbYs7O3tIRAIYGhoSEA6PPyCRCKJH/GfKCoqlJKKhJxCLl+EbljQdBPZXAH5AtsmDNOiYCYy2TzsioP9/Q9/Eh59+w45mSEyDWXNIgcHqXSOnG20r4BWB3A9n85L8Go+rmivQ2jzh0Y0GsXg4OBvwtPTU1gk3TRNeF4VFeeS0skLu9lsCifHcaAoCkxS6DgX6HQ6aLXb4iwWiwmikZERDA8PQzo5OYGqqqJOruvi4tKFnJCRTKZQI0U8DN3A+fk54vG4qCWTtVotcXZwcIC+vj709/djYGCgS6gQWbGowPd9UmYhm82iQvVhhfV6XQSybRuXFKy3x3fbRJxOp7G6uoqNjQ0sLi5eE1I6CVJlWbZQyx0vFAqQZVnYvZIYhoF8Pn8DDsyvwa/VhNpwONytIW/26laiLnNqqVRGOMly8tpOdUGKVLUsyFV6QjqVI0PErlvF+vo6KSRCll6jKAyNyPmtsVpOrd3uiCC8V6lUUKJuswAuAZeCfbhRPLa2tiEdHx+LzW6NuMNZkSJ3lgkYvO7Zf695Zl9u0ubmG0hnZ2eoVquCxPM8kTZDXL7lfJvg9ppn9u0SbkIKBoNYWXmF5eWXWFp6gbW11/843wUm5O6HQiFIY2MPMTo6Bp4DgXuYn39ykwZf5PkuWJRRq9lAeGcH0uTkNKamZjAxMUXE97Gw8BSNRlO8s/9Bve7DvnDhNq4Q2n4HaXb2ERjT0zMYH3+AubnH4neKRCKEz3cgglj0M3bff8Lb3Y8IPnuOX6ZgBqT8x/wCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/8ac56/image-58.webp 240w,
/static/e5202bb713f0239c106e61aa9276e9d5/d3be9/image-58.webp 480w,
/static/e5202bb713f0239c106e61aa9276e9d5/59b61/image-58.webp 944w&quot;
              sizes=&quot;(max-width: 944px) 100vw, 944px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/8ff5a/image-58.png 240w,
/static/e5202bb713f0239c106e61aa9276e9d5/e85cb/image-58.png 480w,
/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png 944w&quot;
            sizes=&quot;(max-width: 944px) 100vw, 944px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png&quot;
            alt=&quot;image-58.png&quot;
            title=&quot;image-58.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここがデフォルトの設定のままだとx86環境向けのドライバモジュールがビルドされるので、64bit Windowsで起動しようとしても失敗する問題が発生します。&lt;/p&gt;
&lt;h3 id=&quot;カーネルドライバをロードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルドライバをロードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバをロードする&lt;/h3&gt;
&lt;p&gt;ドライバのビルドができたら、ビルドしたドライバモジュールを仮想マシンの&lt;code class=&quot;language-text&quot;&gt;Z:\FirstDriverSample.sys&lt;/code&gt;として配置します。&lt;/p&gt;
&lt;p&gt;※ここは任意のフォルダ、ドライバ名でOKです。&lt;/p&gt;
&lt;p&gt;次に&lt;code class=&quot;language-text&quot;&gt;sc&lt;/code&gt;コマンドで、作成したドライバを&lt;code class=&quot;language-text&quot;&gt;001_sample&lt;/code&gt;サービスとしてロードします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create 001_sample &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= Z:\FirstDriverSample&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;成功すると次のような画面になり、レジストリの&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentControlSet\Services&lt;/code&gt;配下に追加したサービスが登録されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB0UlEQVQ4y6WT227aMBzGzVFI3PCa3WWhWqXuMRBQngEhTm+wabftzS4mrQu0FMg5ThwnDShfbUOAbhdNN0u/+PT35892/uTHwyNWax2rjSkwYFo2TNOC7XhwPQrHFTUNBD4c2xFjvupTAfMDBJQqvEMs8cTH1h/w/LzE0+JRiJlYLpciwFNtxhg45+BhuK8FcRz/xXa7xW63A+FxAk7nMA0dtu1DFrk4TVPhguIjRa4hjMdgrgbLMvH123f0bm/R7/fR6/UUWbvb7R7pdDpHZL/dbkPTNCVKQh4hcH7D9yk+X1+DEIJ6vY5yuYxKpaJqOfYek8lkL8gPgowFuLn5okQajQZqtRpKpZJCimYb/Em1WlWCs9ns5JBav8SlJmi1rtSkDMzj6pzpdHoSdI2f4vVCNJstNVksFnMLFQqFt4Is5OpRkiTG5WVTTcpj/rNgKP4reeQ45keH8r5kYB6y05zd4d5hFHFcXHz68N1ljMfjg6A8sqdB1ze4u7vHYDBQk6PRKDfD4RDr9frkMPKfYBgb/G9RmSLzMPTmIu0svLwkKh+zvMyLjJdiyqEU5P5CWF6Jl94ed8oCkOa1t6+I4zqgzgKLuXyY6K1gehb8Hoe4V6zTlknLrnNnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/817cd8b424ed771b6a711b20326e9a20/8ac56/image-22.webp 240w,
/static/817cd8b424ed771b6a711b20326e9a20/d3be9/image-22.webp 480w,
/static/817cd8b424ed771b6a711b20326e9a20/b0a15/image-22.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/817cd8b424ed771b6a711b20326e9a20/8ff5a/image-22.png 240w,
/static/817cd8b424ed771b6a711b20326e9a20/e85cb/image-22.png 480w,
/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、追加したサービスを起動します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sc start 001_sample&lt;/code&gt;コマンドを実行すると、起動に失敗します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; StartService FAILED 1275:
このドライバーの読み込みはブロックされています&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、64bitのシステムドライバには署名が必要なのに対して、自分で作成したドライバには署名が付与されていないためです。&lt;/p&gt;
&lt;p&gt;このエラーを回避するため、ドライバを検証する仮想マシンをテスト署名モードで起動します。&lt;/p&gt;
&lt;p&gt;以下のコマンドを実行し、再起動すればOKです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt; testsigning on&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;※ OSを再起動するまで、テスト署名モードには移行しません。&lt;/p&gt;
&lt;p&gt;※ セキュアブート環境の場合、テスト署名モードへの移行に失敗します。&lt;/p&gt;
&lt;p&gt;再起動には、管理者権限で起動したコマンドプロンプトで以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;shutdown &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;t 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再起動後、再びサービス起動を実行すると、登録したサービスが起動しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample
SERVICE_NAME: sample
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; NOT_PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IGNORES_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 0
        FLAGS              :&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次はサービスの停止を実行します。&lt;/p&gt;
&lt;h3 id=&quot;サービスの停止ができない問題&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C&quot; aria-label=&quot;サービスの停止ができない問題 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスの停止ができない問題&lt;/h3&gt;
&lt;p&gt;ここまでのドライバモジュールでサービスの停止を実行しようとしても、停止に失敗します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; ControlService FAILED 1052:s
要求された制御はこのサービスに対して無効です。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、ProcessHackerなどのツールを利用してサービスの停止を実行しても同様になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACN0lEQVQ4y31UibKiMBDk/39vtZ6CgCI3yH2K2K8niKuutamaIoFJz9E9aHESoW1b1HVNazAMA263m7J5njHxeb/f8brkvJr4jeOI6/WKoiyh/ex+EHgubMuGYRyQpimyS4YwDBFFMZIkwSWJkeU56qpGyUsSvOs6ZVVVIYkT5Pzu+QG0zeYPL6UKYL/f8xkhjmMEQUDAiM4xLMuCruvqXVEU6PteZScViK0VSHDNsk3WAOXkMVOJNk0TekZvmqUFASOHYUCfAd/WCijBNJ1ZSeoCeDgcVBayF1tL830fruuq8j57uNoCyB7q+l41tetaOCcHRV6gI0lNXSmAllm65zNOpyP7VyyALPOToGeGe8NQDEkmlmnhzMt+lCDKS5RVg7YbkF5yxOkFddvhOs3ox0ntIWCfJVtkV/qkANl81/ORkd3+sEPbL+8bybhpKa+lr1JRw0DzI9M3QIPsSbNFiwklI0vk0VGf4zjwW6cIEuCRgWsCe0mBOKueQO+kUHsqQwIe7aPSU8lLYZrBMG04roejc4Z1PPFswT772Jou/CT/3sOdbpKIXGVgsJ/CqOyFYds+KY16nkdSHEQPSf3N7AugyagC0LaNIkUui0Tko1hD4EBkQ7K+yebfHpomqpIS4Ug5joM8y5+6FEGX1FbE6VmE3VMRo2rRK/A8v5ZMYTePn4Jt22pSREYTLWW5wqoAi5xk/78lc65ttxvl7LHMdVJklmW2JaI4xdFyznlulYSaN1snSnx+Ae3/e/VyADnqAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/8ac56/image-62-1024x756.webp 240w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/d3be9/image-62-1024x756.webp 480w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/e46b2/image-62-1024x756.webp 960w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/a9a89/image-62-1024x756.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/8ff5a/image-62-1024x756.png 240w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/e85cb/image-62-1024x756.png 480w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png 960w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png&quot;
            alt=&quot;image-62-1024x756.png&quot;
            title=&quot;image-62-1024x756.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これは、前述したアンロードルーチンをデバイスドライバに実装していないことに起因します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://proc-cpuinfo.fixstars.com/2017/06/windows-device-driver-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsデバイスドライバの基本動作を確認する (1) - Fixstars Tech Blog /proc/cpuinfo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、コードを以下のように修正しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);

    // アンロードルーチンを定義
	DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでデバイスドライバを再読み込みし、サービスを起動した後に&lt;code class=&quot;language-text&quot;&gt;sc stop 001_sample&lt;/code&gt;コマンドを実行すると、サービスが停止できるようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
SERVICE_NAME: 001_sample
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          続いて、サービスの確認を行います。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;サービスを再読み込みする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B&quot; aria-label=&quot;サービスを再読み込みする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスを再読み込みする&lt;/h3&gt;
&lt;p&gt;サービスの再読み込みのためには、一度登録していたサービスを削除する必要があります。&lt;/p&gt;
&lt;p&gt;以下のコマンドでサービスの削除と再登録が可能なので、これを&lt;code class=&quot;language-text&quot;&gt;reload.bat&lt;/code&gt;などの適当なバッチファイルとして保存して使用していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; delete 001_sample
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create 001_sample &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= Z:\FirstDriverSample&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次は登録されたカーネルドライバのサービスを確認します。&lt;/p&gt;
&lt;h3 id=&quot;サービスの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;サービスの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスの確認&lt;/h3&gt;
&lt;p&gt;そもそもサービスとは、という話を簡単に触れておきます。&lt;/p&gt;
&lt;p&gt;Windowsにおけるサービスは、サービスコントロールマネージャー（SCM）によって開始されるプロセスを指します。&lt;/p&gt;
&lt;p&gt;カーネルドライバを追加した場合、サービスとして追加されるのでややこしいですが、多くの場合「Windowsサービス」と「ドライバサービス」は区別されることが多いようです。&lt;/p&gt;
&lt;p&gt;インサイドWindowsでも、「サービス」とはSCMによって起動されるユーザモードプロセスであり、デバイスドライバはサービスとしては扱わないことが明示されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3ei56Eg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;インサイドWindows 第7版 上&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/win32/services/service-control-manager&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;サービス コントロール マネージャー - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルドライバは先ほど確認した通り&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentCntrolSet\Services&lt;/code&gt;のサブキーとして登録され、SCMで起動されます。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentCntrolSet\Services&lt;/code&gt;に登録されたサービスはカーネルドライバとWindowsサービスとで区別されており、各サブキーの[Type]の値が小さな値のものはカーネルドライバであり、0x10もしくは0x20の値のものはWindowsサービスとして登録されていることを意味します。&lt;/p&gt;
&lt;p&gt;実際に登録されたカーネルドライバのサービスは、ProcessHackerやProexpなどのツールによって確認することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 835px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpUlEQVQ4y3VUaY+bMBTM//9pVT+1ym4uwEA4w2EgHAmQ6bzHRlpVrSXL4Jh5czxnl2Qx2qZBVZWwtkFZlOi6Ox6PBx7TA+M4YZomPJcVM9/xeuEFWbb177EzgY8sTZAmEYwfIEkS1FUNW1vUZYWyZKG6Rt20sMUNj3FkgW2O44C+73UOX+vucPxEGIZkWMPzXOz3e+R5rkBVXSGKYrgmQJbfcDhd4Pkhfv3eww+uSLkXXCM0VNQPouSB3flyQhCEmOcZeZbBGEPG2QZIhkGU4Ox4cD2DKE5RsHCS5ShKsqZFlswHAglo3d6xc7wz2rZV/VVVwfd9FgjQ8OC6LOiGUW24Xq9orIXxPBRFwb0YcRxr4dPxiGsUoawb7FzXQUDvNsASR/4oB2+3GxYCtveBzwWGYVAVEpLsy/vz+fzaGzXQYgO8IKVEBWQ1Ydjwx7bt1OjKtvSH5t/v+uHI51GDmTQES9YCXjG4orIENA5DuCmgJGvoVRiEKl8Am65HToYi+XQ6aUHxWT3mGbEnotxMgmTxXRhn+sPGkB6azcMkTZWBAIo/4p/rujrFkoa9q4w5U57NaZECysdptkmuSduQgVSUUKR5BTBlqtbWyvByuei5Oy0QUAlUnmuqUw8DAkiK75QljO9DQumHrYnXddU9CUXCkPU9J96s0koonq+N/A5Fmlxk6CDD9t5jWV/vV2X9rzETVCU77HiRrYC8x67j0kejkt8M50WYvbb7+48p40nGytAPYziOo7SF4eFw0AIZfZV3aZv1P6y+j5UqlKG0wFtyQf/E9CROtqSZZtV09GvRW7P5NfNj8eyJqh3Q9pP2oYSjoZyNpz3WdZ1eKcO2Kdh30rDipVyns8ve5J+EH0bbyj51wgQ/Pgx+fjj4PDn4OBwJaPEHXr3AFDq1+HQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/8ac56/image-59.webp 240w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/d3be9/image-59.webp 480w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/2321d/image-59.webp 835w&quot;
              sizes=&quot;(max-width: 835px) 100vw, 835px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/8ff5a/image-59.png 240w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/e85cb/image-59.png 480w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png 835w&quot;
            sizes=&quot;(max-width: 835px) 100vw, 835px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png&quot;
            alt=&quot;image-59.png&quot;
            title=&quot;image-59.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、ドライバ（.sysファイル）がシステムにロードされていることも確認してみます。&lt;/p&gt;
&lt;h3 id=&quot;ドライバがシステムに読み込まれていることを確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;ドライバがシステムに読み込まれていることを確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバがシステムに読み込まれていることを確認&lt;/h3&gt;
&lt;p&gt;Proexpで、[Lower Pane View]から[DLLs]を開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 786px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 100.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAES0lEQVQ4y1VUiW7bRhDVN7dA0KBAPyABCjRtgRQBEuRoDiRwkBaJ4zOOY8l2bImiqJMURYqieIgiJUqUZR3269s1GrQLPOxyZ/dx5s3s5KJBiJ7rom65sPoDhIGPMAy/YTAYYJKmGI1GGKcTjMepnC8XSyxXa6yIxXJFLLleIef7MeIoQBRHcFwP3W4XvV6PF8cSk8kEcRzLH6WRiyzsYpGNcJmNkcYB4tDFLI2RpQmSJEGu73vYqQQ4aCSwbAdmuw1dN+D7PrIsk4STdAS7H+EvJcKH6gT7xgL77aXErj7HgXWNSgg5cgndP6zY2K4OoNv00OrAIKlNT/t9j2EPMCNxPxxip2TjoOoTHg7rIU7NEY6aA+T1BN2xoLtGzgtjuHYHLSdCw7DhWCbcngPHtuB7fYyTmIRTJIMAQ0tH5jmYBT1kfg9Tr8u9FmZ+l2Qr0tFDIaTnBShoFmp2AMN20fWHCJIMfjKFF0/gDUY4bzu487mA307O8EtJxT2tiZ8LCu5+OsHdvIKtcHIT8pKEuFrhkK5vnLnYKOjYpKafzRk+tac4MDPsNUf4SI33TBdlaq4Qn3UTv77+gjuPt3Hn6T7+PjZvCNfrFbLZHB0mJPJd2GYbkxHDnIwxm47lvJhnsNoG7v/2B36/dx8PHzzBg/uP8OMPP+HW97dx67vb+PPJixvCq6srDIcJDL0Dy7JQUTUmxeRejJQZHrF0pkxKr+vi4P0nnOzkUf5Sgl5sQTks4uveMcqc035yQyg0dHse7FYbQRjAtm0EQShLJmVBi7K5mF/Ac/oofsijvl+EunWK2l4J1d1zKJvHqG6fIWkFWK1lYfus/BTDZETiHur1OpPky2IW8P2Ahe7A80PUWz1UajZ0M4BpRzA6IVptD22LLyy6wHQ6Ra7VamG9Xkt3RXjlcpmFrcvwhYedTgfn5+cwDB2r5SVqNY32JiVqos71iHr/d+RqtZokEDoJPUWo8/kcs9lMvs3Ly8v/7ZVKJf5UhaqqctY0DS57wdXVNa6vWdgaDR3TxGqxwAUvirBteiUaghiDIODrsRBQGvFiFBJWGIW4V+a6qmmycQiyG0I+sw4viZHSI9UwoNLjJp/egAQWbUqzCSeKsOCZMiUSd2r8qVirhPD8W8hfnz+H+uoV3N1d2FtbKL98ieqbNzDfv4e1uYnG27dyT8zO9jYKjx7hmDh79gyKuPvuHZPoyTYniHM1Hna4mR0dIfz4EQ0ear54IedoZwc2ibSnT2G8fo0hv8skqzx+DFXg4UPUNjZk8i6o8ZI9MVelfn1q8G/IFYbTYLgaQ5oySc5wiDJlaNOLCxEy5ajwjkY0HLa7fl/Wquw1QsMaRRWii5HRIL4N6iKSMWNdCVu9WpXzkhlXFQXVSkVCJEbYRCP+puHp6SlOTk5k6VRpFN+i7hqNhkSxWET+KI98oYAKSYRNoERiRSlzXeS5Jkx63OaT/Qd/JJ8rm+28SgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/8ac56/image-60.webp 240w,
/static/92071d128e5860eb218f94bc82b0ce0b/d3be9/image-60.webp 480w,
/static/92071d128e5860eb218f94bc82b0ce0b/4cb1e/image-60.webp 786w&quot;
              sizes=&quot;(max-width: 786px) 100vw, 786px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/8ff5a/image-60.png 240w,
/static/92071d128e5860eb218f94bc82b0ce0b/e85cb/image-60.png 480w,
/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png 786w&quot;
            sizes=&quot;(max-width: 786px) 100vw, 786px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png&quot;
            alt=&quot;image-60.png&quot;
            title=&quot;image-60.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;画像の通り、作成したドライバモジュールがロードされていることが確認できます。&lt;/p&gt;
&lt;h3 id=&quot;kdprintマクロを追加する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B&quot; aria-label=&quot;kdprintマクロを追加する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KdPrintマクロを追加する&lt;/h3&gt;
&lt;p&gt;次に、デバイスドライバにPrintメソッドを追加します。&lt;/p&gt;
&lt;p&gt;その前に、カーネルドライバの&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;の出力をDebugViewで拾えるようにするために、&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentControlSet\Control\Session Manager&lt;/code&gt;配下にサブキー[Debug Print Filter]を作成し、DWORD型のキー&lt;code class=&quot;language-text&quot;&gt;DEFAULT&lt;/code&gt;を追加して、値を1に設定します。&lt;/p&gt;
&lt;p&gt;※設定の反映にはOSの再起動が必要です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 124.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC/klEQVQ4y6WVSXPaQBCF+f+nXFIunwIHV8q55Z5U5RTH8YKNMZLQjpBAAiEJtKD1pWcAb7FTAU9VFxoB33TPvH7T+m168N0pNN1AEETIixJ5nmO9XqMoCqRpiqZpwEZd1zzYYO/qqkazm2+/ay2XEaIogufN4XsaLFOCphlQVQ1hGNEiAVzPQ7haoaI/sph4MyS0KFsmJ0iUJCjqBiXNW2VZMTxoMTSpClU8gzTUKNMcu2HLKoSfv7ByHIDA48GARzGfo6YFh5eXULpdrGnhFiurqioC1CgTHc6oD2+2wLYunpH7/Qecj0fwO22kp6dYdDpwjo/htzdz9swiOjnZAOu6QlFSyrGK+USC7bjIsowzy7JEtFw+ZNvg+Xg5fwDmxQZomz2IogJ5OKTqYn4wbC9Zts1bUT8+v8hQhqXfQBBkCLRHrutRpmt+aLuT3QW28XT+DMj2MF9ptIc9KIoBQ9d5OQ0dWBiGfwN3JT+ZPwHWVFqJskiRBXcwDQOWNYZDp7qiU42i5aHAHNniBpqqwB47lDUJmzT2asn/BSzXSP1rSMIA1timLsl4x4QHA4sNUCSgN5sjpnJZ670LmAU9WKMR4jh+1OG7gLSH1sikQ7FgmiOSjkt9PjsQmGdIvUvIImlwMkFKJQeLBXWOcwAwp54m5SW5BGFswSVBsxGTq9i2vSeQzIE6D7muYdz+gO7RJwjtL9A7nxEO7uGQi+wJLMnPCGjfYvrtK/yzcywvLoD7e4Qkcns63bdkypCZw9rA1NcwS3IE5Dbl1kDn5Ht7Azduo0CXzslpNCTxCjmJuiLZHKDDrdskGkz1GubI4dafJinXIbevfYAV20PKsIg1uLaA5SrlLcd+8BaweWFfD37I7J/5LrtT6lTDhOxLN8aYkA4ZjH0fBOGrwNcybrH9YeUtFvQ5k0nUXbqkFPi+z/WZkNvsMvzX2F2xLYGMoN/v4+b2Fr3eHY+rqyt06RYTRZFCgiRJGA5lMl66GmSF7E3j72VZ5tetNbJ4vzMj/gOlaYYc0p/6eQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/024db07d72761c7ed65f81cf9a321a17/8ac56/image-64.webp 240w,
/static/024db07d72761c7ed65f81cf9a321a17/d3be9/image-64.webp 480w,
/static/024db07d72761c7ed65f81cf9a321a17/cc661/image-64.webp 660w&quot;
              sizes=&quot;(max-width: 660px) 100vw, 660px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/024db07d72761c7ed65f81cf9a321a17/8ff5a/image-64.png 240w,
/static/024db07d72761c7ed65f81cf9a321a17/e85cb/image-64.png 480w,
/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png 660w&quot;
            sizes=&quot;(max-width: 660px) 100vw, 660px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png&quot;
            alt=&quot;image-64.png&quot;
            title=&quot;image-64.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、デバイスドライバのコードを以下のように書き換え、ビルド後にデバイスドライバを再読み込みします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);

	KdPrint((&amp;quot;This driver unloaded\n&amp;quot;));
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);

	DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;

	OSVERSIONINFOEXW osVersionInfo;
	NTSTATUS status = STATUS_SUCCESS;
	osVersionInfo.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);
	status = RtlGetVersion((POSVERSIONINFOW)&amp;amp;osVersionInfo);

	KdPrint((&amp;quot;This is my first sample driver\n&amp;quot;));
	KdPrint((&amp;quot;OS version is : %d.%d.%d\n&amp;quot;, osVersionInfo.dwMajorVersion, osVersionInfo.dwMinorVersion, osVersionInfo.dwBuildNumber));

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;マクロを使って、現在のOSのバージョン情報を出力しています。&lt;/p&gt;
&lt;p&gt;OSのバージョン情報の取得には&lt;code class=&quot;language-text&quot;&gt;RtlGetVersion&lt;/code&gt;を使っています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlgetversion&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RtlGetVersion function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;取得した情報は&lt;code class=&quot;language-text&quot;&gt;OSVERSIONINFOEXW&lt;/code&gt;構造体として取得されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-osversioninfoa&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSVERSIONINFOA (winnt.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;typedef struct _OSVERSIONINFOA {
  DWORD dwOSVersionInfoSize;
  DWORD dwMajorVersion;
  DWORD dwMinorVersion;
  DWORD dwBuildNumber;
  DWORD dwPlatformId;
  CHAR  szCSDVersion[128];
} OSVERSIONINFOA, *POSVERSIONINFOA, *LPOSVERSIONINFOA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;debugviewを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;debugviewを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DebugViewを設定する&lt;/h3&gt;
&lt;p&gt;SysInternalのDebugViewでKdprintマクロの出力を拾っていきます。&lt;/p&gt;
&lt;p&gt;まずはアプリケーションを起動し、[Caputure]から[Capture Kernel]と[Enable Verbose Output]を有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 453px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 110.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD2ElEQVQ4y22VSW8bRxCF+TtzSW52HCXRVYl98A+wlZNgJIoMGIkudmxAt0DQvu8rF4mc4T5DcjgiRZHapZf6OiaDBGmgwJ6eqlevXlUPE0s7e6pWqqqFoeLmmRpRU/l8XoE9h2blclmNRkONekM3NzdiPTw86PHx8X8tUaqECqqhCsWypnd8/blb1GmxppKXUxxFqpZLymZOVDfwUr6gq14PRD3e3ztgrL/YJ1LJTc3MTGlmfkaTqa72g1iZalWpUkm5Wl3x7a0al5dq3T+oaQyj62t5xjiIz5ROpRTWalpbW9PBwYHa7bYShYKnZrOu0uTvqo79rODNG+VevZL/+rXyo6P2O6rQzs4mJnT29q1is2hsTNHysgKT58YSnJ+fO+t2u0q0L7q6a7VV/PIrzf70m/x3k/LHfzEbV/7XCcXvP6j18aPanz6p9eEPxVNTKrx4ocbLlyobo0qxqJqxBJCVaMSxrhp1+d8Na3w91lExVDKTViqbU8bzVLDyi0Eov1JR1GqpY0HhxoaiH5/Lq9eVTiblmR8NdBqGQaDOZU+pkR+08sU3yg19L//JE/lPv3ZWGvrWbMj2TxUMDysaGdHZs2dqWQWnluRwb09HR0cqGlPXZQB7BniQTCnl2Zjki/IzGXnptPKnpzpvNtX5bG3rettYVQsFNawpuVxOSWOYzWb/YRiZE/XvW6Zet6OoGcmzOaxYqVVLdn5xoY6JjV1gva7Kxoy5zOaySlvik5MTN68OsGqBtHtra0slO/R935WQy3kiWWCgDHb4edCx2HTnXcYqOTw8dKDg/F2yOQCYspnaMLFPrUzaTxlLS0vurGAl7u/vu+fNzU3t7Oxod3fX3Sj8/9UUxCTb9va2FhcXHXUWzuvr6y4YlsfHx5qfn3eV4Ms5sewZapI6hhXT48J0gjbOBPOCjDgRxBkJ8KERSIDuPbuGnU7HGXsHSGmUSAkLCwtOPxZaLttt4FpREqVOT09rdXV1oBtJkYqy2Q8Ygk4QYNDnBaVTDsH9BlAmPuwBohF91gMNYXJpl5/yYNEHJBESwJw9GtKUvob4kZRzwEv2MXEMYXZ1deU06gOSCe0Ag1HdhpmglZUVB8YZRiIqgPFgbACEIVoCyJDyAsaA40wVBJIEcMrrN4aZxNg7QALQkGDGpt8UEszNzTlGAKEfCSmRd8TxlUFDSJFo0OVr+6YBRIk48gIQgjmnKQjf145zgBin/mCzd02hRBiSfXZ21jmzcNqz+81wIz5ADDZ+AJOcRnCDSDpoCjPIurVPPc3hl3V3d+f+lLB7+//gHOOZX97/1wD8C7ehKnzFNI1QAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/8ac56/image-66.webp 240w,
/static/f15f75aa75f9687bbf2686d7e50e4671/2430e/image-66.webp 453w&quot;
              sizes=&quot;(max-width: 453px) 100vw, 453px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/8ff5a/image-66.png 240w,
/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png 453w&quot;
            sizes=&quot;(max-width: 453px) 100vw, 453px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png&quot;
            alt=&quot;image-66.png&quot;
            title=&quot;image-66.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、ツールバーのキャプチャボタンを押してキャプチャを開始した状態でサービスを起動すると、DebugViewでOSのバージョン情報を取得することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABy0lEQVQ4y52S20pCURCG1/aUhwRTEcsrL3yNyCwqoh6gCKLzgYiIniOIbrqJ7sIwJeoiqF4iEIWCgih129EySc2/NdMuysgOC35mZi/WN/+stcWlqkLNpJDJpJHNZpHL3SKXz8uYQ6FQ+LPE2ekp0qlzJBIJpC4uoKqvYMrzEvz4mOf4W4nDeBzq9TXiySSSR0c4PjnBze0dHuTmf5bIbG/j7uAAV7u7SO/s4H5vD/ubMaysrmF9PYzIZhTR2BYi0RgrvBGpKYFKBSiVgHIZz09P3GV0bBxCCNjr66HX6Ti3mM0w19VxXlMEqGgqEliuweERCEVBIBCAw+GAxWKB1+uFyWSCIr/rZBOFpGh6rxUNKF2SShpwfHKauzU1NjKMRDC9Xv9Lh1XAufkFmOR4Ho+HndntdpjlyDabDUajEQaDgWO1vnU4MzvHmy6Xi0cmEDkkp+SSRtZpI1KkBqRvgRNT03yHDRJGnekQuXW73XyQagJT/uUaPgLfHmVoZJQ3/X4/nE4nO/P5fDw65VarlWWTfwHVbw0ofgYWiwzs6x9gII374yPUepSy/BdpLS4to7mlFd09vejs6kaovQMtwRCCoTYEWz+oupZ6AewCe2nx8DgEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/8ac56/image-67-1024x642.webp 240w,
/static/8a20c71a43fccf4a87343dbe533bf956/d3be9/image-67-1024x642.webp 480w,
/static/8a20c71a43fccf4a87343dbe533bf956/e46b2/image-67-1024x642.webp 960w,
/static/8a20c71a43fccf4a87343dbe533bf956/a9a89/image-67-1024x642.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/8ff5a/image-67-1024x642.png 240w,
/static/8a20c71a43fccf4a87343dbe533bf956/e85cb/image-67-1024x642.png 480w,
/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png 960w,
/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png&quot;
            alt=&quot;image-67-1024x642.png&quot;
            title=&quot;image-67-1024x642.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後は、自作のドライバに対してWinDbgでカーネルデバッグを仕掛けてみます（ようやく本題）&lt;/p&gt;
&lt;h2 id=&quot;カーネルデバッグで自作ドライバを解析してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;カーネルデバッグで自作ドライバを解析してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルデバッグで自作ドライバを解析してみる&lt;/h2&gt;
&lt;p&gt;まずはカーネルデバッグを有効化します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;debug on
bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;dbgsettings serial debugport:1 baudrate:115200
shutdown &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;t 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;詳しい設定方法は以下の記事にまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの接続に成功したら、今回ビルドしたドライバのpdbファイルをSympathに追加します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\source\repos\Try2WinDbg\drivers\FirstDriverSample\x64\Debug&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;モジュールの一覧を参照すると&lt;code class=&quot;language-text&quot;&gt;FirstDriverSample&lt;/code&gt;の存在が確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
fffff800`64520000 fffff800`64527000   FirstDriverSample   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
fffff801`74000000 fffff801`747cc000   nt         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\ntkrnlmp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\F7971FB6AA7E450CBCA7054A98D659421\ntkrnlmp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
Unloaded modules:
fffff800`62c80000 fffff800`62c8f000   dump_storport&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62cc0000 fffff800`62ce5000   dump_storahci&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62d10000 fffff800`62d2c000   dump_dumpfve&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`63400000 fffff800`63413000   dam&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys 
fffff800`61ec0000 fffff800`61ed0000   WdBoot&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62ba0000 fffff800`62bae000   hwpolicy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルがロードされているので、関数名も確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;f FirstDriverSample!d*
fffff800`64521020 FirstDriverSample!DriverEntry &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;struct _DRIVER_OBJECT &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; struct _UNICODE_STRING &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff800`645210f7 FirstDriverSample!DbgPrint &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DbgPrint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uf&lt;/code&gt;コマンドでエントリ関数のディスアセンブル結果を見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; uf FirstDriverSample!DriverEntry
FirstDriverSample!DriverEntry &lt;span class=&quot;token namespace&quot;&gt;[C:\Users\Tadpole01\source\repos\Try2WinDbg\drivers\FirstDriverSample\FirstDriver.cpp @ 13]&lt;/span&gt;:
   13 fffff800`64521020 4889542410      mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+10h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rdx
   13 fffff800`64521025 48894c2408      mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+8]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rcx
   13 fffff800`6452102a 4881ec68010000  sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;168h
   13 fffff800`64521031 488b05c81f0000  mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!__security_cookie (fffff800`64523000)]&lt;/span&gt;
   13 fffff800`64521038 4833c4          xor     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp
   13 fffff800`6452103b 4889842450010000 mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+150h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rax
   16 fffff800`64521043 488b842470010000 mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+170h]&lt;/span&gt;
   16 fffff800`6452104b 488d0daeffffff  lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!FirstDriverUnload (fffff800`64521000)]&lt;/span&gt;
   16 fffff800`64521052 48894868        mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rax+68h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rcx
   19 fffff800`64521056 c744242000000000 mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+20h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;0
   20 fffff800`6452105e c74424301c010000 mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+30h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;11Ch
   21 fffff800`64521066 488d4c2430      lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token namespace&quot;&gt;[rsp+30h]&lt;/span&gt;
   21 fffff800`6452106b ff158f0f0000    call    qword ptr &lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!_imp_RtlGetVersion (fffff800`64522000)]&lt;/span&gt;
   21 fffff800`64521071 89442420        mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+20h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;eax
   23 fffff800`64521075 488d0d74010000  lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;FirstDriverSample! ?? ::FNODOBFM::`string&lt;span class=&quot;token string&quot;&gt;&apos; (fffff800`645211f0)]
   23 fffff800`6452107c e876000000      call    FirstDriverSample!DbgPrint (fffff800`645210f7)
   24 fffff800`64521081 448b4c243c      mov     r9d,dword ptr [rsp+3Ch]
   24 fffff800`64521086 448b442438      mov     r8d,dword ptr [rsp+38h]
   24 fffff800`6452108b 8b542434        mov     edx,dword ptr [rsp+34h]
   24 fffff800`6452108f 488d0d7a010000  lea     rcx,[FirstDriverSample! ?? ::FNODOBFM::`string&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`64521210&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   24 fffff800`64521096 e85c000000      call    FirstDriverSample!DbgPrint &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`645210f7&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   26 fffff800`6452109b 33c0            xor     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;eax
   27 fffff800`6452109d 488b8c2450010000 mov     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+150h]&lt;/span&gt;
   27 fffff800`645210a5 4833cc          xor     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp
   27 fffff800`645210a8 e823000000      call    FirstDriverSample!__security_check_cookie &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`645210d0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   27 fffff800`645210ad 4881c468010000  add     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;168h
   27 fffff800`645210b4 c3              ret&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は特に動きのあるカーネルドライバではないのでいったんここで終了します。&lt;/p&gt;
&lt;p&gt;次回以降では、実際に自作のドライバに対してライブデバッグを仕掛けていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;カーネルモードデバッグの検証のために、カーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;WinDbg関連記事はこちらにまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Active Directoryラボ環境を構築する手順とトラブルシューティングの備忘録]]></title><link>https://kashiwaba-yuki.com/windows-activedirectory-lab</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-activedirectory-lab</guid><pubDate>Sun, 05 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;ラボ環境にAD環境を構築した際の備忘録です。&lt;/p&gt;
&lt;p&gt;とりあえずドメインコントローラの設定とクライアントをADに参加させるところまでの手順とトラブルシューティングについてまとめました。&lt;/p&gt;
&lt;p&gt;また他の構成を試す場合は追記していこうと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ad%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%A7%8B%E7%AF%89&quot;&gt;ADサーバの構築&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%81%AE%E5%9F%BA%E6%9C%AC&quot;&gt;ADの基本&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E6%83%85%E5%A0%B1&quot;&gt;環境情報&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;ADを有効化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AB%E6%98%87%E6%A0%BC%E3%81%99%E3%82%8B&quot;&gt;ドメインコントローラに昇格する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip%E5%9B%BA%E5%AE%9A&quot;&gt;IP固定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%81%A8dns%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;ADとDNSの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot;&gt;ADユーザの追加&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92ad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot;&gt;サーバをADに参加させる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%84%AA%E5%85%88dns%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%AE%9B%E5%85%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot;&gt;クライアントをドメインに参加させる&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ad%E3%81%B8%E3%81%AE%E5%8F%82%E5%8A%A0%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0&quot;&gt;ADへの参加に失敗した場合のトラブルシューティング&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%8C%87%E5%AE%9A%E3%81%95%E3%82%8C%E3%81%9F%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%8C%E3%81%AA%E3%81%84%E3%81%8B%E3%81%BE%E3%81%9F%E3%81%AF%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E5%87%BA%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;「指定されたドメインがないか、またはアクセスできません」のエラーが出る場合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dns%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;DNSのイベントを確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%90%8D%E3%81%ABlocal%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B&quot;&gt;ADドメイン名に.localを使っている&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ipv6%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;IPv6を無効化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dns%E3%81%AB%E3%82%88%E3%82%8A%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%8F%82%E7%85%A7%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%ABad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84&quot;&gt;DNSによりドメインコントローラの参照ができているのにADに参加できない&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%A3%E6%90%BA%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8B%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF&quot;&gt;連携がうまくいかないときは&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ldaps%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%97%E3%81%A6%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8ad%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B&quot;&gt;LDAPSを有効にしてアプリケーションとAD連携する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;adサーバの構築&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%A7%8B%E7%AF%89&quot; aria-label=&quot;adサーバの構築 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADサーバの構築&lt;/h2&gt;
&lt;h3 id=&quot;adの基本&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%AE%E5%9F%BA%E6%9C%AC&quot; aria-label=&quot;adの基本 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADの基本&lt;/h3&gt;
&lt;p&gt;AD環境において、リソースはドメインコントローラ（DC）によって管理されます。&lt;/p&gt;
&lt;p&gt;このドメインコントローラの機能を提供しているのは、AD DSです。&lt;/p&gt;
&lt;p&gt;今回構築するAD DSでは、組織単位のリソースグループ（OU）を作成して、ユーザやサーバなどのオブジェクトを管理します。&lt;/p&gt;
&lt;p&gt;また、権限や設定は、グループポリシーによって定義することができます。&lt;/p&gt;
&lt;p&gt;AD環境において、ドメインの集まりはフォレストと呼ばれます。ADを作成するときは、必ず一つのフォレストと一つのドメインが必要となります。&lt;/p&gt;
&lt;h3 id=&quot;環境情報&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E6%83%85%E5%A0%B1&quot; aria-label=&quot;環境情報 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境情報&lt;/h3&gt;
&lt;p&gt;ADサーバ用のWindowsServerの構成情報です。&lt;/p&gt;
&lt;p&gt;※コンピュータ名を15バイト以上にしてしまっていると、NetBIOS名に変換する際に短縮されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 532px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.91666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB6UlEQVQ4y5VT25aiMBD0/z/Pl52XXUXukACCkCBIbVcrDs7MzpxtT0gg6UpVV7tblgVdf8XgJxkzisqhbj1M45DbHqZ26N0Ehhz9MXbzPCMrW0mU5KrD77BGYQckZY8gaRHlHaqzIxxutxtI4Luxm6YryiJHwZHnqGsD7wfcZmG1zC+3M4Gg340dD14uFxz+HBDFMeI4QRSFCI4BEln3lx7DMKCX4cfxZ8l8UHZVWWFX43w+o2ka1NV9zdkaC2srtG37T6lPQNIkAGfGOv9vrOVQhgTMsgzOuycoD1y6DsYYHVleoKkrJEmKsiy13qw7c/MsxXidtA0UkFLe3n4hlQ0CT9PdDCOJQRCg73u5zGMcvawHmUcxzmltp2nS9apMAQdJCIIj9vu9GrMGmYRhKHMhNa6kjlbYCruigJV37p9OJzV1la2AbB3KIv1tdCI5F2lGgYyaZq1BIRfwPU4TBKdALx0fHbAjZd58d7fWdZKmyoRApSSG0kZfNvVDJtfslE0fkkmmAG3b6SYP3Wt4xOFw0L3l0WJfgb9Ids4JqwS5uJYKu2G4u12Lq3EcqVFkXRZG3d3W7FMf8kEXoyhSyUdh1D0SWI7Rj1qf20ae/jasXv7L/EjbWfCPQVPoJA3wzj8BsLw388f4CxXZi9/5rj6cAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bc726a41d571759699cef3768eae7d64/8ac56/image-28.webp 240w,
/static/bc726a41d571759699cef3768eae7d64/d3be9/image-28.webp 480w,
/static/bc726a41d571759699cef3768eae7d64/b5f85/image-28.webp 532w&quot;
              sizes=&quot;(max-width: 532px) 100vw, 532px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bc726a41d571759699cef3768eae7d64/8ff5a/image-28.png 240w,
/static/bc726a41d571759699cef3768eae7d64/e85cb/image-28.png 480w,
/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png 532w&quot;
            sizes=&quot;(max-width: 532px) 100vw, 532px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;adを有効化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;adを有効化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADを有効化する&lt;/h3&gt;
&lt;p&gt;まずはサーバの役割の追加から、Active Directory ドメインサービスを有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACNklEQVQ4y3VTy5LTMBD0x3PhzkfshTtUURwo4MJpDyke2U3ixE4kW5b8kmXJj2ZG2V2WLVDV1IylcaunZ5RYo9B/e4dw+xGYPOZlwTzP/7VlYVui8TfWFY9rpTjphhHKzRA2QHfDPwAeLpimGHsf0LQtlKowDA4LgSzLGj2vxA0WumkgTA1BSVWl6YcOWhtUZFpr1MagsQ5SGZwvArKs0DQdvPMEhGhhXuDCjETWFtJ0MMTQNC36tgFmjzXQ7X6AtRajc7AjV2BREVBL4H6aYf21Kt0PGCgew4Lk9Yd7vPmU4tX7HfZlj+1J4ObLL9x8/o63X39AEeNxdCjJF7pGRZVwyVyBpliRl1QZ7/mJNOTkq15T1CnNL7jdpvh5lNhmBYH5CChLRbop5HmG8zlHmqaRfQiBdPXkPbGckEwEwmDs+bCQAqoQWKfw1L2FLhSFghtHnE4n7HY7tMQodpnPqVnc7Z40TXiTwa6AE4QQJPyFfuho79ppPrvIMnYzEJvsxCzPkEJCPOVOsC68BAyQUuL+7g77/YE6zqMxRClEcQXkxSU6Ghk+Y6YjMeecvxiy50QGTA8HbDYbiouok6Mu67qJc8cx5zFILPXZsi8BOSnPc2RZRgz3OB6PUYK6NugJjME7YhSt62gWm6gn/3Mm43FKmPJz46S6rqNnK8sSZVHEYe7pVbG1NHc8Psy6rEyMK9P8Aez7Pt7OxrrwNzN4jI15eDF0Qdf10fhFadofSIKRJWBdqcLfDN7lCNqUKGgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/8ac56/image-13.webp 240w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/d3be9/image-13.webp 480w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/b0a15/image-13.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/8ff5a/image-13.png 240w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/e85cb/image-13.png 480w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png&quot;
            alt=&quot;image-13.png&quot;
            title=&quot;image-13.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このまま次に進んでいき、[必要に応じて対象サーバーを自動的に再起動する]の設定を有効化した状態でインストールを開始し、しばらく待ちます。&lt;/p&gt;
&lt;p&gt;より詳しい手順は以下のサイトなどが参考になると思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ittrip.xyz/soft/windows/ad-setup-ad-easy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active Directory サーバー（ADサーバー）の構築手順を初心者にも分かり易く徹底解説 | IT trip&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、ドメインコントローラはデフォルトではLDAPSが利用できません。&lt;/p&gt;
&lt;p&gt;Active DirectoryとLDAPSで連携する他のアプリケーションを利用したい場合は、LDAPSを利用するための証明書が必要となります。&lt;/p&gt;
&lt;p&gt;ドメインコントローラに認証サーバを導入して自己証明書でLDAPSを利用できるようにするためには、ここでAcrtive Directory 証明書サービスも一緒に追加しておきましょう。&lt;/p&gt;
&lt;h3 id=&quot;ドメインコントローラに昇格する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AB%E6%98%87%E6%A0%BC%E3%81%99%E3%82%8B&quot; aria-label=&quot;ドメインコントローラに昇格する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドメインコントローラに昇格する&lt;/h3&gt;
&lt;p&gt;有効化が完了すると、以下の画像のような表示になります。&lt;/p&gt;
&lt;p&gt;続いて、[このサーバーをドメインコントローラーに昇格する]をクリックしてドメインコントローラを作成していきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 625px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVQ4y51T22oTURSdj0qEYB/qQ3wS+xeNBaU/4CVINFTQPvvmj/gkiPhSCcZqTJu0ucxk7pOZc+aWmeXeJxeSUkHcsNjnklln77VXtFqthttQrd5BpVKlXKVc2QGf1et17O/fw8MHddyvUz44wN7eXWiNRgM3cXjYwIvnT/H6VQvNZhOtVgvtdnsHp6fvcPLmLT68b+Hls2M8fnKMo6NH0CIhEEURQUAIBq1FgiwcQAZXGE8MSClxM/LFAmVZIk5y6PoMYThXHFqWpVjkGfIsQ5qmCkkcYz6fw3FsTMdjTAiWacKxbZU914FLcFxX7Q1DR0bfJ0kCbS5TGK6AGyYoikK9yq9nsYBJBJ3eBc4vh7g2TIxMBxPLRm9swHQ8SOrIJVKTSDn4ey3NCwQiRRTnRAYFjr7uo3MxhUmv20Qc+L6SJgxDzIjM8wNEtHYcR91zcDEayi1h6KBUjCWmfowvv0b4+K2LTz/6+NwbEIY4G4xUZUzOmrM0XOWGkCsriiVRuSpP7UlX0zLxtfMdZ91zdPuX6PzsYThZVmxZFjzP22BDOHEEuO31wRpcheUF1LqF31MS3naRSIGYJr50g1DT90kKbntDGIgMRVnuWIIveGJ+EGB4dQ1jNiN7JIhp+lLGKjP4N+FKxy3CFIK8FMYZpq6Ew9Omi4DIeHq6rmNGhNzmbeA7rnJDmC/IJqRZkhVq0jJdrKZdYLEyL9uB13/DdihjL0Hm3jI47/8V6z8EQ1vrIVf6bGv0P/gDsPfvf4wE8WEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/11ca18025b88eb65cab87bde36999afd/8ac56/image-15.webp 240w,
/static/11ca18025b88eb65cab87bde36999afd/d3be9/image-15.webp 480w,
/static/11ca18025b88eb65cab87bde36999afd/487e2/image-15.webp 625w&quot;
              sizes=&quot;(max-width: 625px) 100vw, 625px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/11ca18025b88eb65cab87bde36999afd/8ff5a/image-15.png 240w,
/static/11ca18025b88eb65cab87bde36999afd/e85cb/image-15.png 480w,
/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png 625w&quot;
            sizes=&quot;(max-width: 625px) 100vw, 625px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png&quot;
            alt=&quot;image-15.png&quot;
            title=&quot;image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;構成ウィザードが開いたら、[新しいフォレストを追加する]から任意のドメイン名を設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACUElEQVQ4y41UXW/TMBTNL+aN38A7vwAJiSceeEQboA4QGwPG2OjWscLSNmVJm2RO4thxbOdw7a5dmDaEpaPr+OP4nuPrBKPxBMOznxj+uMDJ+QQHxyOcnoeYXqaYxekqXt7ETZ/moiQnZAjnCx93D0cItG7Baw6gw03rerivdVCNRFUWSJIYSgo8efoMwcE0x8dfS+yHOT5PGC6ZoLUdjLUwxkDrFVzfoW01fWsopZClGZbLJRaLBcqyxPbgPYLHOxM82hrj4YtTPHg+xOAsQRr/xmQ69Ys5535zXdcQQlwfon3sum6jxyVRK4PAKlpYFYBtaVDDkgWz2QxTIgwvQkRRhDiOEYYhGGMbwtswRiPnDQLVNCgo3aKsoI312SySBFmWYz6fIyIURUlSW5+L9VboHlYHWIoZVwgEXYiT5k5fe5PnOVLyx5FWVUVyOWpJ4wVHwSUESVujvZbvyL1kc02yPsll4r5FLXzf+dRRVo1qSQUHF5JIjIfSpifZgNWUoTOz74UjcZN2c8s3GxzxvySnJXnofFlvWBP+bba54yJMD3pDeMX/k7BPfBfW85VsV4TtLcnojMdd5XEfnHxWU4bOdEUk7gW4UxTFtJRImKQy6mViV7Cd85cOc/75MfK1s3QVFsUqQ9esrzHdKv8aXHmkrIKUEg3BxVYoKNGiLNz7bWAaqg7RQFI1cMYhK4El/TSC1+/2sbWzh5eDPYzDCDkrkV0x5IRlzpASYqrJr7Nj7E+PsP19F29Gn/AtPsEwOsN4PsGrowHenn7Al9kh/gAEHoFhtySIewAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/749bc15be35b1458ec6de23edb25c317/8ac56/image-26.webp 240w,
/static/749bc15be35b1458ec6de23edb25c317/d3be9/image-26.webp 480w,
/static/749bc15be35b1458ec6de23edb25c317/b0a15/image-26.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/749bc15be35b1458ec6de23edb25c317/8ff5a/image-26.png 240w,
/static/749bc15be35b1458ec6de23edb25c317/e85cb/image-26.png 480w,
/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png&quot;
            alt=&quot;image-26.png&quot;
            title=&quot;image-26.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;設定はデフォルトで問題ないので、ドメインコントローラオプションからパスワードを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACe0lEQVQ4y2VU227UMBDNp8MTb/wH4gVRipBKq74hEKAWdVG6hVV3u5vLxrk6Tpw4zmHG2fRGpCN7bc+ZmTMz6yUiQxQL7GkVaY7NNkBCa6M7Qg9FqNvuPyhC0xl3X9YN+mHEx8/n8GSr6YIOmxaFat2+oj2j63tYO8AOz0BnA62NUqjKAmEQQIiEbDp4Y6dgCYAlDBitQUukujcwZjJ0sBZ2HInMOhhjkGWUlRBICKlIUSoifHl0hRdHC7w+X+PVyQpfVwKqKpAkiXssK0l7kmSfYLfbuXNFkfUUPTsaycn0jai1gXfqxzi+2OBkEeJsKbBOJIosxWZzh6IoXTRsVJYlFlcL+L6P5XKJIAwRErTWLlqGZEKYFjDaeXB+ht4Zp2lK+pSopERd1w5ZliPPCUXhomQw0STLgbAgoyiOsae0zGDRNA122y2iKMJ6vcbN8oZED50T55CiHR9pyWQzqSNU5LmqKrRt6y66rrsn45RYeElRZmnmnM0E93hOOIs7e2NCjoZJCkqtJB0zSp+J+TdLwekzCdtOxFMnuKI89sh7FpkryVEyaUctxF9MVT46/oR37z/gy7cf1FYDNXfvenVurVLpB8J55QecPsvAkXAU3MyKGn0bRLjbhYiT1BEy+kdFqXrLhOapJoYiGi2r79ZpKiajh298akNDMNBbsVrDm7UbDiOlKcVcajev8gCemofKznrb+0rbg7PbN2/had26FPUBXMlSKtSqoR5UkDVB1iio/7jF8rJ2aOkdzzJ3CZ9LshVRAk9kNGYz6F9G5AX1ZOp0yrjCRYVoL3D128f131t8/+Xj0l8hFjmCaI+A735e4PL0DH92Mf4BVDN+QZmP+qcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3ff8d86206a1469719ab33792915db67/8ac56/image-17.webp 240w,
/static/3ff8d86206a1469719ab33792915db67/d3be9/image-17.webp 480w,
/static/3ff8d86206a1469719ab33792915db67/b0a15/image-17.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3ff8d86206a1469719ab33792915db67/8ff5a/image-17.png 240w,
/static/3ff8d86206a1469719ab33792915db67/e85cb/image-17.png 480w,
/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png&quot;
            alt=&quot;image-17.png&quot;
            title=&quot;image-17.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続くDNSオプション、追加オプションもデフォルトのまま進みます。&lt;/p&gt;
&lt;p&gt;追加オプションのNetBIOSドメイン名には先ほど設定したルートドメイン名が入ります。&lt;/p&gt;
&lt;p&gt;パス、オプションの確認もデフォルトのまま進め、最後にインストールを実行します。&lt;/p&gt;
&lt;p&gt;インストールにはしばらくかかるので、完了するまでコーヒーブレイクを楽しみましょう。&lt;/p&gt;
&lt;p&gt;インストールが完了すると再起動が実行され、ログイン画面にワークグループではなくドメイン名が表示されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAEIElEQVQ4yzWS/U+TVxSA34oIKCozU4NGPoTWFqGllJbW8tEP2r5AkYrQL8pboJQKrAWL0FIQiOC3Wcw23dymS4xsRkUxccuWxe1Pe3Zx2w9Pzs3JyXPPOfdKkiTxP0X7VJTsV1EqKCkuoljkjlRU0OpXCKdXiF9dYSC1RJldQWqJoDJHkVojgjCSaY8Qkkql+iQ6sH8fpUJSXrqfgyXFHFBJHDp2AmMgRXdyHf9UnsCVPLFMAd/4VSqcE0I0gmQR7InNkX/lZUKy11FZsZAWSRQLUZHo7NCJM1gnrjO68YT07e9J3XiEOZbHODyHL7FES3COzz2TFNnjSLZRJKugLYZUKiRlpaWUHSqnpPwIRyurqNTbsYwukrr7jOVHP7P541sWHm4TX/uGpuEsVf402ksZDENpKntTSF3jSJ2C9jGkph6FluEMzeJmvYgmJYdBydOfvUP6/lO2nr3l4S+/UXj8krm7P+BIrnLaP8u5wQzH+2Ypl69Q7E2h8kwhuSeRvF/coHt6HcfUGvbECtbxJUyxLL1zm+S+fs6DF7tC+pqbP+2QFKPrRxbRhBaoDl6jSkhPBdKcvDjLZ/0zHO6bRuqdXaFH4JlexZG6TmdyWZCnQzB95zFrT7bFuM8ofPuCwfw9DGMFGgLjNMoBNJEs6vA8dWKftcEMNcNppIH5Vfoyq7hTy3Qoc7inV0THOVzTS7hnlggWNkncuEckt4ErtYhR9tBQf5DWc6WoA5M0iF3rR+fRx+dpVDJIl7IFlPX7JBYW8TrbUPJbzD74juTWA6Zu3Wdi6y5jm3dI3vwSZTGH7FDjtJ3HadYghxS6F77CKr6TOTmPJTWHFFoqEFm9RTY3Q7zPhM1ipMvnYSibI5QvCJaJLK+Impv0X3ZjrDuGrVmHy6wj6jMQH/Hjm8niy1wTzCNNXN8gurJJMtaFXXOQxpqTrC+m2d7dZefjX+z8+ZE3gld//M3bl4/ZWEjga62ht/koXkMFV+UKBmQTsfwa4VweyT8WpycYoMepwdRSj63dytPtF+x8+MDr9+959e4db97v8npXxF9/59HT53hkGWtbC8ZWI3a7mfPNzZi8PVj8F5F8wcs4A4PorHaqmy2cNV3guKaJemsnjS4fWoeLBqeH1m4PFy40UaeuQ6PVoW88j7FJR0+7kQ5bGw5PH17ZhxSdmmJwRMFtM6Cvr0JbW4225jT+PplwNEgwMshQeIhIaJC4bKC94RRmdSUdInYbzhBqV9Nv1TDYpSfq1olH6TaRumhmXBQnxJITchOTciMTHg3j7rOCWsZctSjOs0QdGkZdOmKCsENLsFPLJbuGgK2OQFsVA5YzSCcPH2C4vZ4ZfyOTPi2TXg0JIZv0nvvvrP7ExB7d9UJeR1zIFUctsa4aoh3VRNqrCAuC9ir+AfmVYeWhb82fAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/8ac56/image-27.webp 240w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/d3be9/image-27.webp 480w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/b0a15/image-27.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/8ff5a/image-27.png 240w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/e85cb/image-27.png 480w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png&quot;
            alt=&quot;image-27.png&quot;
            title=&quot;image-27.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでAD環境の構築は完了です。&lt;/p&gt;
&lt;p&gt;この後は、ラボ環境に構築した他のマシンをADに追加し、グループポリシーで管理を行っていきます。&lt;/p&gt;
&lt;h3 id=&quot;ip固定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ip%E5%9B%BA%E5%AE%9A&quot; aria-label=&quot;ip固定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IP固定&lt;/h3&gt;
&lt;p&gt;作成したADにサーバを参加させる場合、ドメインに参加するサーバ側で優先DNSサーバの設定をドメインコントローラのIPアドレスに指定する必要があります。&lt;/p&gt;
&lt;p&gt;この作業を簡単にするため、ドメインコントローラ側のIPアドレスを固定します。&lt;/p&gt;
&lt;p&gt;ネットワークプロパティを開くと、デフォルトで優先DNSサーバがローカルホストに設定されていました。&lt;/p&gt;
&lt;p&gt;この設定のまま、IPアドレスを固定すれば完了です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 473px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 111.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADK0lEQVQ4y5VUiW7iMBTk/39sj6pSu0C7XIGQEnI6NzlImH3jkBSWaqWN9LBD7PGbeeM3+fBjuH4IR+JwdLG3HbiBwtELcHA8WPK+2VnYfdgwJYr6jKYD6vaiozp3+r2oarhxgYkTRnCOsrAokMQR4ihCmiYyj5EmjESP/J/f8yz7jPxzXmQpgiTHxI9ShGGAum5kQaGB8zwf54xMNpxOJx3Dt36U4Hquk7knWJMgzuF7LmzJ0rIszOczTGczrFdLbLdb7HY7rJYLLNdrzN/mmE2neHl5xfv7G15fOS6w3W2hwhBJUWPiqQTLxTvMvalp+b6HIAhwlANc10WkqYrOnofNZoPD4YAPCSbB+cG2YUsw2ygvMXEFsGvPKKsKfz+XywX/86j0xAxTnJsanmTgOo6muVqtYJp7GIYhmR5F33o84Kvo9MGXHtCPM02Vmx0B9H0fW2ODnWniVFb9hq7D+Sx2aZqHaNtWf79I9BlKZVqhTCDqV1b1Hd1hpJWoab/OH+dpml7XdQhT8aEbJoLearBQKV0QCnxLkU8ifjyK+J4AaXlkDKWytFW/+AHQRyyblAoFOEQtdIg1AEaR0noGga8PJSgPeQD0xYesskdAsQddzw1KAG4fUiYI/RaEPSDByrLsmXQjYKY3sJJN0wtfiYUaeac+pJ9luXgxGa01ZM1i9KGp9EWJMjlFrhTNyVOpC4MV580xpdrUi9eOMnzlzzvbxEWl6VjWXkBEIwEjdVLOrvQ5dqIz6ZHJEIN1ulvKcU56lQZkQQjGag9mHp5YOg2LouTbwEJrfnXEWJQoK8W0jW4CpKaU3GfJqjgVo07aNrKZspAF5TgcPnSVCXhXFP4QfaBA5/NWMD5F78b/ObbX8f7iX28Kf5ghT2b32EsReJ+NjaEzamTzVw/9+P37N/x8esJMWh57qgZkhrw2zTUrZslmy7i9q23b39ehwifxoCtJ9DIpVOWpp+wEETJp8Ylu9Y+RsP1TfHHC3gnxsrbxNFthatjYHBVs0XIpDdgw1rCOHiZ2ECNQMfx/hCcRRgkMAXheO/gx3+F5ZWNuStPdmvj19huLtaEP/ANQCJMLbUYznQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/8ac56/image-20.webp 240w,
/static/294c5eb1b8546188cedf978fd7ae6b39/7124e/image-20.webp 473w&quot;
              sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/8ff5a/image-20.png 240w,
/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png 473w&quot;
            sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png&quot;
            alt=&quot;image-20.png&quot;
            title=&quot;image-20.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;adとdnsの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%A8dns%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;adとdnsの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADとDNSの確認&lt;/h3&gt;
&lt;p&gt;サーバマネージャの [ツール]から[Active Directory ユーザとコンピュータ]を開き、[Domain Controllers]の欄に設定したコンピュータ名とルートドメイン名の組み合わせがDNS名に適切に設定されていることを確認します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 774px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+0lEQVQ4y31UCW7bMBDU/99R9DUJiqSIcyq2bMmURN0HRV2ezlJIC6dBCCxoW/Ls7MyQ3ilOEadnhHGMROcozhGKPEdrejTdiMF0WOcBxjSwo8F3y9oRXhgdcDrt8XoIEKoEar9HEJygEoVznKEocpwCH2lyQp6niMIIVVWhris0TYO+65BlGYbBouN3b3c44Og/4P39gHG0uLDTyzGFH4SIzgpl3eJ0jpGVNbrechpN5gapzhCRQFZUyKuGU0x4OGp4qmhQqEc87nZkUGC0FgOpR7Em88iBZkXJcScCGrdP8+KqN4MraXAhk7eUDAVZh3e4vb3B/d09/DcfJTs2XQudxm68JEkQU2Npqs5nShKw2QnH4xEHTphTczPOwLrAs2RkGkWtCkzTBNP37GrwHmgCW9ihd2ACvK4rhMpkBzeirHmeKdUEO5H1NAvg+MmrC3oKrIsWXcdmdLuj8IZNlmXGvKxo7IpqWDCQ1UUaEGgDnAg4boDyQHQQFh11qehY2zZ0s3bsHcsyR1Qa/LzJ8OMmx071MNOK2owY5xUy7RWgLAHsjXVGSGRkpWnqNIuVcsCpgPPZMNAUGiUlgAOncBp+BhSGRVUTKHEaiehKbToLARlt5C7/lVQYvj8uFyeNJw+vFLyIhiM0IzRQfFmZ1tAscTsnqOjZ0zzZt8/GAUqOPUEV6tJxITtpULcdCgZZfhfey7JclbzzUTKBGNvbjbUnmkiuZJeR5Bid44TBXa+k+G7NbBKnuYuWJyxcFkldzqYIr5LUxeCzFF/VB6BKM3Rtu5nyAdryhyPZBjxyhjr2feeayGjfAS7MplwsTVP/Y7hFYBNaXJZLIQpDJ4fcLF+tDzFmnuuy2cJ/BSgGaWZODLFM/1+NKKcYdsXM7auDFWPqtucxHf4HTCS4vGh1UZNZg9dQ49dzgKcgxpvv49Xfw3/f4/fDDv7+gKfnFzy/vCHNS7RyH34GFKcFSO6/vKygshLHOEeYZO4uVKyYBqhk22P3XTOfJcqyxB+OeLO9nuPK1QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cb0974d2618b05ae87e6354b11811391/8ac56/image-21.webp 240w,
/static/cb0974d2618b05ae87e6354b11811391/d3be9/image-21.webp 480w,
/static/cb0974d2618b05ae87e6354b11811391/9b58d/image-21.webp 774w&quot;
              sizes=&quot;(max-width: 774px) 100vw, 774px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cb0974d2618b05ae87e6354b11811391/8ff5a/image-21.png 240w,
/static/cb0974d2618b05ae87e6354b11811391/e85cb/image-21.png 480w,
/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png 774w&quot;
            sizes=&quot;(max-width: 774px) 100vw, 774px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、サーバマネージャの [ツール]から[DNS]を開き、前方参照ゾーンに作成したADに関連するゾーンが設定されていることを確認します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 859px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1ElEQVQ4y51S2W7cMAz0/39XX7pBgjRAgKZNduNTPtaHbEm2ZFtTUtuiCdAg2BIgSOoYajiKulGh7UcoM8OuHm7bYckppdxT/rnPboNZHPSyIopFgyR9QZyXEHWO10ygbjrIcYJzDvu+Y982itv7+CbftpXiCusYsCgRJyekFJVROLc9NcgwSAmlFLTWECXtKQ1jDEZqxHtaG2iq+2FAXTfh3KgMIjMbnOsEz88/0HUDyvyEx4cbbLuH90R9pc7WhvgvZxYXJkzbIlrsgqb4icPhK/KiQiNe8Hj/BVJqLMuCa2yxRFkpCdkmgdbuPc5NibvbA+I4Rtf34aCaJvT9QE0k5nkm2iMGojpSLSlfaY5sMwkTWbe961KRIDe335BnKc5dF9aKooAQAobAGPB4PCJLU2rS0/xqVHVFeUf7RFmbCy1Wk60+d7i7f0D8ekKe5zRHHwDLqoSjmbEwT0/fA4O2bVGWAhXtMeDMM9SEysYX2TT9x47oTUSTKTEdBuGaRdio5hFwzcqy/3mMW3dW+S8gu7UO/oOhX858tE53141Ups/41hzV3nv8j4UXDvRRp1EGeqxeiCG/wuk8Y8hJIUrp78VZQS5CzESNJBe/167zrGzwC+Ck6PlVm3NNAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/8ac56/image-22.webp 240w,
/static/3f5feec02117af80f2fe0a7abb61b426/d3be9/image-22.webp 480w,
/static/3f5feec02117af80f2fe0a7abb61b426/4e068/image-22.webp 859w&quot;
              sizes=&quot;(max-width: 859px) 100vw, 859px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/8ff5a/image-22.png 240w,
/static/3f5feec02117af80f2fe0a7abb61b426/e85cb/image-22.png 480w,
/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png 859w&quot;
            sizes=&quot;(max-width: 859px) 100vw, 859px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後に、PowerShellを起動して、作成したドメインで適切にドメインコントローラのアドレスが参照できることを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ nslookup hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
サーバー:  localhost
Address:  ::1
名前:    hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
Addresses:  2001:f71:81a0:3a00:3086:3ad5:664d:d4e0
          192&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;168&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;100&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;50&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ADサーバの優先DNSサーバは、ドメインコントローラ昇格の後にデフォルトでローカルホストが定義されています。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;hacklab.local&lt;/code&gt;という名前で自分のアドレスを参照できていることが確認できました。&lt;/p&gt;
&lt;h3 id=&quot;adユーザの追加&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot; aria-label=&quot;adユーザの追加 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADユーザの追加&lt;/h3&gt;
&lt;p&gt;ADの設定直後はデフォルトのユーザしか登録されていないので、ユーザを追加していきます。&lt;/p&gt;
&lt;p&gt;サーバマネージャの [ツール]から[Active Directory 管理センター]を開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAACoUlEQVQ4y31T21LTUBTNr+kLyEVahw9w9Av8AwUffGF8cEZ/gicckZsoWguITBGndQBLbBoa0uba3Jom7XLvQ1PunJk1O+ec7HXWvkmL6wUsr6zh/YePWFlbR6G4ha+ForDFrR/Cfvu+KVAoboo92+zsKqTHT55ibOwBRkdGkM/lMDU1RXiIfD6P6enpwd0oHuXyyNHd5OQEJsbHcf/+vRshLRRK2N4sokiv/trfx97eHnZ2drC7u4tSqYRKpYJyuTy0Ahe/r0ByXBf9NEG2Op0OwjBCt5sgSc7g+T5ctw3HceF5HqIouhXS8/ltvFj8g2fz+5hbPQQ/YLd9xAPCth/Ccj349EgUd5GmqTiP45ge7V6DdCQr0E0bqm7AJEdFqREUBEEgFIdhCF3Xxd4yTViWJRTftiRN02DTj924g6Qbo9FoQCPoepPCdOGTM5MwoWG0YBqmCJtXv9+/BimgUDoUe0jgMJrNJjkalMtYOPEZ548t55fBoZEvUwqSSwoFIf0UDQhZoaqqsG1b7FmZaVpUEIeUnxA0cXe7wogJoyEhk8myLJQKwkHILhGqal08aFKKztdVhdFlhWq9DqVWEyngxeeWZSOg4likzLad4d0dhGc5TKkoCz+rmKE24laaXTrE3GcZr5YO8PpTFW+/VPFuQ8abjRpmlo8JVbxclTGbYeX4BoWnLfxVmziqayhXFVRVHWrLwT+1gd+VA9RONJxQi+lOgFPHh9xoQWnaAqrhQvIvFIWtZRqwqD1sy4R+qtG3gTDwxZ6Lwrn02jRdvURMWBh4iKNQIKHWk/wgHBIyuCV6VK1YdD5NC01GNgVxfD4RSZIK9Ho9mp4MKaQw6ohQM3Az83TweJ07J9dw09iJ0bOoahwGtwJXMWveu5zuwn/CG9iu3nJD2AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/8ac56/image-23.webp 240w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/d3be9/image-23.webp 480w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/b0a15/image-23.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/8ff5a/image-23.png 240w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/e85cb/image-23.png 480w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png&quot;
            alt=&quot;image-23.png&quot;
            title=&quot;image-23.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、上記のように登録したドメインのUsersを右クリックして、ユーザの新規登録を行います。&lt;/p&gt;
&lt;p&gt;ここでは、TESTUSERというユーザを作成しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB00lEQVQoz41SSW7cQAzU/59iGMg3cgiCADkYSBwHGEUzrV29b9JUSGrsa3Igml3gUiyyUUqh73us64plWTAMA6ZxFP9fNk+T5HofkGPAn8mgsfSp+45SKzbjoF2A9REu/IdRrg8JZT8Qc0UpFU3btrDOIecsLLWxMBToKJDfzXmElHEchzTeH3b6h+RZayl3w7IRw67rsG0bYorycvGBRmbfGCN/H4L4tTKLgpwS3IME44wlwtQworkQQ01gJpC7zMuKkbRRNyWMAxUL3kNrTQXORE//kZpyMW7s6M8TjNOM5ta18EYDR0UKDkZT0XmRRGYxU9BKC+CxHMVdr1cpeLlc8Pr6C0r1sqAYT02b588/8fRN4dP3AU9fWjx/vWE0EcBdWI209ffxIzXh8Zg1X4MlvbkQa8q4p0U1L787vLQjflxnvPUb3gYDnwruNAIzvPWjSLCQHCzLh46k38eCCKuECcMUPArd0J4jjpKw1yInxIGikT6ZcfDOiWRcLAnbs/g765ViG96g3GE57yjmIi/ud9HOkXYh8FI2wrMY68lHXSszTcLu2CusMHzowp2ZQam73JPlAydzdOSJGiQ63EhScEPWSlsnfiBMzRodSaOGCX8BMGdNJAG5sGQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/8ac56/image-24.webp 240w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/d3be9/image-24.webp 480w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/b0a15/image-24.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/8ff5a/image-24.png 240w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/e85cb/image-24.png 480w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png&quot;
            alt=&quot;image-24.png&quot;
            title=&quot;image-24.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後に、他のサーバをこのTESTUSERを使ってADに参加させます。&lt;/p&gt;
&lt;h2 id=&quot;サーバをadに参加させる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92ad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot; aria-label=&quot;サーバをadに参加させる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サーバをADに参加させる&lt;/h2&gt;
&lt;h3 id=&quot;優先dnsサーバの宛先をドメインコントローラのipアドレスに設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%84%AA%E5%85%88dns%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%AE%9B%E5%85%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;優先dnsサーバの宛先をドメインコントローラのipアドレスに設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに設定する&lt;/h3&gt;
&lt;p&gt;まずはネットワーク設定を開き、優先DNSサーバの宛先をドメインコントローラのIPアドレスに変更します。&lt;/p&gt;
&lt;h3 id=&quot;クライアントをドメインに参加させる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot; aria-label=&quot;クライアントをドメインに参加させる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;クライアントをドメインに参加させる&lt;/h3&gt;
&lt;p&gt;コントロールパネルのシステムから、コンピュータ名/ドメインの変更を選択し、&lt;code class=&quot;language-text&quot;&gt;hackroom.lab&lt;/code&gt;ドメインに参加させます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 897px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADVklEQVQ4y0WU22okVRSG+wWUeQPvfBDvvFFEGBCcG70aFG9GEII3vsAoqCC5EcIgKCKSOCbTmZk4OU3SnelOVzp9ru6uqq5zVdexu9M5+LlSXkzBz9qw9/73v9a/VpVK723wxr0tfvpb4XFlwNaJytO6ypOTAeWaxFcDnp6O2FHGPGuM2K6P2JS9zZO+nBFUe6wfNNmutHn42yGl0sc73Plsn3LDQLUCBpZPW3cZuQFhluHFMW6cCjKCLCe/XBDmWYF4LjGN5cyU7GLO77stIbxf4c2VOgddneHEoavZ1AYORpgSxCGW7+FFiVySy0J4cX1RYHmzLOLr74Y/95qU7nyj8Pa3TR7XOpwODBqqQccOGfqiLPQYGRqaqWP7NvNlxmyRCkRdHpMv55TLmzz8YRXN0otylXbPVF40uhyddXjZaHNQa1LrqFSbXY6bKoeyv3faY6/WpqdPGExsycIgnUU8r55z9933+fzLt/h05WvKJxqlkW5juR5Kr8/LepPDmkJFabFXrbPX6HHUHrMvpLd4diIPdiz2jxVRPRFVHh+srPHg+3v8+POvbNWE0HA8qVNARx3R6g6oK+e8apxxcFShNTQ47TlEaUiUTckl3UyULa8XWGIWXKOFITsdneubBRsVSTlMI3Fqimk7OI6N6zqEYYAra1secsNYapb/j4ucaJYTznNU6YIoi1kscy4vcyG/YL0ypGT5LuOJLup69Ad9HM8VFVL0JGZs+/ixODxNcIIIW3CsB+wMfVqmS5pHxLOEaZ4I4ZKN6oiSbpv0xyraxMT3PKbTiCgSSLS9gFZfpX52LulrdEYjVENnoGuMrQlhEhZue5HP1VXGenVMyQ68oj3GhomiKOiGQZKmRKIwSROCwC9KoVk2E9cklMuWZxJnEelcelVITenVSyH8q6ZTShZz5tKgth/SUwe0e12CaEosExAnklJ6a8SMoWljuDYzmZTbaZldLYrmDvMUbZqLPUuenDmUlrOUS2nUSNxKxYxEajqXCXGDQNwPmXo2vqnhCVkYmCznUWEA/y4KZ4t1gSUv2kK4bQTsGj77Y4dDic+1gPIoYK3lsar4PDo1+UN+CKtVi0+2fO5vT3nwT8JXOxFfbE358BePu48cPlqb8M53ff4DMuvmsRgqHe8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d75eba38d172da144032ebb11eb3de41/8ac56/image-29.webp 240w,
/static/d75eba38d172da144032ebb11eb3de41/d3be9/image-29.webp 480w,
/static/d75eba38d172da144032ebb11eb3de41/10735/image-29.webp 897w&quot;
              sizes=&quot;(max-width: 897px) 100vw, 897px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d75eba38d172da144032ebb11eb3de41/8ff5a/image-29.png 240w,
/static/d75eba38d172da144032ebb11eb3de41/e85cb/image-29.png 480w,
/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png 897w&quot;
            sizes=&quot;(max-width: 897px) 100vw, 897px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png&quot;
            alt=&quot;image-29.png&quot;
            title=&quot;image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;認証には、先ほど作成した&lt;code class=&quot;language-text&quot;&gt;TESTUSER&lt;/code&gt;の認証情報を利用しました。&lt;/p&gt;
&lt;h2 id=&quot;adへの参加に失敗した場合のトラブルシューティング&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%B8%E3%81%AE%E5%8F%82%E5%8A%A0%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0&quot; aria-label=&quot;adへの参加に失敗した場合のトラブルシューティング permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADへの参加に失敗した場合のトラブルシューティング&lt;/h2&gt;
&lt;h3 id=&quot;指定されたドメインがないかまたはアクセスできませんのエラーが出る場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%8C%87%E5%AE%9A%E3%81%95%E3%82%8C%E3%81%9F%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%8C%E3%81%AA%E3%81%84%E3%81%8B%E3%81%BE%E3%81%9F%E3%81%AF%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E5%87%BA%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;指定されたドメインがないかまたはアクセスできませんのエラーが出る場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;「指定されたドメインがないか、またはアクセスできません」のエラーが出る場合&lt;/h3&gt;
&lt;p&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに変更しているか、pingコマンドでドメインコントローラのサーバに疎通が可能かをまず確認します。&lt;/p&gt;
&lt;p&gt;次に、ドメインコントローラ側でコマンドプロンプトからDNSサーバの稼働を確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; queryex dns
SERVICE_NAME: dns
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 10  WIN32_OWN_PROCESS
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ACCEPTS_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 2800
        FLAGS&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを確認しても問題が発生する場合は、nslookupで参加するドメインのドメインコントローラが参照できるかを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ nslookup hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
サーバー:  UnKnown
Address:  2404:1a8:7f01:b::3
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; UnKnown が hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab を見つけられません: Non-existent domain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このような出力となった場合、ドメインコントローラのDNSを適切に参照できていないため、AD参加ができません。&lt;/p&gt;
&lt;p&gt;まずはドメインコントローラ側のファイアウォールを無効化してみて、DNS参照ができるかを試します。&lt;/p&gt;
&lt;p&gt;次に、クライアント側（ADに参加したいサーバ）のコマンドプロンプトにて以下のコマンドを入力し、DNSキャッシュをクリアした後にもう一度nslookupを試します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;ipconfig/flushdns&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで失敗した場合、ドメインコントローラ側のDNSのイベントを確認します。&lt;/p&gt;
&lt;h3 id=&quot;dnsのイベントを確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dns%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;dnsのイベントを確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DNSのイベントを確認する&lt;/h3&gt;
&lt;p&gt;サーバマネージャのDNSタブを開くと、以下のようにイベントが確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABxUlEQVQoz6WRaXPSUBSG84MBKYv9P45fndGOpR+1VmynaElbaFlkSQIhK0tCNqB9vIkbWr+ZmWeec96ce+bOXOn54SH5QoGDUolcLs+zYpHiwQG5fD7L/0UuX8jmKtUqlUqVUrlMqVSmKDJpbpvs4hB4xDENQm/JQxIJQpLAZxP6WZ3OpN5nFwdsouC7Aw/XtpBenrZ48WnAkaxxrbqcD13qX20uBjYfugbvOwaXQ4fGyOFj3+JU9HXhd/czznomn0Ve79uc9V3uxzrSnWbTHJm0FIu+seJq4tEUyFOfpiDtr4VvZ+tfmbxHmjdUj3PFZ6A7SOw28LDlcZtk/p9vt4mRwigiI4xYeT6evyYQdRDt8XcfxU/w1wG+OCtFYiCOI6I4ZrmYE4hHScKAaO3hL+esV4usDv3VHssntbdwWYjz2cKURCwc6C4tbc6NQFYc2hOXtpZmLjeqQ3Ns05mt6Jr+H/RSGz7OfPl74XaT0OhqvLroc/RlzJvGkNeXfd5ejThuKhzLKjVZoXarc3JncdI2qQl+utYymVrO3g2ThImqMOx10NUxU2WENhpgTFQsfZLZ/GFb2NI1zPTfVGOmKZjCjuPwDaQdzygvRMNoAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/8ac56/image-25.webp 240w,
/static/7d4dd945a94499e44e58e11ad7c35444/d3be9/image-25.webp 480w,
/static/7d4dd945a94499e44e58e11ad7c35444/b0a15/image-25.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/8ff5a/image-25.png 240w,
/static/7d4dd945a94499e44e58e11ad7c35444/e85cb/image-25.png 480w,
/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png&quot;
            alt=&quot;image-25.png&quot;
            title=&quot;image-25.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;僕の環境では、DNSサーバが&lt;code class=&quot;language-text&quot;&gt;192.168.100.50&lt;/code&gt;でのソケットを開けなかったというエラーが出力されていました。&lt;/p&gt;
&lt;h3 id=&quot;adドメイン名にlocalを使っている&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%90%8D%E3%81%ABlocal%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B&quot; aria-label=&quot;adドメイン名にlocalを使っている permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADドメイン名に.localを使っている&lt;/h3&gt;
&lt;p&gt;僕の環境ではこれをやらかしてました。&lt;/p&gt;
&lt;p&gt;AD立て直しです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://asohiroblog.net/active-directory-domain-name-local/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active Directoryのドメイン名に「.local」を使ってはいけない件 - asohiroblog&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ipv6を無効化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ipv6%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;ipv6を無効化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IPv6を無効化する&lt;/h3&gt;
&lt;p&gt;IPv6で名前解決を使用とするとAD参加に失敗する場合があるそう。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vamdemicsystem.black/windows/%E3%80%90activedirectory%E3%80%91%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%8F%82%E5%8A%A0%E6%99%82%E3%81%AB%E3%80%8C%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3xxx%E3%81%AEactivedirectory%E3%83%89%E3%83%A1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;【Active Directory】ドメイン参加時に「ドメインxxxのActiveDirectoryドメインコントローラ(AD DC)に接続できませんでした。」メッセージが出力され失敗する | 株式会社ヴァンデミックシステム&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;dnsによりドメインコントローラの参照ができているのにadに参加できない&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dns%E3%81%AB%E3%82%88%E3%82%8A%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%8F%82%E7%85%A7%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%ABad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84&quot; aria-label=&quot;dnsによりドメインコントローラの参照ができているのにadに参加できない permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DNSによりドメインコントローラの参照ができているのにADに参加できない&lt;/h3&gt;
&lt;p&gt;以下のようなエラーが発生している場合、DNSによりドメインコントローラの名前解決には成功しているにも関わらず、ドメインコントローラへの接続に失敗しているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;クエリによって、次のドメイン コントローラが識別されました:

&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;DC&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

このエラーの一般的な原因として挙げられるのは:

- ドメイン コントローラの名前を IP アドレスに割り当てるための Host &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; レコードが見つからないか、正しくないアドレスを含んでいる。
- DNS で登録されているドメイン コントローラがネットワークに接続されていないか、実行中でない。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;僕の環境では、複数NIC構成でADを作成した際にこの問題が発生しており、ADサーバに割り当てるNICを一つにした状態でADを再作成したら解消されました。&lt;/p&gt;
&lt;h3 id=&quot;連携がうまくいかないときは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%A3%E6%90%BA%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8B%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF&quot; aria-label=&quot;連携がうまくいかないときは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;連携がうまくいかないときは&lt;/h3&gt;
&lt;p&gt;以下を確認してみる。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://niyodiary.cocolog-nifty.com/blog/2009/09/pc-499b.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ドメイン参加時にクライアントPC・サーバー設定で気をつけること: niyoな日記&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下の記事も参考にしました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://validationmemo.blogspot.com/2019/01/active-directory.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ValidationMemo: Active Directoryのドメイン名を検討するときに考えるべきこと&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ldapsを有効にしてアプリケーションとad連携する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ldaps%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%97%E3%81%A6%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8ad%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;ldapsを有効にしてアプリケーションとad連携する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;LDAPSを有効にしてアプリケーションとAD連携する&lt;/h2&gt;
&lt;p&gt;LDAPSを利用して他のアプリケーションとAD連携を行うには、以下の記事が参考になりました。&lt;/p&gt;
&lt;p&gt;Acrive Directory 証明書サービスをインストールして自己証明書で認証を行うだけれあれば、非常に簡単に設定できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kmmr.jp/post-413/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active DirectoryのLDAPS通信を有効化する | KMMR Note&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blog.putise.com/windows-ad%E3%81%AEldaps%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%AE%E6%A7%8B%E7%AF%89%E6%96%B9%E6%B3%95/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows ADサーバーのLDAPS有効化の構築方法 | puti se blog&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;中々問題が解消できず、トラブルシューティングにかなり時間がかかりました。&lt;/p&gt;
&lt;p&gt;やっぱりAD連携そのものへの理解が不足しているとトラシューにも時間がかかりますね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Ubuntu20.04にXRDP接続した際に起きた問題についてのまとめ]]></title><description><![CDATA[この記事では、Ubuntuマシンに対してXRDP接続を行ったときに発生した問題についてまとめています。]]></description><link>https://kashiwaba-yuki.com/linux-trouble-ubuntu-rdp</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-trouble-ubuntu-rdp</guid><pubDate>Tue, 30 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;この記事では、Ubuntuマシンに対してXRDP接続を行ったときに発生した問題についてまとめていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E3%81%A7%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%89%E3%83%90%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A&quot;&gt;UbuntuにXRDPで接続するときにサイドバーを表示する設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A%E3%81%8C%E5%88%A9%E3%81%8B%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C%E3%81%AE%E5%AF%BE%E5%87%A6&quot;&gt;UbuntuにXRDP接続したときに日本語キーボード設定が利かなくなる問題の対処&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E9%96%B2%E8%A6%A7%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%93%8D%E4%BD%9C%E3%81%8C%E9%81%85%E3%81%84%E5%95%8F%E9%A1%8C&quot;&gt;ブラウザ閲覧時のスクロール操作が遅い問題&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;ubuntuにxrdpで接続するときにサイドバーを表示する設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E3%81%A7%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%89%E3%83%90%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;ubuntuにxrdpで接続するときにサイドバーを表示する設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UbuntuにXRDPで接続するときにサイドバーを表示する設定&lt;/h2&gt;
&lt;p&gt;UbuntuなどのLinuxマシンを建てたときに、ホストからRDPでアクセスするためにXRDPを使用します。&lt;/p&gt;
&lt;p&gt;この場合、ただXRDPを使うだけなら以下のようなコマンドだけでも問題ないのですが、Ubuntuの場合はアプリケーションランチャーになるサイドバーが表示されなくなってしまいます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; -y xrdp
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; xrdp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;その場合は、ホームディレクトリに&lt;code class=&quot;language-text&quot;&gt;.xsessionrc&lt;/code&gt;を作成し必要な接敵を書き込むことでサイドバーを表示させることができるようになります。&lt;/p&gt;
&lt;p&gt;具体的には、以下のコマンドをコピペするだけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# ~/.xsessionrc に書き込む&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;GNOME_SHELL_SESSION_MODE&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ubuntu
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;XDG_CURRENT_DESKTOP&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ubuntu:GNOME
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;XDG_DATA_DIRS&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop

&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;EOF&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ~/.xsessionrc&lt;/span&gt;
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコマンドで&lt;code class=&quot;language-text&quot;&gt;.xsessionrc&lt;/code&gt;が作成されたら、以下のコマンドでサービスを再起動します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart xrdp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.hiroom2.com/2018/04/28/ubuntu-1804-xrdp-gnome-ja/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ubuntu 18.04: GNOMEデスクトップ環境にXRDPで接続する - Narrow Escape&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ubuntuにxrdp接続したときに日本語キーボード設定が利かなくなる問題の対処&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A%E3%81%8C%E5%88%A9%E3%81%8B%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C%E3%81%AE%E5%AF%BE%E5%87%A6&quot; aria-label=&quot;ubuntuにxrdp接続したときに日本語キーボード設定が利かなくなる問題の対処 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UbuntuにXRDP接続したときに日本語キーボード設定が利かなくなる問題の対処&lt;/h2&gt;
&lt;p&gt;デフォルトの状態でXRDP経由のアクセスをした場合、UbuntuのキーボードがUS配列になってしまう場合があります。&lt;/p&gt;
&lt;p&gt;その問題を回避するために、以下の設定を実施します。&lt;/p&gt;
&lt;p&gt;まずは、設定画面を開きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gnome-session-properties&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、[Add] をクリックして、NameとCommandに、それぞれ以下を入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Name&lt;/span&gt;
Set JP keyboard on X startup

&lt;span class=&quot;token comment&quot;&gt;# Command&lt;/span&gt;
setxkbmap jp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらが設定画面です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 78.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAEAklEQVQ4y2WS609TdxjHzxvJmEQ2BVflbrhpAQHLpVwKDLygUYQB4yK0KFBAkciYIoGwaYKJRtwYOJR7W2gtLRSYjiL4dtlf4WuGBMIILXPbZ7+eTbNsJ+eT5znP8zvf8zwnX6k2xovK+P2UqQ5RoVJQkSRikoJLKQqq1QFo04LQCbTqQKpSDslcShZnPKQEUKXy47JyD5djvaiJ2YPUFO/FmYRIUlVqMpNS0SSlk63KEmjITcnhVNpJTqrzyErMJC02lcz4dDLi08g8riYjMYv8xDgaj3uhj/eWkVpU3hQejSQjJI64g0Ec9z9Con80J/yjSFYoSQ+KQn04gljfcJnovaEofUKI3RdGjE8YeYpArqs+5HqSD80qH6Q29V6KI5WcUeah1VVTc1mHrkYrU99QT+PVBhqb9DQ0NaBv1KMTfc85T18v+rpP1bQkfsAXal9aU32ROjUfcfFIJJXZpTwzmzEZDZjNFiwWC/Pz8yz+uIjTuYRz0cnLpZe8WllheeWV3HvufElnrZYbiV60a/bTpt6HdCf3AEXhUZSoL2KcmKJvYJDKqktUVJRTV19H25dtdHTcFnTQ2nqDa83NtF2/Sv+jh0zPztFRU8nNZG86s/24mSYmvHf6ICVRRynPKWOkvYXB2iJGng5iNJkYG3rClHGCScO4jGFsRHx0DNvECIahQZ7NOOi6UkVXug/dOf50Zh1AenBWQUlENJ9nFjMuvjp6/y5rv6ziuVy/brHxZo3fXDv8vusWlT/F/YfcW1lexioEu+u13NH40nNKwd1cP6Tec8JPx5SUZRZhdziYXXjO69evWV1dZXNzk42NDVwuN2/fvsXtcsm17e1tlpyLsuDXei09OR/zIP8QPXkHkfoLAimNUlKcVozNZsUxO8ubtTUh4sLtdrO7uyvnrh2XHHfdu3JtyemUBb+q13E/7wC95wK4J6aUBouC0SdEcSXvPDa7DYeYcn19XX5pZ2fnPe9EPblbTPxOsKdJy8PTfnxzPlBMeRjpyWdHGC4M4mmdhmmb/X+CspDAs6ZnfU/c2toSFnJisTl4equavnOf8O2FYHrPCsHh0nCMpcFMNGYJQRtzQnB+bo4F4bN/4/HdnKj/HR1YhU9tjgWG2qsZOK/gu4IQeW1pvCwSS1kIhqbcfyacw26fwT4zI37BzPvc/p/carVin3/B8G0d319QMFAYSp9YWzKURzJdEcrUtRyMwmse33kwCyymccwmg/xsmTQIjEyZPBiYFH40mCYZulnJk4LDPC4Ko78gCMlYHsGzqmima2Kw1J5gui4Je0MKiw0nWO4+yw9d+by4lsxPrQn83K7BeSubqbpkxqvjGa1KYLTiGMMlYTwuDGHgYjB/AYgNGXLsrNnRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/8ac56/image-15.webp 240w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/d3be9/image-15.webp 480w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/b0a15/image-15.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/8ff5a/image-15.png 240w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/e85cb/image-15.png 480w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png&quot;
            alt=&quot;https://yukituna.com/wp-content/uploads/2021/11/image-15.png&quot;
            title=&quot;https://yukituna.com/wp-content/uploads/2021/11/image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでOSを再起動すると、次回のアクセスからJIS配列が反映されるようになりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/vochicong/items/6452ac54bde56b0e0bb3&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ubuntu で日本語キーボードレイアウト - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ブラウザ閲覧時のスクロール操作が遅い問題&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E9%96%B2%E8%A6%A7%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%93%8D%E4%BD%9C%E3%81%8C%E9%81%85%E3%81%84%E5%95%8F%E9%A1%8C&quot; aria-label=&quot;ブラウザ閲覧時のスクロール操作が遅い問題 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブラウザ閲覧時のスクロール操作が遅い問題&lt;/h2&gt;
&lt;p&gt;XRDP経由でスクロール設定が反映されない問題は既知事象なのですが、長らく修正されていないようです。&lt;/p&gt;
&lt;p&gt;参考；&lt;a href=&quot;https://github.com/neutrinolabs/xorgxrdp/issues/150&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Vertical scroll speed too fast (xrdpMouse) · Issue #150 · neutrinolabs/xorgxrdp&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;imwheelなどのツールを試しましたが効果はありませんでした。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;個人的にハマった問題の解消方法をまとめました。&lt;/p&gt;
&lt;p&gt;Ubuntuのセットアップでまた困ったことがあれば、都度追記していきたいと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-006-symbol</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-006-symbol</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は、上記のWinDbgまとめ記事で解析のために使用するサンプルプログラムをビルドする環境について紹介します。&lt;/p&gt;
&lt;p&gt;以下の要件を実現できる環境を、WSL2上のUbuntu20.04で構築していきます。
基本的にはDockerコンテナを使用するので、Dockerが動くならどの環境でも問題ないと思います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Linux環境でEXEファイルをクロスコンパイルできる&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Linux環境でシンボルファイル（.pdbファイル）を生成できる&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%93%E3%83%AB%E3%83%89%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B&quot;&gt;ビルド環境を整える&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABpdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot;&gt;シンボルファイル（.pdbファイル）とは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#linux%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%99%82%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95&quot;&gt;Linux環境でコンパイル時にシンボルファイルを生成する方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#llvm-mingw%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B&quot;&gt;llvm-mingwの環境を用意する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#llvm-mingw%E3%81%A7pdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BB%98%E3%81%8D%E3%81%A7c%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;llvm-mingwでPDBファイル付きでC++ファイルをコンパイルする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;ビルド環境を整える&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%93%E3%83%AB%E3%83%89%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B&quot; aria-label=&quot;ビルド環境を整える permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ビルド環境を整える&lt;/h2&gt;
&lt;p&gt;WinDbgテスト用のプログラムは、以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずは、Dockerが利用可能なOS上の任意のディレクトリに上記のリポジトリをcloneします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/kash1064/Try2WinDbg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、コンパイル用の以下のコンテナイメージをpullします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; pull kashiwabayuki/try2windbg:1.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://hub.docker.com/r/kashiwabayuki/try2windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kashiwabayuki/try2windbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このコンテナイメージは、&lt;a href=&quot;https://hub.docker.com/r/mstorsjo/llvm-mingw/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;mstorsjo/llvm-mingw&lt;/a&gt;のコンテナイメージを一部カスタマイズしたイメージです。&lt;/p&gt;
&lt;p&gt;詳細については後述します。&lt;/p&gt;
&lt;p&gt;サンプルプログラムのリポジトリとコンテナイメージの取得が完了したら、ダウンロードした&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg&lt;/code&gt;ディレクトリに移動します。&lt;/p&gt;
&lt;p&gt;続いて、以下のコマンドを入力することで、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/src&lt;/code&gt;直下に、コンパイルされたEXEファイルとシンボルファイルが生成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; Try2WinDbg

&lt;span class=&quot;token comment&quot;&gt;# ビルドに使用するコンテナイメージを指定&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;CONTAINER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kashiwabayuki/try2windbg:1.0
&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; run --rm -it -v &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;/src:/try2windbg &lt;span class=&quot;token variable&quot;&gt;$CONTAINER&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bash&lt;/span&gt; -c &lt;span class=&quot;token string&quot;&gt;&quot;cd /try2windbg &amp;amp;&amp;amp; make&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで、環境構築は完了です。&lt;/p&gt;
&lt;h2 id=&quot;シンボルファイルpdbファイルとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABpdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot; aria-label=&quot;シンボルファイルpdbファイルとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイル（.pdbファイル）とは&lt;/h2&gt;
&lt;p&gt;拡張子&lt;code class=&quot;language-text&quot;&gt;.pdb&lt;/code&gt;を持つファイルは、シンボルファイルと呼ばれるファイルです。&lt;/p&gt;
&lt;p&gt;PDBは、「プログラムデータベース」の略称で、プロジェクトのソースコード内の識別子とステートメントをコンパイル済みアプリの対応する識別子と命令にマッピングしています。&lt;/p&gt;
&lt;p&gt;このシンボルファイルを利用することで、デバッガを用いてアプリケーションやプロセスの解析を行う際に、非常に効率的な解析を行うことができます。&lt;/p&gt;
&lt;p&gt;シンボルファイルがなくても、デバッガによる解析は可能です。&lt;/p&gt;
&lt;p&gt;しかし、適切なシンボルファイルが読み込まれている場合と読み込まれていない場合には、同じアドレスを指し示す場合にも、デバッガ上で次のような表示の差異が発生します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;sample+0x110     &lt;span class=&quot;token comment&quot;&gt;# シンボルファイルなし&lt;/span&gt;
sample&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;main+0x10 &lt;span class=&quot;token comment&quot;&gt;# シンボルファイルあり&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルを適切に読み込ませることで、被疑箇所をスムーズに特定したり、関数名から挙動を類推したりと、より効率的にデバッグを行うことができるようになります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/visualstudio/debugger/specify-symbol-dot-pdb-and-source-files-in-the-visual-studio-debugger?view=vs-2019&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッガーでシンボル (.pdb) ファイルとソース ファイルを設定する | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;linux環境でコンパイル時にシンボルファイルを生成する方法&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#linux%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%99%82%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95&quot; aria-label=&quot;linux環境でコンパイル時にシンボルファイルを生成する方法 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Linux環境でコンパイル時にシンボルファイルを生成する方法&lt;/h2&gt;
&lt;p&gt;Windowsアプリケーションのデバッグ時に非常に重要なシンボルファイルですが、Microsoftコンパイラの場合はビルド時に自動的に作成されます。&lt;/p&gt;
&lt;p&gt;しかし、MinGWなどを用いてLinux環境でクロスコンパイルを行う場合は、シンボルファイルは通常生成されません。&lt;/p&gt;
&lt;p&gt;MinGWでクロスコンパイルしたEXEファイルのシンボルファイルを作成する方法については、以下のStackOverFlowのように、&lt;code class=&quot;language-text&quot;&gt;cv2pdb&lt;/code&gt;を用いた方法が案内されるケースもありますが、この方法ではLinux環境ではシンボルファイルの作成ができません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/19269350/how-to-generate-pdb-files-while-building-library-using-mingw/28627790&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - how to generate pdb files while building library using mingw? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで今回は、&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;を用いた方法を利用しました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;とは、&lt;a href=&quot;https://llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LLVM&lt;/a&gt;/&lt;a href=&quot;https://clang.llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Clang&lt;/a&gt;/&lt;a href=&quot;https://lld.llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LLD&lt;/a&gt; をベースにした&lt;code class=&quot;language-text&quot;&gt;mingw-w64&lt;/code&gt;のツールチェーンです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;mstorsjo/llvm-mingw: An LLVM/Clang/LLD based mingw-w64 toolchain&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;LLVMとは、一言で言うとプラットフォームに依存せずに任意のプログラミング言語のコンパイルを行うことができる基盤です。&lt;/p&gt;
&lt;p&gt;また、ClangとLLDは、LLVM用のC言語とリンカです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;は、通常のMinGWがGNUベースのbinutilsをLLVMベースのbinutilsに置き換えたものです。&lt;/p&gt;
&lt;p&gt;これによって、様々なコンピュータアーキテクチャ（i686、x86_64、armv7、arm64）に対して単一のツールチェーンでのコンパイルを実現しています。
また、PDB形式でのシンボルファイルの生成もできるようになります。&lt;/p&gt;
&lt;h2 id=&quot;llvm-mingwの環境を用意する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#llvm-mingw%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B&quot; aria-label=&quot;llvm mingwの環境を用意する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;llvm-mingwの環境を用意する&lt;/h2&gt;
&lt;p&gt;LLVMベースのMinGWを利用できる環境を用意するために最も簡単な方法は、公式の用意している&lt;a href=&quot;https://hub.docker.com/r/mstorsjo/llvm-mingw/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Dockerイメージ&lt;/a&gt;を使用することです。&lt;/p&gt;
&lt;p&gt;基本的には、このイメージをDockerhubからpullするだけで、簡単に利用できるようになります。&lt;/p&gt;
&lt;p&gt;もしDockerコンテナではなく、Linuxのホスト上にllvm-mingwの環境を構築する必要がある場合は、以下のDockerfile内のスクリプトを参考にするとよいです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw/blob/master/Dockerfile.cross&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw/Dockerfile.cross at master · mstorsjo/llvm-mingw&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;llvm-mingwでpdbファイル付きでcファイルをコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#llvm-mingw%E3%81%A7pdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BB%98%E3%81%8D%E3%81%A7c%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;llvm mingwでpdbファイル付きでcファイルをコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;llvm-mingwでPDBファイル付きでC++ファイルをコンパイルする&lt;/h2&gt;
&lt;p&gt;llvm-mingwの使い方は以下の通りです。&lt;/p&gt;
&lt;p&gt;公式のDockerイメージの場合は、すでにLLVMベースのMinGWに対して、&lt;code class=&quot;language-text&quot;&gt;x86_64-w64-mingw32-g++&lt;/code&gt;としてパスが通っています。&lt;/p&gt;
&lt;p&gt;これを利用して、&lt;code class=&quot;language-text&quot;&gt;-Wl,-pdb=&amp;lt;filename&gt;.pdb&lt;/code&gt;というオプションを付けてコンパイルを実行することで、EXEファイルのコンパイルと同時にシンボルファイルも作成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;x86_64-w64-mingw32-g++ -Wl,-pdb&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;sample.pdb sample.cpp -o sample.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、Linux環境でWindows向けのEXEファイルをクロスコンパイルする際に、デバッグ用のシンボルファイルを作成する方法についてまとめました。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-007-memory-spoofing</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-007-memory-spoofing</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;では、WinDbgを用いてユーザモードアプリケーションのデバッグを行う方法について紹介しました。&lt;/p&gt;
&lt;p&gt;今回は、ユースケース別のWinDbgの使い方として、ユーザモードアプリケーションのライブデバッグ時に、メモリやレジスタの情報を確認する方法について紹介します。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E3%81%AE%E7%9B%AE%E6%A8%99&quot;&gt;今回の目標&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot;&gt;本記事で使用するサンプルプログラム&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot;&gt;WinDbgでアプリケーションを起動する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#main-%E9%96%A2%E6%95%B0%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;main 関数のアドレスにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#return_addr%E9%96%A2%E6%95%B0%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;return_addr関数にブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot;&gt;メモリの情報を参照する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E6%94%B9%E3%81%96%E3%82%93%E3%81%99%E3%82%8B&quot;&gt;メモリの情報を改ざんする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回の目標&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E3%81%AE%E7%9B%AE%E6%A8%99&quot; aria-label=&quot;今回の目標 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回の目標&lt;/h2&gt;
&lt;p&gt;今回の目標は以下の2点です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;関数呼び出し時に、RSP/BSPに関数の実行が終了した後に呼び出される命令のアドレスが格納されることを確認する&lt;/li&gt;
&lt;li&gt;RSPの参照するメモリ情報を改ざんして、任意の関数を実行させる&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;今回は、WinDbgによるユーザモードアプリケーションのライブデバッグで、プログラムの各所にブレークポイントを設定し、関数呼び出し時のスタックの情報を参照していきます。&lt;/p&gt;
&lt;p&gt;また、WinDbgからメモリの情報を改ざんして、任意のプログラムを実行させてみます。&lt;/p&gt;
&lt;h2 id=&quot;本記事で使用するサンプルプログラム&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot; aria-label=&quot;本記事で使用するサンプルプログラム permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;本記事で使用するサンプルプログラム&lt;/h2&gt;
&lt;p&gt;今回テストに使用するのは、以下のソースコードからなるプログラムです。&lt;/p&gt;
&lt;p&gt;実行されると&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数を呼び出して、いくつか文字列を出力した後に終了するプログラムです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// return_addr.cpp&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ret_func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Call ret_func\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Start main\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ret_func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Return ret_func\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;サンプルコードについては、&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;に置いてあります。&lt;/p&gt;
&lt;p&gt;サンプルプログラムをシンボルファイル(（.pdb）付きでコンパイルする方法については、以下の記事でまとめているので良ければご参照ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;それでは、このソースコードをコンパイルした&lt;code class=&quot;language-text&quot;&gt;return_addr.exe&lt;/code&gt;を使用して、さっそく解析を行っていきます。&lt;/p&gt;
&lt;h2 id=&quot;windbgでアプリケーションを起動する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでアプリケーションを起動する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでアプリケーションを起動する&lt;/h2&gt;
&lt;p&gt;今回はUWP版のWinDbg Previewを使用して解析を行います。
Windowsストアからダウンロードできます。&lt;/p&gt;
&lt;p&gt;まずは、コンパイルした&lt;code class=&quot;language-text&quot;&gt;return_addr.exe&lt;/code&gt;をWinDbgから実行します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACM0lEQVQoz5WSS28SURiGJ+qGQiqX2gXlfhPBdBQEBk0lKQsv3fgvCLeNsbiQiImbbizwAxrX/Aa7NsaFMcbYFBhgZijQaaEQoGFTXuecGi+JGj3Jk+9cvnnP+31nGEkUIApNSEILDb6Gk0Ef8/kZyJjP8V9jNpuB2W/J2GsegpcGaPXG2OO72Nl5je3tVyiXy5RSqUQpFovf579SxtbWFnZ334D5Igzw/nML7z7y+FSX8fZDFZ6rXuh1l7G8vITFxUXodDpoNBqoVCrKwsICjWq1mu5fWVrChYuX8PhJDszxkQyx1YTQbCjlHqPV5BFdi8Fms2GVZREOh8EqkRAKhRCNRhEMBhGJRBAIBCjXvF4YV8x4/uIlmCP5AIIootPpYHp6inq9Di5+X0lYAXszgAcPN6gA+ZDjoojH4+AU0VgsRi/jOA4ulwtarRb5/DMw8uEBOt0uer0eToZDVKtV3F6/B4fLDY/HQ52aTCaK2WyGxWKhkUD2yNrpdEKv1yuCeTBCo44DxV273YYsy6jVarizdhdWmxVepRSr1UpF/4bD4fghWG/wSrnnDieTCXieR0TpIXHn9/v/SZA4NBgM54L7UgeiJEIQBIzHY9rD9Y1HuL7K0maTkojonyDndrud/glUcNDvo/+N6XRKHQaDt2A0GuHz+SjErdvt/i3knGVv0PxCoQBmNBqBMFQehDiUJAm5zU0kEglkMhlks1mk02mkUikafyaZTCKXe0qdkbxKpYKvCaUEELLRkZkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/8ac56/image-39.webp 240w,
/static/8f30de1343e57c5f98ceb1fe263c893d/d3be9/image-39.webp 480w,
/static/8f30de1343e57c5f98ceb1fe263c893d/b0a15/image-39.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/8ff5a/image-39.png 240w,
/static/8f30de1343e57c5f98ceb1fe263c893d/e85cb/image-39.png 480w,
/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png&quot;
            alt=&quot;image-39.png&quot;
            title=&quot;image-39.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、起動前の状態で停止し、デバッグコマンドか使用できるようになります。&lt;/p&gt;
&lt;p&gt;まずはシンボルファイルを読み込ませていきます。&lt;/p&gt;
&lt;p&gt;僕の環境では、デスクトップに&lt;code class=&quot;language-text&quot;&gt;return_addr.pdb&lt;/code&gt;を配置しているため、&lt;code class=&quot;language-text&quot;&gt;.sympath+ &amp;lt;デスクトップのパス&gt;&lt;/code&gt;としてます。
シンボルファイルのパスを追加した後は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\Desktop
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが適切に読み込まれている場合、以下の画像のように&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.exe&lt;/code&gt;の関数名などをWinDbgが解釈して表示することができるようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;㏐&lt;/code&gt;コマンドでモジュール一覧を表示した際に、以下のように&lt;code class=&quot;language-text&quot;&gt;(pdb symbols)&lt;/code&gt;と表示されていればOKです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
00007ff7`cd710000 00007ff7`cd72a000   return_addr C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\return_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\28CEC53415E7CD7D4C4C44205044422E1\return_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
00007ffd`ef320000 00007ffd`ef5e9000   KERNELBASE   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`ef5f0000 00007ffd`ef6f0000   ucrtbase   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`f01b0000 00007ffd`f026e000   KERNEL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`f18d0000 00007ffd`f1ac5000   ntdll      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\96EF4ED537402DAAA51D4A4212EA4B2C1\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;main-関数のアドレスにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main-%E9%96%A2%E6%95%B0%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;main 関数のアドレスにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main 関数のアドレスにブレークポイントを設定する&lt;/h2&gt;
&lt;p&gt;プログラムのデバッグのためにブレークポイントを設定したいので、まずはmain関数のアドレスを特定していきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x /D /f return_addr!m*&lt;/code&gt;を実行すると、mから始まるシンボルの一覧が表示されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;f return_addr!m*
 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z

00007ff6`96451490 return_addr!main &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`964527b0 return_addr!memcpy &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;memcpy&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`96452790 return_addr!malloc &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;malloc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`96451420 return_addr!mainCRTStartup &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainCRTStartup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`964516a0 return_addr!matherr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_matherr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;main関数は&lt;code class=&quot;language-text&quot;&gt;00007ff7 cd711490&lt;/code&gt;にあることがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bu&lt;/code&gt;コマンドでブレークポイントを設定し、&lt;code class=&quot;language-text&quot;&gt;bl&lt;/code&gt;コマンドで設定されたことを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu 00007ff7`cd711490
0:000&gt; bl
     1 e Disable Clear  00007ff7`cd711490     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドでプログラムを実行したところ、main関数の開始時点で停止するところまで進めることができました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABwElEQVQoz3WS2a6bMBRF+f9f6W9UqtSXVrlqEsKUQIBg5sHMZPVAVfWhupa2bGR7s473Mb58tfl28rCdANuLiV4FSZrzEiVZQRQrfD+gKiumaaJre9qmRetevuf/ZDw9F9eyud1s7p5Pmma0bYPuOvpeUxQFpnlFqYR99P3Ctm18NoyHr7jfEx4PRRSV5Hkrhi2NqBPTPC+wLIebaVPXrRhCXQmdXhnbhUHPjOPM338YHx8nLpcPzudfQmmSJIlQlXK5pm4aIU6xbj9xnZOUG9HWKXUZsgwFLA2sNbxFW81bZHhSpm0nhGFElqVClFNKmftcVRXZbmj+4Hr+LmsH3cp+7KNVxFJkzDplnjK2pRTTCsNxfDyv4fVS8k7qINrnMAyPdZIoXPd+vLGSoHQH1bOjew7oYKRLBzo9sCzvPyVfrxeez4cYvojjmCAIyIVwXVc5tFBKujfTPOj30bUT0zx/Eskbw3UcbMvCvJxxHFta5CEmJdu6HEf2tE0xdF33CGscNoZBiMR0nv5pb6kdwIiiFyqTEKS/yrpDDzPDtNJ0I8O8kcqe67h4Yri/bVn2qFCCURVjI7S1SKjHcTpMfwPouqnJpSj4BwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/8ac56/image-40.webp 240w,
/static/3d5add2849ffd712de4c9b1b90999cec/d3be9/image-40.webp 480w,
/static/3d5add2849ffd712de4c9b1b90999cec/b0a15/image-40.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/8ff5a/image-40.png 240w,
/static/3d5add2849ffd712de4c9b1b90999cec/e85cb/image-40.png 480w,
/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png&quot;
            alt=&quot;image-40.png&quot;
            title=&quot;image-40.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;return_addr関数にブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#return_addr%E9%96%A2%E6%95%B0%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;return_addr関数にブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;return_addr関数にブレークポイントを設定する&lt;/h2&gt;
&lt;p&gt;今回は、関数呼び出し時のベースポインタに格納される値を確認することを目的にしています。&lt;/p&gt;
&lt;p&gt;そのため、次はDisassemblyウインドウで確認した&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の先頭アドレスにブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu 00007ff6`96451470
0:000&gt; bl
     0 e Disable Clear  00007ff6`96451470     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!Z8ret_funcv
     1 e Disable Clear  00007ff6`96451490     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行したところで、&lt;code class=&quot;language-text&quot;&gt;r&lt;/code&gt;コマンドを使ってレジスタ情報を出力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; g
Breakpoint 0 hit
return_addr!Z8ret_funcv:
00007ff6`96451470 4883ec28        sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;28h

0:000&gt; r
rax=000000000000000b rbx=0000000000000001 rcx=00000000ffffffff
rdx=00007ffdef6e0980 rsi=0000021d4c3134d0 rdi=000000000000002b
rip=00007ff696451470 rsp=0000002e738ff748 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000002e738ff780
 r8=0000002e738fdb78  r9=0000021d4c31a47b r10=0000000000000000
r11=0000002e738ff660 r12=0000000000000000 r13=0000000000000000
r14=0000021d4c315230 r15=0000000000000001
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
return_addr!Z8ret_funcv:
00007ff6`96451470 4883ec28        sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;28h&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数呼び出し直後の&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値は&lt;code class=&quot;language-text&quot;&gt;0x2e738ff780&lt;/code&gt;であることがわかりました。&lt;/p&gt;
&lt;h2 id=&quot;メモリの情報を参照する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリの情報を参照する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリの情報を参照する&lt;/h2&gt;
&lt;p&gt;次に、Memoryウインドウのアドレスバーに&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの指すアドレスを入力し、メモリの情報を確認します。&lt;/p&gt;
&lt;p&gt;どうやら、&lt;code class=&quot;language-text&quot;&gt;0x7FF6964513DA&lt;/code&gt;という値が格納されているようです。（リトルエンディアン表記なので逆から読みます。）&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 554px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQoz4WR227TUBBF/ZfwEMoP8FXwALS0FImXEtFULUkaJ67tXJo0vh1fjh07tFVVhFRouxgnEeIBhKWlPT6zZ86Mbez3Y3YHmp2+5l0/F83Y7qf/x/yTTY2o8WI/pvE65Okrjycv5zTehDS2Axpv/84zyW3thGxtK9FINNrEIc9Fje8319zdXvPtquT2soT7O+Dnhvu1Pm54+CHvD/z7ecRwXYe80ASBT7WsWH5dUhQFVVVRlguSJBEUl8uFUHJztWSRp+gkIlYhi7KgrEqpq/ADmfBzq4NpjWh3LSx7ypk748yZYjkzYYo5kFzP5aB3wSfTo9n3+die8OF4RLPtSs1kVWMPL+j1xxjNwzY9KTrpWNJ4Qtd0aZ/aa7o2nZ7Dcdfh/ZHD3pHLbstlr1XHQw5OHLo9my+nzsp32DIxbNsi1ymz2TlFrkmTmDD0iaLgN/VqeaqEiCyOyGVdHcu5+JTaeOR85MqEA8sijELG4xFJmkkywvN8fH9NHYehNMo0mdbiSVcaRor5fL769p74giDAHZ5jjKRRnudS7KF1TiZNlVKoWMlk8Yr6x2RZRirNaq+uN0kTlFwex7F4157p1OMXnoZz0M48/4oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/8ac56/image-41.webp 240w,
/static/1cabcf6604be115fac70bf2636e0bf95/d3be9/image-41.webp 480w,
/static/1cabcf6604be115fac70bf2636e0bf95/5e3e0/image-41.webp 554w&quot;
              sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/8ff5a/image-41.png 240w,
/static/1cabcf6604be115fac70bf2636e0bf95/e85cb/image-41.png 480w,
/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png 554w&quot;
            sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png&quot;
            alt=&quot;image-41.png&quot;
            title=&quot;image-41.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このアドレスについて、Disassemblyウインドウで確認したところ、&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の実行が完了して戻り値を返した後に実行される命令のアドレスであることがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/75609/image-42.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACRElEQVQoz3WSC2/TMBSF8++RgDHBj+BXoGkPNCQYg3bL2qRJ0yTOY3nYead5NIfrbFDEhKVP17Gdo3OPrXz8yvDhiuHVJxtvzz2cXPh4febSnOHNmY2TcwfvLhycXjK8/+zP9fTSw+mFhL2oimntoBkW1qYN3XLgxwLtCCT5iCguENopgl2K0OEooj26fEJXEwdifImiaxo2ug5ru4WhaxCcQ45M9GjKBrEXoc1q1LxCKxqgo0368X9D0UhQom82s2ieF/NGmvaosxZ1WAMlLcjlHJj4hKkgOmJPkNNpOjILzi43BjzPQ9vuMQw9EhJs8hbZLsPe36MPe0wpORMkHD0TS7f/ONSpXcmW3FnWFqqqIssycnpALmSGAWI/RsxiJF4C7nPwhMgIkSKO45kkSVBW5VOGuqbDMMy5ddt20HV7iGxAXTQISDB0Q8RuDB6QiMchEgEhBMVyFJQmuq6DYlB2hmHMQjJDlzGM44iScqvrBsxj8AMfj9EjsjwjVyTKU6RcVj47i6Loj6iyXCxwc3ODxXKJH7e3uL7+gjAM4NAz8cmduTBh3Vswf5rQv+vQvq2hqRrWz9k/qA9YrVZYr9dkyoai3t9jSWJ3VOUB2bogF0FY0pNJEKx8BGoAducRDM7SAVtQXbhw71w4W4e6ornLqKvfGc6XYtGlSHZ0/Qdq74CuGFDZJVrWonEa1Lsa1bZC5RFJhTqh77KahaqqOmZomubsTObAuUDfd1QHFEUJXnB6GSOGw3Bk/IthoPM9+uFp/gstOXoteJ6MiAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/8ac56/image-42.webp 240w,
/static/40941ec5ef1fd3456d2071540c9f93f0/d3be9/image-42.webp 480w,
/static/40941ec5ef1fd3456d2071540c9f93f0/e46b2/image-42.webp 960w,
/static/40941ec5ef1fd3456d2071540c9f93f0/fd213/image-42.webp 994w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/8ff5a/image-42.png 240w,
/static/40941ec5ef1fd3456d2071540c9f93f0/e85cb/image-42.png 480w,
/static/40941ec5ef1fd3456d2071540c9f93f0/d9199/image-42.png 960w,
/static/40941ec5ef1fd3456d2071540c9f93f0/75609/image-42.png 994w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/d9199/image-42.png&quot;
            alt=&quot;image-42.png&quot;
            title=&quot;image-42.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の実行が完了した後に呼び出されるアドレスを確認するため、関数が呼び出された瞬間の&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタの値を確認してみます。&lt;/p&gt;
&lt;p&gt;レジスタの情報から&lt;code class=&quot;language-text&quot;&gt;0xa74d0ffd58&lt;/code&gt;がスタックポインタのアドレスであることがわかりましたので、Memoryウインドウを確認してみます。&lt;/p&gt;
&lt;p&gt;どうやら、&lt;code class=&quot;language-text&quot;&gt;0x7FF6964514B7&lt;/code&gt;という値が格納されているようです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 450px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 108.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD3ElEQVQ4y3VVa3eiWBDk//+j7J7MZI3GGAXkJU9BBBSfM2bPJJqTpKa6Mbv7ZT/0udzm0l3VXX0xoihFmhZYt3vsdkdstwfaUW2z2WO72dH2/7Gd+luel/XfM50Zm80Wx+NPnJ7/xo8fJ5xOz7qK/fr1itfX8//ay8sZl/Mb3t5ol84YcEM0WxwOByzLJZqmQVVVWFY1P3jpDl/tcvmyCy7cn89nvL+/4+PjA5+fn2qG53qYjCcoigU810WSZJqgXBT0lRq8rmtdkyRBkqZMXCLLMt3P5zkWi5JrhjzPYURhCJeB6rpBEsca+LDfX5HWkJJsyWK322G5XKKktes11rS6rrDiulqt+K7U88bjcIjb22/MlmL0OMTU8dAQUcrsMX3iLxcLNi7RxJ7vIwjEAkynU/hcffp8z8NsFsKIowgeN0IriSNCL9iko6JomHm1WrOjrSIqSXVJ6pJQkghFoat+IleE5sREvz9AzlrYlskskX6csyYZfUVRKP0F1xnLE8UJfTkRp4gJIJvP9TkisDTNYMxmM0J3NEPI5zTLsWNTqmrJ+rSKvOValouuAUSzYoKmqVET7Zrv2k2rKEuqxLAtCw8PQ22Gy5qEUYwNKRb5HMWVjiJk18Mw0i4L3YVQJjopgVCP2dAsm8OwrgHnV8qeF7CzrVLOKRtJJAGjKGQjZkgoF6EvpZCAIif5VnqhAZWy7eiLmB9JV0Uispcii3UUGw1SEJkKnyUq8kJLIM8LJpbVGD+N0Ov1CHsOczKiNDzqbk3ZsMhZyqykWBZI2YAZ5ZIkMZpKAsyJMNXatu0KGWUlOjbsaYDB0ILjJRibnBozgOtnsJ0IUy+jpXADJrNDjK0ZzKn4Ez3jXN85fqrvw5iT8sBgN3/20RvYuP0+xLe7JwyffPzFff/RwwOfh08B7u5NfKfd9S09ez900B+6POPTXNz1JgShwg7ZCJftJ+wk0gI/n35SKg2bs2Y9NzgetljVSx0vkUu7rrFe1UpVGrjbbnQvgv9H2F2XrW702AARuvhErAVlIdIIKewZpSMilmeZsIDjJiMnd4I01JB5HI2e+EEBZ2rDYcBWddiNlfiXZafHr9tGGvU1HbKX54wmAIyAg22ZFulUOilyIcjtooeoM0Emo5ZpINFmp0Ex8UnCbp9T8CWMyWSC/v1AD5uTMWzb1etIEslkCDWZAtGr3DBh1FEWk1tG9l8+pSw0fD/QIEJFMh4Oe80mqLsLtrrOanfb1FXnl/H7OtOda2AM+n3c3PyhaB4GfYwnlv4KLNPUS8NxHFWBbVuwtGkuxe/Apd+UM053RvYC7DdDEyxIDRyupgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/edbc69403a43689b53084056d7218281/8ac56/image-43.webp 240w,
/static/edbc69403a43689b53084056d7218281/8626f/image-43.webp 450w&quot;
              sizes=&quot;(max-width: 450px) 100vw, 450px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/edbc69403a43689b53084056d7218281/8ff5a/image-43.png 240w,
/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png 450w&quot;
            sizes=&quot;(max-width: 450px) 100vw, 450px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png&quot;
            alt=&quot;image-43.png&quot;
            title=&quot;image-43.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;先ほど同様Disassemblyウインドウを確認すると、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の実行が完了した後に呼び出される予定の命令のアドレスであることが確認できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVQoz42PXXOaUBRF+f+/p51MpzNJbBILlqo1RiNcvm5BiFIxQEFFWL2R9LXTfWbNPnPOy95atBKMP31G/3iF/uGK5fUA+8sQe3CPb0yQ5hRHNxAPQ8TdEF8fIb+ZBCMT+YbeE7y7tpjNmZnfmY8nLKY/mHzVCSxBU+SsvZQ0TImWDnIp+BXEVOGe6mdGHSmP99R7RdZTKTTPdZHSJwg8wijE8Tws4dCpKSs4HKFIC/ZJzm6dUaYVTd5y2B055Wf1P3FsGuVHmrZFM8aPXBszbhQPozGD21tMlThNN9h2gu8mbB4TQiNUlQJV2UfeS5wbB//Ox525eCqE46gWUqLNlxaTJ4vpwubp2cK2LF5eNhwOFXGcs92+Ertrtv6WclNSxAVFpEiKfs8VpaLo0azVCmFbCGuFDAKqquavdrsz1e+G1yLjRMP/SLNtW1UTCCFUovhy7Lru4ll2oq4b2vO5v7fd5fcv/gDlFAXQng7N7gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/859de4dce43eae51c0392542e57f1b70/8ac56/image-44.webp 240w,
/static/859de4dce43eae51c0392542e57f1b70/d3be9/image-44.webp 480w,
/static/859de4dce43eae51c0392542e57f1b70/ed60d/image-44.webp 840w&quot;
              sizes=&quot;(max-width: 840px) 100vw, 840px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/859de4dce43eae51c0392542e57f1b70/8ff5a/image-44.png 240w,
/static/859de4dce43eae51c0392542e57f1b70/e85cb/image-44.png 480w,
/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png 840w&quot;
            sizes=&quot;(max-width: 840px) 100vw, 840px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png&quot;
            alt=&quot;image-44.png&quot;
            title=&quot;image-44.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;メモリの情報を改ざんする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E6%94%B9%E3%81%96%E3%82%93%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリの情報を改ざんする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリの情報を改ざんする&lt;/h2&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数終了後にジャンプする&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタのアドレスが指すメモリの情報を改ざんして、任意の関数を実行させたいと思います。&lt;/p&gt;
&lt;p&gt;WinDbgでは、Memoryウインドウの値を直接書き換えることで、メモリの情報を任意の値に改ざんすることが可能です。（管理者権限でWinDbgを起動しておく必要があります）&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/memory-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのメモリの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、僕の環境で利用しているWinDbg Previewでは、Memoryウインドウから値の改ざんができませんでした。（Windows Debug Toolsに含まれる WinDbg X64 では可能だったので、Preview版が未対応であるか、バグである可能性があります。）&lt;/p&gt;
&lt;p&gt;そのため、今回はMemoryウインドウからではなく、&lt;code class=&quot;language-text&quot;&gt;e&lt;/code&gt;コマンドを利用してメモリの情報を改ざんしていきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/e--ea--eb--ed--ed--ef--ep--eq--eu--ew--eza--ezu--enter-values-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;e、ea、eb、ed、eD、ef、ep、eq、eu、ew、eza (値の入力) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;改ざんしたいアドレスは、&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタの指し示している&lt;code class=&quot;language-text&quot;&gt;0x000000150acffb58&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;このアドレスの値を、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の呼び出しアドレスに変更して、もう一度&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数が実行されるように改ざんしていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の呼び出しアドレスは&lt;code class=&quot;language-text&quot;&gt;0x00007ff7 81df1470&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;以下のコマンドでまとめてメモリの情報を改ざんできます。（リトルエンディアン記法なので、逆から入力してます）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;eb 000000150acffb58 0x70 0x14 0xdf 0x81 0xf7 0x7f 0x00 0x00&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;コマンドを実行すると、見事にメモリの情報を書き換えることができました！&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 470px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACzElEQVQ4y4VU2XLbMAzU//9aJo2P2JmJ60OOrYMiKcmy5COWUexKcj3tTPuwAx4guMASDBaLlez2iThXirMF4V0hNvOSGfc3sh46NsYrhrnVM06CLLNSlpV4n2tQTxiTSV038v39Ldfr9Qk6v1zlojifL7rfyu0G3KRtW/oHy+VSkiSR7TaU9XolYRjKZrORNE31olLyvJCiKDkuikIOh4NeVnN8Op00+IXA2v0uEnzM5wyY57kySzVlz02MjQYF2yzLeAH8kBGCWWs1K89zmBtj5KYsydBaxw3v1Wrqx+ORTAZbVRXXEQCHMS/LQ8f2WKtfxfW2vUvw/j7lzc5ZZdQxqOujBvB6COnmtNaCqSGzPPdSaTDvHP1ABOdbzTl4GS3lY7GX0ftGpvOtTGahvLz9lLfpmhgpXsdL+TFZyWQeylj34fs6XtE+ozzUGvB1KtuvvXztYgm3O0UkSWplH6USKbAO7BTbr4jAPI6N2kSfXExg7aKvIAjDDVNAPYrcU83L+cy0GxWnqrpa1gqkjvpxr6m7dR2jhvC7I+XZbKY1TFkbKOVUIDg61wkFhTEGoDT8IMCgMKzDWfWjKIvFgkIMh62Om6ZhABzGC4DFRZ4CDCJ08G4Y+06Uz89PBoIjlMTBqk8B6QO4oGNtH0EZ5ElhzBlwPp8xFSzgMWdkWEupz6XouwMBUTuUBPtWCZjMkAiAdYApb9Zr0sVBiIMH3LVW/mg3BMO7w5htSPsELVeOhw2G4/FIn0fEm6JoT4HgFMexjuPeJg8gmzT9c9z5kCGeDVuqLCgMWLFT0KO4ue/V3/gPw+l0IrFGhyDdTd0vg9sNGfQfRF8nk3UtONSN6/AbaogvC4LgJqgFRlCU76xXNO+ZDij+mFN5tQ+GURTztpSfQ8bgrNFT3Qa2KZn142EdfmrJEEXH74yn0bXU6fFhovVom+bfgJ9atN4vRkDkIouePKcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1457b24c4c4f8accce704bebb69e8587/8ac56/image-45.webp 240w,
/static/1457b24c4c4f8accce704bebb69e8587/4424c/image-45.webp 470w&quot;
              sizes=&quot;(max-width: 470px) 100vw, 470px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1457b24c4c4f8accce704bebb69e8587/8ff5a/image-45.png 240w,
/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png 470w&quot;
            sizes=&quot;(max-width: 470px) 100vw, 470px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png&quot;
            alt=&quot;image-45.png&quot;
            title=&quot;image-45.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドでプログラムの実行を再開したところ、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の処理が終了した後にもう一度&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数が呼び出され、本来一度しか表示されないはずの&lt;code class=&quot;language-text&quot;&gt;Call ret_func&lt;/code&gt;というテキストが2回出力されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAAAtUlEQVQoz7WTWwqDMBBFJxHsjxAfGIkg/qjVbqIP0JKswLr/fdzGtKUUCgW1H4dJCDlMuBM6nS/ougPatkXT7FHXNcqyhFIKeZ7b+puiKJAkCcbxBlL20s73QUSr6fsrKI5jt2GMW9giPM9zjmE4goQQqzvjnLtqdA8Kw3AzodZma6H+gzCKomcobLHwFYox9slBEGwyMo+UB1BVVW4opZRI0/Qr81mWZR9I+V7Pn2BubJom3AHwb93Jg1cUsQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2e8be04956866299fe714ccb045afd39/8ac56/image-46.webp 240w,
/static/2e8be04956866299fe714ccb045afd39/d3be9/image-46.webp 480w,
/static/2e8be04956866299fe714ccb045afd39/b0a15/image-46.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2e8be04956866299fe714ccb045afd39/8ff5a/image-46.png 240w,
/static/2e8be04956866299fe714ccb045afd39/e85cb/image-46.png 480w,
/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png&quot;
            alt=&quot;image-46.png&quot;
            title=&quot;image-46.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgでメモリの情報を参照したり改ざんしたりする方法について紹介しました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-008-time-travel-debugging</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-008-time-travel-debugging</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;今回は、UWP版のWinDbg Previewから利用可能になった Time Travel Debugging 機能の公式チュートリアルを試していきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#time-travel-debugging-%E3%81%A8%E3%81%AF&quot;&gt;Time Travel Debugging とは&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot;&gt;TTDで作成されるファイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8&quot;&gt;TTDでできないこと&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99&quot;&gt;チュートリアル：サンプルプログラムの準備&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B&quot;&gt;ttd_sample.exe をTTDでトレースする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;TTDでトラブルシューティングを行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot;&gt;シンボルファイルを読み込む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;トレースファイルから例外を確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;TTDトレース内のイベント一覧を確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;例外の詳細を取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B&quot;&gt;例外が発生したタイミングにジャンプする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#step-into-back&quot;&gt;Step Into Back!!!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot;&gt;BSPの指すアドレスのメモリデータを参照する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;補足：ESPとEBPについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;問題の原因箇所を特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot;&gt;GetCppConGreetingPwy関数のデバッグ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;time-travel-debugging-とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#time-travel-debugging-%E3%81%A8%E3%81%AF&quot; aria-label=&quot;time travel debugging とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Time Travel Debugging とは&lt;/h2&gt;
&lt;p&gt;Time Travel Debugging(TTD) 機能を使用することで、ユーザは実行中のプロセスの挙動を記録して、あとで「前後に」再生することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-overview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - 概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;TTDを利用した場合、以下の利点があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ライブデバッグとは異なり、問題が発生したタイミングに「巻き戻し」て解析を行うことができる&lt;/li&gt;
&lt;li&gt;TTDのトレースファイルを共有することで、問題再現時の情報の共有が容易になる&lt;/li&gt;
&lt;li&gt;クラッシュダンプと異なり、問題の原因となるコード実行時の情報を含む&lt;/li&gt;
&lt;li&gt;統合言語クエリ（LINQ）を用いてトレースに対してクエリを実行できる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一方で、TTDの記録には大きなオーバーヘッドが必要になり、数分程度の記録でもGB単位の容量になる場合があります。&lt;/p&gt;
&lt;p&gt;TTD機能はWinDbg Previewで利用可能な機能ですが、VisualStudioでも同様に利用することが可能なようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://devblogs.microsoft.com/visualstudio/introducing-time-travel-debugging-for-visual-studio-enterprise-2019/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Introducing Time Travel Debugging for Visual Studio Enterprise 2019 - Visual Studio Blog&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ttdで作成されるファイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; aria-label=&quot;ttdで作成されるファイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDで作成されるファイル&lt;/h3&gt;
&lt;p&gt;トレース時には、通常以下の3つのファイルが作成されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;.idx ファイル：トレース情報にアクセスするためのインデックス&lt;/li&gt;
&lt;li&gt;.run ファイル：コードの実行が保存されるファイル&lt;/li&gt;
&lt;li&gt;.out ファイル：TTD実行時の情報が出力されるファイル&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に.idx ファイルと.run ファイルは、トレースに要する時間によって非常に大きなサイズになる場合があります。&lt;/p&gt;
&lt;h3 id=&quot;ttdでできないこと&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8&quot; aria-label=&quot;ttdでできないこと permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDでできないこと&lt;/h3&gt;
&lt;p&gt;本記事執筆時点（2021/10/17）のWinDbg Previewで行うTTDでは、以下の3点については実現していない点に注意が必要です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;カーネルモードプロセスのトレース&lt;/li&gt;
&lt;li&gt;TTD再生時のメモリ書き込み&lt;/li&gt;
&lt;li&gt;Protected Process Light（PPL）で保護されたプロセスのトレース&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に、TTDトレースは読み取り専用となるため、条件分岐のタイミングにブレークポイントを設定して、レジスタを書き換えて任意のアドレスに分岐させるといった、ライブデバッグでよく行われる手法はTTDでは使用できません。&lt;/p&gt;
&lt;h2 id=&quot;チュートリアルサンプルプログラムの準備&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99&quot; aria-label=&quot;チュートリアルサンプルプログラムの準備 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;チュートリアル：サンプルプログラムの準備&lt;/h2&gt;
&lt;p&gt;それではここから、TTDの公式チュートリアルを実践していきたいと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回使用した環境は以下の通り。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WIndows 10 Pro 20H2&lt;/li&gt;
&lt;li&gt;WInDbg Preview 1.2106.26002.0（管理者権限で起動）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;サンプルプログラムについては、VisualStudioではなくllvm-mingwでクロスコンパイルしたものを使用していきます。&lt;/p&gt;
&lt;p&gt;サンプルプログラムのソースコードと、コンパイル環境については以下の記事にまとめています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回使用したサンプルプログラムは以下のようなコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;array&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;cstring&gt;&lt;/span&gt; &lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size_t size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; L&lt;span class=&quot;token string&quot;&gt;&quot;HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wcscpy_s&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    std&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;array&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;%ls\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;公式チュートリアルのソースコードを参考に作成した実行ファイル（ttd_sample.exe）をPowerShellから実行したところ、何らかの理由でプログラムが異常終了します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAADQUlEQVQ4y4WUW2yTZRjH366OnUC2MWVAt7Gta8vafS3tECMsw61lhe5b23U9jIUyDsNkJgaHazw1mRAWTBYTJMELiN6YKImJN0YIN94ZQ4zRO6PRRIyJso2DFg9E8/Pp1+rqhnDxy/vm+573//3f5/Cpx5NZfP4U24JpvLvH0PqSuPvjQoKt8tzrH8UbGMUX2IenP4W2K2nQ1ZvE1Zug68kUrp1Rnth/msCJqyj73gzrtBQbto3T2J2m3j1KgydGnRZlrStGtSNBzZY4a5wpyjuiqNYQqm1wifYwytKPO5IhdOpTVPPuZ1Gb5IU1LgExCRgR4gWsy+gQbIkS4pjsKVRLCKc+zdDsZxK397ioDmK2JzDZRjB1/BdVpHS/REzOiHBLEE84w+jcF/KR0HOopkHK7PF7HHgQIihGVHMQX3Sa9Gufo7bopYKxEh4sVupQ048Tnb2aF5y+r8MyydP/YaTFENyDMzRF6MTHqE79Ple2iouWiBBeRqSAdbhwZXHo1qeIzX6CcoXFoeUegiK2qjNJU88RmnsnaOk9apDfN/VMYJHnFc5kofLi0DU4xZ7sRyiP9M9yQXN+b9HZmXiRr765xpdff8+31+b57odFYYEf528xv3iTHfHnpeV0zLYodR091Nr8UuXglFRJXym4MUQgPUMu9xs/Xb/Bwo2fub5wi0VZc7k7wF/0jWWNuHJHnMr6VkwVDaj6HU9L9w9JcpeqbHYUBAfGZ+TcH9z9Pcefd3/9l5u3b/PLnRy79r1sxD3kGKGqoZ2yGgtqVVdapmJ4RWVVc5jOgWd48+JlLrxzifPCBYPLnHrjPV45+y7WvkmjSGa7CP7j0CRJzbszpqSIyq8SpNpkdh8dWEljsEBbpHhmmJr1DsprN6Mq3QelbYbk2uKyNVpci8hsl8kHDaTfllOY+zwRVm/SqGr0oLShl6jzHWL99qdoeOwo67onqPcdodZ7mLVbD/Gw5yBr3OOs1sap0Q5QLSmqdqWpcu2n0lmgQv5IG7qTWPzSgpnXr3Bs7kMmT3/A4ZPvM5a9SCzzNvqxtwhMnqdn4hzbD5zBOzZHV+JVOmOz2CInaddn2BzK0hR8gY2BDI3+DI/0Zfgbc5BcoR3iOeEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a67b31f412fbc8448faa3c68f717a457/8ac56/image-28.webp 240w,
/static/a67b31f412fbc8448faa3c68f717a457/d3be9/image-28.webp 480w,
/static/a67b31f412fbc8448faa3c68f717a457/b0a15/image-28.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a67b31f412fbc8448faa3c68f717a457/8ff5a/image-28.png 240w,
/static/a67b31f412fbc8448faa3c68f717a457/e85cb/image-28.png 480w,
/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この異常終了の原因をTTDを用いて特定していくのが、このチュートリアルのシナリオになります。&lt;/p&gt;
&lt;h2 id=&quot;ttd_sampleexe-をttdでトレースする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttd_sampleexe をttdでトレースする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ttd_sample.exe をTTDでトレースする&lt;/h2&gt;
&lt;p&gt;まずはWindowsストアからダウンロードしたWinDbg Previewを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;次に、右上の[ファイル]から、以下の画像のように[Launch executable(advanced)]を選択します。&lt;/p&gt;
&lt;p&gt;ここから、デバッグ対象のバイナリを実行して、TTDトレースを取得することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABJUlEQVQoz4WSvU7DMBSFvTLyNgwVdOEReBMQbAy8AogCK++CRBGkElFbIVHi5seOf5I4LEyndtKgFtJkOLqSdfz53ntM9i5fcfzgQ6cMdBmC0iWklCiKYkt5nneq8ZH9Kw8nj3MowZCmHFpJ5JlGnCQQQvzCjTGdclDnJeR8jOH9FNOFxJP3ibdZjDnVFi7+XCp7ZOoOycULhnc+BOeYfXyBhgxc5mCMVS+WZdnbnVPjI+RsjKPRBEZGCKNoPXIGZatWqnd3TkkS290zhKGogYObCTIeI+Fp1ZnS2hqLf8HskrZ+N41SugYeXHsI6AJBQKsg3KuZ7bJJd7NuJ7953uzw9BmD23c7nqiS1RbUBmz7Rm1fqgIejnz8fBsLqU3ZGtoF3KUVxheS6t47uDkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/8ac56/image-29.webp 240w,
/static/29a630fa24b406d2131da2f51a2b8d6c/d3be9/image-29.webp 480w,
/static/29a630fa24b406d2131da2f51a2b8d6c/b0a15/image-29.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/8ff5a/image-29.png 240w,
/static/29a630fa24b406d2131da2f51a2b8d6c/e85cb/image-29.png 480w,
/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png&quot;
            alt=&quot;image-29.png&quot;
            title=&quot;image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回は、[Executable]の欄に、先ほどコンパイルした&lt;code class=&quot;language-text&quot;&gt;ttd_sample.exe&lt;/code&gt;の絶対パスを入力しています。&lt;/p&gt;
&lt;p&gt;また、右下の[Record with Time Travel Debugging]のチェックを有効化します。&lt;/p&gt;
&lt;p&gt;あとの項目については、今回はデフォルトのままで問題ないので[Record]ボタンをクリックします。&lt;/p&gt;
&lt;p&gt;[Configure location]ウィンドウでは、トレースファイルの保存先を設定できます。
任意のフォルダを選択して[Record]ボタンをクリックしてください。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 527px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz6WSu0/DMBDG+//viAmJgY0ZgcTAipAYoeHROLZju3k/G9om6sc5oSWIQpEYfrqzcz5/98WTIs+R76Eoij8zPjOxSVVVKMvyx8JDjOsnNuGcw/M8aKWgPjDGIIoihGF4EFtvaweFWYaHxyk8LhAFEeI4gdFzpEmGtu2wWq2/0a5bdF2Hjr5vNhsEQQApZT/lJEkSusEQczBP0gdDN9XUMEfyQZqWyLKBPC8RBikJMBByDi4Cmk59bSilJhRmM7eHk1opJJSv4Ps+XVCiaRrU9QLL5Rvu7qc4OrnA2fkNjk+vcHl9SxbpYeQ4ick7A+ZyPDkvcF2PmnrwGO9hrqA9iozijPV7dj11XnsYqRNCjxXGpMLQokFV1igLy4Ko+tG3e9ZTrTX5a3qfE0IrTXlK5zU1FUPDNE1JEQMn/wSXNO4Qx7mNg3KXIttZY2Gk2HGePxXaue1fUqMnsw+r7jessN3Dtp3/y/ZhvwPQ6DVs85U7BgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/8ac56/image-30.webp 240w,
/static/19c7d77f0173fa84d4f0a31389cda00b/d3be9/image-30.webp 480w,
/static/19c7d77f0173fa84d4f0a31389cda00b/042cc/image-30.webp 527w&quot;
              sizes=&quot;(max-width: 527px) 100vw, 527px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/8ff5a/image-30.png 240w,
/static/19c7d77f0173fa84d4f0a31389cda00b/e85cb/image-30.png 480w,
/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png 527w&quot;
            sizes=&quot;(max-width: 527px) 100vw, 527px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png&quot;
            alt=&quot;画像に alt 属性が指定されていません。ファイル名: image-30.png&quot;
            title=&quot;画像に alt 属性が指定されていません。ファイル名: image-30.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションが実行され、障害が再現されました。この時点でTTDトレースが取得されているため、[プログラムの終了]をクリックしてアプリケーションを終了します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACrUlEQVQ4y41SS08aURQeH6mhC3cSFxqjaSiRxFXdl/7JpsvSBbY/QJsuuqkoVoOCwMDAwAwDzDDDPEB88vh6zqXVtjHRm/lyTs6c+93vPKRvGRWO48Jsd9BqW2ibDBst00GxbkM3XXRsF07XR+D34fs9XFxcYjC4EvYPLi+v0ek4kA7SGbyNx7G5GcPW1hZisZjwo4SNSAyvIlFEIhG8jkaxvr6BePwdPW6TiACe10cQDOCTZTSbFqQf+yksLi5CkqRnIRwOQy5VUdfa0A0TDcNCl9Tz6boepGw2i+XlZZE8OzuLmZmZf8Axxvz8vMhZXV1FLneOWq2OalVFuazApDbx8fwA0unZGZaWwiKZCZ5SuLKyAlmWYRiGgKZpsDv2lNAjwnQ6fa+QVczNzQmwKrYLCy8ICwiFQvcK8/k86vU6VFVFpVJBu91+IDw8OEToZehRNW+2t3F8cor91BFy5wXs7e1hbW0NSrlM6prQdZ1Kr9F0Ow+EhUIRiUQCHxOf8HlnB8lkEjtk37//gN3dr7QSAzQtF11KZiXJ5BeUlRpqag2NRkOo7FjWw1C4qa7bxcVggH6f14DXwRcwGgYURUEuLyOTOYVclMUwstm8IOL+Valk0zSnhF0irNAFXavTGmh0uSIaLpdKUCixVCyKeKVaRbGQpxKnBBr1T9d0UmiIsm37r6GoNHqTSuFyuC9cBoN9vthsUkz4GlqtFkpyCSV6kBUyuAKO3xNWSJVldUiui17Qo40PqGwunXx/6nvUG88N6H8fFu0cD8FxHHGHbUB5o9EIJvFIrufh+uYWw+EI48kEo/FE2Kk/Jgvc3N7hbjjEWPwD6Jvit89xtj71XxrdXuPpM8Fzzs3VANL38waO9R5+asGjONZ6SKseUootcFTzROz/vJNGH6migV/NBKZqnNlXpwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4b165877ec22631875e1dc785be8a9b9/8ac56/image-31.webp 240w,
/static/4b165877ec22631875e1dc785be8a9b9/d3be9/image-31.webp 480w,
/static/4b165877ec22631875e1dc785be8a9b9/b0a15/image-31.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4b165877ec22631875e1dc785be8a9b9/8ff5a/image-31.png 240w,
/static/4b165877ec22631875e1dc785be8a9b9/e85cb/image-31.png 480w,
/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png&quot;
            alt=&quot;image-31.png&quot;
            title=&quot;image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションが終了すると、自動的にTTDトレースが開始され、Timelinesの位置が先頭の状態で開始されます。&lt;/p&gt;
&lt;p&gt;ここから、いよいよTTDを用いたトラブルシューティングを開始します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACOElEQVQ4y41S2ZLaMBD0//9NKqmw+wd5ILA2vi+MMT7lQ+ZYKI7OjGDZ4i2q6tI16umekTb5Y8KOM+RFiSwvsd7kaNoOXS9p7tGI7glB+yhewwsShPQmWRVI0oLuetxuN+x2B2iOMYc+/4vpdArLMhEEPsyFAduyEEURijxHWZYQTQM5SIRBCN93sVqtCEQchaiqCjw+P0/QFgsTjuvCtGzYtkckMTzPI+IAOZG1oiW1PbquQ98P6j4MAyJLsV6vsVwuUdf1N6FHZHzIARuyW1U12lZASqlIGMMwEFmvzgJSGJKLJEnUuzAMlYMnYUQHLJ8v2CKDA1kdW+FgBq852f0+VurSNEUcx0+Fh8ORamg7yLJMBbBKzqzIHiS8LopCkeZ5QfULlGVOyrEBCeF7HuM4QvuYz2EYBhaLBXyqmwoKAqWY10pdzWVoH5YDROE9Lk1XSnH5aIoiNHQdOmE2m1NjLDiOC/1Dh2ma9Gil7AghVF25nvfS3JNxqVjpV5eVZZbMdjv6Y3JgDNhtR4XtKLGjrPv9HtvdnhRs4VITPddBTN1mdb7vq7Lcm0KEaUiZxB7uZoBH8HMJj8F7mh2ak4I/+gi5PZB9gaZhxZ2CEPwLJE6nM/0ECa2lzmXdDlElEddM2CIqByybEXHRq/WmGZS68+WKy/WGyw2voLMzLQ5H+jbAGd/jSjgSLngdV/zfuEL7Mcvw5ghMbIE3htMq8H7y2P82a/w0SvwivNnNI0a84J3O3q0K/wBQasHtOBOkhwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4848fb3a587368a95aca2e693ab84c50/8ac56/image-32.webp 240w,
/static/4848fb3a587368a95aca2e693ab84c50/d3be9/image-32.webp 480w,
/static/4848fb3a587368a95aca2e693ab84c50/b0a15/image-32.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4848fb3a587368a95aca2e693ab84c50/8ff5a/image-32.png 240w,
/static/4848fb3a587368a95aca2e693ab84c50/e85cb/image-32.png 480w,
/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png&quot;
            alt=&quot;image-32.png&quot;
            title=&quot;image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このままTTD解析を行うこともできますが、せっかくなので保存されたトレースファイルを開いて解析を行いましょう。&lt;/p&gt;
&lt;p&gt;一度WinDbgを閉じたあと、再度管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;先ほどと同じく[ファイル]の一覧から、今度は[Open trace file]を選択して、作成された.runファイルを開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAACFklEQVQoz5WSXU/SURjA/+uGlWhs0OJtAiLGkv68hay2Xr5Fn6SWa90gMt7a3KqLtm4s1PoONu+8MDNzuSlSICAITOpKQTd+/c9xMXXddLbfnnOe7fntOec5ysM333k0t0OtecDvX20ODtq022263S7/u05OTlCuxta5/WqTfLHMXrXC7m6ZVrPF2tpXUqkUmWyWrEY6nZbns4icIJPJMDU1xdLSEoru+RfCLzfZrrZo7Nep1ev0ej1mZ2fR6XSYLTYMBgMDAwPo9XqGhoZkHBwclIizyWTi8hU9sXgC5dKzVTwvNijVmlRKRfL5bTpHh8wvLGB3ewkFAzy4f49IJEIgECAajTIxMUFEoOXC4TBer5frZrPWaRZFefqZkfQGhfIehZ9lCqUqh8c93uXm8Y6Po6q3uHsnKgtVVSUYDBIKhfrR7/fj8XgwGo3yGRTl8QouTbier7C2VWd1q0ax1eH12xxmq4WxsTGGhx1YrVbsdrvEZrP19wKXyyWvfSp8soIz/Y2dwg9ajTpVbTDH3SPmP3zkmt3JDU3oHh3F6XTKwn/hdrulUAxICl2acHUrr025SkVDDOV9bo6RmyoupwOHwyGFFxGyv/GcUHS4Xdmn2dinVjudci6Xw2KxyIJRrUPRhRBfROR9Pp98knPCsx+70+mwvLzM5OQk09PTkng8TiwW6yP+nYjJZJKZmRkSiQSfFhf5A3Qe4rocuYGSAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/8ac56/image-33.webp 240w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/d3be9/image-33.webp 480w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/8ff5a/image-33.png 240w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/e85cb/image-33.png 480w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png&quot;
            alt=&quot;image-33.png&quot;
            title=&quot;image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでトレースファイルがWinDbgに読み込まれ、解析ができるようになりました。&lt;/p&gt;
&lt;h2 id=&quot;ttdでトラブルシューティングを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;ttdでトラブルシューティングを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDでトラブルシューティングを行う&lt;/h2&gt;
&lt;p&gt;ここからは、取得したトレースファイルを解析して、トラブルシューティングを行います。&lt;/p&gt;
&lt;h3 id=&quot;シンボルファイルを読み込む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot; aria-label=&quot;シンボルファイルを読み込む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイルを読み込む&lt;/h3&gt;
&lt;p&gt;公式チュートリアルでは、まず初めにシンボルファイルのパスをWinDbgに読み込ませていきます。&lt;/p&gt;
&lt;p&gt;僕の環境では、デスクトップに&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.pdb&lt;/code&gt;を配置しているため、&lt;code class=&quot;language-text&quot;&gt;.sympath+ &amp;lt;デスクトップのパス&gt;&lt;/code&gt;としてます。
シンボルファイルのパスを追加した後は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\Desktop
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが適切に読み込まれている場合、以下の画像のように&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.exe&lt;/code&gt;の関数名などをWinDbgが解釈して表示することができるようになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 539px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADkklEQVQ4y21UiW6jWBDk//9mZ7UrRUqU7EwOx45PfHCDAZvDJxhiJz5qq18mGa1mkdpgHl3dXV3dWrEtkOc5Xl9fsVgsUNU15LpcLjifz/8x4JddLuffzsW0IAgwGAwwm81QlqUCXi6XWK3WqKoKu93up5XIsp2yPN/xvFTvfp3vlL9mTCZoNBrwPA+O42A4HKLf76HT6cK2HQS+rwLGcYjmc4nv3wvc3BTo9XcMnMAwLFiWzYTm2Gw20EajER4fHzEhcPulRYcfeHl5wdNTg8B9BXZ3e8eADlrNCn98K9EgcK+3IJBBnzZ9DSRJgu12C63b6eD6+hq6rjODZ0a/wf39PW5vb9Fut+nYw9XVFZ1NOtf46++SAUvEUYRnft/hN1JdURRYr9fQTMNAs9mCZVrMps/nJrrdHp3aDDKEPtTx8PBAJ5cAJb79ucVAL+C5FoP1VSJRFCuw1WoFbUiH+/sf5GLMMh/I5xMza+GJd5PcRMxEeE3SObN8Z3l71PUec3Lmeb7iPZyGqik1FaLN4nf4/js5OJP4EwGAeHYkySf8fh1/2v+dfVya6wRM3cAiL5Cma4JL5zyMJ56SjpThs9MbEj4e5ex+zgoyeH5BiVWYzxOl3/1+/wF4PB75ImE5Q2bnYzYPWU4AP3AwnXpwXVt1eLnKGHRDHW6RL0pqUZqwUkMh+vsQPgHlJ0sPaLUyGJMNLPuV3B3ITcUm7RBGFcKwhmkeGOxAWg6s5IDT6cAM95CEPi+ZLgW4XKwx1C2MxjZ21TskWM5sWi2dTbAp4C05XvFespotMytRkAIpVZrxCfYFKCMkIo2ikLNc4eNdgdFIV/qT7h0O+y+T8RQT3uRMnr+a8vb2hjSZMcMBSRcAi9nMyJ/P8eqydFtJynYsxZnYar1gs2iceclyzZE7nc60E7QwzChkH1G8IlgK18l5jzAeh7QYjpvwjJMR1yy5oh4rSqomUM3O18ywYlN2ao7VLAsvvpcRJKAUBDBBEMxZ/pLdTTBlQNcVFUjWc0ooZdYJfWYIpjE1GyNjpwVMjZ7nuhyzZ2qxwwaMuRC6HKcBN42pOJR3ui4j1lN8yvsh/wsNos8so5xY+leGfc7j3d0//MBU2+WRW2Yw0NVzh4tDloNsH5lvnZtHZtwwTcgenU6najTTNFU8qlmWJshWkWi2bXPwdbXfXNeh9kzVFFltnuup/67rKUcRtJgCY6mfC/ZfFrVyHSA5Wl0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/250917af9537b4cef03305202ba42a47/8ac56/image-36.webp 240w,
/static/250917af9537b4cef03305202ba42a47/d3be9/image-36.webp 480w,
/static/250917af9537b4cef03305202ba42a47/9cb26/image-36.webp 539w&quot;
              sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/250917af9537b4cef03305202ba42a47/8ff5a/image-36.png 240w,
/static/250917af9537b4cef03305202ba42a47/e85cb/image-36.png 480w,
/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png 539w&quot;
            sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png&quot;
            alt=&quot;image-36.png&quot;
            title=&quot;image-36.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;シンボルファイルの読み込みまで完了したら、いよいよ解析を始めていきます。&lt;/p&gt;
&lt;h3 id=&quot;トレースファイルから例外を確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;トレースファイルから例外を確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トレースファイルから例外を確認する&lt;/h3&gt;
&lt;p&gt;トレースファイルを開くと、次のように&lt;code class=&quot;language-text&quot;&gt;code 80000003&lt;/code&gt;例外が発生したことがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;19e0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1f9c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first/second chance not available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Time Travel Position: D:0 &lt;span class=&quot;token namespace&quot;&gt;[Unindexed]&lt;/span&gt; Index
&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;index
Indexed 2/2 keyframes
Successfully created the index in 362ms&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、ここに表示されている&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;は、TTDトレースの位置を表しています。（ポジションの情報は、実行環境によって変わる場合があります。）&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!ttdexe.tt &amp;lt;Time Travel Position&gt;&lt;/code&gt;のようなコマンドを実行することで、任意のトレースポイントにジャンプすることもできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-extension-tt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;タイムトラベルデバッグ拡張機能! tt コマンド - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ttdext&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tt D:0
Setting position: D:0
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;19e0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1f9c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first/second chance not available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Time Travel Position: D:0
ntdll!LdrInitializeThunk:
00007ffd`f1944b00 4053            push    rbx&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ttdトレース内のイベント一覧を確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttdトレース内のイベント一覧を確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレース内のイベント一覧を確認する&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;dx -r1 @$curprocess.TTD.Events&lt;/code&gt;を呼び出して、TTDトレースの中で発生したイベントの一覧を取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-event-objects&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;TTD イベントオブジェクト - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下の出力を見ると、プログラムの実行時に各種モジュールがロードされた後にスレッドが立ち上がり、例外が発生したためスレッドを停止して、各モジュールをアンロードしてプロセス終了した一連の流れを確認できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events                
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ttd_tutorial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe Loaded at position: 2:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module TTDRecordCPU&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 3:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module apphelp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 4:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNELBASE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 5:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ucrtbase&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 6:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x5&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNEL32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL Loaded at position: 7:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x6&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 8:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x7&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Thread UID:   2 TID: 0x1F9C created at D:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x9&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Thread UID:   2 TID: 0x1F9C terminated at 96:1
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xa&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module apphelp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xb&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module TTDRecordCPU&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xc&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ttd_tutorial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xd&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNEL32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xe&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNELBASE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xf&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x10&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           : Module ucrtbase&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;例外の詳細を取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;例外の詳細を取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;例外の詳細を取得する&lt;/h3&gt;
&lt;p&gt;例外のイベントをクリックして詳細を表示したところ、例外発生時の&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;7C:0&lt;/code&gt;であることがわかりました。（ポジションは実行環境によって変わる可能性があります。）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;                 : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;             : Exception
    Position         : 7C:0 &lt;span class=&quot;token namespace&quot;&gt;[Time Travel]&lt;/span&gt;
    Exception        : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、子要素の[Exception]を選択することで、さらに詳細な例外の情報も取得することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Exception
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Exception                 : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    Position         : 7C:0 &lt;span class=&quot;token namespace&quot;&gt;[Time Travel]&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;             : Hardware
    ProgramCounter   : 0x52005400200045
    Code             : 0xc0000005
    Flags            : 0x0
    RecordAddress    : 0x0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;例外が発生したタイミングにジャンプする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;例外が発生したタイミングにジャンプする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;例外が発生したタイミングにジャンプする&lt;/h3&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;7C:0 [Time Travel]&lt;/code&gt;をクリックして、例外が発生した位置にジャンプします。&lt;/p&gt;
&lt;p&gt;画面下部の[Timelines]のカーソルの位置が進みました。&lt;/p&gt;
&lt;p&gt;TTDでは、現在の&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;でトレースされたメモリやレジスタの情報を参照することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACEklEQVQ4y42T6Y6bQBCEef83SqLdfYD8sr0cNubwcuMZrsGcxpWesUUix5EyUqlhYD6qq4X27SeDHZxhWRY2Ox26YeGTFMYpeFkhZwV4UaHreozjiCTJIMQF1+sV8zyTrpimGctyQ0Xva/5RoKBDpqFjt9thu91A13X4nocwDFEUBdr2gtttoUMLXNqfpgmvlmgENNOskGaMHBowCGoYJkzTUI5t+wjGmHIkYRKU52eC3/6SXE3TQHPcDlF0wemUI05KVFWpIJzz1V3bduqQBDLGV8BzVUDDzMlJhu3mBNNKFYTToSzLlKQjIVrlUObmuB6GYXgJlDlrvu9QLgdq8ZMy8xHFAcLoi0AZfbFGSUELIVag55/UcF4B+2GCZh8dmuweB9snYIAgOBGUgOec2heqjYbClu1KoEvA4V/AfoQWhIwyLOB5CTnjSFKGsqpQNy3VTrUhHUpXK3D4DfxzKA+gdEVtBiHSNEYch6SYcqTs6pJUoSWghMm2j467tvy8FDD9ihDyFnZSw0kbuJlYZScN9nGNIOVq2pdLhzPjaup9P9B9Tx3c6zhOlHcNTfASUdnimNaw0wpmxHCISzhZjT1FsafrtBCYyeEo/wjqbpoXjPP9fnrUmR70FIV2N3t7aAaWjqr8E5bHHu77/7UWaN+NHG97jrdDgXfSh12q+vbQ+6HED5Ph/h5bnz9L7n9YOX4Bc+/a8n94GSYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/8ac56/image-34.webp 240w,
/static/8e3bc7f6f574ab989430b7790e7ea787/d3be9/image-34.webp 480w,
/static/8e3bc7f6f574ab989430b7790e7ea787/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/8ff5a/image-34.png 240w,
/static/8e3bc7f6f574ab989430b7790e7ea787/e85cb/image-34.png 480w,
/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png&quot;
            alt=&quot;image-34.png&quot;
            title=&quot;image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;WinDbgでは、&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;コマンドでレジスタの情報を参照できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Time Travel Position: 7C:0
0:000&gt; r
rax=0000000000000000 rbx=0000000000000001 rcx=00000000ffffffff
rdx=00007ffdef6e0980 rsi=000002b36fa33520 rdi=000000000000002c
rip=0052005400200045 rsp=000000b936effb20 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=004d004900540020
 r8=000000b936efde98  r9=000002b36fa3899c r10=0000000000000000
r11=000000b936eff980 r12=0000000000000000 r13=0000000000000000
r14=000002b36fa2d110 r15=0000000000000001
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
00520054`00200045 ??              ???&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のように、&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値が大きく異なる場合、何らかの理由でスタックが破壊されている可能性があります。&lt;/p&gt;
&lt;h3 id=&quot;step-into-back&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#step-into-back&quot; aria-label=&quot;step into back permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Step Into Back!!!&lt;/h3&gt;
&lt;p&gt;ここから、スタックが破壊されたタイミングを特定するために、時間を戻します。&lt;/p&gt;
&lt;p&gt;画面の通り[Step Into Back]ボタンをクリックすることで、1つずつトレース位置を戻すことができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 852px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 120%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAAD3UlEQVQ4y4VU2ZLiRhDUj/vZz/4F+wP8YIftxTG7MTjwBnMxMAgY0AFCAh3oPkAtIF3VGJZd76wVkVF9qTq7KquU7290vB+pWFpraJoF/VXDjK3lQJtpWK0CrBwXI9PFfG7jaWLjlweyeoil48N2Q1i2j2CTIIpSKNt4A3OuwppbmP35AeMff4LR/huG4UCfGlivfXhrD+3+HFNjifHMwu2Thle6oMpzpHGKPMnIJnKs/PBhge9+1fBedREFdOvSheN48OhG14/hBTH8IMHKC+HTWhxniMIIMbEJwhQbshuyYZTBpTNKV9Xw7uMzPvaG0BdLPA5U9IZjjKY6XsZTdLr36Nw9IspKiCNQicNXsMe2OSKIcyj2wqSnTWDqGqzFHCN1iOfnHkzTJCYbiqED3/cgRI2mETjsG7z1bbc7KJqmwVmt6Kk2gmCDNM3oCRtkFJ9qu0VdC3lYCEHPjZEXBfaHAznfY78/QY4PexRFBWU8HkPXdXJoIQwLZJmgmypUVYXdbkfj7WVcE8u6ruUaz884z7OsgGIYBhYLC5a1oIxG9DPo1gYN3Xw8Hi84MWkurL7E4czw5eUFzHIymcC2bWK6BF9iOw5dsCbtzeU4SVL6oUBOofgaeC8h+SicgHa7jW63i8FggNvbW5r/hfv7B7nWarVwc3NDlzkU35TEG1FoQmnPCEO2IdkYypAYPj4+ot/vg9ne3d2h0+nIMbObzWYy455PAvc8yrgvk3Pt8JPjhBySTDjT/GROjue68un8cxAEkk1ZltKJQ0/ndWaaJMlnSNN/S09VVUynM4qbDnvp0+YOZfEpLtdxO4+zLPsPeJ2r6CIbxnpN5RfFcInlmR0zY0bMkuXzFlg6aUqyYUf9/gCj0VhqkRPD8dM0HRO6jBPz1OvJn/7vK8stFNM0KH6vUirWYiGd9ciBYZgyXpyQOa1zWZEcSW+Hz/R5Bn9S2PO5SfW6ImFbMuicLXaUJLFkxWLm70iOkjj+JtM8o+bgU6yCTUiyCOQNguqyqnYoyorqlmKzq6mmubxqKi8h54xaNIT9BaI5IOJ+OBlNqafliNJSWj/MLgi+mF9jExeEUtogKqh/pnDWAZTw4VkKcmBF+F310Rr5eHeF1hWu1/5QPfzcW8nxb0MXnakn5aNU1FlYlNyqkpzqMS8lUmkLaqwZ4jRHQuFIr/doviZGfCYtSkRUx9zqFG5H3OsE2UbUspHKZkqbO7GFm6yxoTjneUb7p3Pick5cGm9ZVqcGyzKQoNSfJcGZPR0W5KQ5zRtOgpD98Pr8+Z/drpZQON3nXvcmRPPtfVIGP7eqtvgHh9kNveAdOTUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/8ac56/image-37-852x1024.webp 240w,
/static/12d497b36084dbe911d3bc61dcac5f79/d3be9/image-37-852x1024.webp 480w,
/static/12d497b36084dbe911d3bc61dcac5f79/39392/image-37-852x1024.webp 852w&quot;
              sizes=&quot;(max-width: 852px) 100vw, 852px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/8ff5a/image-37-852x1024.png 240w,
/static/12d497b36084dbe911d3bc61dcac5f79/e85cb/image-37-852x1024.png 480w,
/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png 852w&quot;
            sizes=&quot;(max-width: 852px) 100vw, 852px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png&quot;
            alt=&quot;image-37-852x1024.png&quot;
            title=&quot;image-37-852x1024.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Time Travel Position: 7B:17&lt;/code&gt;の時点では正常であった&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値が、&lt;code class=&quot;language-text&quot;&gt;Time Travel Position: 7B:18&lt;/code&gt;のタイミングで破損したことが推察できます。&lt;/p&gt;
&lt;h3 id=&quot;bspの指すアドレスのメモリデータを参照する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot; aria-label=&quot;bspの指すアドレスのメモリデータを参照する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;BSPの指すアドレスのメモリデータを参照する&lt;/h3&gt;
&lt;p&gt;スタックが破壊される直前にBSPが保持していたアドレス情報が、&lt;code class=&quot;language-text&quot;&gt;0xb936effb00&lt;/code&gt;であることが確認できました。&lt;/p&gt;
&lt;p&gt;次は、このBSPが示すメモリアドレスの情報を表示してみます。&lt;/p&gt;
&lt;p&gt;WinDbgの[View]から、memoryウィンドウを開き、アドレスバーに&lt;code class=&quot;language-text&quot;&gt;0xb936effb00&lt;/code&gt;を入力します。&lt;/p&gt;
&lt;p&gt;このとき、[Memory]タブの[Text]の設定項目を[none]から[ASCII]に変更することで、メモリデータ内の文字列を表示させることができるようになります。&lt;/p&gt;
&lt;p&gt;以下の画像のように、BSPの指すアドレスにはどうやら文字列が格納されていることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACCElEQVQoz4VSy5KbMBDk/78kp+yecs05lWzs2CCEhHhJgME2mIfBXh86I3krqcolh64eGM2rZ7wv33zwRGMnNLpzj+Pxibbt0XeDw+l4cTz043/hcV9ApkdseEGBE04ncgwzpnHGV1bj03eDl02Nz9uDw+uvBi//4HXX/oEnZYa6OsHoEhVx308YxxGPxwNcxGCRRFoYpNogozcWuqqRmwpJrsk+YJgXwhXX2zu8zc89OI8RhjHiOEOWlTg0LS6XC1jAEHEOFZNPSihl30j3LYRwti4KmmbEOAy43VZ4+32IPC+RZgZaH1DXJ0zTTM47FeKQ8hmUpin5C3qbOagkcVwaQ+8nzPNEMTd4PiXUukaWGxhTo2nPuF4XN3LAOFjIqVgBGSvEKoWQijp9spAxkiRDVTcoafTLQEsRUQ5Tnqlai5aW0nULJVyxrgv8gGO3Z5RUOAQsIpYftnD+SChKeISpGpJpoi2HtJT6grLs0DQjYSLHSCPMYCyksUMaW7jRrWaW7bfVUBKsDFa7dV3xfr/De3v7Qc7I6eX7e2dvtxuMpIsQ0gUqpRxiWoblLHtqaL+11liWxenoNAwZcz8LEt5y3/euuztVC4Lgo8Nn4iiKHNui1g5D5pLb7iweDzqbiO7sfO5ozIGqXOkGJ3Le3GHzSLgulUpoyzkF/0VKsAsxpnRXYWGX+RvmiiSvmi5QuAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9622b7e84612443b9124da99e3025e1e/8ac56/image-38-1024x568.webp 240w,
/static/9622b7e84612443b9124da99e3025e1e/d3be9/image-38-1024x568.webp 480w,
/static/9622b7e84612443b9124da99e3025e1e/e46b2/image-38-1024x568.webp 960w,
/static/9622b7e84612443b9124da99e3025e1e/a9a89/image-38-1024x568.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9622b7e84612443b9124da99e3025e1e/8ff5a/image-38-1024x568.png 240w,
/static/9622b7e84612443b9124da99e3025e1e/e85cb/image-38-1024x568.png 480w,
/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png 960w,
/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png&quot;
            alt=&quot;image-38-1024x568.png&quot;
            title=&quot;image-38-1024x568.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;補足espとebpについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;補足espとebpについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;補足：ESPとEBPについて&lt;/h3&gt;
&lt;p&gt;少しだけコンピュータの話に触れておきます。&lt;/p&gt;
&lt;p&gt;x64アーキテクチャなどのCPUで稼働するコンピュータ上で関数を呼び出す場合は、CALL命令が利用されます。&lt;/p&gt;
&lt;p&gt;CALL命令は、簡単に言うと以下の処理を実行する命令です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CALL命令の次の命令のアドレスをスタックに格納する（CALLする関数の処理がすべて完了したら、この時スタックしたアドレスが呼び出される）&lt;/li&gt;
&lt;li&gt;CALLする関数のメモリアドレスにジャンプする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/tobira-code/items/75d3034aed8bb9828981&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86-64プロセッサのスタックを理解する - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;詳しくは、こちらの記事にまとめていますので、良ければ参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;問題の原因箇所を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;問題の原因箇所を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;問題の原因箇所を特定する&lt;/h3&gt;
&lt;p&gt;ここで、先ほど確認したように、BSPレジスタの値が示すアドレスは文字列になっていました。&lt;/p&gt;
&lt;p&gt;今回のサンプルのようなプログラムの場合、BSPに格納されているアドレスは、main関数の処理が完了した後に呼び出される命令のアドレスとなることが想定されます。&lt;/p&gt;
&lt;p&gt;では、一体どこでスタックが破壊されたのか、それを特定していきましょう。&lt;/p&gt;
&lt;p&gt;次のコマンドでmain関数にブレークポイントを設定した状態で、[Go Back]ボタンを押して時間を巻き戻します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bu ttd_tutorial!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;するとmain関数の先頭で停止するので、BSPにメモリアドレスがプッシュされるまで[Step Into]で処理を進めます。&lt;/p&gt;
&lt;p&gt;BSPにアドレスがプッシュされた直後のメモリの情報を見ると、この時点ではまだ文字列ではなく、main関数実行後に呼び出される命令のアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACB0lEQVQoz12S65KaQBBGff/3yTtkk3+uArIoslkRBOQOw/WkZ0hlk7WqS2qgznyX3lmuz4sb8e01wo0asrzlI4pJ8oK6V3TjSDuMdDJ1q7gGN7zLO8GviFv4ILynxI8nYZSRpAU7y7IIrj5DnaN/VTnQxBVLMbNWCzT6UGaAdV05Hm32+wOn0xvOycWyHdw3jzTL6bqe3eH1wPlykdvu1E1H/uyIbzFZnDG20wbqV5DHeV5wnJOMg+9fOJ/PAj7Jv0dd14ziZnc8HgmCgPs9ZBgmilwJLCFPctq8QZU93bNlaAemacKybGzbNjDP83Bdl4sIKsoSpZQGOvLiKv6fYkncic2+GkHxOatJQxRigCdR+BVYCrDvjeXv8sFPotBlGp+U+Z0yDSTTB2OdyiSMncyQ0HcpOnNt83q9mqg0UIOLohCHgyg8/ODj3SJLpJg+pSpimuIm+aUogZlpZboHbfPYgCZD36jUeRqgKBxkE3a6sfMlIAwj2m4SyyuJFJI+CirJrpI1qstOzlux1WAdrf8y3IBvlFW1KdQ3avlheGNZ9Noo4iiiLEqWXg6GlXVe/2Q4C8zB0UCx+wn05MJqa/l1v5dQfdJUbKnRtFzd5WU6Mj/nbQfVVsqyrAZoW18VeqaUvwp9XysMZZdasrQxz1EcSwmKeVykrNmoU2owdp1/Wv4EbpZ/A82gNdfb8y55AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8df57812168816d1b3f7494929bc0953/8ac56/image-47-1024x578.webp 240w,
/static/8df57812168816d1b3f7494929bc0953/d3be9/image-47-1024x578.webp 480w,
/static/8df57812168816d1b3f7494929bc0953/e46b2/image-47-1024x578.webp 960w,
/static/8df57812168816d1b3f7494929bc0953/a9a89/image-47-1024x578.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8df57812168816d1b3f7494929bc0953/8ff5a/image-47-1024x578.png 240w,
/static/8df57812168816d1b3f7494929bc0953/e85cb/image-47-1024x578.png 480w,
/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png 960w,
/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png&quot;
            alt=&quot;image-47-1024x578.png&quot;
            title=&quot;image-47-1024x578.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;DisassemblyウインドウとMemoryウインドウを見比べながら何度か[Step Over]で処理を進めていくと、&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数を呼び出した直後にスタックが破壊されたことがわかりました。&lt;/p&gt;
&lt;p&gt;↓ スタック破壊前&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACIElEQVQoz1WTaW7bQAyFff+T9BztjwZF0Bi2tWu0WiNr3z3a7FfOJGkbAQQ5EOcjHykdPD/Cm5fh22sCM2lQ1R2uaYG0qNAOd4xixXhflHV0juIUYcTBKSfLa+RFg7JqKW5QNz0OhmkiuUYoeIjH/kQ/bvQyA89TtH2HuxAYpxFimSGfi2bgdNZg2a6KbYepOMsryhM46McTLEqIXQ8FVa/SkoyjzwuMZaV8X5QYyKa6gaETxLIQBD4s8q7rwHEcDMOAbdtwOP58wYns7fsPRLqFzL0iPGm4mQydl6ALyK7v1iYcmqbBNC14nqc8Yy5cxtC2LZZlwcGilmOeIU5SLDswjEBdDVilwie+PPIogbIzz2MENJVnzPsH1M4vYM5vBN4R21KiLTl1EmAuc6xlgaUg3xTYuxK7qGhu70ApWQI/JTdNg3VdCXj5BeYeYZuvmEVBwBuqyMfAOab0hpFkjhmHqDNsov6vQw+GaRDMpqXYqkMFNAwbUZTQlkra0oq+2zENAs8F2En2Nj+xrU/sD4q3J87nM3RDp7m5ytu2pQr8lXyhBFktikLa1B0Vze+Wc+R1jm1fv87w8cDlclEgRotQQIeA9gdwJaCcQxCGahZi3tB1ApxfkWQJxnGi7jZVeZ5n5TVNhyGBH0uR92zboXvdu2Rd1+H7PuI4hqC/oq5GNHVN8icqMKtvSyZKk1BdN9QSgiAgkK227LoMfd+rnD87SDCQKCF7DgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1e99b97d538901f0412fcb48be81cab8/8ac56/image-48.webp 240w,
/static/1e99b97d538901f0412fcb48be81cab8/d3be9/image-48.webp 480w,
/static/1e99b97d538901f0412fcb48be81cab8/b0a15/image-48.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1e99b97d538901f0412fcb48be81cab8/8ff5a/image-48.png 240w,
/static/1e99b97d538901f0412fcb48be81cab8/e85cb/image-48.png 480w,
/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png&quot;
            alt=&quot;image-48.png&quot;
            title=&quot;image-48.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;↓ スタック破壊後&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACHElEQVQoz22SaZKbMBCFff+D5CxxkrEr9gAS62AwZhMg9sXjl5bsSeVHVPWqkVB96uXtvCDEwUvx7UcEI6ogqhZRkuOaFhCyg+wnyG7UsSVdohs+wgRXupPlAmkmkBc1xQqlaLBjnCG5RuiqDHgA/XBH3dQQdUWAFuM00tlAcYJapslwOr3DdjxYjIPbLkyLI7llaGSLnXE44vzzDe7ZwM0PUUYZ8kuIJknR5QW6LEerlOboCwFmMXDGEAQBHNuG67lgtO+6Ftu2Ynf69QZ+OuO03yN2A4LluBgcmRuij0sMSYm+pKgkBEzD1FDP82ET0PM9HWUjMc8zdtz2EFJfLnGCjUruOqAtRmw91TeSnpX+XaZp6Yxcj0Ccw/efYCklJgU0zt/huUd4zgHrXECKG+Q1xCZyoBF4VCUeglST5oqApgaqkm2bw3GfJdd1jWVZFHBPsCMC/zeWuSRgChldMKUpFtKU3DDmCeY6xedSwbKeQFUqp4E6jqPPmqZ5AhmzyQoJsoyykxP92NCTTe4L8LnR4O+khzaAjoZhwDCNV2YWTdvWWSug7uH7+1n3IQh8jONMqQ9kgRhxFmNavhr4+KeHpga6/wMuBGSWRbAPuuDQCxtNa6JsUxTUu3Ecsa6rLkW9rr4tmrCpgK+hfIHVUJaVSrY0MEAcU0bTiqoaIMgeDV0YyNTbdifQ9tITyF/TVT5U9lF7SaZelhV/AGhmMLpFANVVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/8ac56/image-49.webp 240w,
/static/7e9f90fc440fcfb013fd35325207dfee/d3be9/image-49.webp 480w,
/static/7e9f90fc440fcfb013fd35325207dfee/b0a15/image-49.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/8ff5a/image-49.png 240w,
/static/7e9f90fc440fcfb013fd35325207dfee/e85cb/image-49.png 480w,
/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png&quot;
            alt=&quot;image-49.png&quot;
            title=&quot;image-49.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このことから、スタック破壊の原因は&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数に存在することが特定できました。&lt;/p&gt;
&lt;h3 id=&quot;getcppcongreetingpwy関数のデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;getcppcongreetingpwy関数のデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GetCppConGreetingPwy関数のデバッグ&lt;/h3&gt;
&lt;p&gt;TTDトレース内の時間を少し戻して、今度は&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数の処理を追ってみました。&lt;/p&gt;
&lt;p&gt;すると、&lt;code class=&quot;language-text&quot;&gt;wcscpy_s&lt;/code&gt;関数を呼び出した直後にスタックが破壊されたことがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB6ElEQVQoz3WSbZOTMBSF+///lB+ccRx1XVelQBK6QKAtS3gpaWiB0uNNqNVdx8ycuQTIk3Nys4rjBHm+g1INus44HQ4djOkxDCPGcXolme0Q8hjP8RYyf0GaFci2pVO+U1gFvg8pJS6XCXYYM2GeL/jf4FzAW/tgjEMIAUbzIAiw3xfOyMrzPNotpt1HAgFa2zq7xdfr9ZXsECJCGIYE5ogIuMwD1HVNiQashLA7cRTFHk3T0i4G4zQ4lwvkasmLaDDGyNECtA6jaEPvQlRVhdPphNV6HdDLBLZqPRDwgizb4jmVqOqWfprQ9wNpScApqoUuQO6AnOZ3YBA8IJUe4viJFhU4mgplSY5Lhrp9hj5mOHSpq0BHoJAiMmw2G2yi6B5ZKUXAMzn88h7rz++Q/PyIHX9EGfukJzSpB52HOGQ+ujxAR1VvGULfQ8h+x43AxdIU6/B8JuCPh2/wvn7H44dPkCyGkjXSdYS9kND0fMwb6BdS2cColoDBvSkWugD9P01h9CHLcyQyxTBdYPoZlapxNiNgb8+bGyTcNfkLyBdgVd2A9to465xhmmZ07UhRO8yKSDURFKl1x+fg4hbxX+Atsj3gJEndIWtt0DY96i1FLQ1O1Rmm6EkGpuwx9pMDhfcuizdnOOAXFtczjy08/3QAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/8ac56/image-50-1024x575.webp 240w,
/static/4d151361fce7650a5121ec8d9bf7f8af/d3be9/image-50-1024x575.webp 480w,
/static/4d151361fce7650a5121ec8d9bf7f8af/e46b2/image-50-1024x575.webp 960w,
/static/4d151361fce7650a5121ec8d9bf7f8af/a9a89/image-50-1024x575.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/8ff5a/image-50-1024x575.png 240w,
/static/4d151361fce7650a5121ec8d9bf7f8af/e85cb/image-50-1024x575.png 480w,
/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png 960w,
/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png&quot;
            alt=&quot;image-50-1024x575.png&quot;
            title=&quot;image-50-1024x575.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここまで特定できたところで、ソースコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;array&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;cstring&gt;&lt;/span&gt; &lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size_t size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; L&lt;span class=&quot;token string&quot;&gt;&quot;HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wcscpy_s&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    std&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;array&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;%ls\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;どうやらワイド文字列で50字分しか設定されていなかった配列&lt;code class=&quot;language-text&quot;&gt;greeting&lt;/code&gt;に対して、75文字の&lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt;を書き込んだことで、スタックオーバフローが発生したことが原因のようです。&lt;/p&gt;
&lt;p&gt;そこで配列&lt;code class=&quot;language-text&quot;&gt;greeting&lt;/code&gt;の要素数を75に修正した&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial_fixed.cpp&lt;/code&gt;を使用して&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial_fixed.exe&lt;/code&gt;を作成しました。&lt;/p&gt;
&lt;p&gt;これで無事にエラーが解消され、無事に実行に成功しました！&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ ttd_tutorial_fixed&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
HELLO &lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; THE WINDBG TEAM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;過去と未来の双方向にトレースしていくことができるTTDによるデバッグを試してみました。&lt;/p&gt;
&lt;p&gt;特に、メモリダンプやプロセスダンプからはわからなかった過去のメモリやレジスタの状態がわかるため、非常に解析がスムーズになりました。&lt;/p&gt;
&lt;p&gt;また、ライブデバッグと異なり前の処理に戻ることができるため、「ブレークポイントを設定して問題を再発させて・・・」という手間がなくなる点も非常に便利でした。&lt;/p&gt;
&lt;p&gt;今後もTTDを活用したデバッグ手法についてまとめていこうと思っております。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧くださいますと幸いです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-005-kernel-dump</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-005-kernel-dump</guid><pubDate>Fri, 08 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;の記事では、WinDbgでカーネルモードデバッグを行う最初の一歩について紹介しました。&lt;/p&gt;
&lt;p&gt;今回は、ライブデバッグではなく、カーネルメモリダンプの解析方法について紹介します。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB&quot;&gt;今回利用するツール&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg-preview&quot;&gt;WinDbg Preview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notmyfault&quot;&gt;NotMyFault&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;カーネルメモリダンプを取得する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;コントロールパネルから設定を変更する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;NotMyFaultを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;メモリダンプを取得する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;カーネルメモリダンプの解析を行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot;&gt;WinDbgにダンプファイルを読み込む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;メモリダンプ読み込み時の出力を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;!analyze -v で自動解析を行う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot;&gt;スタックバックトレースの解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B&quot;&gt;トラップフレームからスレッドを復元する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;プロセスを確認する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回利用するツール&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB&quot; aria-label=&quot;今回利用するツール permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回利用するツール&lt;/h2&gt;
&lt;p&gt;今回は、Windows10環境にて、次の2つのツールを使用します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WinDbg Preview&lt;/li&gt;
&lt;li&gt;notmyfault64&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;windbg-preview&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg-preview&quot; aria-label=&quot;windbg preview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbg Preview&lt;/h3&gt;
&lt;p&gt;WinDbg Previewは、Microsoft Storeから入手可能なUWP版のWinDbgです。&lt;/p&gt;
&lt;p&gt;Windows Debug Toolsの中に含まれている従来のWinDbgと比較して、UIがかなりモダンになっていたり、タイムトラベルデバッグ（TTD）に対応していたりと機能強化されています。&lt;/p&gt;
&lt;p&gt;なお、従来のWinDbgとは同じエンジンを使用しているらしく、すべての機能が引き続き利用できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugging-using-windbg-preview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg プレビューを使用したデバッグ - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;notmyfault&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notmyfault&quot; aria-label=&quot;notmyfault permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;NotMyFault&lt;/h3&gt;
&lt;p&gt;NotMyFaultは、本来コンピュータがクラッシュしたときに生成されるメモリダンプを手動で取得するために用いるツールです。&lt;/p&gt;
&lt;p&gt;以下のドキュメント内のリンクから取得できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルメモリダンプを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルメモリダンプを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルメモリダンプを取得する&lt;/h2&gt;
&lt;p&gt;解析のため、まずはカーネルメモリダンプを取得していきます。&lt;/p&gt;
&lt;h3 id=&quot;コントロールパネルから設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;コントロールパネルから設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コントロールパネルから設定を変更する&lt;/h3&gt;
&lt;p&gt;メモリダンプを取得する端末でコントロールパネルを開き、[システムとセキュリティ]を開きます。&lt;/p&gt;
&lt;p&gt;次に[システムの詳細設定]をクリックして、[システムのプロパティ]ウィンドウを開きます。&lt;/p&gt;
&lt;p&gt;そして、[起動と回復]セクションの[設定]をクリックし、起動したウィンドウ内の[デバッグ情報の書き込み]の設定を[カーネルメモリダンプ]に変更します。&lt;/p&gt;
&lt;p&gt;最終的に、以下の画像の設定になっていればOKです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACk0lEQVQoz01S204TURSdb/BZMBgp0d/xTX/BFz/BxBcMPoCBIA+KbyZGXkRIuBilFCSA0dDSOp1brzOdmc59preZLvc5WOAkK6c9+8w6a+21BaNtwDQsWIYNs2PD0E3oLQO25cB1PDTrOo4OzqGqNV5n5xM4tguX4DsuojDE5fEhBNMyYds2OmYHRofITRPtdpv2DuIkRhwluPhdhixX0Wq1oBs6v+/7PlyXSBkcB34QQjz7CcFxuryYxAl6SQ9RFCGgYkK/2Rr0BhBLIiRJgqKo0DSN1KoczWaL0IRK537oY+vjDoQsy5Cm6TUGgwGGwyHiOOaXfc+HVlWg1TRSKXNUKhWUSpfcjWVZkKoSuQnxfmUTQhRHJN1Fv9/nZGNSNR6PwR5iexL38LckcWsu9Yq5mcCj79i37JwRflrfgzBKR1eWk4STThYj73a7CPwQ5SKzK5E1UkpWG/U6HKq5/wlZD6M4xLcNCoURpWnGSW6UAUOyH9BDESkUywpUsv+nXIZGgTnUZwaXkr1NuPM5D8GilJlklhhTGgQBstEIST4P/+AAXr4A6VKCVDhEcWsLjeNj6KenaLL94gKu53HCkAj3Nr5DmCi7Bv3PKBRndxe17W1Ye/tQKiLkkxPIhQLkoyM0z38hEEV4ZN+j0FxGGIX4sbl/Q3h7sf419DYMSjGktDWpCpn6VmEJywoUsl+nutaoo15jA2/SHAbIf/0CIWR98K7SY2PAh5cuN+gyG/Ai2aqUivyh0WiIjHqbZSmS/gCmG8CnwQ8CnztTz3YhzM7k8OD+LHIzc8hNz2F2Kkc7YWoOD+89wt0703jy+CnW333A8tIKVpffYm1lDYuLq3g5v4hXC0t4Pb+A5TerePH8Gf4BaKNdYR1kH9QAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/df507aee8ef651273247df2766ef4b5b/8ac56/image-16.webp 240w,
/static/df507aee8ef651273247df2766ef4b5b/d3be9/image-16.webp 480w,
/static/df507aee8ef651273247df2766ef4b5b/b0a15/image-16.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/df507aee8ef651273247df2766ef4b5b/8ff5a/image-16.png 240w,
/static/df507aee8ef651273247df2766ef4b5b/e85cb/image-16.png 480w,
/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png&quot;
            alt=&quot;image-16.png&quot;
            title=&quot;image-16.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;notmyfaultを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;notmyfaultを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;NotMyFaultを取得する&lt;/h3&gt;
&lt;p&gt;以下のドキュメント内の[メモリダンプファイルを手動で生成する]の項から、NotMyFaultの入ったZIPファイルダウンロードし、解凍します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;メモリダンプを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリダンプを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリダンプを取得する&lt;/h3&gt;
&lt;p&gt;すべてのウィンドウを閉じ、メモ帳アプリを開きます。&lt;/p&gt;
&lt;p&gt;適当に文字を書き込んだところで保存を実行し、以下の画像のようにファイルを書き込む前の状態で操作を中断します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 64.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACWElEQVQ4y42Ty08TURSHR0Lc2EKhWmmn82hn+goNtLQyU0tp6SsxcdGNbt1ZSxMSTEjQYDQmunTpWnbGtSu3blxIjAiRx0xbiohAgn/Cz3vvtLWoCU7y5Zx77sx3n8O9f/sG258+oPXlIw62PuP79jqOjE0cmWf5QTEsDjvxmNSOd9dxum/g3cuneHYjAu5grwH6nJz+RHOvjUZrD0ajBbNJILnZtKD1frr1XbOB9uEJXr94guclFdy3psGE8/U6HA4H3LwA5+gInM5R2G02DNntsNttsNkukWhnNdoeHhpijJBvRhzDsJG+26kouP1GR1ir4YrLhXAkgkAgAJ/PB1mWe9AajX6/n/VRaG71qZCUINLXNHDtjnBh6SHCkwlc1zWEQiFIktST0XxiYgLRaBSxWAzR8fGenPb5SM6LMlaKIXCtjvDByiMkyAgpXUcgGIQoij0ZpduWZalXswa18AgSHheC4AzDElZr83BdHYOqKmx5/cL+mf4WyWcQyPtzyQS4nZ1dJry3sAgXLyEUDEDtE/4vgijhljYJ7uvWFhPW7i9BUMNQfDLEf8zgPLxEeEcjp7yxscmE9cUlKOEovB43eJ7v7dt5dLfAKwi4mYyBM02TCZeXl9kpapqGZDKJqampv4jH44w/21YtTq6NDu7V6irW1tZwt1pFuVxGpVJhMZfLIZPJYHZ2lkHzfH4OxWIR2WwWMzMzpJ1HqVzCHImFQgEpLQ1uYPAiLgwMkj/jMps6Xe7YmBtutweeLh6eIZKr4fcpUPwqVEWFPq2jmCMDZLIMfTqNX7YP/N7xkrLuAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f943dd66de27fc0bc932bf88313edd91/8ac56/image-17.webp 240w,
/static/f943dd66de27fc0bc932bf88313edd91/d3be9/image-17.webp 480w,
/static/f943dd66de27fc0bc932bf88313edd91/b0a15/image-17.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f943dd66de27fc0bc932bf88313edd91/8ff5a/image-17.png 240w,
/static/f943dd66de27fc0bc932bf88313edd91/e85cb/image-17.png 480w,
/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png&quot;
            alt=&quot;image-17.png&quot;
            title=&quot;image-17.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この状態で、先ほど解凍したNotMyFaultを実行します。
※ 途中で同意を求められるのでOKを選択してください。&lt;/p&gt;
&lt;p&gt;起動すると次の画面が表示されるので、初期状態のまま[Crash]をクリックします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 396px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 116.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtElEQVQ4y41Vi1LiQBDk/z9L705F0CJRngbzJuH9CCgE6JseCBUg3LlVU+wuSW/3TO+kdH93h0ajgZpRQ6vVwiJZYDqdYjwea4xGo9N8MpnoOtvLz+M4VpyS6ziYzeaYz+fyO8NisdDgerlcYrVancXX19dVcP/7+xv9fh8ly7IwHA6x2Wzgey4s6xPDwQCdTgczAU2EcZIkGjyQ7IuCBIIgQMkRhly4rodYTojjCIEfoNfrwdffCK7jwvN8YbwCx263w36/PwXXHAMhUrJtB2EQwjTfNAeddgfNRhP1ehONel2YWpKCRGWlaaovZkDZyOYK6Lqu6rc/bUymM+yOJ26321PkRx4sY3cG6Hme5sA0TNgiLQxDlchfylXpIjcMmQJf8xTHfZ0nyersgBNDVrXyXIFRM1GtvEhU8fryKntVlJ/KqFQqqNUMPP55QLn8jF/3v2EIgc+ujVQUXAEmkqOu1VUm3pGNbdtaHNoqFJZUwSrzJbriskDngGKJVqsDR6RSiiOFoqxBf6DeGo3GKBqFOaRt6EFPbEOb9AWIOdwcK3pZjHwUMiTger0W6wQqOerFKpU3gA9ut7uzqubnNwHJMBCplEuDbzZpobyi9Q3AtYCFmjuC0ugEpnVofBr7EvSfgLwBzCGlssIE5h5TsUyWJ3P/GJA3xVew8JBL/2De+XxxBfCjoihDL0Bb7vFH5wOR9DYyHY8nNyv8X8DhcKSsxtJE05xlikDy+4XGvswPH0rT7VmDOFhoq4cx9rkmctUcimyRDb7cajbxIPeYKeHNCcMAT49PMExTr+EZIO8sB72YnZ4P7s/kHvPbMZX2xmvKZnJYT9UJ2Th9AvjQrdaetffsO5MF1+zu7VYTb2+m9II2ut0uSu/v70qVfS+KIv163Qr+z+eyIIBhGKhWKyqfHf8vf4PZY60odpIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/8ac56/image-18.webp 240w,
/static/56332a5e1b75d8bd5ca15658b2030727/2a0bc/image-18.webp 396w&quot;
              sizes=&quot;(max-width: 396px) 100vw, 396px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/8ff5a/image-18.png 240w,
/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png 396w&quot;
            sizes=&quot;(max-width: 396px) 100vw, 396px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png&quot;
            alt=&quot;image-18.png&quot;
            title=&quot;image-18.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、Windowsマシンでブルースクリーンが発生して再起動されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABfklEQVQ4y9VSu04CQRRdYFfEtwFNjMYCY2d8UKiV/6SEXUBRML5NVKLGyn+wsrK0RRvYXVYXKo1+xfHe2eEZUFuKkzs7O/fcc86MouhFKIYJRS9BSZQa9T/gs7Vew4KaKEARhLqJQNLEUMbCIGFiv4wIYWTXru9N0vfYno1RQiRXFujftiRZjfAFik8S9qVNzBw5WLpysX5bRSzvYu70DVHC4qWLtZsKVvJeXbhwxdm+dCuhpjcRqikTwxkb41kboR1LDGDVDFbCzQz+p9HZFtsCbYTcNH/2jqkDRzRws5b2KpP6DM8FD1ZT3rp2JkjwJaVlv0GE8RKiJw6yj5+IP3xg9tgRSjm3sMyLsxR5kkIezgjJ9QBVf8qGygoDTLhZRIyyu3/+xvnTF5Ypq3DOxvShU7+EIOfVbrP5VQjLr2SZCWmDb3TjrorV64pYa9JaIyP5RDqi6VLq75CnkFJlq9iqor256147IU3xy/C7knRT2ZHwV0t/oIcICz2g8AeTP71+51uxDgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ac56/image-19.webp 240w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/d3be9/image-19.webp 480w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/b0a15/image-19.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ff5a/image-19.png 240w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/e85cb/image-19.png 480w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png&quot;
            alt=&quot;image-19.png&quot;
            title=&quot;image-19.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;再起動後、&lt;code class=&quot;language-text&quot;&gt;C:\Windows&lt;/code&gt;直下に、&lt;code class=&quot;language-text&quot;&gt;MEMORY.DMP&lt;/code&gt;が存在することを確認します。
※ 僕の環境では大体450MBくらいになりました。&lt;/p&gt;
&lt;p&gt;これでカーネルメモリダンプの取得が完了しました。&lt;/p&gt;
&lt;h2 id=&quot;カーネルメモリダンプの解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;カーネルメモリダンプの解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルメモリダンプの解析を行う&lt;/h2&gt;
&lt;h3 id=&quot;windbgにダンプファイルを読み込む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot; aria-label=&quot;windbgにダンプファイルを読み込む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgにダンプファイルを読み込む&lt;/h3&gt;
&lt;p&gt;解析を行うために、WinDbgを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;次に、[File]から[Open dump file]を選択し、先ほど出力された&lt;code class=&quot;language-text&quot;&gt;MEMORY.DMP&lt;/code&gt;をインポートします。
（メモリダンプがWinDbgに読み込まれるまで数分かかる場合があります。）&lt;/p&gt;
&lt;p&gt;メモリダンプが読み込まれると、以下の出力が確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Loading Dump File &lt;span class=&quot;token namespace&quot;&gt;[C:\Windows\MEMORY.DMP]&lt;/span&gt;
Kernel Bitmap Dump File: Kernel address space is available&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; User address space may not be available&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;

Symbol search path is: srv*
Executable search path is: 
Windows 10 Kernel Version 19041 &lt;span class=&quot;token function&quot;&gt;MP&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;3 procs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Free x64
Product: WinNt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; suite: TerminalServer SingleUserTS
Edition build lab: 19041&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;amd64fre&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;vb_release&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;191206-1406
Machine Name:
Kernel base = 0xfffff800`62600000 PsLoadedModuleList = 0xfffff800`6322a230
Debug session time: Thu Oct  7 20:33:12&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;945 2021 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UTC &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 9:00&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
System Uptime: 0 days 0:00:54&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;755
Loading Kernel Symbol&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;メモリダンプ読み込み時の出力を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;メモリダンプ読み込み時の出力を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリダンプ読み込み時の出力を読む&lt;/h3&gt;
&lt;p&gt;前項の出力結果から、次の情報が取得できます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;読み込まれたダンプファイルがカーネルメモリダンプであること&lt;/li&gt;
&lt;li&gt;WindowsのカーネルバージョンとCPUのコア数、bit数&lt;/li&gt;
&lt;li&gt;Kernel base と PsLoadedModuleList のアドレス&lt;/li&gt;
&lt;li&gt;Debug session time：STOPエラー（ブルースクリーン）が発生した時間&lt;/li&gt;
&lt;li&gt;System Uptime：システムがクラッシュまでに稼働していた時間（今回は検証環境なので54秒）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に&lt;code class=&quot;language-text&quot;&gt;Debug session time&lt;/code&gt;や&lt;code class=&quot;language-text&quot;&gt;System Uptime&lt;/code&gt;はトラブルシューティングの際に重要な情報になることもあるので、確認しておくとよいでしょう。&lt;/p&gt;
&lt;h3 id=&quot;analyze--v-で自動解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;analyze  v で自動解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;!analyze -v で自動解析を行う&lt;/h3&gt;
&lt;p&gt;次に、以下のコマンドを入力して自動解析を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;analyze &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;v&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最新のWinDbgの自動解析機能はかなり高機能であり、&lt;code class=&quot;language-text&quot;&gt;!analyze -v&lt;/code&gt;コマンドだけでも非常に多くのことがわかります。&lt;/p&gt;
&lt;p&gt;このコマンドを実行すると多くの出力が得られますが、その中からいくつか抜粋して確認していきます。&lt;/p&gt;
&lt;p&gt;まず最初に出力されるのは、クラッシュ原因の解析結果です。
トラブルシューティングの際はまずこの出力を手掛かりにしていくのが効果的な場合もあります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;analyze &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;v
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                        Bugcheck Analysis                                    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;

DRIVER_IRQL_NOT_LESS_OR_EQUAL &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
An attempt was made to access a pageable &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;or completely invalid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; address at an
interrupt request level &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; that is too high&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  This is usually
caused by drivers &lt;span class=&quot;token keyword&quot;&gt;using&lt;/span&gt; improper addresses&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; kernel debugger is available get stack backtrace&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Arguments:
Arg1: ffffd8024aaa8010&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; memory referenced
Arg2: 0000000000000002&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IRQL
Arg3: 0000000000000000&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value 0 = read operation&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 1 = &lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt; operation
Arg4: fffff80060da1981&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; address which referenced memory&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は、NotMyFaultの&lt;code class=&quot;language-text&quot;&gt;High IRQL Fault(Kernel-mode)&lt;/code&gt;を選択してシステムをクラッシュさせたため、&lt;code class=&quot;language-text&quot;&gt;DRIVER_IRQL_NOT_LESS_OR_EQUAL (d1)&lt;/code&gt;エラーが発生したことが示されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xd1--driver-irql-not-less-or-equal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Bug Check 0xD1 DRIVER&lt;em&gt;IRQL&lt;/em&gt;NOT&lt;em&gt;LESS&lt;/em&gt;OR_EQUAL - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このエラーは、&lt;code class=&quot;language-text&quot;&gt;PASSIVE_LEVEL(=最も低い割込みレベル)&lt;/code&gt;より高いレベルの&lt;code class=&quot;language-text&quot;&gt;Interrupt Request Level (IRQL)&lt;/code&gt;で動作するコードをページプール領域に展開しようとした際に発生するエラーです。&lt;/p&gt;
&lt;p&gt;詳しくは次の記事が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sciencepark.co.jp/device_driver/dvdr/report-12/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバドラ講座12 │ サイエンスパーク株式会社&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いてレジストリ情報が出力されたあと、クラッシュした原因のプロセスとスタックトレースが出力されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;PROCESS_NAME:  notmyfault64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe

TRAP_FRAME:  ffffd48f77af97e0 &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; 0xffffd48f77af97e0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
NOTE: The &lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; frame does not contain all registers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Some register values may be zeroed or incorrect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
rax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340
rdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000
rip=fffff80060da1981 rsp=ffffd48f77af9970 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000000000000002
 r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0
r11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei ng nz na pe nc
myfault+0x1981:
fffff800`60da1981 8b03            mov     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rbx]&lt;/span&gt; ds:00000000`00000000=????????
Resetting default scope

STACK_TEXT:  
ffffd48f`77af9698 fffff800`62a09169     : 00000000`0000000a ffffd802`4aaa8010 00000000`00000002 00000000`00000000 : nt!KeBugCheckEx
ffffd48f`77af96a0 fffff800`62a05469     : 00007ff8`f16ecc00 00000000`00000000 00000000`00000f4d 00000000`00000000 : nt!KiBugCheckDispatch+0x69
ffffd48f`77af97e0 fffff800`60da1981     : 00000000`00000000 ffffd48f`77af99c8 00000000`00000000 00000000`00000000 : nt!KiPageFault+0x469
ffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981
ffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d
ffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1
ffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55
ffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8
ffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5
ffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56
ffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25
0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54

SYMBOL_NAME:  myfault+1981
MODULE_NAME: myfault
IMAGE_NAME:  myfault&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
STACK_COMMAND:  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;thread &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cxr &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; kb
BUCKET_ID_FUNC_OFFSET:  1981
FAILURE_BUCKET_ID:  AV_myfault!unknown_function
OS_VERSION:  10&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;19041&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1
BUILDLAB_STR:  vb_release
OSPLATFORM_TYPE:  x64
OSNAME:  Windows 10
FAILURE_ID_HASH:  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;9745090a-9bce-ccba-c096-ca6e9ca04c64&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
Followup:     MachineOwner&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このように、&lt;code class=&quot;language-text&quot;&gt;!analyze -v&lt;/code&gt;だけでもかなりの情報を確認することができます。&lt;/p&gt;
&lt;h3 id=&quot;スタックバックトレースの解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;スタックバックトレースの解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックバックトレースの解析&lt;/h3&gt;
&lt;p&gt;続いて、スタックバックトレースを解析してみます。&lt;/p&gt;
&lt;p&gt;スタックバックトレースの表示コマンドについては、以下のドキュメントを参照。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/k--kb--kc--kd--kp--kp--kv--display-stack-backtrace-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;k、kb、kc、kd、kp、kP、kv (スタック バックトレースの表示) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;k / kb / kv&lt;/code&gt;の3つのコマンド結果を比較してみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjUlEQVQoz5VS2W7CMBDM//8V4kxJI0AJSRwngZyEUwgIh4Dp7qrloepDsTRar2WPZ2fXSNMa6/UKdV1jtVrheDxisVhgv9/jdruB1/P5/DcM36uglAfP8+E4DpbLJYIgQFlWuN/veDwe7xGqoEIcayJR0Fpju90iSRLMZjNRyqTvLMN1IiKMkOc5qfSEaD6fC/K8ECsYrLyqKolsx+FwEHt+w7DtEJb1gTTNYNs27S1Yw6HEXq+PwcBEv9+XfDweYzKZoCRiruQvGKYZ0IMuKZvT4wE6nQ663a7EVquFdrtN6MA0TYxGI3zSp0op8rgUgs1m84IQOlSy1qE0gT2M4xi+70ljOA/DUOKMfM3SVCyJ44QmY43T6YSmaV7g3EiSJfIiE4V8mQ/Z04SIOedzJoyiCIHvyxn7XZSF3L1er4KfEZMua62kDJ8esOGK1E2nU7iuK2DfeKRcAivmhjHxbrcj0kYmgSFjE+maLiSigCGEKpCSw+9PmJwngPdcbpZlMlpFUUhnL5cLzuez4AtJwOPcIhjU0QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/8ac56/image-21.webp 240w,
/static/1143b35b663a53e8d322c8d21a49e0e2/d3be9/image-21.webp 480w,
/static/1143b35b663a53e8d322c8d21a49e0e2/e46b2/image-21.webp 960w,
/static/1143b35b663a53e8d322c8d21a49e0e2/7e452/image-21.webp 1402w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/8ff5a/image-21.png 240w,
/static/1143b35b663a53e8d322c8d21a49e0e2/e85cb/image-21.png 480w,
/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png 960w,
/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png 1402w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kv&lt;/code&gt;の方が情報量が多いことがわかります。
このコマンドではフレームポインターの省略された情報(FPO) 情報も表示します。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;(TrapFrame @ ffffd48f&lt;/code&gt;77af97e0)`という表示に注視します。&lt;/p&gt;
&lt;p&gt;これはトラップフレーム(割り込み発生時のレジスタ、スタック)といって、この時点のスレッドの状態を復元するための非常に重要な情報です。&lt;/p&gt;
&lt;h3 id=&quot;トラップフレームからスレッドを復元する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B&quot; aria-label=&quot;トラップフレームからスレッドを復元する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラップフレームからスレッドを復元する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.trap&lt;/code&gt;コマンドを使ってトラップフレームからスレッドの復元をしてみます。&lt;/p&gt;
&lt;p&gt;トラップフレームで復元した時点でのレジスタの情報が出力されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; ffffd48f`77af97e0
NOTE: The &lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; frame does not contain all registers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Some register values may be zeroed or incorrect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
rax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340
rdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000
rip=fffff80060da1981 rsp=ffffd48f77af9970 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000000000000002
 r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0
r11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei ng nz na pe nc
myfault+0x1981:
fffff800`60da1981 8b03            mov     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rbx]&lt;/span&gt; ds:00000000`00000000=????????&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、スタックバックトレースの結果からも、トラップフレーム時点の状態に戻っていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; kv
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Stack trace &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; last &lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt; context &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;thread/&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cxr resets it
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               : Args to Child                                                           : Call Site&lt;/span&gt;
00 ffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981
01 ffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d
02 ffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1
03 ffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55
04 ffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8
05 ffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5
06 ffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56
07 ffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TrapFrame @ ffffd48f`77af9e40&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
08 0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセスを確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセスを確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセスを確認する&lt;/h3&gt;
&lt;p&gt;ここからは、ファイルの保存途中で停止したメモ帳プログラムの動きをメモリダンプから解析してみます。&lt;/p&gt;
&lt;p&gt;次のコマンドで、稼働中のプロセスの一覧を参照できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;process&lt;/span&gt; 0 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-process&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロセス (WinDbg) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 0&lt;/code&gt;のように、1番目の数値を0にした場合は、全プロセスについて情報が出力されます。&lt;/p&gt;
&lt;p&gt;特定のプロセスに関する情報のみを表示する場合は、1番目の値でプロセスの16進数アドレス、またはプロセスIDを指定します。&lt;/p&gt;
&lt;p&gt;また、2番目の数値を変更することでより詳細な情報を出力させることができます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 0&lt;/code&gt;とした場合は、すべてのプロセスについて時間と優先度の統計情報が出力されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 1&lt;/code&gt;とした場合は、プロセスに関連付けられているスレッドとイベントの一覧と、それらの待機状態に関する情報も出力させることができます。&lt;/p&gt;
&lt;p&gt;この出力の中から、メモ帳のプロセスの情報を探し当てます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;PROCESS&lt;/span&gt; ffff9189527e9080
    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8
    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    Image: notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、このプロセスのアドレスを利用して、プロセスの詳細情報を出力してみます。&lt;/p&gt;
&lt;p&gt;フラグ（2番目の値）を7に設定することで、1つのプロセスの完全な詳細を表示することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;process&lt;/span&gt; ffff9189527e9080 7
&lt;span class=&quot;token keyword&quot;&gt;PROCESS&lt;/span&gt; ffff9189527e9080
    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8
    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    Image: notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
    VadRoot ffff918953a30a20 Vads 285 Clone 0 Private 2175&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; Modified 340&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; Locked 2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    DeviceMap ffffd80247fe8cf0
    Token                             ffffd8024a19c770
    ElapsedTime                       00:00:47&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;378
    UserTime                          00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;000
    KernelTime                        00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;000
    QuotaPoolUsage&lt;span class=&quot;token namespace&quot;&gt;[PagedPool]&lt;/span&gt;         430688
    QuotaPoolUsage&lt;span class=&quot;token namespace&quot;&gt;[NonPagedPool]&lt;/span&gt;      39648
    Working &lt;span class=&quot;token function&quot;&gt;Set&lt;/span&gt; Sizes &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;min&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;max&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;11788&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 50&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 345&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;47152KB&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 200KB&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 1380KB&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    PeakWorkingSetSize                11793
    VirtualSize                       2101500 Mb
    PeakVirtualSize                   2101501 Mb
    PageFaultCount                    14745
    MemoryPriority                    BACKGROUND
    BasePriority                      8
    CommitCharge                      3452

        THREAD ffff91895309d080  Cid 1e90&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1e94  Teb: 000000bb6f2ad000 Win32Thread: ffff9189523d0fc0 WAIT: &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UserRequest&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; UserMode Non-Alertable
            ffff918953118260  SynchronizationEvent
            ffff918952d83d80  QueueObject
        Not impersonating
        DeviceMap                 ffffd80247fe8cf0
        Owning &lt;span class=&quot;token keyword&quot;&gt;Process&lt;/span&gt;            ffff9189527e9080       Image:         notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
        Attached &lt;span class=&quot;token keyword&quot;&gt;Process&lt;/span&gt;          N/A            Image:         N/A
        Wait &lt;span class=&quot;token function&quot;&gt;Start&lt;/span&gt; TickCount      3492           Ticks: 12 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0:00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;187&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        Context &lt;span class=&quot;token keyword&quot;&gt;Switch&lt;/span&gt; Count      10798          IdealProcessor: 2             
        UserTime                  00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;140
        KernelTime                00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;328
        Win32 &lt;span class=&quot;token function&quot;&gt;Start&lt;/span&gt; Address 0x00007ff7e2e85a30
        Stack Init ffffd48f777bffd0 Current ffffd48f777bead0
        Base ffffd48f777c0000 Limit ffffd48f777ba000 Call 0000000000000000
        Priority 10 BasePriority 8 PriorityDecrement 0 IoPriority 2 PagePriority 5
        Child-&lt;span class=&quot;token function&quot;&gt;SP&lt;/span&gt;          RetAddr               Call Site
        ffffd48f`777beb10 fffff800`6280c970     nt!KiSwapContext+0x76
        ffffd48f`777bec50 fffff800`6280be9f     nt!KiSwapThread+0x500
        ffffd48f`777bed00 fffff800`628805ce     nt!KiCommitThreadWait+0x14f
        ffffd48f`777beda0 fffff800`62c6f620     nt!KeWaitForMultipleObjects+0x2be
        ffffd48f`777beeb0 ffffeccb`d0c3798d     nt!ObWaitForMultipleObjects+0x2f0
        ffffd48f`777bf3b0 ffffeccb`d0b46c5e     win32kfull!xxxMsgWaitForMultipleObjectsEx+0xd9
        ffffd48f`777bf460 ffffeccb`d15d6fd0     win32kfull!NtUserMsgWaitForMultipleObjectsEx+0x3fe
        fffff800`62a08bb5     win32k!NtUserMsgWaitForMultipleObjectsEx+0x20
        ffffd48f`777bfdd0 00007ff8`eed7a104     nt!KiSystemServiceCopyEnd+0x25 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TrapFrame @ ffffd48f`777bfe40&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        000000bb`6f17e2d8 00000000`00000000     0x00007ff8`eed7a104
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この出力情報から、ファイルを保存しようとしているタイミングのプロセスの情報を取得することができました。&lt;/p&gt;
&lt;p&gt;※今回はカーネルメモリダンプなので、カーネルモードプロセスの情報しか含まれていません。
ユーザモードのプロセスの情報も見る場合は、完全メモリダンプを取得する必要があります。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、Windows環境でカーネルメモリダンプを取得する方法と、WinDbgを用いた簡単な解析方法について紹介しました。&lt;/p&gt;
&lt;p&gt;今後は、より高度な解析手法についてもまとめていく予定です。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;s&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩]]></title><link>https://kashiwaba-yuki.com/windows-windbg-004-kernel-debug</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-004-kernel-debug</guid><pubDate>Wed, 06 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;の記事では、公式チュートリアルの内容を参考にWinDbgでユーザモードプロセスのデバッグを行う最初の一歩について紹介しました。&lt;/p&gt;
&lt;p&gt;今回の記事では、WinDbgを用いてカーネル モードデバッグを実施する方法についてまとめます。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89&quot;&gt;カーネルモードデバッグのための環境構築&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回使用する環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4&quot;&gt;VirtualBoxの設定変更&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;カーネルモードデバッグの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot;&gt;WinDbgの設定をする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;WinDbgでカーネルデバッグを行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot;&gt;WinDbgからカーネルを停止する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;カーネルモードデバッグでモジュール一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;カーネルモジュールにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルモードデバッグのための環境構築&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89&quot; aria-label=&quot;カーネルモードデバッグのための環境構築 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグのための環境構築&lt;/h2&gt;
&lt;p&gt;WinDbgを用いてカーネルモードデバッグを行うためには、WinDbgを使用する「ホストコンピュータ」と、デバッグ対象のターゲットコンピュータの2つを用意し、下記のいずれかの方法で接続する必要があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;イーサネット&lt;/li&gt;
&lt;li&gt;USB 2.0 / USB 3.0&lt;/li&gt;
&lt;li&gt;シリアル (null モデムとも呼ばれる)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg--kernel-mode-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg の概要 (カーネル モード) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;※ より正確には、すべてのカーネルプロセスにアクセスしてデバッグを行うためには2台のマシンが必要です。
1台のマシンでローカルカーネルデバッグを実施することもできますが、OSの稼働を止める必要があるような解析は行うことができず、制限が発生します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/setting-up-local-kernel-debugging-of-a-single-computer-manually&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;単一コンピューターのローカル カーネル デバッグの手動設定 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、通常カーネルモードデバッグを行う際には2台のコンピュータが必要ですが、WinDbgは仮想マシンにインストールしたWindowsに対してもカーネルモードデバッグを行うことができます。&lt;/p&gt;
&lt;p&gt;今回は、VirtualBox上に構築したWindowsマシンに対してカーネルモードデバッグを仕掛けていきます。&lt;/p&gt;
&lt;h3 id=&quot;今回使用する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回使用する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回使用する環境&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ホストマシン&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows10 Pro 20H2&lt;/li&gt;
&lt;li&gt;WinDbg 10.0.22000.1 AMD64 (管理者権限で起動)&lt;/li&gt;
&lt;li&gt;VirtualBox 6.1.26&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ターゲットマシン&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows 10 Pro 1511 (VirtualBox上に構築)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;virtualboxの設定変更&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4&quot; aria-label=&quot;virtualboxの設定変更 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VirtualBoxの設定変更&lt;/h3&gt;
&lt;p&gt;今回は、VirtualBox側ですでにWindowsの仮想マシンが構築されていることを前提とします。&lt;/p&gt;
&lt;p&gt;カーネルモードデバッグを行うために、VirtualBoxの仮想マシン側でCOMポートの設定を行います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ホストマシンのVirtualBoxマネージャで、デバッグ対象の仮想マシンの設定を開きます。&lt;/li&gt;
&lt;li&gt;次に[シリアルポート]の設定項目を開き、[ポート1]を有効化します。&lt;/li&gt;
&lt;li&gt;ここで、以下の設定をそれぞれ実施します。&lt;/li&gt;
&lt;li&gt;ポート番号：COM1&lt;/li&gt;
&lt;li&gt;ポートモード：ホストにパイプ&lt;/li&gt;
&lt;li&gt;パス/アドレス：&lt;code class=&quot;language-text&quot;&gt;\\.\pipe\com1&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACy0lEQVQ4y51SSU9TURR+LYXwP9SdY+JCE40sXJCIA7pQXGhYoGjqT1ASTdy4UnCjlAroAtQERGVUpLRWOtFJChShAx1e2/c6Pdq+1+Hz3guoG2PiSb57bs4757vfOedxbosZGVFEio8jnUogIyQRj/HEJ5ATk0jySWSFFLmnIKYECCSeThPwMfRrWzB0aS/eXNmPp62H8OjcYXAOlwclpYw/bTUSQFbKQlYqEBKkWBSQyeUglxTEhBAychLVCjBw+wL0Lftwr/kozp84jtaTx8ANfjRhanED3o04QmkF0VwF4c04fL5lhEIhokYkSEMUtn04HEY0EkVgYx3d15rxsGkP7p4+AO2pg7jZdATc9Z7PuKhfx5kXUZwdlnB5KAm3P4jNcAiBQBAiGQdFNptFJpNhnoKSB3xe/HDbEfDYwK99x/jjLnCv3r7HrG0JU2YXpglmzE7MLxFl+QJrn+d5RCIR5EjLW1tbkCQJpVKJoVytQqnWfo1sbLAX3PiHMfi8LrgcVrgX7XATb/NvIpWVUKtUkM9LiMVi8Pv9jJyqKxaLJJ5HsVBAheTIcokRDuoI4cjIKNweD6w2O+wOB2w2GzxknlJRZkmKojBVwWCQzNVHtiwwUhovl8uoEpVlcqc2qn8Obnj4NZxOJxYWFmCxWGG1WDDnWsPy2gaSZMMFooYW05YpkSzLrF2qjBLSb3JpW+E7/TNwExMT7PWVlRXWln91Fd5ADAmy1QKZmSwr+JdVCTm1l306cG1tV6HV3kFn5y10dNxAe3s7Jr+5kSuUGKGy006tVvsrKjuEOl0fOGL0gKa+ESqVht1npmdYwu426Zxo0W9UWWwXu4/29hKFKrUGaoq6etQ3NDJCo8mE/7H+/gFSr1KTo44wa6BSNzDCJ909sFqtmJ39gjmDAYb5eRgMFEbmjUYjW+Ai+TM+zZkxNmnAV5MZD7ru4yfPlHJ8skb53QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/8ac56/image-11.webp 240w,
/static/57d56d521ef808486eb1a1b8a20d0c26/d3be9/image-11.webp 480w,
/static/57d56d521ef808486eb1a1b8a20d0c26/b0a15/image-11.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/8ff5a/image-11.png 240w,
/static/57d56d521ef808486eb1a1b8a20d0c26/e85cb/image-11.png 480w,
/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png&quot;
            alt=&quot;image-11.png&quot;
            title=&quot;image-11.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでVirtualBox側の設定は完了したので、仮想マシンを起動します。&lt;/p&gt;
&lt;h3 id=&quot;カーネルモードデバッグの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;カーネルモードデバッグの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグの有効化&lt;/h3&gt;
&lt;p&gt;仮想マシンが起動したら、コマンドラインを管理者権限で起動して、以下のコマンドを入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;debug on
bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;dbgsettings serial debugport:1 baudrate:115200&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もしくは、&lt;code class=&quot;language-text&quot;&gt;Msconfig.exe&lt;/code&gt;を起動して、詳細オプションからCOM1ポートを指定してデバッグを有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 666px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADQ0lEQVQ4y41Tz4tbVRi9dKBQKwi1RYrLakFtUReCq67tyo11VcFFFyIUayuFKpTROgstUysMUloVBRcuWov/hB3QOp02Y5LJZCbJe3k/7n0/8/J+JJPk+H33JTPtrg8O3+U+7vnOOd+94q/lf7DeaKBaX0e700Gr/Tja2Go9HTYZm1sQjXoNgzQGRgXS2EcvkIh9F/3IQ9YLMBmmwHb2VBjkGcTfNRN310b4ozLE3UcFbq/muLOa4feVFH8+SvHb/Qw3lzPcWi5riXSK2b8UN5ZzbLgphGm7yMZAnE+QDKBh+BlqLQeVZhcd1YcVD9ENB7AixhBOb0TYhs37tMd1vRvB9SMI13FQfsSKiYYfRvClA9fuQrkWWUkxyPooCGkSQU73kzjUe8O8jzAMID0fwpkSTiaTshK6rkKlUsHqw4f4d2UF/1WrsCwbURRDKYUODc80u5BSaXieB0d6cBURGoaBZrOJytoaGjRtwzTRMiyaWBONjQ0isuC6LnzfJ8JII45jDV4HQaArE3oBWbZtGz53IKVZliHPc5i2RLvVQovAB5Mk2SGLwpDs7WLWwFUeAnIgpJQoigKKap8O8qeoE6timN2ubsaHHieYKeS9eKrQD4mQM+GPLfV6CcbjMSRNq9ncQK1eR5Xya9MFnylkAWWGJlxal5ZD2JQ7D3OHkDt5RMqVLW9RhtVaTR/knLkyIat+8GBF524YJjr0j8VYdP12pswT5vzKDAu4XkidfT0QVsRN/GmzmVKdIaljhaVlBeWHZYbj0RCDIsf2oNCV82DliobFVyKgw1LbC3fIdokj9ChP03K0C/HuB2dx6sxneI/w/kef4+Tpc1j69Q4iUrg1nbRDNp8kCqcor03aT1Cpb+LUuasQ4pmXIfYRnn0F4sCbEHuO4MPzCxht05NyXK1SqvICK+VpSAblJadrJrx3vwJx5B2IuUPHMXfoGOZeeAN7X3wLYv9RXPjqevlqKIrySe5iMhnD8HowZAAvKciJh34cYK3WwHNHT5DCA6zsVYjnX8Oeg8eJ8CW8ffI0vln6BZe/vYH5xZuEW5i/9hO+/O5nXF78EZ9e+QGfzH+PiwtLuHTlGr5YuI6PL36NvYdfx/+wGK4WmV5fYAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/8ac56/image-9.webp 240w,
/static/7be9c75f374117e7a6f4bb8a457bd035/d3be9/image-9.webp 480w,
/static/7be9c75f374117e7a6f4bb8a457bd035/be082/image-9.webp 666w&quot;
              sizes=&quot;(max-width: 666px) 100vw, 666px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/8ff5a/image-9.png 240w,
/static/7be9c75f374117e7a6f4bb8a457bd035/e85cb/image-9.png 480w,
/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png 666w&quot;
            sizes=&quot;(max-width: 666px) 100vw, 666px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png&quot;
            alt=&quot;image-9.png&quot;
            title=&quot;image-9.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;上記の設定が完了したら、ホストマシン側でWinDbgの設定を行います。&lt;/p&gt;
&lt;h3 id=&quot;windbgの設定をする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgの設定をする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgの設定をする&lt;/h3&gt;
&lt;p&gt;ホストマシン側で、WinDbgを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;カーネルモードデバッグの場合は、WinDbgも管理者権限で起動しておく必要があります。
もしユーザモードで起動している場合は、&lt;code class=&quot;language-text&quot;&gt;Kernel debugger failed initialization, Win32 error 5 アクセス拒否されました&lt;/code&gt;というエラーとともにカーネルモードデバッグに失敗します。&lt;/p&gt;
&lt;p&gt;WinDbgを管理者権限で起動したら、[File]&gt;[Kernel Debug]を選択し、以下の画像のように名前付きパイプを利用してターゲットマシンに接続させます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABdElEQVQoz52S6W6CUBCFef83UVGoCiSKaRMTdsGoD9AfdWmtstcKwilzE4220dpO8mVm7oWTWS4XRRG2YQw/SuDHKT7zDPs8R14cUJQFvltZlrhlnGObsG0bhq6foNx1XTiOA02v7gyniscwTReeO4FVxbY3hWVZGI1GmM1mmE6nzHOWaUDTdEwmk9MFQbnneRiPx5BkCbVaDTzPo9lsotHgUeeb7Kxer7OzI1wSx1iv14iiEGEYIkkS7HY77Pd7RlEUrBJBEKAoCiRJOiHL8kVOcPP5C5bLJXzfx2q1wmazQRAESNMUh8OBzUWvxtBqtdgPnU7nJtxiMQcthiphC9pufyzAMIwLwW63exXWclC1SoJUGQlSTGL/EjyvpjyPK0j4X4LHWV2zPwtmWYbX4APPqwBvQYrN+5q1T1unuWqadr8gbXA4HELuP0GQVSjqI/q9HlRVxWAwYJ4+bLfbzP8qKIoie5Ci0MKDKDBPb+6ce8WIL0AtNRYExCc0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/8ac56/image-13.webp 240w,
/static/4ee28ac0fb172f16033a6266f6071c7a/d3be9/image-13.webp 480w,
/static/4ee28ac0fb172f16033a6266f6071c7a/b0a15/image-13.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/8ff5a/image-13.png 240w,
/static/4ee28ac0fb172f16033a6266f6071c7a/e85cb/image-13.png 480w,
/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png&quot;
            alt=&quot;image-13.png&quot;
            title=&quot;image-13.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここまで完了したところで[OK]をクリックすると、カーネルデバッグ用のCommandウィンドウが起動し、COMポートへの接続を待機し始めます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Waiting &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; pipe \\&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;\pipe\com1
Waiting to reconnect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、ターゲット側のWindowsマシンを再起動します。&lt;/p&gt;
&lt;p&gt;すると、以下の画面のようにWinDbgがターゲットマシンに接続され、ターゲットマシンがテストモードで起動しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5909177960178f54921d390b555c8b13/0b533/image-10.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 59.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACu0lEQVQoz42SW0hUURSG95zxFpGWUJGYqaljVuIY5KUUK5HQxocsU0tLyKCyvBX2JkFUL0EUlpcMnehCWeB1gnzo8tBbotltAoNgTHMyndFRnNGvfQ5ZEBEd+FiHtc/511p7/cJmG8JuH2VkZISxsTFGR0dxOh1Mu1zMzMzgknF6elrDpeL6zZQ8m52dpa+vj9bWVtrb2xEDAwMMDg4yPDwshZzaj+pHHo+Hubk5/uf5MmTj+bOnGsJqtWKz2TTsdjsOh4PJyUkp5uGr/RuNzXclt7lSb+Zqwy3qm+9R13yfOvND6loeUC+pbbrD5est1Da0INxut1Zlfn7+V0XPz87631rxj9iGX1gyIjAWsSQGEbABsSwOsSJJ5uIR/jLnvw7hF0mIMQOhjrcguMDCqAMfPrE8oRARnIISth0lfAfK2gwUwy6UjXkomw6jk+ijdiFWbcGQuu/fgm+sn1iVXY6IMqFbvwdhPIiSdBxl53l0+c3oj7TjXd2LV00/IusiUZllfxdUF6IJvrMSmyaFDNkI2ZGIL8Y7tRLfvCaU6n70tRME3HOy++U8sTUWQjNOIP61yfcfB4lMMiFWp6IzmDRBr21n8M5tRKnqRVEFH01R3DtH8tlOQtKPIVTvjY+PMzExoW1XxeFw4nbP8qrvNeuTMxFBiejC0hExOYgk2UXWJUTRfZTyF/hc+Exg43d8DpmJzJTX09XVRWdnJ2q0WCwa3d3d9PQ84cbNFowpJpSV8ShBm1FCUtCvTUcfnY3eWIR+ayVKxjl0ibJIuImo7UWIjo4OFlCdrsa2tjYeP7ZQe62B6Lg0aYk1CN8QxKIw+R4hbSKts9SIWCzt4iPzvsEI71AMCXIatbs/UUXVTs3mWxwrLaO88jRlFVWUnixn/8ESCkuOkltQRG7eAbJz8snMOYBpbwEVlaf4AZpplz8gK+T/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5909177960178f54921d390b555c8b13/8ac56/image-10.webp 240w,
/static/5909177960178f54921d390b555c8b13/d3be9/image-10.webp 480w,
/static/5909177960178f54921d390b555c8b13/b0a15/image-10.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5909177960178f54921d390b555c8b13/8ff5a/image-10.png 240w,
/static/5909177960178f54921d390b555c8b13/e85cb/image-10.png 480w,
/static/5909177960178f54921d390b555c8b13/0b533/image-10.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5909177960178f54921d390b555c8b13/0b533/image-10.png&quot;
            alt=&quot;image-10.png&quot;
            title=&quot;image-10.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、WinDbgでWindowsのカーネルデバッグを実施する準備が完了しました。&lt;/p&gt;
&lt;h2 id=&quot;windbgでカーネルデバッグを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;windbgでカーネルデバッグを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでカーネルデバッグを行う&lt;/h2&gt;
&lt;p&gt;WinDbgがCOMポート経由でターゲットマシンに接続したことで、カーネルデバッグの準備が整いました。&lt;/p&gt;
&lt;p&gt;しかし、現在はターゲットマシンのWindowsOSが稼働しているため、WinDbgのCommandウィンドウによる操作を行うことができません。&lt;/p&gt;
&lt;p&gt;WinDbgでカーネルデバッグを進めるためには、一度Windowsカーネルを停止する必要があります。&lt;/p&gt;
&lt;h3 id=&quot;windbgからカーネルを停止する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgからカーネルを停止する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgからカーネルを停止する&lt;/h3&gt;
&lt;p&gt;カーネルデバッグのためにWindowsカーネルを停止するには、WinDbg上部のツールバーから[Break]ボタンをクリックするか、[Ctrl+Break]キーを押して下さい。&lt;/p&gt;
&lt;p&gt;または、WinDbg上部の[Debug]メニューから[Break]を選択することでも停止が可能です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 426px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 104.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADqElEQVQ4y21Ua2/bRhDk///aD0WBfmiRAm1ToCkSoCiQBq2jxKlsvSzqQVLi+yG+RZGSLBu1prsrU3GNCFgcJN3Nzc7MnnI9mcJ3XRR5jjzLkMQxqpLWyMcqCpEXObIsQUr/lesCfuAjDCKkaYokSZDTubIs4HkB0jiCkpU1mrrBel1ht22QrBtcGTH6ZgY/ShCFITabCvEqpnWD/X6Pptni9vZW6nA44O7uDrvdHneHWygfO29x1b3EoN9H76qL3nCMkRmjp/lIskIY13RhnuWoqg3u7+/PYAzO63a7pUtqujyB8u13X+OHn37Gy1/f4MWPv+D3P97isGsQBx61FkpLMYGmaSZrkqTY1DU2VUUXVMK6KAppu9cfEuDrPr562cE3v3Xx/Z8a3nxaCBPf86DrBtQbFVN1gvlsDnWsEouI2DQCxOuJ3Rb31O5obkN51+lC1UyM50tMdBuWF6GmjWyUsVjAdVzR0fd9BH5wBquJJZsYx4kw507CKIbSvephaeiYTSewLZPEj8igNbnmYj6fkcPZqTVizWwYrAVcRREWxpLOTuXCjJxXOpddjEYjmKaFsapiNpsJgMsMqeUpxUodj+HYroC0gFx8AV/o2DbiJJYYKRcdcnjQh2EYAmxZFira7Di2gFumCV3TiMnizKwt/r4uSzLkVAyuvP9wifH4RgxYLpfUqvfYskdgFra73WeAR2dbd9flGjbt0XSdWDrStnJBgLquwSRmzEgjNrw5DANhx9Hh7y3I02KD0jQRvaNoReasoPx10UGvd40pCTscDglcl43c+oQ0ZW2F4bN225Z5TUk/y7KRsCnvP3zCiIBGoxsENKfMkseQTWHt/OBzVJ7XlkbVcz25PCTHRcO/Ox/Ru74WHQaDAQV4hl1dSSQ8Al2tVrQx/yIgPxCsNbfMYJ5HGtquj+PDg4zPngwoNw0GLgE+BlYCTTrWTwLdasph5nNcbBBfoExmGvjDr4VB5rzr/INX6gYm5c4k1zku5tIUBlmeyVoU5f+0ZElESwY0HQ8PD//KD8zGJj0Ou1r05GyyRgzIITdpkjRNl9Z4f/UkRlyi4WRuEL+jpL59jiqJTUjhdk7RIT0beQSaM5vnevJvfEZZWo60fDweH1vfnUdPoxfGorEqKeithl/K43m2yUClN7yhw460x5PCK7OI6U+bsuXT087mcLVhfp7HlnFEnSgLYsiTElDemDKD8mFD5xdoJprxA8Hv4cnx076nxUD8H0v0HysIC+BNy+NRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/8ac56/image-14.webp 240w,
/static/ff4901184468bdbffd12fe366e0a50f0/dca0e/image-14.webp 426w&quot;
              sizes=&quot;(max-width: 426px) 100vw, 426px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/8ff5a/image-14.png 240w,
/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png 426w&quot;
            sizes=&quot;(max-width: 426px) 100vw, 426px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png&quot;
            alt=&quot;image-14.png&quot;
            title=&quot;image-14.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、次のような出力の後にCommandウィンドウから操作が可能になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Connected to Windows 10 10586 x64 target at &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Mon Oct  4 17:32:25&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;121 2021 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UTC &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 9:00&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ptr64 TRUE
Kernel Debugger connection established&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Symbol search path is: srv*
Executable search path is: 
Windows 10 Kernel Version 10586 &lt;span class=&quot;token function&quot;&gt;MP&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1 procs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Free x64
Edition build lab: 10586&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;162&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;amd64fre&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;th2_release_sec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;160223-1728
Machine Name:
Kernel base = 0xfffff803`5280b000 PsLoadedModuleList = 0xfffff803`52ae9cd0
System Uptime: 0 days 0:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;121
KDTARGET: Refreshing KD connection
&lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first chance&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;   You are seeing this message because you pressed either                    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;       CTRL+C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; you run console kernel debugger&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; or&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;                       &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;       CTRL+&lt;span class=&quot;token keyword&quot;&gt;BREAK&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; you run GUI kernel debugger&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;                          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;   on your debugger machine&apos;s keyboard&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                                      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                   THIS IS NOT A BUG OR A SYSTEM CRASH                       &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; you did not intend to &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt; into the debugger&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; press the &lt;span class=&quot;token string&quot;&gt;&quot;g&quot;&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; then   &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; press the &lt;span class=&quot;token string&quot;&gt;&quot;Enter&quot;&lt;/span&gt; key now&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  This message might immediately reappear&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; it &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; does&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; press &lt;span class=&quot;token string&quot;&gt;&quot;g&quot;&lt;/span&gt; and &lt;span class=&quot;token string&quot;&gt;&quot;Enter&quot;&lt;/span&gt; again&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                                          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
nt!DbgBreakPointWithStatus:
fffff803`52952eb0 cc              int     3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルモードデバッグでモジュール一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルモードデバッグでモジュール一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグでモジュール一覧を表示する&lt;/h3&gt;
&lt;p&gt;カーネルモードデバッグの場合でも、Commandウィンドウから行う基本的な操作は、&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;こちらの記事&lt;/a&gt;で紹介したユーザモードデバッグとほぼ同一です。&lt;/p&gt;
&lt;p&gt;試しに、&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;コマンドを実行して読み込まれているモジュールの一覧を出力してみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y62TaXObQAyG+f9/qtNPPdIG2OVawuX6xE7ABgzG11tpfYzTZuqmU808s9ICL9JKa1jSw8Oj1AhXwRQBvpkubCeEG2ZwgggqzhASKrohvoHi4CmF8kMYHz6Z+PhF4LOlYKsB5NOQGEGEQ5hBBksz0M8c2j89/x0nGuHhqw0jjkIMshT5bIri5RnVaol+02G37YHjAdou6x0rVxUMpRSyLEOapphOp8jzHIvFAquqQtu2OBxOYsfjkXzi+Abnd/LFM4zRaKTFkiShNUNCflEU2O126LoOm83mKvgn2OYs+EJlclaTyYTWGRbzuRZsmkYL9n2Pv7WqWcNI4hjD4RBlWaIol3QONeq6RkUlM5zhfr/XGf/Kdru9wnHTdjCiKEJM5WZJhGS6QjavdZNYhM+GM+QPeGX4B5eY/QscVzVlaNs2PM+HFBa8wQuS2Qqh72J/OOC9tm43MBxHIggUfFfC/1HAH9c0qIkum7O814zbppwFHRIM4JFgNC4QTip4KsJ6vdYlv0+QzlDKU4aeIxCOl0jzGpHy8S/Wdj0MIQSdoQdXCrjxBDKZ0Z30aHTKV92+B1+Cckk3paGPeN544wKXy7zydXzmvHcLd1qPDf6zGUI6cFwP8g2u+w75NFqeH2jYt2yJR9M+YdmwhcR3U+AnWWa+Jd832uIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1d792de8449ddeac48b488e2dd683b09/8ac56/image-12.webp 240w,
/static/1d792de8449ddeac48b488e2dd683b09/d3be9/image-12.webp 480w,
/static/1d792de8449ddeac48b488e2dd683b09/e46b2/image-12.webp 960w,
/static/1d792de8449ddeac48b488e2dd683b09/f992d/image-12.webp 1440w,
/static/1d792de8449ddeac48b488e2dd683b09/bb6b4/image-12.webp 1470w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1d792de8449ddeac48b488e2dd683b09/8ff5a/image-12.png 240w,
/static/1d792de8449ddeac48b488e2dd683b09/e85cb/image-12.png 480w,
/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png 960w,
/static/1d792de8449ddeac48b488e2dd683b09/07a9c/image-12.png 1440w,
/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png 1470w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png&quot;
            alt=&quot;image-12.png&quot;
            title=&quot;image-12.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;x nt!MmCreate*&lt;/code&gt;を実行して、ntモジュールのいくつかのシンボル一覧を取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; x nt!MmCreate*
fffff803`52bd46ac nt!MmCreateTeb &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateTeb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c5733c nt!MmCreatePeb &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreatePeb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`528ecfb8 nt!MmCreateMdl &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateMdl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`528a5fc8 nt!MmCreateSystemSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSystemSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c08c40 nt!MmCreateSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c4a2fc nt!MmCreateProcessAddressSpace &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateProcessAddressSpace&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c08d30 nt!MmCreateCacheManagerSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateCacheManagerSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c88c8c nt!MmCreateSpecialImageSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSpecialImageSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`5281cda0 nt!MmCreateKernelStack &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateKernelStack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52e2e838 nt!MmCreateMirror &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateMirror&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルモジュールにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルモジュールにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモジュールにブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;bu nt!MmCreateProcessAddressSpace&lt;/code&gt;を実行し、ブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; bu nt!MmCreateProcessAddressSpace
kd&gt; bl
     0 e Disable Clear  fffff803`52c4a2fc     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; nt!MmCreateProcessAddressSpace&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを実行してWindowsカーネルの実行を再開すると、新しいプロセスが起動するごとに設定したブレークポイント設定により、その都度カーネルが停止し、WinDbgによるデバッグモードに移行します。&lt;/p&gt;
&lt;p&gt;例えば、今回はターゲットマシン環境でMicrosoft Edgeアプリケーションを起動してみました。
すると、新たなプロセス起動時の処理で&lt;code class=&quot;language-text&quot;&gt;nt!MmCreateProcessAddressSpace&lt;/code&gt;が呼び出されたため、カーネルが停止し、WinDbgでのデバッグが可能になります。&lt;/p&gt;
&lt;p&gt;ここから、WinDbgによりWindowsカーネルの処理をステップ実行したり、スタックトレースを参照したり、レジストリの情報を書き換えたり、といった操作が可能になります。&lt;/p&gt;
&lt;p&gt;以下の画像は、Microsoft Edgeの起動中の状態までステップ実行し、スタックトレースを出力した状態の画像です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAADCElEQVQ4y32Sa2hTZxjHX9aKOrygHQ76XfwgXkA7cIidNa013ot2Tu2F2mlTp9YLVRHRwawtVhG8tV5WrZPJsurWffLzGCKbdDPNSZpLkxMTk5MmNuklvfe395z4QVF84M/7f98DP57/cx7xT0cHXS4vnUoXTpcHxeHGLuWQb/rd7fV9UF3y26uwhqW6BiGmMnX6XDIyP0U8ffY3iqsbh7sbj+8lXjVIIKQR0uJoscQb9b7l0wpHXzMwNMp3h2olcCYzZmUzTUKF0+kgEFB5FQoRjWr0RKOMDA8xPj7Gx2pyctI4Dx87JYEZiE/myHM6Qg0ECIfD+P1+VFUlHImQSqUYGh5mdHRUaozhN35iYuI98C/W39lVso/KfQcpr6hCKIpCMBgkIkHxeJxEIkFvby+vpfS6fd+KubiSbeXV5Jq/oWBrGWuLKigotlCwfS/rd1SxZdd+Nu+0sLnkAKLb5yfZn6K/v5+RkREZddzoJpUaMoAn65sRs5ZiqmrAcvUJpfVtlDY8pqzxD8outFPS0MbuOqt8e8TsxRsRHS/sRDWNZF+fAdPj6TU2no539k47YsEGltX+xiZrisK7EQrvRTG3apjvR1jXmtaGn+N8bj6B+NfmQPX7jPnpkfX4uk8kkwbw+yt3JdDMoiNtrG0JknfdxZomD6uuu/nqhtvwefLMv+Una2s94j+bQigURJNdDg4OGlBdAwODBrDu4jUysnMk8FfZWVgC3OTe8LL/UZCvf1INb2r2UnBH5bONZxHPnr/A3mnDZrMZnTmdTlwulzFTvX641ISYt4RFNQ/fAVZaX7Kt1S+7fAu45TzCrjiJxWLyL8sd7ImRlFH1TvXV0etc4xWmzFvI4kMPjFnpwPybXgmVUWVc3ZuaPWmgWe6kpkU/usCXr7WQOWc+86taMN3rMbrLbfKx+qbK6ltq+mz2s+bHEFm5FsRffz7FYe+iU87S3ulAkV6/697r8XH6TB05X+axfk8tRUcayf/2DPnVdawsPc4XxYdZvr2GnOKjrNh9ghxTEf8DP8EcKp4eO4EAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/8ac56/image-15.webp 240w,
/static/4971cbcbb8730b99f99fd16584f1a897/d3be9/image-15.webp 480w,
/static/4971cbcbb8730b99f99fd16584f1a897/b0a15/image-15.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/8ff5a/image-15.png 240w,
/static/4971cbcbb8730b99f99fd16584f1a897/e85cb/image-15.png 480w,
/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png&quot;
            alt=&quot;image-15.png&quot;
            title=&quot;image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgを用いたカーネルデバッグの設定方法と、簡単な操作について紹介しました。&lt;/p&gt;
&lt;p&gt;実際にカーネルデバッグを用いてトラブルシューティングを行うテクニックについては、また違う記事でまとめていく予定です。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgのユーザモードデバッグチュートリアルを試してみた]]></title><link>https://kashiwaba-yuki.com/windows-windbg-002-tutorial</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-002-tutorial</guid><pubDate>Tue, 05 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;今回はとりあえず公式チュートリアル内の手順を再現して、WinDbgによるユーザモードプロセスのデバッグについて試してみました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#widbg%E3%81%A8%E3%81%AF&quot;&gt;WiDbgとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB&quot;&gt;WinDbgチュートリアル&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回使用する環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%81%AE%E8%B5%B7%E5%8B%95&quot;&gt;Notepad.exeの起動&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot;&gt;シンボルパスの設定と読み込み&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E4%B8%80%E8%A6%A7%E3%81%AE%E5%87%BA%E5%8A%9B&quot;&gt;シンボル一覧の出力&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;ブレークポイントの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot;&gt;Notepad.exeを実行する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;プロセスに読み込まれているコードモジュールの一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;スタックトレースを表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B&quot;&gt;Notepad.exeを再開する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AB%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot;&gt;ファイル書き込み時にプロセスを停止する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%86%85%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;プロセス内のスレッド一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;特定のスレッドのスタックトレースを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E7%B5%82%E4%BA%86%E3%81%97%E3%81%A6%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%8B%E3%82%89%E3%83%87%E3%82%BF%E3%83%83%E3%83%81%E3%81%99%E3%82%8B&quot;&gt;デバッグを終了して、プロセスからデタッチする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;widbgとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#widbg%E3%81%A8%E3%81%AF&quot; aria-label=&quot;widbgとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WiDbgとは&lt;/h2&gt;
&lt;p&gt;Windows環境のデバッグやトラブルシューティングに使用するツールです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windows-debugging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows のデバッグの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WinDbgは、主に以下の用途に利用されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windowsメモリダンプやプロセスダンプの解析&lt;/li&gt;
&lt;li&gt;カーネルモードのライブデバッグ&lt;/li&gt;
&lt;li&gt;ユーザモードのライブデバッグ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MicrosoftのWindows開発チームも使用している公式のデバッガです。&lt;/p&gt;
&lt;p&gt;VisualStudioデバッガとの違いとして、WinDbgはカーネルモードのデバッグやスレッドスタックの分析まで実現することができます。&lt;/p&gt;
&lt;h2 id=&quot;windbgチュートリアル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB&quot; aria-label=&quot;windbgチュートリアル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgチュートリアル&lt;/h2&gt;
&lt;p&gt;WinDbgのはじめの一歩として、&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;公式ドキュメントのチュートリアル&lt;/a&gt;を実践していきます。&lt;/p&gt;
&lt;p&gt;このチュートリアルでは、WinDbgを使用してユーザモードのプロセスにアタッチし、デバッグを行います。&lt;/p&gt;
&lt;h3 id=&quot;今回使用する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回使用する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回使用する環境&lt;/h3&gt;
&lt;p&gt;今回使用している環境は以下の環境です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows10 20H2&lt;/li&gt;
&lt;li&gt;WinDbg 10.0.22000.1 AMD64（管理者権限で起動）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;notepadexeの起動&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%81%AE%E8%B5%B7%E5%8B%95&quot; aria-label=&quot;notepadexeの起動 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeの起動&lt;/h3&gt;
&lt;p&gt;Windows環境でWinDbgを起動した後、[Ctrl+E]キーで[Open Executable File]を呼び出し、&lt;code class=&quot;language-text&quot;&gt;C:\Windows\System32\notepad.exe&lt;/code&gt;を選択します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211002113631533.png&quot; alt=&quot;image-20211002113631533&quot;&gt;&lt;/p&gt;
&lt;p&gt;実行ファイルを開くと、Commandウィンドウが起動しました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211002113723502.png&quot; alt=&quot;image-20211002113723502&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;シンボルパスの設定と読み込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;シンボルパスの設定と読み込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルパスの設定と読み込み&lt;/h3&gt;
&lt;p&gt;Commandウィンドウの下部にあるコンソールに、以下のコマンドを入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath srv*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.sympath&lt;/code&gt;コマンドは、シンボルパスを設定するコマンドです。
シンボルパスとは、デバッガがシンボルファイルを探す際の探索先を意味します。&lt;/p&gt;
&lt;p&gt;シンボルファイルは、デバッガがコード モジュール (関数名、変数名など) に関する情報を取得するために必要です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-sympath--set-symbol-path-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.sympath (シンボル パスの設定) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;シンボルパスの設定が完了したので、以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドによって、シンボル情報を削除した後、再読み込みします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-reload--reload-module-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.reload (モジュールの再読み込み) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行しても、特にレスポンスはない点に注意が必要です。
以下の出力が得られたら次に進みます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload
Reloading current modules
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;シンボル一覧の出力&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E4%B8%80%E8%A6%A7%E3%81%AE%E5%87%BA%E5%8A%9B&quot; aria-label=&quot;シンボル一覧の出力 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボル一覧の出力&lt;/h3&gt;
&lt;p&gt;上記の出力確認後に、&lt;code class=&quot;language-text&quot;&gt;x notepad!*&lt;/code&gt;コマンドを実行して&lt;code class=&quot;language-text&quot;&gt;Notepad.exe&lt;/code&gt;モジュールのシンボルを表示します。
※ ここで出力が得られない場合は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを再実行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/x--examine-symbols-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x notepad!*&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;出力結果は1500行近い数になりました。
かなり多いですね。&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;ブレークポイントの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントの設定&lt;/h3&gt;
&lt;p&gt;次に、上記の出力で確認したシンボル情報を用いて、wWinMain関数にブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bu notepad!wWinMain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;特に出力は返ってきませんが、&lt;code class=&quot;language-text&quot;&gt;bl&lt;/code&gt;コマンドでブレークポイントの一覧を参照できます。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bl--breakpoint-list-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;bl (ブレークポイントの一覧) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これで、&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;にブレークポイントが設定されたことが確認できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu notepad!wWinMain
0:000&gt; bl
     0 e Disable Clear  00007ff6`8402c0f8     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; notepad!wWinMain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;notepadexeを実行する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot; aria-label=&quot;notepadexeを実行する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeを実行する&lt;/h3&gt;
&lt;p&gt;ブレークポイントの設定が完了したので、&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで起動しているアプリケーションを実行します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/g--go-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;g (実行) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ブレークポイントで設定されたwWinMain関数の呼び出し時点で停止しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; g
ModLoad: 00007ff9`9cd70000 00007ff9`9cda0000   C:\WINDOWS\System32\IMM32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL
Breakpoint 0 hit
notepad!wWinMain:
00007ff6`8402c0f8 488bc4          mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセスに読み込まれているコードモジュールの一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセスに読み込まれているコードモジュールの一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセスに読み込まれているコードモジュールの一覧を表示する&lt;/h3&gt;
&lt;p&gt;ブレークポイントでプロセスが停止した状態で&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;コマンドを実行し、現在プロセスに読み込まれているコードモジュールを確認します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/lm--list-loaded-modules-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;lm (読み込まれたモジュールの一覧表示) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
00007ff6`84020000 00007ff6`8405a000   notepad    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\Program Files &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x86&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\Windows Kits\10\Debuggers\x64\sym\notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\6539CE998C7CAFD73A8E13A54542E1121\notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
00007ff9`8ef30000 00007ff9`8f1ca000   COMCTL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`982c0000 00007ff9`98350000   apphelp    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9aa40000 00007ff9`9aadd000   msvcp_win   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9ab90000 00007ff9`9ae59000   KERNELBASE   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9aec0000 00007ff9`9afc0000   ucrtbase   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9b010000 00007ff9`9b11b000   gdi32full   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9b340000 00007ff9`9b362000   win32u     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9bbc0000 00007ff9`9bcea000   RPCRT4     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9bf20000 00007ff9`9c275000   combase    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9c3c0000 00007ff9`9c46e000   shcore     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cc50000 00007ff9`9cd0e000   KERNEL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cd70000 00007ff9`9cda0000   IMM32      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cfd0000 00007ff9`9cffb000   GDI32      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d000000 00007ff9`9d1a1000   USER32     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d1b0000 00007ff9`9d24e000   msvcrt     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d290000 00007ff9`9d485000   ntdll      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\Program Files &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x86&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\Windows Kits\10\Debuggers\x64\sym\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\E2BF5EA3ECAA1D5310F1E166306A0BCC1\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;スタックトレースを表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;スタックトレースを表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックトレースを表示する&lt;/h3&gt;
&lt;p&gt;プロセスが停止した状態で&lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt;コマンドを実行して、スタックトレースを表示します。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;で停止したタイミングでのスタックトレースを取得できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f11f7b8 00007ff6`840459b6     notepad!wWinMain
01 00000055`5f11f7c0 00007ff9`9cc67034     notepad!__scrt_common_main_seh+0x106
02 00000055`5f11f800 00007ff9`9d2e2651     KERNEL32!BaseThreadInitThunk+0x14
03 00000055`5f11f830 00000000`00000000     ntdll!RtlUserThreadStart+0x21&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;notepadexeを再開する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B&quot; aria-label=&quot;notepadexeを再開する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeを再開する&lt;/h3&gt;
&lt;p&gt;もう一度&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを実行すると、中断されていたプロセスが再開され、メモ帳アプリが起動しました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003210626408.png&quot; alt=&quot;image-20211003210626408&quot;&gt;&lt;/p&gt;
&lt;p&gt;この状態では、デバッガはBusy状態となり、追加のコマンド入力を受け付けなくなります。&lt;/p&gt;
&lt;p&gt;再びメモ帳プロセスを停止してデバッガを使用するために、Breakボタンか、[Ctrl+Break]キーを押します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003211015461.png&quot; alt=&quot;image-20211003211015461&quot;&gt;&lt;/p&gt;
&lt;p&gt;これで再度メモ帳プロセスが停止され、デバッガ操作が可能になりました。&lt;/p&gt;
&lt;h3 id=&quot;ファイル書き込み時にプロセスを停止する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AB%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot; aria-label=&quot;ファイル書き込み時にプロセスを停止する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ファイル書き込み時にプロセスを停止する&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;bu ntdll!ZwWriteFile&lt;/code&gt;を実行して、ファイル書き込み時にプロセスを中断するためのブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:002&gt; bu ntdll!ZwWriteFile
0:002&gt; bl
     0 e Disable Clear  00007ff6`8402c0f8     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; notepad!wWinMain
     1 e Disable Clear  00007ff9`9d32ce60     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; ntdll!NtWriteFile&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再び&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを入力してプロセスを再開したのち、メモ帳に書き込み保存を実行しようとすると、プロセスが停止されます。&lt;/p&gt;
&lt;p&gt;このタイミングでスタックトレースを表示すると、書き込み時のスタックトレースを取得することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f8fdb78 00007ff9`9bc1f6f4     ntdll!NtWriteFile
01 00000055`5f8fdb80 00007ff9`9bc0c641     RPCRT4!UTIL_WriteFile+0x5c
02 00000055`5f8fdbe0 00007ff9`9bbf5863     RPCRT4!NMP_SyncSend+0x81
03 00000055`5f8fdc60 00007ff9`9bbf2a56     RPCRT4!OSF_CCONNECTION::TransSendReceive+0xf7
04 00000055`5f8fdcd0 00007ff9`9bbf239b     RPCRT4!OSF_CCONNECTION::SendBindPacket+0x2ee
05 00000055`5f8fdf20 00007ff9`9bbf3ed1     RPCRT4!OSF_CCONNECTION::ActuallyDoBinding+0xeb
06 00000055`5f8fdfd0 00007ff9`9bbf3c0e     RPCRT4!OSF_CCONNECTION::OpenConnectionAndBind+0x225
07 00000055`5f8fe080 00007ff9`9bbf7736     RPCRT4!OSF_CCALL::BindToServer+0xce
08 00000055`5f8fe120 00007ff9`9bbf84d6     RPCRT4!OSF_BINDING_HANDLE::InitCCallWithAssociation+0x8a
09 00000055`5f8fe180 00007ff9`9bbf75e7     RPCRT4!OSF_BINDING_HANDLE::AllocateCCall+0x256
0a 00000055`5f8fe2e0 00007ff9`9bca00f5     RPCRT4!OSF_BINDING_HANDLE::NegotiateTransferSyntax+0x37
0b 00000055`5f8fe330 00007ff9`9bca3840     RPCRT4!NdrpClientCall3+0x715
0c 00000055`5f8fe6a0 00007ff9`99bc139e     RPCRT4!NdrClientCall3+0xf0
0d 00000055`5f8fea30 00007ff9`775c1e00     wkscli!NetWkstaGetInfo+0x5e
0e 00000055`5f8feae0 00007ff9`83c62df6     ntlanman!NPOpenEnum+0x50
0f 00000055`5f8fec40 00007ff9`83c61b7f     MPR!MprOpenEnumConnect+0x176&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセス内のスレッド一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%86%85%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセス内のスレッド一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセス内のスレッド一覧を表示する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~&lt;/code&gt;コマンドを使って、プロセス内のスレッド一覧を取得できます。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/---thread-status-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;~ (スレッドの状態) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;現在のメモ帳プロセスには、以下の14個のスレッドが存在するようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; ~
   0  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;7ac Suspend: 1 Teb: 00000055`5f35c000 Unfrozen
   1  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;22f0 Suspend: 1 Teb: 00000055`5f36a000 Unfrozen
   2  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1500 Suspend: 1 Teb: 00000055`5f36e000 Unfrozen
   3  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;198c Suspend: 1 Teb: 00000055`5f370000 Unfrozen
   4  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;2094 Suspend: 1 Teb: 00000055`5f364000 Unfrozen
   5  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1d6c Suspend: 1 Teb: 00000055`5f372000 Unfrozen
   6  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1048 Suspend: 1 Teb: 00000055`5f368000 Unfrozen
   7  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1408 Suspend: 1 Teb: 00000055`5f374000 Unfrozen
   8  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;30c Suspend: 1 Teb: 00000055`5f376000 Unfrozen
   9  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1b18 Suspend: 1 Teb: 00000055`5f378000 Unfrozen
  10  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;af8 Suspend: 1 Teb: 00000055`5f37a000 Unfrozen
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; 11  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;898 Suspend: 1 Teb: 00000055`5f37e000 Unfrozen
  12  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1720 Suspend: 1 Teb: 00000055`5f380000 Unfrozen
  13  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;37c Suspend: 1 Teb: 00000055`5f382000 Unfrozen&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;特定のスレッドのスタックトレースを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;特定のスレッドのスタックトレースを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;特定のスレッドのスタックトレースを取得する&lt;/h3&gt;
&lt;p&gt;ここで、特定のスレッドのスタックトレースを取得するには、以下のコマンドを続けて使用します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;~0s
k&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~0s&lt;/code&gt;コマンドは、スレッド番号0の設定を取得します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-s--set-current-thread-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;~s (現在のスレッドの設定) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;出力は次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; ~0s
win32u!NtGdiGetCharABCWidthsW+0x14:
00007ff9`9b3465e4 c3              ret
0:000&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f117108 00007ff9`9b01a2ae     win32u!NtGdiGetCharABCWidthsW+0x14
01 00000055`5f117110 00007ff9`9b01a211     gdi32full!LoadGlyphMetricsWithGetCharABCWidthsI+0x5e
02 00000055`5f1174b0 00007ff9`9b019d60     gdi32full!LoadGlyphMetrics+0x99
03 00000055`5f1174f0 00007ff9`8aa29016     gdi32full!CUspShapingFont::GetGlyphDefaultAdvanceWidths+0x150
04 00000055`5f117550 00007ff9`9b020b65     TextShaping!ShapingGetGlyphPositions+0x516
05 00000055`5f117750 00007ff9`9b0266e3     gdi32full!ShlPlaceOT+0x255
06 00000055`5f117970 00007ff9`9b025d9b     gdi32full!RenderItemNoFallback+0x573
07 00000055`5f117aa0 00007ff9`9b025c6b     gdi32full!RenderItemWithFallback+0xeb
08 00000055`5f117af0 00007ff9`9b025a3f     gdi32full!RenderItem+0x3b
09 00000055`5f117b40 00007ff9`9b027ac6     gdi32full!ScriptStringAnalyzeGlyphs+0x20f
0a 00000055`5f117bf0 00007ff9`9b024ca2     gdi32full!ScriptStringAnalyse+0x626
0b 00000055`5f117dc0 00007ff9`9b0246be     gdi32full!LpkCharsetDraw+0x5c2
0c 00000055`5f117ff0 00007ff9`9d01f5f2     gdi32full!LpkDrawTextEx+0x5e
0d 00000055`5f118060 00007ff9`9d01e9bf     USER32!DT_DrawStr+0xb6
0e 00000055`5f118110 00007ff9`9d01eede     USER32!DT_GetLineBreak+0xf3
0f 00000055`5f1181b0 00007ff9`9d01eb50     USER32!DrawTextExWorker+0x36e
10 00000055`5f118300 00007ff9`6b8a6123     USER32!DrawTextW+0x40
11 00000055`5f118370 00007ff9`6b89ac60     DUI70!DirectUI::Element::GetContentSize+0x463
12 00000055`5f118450 00007ff9`6b8a7196     DUI70!DirectUI::Element::_UpdateDesiredSize+0x6a0
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 以下略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;デバッグを終了してプロセスからデタッチする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E7%B5%82%E4%BA%86%E3%81%97%E3%81%A6%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%8B%E3%82%89%E3%83%87%E3%82%BF%E3%83%83%E3%83%81%E3%81%99%E3%82%8B&quot; aria-label=&quot;デバッグを終了してプロセスからデタッチする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグを終了して、プロセスからデタッチする&lt;/h3&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;qd&lt;/code&gt;コマンドを使用して、デバッグを終了してプロセスからデタッチします。&lt;/p&gt;
&lt;p&gt;デバッグを終了すると、Commandウィンドウが終了し、停止されていたメモ帳の書き込み処理が再開されました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003212553671.png&quot; alt=&quot;image-20211003212553671&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;とりあえず&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;公式チュートリアル&lt;/a&gt;のユーザモードデバッグの手順について一通り実践してみました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgの各ウィンドウについてまとめてみた]]></title><link>https://kashiwaba-yuki.com/windows-windbg-003-ui</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-003-ui</guid><pubDate>Tue, 05 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;この記事では、&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;で使用したチュートリアルの環境を利用して、WinDbgの基本的なUI操作についてまとめていきます。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本記事では、以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%81%AEui%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;WinDbgのUIについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-open-souce-file-ctrlo%E3%82%AD%E3%83%BC&quot;&gt;1. Open Souce File ([Ctrl+O]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-insert-or-remove-breakpoint-f9%E3%82%AD%E3%83%BC&quot;&gt;2. Insert or remove breakpoint ([F9]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-command-alt1%E3%82%AD%E3%83%BC&quot;&gt;3. Command ([Alt+1]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-watch-alt2%E3%82%AD%E3%83%BC&quot;&gt;4. Watch （[Alt+2]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-locals-alt3%E3%82%AD%E3%83%BC&quot;&gt;5. Locals （[Alt+3]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-registers-alt4%E3%82%AD%E3%83%BC&quot;&gt;6. Registers （[Alt+4]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-memory-window-alt5%E3%82%AD%E3%83%BC&quot;&gt;7. Memory Window （[Alt+5]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-call-stack-alt6%E3%82%AD%E3%83%BC&quot;&gt;8. Call Stack ([Alt+6]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-disassembly-alt7%E3%82%AD%E3%83%BC&quot;&gt;9. Disassembly ([Alt+7]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-scratch-pad-alt8%E3%82%AD%E3%83%BC&quot;&gt;10. Scratch Pad ([Alt+8]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-processes-and-threads-alt9%E3%82%AD%E3%83%BC&quot;&gt;11. Processes and Threads ([Alt+9]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12--command-brouser-ctrln%E3%82%AD%E3%83%BC&quot;&gt;12.  Command Brouser ([Ctrl+N]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13--source-mode-on&quot;&gt;13.  Source mode ON&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14--source-mode-off&quot;&gt;14.  Source mode OFF&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15--font&quot;&gt;15.  Font&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#16--options&quot;&gt;16.  Options&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;windbgのuiについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AEui%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;windbgのuiについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgのUIについて&lt;/h2&gt;
&lt;p&gt;今回利用しているWinDbgのバージョンは&lt;code class=&quot;language-text&quot;&gt;WinDbg10.0.22000.1 AMD64&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;こちらはWinDbgを起動した直後のGUIです。管理者権限で起動しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAA00lEQVQoz+2TywrCMBBF8/9/Yp+TZ0Oh0tpdv8RHu65d2GtGBVFQobp0cbjJJbnMMIzY7vYY+h7DMKA/XHUcR0zHCfM84/QWPNz5vbAmh/cehXNwAWvtBfaqqkIZ1FkPyhScKSBThcIET4WzLmGNg84zWKXRdR2ElgpEBCnlI8HLA5RloDQFJcldkxgUrUAxawwZvDSKUK3XEFyVMeY1odpPcEdKKWya5hqotb58Zl0C/+WumufAb/gH/jCQR750us9TrusagjeCQ91tU5bCwW3b4gwyrPpYHYlhdwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/8ac56/image-20211001004013146.webp 240w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/d3be9/image-20211001004013146.webp 480w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/b0a15/image-20211001004013146.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/8ff5a/image-20211001004013146.png 240w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/e85cb/image-20211001004013146.png 480w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png&quot;
            alt=&quot;WinDbg起動後GUI&quot;
            title=&quot;WinDbg起動後GUI&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;それぞれのボタンは次の機能を持ちます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;番号&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;機能&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;ショートカット&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Open Souce File&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Ctrl+O&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Insert or remove breakpoint&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;F9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;3&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Command&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;4&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Watch&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;5&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Locals&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;6&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Registers&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;7&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Memory Window&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;8&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Call Stack&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;9&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Disassembly&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;10&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scratch Pad&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;11&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Processes and Threads&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;12&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Command Brouser&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Ctrl+N&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;13&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Source mode ON&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;14&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Source mode OFF&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;15&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Font&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;16&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Options&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;各ツールバーボタンの説明については、以下のリファレンスに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/toolbar-buttons&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ツール バー ボタン - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;各ショートカットについても以下のリファレンスに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/keyboard-shortcuts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Keyboard Shortcuts - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-open-souce-file-ctrloキー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#1-open-souce-file-ctrlo%E3%82%AD%E3%83%BC&quot; aria-label=&quot;1 open souce file ctrloキー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;1. Open Souce File ([Ctrl+O]キー)&lt;/h3&gt;
&lt;p&gt;ツールバーの一番左端にある1番のボタンは、&lt;code class=&quot;language-text&quot;&gt;Open Source File&lt;/code&gt;ボタンです。&lt;/p&gt;
&lt;p&gt;このボタンをクリックすると、エクスプローラーウィンドウが開き、ソースファイルをWinDbgで開くことができます。
※ 実行ファイルやプロセスへのアタッチはできません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/file---open-source-file&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;File Open Source File - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Ctrl+O]キーです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 744px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACwElEQVQ4y62Ua2/aMBSG87/3adrUv7KOW7ijtZ1QK6103dgaoAwIuZSkISEJhFshIfDONoShimrVNEsvxwc7j4/tc8wZpgXP8zAej5mlms1mmM/n8H3/1VqtVgjDENxPoQZN12EYBmzbxnQ6ZfDJZMKgFB4tEPlTpq2/XC7RbDaRyWRQLpfBtdttWJYFRZHRM4cY2A6mBEZXXSwWTMuddd0RNK0Dx1bwaI3IouM9MBaLMSgnd0WozhS6PcLQdeG4Hgvf9wMEQQCfiPo0Gp3s5Olpgc1mw3bhkPm0iaKIVCqFYrEIThLbaOhDiPoA3miEh55OIiFgJ5LD/MHARk/rkZ0orE+PR9M0mKaJer0Bnk8hn8+D68kiytIEd5oHhD5bkUbwkqLxNdV6zXxJkpBMJlEoFMB1JQWucQfXFBGs1vsPnjf61x68848CZUmG3lehGz2Eq/CvER7qKFCRuug5MyiWh/Uq+A9AWYJGbtgYOOQ2Xw988QxVEmFNtdDV+tiEIf6lybL8B9ghObR8IhVAknlE0oYmORVNh6hvWSbzD6UbfQy9MeYLH/XGPXiSh9tLIfSAJC7NeMex0Wq1YFJgv0/ybcDycDgcYryrc2pHxK9Lj7iqNnFzr+LqVkAmzW/zUBAEVse0CuhZfK9WIbV/4cO1gjfpLk5KMk4u+nh3YeH9hUlk4e1ZHxWhjdrdDwi1GiqVCtLp9BaYSCRYHVLF43EkSeixj6coXt7ia8vAdV3F/eMEXTeAaPsQHR8dYk9TWSTiMdDv6fnlcrktkO77ubLZLG5uv0FTZZh6D7PxKErvvS19OmeQ6BsKoz5Hfw5FB+ircfXlBu22iAl5zo61fOkMWTIvAu0jPAbMkQjPP1+iKjTQIaUpyg9E6k4P6BCbLZTI/OweSC0DRp1I0SDdNj1onufZ08TvFPX3ix/AqH4DkP5bgP7PKQEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/8ac56/image.webp 240w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/d3be9/image.webp 480w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/43142/image.webp 744w&quot;
              sizes=&quot;(max-width: 744px) 100vw, 744px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/8ff5a/image.png 240w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/e85cb/image.png 480w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png 744w&quot;
            sizes=&quot;(max-width: 744px) 100vw, 744px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png&quot;
            alt=&quot;image-20211004094912087&quot;
            title=&quot;image-20211004094912087&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ソースファイルを開くと、以下のようにWinDbg上でソースファイルの中のソースコードを参照することができます。
※ これは読み取り専用であり、書き込みはできません。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 299px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 102.91666666666669%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAClUlEQVQ4y+1Ua1PaUBDNX+6v6IdWW/3UT52ORVEiPtuZPkRAQMtDQWDGcSY8k5AQkmASEMIjp5tU5anjD+jOnNm92XtPdpOzlzm5SELkeUgNCQ1Rgq5raCoKFAIvCNDbOiRJQq1Wh6a34ZrjOM+CucjfEFkDTVlBvVonL6PVakGWJYiiiDvD8GKer0PV9CfCR3OcMcbjCRhTv/MSIi9gMBzAMkwoROia+yJJbGA0cmAad14HQl2APRyiramoUQHzxpxFfyOVSuE8cY7Lyytk0hkkKM5ms0jEE4idxfAnmUI6nfbWbu4qm8NlJoN4LIHcdR6FQgH5fMHzzPraG2x8+YSjgwPsB1ns7bJgA9tgd/wUB3CwF0SQ3cHuA/Zoz6M/3Kcc7XHhnguyATD+bzFsHkXgOwx72DyO0Dr8sD6Fj2J3vfXwfCbnITwDZp2N4oM/hFX/KVa2fmF1K4QVXxQftyN47wthLXCOdcK7ryd4+/kn7Y1i45SDL1JaCuZ76BahRA3RZBk/ImWcJTlCDuGLrId4uoh4pojcTQVZgusLnIhiqUEQF8AIfA/0w2CZQFMCRkOgY7WhthQPlmmg27HwWmNkeUBaI7KmQHoTSNQy+n17YeOYtOfB1ZvnncmzKTAcp+L+niqkEnXSpGlaRNiHQwcn4qUpGI2eBD3vZyrs9TpeIAg8TYZAE1GjSmV0SdRGqQSzUkFPVaGRxjo0ihZNj0HTMz2CM4RDUr1rPC+hWLxFJnONOt+ARuPWqVRhVquwaNb7ND1Wu03f15ohWiDsdv9VWKs5KJfH4LgxVdqHpimTlqfbnzq8tGWV2nkuifnDS77hQoWDwWAu6bx4Pb30QzxC2+7P3XHL41fr0LbtV7X8n/BZ+wuQyiKaGETlqAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/8ac56/image-20211004095157514.webp 240w,
/static/01d3f515f70810b9c6bd7fcf58b31018/cf880/image-20211004095157514.webp 299w&quot;
              sizes=&quot;(max-width: 299px) 100vw, 299px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/8ff5a/image-20211004095157514.png 240w,
/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png 299w&quot;
            sizes=&quot;(max-width: 299px) 100vw, 299px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png&quot;
            alt=&quot;image-20211004095157514&quot;
            title=&quot;image-20211004095157514&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-insert-or-remove-breakpoint-f9キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2-insert-or-remove-breakpoint-f9%E3%82%AD%E3%83%BC&quot; aria-label=&quot;2 insert or remove breakpoint f9キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2. Insert or remove breakpoint ([F9]キー)&lt;/h3&gt;
&lt;p&gt;2番のボタンは、&lt;code class=&quot;language-text&quot;&gt;Insert or remove breakpoint&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;アクティブなウィンドウがSourceウィンドウか、Disassemblyウィンドウのときのみ利用可能です。&lt;/p&gt;
&lt;p&gt;このボタンを任意の箇所を選択した状態で押すことで、ブレークポイントの設定を切り替えることができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは、[F9]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/edit---breakpoints&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Edit Breakpoints - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;例えば、次の例では、メモ帳アプリの&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;にブレークポイントが設定されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 827px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACc0lEQVQ4y41UaXPaMBD1//8h/dR2SpurkGAwBEomCSUTfBuDHaIANrdtsA2vK9F2SDOdiTRv3q5krfaSJdXqYTJ6wYjwwhjhGWEYIAwCzOdTIUfrNbIsQ5qmyAjpljhLkeeE7DfyA6SPha8olRVcynWcFxV8L1ZROLnCt/MySrR2VW3g4pL2SjWc0X5J5vo1TstNnJVkWpch15qEHwLSh9MaCuVbnCgdFCptXDRVyHcOwRaotB2U7yzI97YAl5WOi+pPF5V7B9V2T8gK10mWlMYNbNOApnahdh9h6BpGLwyr5ULwZDyCRfuc2fMQz8MnSsFKIIkjxNFaMNezdAvpSmnAtixoug7DMNDtduF5HpbLJYbDocDDwwMY5dft9xGEIaIoxoryGicJojhGQsz1PM8h8bgtyxQGVVXFZDIBH/yj8XiMxWJBhQnx3iHJyg/YhgVd1clTG5tkczAYJZgGU2SbTOj7/f5dkOSbJswnyuFAIzZB2TgYpBkmITY0dzSxf230+JJjWWp9bsP7MoD9yQa7YEjvUqAFZNcZ4lqMvJED1tvQ/hh6E3K9cIt+0YVT7KF/2cdj4RGz6xnSTop5a45ACWBXbHi+J4rGi/SvV69CLrcaMAY6NFeD4RlwmStC5KH6oQ+2YGBTRq9mLgrGq/8/74SH1XqLimLCJFimRb2oYjwaIxgHYEOGYBLA93xhcLfbidbg4M+Q83a7/Qu+Jsl1KgqFousGtY+FTqcjPOGtEtB75q2jaRrW1GfcO95GMfUel1erlQDfi6JIsNS4uadGHsB1Xfi+D8dxDj8B+hlwg7PZDL1eT1zCD/ODx8y/Ox6/ABN9DwDfehLgAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/8ac56/image-1.webp 240w,
/static/9e742535d0952d27bb42e42a2c33e5bb/d3be9/image-1.webp 480w,
/static/9e742535d0952d27bb42e42a2c33e5bb/97d4f/image-1.webp 827w&quot;
              sizes=&quot;(max-width: 827px) 100vw, 827px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/8ff5a/image-1.png 240w,
/static/9e742535d0952d27bb42e42a2c33e5bb/e85cb/image-1.png 480w,
/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png 827w&quot;
            sizes=&quot;(max-width: 827px) 100vw, 827px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png&quot;
            alt=&quot;image-1.png&quot;
            title=&quot;image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、ブレークポイントに設定された箇所（色のついた行）にカーソルを置いた状態で&lt;code class=&quot;language-text&quot;&gt;Insert or remove breakpoint&lt;/code&gt;ボタンか、[F9]キーを押すことで、ブレークポイント設定を解除できます。&lt;/p&gt;
&lt;p&gt;逆に、ブレークポイントに設定されていない箇所（色のついていない行）でこのボタンを実行することで、新たなブレークポイントを設定することもできます。&lt;/p&gt;
&lt;h3 id=&quot;3-command-alt1キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#3-command-alt1%E3%82%AD%E3%83%BC&quot; aria-label=&quot;3 command alt1キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;3. Command ([Alt+1]キー)&lt;/h3&gt;
&lt;p&gt;Commandウィンドウが閉じている状態で3番のボタンをクリックすることで、新たにCommandウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+1]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/view---command&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;View Command - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/99375/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABX0lEQVQ4y62S626CQBBGef93apPGWBMRqtwE8RIVUbGFcL8ofJ1dg7a/1NZNTmaW7J6d2UV46bzjtdMnRLz1ZHTFEaGiJ2l4lw10ByP0hzpExYA4uo0gqROYszVUcw7VWsCwl9CJpfuJ9T7Aehec450IlmUhDHykcYQ0iRBHIfIsxV+HIA5kTCZUpWliOp3BcTaYzxcUHbiuizRN0dDCuq6J5kzTXPOf3whB+hiSaApN06AoCs91XYckSXweBMHd1TVMKJOQta2qKsbjMVarFWzb5gewypMkwel0QlVVF47H4685g8l4y6pukNDk7fm+zyuKooi3mmUZ8jxHWZYXCYvtASxvuQo1HQfPQxzHXBKGIYdtaiXt4lvt8pa9wxeCOEMYp7S55Bfcioqi4PGhVw6jmMz1paL/IjibLSXVU2RcuPMOeOYQdvsnC93tHgX9FmVJj/AA7fqcHo6R5We+AWYCM1ya5np/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/8ac56/image-2.webp 240w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/d3be9/image-2.webp 480w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/e46b2/image-2.webp 960w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/f992d/image-2.webp 1440w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/305dd/image-2.webp 1525w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/8ff5a/image-2.png 240w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/e85cb/image-2.png 480w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/d9199/image-2.png 960w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/07a9c/image-2.png 1440w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/99375/image-2.png 1525w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/d9199/image-2.png&quot;
            alt=&quot;image-2.png&quot;
            title=&quot;image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;4-watch-alt2キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#4-watch-alt2%E3%82%AD%E3%83%BC&quot; aria-label=&quot;4 watch alt2キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;4. Watch （[Alt+2]キー）&lt;/h3&gt;
&lt;p&gt;4番のボタンをクリックすることで、Watchウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+2]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/view---watch&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;View Watch - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Watchウィンドウには、グローバル変数、ローカル変数、レジスタに関する情報が表示されます。
Watchウィンドウの詳細については以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/watch-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ウォッチ ウィンドウの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;5-locals-alt3キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#5-locals-alt3%E3%82%AD%E3%83%BC&quot; aria-label=&quot;5 locals alt3キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;5. Locals （[Alt+3]キー）&lt;/h3&gt;
&lt;p&gt;5番のボタンをクリックすることで、Localsウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+3]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---locals&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ローカルの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Localsウィンドウでは、ローカル変数を一覧することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/locals-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのローカル変数の表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;6-registers-alt4キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#6-registers-alt4%E3%82%AD%E3%83%BC&quot; aria-label=&quot;6 registers alt4キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;6. Registers （[Alt+4]キー）&lt;/h3&gt;
&lt;p&gt;6番のボタンをクリックすることで、Registersウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+4]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---registers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;レジスタの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Registersウィンドウを用いたレジスタの表示と編集方法については、以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/registers-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのレジスタの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;7-memory-window-alt5キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#7-memory-window-alt5%E3%82%AD%E3%83%BC&quot; aria-label=&quot;7 memory window alt5キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;7. Memory Window （[Alt+5]キー）&lt;/h3&gt;
&lt;p&gt;7番のボタンをクリックすることで、Memoryウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+5]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---memory&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/61946/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVQoz2WRWW/CMBCE8///VSUkSrnskBCTG2gOOwmECsTRh6nXxZFKHz7NZm1P1mNnNJlh9L7QLDGeckwWHqYswJwLTPkGM+aD+eE/OLGOBtynOm/jOT54AFfkiHc1kr00Gm1rxLpOP9ULjVHat8kKTYkwLxEke32mgpNlGVolEW4E8iyFrEvISlNXULJCo9dIf+varCtZmz1d2+Dr1KM/HtA2Et+POxzPX0OIDVzXRRAIpPoHaZo+NTOaJAmSZy+KYvNNe06nE3qNUg0OhwPud23IuIvVyoXneQjDENvt1pDnucHWZPDaL8sSVVWhKArsdjtcLhc4iyUD50ybrvSkYjAkKA7CmtAhUttr29ZMRtp1HW63G5wl4/B9fzC0JubaGmtGvVdDuvL5fMbxeETf97her3rCxdLkxxgzxnH8m5FVMiWNosjUtk+QEU1mJ3w8HvZRxJAR5UHZkFI+Sqk/SCkNVNN17XT2UX4A7dmNBp/sMPEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/8ac56/image-3.webp 240w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/d3be9/image-3.webp 480w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/e46b2/image-3.webp 960w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/f992d/image-3.webp 1440w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/87ef7/image-3.webp 1546w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/8ff5a/image-3.png 240w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/e85cb/image-3.png 480w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/d9199/image-3.png 960w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/07a9c/image-3.png 1440w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/61946/image-3.png 1546w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/d9199/image-3.png&quot;
            alt=&quot;image-3.png&quot;
            title=&quot;image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Memoryウィンドウの用法については以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/memory-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのメモリの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;8-call-stack-alt6キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#8-call-stack-alt6%E3%82%AD%E3%83%BC&quot; aria-label=&quot;8 call stack alt6キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;8. Call Stack ([Alt+6]キー)&lt;/h3&gt;
&lt;p&gt;8番のボタンをクリックすることで、Call Stackウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+6]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---call-stack&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;呼び出し履歴の表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Call Stackウィンドウにはスタック内の呼び出し履歴情報が表示されます。&lt;/p&gt;
&lt;p&gt;これは、Commandウィンドウで&lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt;コマンドを実行して呼び出したスタックトレースの情報と同一になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8cdda/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACrElEQVQ4y5WUi3KaQBSGef+XadLp1Fya0cTWJvGOoqCgIAJRbmtETaP4d89ikibRpt2Zf87uwvnOZRek62oLlmmi3+/DMAYwTQvjsc3lIgoZV4QwiBFFpBAsjsFYnNk42tkYM5ZJ+pTLo1Cq4KJ4i/PCDc4K17i6qeMsX8JRroDj8xK+5Ms4vrjB528/cVKs4uSqglNuT4u1na0id1nG10IZUq2pIphOEPg+7ikyzyLyp4jDAIqqoz8cwXYnMG0Xk4Dhzo8RsLmYO5NArEnJao3lrxTS0VUL+eYQF/UBctUh8oqHH3qI73qM4m0TRk/FYGBAlpvQNBUdpQ3XddDvaahUylDaLXQ7Cm+LDxpSqdGDMb6DOnTQNV1YE4ZwuYG/2KChaBygQNU0dLtdqKoKhdbc9no9dDodtNttsWeNeCW2Dcmbxjg01J6OWq2KVqslDo0cCVCpVISlIPSMJMuy2JdGbiCcN2mKdLsV2pL4ntymrLoCRg4EIChlovGsq9UsGGXMGMPj4yMBQwEkyLPdzRuyIsrSdR2NRkM4EsCyLLFXr9dFIIIvl8ushw7v2TsgXjKkgzAM412GlDVlSGsCOo6DxWIBaexFfwF2uMNLr+ggqHcEpDllTUCaT6fTrGTb21MyH2m6hc7vIJXpuvyriSLM53OsViskSYLZbIaHhwes1+tnH1Gy7Uz2AjebDQZOwK9MH+ZwKEokeZ4nAjydMvUzCALxPsGlsePtB/IMB5YtehOEoXDaJ59/YaSntTQajQ9kmGLEgyXJ/NX+obHdXTfJOgBcc+DYm2DJT+5Ph7eAt4EkcwdM9wH5T2HxBviRJJP3KTvV9FXENW9yBkz+D/hU8vueAA4vebX7Av51SB1Vw/08QRjxv3M842KI2UysxT/QDxCx++wZ+1i/AT9Vj5Jgo13rAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8ac56/image-4.webp 240w,
/static/8d3483c3e7085965a85ff382babc6f5a/d3be9/image-4.webp 480w,
/static/8d3483c3e7085965a85ff382babc6f5a/e46b2/image-4.webp 960w,
/static/8d3483c3e7085965a85ff382babc6f5a/2768a/image-4.webp 1168w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8ff5a/image-4.png 240w,
/static/8d3483c3e7085965a85ff382babc6f5a/e85cb/image-4.png 480w,
/static/8d3483c3e7085965a85ff382babc6f5a/d9199/image-4.png 960w,
/static/8d3483c3e7085965a85ff382babc6f5a/8cdda/image-4.png 1168w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/d9199/image-4.png&quot;
            alt=&quot;image-4.png&quot;
            title=&quot;image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Call Stackウィンドウについては以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/calls-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのコール スタックの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;9-disassembly-alt7キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#9-disassembly-alt7%E3%82%AD%E3%83%BC&quot; aria-label=&quot;9 disassembly alt7キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;9. Disassembly ([Alt+7]キー)&lt;/h3&gt;
&lt;p&gt;9番のボタンをクリックすることで、Disassemblyウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+7]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---disassembly&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;逆アセンブリの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Disassemblyウィンドウでは、デバッグ対象のアセンブリコードを表示することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAAB7UlEQVQ4y42T626bQBCFef/nqfqvatNUjWOMbdzU3MLN5h6wLRsMNuDTnQXSJqJqRzrM7kh8O7tnV7h7mEFcPGE6f4Ikr7FSDCiGjZ9MPzQ2fragmjZUlpVBRi8+t7HWLWgs3z3MIXz88ojPExnfFyqW2gaTlcH0zMZbyIYHWfewYllxYqbknWKuNWU7wKdvEoTZfAldUxCFAY6HPRzbQpa+4HqpUF8vaJsa7IP/CS/OIIjSEoqiYLv1cDgcoOsGfN9HURQ4n0vUdc3UoG1vuN3G1bQtB7p+BEFaylBVFa7rIssymKYJx3GQ5zmqqkJZlrher/xHijEgLUaxIaAozWHoOvb7PdI0RZIkHHa5XPru6jewsXgDnIgS74hKp1OOsX/+ttVhgQG4DWIIH+4X+CqbWDg7zKyMO0amUGf/ildgn/2QAaeiyIzQ2FYJlCKOIm4IAZumeRXNW3b43IS+NkAHYBAx4ONU5Kb4foDdbgfbtvlZ0phMOh6PXHSutNDpdOIiswboAIzihDqc8WsThiGHbDYbbhA5O5jyp4Y6wYaO2/7aeEHUAXVNYx16HETXh3LT/IY0fLsdgOqkMfccL+xeisYucxBGSF5S2I4LPwhxzAsU7GLnRclzca5QlFU/7ubnsqvl9ACaFprl4hetfNpZnssUCAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/33f9d2be7685707e323d19821c6e993f/8ac56/image-5.webp 240w,
/static/33f9d2be7685707e323d19821c6e993f/d3be9/image-5.webp 480w,
/static/33f9d2be7685707e323d19821c6e993f/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/33f9d2be7685707e323d19821c6e993f/8ff5a/image-5.png 240w,
/static/33f9d2be7685707e323d19821c6e993f/e85cb/image-5.png 480w,
/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png&quot;
            alt=&quot;image-5.png&quot;
            title=&quot;image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Disassemblyウィンドウについては以下を参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/disassembly-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのアセンブリ コードのデバッグ - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;10-scratch-pad-alt8キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#10-scratch-pad-alt8%E3%82%AD%E3%83%BC&quot; aria-label=&quot;10 scratch pad alt8キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;10. Scratch Pad ([Alt+8]キー)&lt;/h3&gt;
&lt;p&gt;10番のボタンをクリックすることで、Scratch Pad ウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+8]キーです。&lt;/p&gt;
&lt;p&gt;Scratch Padとは、テキストを入力し、保存できるクリップボードです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/scratch-pad&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スクラッチ パッドの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;11-processes-and-threads-alt9キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#11-processes-and-threads-alt9%E3%82%AD%E3%83%BC&quot; aria-label=&quot;11 processes and threads alt9キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;11. Processes and Threads ([Alt+9]キー)&lt;/h3&gt;
&lt;p&gt;11番のボタンをクリックすることで、Processes and Threadsウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは [Alt+9]キーです。&lt;/p&gt;
&lt;p&gt;このウィンドウでは、デバッグ中のすべてのプロセスの一覧を参照できます。
以下の画像の例では、&lt;code class=&quot;language-text&quot;&gt;notepad.exe&lt;/code&gt;のプロセスの下に、プロセス内のスレッドがツリー状に表示されています。&lt;/p&gt;
&lt;p&gt;ここで、プロセスの表示は&lt;code class=&quot;language-text&quot;&gt;&amp;lt;デバッガーが使用する内部の10進数プロセスインデックス&gt;:&amp;lt;16進数のプロセス ID&gt; プロセスのアプリケーション名&lt;/code&gt;の形式になります。&lt;/p&gt;
&lt;p&gt;また、各スレッドの表示は、&lt;code class=&quot;language-text&quot;&gt;&amp;lt;デバッガーが使用する内部の10進数のスレッドインデックス&gt;:&amp;lt;16進数のスレッド ID&gt;&lt;/code&gt;を意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/processes-and-threads-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのプロセスとスレッドの制御 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5fe4090a03487b2049385dd4da71bb45/914c7/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACqElEQVQ4y6VTaVPaUBTN//8b/dQPnWqtRcCVRSwKSBLIRkgCQiBh31Hx9N3bhkHq6HT6Zs7c+5Z73l2lqxsFllWHWrVQEdD0Oiy7CbfRFuigG4wQhGOE/QmCnoCQ3WAo9mP0BhOWu5A+fTnB99MUDuIpHCUyODhJ4TCRRuwih6NkVuzTOIynhX4t3oi9kF9j58Img+Oz7F+QPh+nkS/ruC5qyBYqSN8qyJU0Bp3lZROZOxU39zrrt7KFkuZAsZowvAC624Xmdliv1n1IifMM3LoF09CgVVUYWhWqUoapa6xXFBlyuQTHrqHrizTUbdY7fguzyRjz2QTL+QyL+ZSllLy6gee60HUDsqLAMAzYti3yasEwTUaj0eR9rVZDEAQIez10u120Wi0Mh0MsVyssFgusVmvh4WUODc9h0k7Hh+O46AkDMuz3+yx93xd3HZaDwYCNZ/P5H5IVnp+fES3pMnsnSBw0/RCj6Vz8HMLzPDw8PDAhGTw9PTHI8PHxkfXNZsMEJOnNy8sLQ0rlimiLn22vDbPuYTQaiRAbCMMQH62IZL1eMzETHvw4R90W+dJ1lO/vOcR2u82h7Rq9heievN6GnBQ5rKgKqlUNqqpykukBhbFP+JZ3tMgJRVG4cNJVtiiIZGiaJiqtYzwevzL6KNyIsFAooFgsQjo5S4uQa6JdTPaQCrFL9pZ3+/fL5ZKjolxK32IXsGsme1gqlbbFeM+7fUIi2uYwlriA6zrc0JVKhXswaof3CrILIty2TSyeZEJKqCzL25D/Zb0ijCdOBdnv/FFRaKRmsxljOp1iMplsdZoMamrK1y5ehfwzX0AgSBwxelRhSjA1N+lEQogI52LcqJ32QYTRNEnpTI7LTv1HRGRMhruIziLP9xF9TJAKJRmbneH+3/ULnCeSIYVollMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5fe4090a03487b2049385dd4da71bb45/8ac56/image-6.webp 240w,
/static/5fe4090a03487b2049385dd4da71bb45/d3be9/image-6.webp 480w,
/static/5fe4090a03487b2049385dd4da71bb45/e46b2/image-6.webp 960w,
/static/5fe4090a03487b2049385dd4da71bb45/0e613/image-6.webp 978w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5fe4090a03487b2049385dd4da71bb45/8ff5a/image-6.png 240w,
/static/5fe4090a03487b2049385dd4da71bb45/e85cb/image-6.png 480w,
/static/5fe4090a03487b2049385dd4da71bb45/d9199/image-6.png 960w,
/static/5fe4090a03487b2049385dd4da71bb45/914c7/image-6.png 978w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5fe4090a03487b2049385dd4da71bb45/d9199/image-6.png&quot;
            alt=&quot;image-6.png&quot;
            title=&quot;image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;12--command-brouser-ctrlnキー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#12--command-brouser-ctrln%E3%82%AD%E3%83%BC&quot; aria-label=&quot;12  command brouser ctrlnキー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;12.  Command Brouser ([Ctrl+N]キー)&lt;/h3&gt;
&lt;p&gt;12番のボタンをクリックすることで、Command Brouserウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Ctrl+N]キーです。&lt;/p&gt;
&lt;p&gt;このウィンドウでは、コマンドの出力結果を取得することができます。&lt;/p&gt;
&lt;p&gt;実行するコマンドは、Commandウィンドウで入力するコマンドと同一ですが、コマンドの実行履歴などを利用して効率的なコマンド実行を実現できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/command-browser-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのコマンド ブラウザー ウィンドウの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/75b1f/image-7.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+klEQVQ4y4WTCZOiMBCF+f//ao+xxmNAIEC48UAZVlFuS5G3TXad0p1aJ1VfpZNKv7zQjTSTFcw1E4pqQDM4DO7CcgIihMo47TMoOsfccD7QTBfqEDMbjPvQuQfN8qCSjjTTbJjcgWE58KMVuBuQkAk3WGCb7uCFa/wcy5goTMxjWcdoOhfIfy/yohhRnCJaxJCWFGT7HXa7X8iPB8H7e4Is2wPo0bQn2NxCGHjwPReLKEQUBmLexGsc6NyectumRne5QKqbFs9GXlSwuI1NkqKqKjRNI2jbFnVd49J1H2ev1yuksqrFou/7T9wEuU3PCiK4rosoirBer2GaJjjnSNP0X8HmuWBZQabCGUyHYRhQVRWapoExJmLLsoT4arVCEASPgvfj3qGm68LNkGzbtnCq094gmiQJDocDyrJEURRfCx7zkhzpQuwmHIYhuZaF0yzLHvIevuH/HOo6E0KOQ63l+1gul+KZg9vNZoMLVXcYHRXoy6IU9ALPDygxFm6GyuZ5LjidTg8mRFEGB0Ny113RXe+gtXhyUYs/YbGIyJGD7TahC3zhOI5jaqFWOBwY2knqusvTPjyfzzgOTd7TBX33Z6aGFzH6T+el7xMdE83F+IbuE4FgYoT4odj4JlsYG7RmPmbMhUJMVQejNwMvUw0vr28YvU6JMX4DWdzMnEsSmBIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/8ac56/image-7.webp 240w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/d3be9/image-7.webp 480w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/e46b2/image-7.webp 960w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/f992d/image-7.webp 1440w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/f6ed9/image-7.webp 1699w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/8ff5a/image-7.png 240w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/e85cb/image-7.png 480w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/d9199/image-7.png 960w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/07a9c/image-7.png 1440w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/75b1f/image-7.png 1699w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/d9199/image-7.png&quot;
            alt=&quot;image-7.png&quot;
            title=&quot;image-7.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;13--source-mode-on&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#13--source-mode-on&quot; aria-label=&quot;13  source mode on permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;13.  Source mode ON&lt;/h3&gt;
&lt;p&gt;デバッガーをソースモードに切り替えます。&lt;/p&gt;
&lt;p&gt;ソースモードがアクティブである場合、ステータスバーで ASM を使用することはできません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug---source-mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッグソースモード - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;14--source-mode-off&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#14--source-mode-off&quot; aria-label=&quot;14  source mode off permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;14.  Source mode OFF&lt;/h3&gt;
&lt;p&gt;デバッガーをアセンブリモードに切り替えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug---source-mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッグソースモード - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;15--font&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#15--font&quot; aria-label=&quot;15  font permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;15.  Font&lt;/h3&gt;
&lt;p&gt;デバッグウィンドウのフォントを変更できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---font&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;フォントの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;16--options&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#16--options&quot; aria-label=&quot;16  options permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;16.  Options&lt;/h3&gt;
&lt;p&gt;オプションウィンドウを開きます。
オプションウィンドウでは、以下の項目を設定可能です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ソースウィンドウでタブ文字を表示する場合のタブの幅&lt;/li&gt;
&lt;li&gt;同時に開くことができるドキュメントまたはソースウィンドウの数&lt;/li&gt;
&lt;li&gt;ソース言語の解析によるシンタックスハイライトを有効化します&lt;/li&gt;
&lt;li&gt;マウスホバー時の解析を有効化します&lt;/li&gt;
&lt;li&gt;Enterキーで直前のコマンドを再実行する機能を有効化します&lt;/li&gt;
&lt;li&gt;自動スクロール機能を制御します&lt;/li&gt;
&lt;li&gt;ワークスペースをWinDbgに保存する時間と頻度を制御します&lt;/li&gt;
&lt;li&gt;簡易編集モードを有効化します&lt;/li&gt;
&lt;li&gt;表示されるテキストの色を変更します&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---options&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;オプションの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 434px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 99.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACq0lEQVQ4y5VU2W4aQRDcX0+U9zzkMd+ROFKkSJGykWNu9gCWvdgDzLEHYLBsjkrX2GDkxBZeqTQz2p6e6u7q1izTgGVaCMMB0jRFHMdnI0lipEmCodxL4ghuvw9tMh5jNBqhLEpst1vs93vsdjsF7l/7tmKzuttieXuP+Vpws4bmeh4ajQYqlYpimOc5sixT63Q6hesHcDwfPdeTvY9A4AtSsptk+Gml+HLZwdeqj4Y/gRaGIQhens/nmM1mKMsSc8Esy1GzPfipOBb0wiGGQwlPHmZURVEgiiIY7TacXg+MVuNrfYk9CAIFnk3TVDkqxGnfD2HaXfS9AF4QqrwtFgsFRkK7ZrOJnjgc0+FgMFAH13XR7XbBMw2fwp4I6ykyYZ5lM9k//SPohETomNFpZMf8kVW1WlUrWXY6HWGTqDQUUjCy5VqqtTiC5+VyqRhzr5GZ4zhHhmRLh8wpmZxePgcq5FarBcuylEPbtpUzvnYI6zWcMlYMWSWGR+mQ3XNWNHoJpzZHh0yoYRhHhnR4avBmh8xdW3SkxCr6YnLfkrPnRZIqu2g0W7j8c4Vmqy1685HlxVnI83+j0KJBiIHnYDqKkY9TlNMhbhfZWSiLh8I8aPQh91rbCfHxwsZn/Rqffk3w4fsQ77/FeHcRvQra1J0EizLHarUWrB5zKK31o2KhJj91w4Nuhmh4ov7sDslyj2i+xaDcICq3j9ioczzfycAIhGVxnD4UuBoOVlt60TbhOdJ6votsPMLseogym+BuffPi+GK47KDDx4JqvshG13/jStrPkLZri4QMw1TIZNrcbzbYcUY+AydlqdqyUHN0I3ZsU41Nres66vW6Wmu1mpIR9VmevP6/j73NxuAdzgRVFLZdU2Sj1gNkHNXrDbWn4F/CoSFIgEOFjfEXbyjEiwcQcNAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/8ac56/image-8.webp 240w,
/static/a2ea8226a0602eac51ed9c3bddb5c33f/e6590/image-8.webp 434w&quot;
              sizes=&quot;(max-width: 434px) 100vw, 434px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/8ff5a/image-8.png 240w,
/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png 434w&quot;
            sizes=&quot;(max-width: 434px) 100vw, 434px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png&quot;
            alt=&quot;image-8.png&quot;
            title=&quot;image-8.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgを用いたデバッグや解析の際に利用するウィンドウのインターフェースについてまとめました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgを用いたデバッグとトラブルシューティングのテクニック]]></title><link>https://kashiwaba-yuki.com/windows-windbg-001-index</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-001-index</guid><pubDate>Mon, 04 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は、WinDbgを用いたWindowsのデバッグやダンプの解析方法について0から学べる情報を整理したいと思い、この記事を書き始めました。&lt;/p&gt;
&lt;p&gt;私は、本業の中でしばしばメモリダンプやプロセスダンプを解析してトラブルシューティングをしなければならないことがあるのですが、各問題の原因特定のために有効な調査方法についてわかりやすい情報が非常に少ないと感じています。&lt;/p&gt;
&lt;p&gt;そのため、常に手探りでの解析になることに苦しい思いをしており、WinDbgを用いた解析手法について充実したナレッジがないものかと常に思案していました。&lt;/p&gt;
&lt;p&gt;しかし、中々有効な情報源が見つからなかったこともあり、「まずは自分が情報を発信しよう」という考えのもと、WinDbgを用いた解析手法について整理した情報を公開していくことにしました。&lt;/p&gt;
&lt;p&gt;現時点(2021/10/02)ではまだ記事数は少ないですが、最終的にはWinDbgを用いた各種解析手法や、トラブルシューティングに有効なテクニックについて目的別に整理した記事を書いていこうと考えています。&lt;/p&gt;
&lt;p&gt;公開した記事はすべて以下に整理しています。&lt;/p&gt;
&lt;h2 id=&quot;記事カテゴリ一覧&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA%E4%B8%80%E8%A6%A7&quot; aria-label=&quot;記事カテゴリ一覧 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事カテゴリ一覧&lt;/h2&gt;
&lt;h3 id=&quot;はじめてのwindbg&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AEwindbg&quot; aria-label=&quot;はじめてのwindbg permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;はじめてのWinDbg&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-003-ui&quot;&gt;WinDbgの各ウィンドウについてまとめてみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-005-kernel-dump&quot;&gt;Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるユーザモードデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;windbgによるユーザモードデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるユーザモードデバッグ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-009-base64&quot;&gt;C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-010-socket&quot;&gt;Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるカーネルモードデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;windbgによるカーネルモードデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるカーネルモードデバッグ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;Windowsカーネルドライバを自作してWinDbgで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windriver-002-irp&quot;&gt;Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるプロセスダンプ解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%83%80%E3%83%B3%E3%83%97%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;windbgによるプロセスダンプ解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるプロセスダンプ解析&lt;/h3&gt;
&lt;p&gt;まだこのカテゴリの記事がありません。&lt;/p&gt;
&lt;h3 id=&quot;windbgによるメモリダンプ解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;windbgによるメモリダンプ解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるメモリダンプ解析&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-005-kernel-dump&quot;&gt;Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbg-previewによる-time-trabel-debugging&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg-preview%E3%81%AB%E3%82%88%E3%82%8B-time-trabel-debugging&quot; aria-label=&quot;windbg previewによる time trabel debugging permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbg Previewによる Time Trabel Debugging&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-009-base64&quot;&gt;C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-010-socket&quot;&gt;Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;ユースケース別の解説記事&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E5%88%A5%E3%81%AE%E8%A7%A3%E8%AA%AC%E8%A8%98%E4%BA%8B&quot; aria-label=&quot;ユースケース別の解説記事 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ユースケース別の解説記事&lt;/h2&gt;
&lt;h3 id=&quot;windbgでメモリ情報を参照編集する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%83%A1%E3%83%A2%E3%83%AA%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでメモリ情報を参照編集する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでメモリ情報を参照/編集する&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;アプリケーションエラーの原因調査&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E5%8E%9F%E5%9B%A0%E8%AA%BF%E6%9F%BB&quot; aria-label=&quot;アプリケーションエラーの原因調査 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アプリケーションエラーの原因調査&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;補足&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3&quot; aria-label=&quot;補足 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;補足&lt;/h2&gt;
&lt;p&gt;各記事で解析のために使用しているサンプルプログラムは、いずれも以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;サンプルプログラム：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リポジトリ内のサンプルプログラムをシンボルファイル（.pdb）付きでコンパイルする方法については、以下の記事にまとめています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;外部参考資料&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%A4%96%E9%83%A8%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99&quot; aria-label=&quot;外部参考資料 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;外部参考資料&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debugging Tools for Windows (WinDbg、KD、CDB、NTSD) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://techinfoofmicrosofttech.osscons.jp/index.php?WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg - マイクロソフト系技術情報 Wiki&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://windbg.info/download/doc/pdf/WinDbg_A_to_Z_color_JP.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg. From A to Z!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://windbg.info/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Welcome to WinDbg.info&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3KTG0e9&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item></channel></rss>